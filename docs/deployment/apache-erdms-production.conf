# ============================================
# ERDMS Platform - Production Apache Config
# Domain: erdms.zachranka.cz
# Multi-App Architecture
# ============================================

<VirtualHost *:80>
    ServerName erdms.zachranka.cz
    ServerAdmin admin@zachranka.cz
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://erdms.zachranka.cz/
</VirtualHost>

<VirtualHost *:443>
    ServerName erdms.zachranka.cz
    ServerAdmin admin@zachranka.cz
    
    # SSL Configuration (uncomment when SSL cert is ready)
    # SSLEngine on
    # SSLCertificateFile /etc/letsencrypt/live/erdms.zachranka.cz/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/erdms.zachranka.cz/privkey.pem
    
    # ============================================
    # DASHBOARD + LOGIN (root path /)
    # ============================================
    DocumentRoot /var/www/erdms-dev/dashboard/dist
    
    <Directory /var/www/erdms-dev/dashboard/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router - všechny requesty na index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/eeo-v2
        RewriteCond %{REQUEST_URI} !^/api
        RewriteRule . /index.html [L]
    </Directory>
    
    # ============================================
    # AUTH API (Node.js - Entra ID)
    # ============================================
    ProxyPreserveHost On
    ProxyPass /api/auth http://localhost:4000/api/auth
    ProxyPassReverse /api/auth http://localhost:4000/api/auth
    
    ProxyPass /api/users http://localhost:4000/api/users
    ProxyPassReverse /api/users http://localhost:4000/api/users
    
    # ============================================
    # EEO2025 APPLICATION (/eeo-v2/ subdirectory)
    # ============================================
    Alias /eeo-v2 /var/www/erdms-dev/apps/eeo-v2/client/build
    
    <Directory /var/www/erdms-dev/apps/eeo-v2/client/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router pro subdirectory
        RewriteEngine On
        RewriteBase /eeo-v2
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /eeo-v2/index.html [L]
    </Directory>
    
    # ============================================
    # EEO NODE.JS API (port 4001)
    # ============================================
    ProxyPass /api/eeo http://localhost:4001/api/eeo
    ProxyPassReverse /api/eeo http://localhost:4001/api/eeo
    
    # ============================================
    # EEO LEGACY PHP API (/api.eeo/)
    # ============================================
    Alias /api.eeo /var/www/erdms-dev/apps/eeo-v2/api-legacy/api.eeo
    
    <Directory /var/www/erdms-dev/apps/eeo-v2/api-legacy/api.eeo>
        Options +ExecCGI -Indexes
        AllowOverride All
        Require all granted
        
        # PHP-FPM Handler
        <FilesMatch "\.php$">
            SetHandler "proxy:unix:/run/php/php8.4-fpm.sock|fcgi://localhost"
        </FilesMatch>
        
        # Allow .htaccess overrides
        DirectoryIndex index.php
    </Directory>
    
    # ============================================
    # STARÉ PŘÍLOHY (legacy attachments)
    # ============================================
    Alias /prilohy /var/www/erdms-dev/apps/eeo-v2/prilohy
    
    <Directory /var/www/erdms-dev/apps/eeo-v2/prilohy>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
    
    # ============================================
    # LOGS
    # ============================================
    ErrorLog ${APACHE_LOG_DIR}/erdms-error.log
    CustomLog ${APACHE_LOG_DIR}/erdms-access.log combined
    
    # ============================================
    # SECURITY HEADERS
    # ============================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # ============================================
    # COMPRESSION
    # ============================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>
    
    # ============================================
    # CACHING
    # ============================================
    <IfModule mod_expires.c>
        ExpiresActive On
        
        # Images
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        
        # CSS and JavaScript
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        
        # HTML - no cache
        ExpiresByType text/html "access plus 0 seconds"
    </IfModule>
</VirtualHost>
