# ERDMS Platform - Apache Configuration
# Domain: erdms.zachranka.cz

<VirtualHost *:80>
    ServerName erdms.zachranka.cz
    ServerAdmin admin@zachranka.cz
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://erdms.zachranka.cz/
</VirtualHost>

<VirtualHost *:443>
    ServerName erdms.zachranka.cz
    ServerAdmin admin@zachranka.cz
    
    # SSL Configuration (uncomment when SSL cert is ready)
    # SSLEngine on
    # SSLCertificateFile /etc/letsencrypt/live/erdms.zachranka.cz/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/erdms.zachranka.cz/privkey.pem
    
    # Dashboard (hlavní stránka)
    DocumentRoot /var/www/erdms-builds/current/dashboard/dist
    
    <Directory /var/www/erdms-builds/current/dashboard/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router - všechny requesty na index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Auth API (sdílené)
    ProxyPreserveHost On
    ProxyPass /api/auth http://localhost:4000/api/auth
    ProxyPassReverse /api/auth http://localhost:4000/api/auth
    
    ProxyPass /api/users http://localhost:4000/api/users
    ProxyPassReverse /api/users http://localhost:4000/api/users
    
    # EEO v2 Application
    Alias /eeo-v2 /var/www/erdms-builds/current/apps/eeo-v2/client/dist
    <Directory /var/www/erdms-builds/current/apps/eeo-v2/client/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        RewriteEngine On
        RewriteBase /eeo-v2
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /eeo-v2/index.html [L]
    </Directory>
    
    # EEO API (Node.js)
    ProxyPass /api/eeo http://localhost:4001/api/eeo
    ProxyPassReverse /api/eeo http://localhost:4001/api/eeo
    
    # EEO Legacy API (PHP)
    Alias /api/eeo-legacy /var/www/erdms-dev/apps/eeo-v2/api-legacy/api.eeo
    <Directory /var/www/erdms-dev/apps/eeo-v2/api-legacy/api.eeo>
        Options +ExecCGI
        AllowOverride All
        Require all granted
        
        <FilesMatch "\.php$">
            SetHandler "proxy:unix:/run/php/php8.4-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </Directory>
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/erdms-error.log
    CustomLog ${APACHE_LOG_DIR}/erdms-access.log combined
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
</VirtualHost>
