<VirtualHost *:80>
    ServerName erdms.zachranka.cz
    ServerAdmin admin@zachranka.cz
    
    # Redirect HTTP to HTTPS
    Redirect permanent / https://erdms.zachranka.cz/
</VirtualHost>

<VirtualHost *:443>
    ServerName erdms.zachranka.cz
    ServerAdmin admin@zachranka.cz
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/erdms.zachranka.cz/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/erdms.zachranka.cz/privkey.pem
    
    # ============================================
    # 1. ROOT PATH (/) - Dashboard s Entra ID
    # ============================================
    DocumentRoot /var/www/erdms-dev/dashboard/dist
    
    <Directory /var/www/erdms-dev/dashboard/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router fallback - všechny requesty na index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        # DŮLEŽITÉ: Exclude /eeo-v2 a /intranet z rewrite pravidel
        RewriteCond %{REQUEST_URI} !^/eeo-v2
        RewriteCond %{REQUEST_URI} !^/intranet
        RewriteCond %{REQUEST_URI} !^/api
        RewriteRule . /index.html [L]
    </Directory>
    
    # ============================================
    # 2. AUTH API - Entra ID Backend (port 3000)
    # ============================================
    ProxyPreserveHost On
    ProxyPass /api/auth http://localhost:3000/api/auth
    ProxyPassReverse /api/auth http://localhost:3000/api/auth
    
    ProxyPass /api/users http://localhost:3000/api/users
    ProxyPassReverse /api/users http://localhost:3000/api/users
    
    # ============================================
    # 3. EEO2025 APP (/eeo-v2/) - React SPA
    # ============================================
    Alias /eeo-v2 /var/www/erdms-dev/apps/eeo-v2/client/build
    <Directory /var/www/erdms-dev/apps/eeo-v2/client/build>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router fallback pro /eeo-v2/*
        RewriteEngine On
        RewriteBase /eeo-v2
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /eeo-v2/index.html [L]
    </Directory>
    
    # ============================================
    # 4. EEO Node.js API (port 5000)
    # ============================================
    ProxyPass /api/eeo-node http://localhost:5000/api
    ProxyPassReverse /api/eeo-node http://localhost:5000/api
    
    # ============================================
    # 5. EEO Legacy PHP API (/api.eeo/)
    # ============================================
    Alias /api.eeo /var/www/erdms-dev/apps/eeo-v2/api-legacy/api.eeo
    <Directory /var/www/erdms-dev/apps/eeo-v2/api-legacy/api.eeo>
        Options +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex api.php
        
        # PHP-FPM handler
        <FilesMatch "\.php$">
            SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost"
        </FilesMatch>
    </Directory>
    
    # ============================================
    # 6. PŘÍLOHY - Statické soubory
    # ============================================
    Alias /prilohy /var/www/erdms-dev/prilohy
    <Directory /var/www/erdms-dev/prilohy>
        Options +Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
    
    # ============================================
    # 7. BUDOUCÍ INTRANET (/intranet/)
    # ============================================
    # Připraveno pro další aplikaci
    # Alias /intranet /var/www/erdms-dev/intranet/dist
    # <Directory /var/www/erdms-dev/intranet/dist>
    #     Options -Indexes +FollowSymLinks
    #     AllowOverride All
    #     Require all granted
    #     
    #     RewriteEngine On
    #     RewriteBase /intranet
    #     RewriteRule ^index\.html$ - [L]
    #     RewriteCond %{REQUEST_FILENAME} !-f
    #     RewriteCond %{REQUEST_FILENAME} !-d
    #     RewriteRule . /intranet/index.html [L]
    # </Directory>
    
    # ============================================
    # LOGGING
    # ============================================
    ErrorLog ${APACHE_LOG_DIR}/erdms-error.log
    CustomLog ${APACHE_LOG_DIR}/erdms-access.log combined
    
    # ============================================
    # SECURITY HEADERS
    # ============================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS pro API endpointy
    <LocationMatch "^/api">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    </LocationMatch>
    
    # ============================================
    # COMPRESSION
    # ============================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # ============================================
    # CACHING
    # ============================================
    <IfModule mod_expires.c>
        ExpiresActive On
        # HTML - no cache
        ExpiresByType text/html "access plus 0 seconds"
        # Static assets - 1 year
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
    </IfModule>
</VirtualHost>
