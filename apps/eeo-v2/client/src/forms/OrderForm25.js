import React, { useState, useContext, useEffect, useLayoutEffect, useRef, useCallback, useMemo, lazy, Suspense } from 'react';
import ReactDOM, { flushSync } from 'react-dom';
import { useNavigate, useLocation } from 'react-router-dom';
import styled from '@emotion/styled';
import { keyframes } from '@emotion/react';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faUser, faClipboardCheck, faChevronUp, faChevronDown, faTimes, faClipboard, faSave, faCheckCircle, faFileContract, faHashtag, faLock, faUnlock, faFileAlt, faFileCircleXmark, faTrash, faSync, faBrain, faDatabase, faDownload, faCheck, faClock, faBookmark, faInfoCircle, faExpand, faCompress, faCreditCard, faPlus, faMinus, faBuilding, faGlobe, faExclamationTriangle, faTimesCircle } from '@fortawesome/free-solid-svg-icons';
import { User, Package, Calendar, FileText, Building, CreditCard, Hash, Users, Mail, Phone, MapPin, Calculator, Coins, Unlock, Lock, Plus, Trash, Search, X, RefreshCw, Bookmark, Eye, CheckCircle, ShoppingCart, Info, Copy, FileDown } from 'lucide-react';
import { CustomSelect, SelectWithIcon } from '../components/CustomSelect';
import { InvoiceAttachmentsCompact } from '../components/invoices';
import ConfirmDialog from '../components/ConfirmDialog';
import SupplierAddDialog from '../components/SupplierAddDialog';
import ModernHelper from '../components/ModernHelper'; // ðŸ’¡ ModernÃ­ Sponka helper
import FloatingNavigator from '../components/FloatingNavigator'; // ðŸ§­ PlovoucÃ­ navigÃ¡tor po sekcÃ­ch
import { ToastContext } from '../context/ToastContext';
import { AuthContext } from '../context/AuthContext';
import { useActivity } from '../context/ActivityContext';
import { ProgressContext } from '../context/ProgressContext';
import backgroundTaskService from '../services/backgroundTaskService';
import ordersCacheService from '../services/ordersCacheService';
// âŒ DEPRECATED: order25DraftStorageService - pouÅ¾ij draftManager mÃ­sto toho
// import order25DraftStorageService from '../services/order25DraftStorageService';
import draftManager from '../services/DraftManager'; // ðŸŽ¯ CENTRALIZOVANÃ DRAFT MANAGER
import formDataManager from '../services/FormDataManager'; // ðŸŽ¯ CENTRALIZOVANÃ DATA MANAGER
import { useAutosave } from '../hooks/useAutosave'; // ðŸŽ¯ CENTRALIZOVANÃ AUTOSAVE HOOK
import { prettyDate, formatDateOnly } from '../utils/format';
import { fetchAllUsers, fetchApprovers, fetchLimitovanePrisliby, fetchLPDetail, searchSupplierByIco, searchSuppliersList, fetchSupplierContacts, createSupplier, updateSupplierByIco, fetchTemplatesList, fetchTemplatesListWithMeta, createTemplate, updateTemplate, deleteTemplate, getUserDetailApi2, fetchUskyList } from '../services/api2auth';
import { getSmlouvyList, getSmlouvaDetail, prepocetCerpaniSmluv } from '../services/apiSmlouvy';
import {
  getStrediska25,
  getFinancovaniZdroj25,
  getDruhyObjednavky25,
  // âŒ DEPRECATED: getOrder25, getNextOrderNumber25, createPartialOrder25, updatePartialOrder25 - pouÅ¾ij V2 API mÃ­sto toho
  // âŒ DEPRECATED: uploadAttachment25, listAttachments25, downloadAttachment25, deleteAttachment25, verifyAttachments25 - pouÅ¾ij V2 API mÃ­sto toho
  setDebugLogger,
  updateAttachment25,
  createDownloadLink25,
  isAllowedFileType25,
  isAllowedFileSize25,
  generateAttachmentGUID25,
  generateSystemovyNazev25,
  createAttachmentMetadata25,
  getTypyPriloh25,
  getTypyFaktur25,
  lockOrder25,
  unlockOrder25
  // âŒ DEPRECATED: api25orders - pÅ™Ã­mÃ© volÃ¡nÃ­ pÅ™es api25orders.post() nahrazeno V2 API funkcemi
} from '../services/api25orders';
import {
  getOrderV2,           // âœ… V2 API: GET order by ID
  createOrderV2,        // âœ… V2 API: CREATE order
  updateOrderV2,        // âœ… V2 API: UPDATE order
  deleteOrderV2,        // âœ… V2 API: DELETE order
  getNextOrderNumberV2, // âœ… V2 API: GET next order number
  checkOrderNumberV2,   // âœ… V2 API: CHECK order number availability
  getOrderTimestampV2,  // âœ… V2 API: GET order timestamp (lightweight)
  // âœ… V2 API: Order Attachments
  uploadOrderAttachment,
  listOrderAttachments,
  downloadOrderAttachment,
  deleteOrderAttachment,
  verifyOrderAttachments,
  // âœ… V2 API: Invoice Attachments
  uploadInvoiceAttachment,
  listInvoiceAttachments,
  downloadInvoiceAttachment,
  deleteInvoiceAttachment,
  prepareDataForAPI,
  normalizeError
  // âŒ REMOVED: getLPOptionsForItems - lp_options se naÄÃ­tajÃ­ pÅ™Ã­mo z enriched objednÃ¡vky
} from '../services/apiOrderV2';
import { deleteInvoiceV2, createInvoiceV2, updateInvoiceV2 } from '../services/api25invoices';
// âŒ DEPRECATED: listInvoiceAttachments25, deleteInvoiceAttachment25 - pouÅ¾ij V2 API mÃ­sto toho
import { notificationService, NOTIFICATION_TYPES } from '../services/notificationsUnified';
import notificationServiceDual from '../services/notificationService'; // ðŸ†• Dual-template notifikace
import { WORKFLOW_STATES, getWorkflowPhase, canTransitionTo } from '../constants/workflow25';
import {
  validateWorkflowData,
  getSectionVisibility,
  getFieldEditability,
  getAvailableActions,
  formatWorkflowState
} from '../utils/workflowUtils';
import {
  broadcastDraftUpdated,
  broadcastDraftDeleted,
  broadcastOrderSaved,
  broadcastMessage
} from '../utils/tabSync';
import { translateErrorMessageShort } from '../utils/errorTranslation';
import {
  normalizeStrediskaFromBackend,
  normalizeStrediskaForBackend,
  normalizeFinancovaniFromBackend,
  normalizeFinancovaniForBackend,
  normalizeFakturaStrediskaFromBackend,
  normalizeFakturaStrediskaForBackend
} from '../utils/dataTransformHelpers';

// ðŸŽ¯ NOVÃ‰: Import refactored hooks pro state management
import { useFormController, useWorkflowManager } from './OrderForm25/hooks';

// ðŸš€ PERFORMANCE: Lazy load DocxGeneratorModal (pouze kdyÅ¾ je potÅ™eba)
const DocxGeneratorModal = lazy(() => import('../components/DocxGeneratorModal').then(m => ({ default: m.DocxGeneratorModal })));

// PomocnÃ¡ funkce pro formÃ¡tovÃ¡nÃ­ data pro DatePicker (YYYY-MM-DD formÃ¡t)
const formatDateForPicker = (date) => {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '';
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// PomocnÃ¡ funkce pro normalizaci textu - odstranÄ›nÃ­ diakritiky a pÅ™evod na malÃ¡ pÃ­smena
const normalizeText = (text) => {
  if (!text) return '';
  return text
    .toLowerCase()
    .normalize('NFD') // RozloÅ¾Ã­ diakritiku na zÃ¡kladnÃ­ znaky + kombinujÃ­cÃ­ znaky
    .replace(/[\u0300-\u036f]/g, '') // OdstranÃ­ kombinujÃ­cÃ­ znaky (diakritiku)
    .replace(/[^\w\s]/g, '') // OdstranÃ­ interpunkci
    .trim();
};

// GlobÃ¡lnÃ­ pomocnÃ¡ funkce pro aktuÃ¡lnÃ­ datum ve formÃ¡tu YYYY-MM-DD
const getCurrentDateFormatted = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

/**
 * ðŸŽ¨ Z-INDEX HIERARCHIE PRO ORDERFORM25
 *
 * PÅ™ehled vÅ¡ech z-index hodnot pro sprÃ¡vnÃ© vrstvenÃ­ komponent:
 *
 * 1-100:     ZÃ¡kladnÃ­ elementy (headers, shadows, atd.)
 * 10000:     Dropdown menu (CustomSelect, MultiSelect)
 * 99999:     Fullscreen reÅ¾im (Container.isFullscreen)
 * 100000:    Dialogy nad fullscreenem (SupplierAddDialog, AresPopup, SupplierPopup, DeleteConfirm)
 * 999999:    NejvyÅ¡Å¡Ã­ vrstva (ConfirmDialog, TemplateModal, LoadingOverlay, PreviewModal)
 *
 * âš ï¸ DÅ®LEÅ½ITÃ‰: Dialogy a modÃ¡ly MUSÃ mÃ­t vyÅ¡Å¡Ã­ z-index neÅ¾ fullscreen (99999),
 *              aby se zobrazovaly i kdyÅ¾ je formulÃ¡Å™ ve fullscreen mÃ³du!
 */

const Container = styled.div`
  background: #f8fafc;
  padding: 0;
  position: fixed;
  top: ${props => props.isFullscreen ? '0' : 'var(--app-fixed-offset-actual, calc(var(--app-header-height, 96px) + var(--app-menu-height, 48px)))'};
  left: 0;
  right: 0;
  bottom: ${props => props.isFullscreen ? '0' : 'var(--app-footer-height, 54px)'};
  width: 100%;
  height: ${props => props.isFullscreen ? '100vh' : 'calc(100vh - var(--app-fixed-offset-actual, calc(var(--app-header-height, 96px) + var(--app-menu-height, 48px))) - var(--app-footer-height, 54px))'};
  overflow: hidden;
  z-index: ${props => props.isFullscreen ? '99999' : 'auto'};
  transition: all 0.3s ease-in-out;

  /* Animace pro loading spinner */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;

const FormWrapper = styled.div`
  width: 100%;
  max-width: 990px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  height: 100%;
  ${props => props.debugPinned ? `
    margin-left: 420px;
    margin-right: auto;
  ` : ''}
  background: transparent;
  transition: margin-left 0.3s ease-in-out, margin-right 0.3s ease-in-out;

  @media (max-width: 1400px) {
    ${props => props.debugPinned ? `
      margin-left: 380px;
      margin-right: auto;
    ` : ''}
  }

  @media (max-width: 1200px) {
    margin-left: auto;
    margin-right: auto;
    max-width: 990px;
  }

  @media (max-width: 768px) {
    max-width: 100%;
    padding: 0 0.5rem;
    margin-left: auto;
    margin-right: auto;
  }
`;

const FixedHeader = styled.div`
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 990px;
  z-index: 100;
  background: ${({theme}) => theme.colors.gray100 || '#f8fafc'};
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  padding: 1rem 0 1rem 0;
`;

const FixedHeaderContent = styled.div`
  width: 100%;
  max-width: 990px;
  margin: 0 auto;
  ${props => props.debugPinned ? `
    margin-left: 420px;
    margin-right: auto;
  ` : ''}
  padding: 0 1rem;
  transition: margin-left 0.3s ease-in-out, margin-right 0.3s ease-in-out;

  @media (max-width: 1400px) {
    ${props => props.debugPinned ? `
      margin-left: 380px;
      margin-right: auto;
    ` : ''}
  }

  @media (max-width: 1200px) {
    margin-left: auto;
    margin-right: auto;
    max-width: 990px;
  }

  @media (max-width: 768px) {
    max-width: 100%;
    padding: 0 1rem;
  }
`;

const ScrollableContent = styled.div`
  /* ScrollovatelnÃ½ obsah - scrollbar na pravÃ©m okraji okna prohlÃ­Å¾eÄe */
  position: absolute;
  top: 0px;
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0;

  /* DecentnÃ­ scrollbar - 80% prÅ¯hlednÃ½ ve vÃ½chozÃ­m stavu */
  scrollbar-width: thin;
  scrollbar-color: rgba(148, 163, 184, 0.2) transparent;

  /* PÅ™i hover vÃ­ce viditelnÃ½ */
  &:hover {
    scrollbar-color: rgba(148, 163, 184, 0.8) transparent;
  }

  /* Webkit browsers (Chrome, Safari, Edge) */
  &::-webkit-scrollbar {
    width: 10px;
  }

  &::-webkit-scrollbar-track {
    background: transparent;
  }

  &::-webkit-scrollbar-thumb {
    background-color: rgba(148, 163, 184, 0.2);
    border-radius: 5px;
    border: 2px solid transparent;
    background-clip: content-box;
    transition: background-color 0.3s ease;
  }

  &:hover::-webkit-scrollbar-thumb {
    background-color: rgba(148, 163, 184, 0.8);
  }

  &::-webkit-scrollbar-thumb:hover {
    background-color: rgba(100, 116, 139, 0.95);
  }

  @media (max-width: 768px) {
    padding: 0;
  }
`;

const ScrollableInner = styled.div`
  /* VnitÅ™nÃ­ wrapper pro centrovÃ¡nÃ­ obsahu */
  max-width: 990px;
  margin: 0 auto;
  /* ðŸ“ DynamickÃ½ padding-top: vÃ½Å¡ka headeru + 20px gap (uÅ¾ zapoÄÃ­tÃ¡no v CSS variable) */
  padding: var(--fixed-header-height, 200px) 1rem 2rem 1rem;

  @media (max-width: 768px) {
    padding: var(--fixed-header-height, 200px) 0.5rem 2rem 0.5rem;
  }
`;

const FormHeader = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;

  @media (max-width: 768px) {
    flex-direction: column;
    gap: 0.75rem;
    align-items: stretch;
  }
`;

const HeaderLeft = styled.div`
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
  flex: 1;

  @media (max-width: 768px) {
    justify-content: space-between;
  }
`;

const PriceSummary = styled.div`
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 16px;
  background: ${props => props.isOverBudget ? 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)' : 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)'};
  border: 2px solid ${props => props.isOverBudget ? '#fca5a5' : '#bbf7d0'};
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  color: ${props => props.isOverBudget ? '#991b1b' : '#166534'};
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);

  @media (max-width: 768px) {
    font-size: 12px;
    padding: 6px 12px;
    gap: 8px;
  }
`;

const PriceItem = styled.div`
  display: flex;
  flex-direction: column;
  gap: 2px;

  .label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.8;
    font-weight: 500;
  }

  .value {
    font-size: 16px;
    font-weight: 700;

    @media (max-width: 768px) {
      font-size: 14px;
    }
  }
`;

const TitleWithButtons = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
  position: relative;
`;

const HeaderTitle = styled.h1`
  font-size: 1.8125rem;
  font-weight: 700;
  color: #b45309;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-variant: small-caps;
  position: relative;

  /* VÄ›tÅ¡Ã­ prvnÃ­ pÃ­smeno s gradientnÃ­m zvÃ½raznÄ›nÃ­m */
  &::first-letter {
    font-size: 1.3em;
    font-variant: normal;
    font-weight: 800;
    background: linear-gradient(135deg, #d97706 0%, #b45309 50%, #92400e 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 2px 4px rgba(180, 83, 9, 0.3);
  }

  /* HornÃ­ index pro ID objednÃ¡vky */
  .order-id-badge {
    font-size: 0.4em;
    font-weight: 500;
    color: #6b7280;
    margin-left: 0.1em;
    vertical-align: top;
    line-height: 1;
    position: relative;
    top: -0.5em;
    left: -6px;
  }

  @media (max-width: 768px) {
    font-size: 1.75rem;

    .order-id-badge {
      font-size: 0.55em;
    }
  }
`;

const PhaseInfo = styled.div`
  font-size: 0.875rem;
  color: #6b7280;
  font-weight: 500;
`;

const HeaderButtons = styled.div`
  display: flex;
  gap: 0.75rem;
  align-items: center;
`;

const HeaderButton = styled.button`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;

  &.template-btn {
    background: #10b981;
    color: white;
    cursor: pointer;
    opacity: 1;
    padding: 0.5rem;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:hover {
      background: #059669;
      transform: scale(1.05);
    }
  }

  &.reload-btn {
    background: #0ea5e9;
    color: white;
    padding: 0.5rem;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:disabled {
      cursor: not-allowed;
      opacity: 0.6;

      &:hover {
        background: #0ea5e9;
      }
    }

    &:not(:disabled) {
      cursor: pointer;
      opacity: 1;

      &:hover {
        background: #0284c7;
        transform: translateY(-1px);
      }
    }
  }

  &.cancel-btn {
    background: #dc2626;
    color: white;

    &:hover {
      background: #b91c1c;
    }
  }

  &.draft-btn {
    background: #059669;
    color: white;

    &:hover {
      background: #047857;
    }

    &:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
  }

  &.fullscreen-btn {
    background: #10b981;
    color: white;
    cursor: pointer;
    opacity: 1;
    padding: 0.5rem;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:hover {
      background: #059669;
      transform: scale(1.05);
    }
  }

  &.toggle-sections-btn {
    background: #8b5cf6;
    color: white;
    cursor: pointer;
    opacity: 1;
    padding: 0.5rem;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:hover {
      background: #7c3aed;
      transform: scale(1.05);
    }
  }

  &.generate-docx-btn {
    background: #f97316;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;

    &:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      opacity: 0.6;

      &:hover {
        background: #9ca3af;
        transform: none;
      }
    }

    &:not(:disabled):hover {
      background: #ea580c;
      transform: scale(1.05);
    }
  }
`;

const PhaseRow = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 0.5rem 1rem;
  margin-bottom: 0;
  gap: 1rem;

  @media (max-width: 768px) {
    flex-direction: column;
    gap: 0.75rem;
    align-items: stretch;
  }
`;

const PhaseIndicator = styled.div`
  font-size: 0.875rem;
  font-weight: 700;
  text-align: center;
  position: relative;
  flex: 1;

  @media (max-width: 768px) {
    text-align: left;
  }
`;

const PhaseProgressContainer = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex: 1;
`;

const PriceSummaryContainer = styled.div`
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.25rem;
  padding-right: 1rem;
`;

const PriceSummaryRow = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  font-weight: 600;
`;

const PriceLabel = styled.span`
  color: #dc2626;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 700;
`;

const PriceValue = styled.span`
  color: #dc2626;
  font-size: 1.1rem;
  font-weight: 800;
  font-family: 'Courier New', monospace;
`;

const PriceBadge = styled.span`
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: 600;
  background: ${props => props.isOver ? '#fef2f2' : '#f0fdf4'};
  color: ${props => props.isOver ? '#dc2626' : '#059669'};
  border: 1px solid ${props => props.isOver ? '#fecaca' : '#bbf7d0'};
`;

const PhaseText = styled.div`
  font-size: 0.875rem;
  color: #374151;
  font-weight: 700;
  text-align: left;
`;

const PhaseProgressBar = styled.div`
  display: flex;
  height: 6px;
  background: #e5e7eb;
  border-radius: 3px;
  overflow: hidden;
  position: relative;
  border: 1px solid #d1d5db;
`;

const PhaseSegment = styled.div`
  flex: 1;
  position: relative;

  &:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 1px;
    background: #d1d5db;
    z-index: 2;
  }
`;

const PhaseSegmentFill = styled.div`
  height: 100%;
  transition: all 0.3s ease;

  /* BarevnÃ© pÅ™echody pro jednotlivÃ© fÃ¡ze */
  &.phase-1 {
    background: linear-gradient(90deg, #9ca3af 0%, #6b7280 100%); /* Å edÃ¡ - zaÄÃ¡tek */
  }

  &.phase-2 {
    background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); /* OranÅ¾ovÃ¡ - v procesu */
  }

  &.phase-3 {
    background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); /* ModrÃ¡ - odeslÃ¡no */
  }

  &.phase-4 {
    background: linear-gradient(90deg, #10b981 0%, #059669 100%); /* ZelenÃ¡ - potvrzeno */
  }

  &.phase-5 {
    background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%); /* FialovÃ¡ - registr */
  }

  &.phase-6 {
    background: linear-gradient(90deg, #06b6d4 0%, #0891b2 100%); /* TyrkysovÃ¡ - fakturace */
  }

  &.phase-7 {
    background: linear-gradient(90deg, #14b8a6 0%, #0d9488 100%); /* Teal - vÄ›cnÃ¡ sprÃ¡vnost */
  }

  &.phase-8 {
    background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%); /* SvÄ›tle zelenÃ¡ - dokonÄeno */
  }

  &.phase-error {
    background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); /* ÄŒervenÃ¡ - chyba/storno */
  }
`;

const PhaseDivider = styled.div`
  width: 2px;
  height: 40px;
  background: linear-gradient(to bottom, transparent, #d1d5db 20%, #d1d5db 80%, transparent);
  border-radius: 1px;

  @media (max-width: 768px) {
    width: 100%;
    height: 2px;
    background: linear-gradient(to right, transparent, #d1d5db 20%, #d1d5db 80%, transparent);
  }
`;

const FormActions = styled.div`
  display: flex;
  gap: 0.75rem;
  align-items: center;
`;

const ActionButton = styled.button`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;

  &.save-btn {
    background: #10b981;
    color: white;

    &:hover:not(:disabled) {
      background: #059669;
    }

    &:disabled {
      background: #6b7280;
      cursor: not-allowed;
    }
  }

  &.cancel-btn {
    background: #dc2626;
    color: white;

    &:hover {
      background: #b91c1c;
    }
  }

  &.icon-only {
    padding: 0.5rem;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
`;

// ðŸ†• Keyframe animace pro spinner
const spin = keyframes`
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
`;

// ðŸ†• Styled spinner komponent
const Spinner = styled.span`
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid #ddd;
  border-top: 2px solid #666;
  border-radius: 50%;
  animation: ${spin} 0.8s linear infinite;
`;

// ðŸ†• Styled retry button - nenÃ¡padnÃ½, ale funkÄnÃ­
const RetryButton = styled.button`
  padding: 2px 8px;
  fontSize: 11px;
  backgroundColor: #fef3c7;
  border: 1px solid #fbbf24;
  borderRadius: 4px;
  color: #92400e;
  cursor: pointer;
  fontWeight: 500;
  transition: all 0.2s ease;

  &:hover {
    background-color: #fde68a;
    border-color: #f59e0b;
  }

  &:active {
    transform: scale(0.95);
  }
`;

const EvidenceNumber = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;

  @media (max-width: 768px) {
    flex-direction: column;
    gap: 0.25rem;
    align-items: flex-start;
  }
`;

const EvidenceLabel = styled.div`
  font-size: 0.75rem;
  color: #6b7280;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
`;

const EvidenceValue = styled.div`
  font-size: 1rem;
  font-weight: 700;
  color: ${props => props.$isEmergency ? '#fde047' : '#1e40af'};
  font-family: 'Courier New', monospace;
  background: ${props => props.$isEmergency 
    ? 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)' 
    : 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)'};
  padding: 0.4rem 0.6rem;
  border-radius: 6px;
  border: 1px solid ${props => props.$isEmergency ? '#991b1b' : '#93c5fd'};
  white-space: nowrap;
`;

const FormSection = styled.div`
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  margin-bottom: 1.5rem;
  overflow: visible;
  border: 1px solid #e2e8f0;
`;

const SectionHeader = styled.div`
  padding: 1rem 1.25rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.3s ease;

  /* BarevnÃ© schÃ©ma podle typu sekce */
  ${props => {
    // UrÄÃ­ zÃ¡kladnÃ­ barvu podle typu sekce
    const getBaseColors = (sectionTheme) => {
      switch(sectionTheme) {
        case 'section-grey':
          return {
            bg: ['#f9fafb', '#f3f4f6'],
            border: '#9ca3af',
            hover: ['#f3f4f6', '#e5e7eb']
          };
        case 'section-orange':
          return {
            bg: ['#fef3c7', '#fde68a'],
            border: '#f59e0b',
            hover: ['#fde68a', '#facc15']
          };
        case 'section-blue':
          return {
            bg: ['#dbeafe', '#bfdbfe'],
            border: '#3b82f6',
            hover: ['#bfdbfe', '#93c5fd']
          };
        case 'section-purple':
          return {
            bg: ['#f3e8ff', '#e9d5ff'],
            border: '#a855f7',
            hover: ['#e9d5ff', '#d8b4fe']
          };
        case 'section-red':
          return {
            bg: ['#fee2e2', '#fecaca'],
            border: '#dc2626',
            hover: ['#fecaca', '#fca5a5']
          };
        default:
          return {
            bg: ['#fef3c7', '#fde68a'],
            border: '#f59e0b',
            hover: ['#fde68a', '#facc15']
          };
      }
    };

    const colors = getBaseColors(props.sectionTheme);

    // UpravÃ­ intenzitu podle toho, jestli je sekce aktivnÃ­
    const opacity = props.isActive ? '1' : '0.6';

    return `
      background: linear-gradient(135deg, ${colors.bg[0]} 0%, ${colors.bg[1]} 100%);
      border-bottom: 1px solid ${colors.border};
      opacity: ${opacity};

      &:hover {
        background: linear-gradient(135deg, ${colors.hover[0]} 0%, ${colors.hover[1]} 100%);
        opacity: 1;
      }
    `;
  }}
`;

const SectionTitle = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 600;
  font-size: 1.1rem;

  ${props => {
    switch(props.sectionTheme) {
      case 'section-grey':
        return 'color: #4b5563;';
      case 'section-orange':
        return 'color: #92400e;';
      case 'section-blue':
        return 'color: #1e40af;';
      case 'section-purple':
        return 'color: #7e22ce;';
      case 'section-red':
        return 'color: #991b1b;';
      default:
        return 'color: #92400e;';
    }
  }}
`;

const SectionIcon = styled.div`
  font-size: 1.2rem;

  ${props => {
    switch(props.sectionTheme) {
      case 'section-grey':
        return 'color: #6b7280;';
      case 'section-orange':
        return 'color: #f59e0b;';
      case 'section-blue':
        return 'color: #3b82f6;';
      case 'section-purple':
        return 'color: #a855f7;';
      case 'section-red':
        return 'color: #dc2626;';
      default:
        return 'color: #f59e0b;';
    }
  }}
`;

const CollapseIcon = styled.div`
  transition: transform 0.2s ease;
  transform: ${props => props.collapsed ? 'rotate(0deg)' : 'rotate(180deg)'};

  ${props => {
    switch(props.sectionTheme) {
      case 'section-grey':
        return 'color: #4b5563;';
      case 'section-orange':
        return 'color: #92400e;';
      case 'section-blue':
        return 'color: #1e40af;';
      case 'section-purple':
        return 'color: #7e22ce;';
      case 'section-red':
        return 'color: #991b1b;';
      default:
        return 'color: #92400e;';
    }
  }}
`;

const SectionControls = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const LockWarning = styled.span`
  margin-left: 0.75rem;
  color: #dc2626;
  font-size: 0.7rem;
  font-weight: 500;
  background: rgba(255, 255, 255, 0.2);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  cursor: help;
`;

const SectionContent = styled.div`
  padding: 1.5rem 1.25rem;
  display: ${props => props.collapsed ? 'none' : 'block'};
`;

const EmergencyToggleWrapper = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
  opacity: ${props => props.disabled ? 0.6 : 1};
  pointer-events: ${props => props.disabled ? 'none' : 'auto'};
`;

const EmergencyToggleSwitch = styled.label`
  position: relative;
  display: inline-block;
  width: 56px;
  height: 28px;
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  flex-shrink: 0;

  input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  span {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: ${props => props.checked ? '#ef4444' : '#cbd5e1'};
    border-radius: 28px;
    transition: all 0.3s ease;

    &::before {
      content: '';
      position: absolute;
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      transform: ${props => props.checked ? 'translateX(28px)' : 'translateX(0)'};
    }
  }

  input:focus + span {
    box-shadow: 0 0 0 3px ${props => props.checked ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
  }
`;

const EmergencyToggleLabel = styled.span`
  font-size: 0.9rem;
  font-weight: ${props => props.checked ? '700' : '400'};
  color: ${props => props.checked ? '#dc2626' : '#374151'};
`;

const FormRow = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;

  @media (max-width: 1024px) {
    grid-template-columns: 1fr 1fr;
  }

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
`;

const FormGroup = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
`;

const ErrorText = styled.div`
  color: #dc2626;
  font-size: 0.75rem;
  font-weight: 500;
  margin-top: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
`;

const Label = styled.label`
  font-weight: 600;
  font-size: 0.875rem;
  color: #374151;

  &::after {
    content: ${props => props.required ? '" *"' : '""'};
    color: #dc2626;
    margin-left: 2px;
  }
`;

// Wrapper pro input s ikonou
const InputWithIcon = styled.div`
  position: relative;
  width: 100%;

  > svg {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 1;
    pointer-events: none;
    width: 16px !important;
    height: 16px !important;
  }
`;

const Input = styled.input`
  width: 100%;
  box-sizing: border-box;
  padding: ${props => props.hasIcon ? '0.75rem 0.75rem 0.75rem 2.5rem' : '0.75rem'};
  border: 2px solid ${props => props.hasError ? '#dc2626' : '#e5e7eb'};
  border-radius: 8px;
  font-size: 0.875rem;
  transition: all 0.2s ease;
  background: #ffffff;

  /* ZvÃ½raznÄ›nÃ© vyplnÄ›nÃ© hodnoty vs. placeholder - sladÄ›no s CustomSelect */
  color: ${props => props.value && props.value !== '' ? '#1f2937' : '#6b7280'};
  font-weight: ${props => {
    if (props.disabled) return '400'; // Disabled elementy majÃ­ normÃ¡lnÃ­ font-weight
    return props.value && props.value !== '' ? '600' : '400'; // SladÄ›no s CustomSelect
  }};

  &:focus {
    outline: none;
    border-color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
    box-shadow: 0 0 0 3px ${props => props.hasError ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
  }

  &:focus + svg {
    color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
  }

  &:disabled {
    background: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
  }

  /* SjednocenÃ­ placeholder barvy se selecty */
  &::placeholder {
    color: #9ca3af;
    opacity: 1;
    font-weight: 400;
  }

  &::-webkit-input-placeholder {
    color: #9ca3af;
    font-weight: 400;
  }

  &::-moz-placeholder {
    color: #9ca3af;
    opacity: 1;
    font-weight: 400;
  }

  /* OdstranÄ›nÃ­ spinner arrows u number inputÅ¯ */
  &[type="number"] {
    -moz-appearance: textfield; /* Firefox */
    appearance: textfield;

    &::-webkit-outer-spin-button,
    &::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  }
`;

const TextArea = styled.textarea`
  width: 100%;
  box-sizing: border-box;
  padding: 0.75rem;
  border: 2px solid ${props => props.hasError ? '#dc2626' : '#e5e7eb'};
  border-radius: 8px;
  font-size: 0.875rem;
  transition: all 0.2s ease;
  background: #ffffff;
  font-family: inherit;
  resize: vertical;
  min-height: 80px;

  /* ZvÃ½raznÄ›nÃ© vyplnÄ›nÃ© hodnoty vs. placeholder - sladÄ›no s CustomSelect */
  color: ${props => props.value && props.value !== '' ? '#1f2937' : '#6b7280'};
  font-weight: ${props => {
    if (props.disabled) return '400'; // Disabled elementy majÃ­ normÃ¡lnÃ­ font-weight
    return props.value && props.value !== '' ? '600' : '400'; // SladÄ›no s CustomSelect
  }};

  &:focus {
    outline: none;
    border-color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
    box-shadow: 0 0 0 3px ${props => props.hasError ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
  }

  &:disabled {
    background: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
  }

  &::placeholder {
    color: #9ca3af;
    opacity: 1;
    font-weight: 400;
  }
`;

// ðŸ’° Komponenta pro zobrazenÃ­ zbÃ½vajÃ­cÃ­ ÄÃ¡stky (LP a Smlouvy)
const RemainingAmountDisplay = styled.div`
  margin-top: 0.75rem;
  padding: 0.75rem;
  border-radius: 8px;
  background: ${props => {
    if (props.$loading) return '#f3f4f6';
    if (props.$notFound) return '#fef2f2';
    if (props.$isNegative) return '#fef2f2';
    return '#f0fdf4';
  }};
  border: 2px solid ${props => {
    if (props.$loading) return '#e5e7eb';
    if (props.$notFound) return '#fecaca';
    if (props.$isNegative) return '#fca5a5';
    return '#86efac';
  }};
  display: flex;
  align-items: center;
  gap: 0.75rem;
  animation: slideDown 0.3s ease;

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;

const RemainingAmountIcon = styled.div`
  font-size: 1.5rem;
  flex-shrink: 0;
`;

const RemainingAmountContent = styled.div`
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
`;

const RemainingAmountLabel = styled.div`
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: ${props => {
    if (props.$loading) return '#6b7280';
    if (props.$notFound) return '#991b1b';
    if (props.$isNegative) return '#b91c1c';
    return '#15803d';
  }};
`;

const RemainingAmountValue = styled.div`
  font-size: 1.25rem;
  font-weight: 700;
  color: ${props => {
    if (props.$loading) return '#6b7280';
    if (props.$notFound) return '#991b1b';
    if (props.$isNegative) return '#dc2626';
    return '#16a34a';
  }};
  font-variant-numeric: tabular-nums;
`;

const RemainingAmountSubtext = styled.div`
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.125rem;
`;

// ðŸ“„ Styled komponenty pro autocomplete smluv
const SmlouvaAutocompleteContainer = styled.div`
  position: relative;
  width: 100%;
`;

const SmlouvaSuggestionsList = styled.div`
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 0.25rem;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  max-height: 300px;
  overflow-y: auto;
  z-index: 1000;
  animation: slideDown 0.2s ease;

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;

const SmlouvaSuggestionItem = styled.div`
  padding: 0.75rem;
  cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
  transition: all 0.15s ease;

  &:hover {
    background: #f3f4f6;
  }

  &:last-child {
    border-bottom: none;
  }
`;

const SmlouvaSuggestionTitle = styled.div`
  font-size: 0.875rem;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 0.25rem;
`;

const SmlouvaSuggestionMeta = styled.div`
  font-size: 0.75rem;
  color: #6b7280;
  display: flex;
  gap: 1rem;
`;

const SmlouvaSuggestionEmpty = styled.div`
  padding: 1rem;
  text-align: center;
  color: #6b7280;
  font-size: 0.875rem;
`;

const Select = styled.select`
  width: 100%;
  box-sizing: border-box;
  padding: 0.75rem;
  border: 2px solid ${props => props.hasError ? '#dc2626' : '#e5e7eb'};
  border-radius: 8px;
  font-size: 0.875rem;
  transition: all 0.2s ease;
  background: #ffffff;
  cursor: pointer;

  /* ZvÃ½raznÄ›nÃ© vybranÃ© hodnoty vs. placeholder - sladÄ›no s CustomSelect */
  color: ${props => props.value && props.value !== '' && props.value !== 'placeholder' ? '#1f2937' : '#6b7280'};
  font-weight: ${props => {
    if (props.disabled) return '400'; // Disabled elementy majÃ­ normÃ¡lnÃ­ font-weight
    return props.value && props.value !== '' && props.value !== 'placeholder' ? '600' : '400'; // SladÄ›no s CustomSelect
  }};

  &:focus {
    outline: none;
    border-color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
    box-shadow: 0 0 0 3px ${props => props.hasError ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
  }

  &:disabled {
    background: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
  }

  /* Placeholder styl pro prvnÃ­ option */
  option:first-child {
    color: #9ca3af;
    font-weight: 400;
  }
`;

// Multi-select komponenta pro stÅ™ediska - lokÃ¡lnÃ­ komponenty
const MultiSelectWrapper = styled.div`
  position: relative;
  width: 100%;
  z-index: ${props => props.isOpen ? 10000 : 1};
`;

const MultiSelectButton = styled.div`
  width: 100%;
  box-sizing: border-box;
  padding: 0.75rem 1.75rem 0.75rem 0.75rem;
  border: 2px solid ${props => props.hasError ? '#dc2626' : '#e5e7eb'};
  border-radius: 8px;
  font-size: 0.875rem;
  background: ${props => props.disabled ? '#f9fafb' : '#ffffff'};
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  color: ${props => {
    if (props.disabled) return '#6b7280';
    if (props.placeholder || !props.value || props.value === '') return '#9ca3af';
    return '#1f2937';
  }};

  font-weight: ${props => props.disabled ? '400' : (props.value && props.value !== '' && props.placeholder !== "true" ? '600' : '400')};
  min-height: 2.5rem;

  display: flex;
  align-items: center;
  position: relative;
  transition: all 0.2s ease;

  /* Custom arrow */
  appearance: none;
  -moz-appearance: none;
  -webkit-appearance: none;
  background-image: ${props => {
    if (props.disabled) {
      return props.isOpen
        ? `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='18 15 12 9 6 15'%3E%3C/polyline%3E%3C/svg%3E")`
        : `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`;
    } else if (props.hasError) {
      return props.isOpen
        ? `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23b91c1c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='18 15 12 9 6 15'%3E%3C/polyline%3E%3C/svg%3E")`
        : `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23b91c1c' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`;
    } else {
      return props.isOpen
        ? `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='18 15 12 9 6 15'%3E%3C/polyline%3E%3C/svg%3E")`
        : `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E")`;
    }
  }};
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  background-size: 16px 16px;

  &:hover {
    border-color: ${props => props.disabled ? '#e5e7eb' : (props.hasError ? '#dc2626' : '#3b82f6')};
  }

  &:focus {
    outline: none;
    border-color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
    box-shadow: 0 0 0 3px ${props => props.hasError ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
  }
`;

const SelectedValue = styled.span`
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: ${props => props.isEmpty ? '#9ca3af' : '#1f2937'};
  font-weight: ${props => props.isEmpty ? '400' : '600'};
`;

const CustomSelectDropdown = styled.div`
  position: fixed;
  z-index: 40;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
  max-height: 300px;
  overflow-y: auto;
  min-width: 200px;

  /* Prevent text selection while scrolling */
  user-select: none;

  &::-webkit-scrollbar {
    width: 8px;
  }

  &::-webkit-scrollbar-track {
    background: #f9fafb;
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }
`;

const CustomSelectOption = styled.div`
  padding: 0.75rem;
  cursor: pointer;
  font-size: 0.875rem;
  border-bottom: 1px solid #f3f4f6;
  color: #1f2937;
  font-weight: 400 !important; /* Normal font pro vÅ¡echny moÅ¾nosti - s !important */

  &:hover {
    background: #f8fafc;
    font-weight: 400 !important; /* ZÅ¯stÃ¡vÃ¡ normal i pÅ™i hover */
  }

  &:last-child {
    border-bottom: none;
  }

  ${props => props.selected && `
    background: #eff6ff;
    border-left: 3px solid #3b82f6;
    font-weight: 600 !important; /* Bold jen pro vybranou moÅ¾nost */
  `}
`;

const MultiSelectDropdown = styled.div`
  position: fixed;
  z-index: 40;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
  max-height: 300px;
  overflow-y: auto;
  min-width: 200px;

  /* Prevent text selection while scrolling */
  user-select: none;

  /* Optimalizace pro plynulejÅ¡Ã­ scrollovÃ¡nÃ­ */
  scroll-behavior: auto;
  contain: layout style paint;
  will-change: scroll-position;
  transform: translateZ(0); /* Force hardware acceleration */

  /* LepÅ¡Ã­ scrollbar styling */
  scrollbar-width: thin;
  scrollbar-color: #d1d5db #f9fafb;

  &::-webkit-scrollbar {
    width: 8px;
  }

  &::-webkit-scrollbar-track {
    background: #f9fafb;
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
`;

const SearchBox = styled.div`
  position: sticky;
  top: 0;
  z-index: 10;
  background: white;
  padding: 0.75rem;
  border-bottom: 1px solid #e5e7eb;
`;

const SearchInput = styled.input`
  width: 100%;
  padding: 0.75rem 0.75rem 0.75rem 2.5rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.875rem;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
  pointer-events: none;
`;

const TemplateSearchBox = styled.div`
  position: relative;
  width: 100%;
`;

const SearchClearButton = styled.button`
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;

  &:hover {
    color: #6b7280;
    background: #f3f4f6;
  }

  &:active {
    transform: translateY(-50%) scale(0.95);
  }
`;

const TemplateSearchInput = styled(SearchInput)`
  padding-right: 2.5rem;
`;

// ModernÃ­ Template Save Modal komponenty
const TemplateModalOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999999;
  padding: 1rem;
  animation: fadeIn 0.2s ease-out;

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
`;

// Delete Confirmation Modal Components - vyÅ¡Å¡Ã­ z-index neÅ¾ fullscreen (100000+)
const DeleteConfirmOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100000;
  animation: fadeIn 0.2s ease-out;

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
`;

const DeleteConfirmModal = styled.div`
  background: white;
  padding: 2rem;
  border-radius: 8px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  max-width: 400px;
  width: 90%;
  z-index: 100001;
`;

const DeleteConfirmTitle = styled.div`
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #dc2626;
`;

const DeleteConfirmMessage = styled.div`
  margin-bottom: 1.5rem;
  color: #374151;
  line-height: 1.5;
`;

const DeleteConfirmActions = styled.div`
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
`;

const DeleteConfirmButton = styled.button`
  padding: 0.75rem 1.5rem;
  background-color: ${props => props.variant === 'danger' ? '#dc2626' : '#f3f4f6'};
  color: ${props => props.variant === 'danger' ? 'white' : '#374151'};
  border: none;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;

  &:hover {
    background-color: ${props => props.variant === 'danger' ? '#b91c1c' : '#e5e7eb'};
  }
`;

const TemplateModal = styled.div`
  background: white;
  border-radius: 8px;
  width: 100%;
  max-width: 600px;
  padding: 2rem;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
`;

const TemplateModalHeader = styled.div`
  margin-bottom: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 1rem;
`;

const TemplateModalTitle = styled.h2`
  margin: 0;
  color: #1e293b;
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const TemplateModalCloseButton = styled.button`
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: transparent;
  border: none;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #64748b;
  transition: all 0.2s;
  border-radius: 4px;

  &:hover {
    background: #f1f5f9;
    color: #1e293b;
  }

  svg {
    width: 20px;
    height: 20px;
  }
`;

const TemplateModalBody = styled.div`
  /* Å½Ã¡dnÃ½ padding - uÅ¾ je v hlavnÃ­m modalu */
`;

const TemplateFormGroup = styled.div`
  margin-bottom: 1.25rem;
`;

const TemplateLabel = styled.label`
  display: block;
  font-size: 0.75rem;
  font-weight: 700;
  color: #64748b;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
`;

const TemplateInput = styled.input`
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 0.875rem;
  transition: all 0.2s;
  background: white;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  &::placeholder {
    color: #9ca3af;
  }
`;

const TemplateSelect = styled.select`
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 0.875rem;
  transition: all 0.2s;
  background: white;
  cursor: pointer;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  option {
    padding: 8px;
  }
`;

const TemplateTypeGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-top: 0.75rem;
`;

const TemplateTypeOption = styled.label`
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 1rem;
  border: 2px solid ${props => props.checked ? '#10b981' : '#e5e7eb'};
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: ${props => props.checked ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'white'};

  &:hover {
    border-color: #10b981;
    background: ${props => props.checked ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : '#f8fafc'};
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
  }
`;

const TemplateTypeRadio = styled.input`
  appearance: none;
  width: 20px;
  height: 20px;
  border: 2px solid #d1d5db;
  border-radius: 50%;
  position: relative;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-top: 2px;

  &:checked {
    border-color: #10b981;
    background: #10b981;
  }

  &:checked::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
  }
`;

const TemplateTypeText = styled.div`
  font-size: 0.875rem;
  font-weight: 600;
  color: ${props => props.checked ? '#065f46' : '#374151'};
  line-height: 1.4;
`;

const TemplateModalActions = styled.div`
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e5e7eb;
`;

const TemplateActionButton = styled.button`
  padding: 0.625rem 1.25rem;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  transition: all 0.2s;

  ${props => props.variant === 'cancel' ? `
    background: white;
    color: #64748b;
    border: 1px solid #e2e8f0;

    &:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
  ` : `
    background: ${props.disabled ? '#cbd5e1' : '#3b82f6'};
    color: white;
    border: 1px solid ${props.disabled ? '#cbd5e1' : '#3b82f6'};

    &:hover:not(:disabled) {
      background: #2563eb;
      border-color: #2563eb;
    }

    &:disabled {
      cursor: not-allowed;
    }
  `}
`;

const MultiSelectOption = styled.div`
  padding: ${props => props.level === 0 ? '0.75rem' : '0.5rem 0.75rem 0.5rem 2rem'};
  cursor: pointer;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: ${props => props.level === 0 ? '#f9fafb' : '#ffffff'};
  border-bottom: ${props => props.level === 0 ? '2px solid #e5e7eb' : '1px solid #f3f4f6'};
  font-weight: ${props => props.level === 0 ? '600' : '400'};
  color: ${props => props.level === 0 ? '#111827' : '#4b5563'};
  position: relative;
  /* Optimalizace pro plynulejÅ¡Ã­ scrollovÃ¡nÃ­ */
  will-change: transform;
  backface-visibility: hidden;
  /* Focusable pro tab navigaci */
  outline: none;

  &:hover {
    background: ${props => props.level === 0 ? '#f3f4f6' : '#f8fafc'};
  }

  &:focus {
    background: #dbeafe;
    box-shadow: inset 0 0 0 2px #3b82f6;
  }

  &:last-child {
    border-bottom: none;
  }

  input[type="checkbox"] {
    margin: 0;
    /* ZabrÃ¡nit pÅ™efokusovÃ¡nÃ­ pÅ™i kliknutÃ­ na checkbox */
    pointer-events: none;
  }

  span {
    padding-left: ${props => (props.level || 0) * 20}px;
    font-weight: ${props => (props.level || 0) === 0 ? '600' : '400'};
  }
`;

const RadioGroup = styled.div`
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-top: 0.5rem;
`;

const RadioLabel = styled.label`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-size: 0.875rem;
  color: #374151;
`;

const RadioInput = styled.input`
  width: 16px;
  height: 16px;
  cursor: pointer;
`;

// Unlock button pro FÃZE 1 sekce - bez pozadÃ­, jen ikona
const UnlockButton = styled.button`
  background: transparent;
  color: #f59e0b;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  padding: 0;
  margin-right: 8px;

  &:hover {
    color: #d97706;
    transform: scale(1.1);
  }

  &:active {
    transform: scale(0.95);
  }

  svg {
    width: 16px;
    height: 16px;
  }
`;

// Loading overlay pro inicializaci formulÃ¡Å™e with blur and fade
const LoadingOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(248, 250, 252, 0.95);
  backdrop-filter: blur(${props => props.$visible ? '8px' : '0px'});
  -webkit-backdrop-filter: blur(${props => props.$visible ? '8px' : '0px'});
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 999999;
  opacity: ${props => props.$visible ? 1 : 0};
  transition: opacity 0.5s ease-in-out, backdrop-filter 0.6s ease-in-out;
  pointer-events: ${props => props.$visible ? 'auto' : 'none'};

  @media (max-width: 768px) {
    padding: 1rem;
  }
`;

const LoadingSpinner = styled.div`
  width: 64px;
  height: 64px;
  border: 4px solid #e2e8f0;
  border-top: 4px solid #f59e0b;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1.5rem;
  transform: scale(${props => props.$visible ? 1 : 0.8});
  transition: transform 0.5s ease-in-out;

  @keyframes spin {
    0% { transform: rotate(0deg) scale(1); }
    100% { transform: rotate(360deg) scale(1); }
  }
`;

const LoadingMessage = styled.div`
  font-size: 1.125rem;
  font-weight: 600;
  color: #374151;
  text-align: center;
  margin-bottom: 0.5rem;
  transform: translateY(${props => props.$visible ? '0' : '10px'});
  opacity: ${props => props.$visible ? 1 : 0};
  transition: transform 0.5s ease-in-out 0.1s, opacity 0.5s ease-in-out 0.1s;
`;

const LoadingSubtext = styled.div`
  font-size: 0.875rem;
  color: #6b7280;
  text-align: center;
  transform: translateY(${props => props.$visible ? '0' : '10px'});
  opacity: ${props => props.$visible ? 1 : 0};
  transition: transform 0.5s ease-in-out 0.15s, opacity 0.5s ease-in-out 0.15s;
`;

// ðŸ’¾ Save Overlay - blur efekt pro zbytek strÃ¡nky kromÄ› hlaviÄky pÅ™i uklÃ¡dÃ¡nÃ­
const SaveOverlay = styled.div`
  position: fixed;
  top: var(--fixed-header-height, 0px);
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(${props => props.$visible ? '5px' : '0px'});
  -webkit-backdrop-filter: blur(${props => props.$visible ? '5px' : '0px'});
  z-index: 99;
  opacity: ${props => props.$visible ? 1 : 0};
  transition: opacity 0.3s ease-in-out, backdrop-filter 0.3s ease-in-out;
  pointer-events: ${props => props.$visible ? 'auto' : 'none'};
  visibility: ${props => props.$visible ? 'visible' : 'hidden'};
`;

// ðŸŽ¤ HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ je implementovÃ¡no globÃ¡lnÄ› v Layout.js
// OrderForm25 NEPOUÅ½ÃVÃ vlastnÃ­ indikÃ¡tor, aby nedochÃ¡zelo ke kolizÃ­m

const PageContent = styled.div`
  filter: blur(${props => props.$blurred ? '3px' : '0px'});
  transition: filter 0.6s ease-in-out;
  pointer-events: ${props => props.$blurred ? 'none' : 'auto'};
`;

const LoadingProgressBarContainer = styled.div`
  width: 300px;
  height: 6px;
  background: #e2e8f0;
  border-radius: 3px;
  overflow: hidden;
  margin-top: 1.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) inset;
`;

const LoadingProgressBarFill = styled.div`
  height: 100%;
  background: linear-gradient(90deg, #2e7d32, #4caf50 40%, #66bb6a);
  border-radius: 3px;
  transition: width 250ms ease;
  box-shadow: 0 0 6px rgba(76, 175, 80, 0.55);
`;

const ErrorMessage = styled.div`
  background: #fee2e2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  padding: 1rem;
  color: #dc2626;
  font-size: 0.875rem;
  margin: 1rem 0;
  text-align: center;
`;

// Ikony pro dodavatelskÃ¡ pole
const SupplierSearchIcon = styled.div`
  position: absolute;
  right: 35px;
  top: 50%;
  transform: translateY(-50%);
  color: #059669;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;

  &:hover {
    background-color: #f0fdf4;
    color: #047857;
  }

  &:active {
    background-color: #dcfce7;
  }
`;

const AresSearchIcon = styled.div`
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  color: #059669;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;

  &:hover {
    background-color: #f0fdf4;
    color: #047857;
  }

  &:active {
    background-color: #dcfce7;
  }
`;

const AddToDirectoryIcon = styled.div`
  color: ${props => props.isActive ? '#667eea' : '#d1d5db'};
  cursor: ${props => props.isActive ? 'pointer' : 'not-allowed'};
  padding: 6px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  transition: all 0.2s;
  opacity: ${props => props.isActive ? 1 : 0.5};
  background: ${props => props.isActive ? 'rgba(102, 126, 234, 0.1)' : 'transparent'};

  ${props => props.isActive && `
    &:hover {
      background-color: rgba(102, 126, 234, 0.2);
      color: #764ba2;
      transform: scale(1.1);
    }

    &:active {
      background-color: rgba(118, 75, 162, 0.2);
      transform: scale(1.05);
    }
  `}
`;

// Ikona koÅ¡e pro mazÃ¡nÃ­ poloÅ¾ek
const DeleteItemButton = styled.button`
  background: #ef4444;
  color: white;
  border: 2px solid white;
  border-radius: 6px;
  padding: 0.375rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

  &:hover {
    background-color: #dc2626;
    transform: scale(1.1);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }

  &:active {
    background-color: #b91c1c;
    transform: scale(0.95);
  }
`;

// Supplier Directory Popup Styled Components
const SupplierPopupOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100000;
  animation: fadeIn 0.2s ease-out;

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
`;

const SupplierPopupModal = styled.div`
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.3s ease-out;

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
`;

const SupplierPopupHeader = styled.div`
  padding: 24px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
`;

const SupplierPopupTitle = styled.h2`
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 12px;
  color: white;

  svg {
    font-size: 24px;
  }
`;

const SupplierPopupCloseButton = styled.button`
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  transition: all 0.2s;

  &:hover {
    background: rgba(255, 255, 255, 0.3);
  }
`;

const SupplierSearchInput = styled.input`
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;

  &:focus {
    outline: none;
    border-color: #40a9ff;
    box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
  }

  &::placeholder {
    color: #8c8c8c;
  }
`;

const SupplierPopupContent = styled.div`
  padding: 24px;
  overflow-y: auto;
  flex: 1;
`;

const SupplierList = styled.div`
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 400px;
  overflow-y: auto;
`;

const SupplierItem = styled.div`
  padding: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  background: white;

  &:hover {
    border-color: #667eea;
    background-color: #f9fafb;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
  }
`;

// ARES Popup Styled Components
const AresPopupOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100000;
  animation: fadeIn 0.2s ease-out;

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
`;

const AresPopupModal = styled.div`
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: slideUp 0.3s ease-out;

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
`;

const AresPopupHeader = styled.div`
  padding: 24px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
`;

const AresPopupTitle = styled.h2`
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 12px;
  color: white;

  svg {
    width: 24px;
    height: 24px;
  }
`;

const AresPopupCloseButton = styled.button`
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;

  &:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  svg {
    width: 20px;
    height: 20px;
  }
`;

const AresPopupContent = styled.div`
  padding: 24px;
  overflow-y: auto;
  flex: 1;
`;

const AresSearchInputField = styled.input`
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  font-size: 14px;
  margin-bottom: 20px;
  transition: all 0.2s;

  &:focus {
    outline: none;
    border-color: #40a9ff;
    box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
  }

  &::placeholder {
    color: #8c8c8c;
  }
`;

const AresList = styled.div`
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 400px;
  overflow-y: auto;
`;

const AresItem = styled.div`
  padding: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: white;
  position: relative;

  &:hover {
    border-color: #667eea;
    background-color: #f9fafb;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
  }
`;

const AresItemContent = styled.div`
  cursor: pointer;
  margin-bottom: ${props => props.hasButtons ? '12px' : '0'};
`;

const AresScopeBadges = styled.div`
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
`;

const AresScopeBadge = styled.div`
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  background: ${props => {
    if (props.scope === 'global') return 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    if (props.scope === 'usek') return 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
    return 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)'; // personal
  }};
  color: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

  svg {
    width: 12px;
    height: 12px;
  }
`;

const AresItemButtons = styled.div`
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
`;

const AresActionButton = styled.button`
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  white-space: nowrap;

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  &.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);

    &:hover:not(:disabled) {
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }

    &:active:not(:disabled) {
      transform: translateY(0);
    }
  }

  &.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);

    &:hover:not(:disabled) {
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
      transform: translateY(-1px);
    }

    &:active:not(:disabled) {
      transform: translateY(0);
    }
  }
`;

const AresLocationSelect = styled.select`
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  color: #262626;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;

  &:focus {
    outline: none;
    border-color: #40a9ff;
    box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
  }

  &:hover {
    border-color: #40a9ff;
  }
`;

const AresLoadingSpinner = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  color: #6b7280;

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
`;

// ðŸŽ¯ ARES Scope Selector Components - PÅ˜ESNÄš STEJNÃ‰ jako v SupplierAddDialog
const AresScopeSelector = styled.div`
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 8px;
  margin-bottom: 16px;
`;

const AresScopeOption = styled.button`
  padding: 12px;
  border: 2px solid ${props => props.selected ? '#667eea' : '#e5e7eb'};
  border-radius: 8px;
  background: ${props => props.selected ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'};
  color: ${props => props.selected ? 'white' : '#595959'};
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  opacity: ${props => props.disabled ? 0.5 : 1};
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 500;
  position: relative;

  &:hover:not(:disabled) {
    border-color: #667eea;
    background: ${props => props.selected ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f9fafb'};
  }

  svg {
    font-size: 18px;
  }
`;

const AresUsekGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 8px;
  margin-top: 12px;
`;

const AresUsekItem = styled.label`
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 10px;
  border: 2px solid ${props => props.selected ? '#667eea' : '#e5e7eb'};
  border-radius: 6px;
  background: ${props => props.selected ? 'rgba(102, 126, 234, 0.05)' : 'white'};
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  opacity: ${props => props.disabled ? 0.5 : 1};
  transition: all 0.2s;
  font-size: 13px;
  font-weight: 600;
  color: ${props => props.selected ? '#667eea' : '#374151'};

  &:hover:not([disabled]) {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
  }

  input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  }
`;

// IÄŒO Check Notification Components
const IcoNotification = styled.div`
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
  z-index: 100;

  &[data-status="checking"] {
    border-color: #3b82f6;
  }

  &[data-status="found-local"], &[data-status="found-ares"] {
    border-color: #10b981;
  }

  &[data-status="not-found"] {
    border-color: #ef4444;
  }
`;

const IcoNotificationTitle = styled.h4`
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
  color: ${props =>
    props.status === 'checking' ? '#3b82f6' :
    props.status === 'found' ? '#10b981' :
    props.status === 'not-found' ? '#ef4444' : '#111827'
  };
`;

const IcoNotificationMessage = styled.div`
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 12px;
  line-height: 1.4;
`;

const IcoNotificationActions = styled.div`
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
`;

const IcoActionButton = styled.button`
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;

  &.primary {
    background: #10b981;
    color: white;
    border: 1px solid #10b981;

    &:hover {
      background: #059669;
    }
  }

  &.fill-form {
    background: #3b82f6;
    color: white;
    border: 1px solid #3b82f6;

    &:hover {
      background: #2563eb;
    }
  }

  &.secondary {
    background: white;
    color: #6b7280;
    border: 1px solid #d1d5db;

    &:hover {
      background: #f9fafb;
      color: #374151;
    }
  }
`;

// CSS for spinner animation
const GlobalStyle = `
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
`;

// =============== TEMPLATE PREVIEW KOMPONENTY ===============

const PreviewModal = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999999;
  padding: 1rem;
`;
const PreviewContent = styled.div`
  background: white;
  border-radius: 8px;
  padding: 2rem;
  max-width: 700px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  position: relative;
`;

const PreviewHeader = styled.div`
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e5e7eb;
`;

const PreviewTitle = styled.h3`
  margin: 0;
  color: #1e293b;
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const PreviewCloseButton = styled.button`
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: transparent;
  border: none;
  border-radius: 4px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #64748b;
  transition: all 0.2s;

  &:hover {
    background: #f1f5f9;
    color: #1e293b;
  }
`;

const PreviewSection = styled.div`
  margin-bottom: 1.5rem;
  padding: 1.25rem;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
`;

const PreviewSectionTitle = styled.h4`
  margin: 0 0 1rem 0;
  color: #1e293b;
  font-size: 0.875rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
`;

const PreviewField = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 0.625rem 0;
  border-bottom: 1px solid #e5e7eb;

  &:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
`;

const PreviewFieldLabel = styled.span`
  color: #64748b;
  font-size: 0.875rem;
  font-weight: 500;
  min-width: 120px;
  flex-shrink: 0;
`;

const PreviewFieldValue = styled.span`
  color: #1e293b;
  font-size: 0.875rem;
  font-weight: 600;
  text-align: right;
  flex: 1;
  margin-left: 1rem;
  word-break: break-word;
`;

const PreviewItemsList = styled.div`
  margin-top: 0.75rem;
`;

const PreviewItem = styled.div`
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;

  &:last-child {
    margin-bottom: 0;
  }
`;

const PreviewItemTitle = styled.div`
  font-weight: 600;
  color: #1e293b;
  font-size: 0.875rem;
  margin-bottom: 0.375rem;
`;

const PreviewItemDetails = styled.div`
  font-size: 0.75rem;
  color: #64748b;
  display: flex;
  justify-content: space-between;
  align-items: center;
`;

const PreviewBadge = styled.span`
  background: ${props => {
    if (props.type === 'po') return '#3b82f6';
    if (props.type === 'details') return '#10b981';
    return '#8b5cf6';
  }};
  color: white;
  padding: 0.25rem 0.625rem;
  border-radius: 4px;
  font-size: 0.6875rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
`;

const PreviewEmptyState = styled.div`
  text-align: center;
  padding: 2rem;
  color: #9ca3af;
  font-style: italic;
`;

// Currency Input Wrapper - pro zobrazenÃ­ KÄ fixnÄ› vpravo
const CurrencyInputWrapper = styled.div`
  position: relative;
  display: flex;
  align-items: center;
`;

const CurrencySymbol = styled.span`
  position: absolute;
  right: 12px;
  color: ${props => props.disabled ? '#9ca3af' : '#374151'};
  font-weight: 600;
  font-size: 0.875rem;
  font-family: inherit;
  pointer-events: none;
  user-select: none;
  display: flex;
  align-items: center;
  height: 100%;
`;

// Currency Input Component - ZachovÃ¡vÃ¡ pozici kurzoru pÅ™i psanÃ­
function CurrencyInput({ fieldName, value, onChange, onBlur, disabled, hasError, placeholder }) {
  const inputRef = useRef(null);
  const [localValue, setLocalValue] = useState('');
  const [isFocused, setIsFocused] = useState(false);

  // Funkce pro formÃ¡tovÃ¡nÃ­ mÄ›ny (BEZ KÄ, protoÅ¾e to je fixnÄ› vpravo)
  const formatCurrency = (val) => {
    if (!val && val !== 0) return '';
    const num = parseFloat(val.toString().replace(/[^0-9.-]/g, ''));
    if (isNaN(num)) return '';
    // Pro faktury/ÃºÄetnictvÃ­ pÅ™esnÄ› 2 desetinnÃ¡ mÃ­sta
    return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ').replace('.', ',');
  };

  // Inicializace lokÃ¡lnÃ­ hodnoty z props (pouze kdyÅ¾ nenÃ­ focused)
  useEffect(() => {
    if (!isFocused) {
      const formattedValue = formatCurrency(value || '');
      if (localValue !== formattedValue) {
        setLocalValue(formattedValue);
      }
    }
  }, [value, isFocused]);

  const handleChange = (e) => {
    const newValue = e.target.value;

    // Aktualizovat lokÃ¡lnÃ­ hodnotu okamÅ¾itÄ› (bez formÃ¡tovÃ¡nÃ­)
    setLocalValue(newValue);

    // ðŸ”§ FIX: PÅ™ed odeslÃ¡nÃ­m do onChange oÄistit hodnotu od formÃ¡tovÃ¡nÃ­
    // Parsovat a vrÃ¡tit jako string s teÄkou (ne ÄÃ¡rkou) pro konzistentnÃ­ uklÃ¡dÃ¡nÃ­
    const cleanValue = newValue.replace(/[^\d,.-]/g, '').replace(',', '.');
    const numValue = parseFloat(cleanValue);
    const finalValue = isNaN(numValue) ? '' : numValue.toFixed(2);

    // âš¡ VOLAT onChange pÅ™i kaÅ¾dÃ©m znaku pro pÅ™epoÄet DPH s oÄiÅ¡tÄ›nou hodnotou
    onChange(fieldName, finalValue);
  };

  const handleFocus = () => {
    setIsFocused(true);
  };

  const handleBlurLocal = () => {
    setIsFocused(false);

    // FormÃ¡tovat hodnotu pÅ™i ztrÃ¡tÄ› fokusu (BEZ KÄ)
    const formatted = formatCurrency(localValue);
    setLocalValue(formatted);

    // ðŸ”§ FIX: PÅ™ed odeslÃ¡nÃ­m do onBlur oÄistit hodnotu od formÃ¡tovÃ¡nÃ­
    const cleanValue = localValue.replace(/[^\d,.-]/g, '').replace(',', '.');
    const numValue = parseFloat(cleanValue);
    const finalValue = isNaN(numValue) ? '' : numValue.toFixed(2);

    // âš¡ onChange uÅ¾ se volÃ¡ pÅ™i kaÅ¾dÃ©m znaku, pÅ™i blur jen formatujeme
    // Ale stÃ¡le musÃ­me zavolat parent onBlur pro validaci
    if (onBlur) {
      onBlur(fieldName, finalValue);
    }
  };

  return (
    <CurrencyInputWrapper>
      <InputWithIcon hasIcon>
        <Calculator />
        <Input
          ref={inputRef}
          type="text"
          name={fieldName}
          placeholder={placeholder}
          value={localValue}
          onChange={handleChange}
          onFocus={handleFocus}
          onBlur={handleBlurLocal}
          disabled={disabled}
          style={{ textAlign: 'right', paddingRight: '40px' }}
          hasError={hasError}
          hasIcon
        />
      </InputWithIcon>
      <CurrencySymbol disabled={disabled}>KÄ</CurrencySymbol>
    </CurrencyInputWrapper>
  );
}

// DatePicker Component - prevzato z src/components/DatePicker.js
function DatePicker({ fieldName, value, onChange, onBlur, disabled, hasError, placeholder = 'Vyberte datum' }) {
  const [isOpen, setIsOpen] = useState(false);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [openUpwards, setOpenUpwards] = useState(false); // ðŸŽ¯ Detekce smÄ›ru otevÅ™enÃ­
  const wrapperRef = useRef(null);
  const calendarRef = useRef(null);

  // Parse value to Date
  const selectedDate = value ? new Date(value) : null;

  // Update currentMonth when value changes to show correct month
  useEffect(() => {
    if (value) {
      const date = new Date(value);
      if (!isNaN(date.getTime())) {
        setCurrentMonth(date);
      }
    }
  }, [value]);

  // Close calendar when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen]);

  // ðŸŽ¯ Detekce smÄ›ru otevÅ™enÃ­ kalendÃ¡Å™e (nahoru/dolÅ¯) podle dostupnÃ©ho mÃ­sta
  useEffect(() => {
    if (isOpen && wrapperRef.current) {
      const checkPosition = () => {
        if (!wrapperRef.current) return;

        const buttonRect = wrapperRef.current.getBoundingClientRect();
        const calendarHeight = 380; // PÅ™ibliÅ¾nÃ¡ vÃ½Å¡ka kalendÃ¡Å™e
        const footerHeight = 54; // VÃ½Å¡ka fixnÃ­ patiÄky
        const buffer = 20; // Extra buffer pro bezpeÄnost

        const spaceBelow = window.innerHeight - buttonRect.bottom - footerHeight - buffer;
        const spaceAbove = buttonRect.top - buffer;

        // OtevÅ™i nahoru pokud: nenÃ­ dost mÃ­sta dole NEBO je nahoÅ™e vÃ½raznÄ› vÃ­ce mÃ­sta
        const shouldOpenUpward = spaceBelow < 300 || (spaceBelow < calendarHeight && spaceAbove > spaceBelow + 50);

        setOpenUpwards(shouldOpenUpward);
      };

      checkPosition();

      // PÅ™idej scroll listener pro re-pozicovÃ¡nÃ­
      const scrollContainer = document.querySelector('[class*="ScrollableContent"]');
      if (scrollContainer) {
        scrollContainer.addEventListener('scroll', checkPosition);
        return () => scrollContainer.removeEventListener('scroll', checkPosition);
      }
    }
  }, [isOpen]);

  // Format date for display
  const formatDisplayDate = (date) => {
    if (!date) return '';
    try {
      const d = new Date(date);
      if (isNaN(d.getTime())) return ''; // Invalid date check
      return d.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch (err) {
      return '';
    }
  };

  // Format date for input (YYYY-MM-DD)
  const formatInputDate = (date) => {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // Get calendar days for current month
  const getCalendarDays = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday = 0
    const days = [];

    // Previous month days
    for (let i = startDay - 1; i >= 0; i--) {
      const date = new Date(year, month, -i);
      days.push({ date, isOtherMonth: true });
    }

    // Current month days
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const date = new Date(year, month, i);
      days.push({ date, isOtherMonth: false });
    }

    // Next month days
    const remainingDays = 42 - days.length; // 6 rows * 7 days
    for (let i = 1; i <= remainingDays; i++) {
      const date = new Date(year, month + 1, i);
      days.push({ date, isOtherMonth: true });
    }

    return days;
  };

  const handleDateSelect = (date) => {
    const formattedDate = formatInputDate(date);
    // Volat onChange s hodnotou - fieldName je uÅ¾ v props
    onChange(formattedDate);
    if (onBlur) {
      onBlur(formattedDate);
    }
    setIsOpen(false);
  };

  const handleToday = (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    handleDateSelect(new Date());
  };

  const handleClear = (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    onChange('');
    if (onBlur) {
      onBlur('');
    }
    setIsOpen(false);
  };

  const prevMonth = (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
  };

  const nextMonth = (e) => {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
  };

  const today = new Date();
  const calendarDays = getCalendarDays();

  const displayText = value ? formatDisplayDate(value) : placeholder;

  return (
    <DatePickerWrapper ref={wrapperRef} data-field={fieldName}>
      <InputWithIcon hasIcon>
        <Calendar />
        <DateInputButton
          type="button"
          onClick={() => !disabled && setIsOpen(!isOpen)}
          disabled={disabled}
          hasError={hasError}
          hasValue={!!value}
          data-datepicker={fieldName}
        >
          {displayText}
        </DateInputButton>

        {/* KÅ™Ã­Å¾ek pro smazÃ¡nÃ­ */}
        {value && !disabled && (
          <DateClearButton
            type="button"
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              handleClear(e);
            }}
            title="Smazat datum"
          >
            âœ•
          </DateClearButton>
        )}

        {/* TlaÄÃ­tko pro dneÅ¡nÃ­ datum */}
        {!disabled && (
          <DateTodayButton
            type="button"
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              handleToday(e);
            }}
            title="Nastavit dneÅ¡nÃ­ datum"
          >
            ðŸ“…
          </DateTodayButton>
        )}
      </InputWithIcon>

      {isOpen && !disabled && (
        <DateCalendarPopup ref={calendarRef} openUpwards={openUpwards}>
          <CalendarHeader>
            <CalendarNav onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              prevMonth(e);
            }}>â—€</CalendarNav>
            <CalendarTitle>
              <span>{currentMonth.toLocaleDateString('cs-CZ', { month: 'long' })}</span>
              <span>{currentMonth.getFullYear()}</span>
            </CalendarTitle>
            <CalendarNav onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              nextMonth(e);
            }}>â–¶</CalendarNav>
          </CalendarHeader>

          <CalendarGrid>
            <CalendarDay>Po</CalendarDay>
            <CalendarDay>Ãšt</CalendarDay>
            <CalendarDay>St</CalendarDay>
            <CalendarDay>ÄŒt</CalendarDay>
            <CalendarDay>PÃ¡</CalendarDay>
            <CalendarDay>So</CalendarDay>
            <CalendarDay>Ne</CalendarDay>

            {calendarDays.map((day, index) => {
              const isToday = day.date.toDateString() === today.toDateString();
              const isSelected = selectedDate && day.date.toDateString() === selectedDate.toDateString();

              return (
                <CalendarDate
                  key={index}
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDateSelect(day.date);
                  }}
                  isToday={isToday}
                  isSelected={isSelected}
                  isOtherMonth={day.isOtherMonth}
                >
                  {day.date.getDate()}
                </CalendarDate>
              );
            })}
          </CalendarGrid>

          <CalendarFooter>
            <CalendarButton
              className="today"
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                handleDateSelect(new Date());
              }}
            >
              Dnes
            </CalendarButton>
            <CalendarButton
              className="clear"
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                onChange('');
                if (onBlur) {
                  onBlur('');
                }
                setIsOpen(false);
              }}
            >
              Smazat
            </CalendarButton>
          </CalendarFooter>
        </DateCalendarPopup>
      )}
    </DatePickerWrapper>
  );
}

// DatePicker styled components
const DatePickerWrapper = styled.div`
  position: relative;
  width: 100%;
`;

const DateInputButton = styled.button`
  width: 100%;
  display: block;
  padding: 0.75rem;
  padding-left: 2.75rem;
  padding-right: ${props => props.disabled ? '0.75rem' : props.hasValue ? '4.5rem' : '3rem'};
  border: 2px solid ${props => props.hasError ? '#ef4444' : '#e5e7eb'};
  border-radius: 8px;
  background: ${props => props.disabled ? '#f9fafb' : 'white'};
  color: ${props => props.disabled ? '#6b7280' : props.hasValue ? '#1f2937' : '#9ca3af'};
  font-size: 0.875rem;
  font-weight: ${props => props.hasValue && !props.disabled ? '600' : '400'};
  line-height: 1.5;
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  transition: all 0.2s ease;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 42px;
  box-sizing: border-box;

  &:hover:not(:disabled) {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
`;

const DateClearButton = styled.button`
  position: absolute;
  right: 36px;
  top: 50%;
  transform: translateY(-50%);
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s ease;
  z-index: 1;

  &:hover {
    background: #dc2626;
    transform: translateY(-50%) scale(1.1);
  }
`;

const DateTodayButton = styled.button`
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  color: #3b82f6;
  border: none;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 13px;
  font-weight: bold;
  transition: all 0.2s ease;
  z-index: 1;

  &:hover {
    background: transparent;
    color: #2563eb;
    transform: translateY(-50%) scale(1.15);
  }
`;

const DateCalendarPopup = styled.div`
  position: absolute;
  ${props => props.openUpwards ? `
    bottom: calc(100% + 4px);
    top: auto;
  ` : `
    top: calc(100% + 4px);
    bottom: auto;
  `}
  left: 0;
  right: 0;
  z-index: 10001;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  padding: 0.5rem;
`;

const CalendarHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  padding-bottom: 0.35rem;
  border-bottom: 1px solid #e5e7eb;
`;

const CalendarNav = styled.button`
  background: #f3f4f6;
  border: none;
  border-radius: 4px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #374151;
  font-weight: 600;
  font-size: 0.875rem;
  transition: all 0.2s ease;

  &:hover {
    background: #3b82f6;
    color: white;
    transform: scale(1.1);
  }
`;

const CalendarTitle = styled.div`
  font-weight: 600;
  font-size: 0.85rem;
  color: #111827;
  display: flex;
  gap: 0.35rem;
`;

const CalendarGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
`;

const CalendarDay = styled.div`
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  font-weight: 600;
  color: #6b7280;
  padding: 0.15rem;
`;

const CalendarDate = styled.button`
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  border: none;
  border-radius: 4px;
  background: ${props => props.isToday ? '#dbeafe' : props.isSelected ? '#3b82f6' : 'transparent'};
  color: ${props => props.isSelected ? 'white' : props.isOtherMonth ? '#9ca3af' : '#374151'};
  font-weight: ${props => props.isToday || props.isSelected ? '600' : '400'};
  cursor: pointer;
  transition: all 0.2s ease;

  &:hover {
    background: ${props => props.isSelected ? '#2563eb' : '#f3f4f6'};
    transform: scale(1.1);
    color: ${props => props.isSelected ? 'white' : '#111827'};
  }
`;

const CalendarFooter = styled.div`
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 2px solid #e5e7eb;
`;

const CalendarButton = styled.button`
  flex: 1;
  padding: 0.5rem;
  border: none;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;

  &.today {
    background: #dbeafe;
    color: #1e40af;

    &:hover {
      background: #bfdbfe;
    }
  }

  &.clear {
    background: #fee2e2;
    color: #991b1b;

    &:hover {
      background: #fecaca;
    }
  }
`;

// ========================================
// ðŸ“Ž FAKTURY PÅ˜ÃLOHY - nynÃ­ Å™eÅ¡eno samostatnou komponentou InvoiceAttachmentsCompact
// StarÃ© styled components (FakturaAttachmentsWrapper, DropZone, AttachmentsList, atd.) odstranÄ›ny
// ========================================

// ========================================
// ðŸ’¡ TOOLTIP PRO INFO FAKTURY
// ========================================

const FakturaInfoIconWrapper = styled.div`
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 6px;
  cursor: help;

  &:hover .tooltip-bubble {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  &:hover .help-icon {
    color: #3b82f6;
  }
`;

const FakturaInfoIcon = styled.span`
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  color: #6b7280;
  transition: color 0.2s ease;

  svg {
    width: 16px;
    height: 16px;
  }
`;

const FakturaTooltipBubble = styled.div`
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%) translateY(-4px);
  width: 320px;
  padding: 12px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  z-index: 1000;
  pointer-events: none;

  /* Å ipka dolÅ¯ */
  &::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid #ffffff;
  }

  &::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-top: 7px solid #e5e7eb;
    margin-top: 1px;
    z-index: -1;
  }
`;

const FakturaTooltipRow = styled.div`
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  font-size: 0.75rem;
  border-bottom: 1px solid #f3f4f6;

  &:last-child {
    border-bottom: none;
  }
`;

const FakturaTooltipLabel = styled.span`
  color: #6b7280;
  font-weight: 500;
`;

const FakturaTooltipValue = styled.span`
  color: #1f2937;
  font-weight: 600;
  text-align: right;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`;

/**
 * ï¿½ VALIDACE STÅ˜EDISEK: Fallback pro neaktivnÃ­ stÅ™ediska
 *
 * Zkontroluje, zda jsou vÅ¡echna stÅ™ediska aktivnÃ­.
 * Pokud ne, nahradÃ­ neaktivnÃ­ stÅ™ediska za "100" (SprÃ¡va Kladno).
 *
 * @param {string[]} strediskaCodes - Array kÃ³dÅ¯ stÅ™edisek
 * @param {Array} strediskaOptions - DostupnÃ¡ aktivnÃ­ stÅ™ediska
 * @returns {string[]} - ValidovanÃ½ array stÅ™edisek
 */
const validateAndFixStrediska = (strediskaCodes, strediskaOptions) => {
  if (!Array.isArray(strediskaCodes) || strediskaCodes.length === 0) {
    return strediskaCodes;
  }

  const FALLBACK_STREDISKO = "100"; // 100 SprÃ¡va Kladno

  return strediskaCodes.map(kod => {
    // Zkontroluj, zda stÅ™edisko existuje v aktivnÃ­ch
    const exists = strediskaOptions.find(opt =>
      (opt.value && opt.value === kod) ||
      (opt.kod && opt.kod === kod) ||
      (opt.kod_stavu && opt.kod_stavu === kod)
    );

    if (!exists) {
      return FALLBACK_STREDISKO;
    }

    return kod;
  });
};

/**
 * ï¿½ðŸ”„ CENTRÃLNÃ TRANSFORMACE: Backend â†’ Frontend
 *
 * Transformuje data z backendu do formÃ¡tu pro frontend form
 * Specifikace: DATA-FORMAT-CONTRACT.md
 *
 * @see src/utils/dataTransformHelpers.js
 * @param {object} backendData - Raw data z V2 API
 * @returns {object} - TransformovanÃ¡ data pro formData
 *
 * PouÅ¾itÃ­:
 * - Po INSERT/UPDATE objednÃ¡vky (saveOrderToAPI)
 * - Po naÄtenÃ­ objednÃ¡vky (loadOrderData)
 * - Po jakÃ©koli komunikaci s backendem
 */
const transformBackendDataToFrontend = (backendData) => {
  if (!backendData) return {};

  const transformed = { ...backendData };

  // 1. POLOÅ½KY: Backend vracÃ­ 'polozky', FE pouÅ¾Ã­vÃ¡ 'polozky_objednavky'
  if (backendData.polozky && !backendData.polozky_objednavky) {
    // ðŸ”§ FIX: Normalizovat ceny z DB - zajistit Å¾e jsou ve formÃ¡tu "12345.67" (string s teÄkou, 2 des. mÃ­sta)
    transformed.polozky_objednavky = Array.isArray(backendData.polozky) 
      ? backendData.polozky.map(item => ({
          ...item,
          cena_bez_dph: typeof item.cena_bez_dph === 'number' 
            ? item.cena_bez_dph.toFixed(2) 
            : (parseFloat((item.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0).toFixed(2),
          cena_s_dph: typeof item.cena_s_dph === 'number' 
            ? item.cena_s_dph.toFixed(2) 
            : (parseFloat((item.cena_s_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0).toFixed(2),
          sazba_dph: parseInt(item.sazba_dph) || 21
        }))
      : [];
    delete transformed.polozky; // VyÄistit BE pole
  }

  // 2. âœ… STÅ˜EDISKA: Normalizovat do array stringÅ¯
  if (backendData.strediska_kod) {
    transformed.strediska_kod = normalizeStrediskaFromBackend(backendData.strediska_kod);
  }

  // 3. âœ… FINANCOVÃNÃ: Normalizovat do flat struktury (POUZE LP a SMLOUVA pole)
  
  if (backendData.financovani) {
    
    const financing = normalizeFinancovaniFromBackend(backendData.financovani);
    
    
    Object.assign(transformed, financing);
  } else {
  }

  // 3.5. âœ… VÅ ECHNA POLE (LP, SMLOUVA, INDIVIDUÃLNÃ, POJISTNÃ UDÃLOST) se naÄÃ­tajÃ­ z financovani objektu
  // normalizeFinancovaniFromBackend() uÅ¾ to udÄ›lal v kroku 3

  // 4. ÄŒÃSLOVÃNÃ: cislo_objednavky â†’ ev_cislo
  if (backendData.cislo_objednavky && !backendData.ev_cislo) {
    transformed.ev_cislo = backendData.cislo_objednavky;
  }

  // 5. âœ… WORKFLOW: Parsovat stav_workflow_kod z JSON stringu na array
  // Backend vracÃ­: '["NOVA","SCHVALENA"]' â†’ FE oÄekÃ¡vÃ¡: ["NOVA","SCHVALENA"]
  if (backendData.stav_workflow_kod) {
    if (typeof backendData.stav_workflow_kod === 'string' && backendData.stav_workflow_kod.trim().startsWith('[')) {
      try {
        const parsed = JSON.parse(backendData.stav_workflow_kod);
        if (Array.isArray(parsed)) {
          transformed.stav_workflow_kod = parsed;
        }
      } catch (e) {
        // Zachovat pÅ¯vodnÃ­ hodnotu
      }
    }
    // Pokud uÅ¾ je array nebo nenÃ­ JSON string, zachovat pÅ¯vodnÃ­ hodnotu
  }

  // 5.5. âœ… DOKONÄŒENÃ: Zajistit sprÃ¡vnÃ© parsovÃ¡nÃ­ potvrzeni_dokonceni_objednavky
  // Backend vracÃ­ ÄÃ­slo (0/1), FE oÄekÃ¡vÃ¡ integer
  if (backendData.potvrzeni_dokonceni_objednavky !== undefined) {
    transformed.potvrzeni_dokonceni_objednavky = parseInt(backendData.potvrzeni_dokonceni_objednavky, 10) || 0;
  }

  // 5.6. âœ… STAV ODESLÃNÃ: Parsovat boolean/integer fieldy pro odeslÃ¡nÃ­ a storno
  // Backend mÅ¯Å¾e vracet 0/1 nebo true/false
  if (backendData.stav_odeslano !== undefined) {
    transformed.stav_odeslano = Boolean(backendData.stav_odeslano);
  }
  if (backendData.stav_stornovano !== undefined) {
    transformed.stav_stornovano = Boolean(backendData.stav_stornovano);
  }

  // â„¹ï¸  INDIVIDUÃLNÃ SCHVÃLENÃ a POJISTNÃ UDÃLOST: NaÄÃ­tajÃ­ se z root objektu (krok 3.5)
  //     stejnÄ› jako cislo_smlouvy - NEJSOU vnoÅ™enÃ© ve financovani objektu

  // 5.8. âœ… DATUMY A TEXTOVÃ‰ FIELDY: KopÃ­rovat pÅ™Ã­mo bez transformace
  const directCopyFields = [
    'datum_storna',
    'odeslani_storno_duvod',
    'identifikator',
    'dt_odeslani',
    'storno_uzivatel_id',
    'storno_provedl'
  ];

  directCopyFields.forEach(field => {
    if (backendData[field] !== undefined) {
      transformed[field] = backendData[field];
    }
  });

  // 6. POZNÃMKA: Backend vracÃ­ 'poznamka', FE pouÅ¾Ã­vÃ¡ 'poznamka_objednavky'
  if (backendData.poznamka) {
    // Pokud je poznÃ¡mka JSON string (chyba z Notes panelu), zkus parsovat text
    let poznamkaText = backendData.poznamka;

    // OpakovanÄ› parsuj, dokud je to JSON (Å™eÅ¡Ã­ vÃ­cenÃ¡sobnÃ© zanoÅ™ovÃ¡nÃ­)
    let maxIterations = 5; // Ochrana proti nekoneÄnÃ© smyÄce
    while (typeof poznamkaText === 'string' && poznamkaText.trim().startsWith('{') && maxIterations > 0) {
      try {
        const parsed = JSON.parse(poznamkaText);

        // Pokud mÃ¡ strukturu {text, datum, typ} z Notes panelu, extrahuj text
        if (parsed.text !== undefined) {
          poznamkaText = parsed.text;
        } else {
          // JinÃ¡ JSON struktura - zachovej pÅ¯vodnÃ­
          break;
        }
      } catch (e) {
        // NenÃ­ validnÃ­ JSON - konec parsovÃ¡nÃ­
        break;
      }
      maxIterations--;
    }

    transformed.poznamka_objednavky = poznamkaText;
    delete transformed.poznamka; // VyÄistit BE pole
  }

  // 7. âœ… POTVRZENÃ DODAVATELEM: Parsovat JSON string z DB
  // Backend vracÃ­: '{"potvrzeni":"ANO","zpusoby":["podepsana_objednavka"],"platba":"faktura"}'
  // FE oÄekÃ¡vÃ¡: {potvrzeni: 'ANO', zpusoby: ['podepsana_objednavka'], platba: 'faktura'}
  if (backendData.dodavatel_zpusob_potvrzeni && typeof backendData.dodavatel_zpusob_potvrzeni === 'string') {
    try {
      const parsed = JSON.parse(backendData.dodavatel_zpusob_potvrzeni);
      transformed.dodavatel_zpusob_potvrzeni = parsed;
    } catch (e) {
      // Zachovat pÅ¯vodnÃ­ hodnotu pÅ™i chybÄ›
    }
  }

  return transformed;
};

// OrderForm25 - Modern form for 2025 orders following workflow phases
function OrderForm25() {
  const navigate = useNavigate();
  const { showToast } = useContext(ToastContext) || {};
  const { userDetail, user_id, username, token, user, userPermissions, hasPermission } = useContext(AuthContext) || {};
  const { triggerActivity } = useActivity();
  const { progress, start: startGlobalProgress, setProgress: setGlobalProgress, done: doneGlobalProgress, fail: failGlobalProgress, reset: resetGlobalProgress } = useContext(ProgressContext) || {};

  // ðŸ›¡ï¸ REF: onDataLoaded protection flag - pouÅ¾Ã­t ref mÃ­sto window
  const onDataLoadedCalledRef = useRef(false);

  // ðŸŽ¯ OPRAVENO: PouÅ¾itÃ­ useLocation() pro reaktivnÃ­ URL parametry
  const location = useLocation();
  const urlParams = useMemo(() => new URLSearchParams(location.search), [location.search]);
  
  // ðŸŽ¯ PERSISTENCE: ÄŒti editOrderId z URL nebo z localStorage
  const editOrderIdFromUrl = urlParams.get('edit');
  const editOrderIdFromLS = localStorage.getItem('activeOrderEditId');
  const editOrderId = editOrderIdFromUrl || editOrderIdFromLS;
  
  // ðŸŽ¯ UloÅ¾ editOrderId do localStorage pÅ™i prvnÃ­m naÄtenÃ­ z URL
  useEffect(() => {
    if (editOrderIdFromUrl) {
      localStorage.setItem('activeOrderEditId', editOrderIdFromUrl);
    }
  }, [editOrderIdFromUrl]);
  
  const archivovanoParam = urlParams.get('archivovano'); // Parametr pro naÄtenÃ­ archivovanÃ½ch objednÃ¡vek

  // ðŸŽ¯ NOVÃ REFACTORED STATE MANAGEMENT

  // ðŸŽ¯ NOVÃ REFACTORED STATE MANAGEMENT
  // Callbacks pro useFormController budou definovÃ¡ny aÅ¾ po state variables

  // âš ï¸ POZOR: StarÃ© useState hooks nÃ­Å¾e budou postupnÄ› nahrazeny formController state
  // Pro nynÃ­ je ponechÃ¡vÃ¡me pro zachovÃ¡nÃ­ funkÄnosti bÄ›hem refactoringu

  const [sectionStates, setSectionStates] = useState({
    objednatel: false,
    schvaleni: false,
    prilohy: false,  // FÃZE 2: PÅ™Ã­lohy

    // RozÅ¡Ã­Å™enÃ© sekce - viditelnÃ© jen po schvÃ¡lenÃ­
    financovani: false,
    dodavatel: false,
    kontakt: false,
    detaily: false,
    dodaci_podminky: false,
    stav_odeslani: false,

    // NovÃ© sekce po stavu objednÃ¡vky
    potvrzeni_objednavky: false,
    registr_smluv: false,  // FÃZE 4: Checkbox "MÃ¡ bÃ½t zveÅ™ejnÄ›na"
    registr_smluv_vyplneni: false,  // FÃZE 5: VyplnÄ›nÃ­ datum + IDDT

    // FÃZE 3: Sekce po odeslÃ¡nÃ­ objednÃ¡vky
    prubeh_objednavky: false,
    dodaci_informace: false,
    fakturace: false,
    // vecna_spravnost: false,  // âŒ ODSTRANÄšNO - refaktorovÃ¡no na per-invoice
    dokonceni: false,  // FÃZE 8: DokonÄenÃ­ objednÃ¡vky
    storno_detail: false,
  });

  // State pro vlastnÃ­ select komponenty
  const [selectStates, setSelectStates] = useState({
    garant: false,
    prikazce: false,
    strediska: false,
    financovani: false,
    lp_kod: false,
  });

  // Search states pro selecty
  const [searchStates, setSearchStates] = useState({
    garant: '',
    prikazce: '',
    strediska: '',
    financovani: '',
    lp_kod: '',
  });

  // Tracking kterÃ© Custom Select fields byly "touched" (uÅ¾ivatel s nimi interagoval)
  const [touchedSelectFields, setTouchedSelectFields] = useState(new Set());

  // ðŸ†• Loading state pro ev. ÄÃ­slo (Å˜EÅ ENÃ PROBLÃ‰MU #1)
  const [isLoadingEvCislo, setIsLoadingEvCislo] = useState(false);

  // Fullscreen reÅ¾im
  const [isFullscreen, setIsFullscreen] = useState(false);

  // ðŸ’° State pro zbÃ½vajÃ­cÃ­ ÄÃ¡stky LP a smluv
  const [lpDetails, setLpDetails] = useState({}); // { lp_id: { zbyva_skutecne, celkovy_limit, ... } }
  const [loadingLpDetails, setLoadingLpDetails] = useState({}); // { lp_id: true/false }
  const [smlouvyList, setSmlouvyList] = useState([]); // Seznam vÅ¡ech smluv pro autocomplete
  const [loadingSmlouvyList, setLoadingSmlouvyList] = useState(false);
  const [smlouvaDetail, setSmlouvaDetail] = useState(null); // Detail vybranÃ© smlouvy
  const [loadingSmlouvaDetail, setLoadingSmlouvaDetail] = useState(false);
  const [smlouvaSearchTerm, setSmlouvaSearchTerm] = useState(''); // VyhledÃ¡vacÃ­ term pro smlouvy
  const [showSmlouvySuggestions, setShowSmlouvySuggestions] = useState(false);
  const [selectedSmlouvaSuggestionIndex, setSelectedSmlouvaSuggestionIndex] = useState(-1); // Index vybranÃ© poloÅ¾ky v dropdownu

  // ï¿½ï¸ REMOVED: Debug useEffect pro tracking re-renders
  // Byl vÄ›tÅ¡inou zakomentovanÃ½, odstranÄ›n pro ÄistÅ¡Ã­ kÃ³d
  // Pokud potÅ™ebujete debugovat re-renders, pouÅ¾ijte React DevTools Profiler

  // useEffect pro ESC klÃ¡vesy v fullscreen reÅ¾imu
  useEffect(() => {
    if (!isFullscreen) return;

    const handleEscKey = (event) => {
      if (event.key === 'Escape') {
        setIsFullscreen(false);
      }
    };

    window.addEventListener('keydown', handleEscKey);
    return () => window.removeEventListener('keydown', handleEscKey);
  }, [isFullscreen]);

  // âœ… REFACTORED: ÄŒÃ­selnÃ­ky budou definovÃ¡ny aÅ¾ po formController

  // âŒ DEPRECATED: dictionariesReadyPromiseRef - pouÅ¾ij areDictionariesReady mÃ­sto toho
  // const dictionariesReadyPromiseRef = useRef(dictionaries.readyPromise || null);
  // const dictionariesReadyResolveRef = useRef(null);

  // Stavy pro pÅ™Ã­lohy
  const [attachments, setAttachments] = useState([]); // LokÃ¡lnÃ­ seznam pÅ™Ã­loh
  // âœ… REMOVED: prilohyTypyOptions - nynÃ­ alias na dictionaries.data.prilohyTypyOptions
  // âœ… REMOVED: loadingPrilohyTypy - nynÃ­ alias na dictionaries.loading.prilohyTypy
  const [uploadingFiles, setUploadingFiles] = useState(false);
  const [dragOver, setDragOver] = useState(false);
  const [isCheckingSyncAttachments, setIsCheckingSyncAttachments] = useState(false);

  // State pro confirm dialog mazÃ¡nÃ­ pÅ™Ã­loh
  const [showDeleteAttachmentDialog, setShowDeleteAttachmentDialog] = useState(false);
  const [attachmentToDelete, setAttachmentToDelete] = useState(null);
  
  // State pro confirm dialog "Vymazat vÅ¡echny pÅ™Ã­lohy"
  const [showDeleteAllAttachmentsDialog, setShowDeleteAllAttachmentsDialog] = useState(false);

  // State pro novÃ© dialogy
  const [showSupplierSearchDialog, setShowSupplierSearchDialog] = useState(false);
  const [aresPopupOpen, setAresPopupOpen] = useState(false);
  const [supplierSearchTerm, setSupplierSearchTerm] = useState('');
  const [supplierSearchResults, setSupplierSearchResults] = useState([]);
  const [supplierSearchLoading, setSupplierSearchLoading] = useState(false);
  const [allSupplierContacts, setAllSupplierContacts] = useState([]); // VÅ¡echny kontakty naÄtenÃ© jednou
  const [aresSearch, setAresSearch] = useState('');
  const [aresResults, setAresResults] = useState([]);
  const [loadingAres, setLoadingAres] = useState(false);
  const [savingToLocal, setSavingToLocal] = useState(null); // ID zÃ¡znamu kterÃ½ se uklÃ¡dÃ¡
  const [aresScopeInfo, setAresScopeInfo] = useState({}); // { ico: { existsInPersonal, existsInUsek, existsInGlobal } }
  const [aresSelectedScope, setAresSelectedScope] = useState('personal'); // VybranÃ½ scope pro ARES dialog
  const [aresSelectedUseky, setAresSelectedUseky] = useState([]); // VybranÃ© Ãºseky pro ARES scope 'usek'

  // ðŸ¢ Ãšseky pro scope selector - naÄÃ­tajÃ­ se z API
  const [availableUseky, setAvailableUseky] = useState([]);
  const [usekyLoading, setUsekyLoading] = useState(false);

  // State pro automatickÃ© vyhledÃ¡vÃ¡nÃ­ IÄŒO
  const [showIcoCheck, setShowIcoCheck] = useState(false);

  // State pro progress indikÃ¡tor po uloÅ¾enÃ­
  const [showSaveProgress, setShowSaveProgress] = useState(false);
  const [saveProgress, setSaveProgress] = useState(0);
  const [saveProgressText, setSaveProgressText] = useState('');
  const [icoCheckStatus, setIcoCheckStatus] = useState(null); // null, 'checking', 'found-local', 'found-ares', 'not-found'

  // ðŸ”’ State pro odemykÃ¡nÃ­ FÃZE 3 SEKCÃ (Dodavatel â†’ Stav odeslÃ¡nÃ­)
  // âš ï¸ POZNÃMKA: FinancovÃ¡nÃ­ je souÄÃ¡stÃ­ FÃZE 1-2, ne FÃZE 3!
  const [isPhase3SectionsLocked, setIsPhase3SectionsLocked] = useState(false);
  const [isPhase3SectionsUnlocked, setIsPhase3SectionsUnlocked] = useState(false); // VÃ½chozÃ­ stav - zamÄeno
  const [isPhase3SectionsLockProcessedFromDB, setIsPhase3SectionsLockProcessedFromDB] = useState(false); // Flag Å¾e zamÄenÃ­ bylo zpracovÃ¡no pÅ™i naÄtenÃ­ z DB
  const [icoCheckData, setIcoCheckData] = useState(null);
  const [isIcoOperation, setIsIcoOperation] = useState(false);

  // State pro sledovÃ¡nÃ­ stavu sbalenÃ­/rozbalenÃ­ sekcÃ­
  const [areSectionsCollapsed, setAreSectionsCollapsed] = useState(false);

  // ðŸŽ¯ State pro "PÅ™idat do adresÃ¡Å™e" dialog
  const [showSupplierAddDialog, setShowSupplierAddDialog] = useState(false);
  const [existingSupplierCheck, setExistingSupplierCheck] = useState(null); // VÃ½sledek detekce dodavatele v DB
  const [supplierAutoFillSource, setSupplierAutoFillSource] = useState(null); // Zdroj automatickÃ©ho vyplnÄ›nÃ­ dodavatele (local/ares/smlouva)

  // ðŸŽ¯ State pro DOCX generÃ¡tor modal
  const [docxModalOpen, setDocxModalOpen] = useState(false);
  const [docxModalOrder, setDocxModalOrder] = useState(null);

  // ðŸŽ¯ NOVÃ‰ STAVY PRO Å˜EÅ ENÃ RACE CONDITION
  // Stav naÄÃ­tÃ¡nÃ­ ÄÃ­selnÃ­kÅ¯ (selecty, dropdown options)
  const [isLoadingCiselniky, setIsLoadingCiselniky] = useState(true);
  // Stav naÄÃ­tÃ¡nÃ­ dat formulÃ¡Å™e (editace objednÃ¡vky)
  const [isLoadingFormData, setIsLoadingFormData] = useState(false);

  // CelkovÃ½ loading stav pro inicializaci formulÃ¡Å™e
  const [isFormInitializing, setIsFormInitializing] = useState(true);
  const [initializationError, setInitializationError] = useState(null);
  const [isInitialized, setIsInitialized] = useState(false); // âœ… Flag pro dokonÄenou inicializaci

  // ðŸ” isEditMode - persistuje v localStorage pro sprÃ¡vnÃ© MenuBar zobrazenÃ­
  // NIKDY se nesmÃ­ ztratit po F5 refresh!
  const [isEditMode, setIsEditMode] = useState(() => {
    try {
      // ðŸŽ¯ NaÄÃ­st z DraftManager
      const metadata = draftManager.getMetadata();

      if (metadata && metadata.isEditMode === true) {
        // âœ… PÅ˜IDAT: NaÄÃ­st i savedOrderId pÅ™i inicializaci
        if (metadata.editOrderId || metadata.savedOrderId) {
          const orderId = metadata.editOrderId || metadata.savedOrderId;
          // PoznÃ¡mka: setSavedOrderId nelze volat zde (useState init),
          // takÅ¾e to udÄ›lÃ¡me v useEffect nÃ­Å¾e
        }

        return true;
      }
      return false;
    } catch {
      return false;
    }
  });

  // ï¿½ NaÄÃ­st Ãºseky z API pro ARES scope selector
  useEffect(() => {
    const loadUseky = async () => {
      if (!token || !username) return;

      setUsekyLoading(true);
      try {
        const usekyData = await fetchUskyList({ token, username });
        setAvailableUseky(usekyData || []);
      } catch (error) {
        setAvailableUseky([]);
      } finally {
        setUsekyLoading(false);
      }
    };

    loadUseky();
  }, [token, username]);

  // ï¿½ðŸŽ¯ NaÄÃ­st savedOrderId z metadata pÅ™i mount (nelze v useState init)
  useEffect(() => {
    if (!user_id) return;

    try {
      const metadata = draftManager.getMetadata();

      if (metadata && metadata.isEditMode === true) {
        // âœ… PÅ˜IDAT: NaÄÃ­st i editOrderId
        if (metadata.editOrderId || metadata.savedOrderId) {
          const orderId = metadata.editOrderId || metadata.savedOrderId;
          setSavedOrderId(orderId);
        }
      }
    } catch (error) {
    }
  }, [user_id]);

  // ðŸŽ¯ UloÅ¾it isEditMode pÅ™es DraftManager pÅ™i kaÅ¾dÃ© zmÄ›nÄ›
  useEffect(() => {
    if (user_id) {
      try {
        draftManager.saveMetadata({ isEditMode });
      } catch (error) {
      }
    }
  }, [isEditMode, user_id]);

  // ðŸŽ¯ UklÃ¡dat scroll pozici pÅ™i scrollovÃ¡nÃ­
  useEffect(() => {
    if (!user_id) return;

    let scrollTimeout;
    const handleScroll = (e) => {
      // Debounce - uklÃ¡dej aÅ¾ po 500ms neÄinnosti
      clearTimeout(scrollTimeout);
      // ðŸš« ZRUÅ ENO: UklÃ¡dÃ¡nÃ­ scroll pozice (na Å¾Ã¡dost uÅ¾ivatele)
      // scrollTimeout = setTimeout(() => {
      //   try {
      //     const scrollContainer = scrollableContentRef.current;
      //     const scrollPosition = scrollContainer ? scrollContainer.scrollTop : (window.pageYOffset || document.documentElement.scrollTop);
      //     draftManager.saveMetadata({ scrollPosition });
      //     // console.log('ðŸ“Š [Scroll] UloÅ¾ena pozice:', scrollPosition);
      //   } catch (error) {
      //     console.error('âš ï¸ [Scroll] Chyba pÅ™i uklÃ¡dÃ¡nÃ­ pozice:', error);
      //   }
      // }, 500);
    };

    // PÅ™ipoj listener pÅ™Ã­mo na ref element
    const scrollContainer = scrollableContentRef.current;
    if (scrollContainer) {
      scrollContainer.addEventListener('scroll', handleScroll);
    } else {
      // Fallback na window scroll
      window.addEventListener('scroll', handleScroll);
    }

    return () => {
      clearTimeout(scrollTimeout);
      if (scrollContainer) {
        scrollContainer.removeEventListener('scroll', handleScroll);
      } else {
        window.removeEventListener('scroll', handleScroll);
      }
    };
  }, [user_id]);

  // Cache pro naÄtenÃ© uÅ¾ivatele z DB (pro getUserNameById)
  const [userNamesCache, setUserNamesCache] = useState({});

  // ðŸŽ¯ CENTRALIZOVANÃ WORKFLOW MANAGER - PÅ˜ESUNUT PO DEFINICI formData
  // (NynÃ­ nÃ­Å¾e v kÃ³du, po useState formData)

  // Helper funkce pro prÃ¡ci s workflow stavy (modifikace)
  const addWorkflowState = (currentStates, newState) => {
    const states = parseWorkflowStates(currentStates);
    if (!states.includes(newState)) {
      states.push(newState);
    }
    return JSON.stringify(states);
  };

  const removeWorkflowState = (currentStates, stateToRemove) => {
    const states = parseWorkflowStates(currentStates);
    const filtered = states.filter(s => s !== stateToRemove);
    return JSON.stringify(filtered);
  };

  // Helper funkce pro zÃ­skÃ¡nÃ­ textu stavu objednÃ¡vky z DB
  const getOrderStatusInfo = () => {
    // MapovÃ¡nÃ­ stavÅ¯ na ÄeskÃ© texty a detaily
    const statusMapping = {
      'NOVA': {
        text: 'NovÃ¡ objednÃ¡vka',
        icon: 'ðŸ“',
        type: 'info',
        description: 'ObjednÃ¡vka je v pÅ™Ã­pravÄ›'
      },
      'ODESLANA_KE_SCHVALENI': {
        text: 'OdeslÃ¡no ke schvÃ¡lenÃ­',
        icon: 'ðŸ“¤',
        type: 'warning',
        description: 'ObjednÃ¡vka ÄekÃ¡ na schvÃ¡lenÃ­ pÅ™Ã­sluÅ¡nÃ½m schvalovatelem'
      },
      'SCHVALENA': {
        text: 'SchvÃ¡lenÃ¡ objednÃ¡vka',
        icon: 'âœ…',
        type: 'success',
        description: 'ObjednÃ¡vka byla schvÃ¡lena a je pÅ™ipravena k dalÅ¡Ã­m krokÅ¯m'
      },
      'ZAMITNUTA': {
        text: 'ZamÃ­tnutÃ¡ objednÃ¡vka',
        icon: 'âŒ',
        type: 'error',
        description: 'ObjednÃ¡vka byla zamÃ­tnuta'
      },
      'NESCHVALENA': {
        text: 'NeschvÃ¡lenÃ¡ objednÃ¡vka',
        icon: 'âŒ',
        type: 'error',
        description: 'ObjednÃ¡vka nebyla schvÃ¡lena'
      },
      'CEKA_SE': {
        text: 'ÄŒekÃ¡ se na rozhodnutÃ­',
        icon: 'â³',
        type: 'warning',
        description: 'ÄŒekÃ¡ se na dalÅ¡Ã­ kroky'
      },
      'ROZPRACOVANA': {
        text: 'RozpracovanÃ¡ objednÃ¡vka',
        icon: 'ðŸ”„',
        type: 'info',
        description: 'ObjednÃ¡vka se zpracovÃ¡vÃ¡'
      },
      'ODESLANA': {
        text: 'OdeslÃ¡no dodavateli',
        icon: 'ðŸ“©',
        type: 'info',
        description: 'ObjednÃ¡vka byla odeslÃ¡na dodavateli'
      },
      'POTVRZENA': {
        text: 'Potvrzeno dodavatelem',
        icon: 'âœ“',
        type: 'success',
        description: 'Dodavatel potvrdil objednÃ¡vku'
      },
      'DOKONCENA': {
        text: 'DokonÄenÃ­ objednÃ¡vky',
        icon: 'ðŸ',
        type: 'success',
        description: 'ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› dokonÄena'
      },
      'ZRUSENA': {
        text: 'StornovanÃ¡ objednÃ¡vka',
        icon: 'ðŸš«',
        type: 'error',
        description: 'ObjednÃ¡vka byla stornovÃ¡na'
      }
    };

    // ZÃ­skej aktuÃ¡lnÃ­ stav z workflow
    const currentStates = parseWorkflowStates(formData.stav_workflow_kod);
    const latestState = currentStates[currentStates.length - 1];

    // Pokud existuje stav_objednavky, preferuj ho
    if (formData.stav_objednavky) {
      // Najdi stav podle nÃ¡zvu
      const foundState = Object.entries(statusMapping).find(([key, info]) =>
        info.text === formData.stav_objednavky ||
        key === formData.stav_objednavky
      );

      if (foundState) {
        return {
          ...foundState[1],
          code: foundState[0],
          hasReason: !!formData.schvaleni_komentar,
          reason: formData.schvaleni_komentar,
          dateApproved: formData.dt_schvaleni
        };
      }
    }

    // Fallback na workflow stav
    const statusInfo = statusMapping[latestState] || statusMapping['NOVA'];

    return {
      ...statusInfo,
      code: latestState,
      hasReason: !!formData.schvaleni_komentar,
      reason: formData.schvaleni_komentar,
      dateApproved: formData.dt_schvaleni
    };
  };

  // âŒ DEPRECATED: getPhaseThemeInternal a getPhaseProgressInternal
  // PÅ™esunuty do useWorkflowManager pro eliminaci duplicit
  // PouÅ¾ij: workflowManager.getPhaseTheme() a workflowManager.getPhaseProgress()

  // âœ… FÃ¡zovÃ¡nÃ­ objednÃ¡vky (8 fÃ¡zÃ­ podle workflow)
  // FÃZE 1/8: NOVA - VytvoÅ™enÃ­ konceptu
  // FÃZE 2/8: ODESLANA_KE_SCHVALENI - ÄŒekÃ¡ na schvÃ¡lenÃ­
  // FÃZE 3/8: SCHVALENA + ROZPRACOVANA - SchvÃ¡lenÃ¡, rozpracovanÃ¡
  // FÃZE 4/8: ODESLANA + POTVRZENA - PotvrzenÃ­ dodavatele + checkbox "MÃ¡ bÃ½t zveÅ™ejnÄ›na"
  // FÃZE 5/8: UVEREJNIT - VyplnÄ›nÃ­ registru smluv (datum + IDDT) [VOLITELNÃ - pouze kdyÅ¾ ANO]
  // FÃZE 6/8: UVEREJNENA / NEUVEREJNIT / FAKTURACE - Fakturace
  // FÃZE 7/8: VECNA_SPRAVNOST - Kontrola vÄ›cnÃ© sprÃ¡vnosti
  // FÃZE 8/8: ZKONTROLOVANA â†’ zobrazÃ­ sekci DokonÄenÃ­ â†’ pÅ™idÃ¡ DOKONCENA a proces konÄÃ­

  const [formData, _setFormData] = useState({
    // Informace o objednateli (naÄteno z userDetail)
    objednatel_id: '', // z databÃ¡ze uÅ¾ivatelÅ¯
    uzivatel_id: '', // souÄasnÃ½ uÅ¾ivatel (vytvoÅ™il objednÃ¡vku)
    garant_uzivatel_id: '', // garant objednÃ¡vky
    prikazce_id: '', // pÅ™Ã­kazce objednÃ¡vky (dÅ™Ã­ve po_uzivatel)
    jmeno: '', // naÄteno z userDetail
    email: '', // naÄteno z userDetail
    telefon: '', // naÄteno z userDetail

    // SchvÃ¡lenÃ­ nÃ¡kupu PO
    predmet: '',
    strediska_kod: [], // ZmÄ›nÄ›no na pole pro multi-select
    max_cena_s_dph: '',
    popis_pozadavku: '', // PodrobnÃ½ popis poÅ¾adavku
    mimoradna_udalost: false, // MimoÅ™Ã¡dnÃ¡ udÃ¡lost (krize, havÃ¡rie)

    // Workflow system - pouÅ¾Ã­vÃ¡ novÃ© konstanty
    stav_workflow_kod: JSON.stringify(['NOVA']), // âœ… VÃ½chozÃ­ stav: NOVA (novÃ¡/koncept objednÃ¡vka)
    schvalovatel_id: '', // ID uÅ¾ivatele, kterÃ½ schvÃ¡lil/zamÃ­tl
    dt_schvaleni: '', // Datum schvÃ¡lenÃ­/zamÃ­tnutÃ­
    schvaleni_komentar: '', // KomentÃ¡Å™/dÅ¯vod schvÃ¡lenÃ­ Äi zamÃ­tnutÃ­

    // === DALÅ Ã ÄŒÃST - VIDITELNÃ JEN PO SCHVÃLENÃ ===

    // FinancovÃ¡nÃ­ objednÃ¡vky
    zpusob_financovani: '',
    financovani: '', // JSON pole pro uloÅ¾enÃ­ do DB
    // DynamickÃ¡ pole pro financovÃ¡nÃ­
    lp_kod: [], // LP kÃ³dy pro LimitovanÃ½ pÅ™Ã­slib (multiselect)
    cislo_smlouvy: '', // ÄŒÃ­slo smlouvy pro Smlouva
    smlouva_poznamka: '', // PoznÃ¡mka ke smlouvÄ›
    individualni_schvaleni: '', // IdentifikÃ¡tor pro IndividuÃ¡lnÃ­ schvÃ¡lenÃ­
    individualni_poznamka: '', // PoznÃ¡mka pro IndividuÃ¡lnÃ­ schvÃ¡lenÃ­
    pojistna_udalost_cislo: '', // ÄŒÃ­slo pojistnÃ© udÃ¡losti
    pojistna_udalost_poznamka: '', // PoznÃ¡mka k pojistnÃ© udÃ¡losti

    // Informace o dodavateli
    dodavatel_id: '',
    dodavatel_nazev: '',
    dodavatel_adresa: '',
    dodavatel_ico: '',
    dodavatel_dic: '',
    dodavatel_zastoupeny: '',

    // KontaktnÃ­ osoba dodavatele
    dodavatel_kontakt_jmeno: '',
    dodavatel_kontakt_email: '',
    dodavatel_kontakt_telefon: '',

    // Detaily objednÃ¡vky
    druh_objednavky: '',
    druh_objednavky_kod: '', // SprÃ¡vnÃ© pole pro databÃ¡zi
    polozky_objednavky: [], // PoloÅ¾ky se inicializujÃ­ v useEffect
    faktury: [], // Faktury se naÄtou s objednÃ¡vkou z BE
    poznamka_objednavky: '',

    // DodacÃ­ a zÃ¡ruÄnÃ­ podmÃ­nky
    dt_predpokladany_termin_dodani: '',
    misto_dodani: '',
    zaruka: '',

    // Stav odeslÃ¡nÃ­ objednÃ¡vky
    stav_odeslano: false, // FÃZE 3: checkbox "OdeslÃ¡no"
    datum_odeslani: '',
    stav_stornovano: false, // FÃZE 3: checkbox "StornovÃ¡no"
    datum_storna: '',
    storno_uzivatel_id: '', // ID uÅ¾ivatele, kterÃ½ provedl storno
    odeslani_storno_duvod: '', // DB pole pro dÅ¯vod storna
    storno_provedl: '',
    storno_poznamky: '',

    // PotvrzenÃ­ objednÃ¡vky od dodavatele - struktura JSON pro DB
    dodavatel_zpusob_potvrzeni: {
      potvrzeni: 'NE', // 'ANO' nebo 'NE'
      zpusoby: [], // pole zpÅ¯sobÅ¯: 'email', 'telefon', 'podepsana_objednavka', 'eshop'
      platba: 'faktura' // vÅ¾dy faktura (pevnÄ› nastaveno)
    },
    dt_akceptace: '',

    // Registr smluv
    dt_zverejneni: '',
    registr_iddt: '',
    ma_byt_zverejnena: false,

    // === FÃZE 3: SEKCE PO ODESLÃNÃ OBJEDNÃVKY ===

    // PrÅ¯bÄ›h objednÃ¡vky
    stav_u_dodavatele: '', // 'potvrzeno', 've_vyrobe', 'pripraveno', 'odeslano', 'doruceno', 'stornovÃ¡no'
    datum_zmeny_stavu: '',
    poznamka_stav: '',

    // DodacÃ­ informace
    cislo_zasilky: '',
    prepravce: '',
    ocekavane_doruceni: '',
    skutecne_doruceni: '',

    // Fakturace
    cislo_faktury: '',
    datum_faktury: '',
    castka_bez_dph: '',
    castka_s_dph: '',
    datum_splatnosti: '',
    datum_zaplaceni: '',
    faktury_objednavky: [], // ðŸ’° Faktury k objednÃ¡vce - uklÃ¡dajÃ­ se do konceptu

    // âŒ VÄ›cnÃ¡ sprÃ¡vnost - FÃZE 7 ODSTRANÄšNA - refaktorovÃ¡no na per-invoice
    // vecna_spravnost_umisteni_majetku: '', 
    // vecna_spravnost_poznamka: '',
    // vecna_spravnost_potvrzeno: 0,

    // DokonÄenÃ­ objednÃ¡vky - FÃZE 8
    potvrzeni_dokonceni_objednavky: 0, // ANO/NE checkbox (0/1) - finÃ¡lnÃ­ potvrzenÃ­

    // PÅ™Ã­lohy k objednÃ¡vce
    prilohy_dokumenty: [],

    // EvidenÄnÃ­ ÄÃ­slo objednÃ¡vky (naÄteno z API)
    ev_cislo: '',

    // DoÄasnÃ© datum objednÃ¡vky pro koncepty (generuje se na FE, pÅ™epÃ­Å¡e se pÅ™i prvnÃ­m uloÅ¾enÃ­ na BE)
    temp_datum_objednavky: new Date().toISOString().split('T')[0], // ðŸ”§ OPRAVA: Nastavit ihned pÅ™i inicializaci

    // Datum vytvoÅ™enÃ­ objednÃ¡vky (nastavuje se aÅ¾ pÅ™i uloÅ¾enÃ­ do DB)
    datum_vytvoreni: ''
  });

  // ðŸ› DEBUG: Interceptor pro setFormData - trackuje vÅ¡echna volÃ¡nÃ­
  const setFormData = useCallback((newData) => {
    const stack = new Error().stack;
    const caller = stack.split('\n')[2]?.trim() || 'unknown';

    if (typeof newData === 'function') {
      _setFormData(prev => {
        const result = newData(prev);
        // DEBUG: FORMDATA UPDATE logging removed for performance
        return result;
      });
    } else {
      _setFormData(newData);
    }
  }, []);

  // ðŸ”’ Registrace aktivnÃ­ objednÃ¡vky (pro detekci konfliktu v InvoiceEvidencePage)
  useEffect(() => {
    if (formData.id) {
      window.__activeOrderFormId = formData.id;
      window.__activeOrderFormEvCislo = formData.cislo_objednavky || formData.ev_cislo || `#${formData.id}`;
    }
    
    return () => {
      delete window.__activeOrderFormId;
      delete window.__activeOrderFormEvCislo;
    };
  }, [formData.id, formData.cislo_objednavky, formData.ev_cislo]);

  // ðŸ“¸ SNAPSHOT pÅ¯vodnÃ­ho stavu formulÃ¡Å™e pro detekci zmÄ›n
  const originalFormDataRef = useRef(null);

  // ðŸ” Detekce zmÄ›n v objednÃ¡vce - porovnÃ¡vÃ¡ aktuÃ¡lnÃ­ stav s pÅ¯vodnÃ­m snapshotem
  const hasUnsavedChanges = useMemo(() => {
    if (!originalFormDataRef.current || !formData.id) {
      return false; // NovÃ¡ objednÃ¡vka nebo snapshot jeÅ¡tÄ› nenÃ­ vytvoÅ™en
    }

    // PorovnÃ¡nÃ­ klÃ­ÄovÃ½ch polÃ­ formulÃ¡Å™e
    const original = originalFormDataRef.current;
    
    // Pole kterÃ¡ budeme porovnÃ¡vat
    const fieldsToCompare = [
      'predmet', 'max_cena_s_dph', 'popis_pozadavku',
      'zpusob_financovani', 'dodavatel_nazev', 'dodavatel_ico',
      'druh_objednavky_kod', 'poznamka_objednavky',
      'dt_predpokladany_termin_dodani', 'misto_dodani', 'zaruka'
    ];

    // Kontrola zÃ¡kladnÃ­ch polÃ­
    for (const field of fieldsToCompare) {
      if (original[field] !== formData[field]) {
        return true;
      }
    }

    // Kontrola pole poloÅ¾ek objednÃ¡vky
    const originalPolozky = original.polozky_objednavky || [];
    const currentPolozky = formData.polozky_objednavky || [];
    
    if (originalPolozky.length !== currentPolozky.length) {
      return true;
    }

    // PorovnÃ¡nÃ­ jednotlivÃ½ch poloÅ¾ek
    for (let i = 0; i < originalPolozky.length; i++) {
      const origItem = originalPolozky[i];
      const currItem = currentPolozky[i];
      
      if (origItem.popis !== currItem.popis ||
          origItem.mnozstvi !== currItem.mnozstvi ||
          origItem.cena_jednotkova !== currItem.cena_jednotkova) {
        return true;
      }
    }

    return false;
  }, [formData]);

  // CENTRALIZOVANY WORKFLOW MANAGER
  // Poskytuje jednotnou logiku pro workflow (eliminuje duplicity)
  // MUSI byt AZ PO useState(formData), protoze potrebuje formData jako zavislost
  // JEDINA PROMENNA pro archivovane objednavky
  const isArchived = useMemo(() => {
    return formData.stav_objednavky === 'ARCHIVOVANO' ||
           formData.stav_objednavky === 'ArchivovÃ¡no';
  }, [formData.stav_objednavky]);

  const workflowManager = useWorkflowManager(formData, isArchived);

  // RozbalenÃ­ API pro snadnÄ›jÅ¡Ã­ pouÅ¾itÃ­
  const {
    currentPhase,
    phaseTheme: currentPhaseTheme,
    phaseProgress,
    mainWorkflowState,
    getCurrentPhase,
    getPhaseProgress,
    getPhaseTheme,
    parseWorkflowStates,
    hasWorkflowState,
    // ðŸ’° Payment mode detection
    isPokladna,
    // ðŸ†• Workflow locking states z WorkflowManager
    isWorkflowCompleted, // ðŸ”’ TRUE pro DOKONCENA, ZAMITNUTA, ZRUSENA (vÅ¡echny koneÄnÃ© stavy workflow)
    isWorkflowRejected,
    isWorkflowCancelled,
    // ðŸ”„ Force refresh API
    forceRefresh: workflowForceRefresh,
    // ðŸ”’ Section state API
    getSectionState
  } = workflowManager;

  // ðŸŽ¯ SledovÃ¡nÃ­ ID uloÅ¾enÃ© objednÃ¡vky (MUSÃ bÃ½t PÅ˜ED useEffect, kterÃ½ ho pouÅ¾Ã­vÃ¡!)
  const [savedOrderId, setSavedOrderId] = useState(null);
  
  // ðŸŽ¯ PERSISTENCE: Sleduj zmÄ›ny savedOrderId a uklÃ¡dej do LS (pro ADMIN/approve reÅ¾im)
  // KdyÅ¾ ADMIN pokraÄuje v editaci po schvÃ¡lenÃ­, musÃ­ se editOrderId zachovat pÅ™es refresh
  useEffect(() => {
    if (savedOrderId && !editOrderIdFromUrl) {
      // Pouze pokud NENÃ editOrderId v URL (tj. refresh strÃ¡nky nebo pokraÄovÃ¡nÃ­ v prÃ¡ci)
      localStorage.setItem('activeOrderEditId', String(savedOrderId));
    }
  }, [savedOrderId, editOrderIdFromUrl]);

  // ðŸŽ¯ [WORKFLOW MANAGER] LogovÃ¡nÃ­ zmÄ›ny fÃ¡ze - DISABLED to prevent infinite loop
  // useEffect(() => {
  //   if (formData.id || savedOrderId) {
  //   }
  // }, [currentPhase, currentPhaseTheme, mainWorkflowState, formData.id, savedOrderId]);

  // âŒ DEPRECATED: StarÃ© helper funkce pÅ™esunuty do useWorkflowManager
  // parseWorkflowStates() - nynÃ­ z workflowManager
  // hasWorkflowState() - nynÃ­ z workflowManager
  // getCurrentPhase() - nynÃ­ z workflowManager
  // getPhaseProgressInternal() - nahrazeno workflowManager.getPhaseProgress()
  // getPhaseThemeInternal() - nahrazeno workflowManager.getPhaseTheme()

  // âŒ REMOVED: (formData.id || savedOrderId) - duplicitnÃ­ state, pouÅ¾ij savedOrderId mÃ­sto toho
  // UrÄenÃ­ zda je to novÃ¡ objednÃ¡vka - odvozeno z formData.id nebo savedOrderId
  const isNewOrder = useMemo(() => !formData.id && !savedOrderId, [formData.id, savedOrderId]);

  // ï¿½ï¸ COMPUTED: Detekce archivovanÃ© objednÃ¡vky
  // Flag kterÃ½ indikuje, Å¾e pracujeme s archivovanou objednÃ¡vkou
  const isArchivedOrder = isArchived;

  // Pro archivovanÃ© objednÃ¡vky nastavit fÃ¡zi na maximum (8)
  // POZNÃMKA: currentPhase uÅ¾ je 8 pro archivovanÃ© dÃ­ky logice v useWorkflowManager
  const currentPhaseOverride = currentPhase;

  // ðŸ›ï¸ OVERRIDE: Pro archivovanÃ© objednÃ¡vky zobrazit vÅ¡echny fÃ¡ze jako dokonÄenÃ©
  const phaseProgressOverride = useMemo(() => {
    if (!isArchivedOrder) {
      return phaseProgress; // BÄ›Å¾nÃ¡ objednÃ¡vka - pouÅ¾ij originÃ¡lnÃ­ progress
    }

    // ArchivovanÃ¡ objednÃ¡vka - vÅ¡echny fÃ¡ze completed
    return {
      ...phaseProgress,
      phases: phaseProgress.phases.map(phase => ({
        ...phase,
        isVisible: true,
        fillClass: 'completed' // VÅ¡echny fÃ¡ze jako dokonÄenÃ©
      }))
    };
  }, [isArchivedOrder, phaseProgress]);



  // ï¿½ðŸŽ¯ [GLOBAL STATE] Export stavu pro Layout.js MenuBar
  // MÃ­sto sloÅ¾itÃ© logiky s draft metadata - OrderForm25 pÅ™Ã­mo vÃ­, co edituje!
  useEffect(() => {
    window.__orderFormState = {
      isEditMode: !isNewOrder,
      orderId: savedOrderId || formData.id,
      orderNumber: formData.cislo_objednavky,
      currentPhase,
      mainWorkflowState,
      timestamp: Date.now()
    };

    // Broadcast zmÄ›nu (pro Layout.js)
    window.dispatchEvent(new CustomEvent('orderFormStateChange', {
      detail: window.__orderFormState
    }));
  }, [isNewOrder, savedOrderId, formData.id, formData.cislo_objednavky, currentPhase, mainWorkflowState]);

  // Loading state pro tlaÄÃ­tka
  const [isSaving, setIsSaving] = useState(false);
  const [isSavingDraft, setIsSavingDraft] = useState(false);
  const [disableAutosave, setDisableAutosave] = useState(false); // âŒ ZAKÃZAT autosave po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
  const disableAutosaveRef = useRef(false); // ðŸš€ REF pro OKAMÅ½ITOU kontrolu (bez async delay)
  const [lastAutoSave, setLastAutoSave] = useState(null);
  const [isAutoSaving, setIsAutoSaving] = useState(false);
  const [dataSource, setDataSource] = useState(null); // 'concept', 'database', null
  const [isDraftLoaded, setIsDraftLoaded] = useState(false); // sleduje zda uÅ¾ probÄ›hlo naÄtenÃ­ draftu
  const autoSaveTimerRef = useRef(null); // â±ï¸ Timer pro debounce autosave pÅ™i psanÃ­
  
  // ðŸš¨ KRITICKÃ FLAG: GlobÃ¡lnÃ­ blokovÃ¡nÃ­ VÅ ECH save operacÃ­ pÅ™i zavÃ­rÃ¡nÃ­
  const isClosingRef = useRef(false);

  // ðŸŽ¯ CENTRALIZOVANÃ AUTOSAVE s debounce logikou (3 sekundy neaktivity)
  const autosaveCallbackRef = useRef(null);

  // PomocnÃ¡ funkce pro saveDraft - bude nastavena pozdÄ›ji
  const performSaveDraft = useCallback((isAutoSave) => {
    if (autosaveCallbackRef.current) {
      autosaveCallbackRef.current(isAutoSave);
    }
  }, []);
  // ðŸŽ¤ POZOR: HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ je implementovÃ¡no GLOBÃLNÄš v Layout.js
  // OrderForm25 NEPOUÅ½ÃVÃ vlastnÃ­ hook, protoÅ¾e by to zpÅ¯sobovalo konflikty
  // Pokud uÅ¾ivatel chce nahrÃ¡vat do poznÃ¡mky formulÃ¡Å™e:
  //   1. Fokusne textarea poznÃ¡mky
  //   2. ZmÃ¡Äkne CTRL+Space
  //   3. Text se vloÅ¾Ã­ pÅ™Ã­mo do textarea (dÃ­ky logice v hooku)

  // Tracking pro unlock - ID objednÃ¡vky kterou je potÅ™eba odemknout pÅ™i zruÅ¡enÃ­
  const [sourceOrderIdForUnlock, setSourceOrderIdForUnlock] = useState(null);

  // Stav pro cancel confirm modal
  const [showCancelConfirmModal, setShowCancelConfirmModal] = useState(false);
  const [cancelWarningMessage, setCancelWarningMessage] = useState('');

  // Stavy pro sprÃ¡vu Å¡ablon (pÅ™evzato z OrderFormComponent)
  const [savedTemplates, setSavedTemplates] = useState([]); // [{ name, data, ts }]
  const [serverTemplates, setServerTemplates] = useState([]); // array of { name, data, ts, type, id, user_id }
  const [templatesFetchStatus, setTemplatesFetchStatus] = useState({ status: null, error: null });
  const [templatesLoading, setTemplatesLoading] = useState(false);
  const [showTemplateSaveModal, setShowTemplateSaveModal] = useState(false);
  const [templateName, setTemplateName] = useState('');
  const [templateType, setTemplateType] = useState('po'); // 'po', 'details', 'mixed'
  const [templateSaveChecked, setTemplateSaveChecked] = useState(false);
  const [saveMode, setSaveMode] = useState('new'); // 'new', 'update', 'merge'
  const [selectedTargetTemplate, setSelectedTargetTemplate] = useState(null); // celÃ½ template objekt
  const [selectedTargetTemplateTs, setSelectedTargetTemplateTs] = useState(null);
  const [showDeleteTemplateConfirm, setShowDeleteTemplateConfirm] = useState(false);
  const [templatePendingDelete, setTemplatePendingDelete] = useState(null);

  // ðŸ”“ Unlock Confirm Dialogs
  const [showUnlockPhase1Confirm, setShowUnlockPhase1Confirm] = useState(false);
  const [showUnlockPhase2Confirm, setShowUnlockPhase2Confirm] = useState(false);
  const [showUnlockPhase3Confirm, setShowUnlockPhase3Confirm] = useState(false);
  const [showUnlockRegistrConfirm, setShowUnlockRegistrConfirm] = useState(false);
  const [showUnlockPotvrzeniConfirm, setShowUnlockPotvrzeniConfirm] = useState(false);
  const [showCancelPublishConfirm, setShowCancelPublishConfirm] = useState(false); // Confirm pro zruÅ¡enÃ­ zveÅ™ejnÄ›nÃ­
  const [showUnlockFakturaceConfirm, setShowUnlockFakturaceConfirm] = useState(false);
  // const [showUnlockVecnaSpravnostConfirm, setShowUnlockVecnaSpravnostConfirm] = useState(false); // âŒ ODSTRANÄšNO
  const [showUnlockDokonceniConfirm, setShowUnlockDokonceniConfirm] = useState(false);
  const [showUnlockStornoConfirm, setShowUnlockStornoConfirm] = useState(false);

  // ðŸ’° FAKTURY - NynÃ­ jsou souÄÃ¡stÃ­ formData.faktury (jako polozky_objednavky)
  const [fakturyLoading, setFakturyLoading] = useState(false);
  const [showAddFakturaForm, setShowAddFakturaForm] = useState(false);
  const [editingFaktura, setEditingFaktura] = useState(null); // Faktura being edited
  const [fakturaFormData, setFakturaFormData] = useState({
    fa_datum_doruceni: formatDateForPicker(new Date()), // âœ… SprÃ¡vnÃ© pole pro datum
    fa_dorucena: 1, // âœ… Boolean flag (0/1)
    fa_castka: '',
    fa_cislo_vema: '',
    fa_strediska_kod: [], // âœ… SprÃ¡vnÃ½ nÃ¡zev pole pro stÅ™ediska
    fa_poznamka: '',
    fa_splatnost: ''
  });

  // ðŸ“Ž PÅ˜ÃLOHY FAKTUR - uÅ¾ Å™eÅ¡eno samostatnou komponentou InvoiceAttachmentsCompact
  // (starÃ© state promÄ›nnÃ© fakturaAttachments, uploadingFakturaFiles, draggingFakturaId, fakturaFileInputRefs odstranÄ›ny)
  // âœ… REMOVED: fakturaTypyPrilohOptions a loadingFakturaTypyPriloh budou definovÃ¡ny aÅ¾ po dictionaries

  // ðŸ—‘ï¸ Confirm dialog pro mazÃ¡nÃ­ faktury
  const [deleteFacturaDialog, setDeleteFacturaDialog] = useState({
    isOpen: false,
    fakturaId: null,
    fakturaNazev: '',
    pocetPriloh: 0
  });

  // ðŸ”“ Confirm dialog pro odemykÃ¡nÃ­ sekcÃ­ (univerzÃ¡lnÃ­)
  const [confirmDialog, setConfirmDialog] = useState({
    isOpen: false,
    title: '',
    message: '',
    onConfirm: null
  });

  // ðŸŽ¯ AUTOSAVE HOOK - faktury jsou teÄ souÄÃ¡stÃ­ formData
  const { triggerAutosave, cancelAutosave } = useAutosave(performSaveDraft, {
    delay: 3000, // 3 sekundy neaktivity
    enabled: !disableAutosave && isDraftLoaded,
    dependencies: [disableAutosave, isDraftLoaded, formData.faktury]
  });

  const [templateActionsLog, setTemplateActionsLog] = useState([]);
  const [hoveredPreviewKey, setHoveredPreviewKey] = useState(null);
  const [previewModalData, setPreviewModalData] = useState(null); // {template, data}

  // States pro editaci nÃ¡zvÅ¯ Å¡ablon
  const [editingTemplateId, setEditingTemplateId] = useState(null);
  const [editingTemplateName, setEditingTemplateName] = useState('');
  const [showSearchPredefs, setShowSearchPredefs] = useState(false);
  const [searchPredefs, setSearchPredefs] = useState('');
  const searchInputRef = useRef(null);

  // ValidaÄnÃ­ chyby - state pro oznaÄenÃ­ ÄervenÃ½ch polÃ­
  const [validationErrors, setValidationErrors] = useState({});
  const [hasTriedToSubmit, setHasTriedToSubmit] = useState(false);
  


  // State pro rozklÃ¡dacÃ­ lokalizaÄnÃ­ panely u poloÅ¾ek
  const [lokalizacePanelStates, setLokalizacePanelStates] = useState({});

  // ðŸŽ¯ LP options pro dropdown v poloÅ¾kÃ¡ch objednÃ¡vky
  const [lpOptionsForItems, setLpOptionsForItems] = useState([]);
  const [lpOptionsLoading, setLpOptionsLoading] = useState(false);
  
  // ðŸ’° LP stavy z API (limit, ÄerpÃ¡no, zbÃ½vÃ¡) - pro pÅ™esnÃ© zobrazenÃ­ ÄerpÃ¡nÃ­
  const [lpStavy, setLpStavy] = useState({});

  // ðŸŽ¯ LP options se naÄÃ­tajÃ­ automaticky v enriched objednÃ¡vce z backendu
  // Viz handleDataLoaded() kde se extrahujÃ­ z response.lp_options
  
  // ðŸ’° NaÄÃ­st aktuÃ¡lnÃ­ stavy LP z API kdyÅ¾ se zmÄ›nÃ­ lpOptionsForItems
  useEffect(() => {
    if (!lpOptionsForItems || lpOptionsForItems.length === 0 || !token || !username) return;
    
    const loadLPStavy = async () => {
      const stavy = {};
      for (const lp of lpOptionsForItems) {
        try {
          const stav = await fetchLPDetail({ token, username, cislo_lp: lp.kod });
          if (stav) {
            stavy[lp.id] = {
              limit: parseFloat(stav.celkovy_limit) || 0,
              cerpano: parseFloat(stav.skutecne_cerpano) || 0,
              zbyva: parseFloat(stav.zbyva_skutecne) || 0
            };
          }
        } catch (error) {
          console.warn(`Nelze naÄÃ­st stav LP ${lp.kod}:`, error.message);
        }
      }
      setLpStavy(stavy);
    };
    
    loadLPStavy();
  }, [lpOptionsForItems, token, username]);

  // ðŸ”‡ WORKFLOW TRACKING - VYPNUTO (zpÅ¯sobovalo hluk v konzoli)
  // useEffect(() => {
  //   if (!formData.stav_workflow_kod) return;
  //
  //   const workflowStates = parseWorkflowStates(formData.stav_workflow_kod);
  //   const phaseInfo = getPhaseProgressInternal(formData.stav_workflow_kod, false, !!formData.id);
  //
  //   addDebugLog('info', 'WORKFLOW', 'state-changed', {
  //     phase: phaseInfo.currentPhase,
  //     states: workflowStates,
  //     orderId: formData.id || 'NEW',
  //     orderNumber: formData.ev_cislo || formData.cislo_objednavky || 'N/A'
  //   });
  // }, [formData.stav_workflow_kod, formData.id]);

  // ï¿½ï¸ REMOVED: useEffect pro naÄÃ­tÃ¡nÃ­ typÅ¯ faktur - nynÃ­ se naÄÃ­tÃ¡ pÅ™es useDictionaries.loadAll()
  // Typy faktur jsou nynÃ­ dostupnÃ© v dictionaries.data.typyFakturOptions (alias: fakturaTypyPrilohOptions)
  // Loading stav je v dictionaries.loading.typyFaktur (alias: loadingFakturaTypyPriloh)
  // Fallback pÅ™i chybÄ› je Å™eÅ¡en pÅ™Ã­mo v useDictionaries reducer

  /**
   * ðŸ”„ AutomatickÃ© doplnÄ›nÃ­ dodavatele ze smlouvy
   * PouÅ¾itÃ­: PÅ™i naÄtenÃ­ objednÃ¡vky ve fÃ¡zi 3+ s financovÃ¡nÃ­m "Smlouva"
   * Priorita: 1) LokÃ¡lnÃ­ adresÃ¡Å™, 2) ARES, 3) Data ze smlouvy
   * @param {Object} orderData - Data objednÃ¡vky s cislo_smlouvy a zpusob_financovani
   * @param {number} currentPhase - AktuÃ¡lnÃ­ fÃ¡ze objednÃ¡vky
   * @returns {Object|null} - DodavatelskÃ¡ data nebo null
   */
  const autoFillSupplierFromContract = useCallback(async (orderData, currentPhase) => {
    try {
      // 1ï¸âƒ£ KONTROLA PODMÃNEK
      // Spustit POUZE kdyÅ¾:
      // - ObjednÃ¡vka je SCHVÃLENÃ (ale jeÅ¡tÄ› nenÃ­ ODESLANÃ) - stav po schvÃ¡lenÃ­
      // - NEBO je rozpracovanÃ¡ s financovÃ¡nÃ­m Smlouva
      const workflowStates = orderData.stav_workflow_kod ? 
        (typeof orderData.stav_workflow_kod === 'string' ? JSON.parse(orderData.stav_workflow_kod) : orderData.stav_workflow_kod) : [];
      
      const hasSchvalena = Array.isArray(workflowStates) && workflowStates.includes('SCHVALENA');
      const hasOdeslana = Array.isArray(workflowStates) && workflowStates.includes('ODESLANA');
      
      // NEPOUÅ½ÃVAT pro objednÃ¡vky co jsou uÅ¾ ODESLANÃ‰ (tam musÃ­ bÃ½t dodavatel vyplnÄ›nÃ½)
      if (hasOdeslana) {
        return null;
      }
      
      // MusÃ­ bÃ½t buÄ SCHVÃLENÃ nebo rozpracovanÃ¡ s financovÃ¡nÃ­m Smlouva
      const isSmlouvaFinancing = orderData.zpusob_financovani?.toLowerCase().includes('smlouva');
      if (!hasSchvalena && !isSmlouvaFinancing) {
        return null;
      }
      
      if (!isSmlouvaFinancing) {
        return null;
      }

      const hasSupplier = orderData.dodavatel_nazev?.trim() || orderData.dodavatel_ico?.trim();
      if (hasSupplier) {
        return null; // UÅ¾ je vyplnÄ›nÃ½ - buÄ z DB nebo z draftu
      }

      const cisloSmlouvy = orderData.cislo_smlouvy?.trim();
      if (!cisloSmlouvy) {
        return null;
      }
      
      // 2ï¸âƒ£ NAÄŒÃST SEZNAM SMLUV PÅ˜ÃMO (eliminace zÃ¡vislosti na state)
      let currentSmlouvyList = [];
      try {
        const response = await getSmlouvyList({
          token,
          username,
          show_inactive: false,
          limit: 500
        });
        
        if (response?.data && Array.isArray(response.data)) {
          currentSmlouvyList = response.data;
        }
      } catch (loadError) {
        return null;
      }

      // 3ï¸âƒ£ NAJÃT SMLOUVU V SEZNAMU
      const smlouva = currentSmlouvyList.find(s => 
        s.cislo_smlouvy === cisloSmlouvy || 
        s.evidencni_cislo === cisloSmlouvy
      );

      if (!smlouva) {
        return null;
      }

      const icoZeSmlouvy = smlouva.ico?.trim();
      if (!icoZeSmlouvy || icoZeSmlouvy.length < 8) {
        // Smlouva nemÃ¡ IÄŒO nebo je neplatnÃ© - vrÃ¡tÃ­me jen nÃ¡zev
        return {
          dodavatel_nazev: smlouva.nazev_firmy || '',
          dodavatel_ico: '',
          source: 'smlouva-fallback'
        };
      }

      // 4ï¸âƒ£ HLEDAT V LOKÃLNÃM ADRESÃÅ˜I (primÃ¡rnÃ­ zdroj)
      try {
        const localResult = await searchSupplierByIco({
          token: token,
          username: username,
          ico: icoZeSmlouvy
        });

        if (localResult?.data && Array.isArray(localResult.data) && localResult.data.length > 0) {
          const supplier = localResult.data[0];
          return {
            dodavatel_nazev: supplier.nazev || supplier.name || smlouva.nazev_firmy || '',
            dodavatel_adresa: supplier.adresa || supplier.address || '',
            dodavatel_ico: supplier.ico || icoZeSmlouvy,
            dodavatel_dic: supplier.dic || '',
            dodavatel_zastoupeny: supplier.zastoupeny || supplier.represented || '',
            dodavatel_kontakt_jmeno: supplier.kontakt_jmeno || '',
            dodavatel_kontakt_email: supplier.kontakt_email || supplier.email || '',
            dodavatel_kontakt_telefon: supplier.kontakt_telefon || supplier.telefon || '',
            source: 'local'
          };
        }
      } catch (localError) {
        // Error in local directory search
      }

      // 5ï¸âƒ£ FALLBACK NA ARES
      try {
        const aresUrl = `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${icoZeSmlouvy}`;
        const aresResponse = await fetch(aresUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (aresResponse.ok) {
          const aresData = await aresResponse.json();
          return {
            dodavatel_nazev: aresData.obchodniJmeno || smlouva.nazev_firmy || '',
            dodavatel_adresa: aresData.sidlo?.textovaAdresa || '',
            dodavatel_ico: aresData.ico || icoZeSmlouvy,
            dodavatel_dic: aresData.dic || '',
            dodavatel_zastoupeny: '',
            dodavatel_kontakt_jmeno: '',
            dodavatel_kontakt_email: '',
            dodavatel_kontakt_telefon: '',
            source: 'ares'
          };
        }
      } catch (aresError) {
        // Error in ARES query
      }

      // 6ï¸âƒ£ FALLBACK NA DATA ZE SMLOUVY (pouze nÃ¡zev a IÄŒO)
      return {
        dodavatel_nazev: smlouva.nazev_firmy || '',
        dodavatel_ico: icoZeSmlouvy,
        source: 'smlouva'
      };

    } catch (error) {
      return null;
    }
  }, [token, username]);

  // ðŸ”§ FIX: Callback funkce pro useFormController - definovanÃ© aÅ¾ po vÅ¡ech state promÄ›nnÃ½ch
  const handleDataLoaded = useCallback(async (loadedData, sourceOrderId) => {
      // Callback kdyÅ¾ jsou data naÄtena z DB
      // KRITICKÃ‰: Nastavit formData s naÄtenÃ½mi daty

      // ðŸ” DEBUG: RAW CELÃ‰ OBJEDNÃVKY z backendu
      // console.log('ðŸ” RAW CELÃ OBJEDNÃVKA z DB:', loadedData);

      // ðŸ›¡ï¸ OCHRANA: ZabrÃ¡nit opakovanÃ©mu volÃ¡nÃ­ onDataLoaded PRO STEJNOU objednÃ¡vku
      // âœ… FIX: Kontroluj souÄasnÃ½ editOrderId, ne jen flag
      const currentEditId = editOrderId || loadedData?.id || 'NEW';
      if (onDataLoadedCalledRef.current === currentEditId) {
        if (process.env.NODE_ENV === 'development') {
          console.warn('âš ï¸ handleDataLoaded uÅ¾ byl zavolÃ¡n pro:', currentEditId, '- ignoruji duplicitnÃ­ volÃ¡nÃ­');
        }
        return;
      }

      // KRITICKÃ‰: Nastavit ochranu PÅ˜ED jakÃ½mikoliv async operacemi
      onDataLoadedCalledRef.current = currentEditId;

      // ðŸ›¡ï¸ DALÅ Ã OCHRANA: Reset ochrany po 5 sekundÃ¡ch pro pÅ™Ã­pad Å¾e by doÅ¡lo k chybÄ›
      setTimeout(() => {
        if (onDataLoadedCalledRef.current === currentEditId) {
          onDataLoadedCalledRef.current = null;
        }
      }, 5000);

      // âœ… FIX: Pro NOVOU objednÃ¡vku okamÅ¾itÄ› povolit autosave
      // NenÃ­ potÅ™eba Äekat na draft loading - form je ready hned
      const isNewOrder = !editOrderId;
      if (isNewOrder) {
        setIsDraftLoaded(true); // âœ… Povolit autosave OKAMÅ½ITÄš pro novÃ© objednÃ¡vky
        setIsInitialized(true); // âœ… OznaÄit jako inicializovanÃ½ aby se nespustil duplicitnÃ­ effect
      }

      // Nastavit ID zdroje pro copy mode
      if (sourceOrderId) {
        setSourceOrderIdForUnlock(sourceOrderId);
      }

      // Nastavit savedOrderId pro edit mode
      if (loadedData?.id) {
        setSavedOrderId(loadedData.id);
        setIsEditMode(true);
        // ðŸŽ¯ PERSISTENCE: UloÅ¾ editOrderId do localStorage pro refresh
        localStorage.setItem('activeOrderEditId', String(loadedData.id));
      }

      // ðŸŽ¯ NEBO pokud je editOrderId v URL - OKAMÅ½ITÄš nastavit editMode
      if (editOrderId) {
        setIsEditMode(true);
        // ðŸŽ¯ PERSISTENCE: UloÅ¾ editOrderId do localStorage pro refresh
        localStorage.setItem('activeOrderEditId', String(editOrderId));
      }

      // ðŸ”¥ NOVÃ‰: NaÄti draft PÅ˜ÃMO TADY bÄ›hem inicializace!
      let finalData = loadedData || {};
      const hasDbData = loadedData && Object.keys(loadedData).length > 0;

      if (user_id) {
        try {
          draftManager.setCurrentUser(user_id);
          const hasDraft = await draftManager.hasDraft();

          if (hasDraft) {
            const draftData = await draftManager.loadDraft();

            if (draftData?.formData) {
              // ðŸŽ¯ KONTROLA: PatÅ™Ã­ draft k tÃ©to objednÃ¡vce?
              const draftOrderId = draftData.savedOrderId || draftData.formData?.id;
              const currentOrderId = editOrderId || loadedData?.id;

              // ðŸŽ¯ Pokud draft mÃ¡ savedOrderId, JE TO EDITACE - nastav HNED!
              if (draftOrderId) {
                setIsEditMode(true);
                setSavedOrderId(draftOrderId);
                // ðŸŽ¯ PERSISTENCE: UloÅ¾ do localStorage pro refresh
                localStorage.setItem('activeOrderEditId', String(draftOrderId));
              }

              // âŒ Pokud je draft od JINÃ‰ objednÃ¡vky, IGNORUJ ho!
              if (currentOrderId && draftOrderId && String(draftOrderId) !== String(currentOrderId)) {
                // NEPOUÅ½ÃVAT tento draft - patÅ™Ã­ k jinÃ© objednÃ¡vce
                console.warn('âš ï¸ Draft patÅ™Ã­ k jinÃ© objednÃ¡vce, ignoruji:', { draftOrderId, currentOrderId });
              } else if (hasDbData) {
                // âœ… Draft patÅ™Ã­ k TÃ‰TO objednÃ¡vce - pouÅ¾ij ho!
                // ðŸŽ¯ NOVÃ LOGIKA: LocalStorage VÅ½DY mÃ¡ prioritu (obsahuje aktuÃ¡lnÃ­ zmÄ›ny uÅ¾ivatele)
                // DB slouÅ¾Ã­ jen jako zÃ¡klad pro systÃ©movÃ¡/immutable pole

                finalData = {
                  ...loadedData, // NejdÅ™Ã­v DB (zÃ¡kladnÃ­ systÃ©movÃ¡ data)
                  ...draftData.formData, // Pak LS draft PÅ˜EPÃÅ E vÅ¡echny user-editable fieldy
                  
                  // âš ï¸ IMMUTABLE systÃ©movÃ¡ pole - VÅ½DY Z DB (nelze mÄ›nit)
                  id: loadedData.id,
                  ev_cislo: loadedData.ev_cislo || loadedData.cislo_objednavky,
                  cislo_objednavky: loadedData.cislo_objednavky,
                  datum_vytvoreni: loadedData.datum_vytvoreni,
                  datum_posledni_zmeny: loadedData.datum_posledni_zmeny,
                  
                  // âœ… FAKTURY: Preferovat draft faktury (obsahujÃ­ lokÃ¡lnÃ­ zmÄ›ny), fallback na DB
                  faktury: (draftData.formData.faktury && draftData.formData.faktury.length > 0) 
                    ? draftData.formData.faktury 
                    : (loadedData.faktury || [])
                };
              } else {
                // NEW: PouÅ¾ij draft
                finalData = draftData.formData;
              }
            }
          }
        } catch (error) {
          console.error('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ draftu:', error);
        }
      }

      // ðŸ”„ AUTOMATICKÃ‰ DOPLNÄšNÃ DODAVATELE ZE SMLOUVY
      // Pokud je fÃ¡ze 3+, financovÃ¡nÃ­ = Smlouva a dodavatel prÃ¡zdnÃ½, zkusit doplnit
      let wasAutoFilled = false;
      if (Object.keys(finalData).length > 0) {
        const currentPhase = getWorkflowPhase(finalData.stav_workflow_kod);
        
        try {
          const supplierFromContract = await autoFillSupplierFromContract(finalData, currentPhase);
          
          if (supplierFromContract) {
            // SlouÄit dodavatelskÃ¡ data do finalData
            finalData = {
              ...finalData,
              ...supplierFromContract
            };
            
            // Nastavit zdroj pro zobrazenÃ­ v labelu
            setSupplierAutoFillSource(supplierFromContract.source);
            
            wasAutoFilled = true;
          }
        } catch (error) {
        }
      }

      // Nastavit finÃ¡lnÃ­ data (pokud nenÃ­ prÃ¡zdnÃ©)
      if (Object.keys(finalData).length > 0) {
        setFormData(finalData);

        // ðŸŽ¯ EXTRAHOVAT LP OPTIONS z enriched order response
        // LP options jsou v loadedData.financovani.lp_nazvy (ne v lp_options!)
        
        // Extrahuj LP z financovani.lp_nazvy (primÃ¡rnÃ­ zdroj pro poloÅ¾ky)
        if (loadedData?.financovani?.lp_nazvy && Array.isArray(loadedData.financovani.lp_nazvy)) {
          const lpOptions = loadedData.financovani.lp_nazvy
            .map(lp => ({
              id: lp.id,
              kod: lp.cislo_lp || lp.kod || `LP${lp.id}`,
              nazev: lp.nazev || 'Bez nÃ¡zvu',
              kategorie: lp.kategorie,
              limit: lp.limit || lp.celkovy_limit,
              cerpano: lp.cerpano || lp.skutecne_cerpano,
              zbyva: lp.zbyva || lp.zbyva_skutecne,
              rok: lp.rok,
              label: `${lp.cislo_lp || lp.kod || `LP${lp.id}`} - ${lp.nazev || 'Bez nÃ¡zvu'}`
            }))
            .sort((a, b) => a.nazev.localeCompare(b.nazev, 'cs'));
          
          setLpOptionsForItems(lpOptions);
        } else if (finalData.lp_kod && Array.isArray(finalData.lp_kod) && finalData.lp_kod.length > 0) {
          // âœ… FALLBACK: ObjednÃ¡vka mÃ¡ LP financovÃ¡nÃ­, ale chybÃ­ lp_nazvy data - naÄti z API
          console.log('âš ï¸ LP financovÃ¡nÃ­ detekovÃ¡no, ale chybÃ­ lp_nazvy - naÄÃ­tÃ¡m z API...');
          try {
            const lpDetails = await Promise.all(
              finalData.lp_kod.map(async (lpId) => {
                try {
                  const lpDetail = await fetchLPDetail({ token, username, cislo_lp: lpId });
                  return {
                    id: lpDetail.id,
                    kod: lpDetail.cislo_lp || lpDetail.kod || `LP${lpDetail.id}`,
                    nazev: lpDetail.nazev || 'Bez nÃ¡zvu',
                    kategorie: lpDetail.kategorie,
                    limit: lpDetail.celkovy_limit || 0,
                    cerpano: lpDetail.skutecne_cerpano || 0,
                    zbyva: lpDetail.zbyva_skutecne || 0,
                    rok: lpDetail.rok,
                    label: `${lpDetail.cislo_lp || lpDetail.kod || `LP${lpDetail.id}`} - ${lpDetail.nazev || 'Bez nÃ¡zvu'}`
                  };
                } catch (err) {
                  console.error(`âŒ Chyba naÄÃ­tÃ¡nÃ­ LP ${lpId}:`, err);
                  return null;
                }
              })
            );
            const validLpOptions = lpDetails.filter(lp => lp !== null).sort((a, b) => a.nazev.localeCompare(b.nazev, 'cs'));
            setLpOptionsForItems(validLpOptions);
            console.log('âœ… LP naÄteny z API:', validLpOptions);
          } catch (err) {
            console.error('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ LP z API:', err);
            setLpOptionsForItems([]);
          }
        } else {
          // NenÃ­ LP financovÃ¡nÃ­
          setLpOptionsForItems([]);
        }

        // ðŸ“¸ ULOÅ½IT SNAPSHOT pÅ¯vodnÃ­ho stavu pro detekci zmÄ›n
        if (finalData.id) {
          originalFormDataRef.current = JSON.parse(JSON.stringify(finalData));
        }

        // ðŸ’¾ ULOÅ½IT DRAFT po autoFill (aby se zmÄ›ny zachovaly pÅ™i F5)
        if (wasAutoFilled && editOrderId && draftManager) {
          try {
            draftManager.setCurrentUser(user_id);
            await draftManager.saveDraft(finalData, {
              orderId: parseInt(editOrderId)
            });
          } catch (draftError) {
            // NepodaÅ™ilo se uloÅ¾it draft
          }
        }

        // âœ… KRITICKÃ‰: Pokud mÃ¡ ev_cislo, nastavit ref aby se uÅ¾ neptalo na next-number!
        if (finalData.ev_cislo && finalData.ev_cislo !== 'NaÄÃ­tÃ¡m...') {
          if (window.__orderForm_hasLoadedNextNumberRef) {
            window.__orderForm_hasLoadedNextNumberRef.current = true;
          }
        }

        // âœ… Nastavit isInitialized flag aby se zabrÃ¡nilo duplicitnÃ­mu naÄÃ­tÃ¡nÃ­
        setIsInitialized(true);
      }

      // âœ… Pro EDIT mode: OznaÄit Å¾e inicializace je hotovÃ¡ aÅ¾ tady (po naÄtenÃ­ draftu)
      // Pro NEW order uÅ¾ je isDraftLoaded=true nastaveno vÃ½Å¡e
      if (!isNewOrder) {
        if (process.env.NODE_ENV === 'development') {
        }
        setIsDraftLoaded(true);
        
        // âœ… KRITICKÃ‰: Povolit autosave i pro EDIT mode!
        draftManager.setAutosaveEnabled(true, 'EDIT order initialization');
      }
  }, [editOrderId, user_id, draftManager, setFormData, setSourceOrderIdForUnlock, setSavedOrderId, setIsEditMode, setIsDraftLoaded, setIsInitialized, autoFillSupplierFromContract, setSupplierAutoFillSource]);

  // OstatnÃ­ callback funkce pro formController
  const handleError = useCallback((error) => {
    // Callback pÅ™i chybÄ› inicializace
    showToast?.(`Chyba pÅ™i naÄÃ­tÃ¡nÃ­ formulÃ¡Å™e: ${error.message}`, 'error');
  }, []); // ðŸ”§ FIX: Remove showToast dependency to prevent infinite loop

  const handleReady = useCallback(() => {
    // FormulÃ¡Å™ ready - mÅ¯Å¾eme dodateÄnÄ› inicializovat UI

    // ðŸš« ZRUÅ ENO: Auto-scroll po naÄtenÃ­ formulÃ¡Å™e (na Å¾Ã¡dost uÅ¾ivatele)
  }, []);

  // Tento hook Å™Ã­dÃ­ celou inicializaci formulÃ¡Å™e a eliminuje race conditions
  const formController = useFormController({
    token,
    username,
    userId: user_id,
    editOrderId,
    archivovanoParam,
    onDataLoaded: handleDataLoaded,
    onError: handleError,
    onReady: handleReady
  });

  // RozbalenÃ­ formController pro snadnÄ›jÅ¡Ã­ pÅ™Ã­stup
  const { lifecycle, dictionaries, orderDataLoader, ui } = formController;

  // âœ… REFACTORED: ÄŒÃ­selnÃ­ky a jejich loading states nynÃ­ z formController
  // Aliasy pro zachovÃ¡nÃ­ zpÄ›tnÃ© kompatibility se stÃ¡vajÃ­cÃ­m kÃ³dem
  const allUsers = dictionaries.data?.allUsers || [];
  const approversBase = dictionaries.data?.approvers || [];
  const strediskaOptions = dictionaries.data?.strediskaOptions || [];
  const financovaniOptions = dictionaries.data?.financovaniOptions || [];
  const druhyObjednavkyOptions = dictionaries.data?.druhyObjednavkyOptions || [];
  const druhyObjednavkyRawData = dictionaries.data?.druhyObjednavkyRawData || null;
  const lpKodyOptions = dictionaries.data?.lpKodyOptions || [];
  const prilohyTypyOptions = dictionaries.data?.prilohyTypyOptions || [];
  const typyFakturOptions = dictionaries.data?.typyFakturOptions || []; // Typy faktur z reduceru
  const stavyWorkflowMap = dictionaries.data?.stavyWorkflowMap || {}; // ðŸ†• Mapa workflow stavÅ¯ z DB ÄÃ­selnÃ­ku

  // ðŸ†• KombinovanÃ© options pro dodateÄnÃ© dokumenty (PRILOHA_TYP + FAKTURA_TYP)
  // âœ… OPRAVA: Deduplikace podle value, aby nedoÅ¡lo k duplicitnÃ­m klÃ­ÄÅ¯m v React
  const dodatecneDokladyOptions = React.useMemo(() => {
    const combined = [...prilohyTypyOptions, ...typyFakturOptions];
    const uniqueMap = new Map();

    // Deduplikace - pokud je duplicitnÃ­ value, ponechÃ¡me prvnÃ­ vÃ½skyt
    combined.forEach(opt => {
      if (!uniqueMap.has(opt.value)) {
        uniqueMap.set(opt.value, opt);
      }
    });

    return Array.from(uniqueMap.values());
  }, [prilohyTypyOptions, typyFakturOptions]);

  // âœ… REFACTORED: areDictionariesReady nynÃ­ z formController.dictionaries.isReady
  const areDictionariesReady = dictionaries.isReady;

  // ðŸ†• State pro garant dropdown options (active users + inactive garant if editing)
  // Inicializuj HNED s aktivnÃ­mi uÅ¾ivateli pokud jsou k dispozici
  const [garantOptions, setGarantOptions] = useState(() => {
    const activeUsers = allUsers.filter(u => u.aktivni === 1 || u.aktivni === '1' || u.active === 1 || u.active === '1');
    return activeUsers;
  });

  // ðŸ›ï¸ SYSTEM uÅ¾ivatel - pÅ™idÃ¡ se JEN kdyÅ¾ mÃ¡ objednÃ¡vka prikazce_id nebo schvalovatel_id = '0'
  // PouÅ¾Ã­vÃ¡ se POUZE u archivovanÃ½ch objednÃ¡vek
  const approvers = useMemo(() => {
    const needsSystemUser = formData.prikazce_id === '0' || formData.schvalovatel_id === '0';

    if (!needsSystemUser) {
      return approversBase; // BÄ›Å¾nÃ© objednÃ¡vky - bez SYSTEM
    }

    // ArchivovanÃ¡ objednÃ¡vka s SYSTEM uÅ¾ivatelem
    return [
      {
        id: '0',
        jmeno: 'SYSTEM',
        prijmeni: '',
        displayName: 'SYSTEM',
        aktivni: 1,
        deaktivovan: 0
      },
      ...approversBase
    ];
  }, [approversBase, formData.prikazce_id, formData.schvalovatel_id]);

  // PÅ™ejmenovÃ¡nÃ­ pro zpÄ›tnou kompatibilitu (rÅ¯znÃ© ÄÃ¡sti kÃ³du pouÅ¾Ã­vajÃ­ rÅ¯znÃ© nÃ¡zvy)
  const fakturaTypyPrilohOptions = typyFakturOptions; // Alias
  // âŒ DEPRECATED: loadingFakturaTypyPriloh - ÄÃ­selnÃ­ky se naÄÃ­tajÃ­ v lifecycle, takÅ¾e vÅ¾dy false zde
  const loadingFakturaTypyPriloh = false; // ÄŒÃ­selnÃ­ky uÅ¾ jsou naÄtenÃ© kdyÅ¾ se formulÃ¡Å™ zobrazuje

  // ðŸš€ CRITICAL FIX: Reset a povolit autosave pÅ™i zmÄ›nÄ› editOrderId
  useEffect(() => {
    const isNewOrder = !editOrderId;
    
    // âœ… FIX: RESET isDraftLoaded pÅ™i zmÄ›nÄ› editOrderId (pÅ™epnutÃ­ mezi objednÃ¡vkami)
    setIsDraftLoaded(false);
    
    if (isNewOrder && user_id) {
      setIsDraftLoaded(true);

      // âœ… KRITICKÃ‰: Povolit autosave v DraftManageru!
      draftManager.setAutosaveEnabled(true, 'NEW order initialization');
    } else {
    }
  }, [editOrderId, user_id]); // SpustÃ­ se pÅ™i zmÄ›nÄ› editOrderId

  // AutomatickÃ© rozbalenÃ­ lokalizaÄnÃ­ch panelÅ¯ s vyplnÄ›nÃ½mi hodnotami
  useEffect(() => {
    if (formData.polozky_objednavky && Array.isArray(formData.polozky_objednavky)) {
      const newPanelStates = {};
      
      // Zkontroluj, jestli KÃ“D druhu objednÃ¡vky obsahuje MAJETEK
      const isMaterialOrder = formData.druh_objednavky_kod && 
        formData.druh_objednavky_kod.toUpperCase().includes('MAJETEK');
      
      formData.polozky_objednavky.forEach(polozka => {
        // Zkontroluj, zda mÃ¡ poloÅ¾ka vyplnÄ›nÃ¡ lokalizaÄnÃ­ data
        const hasLocationData =
          (polozka.usek_kod && polozka.usek_kod.trim() !== '') ||
          (polozka.budova_kod && polozka.budova_kod.trim() !== '') ||
          (polozka.mistnost_kod && polozka.mistnost_kod.trim() !== '') ||
          (polozka.poznamka && polozka.poznamka.trim() !== '');

        // Pokud mÃ¡ data NEBO je materiÃ¡lovÃ¡ objednÃ¡vka, rozbal panel
        if (hasLocationData || isMaterialOrder) {
          newPanelStates[polozka.id] = true;
        } else {
          // Pokud NENÃ materiÃ¡lovÃ¡ objednÃ¡vka a NEMÃ data, zavÅ™i panel
          newPanelStates[polozka.id] = false;
        }
      });

      // Nastav VÅ½DY (ne jen kdyÅ¾ jsou panely k rozbalenÃ­) - aby se mohly i zavÅ™Ã­t
      setLokalizacePanelStates(newPanelStates);
    }
  }, [formData.polozky_objednavky?.length, formData.druh_objednavky_kod]); // PÅ™idÃ¡n druh_objednavky_kod

  // Synchronizace smlouvaSearchTerm s formData.cislo_smlouvy pÅ™i naÄtenÃ­ dat
  useEffect(() => {
    if (formData.cislo_smlouvy && formData.cislo_smlouvy !== smlouvaSearchTerm) {
      setSmlouvaSearchTerm(formData.cislo_smlouvy);
    }
  }, [formData.cislo_smlouvy, smlouvaSearchTerm]);

  // JEDNODUCHÃ‰ WORKFLOW - pÅ™Ã­mo z DB stavu bez mapovÃ¡nÃ­
  const [isConceptSaved, setIsConceptSaved] = useState(false); // Pouze localStorage koncept
  // âŒ REMOVED: savedOrderId - pÅ™esunut vÃ½Å¡ (pÅ™ed isNewOrder)
  const [isPhase1Unlocked, setIsPhase1Unlocked] = useState(false); // Stav pro odemknutÃ­ FÃZE 1
  // âŒ REMOVED: isPhase3Unlocked - pouÅ¾Ã­vÃ¡me unlockStates z WorkflowManager

  // ðŸ§¹ Cleanup pÅ™i unmount - uloÅ¾it draft pÅ™ed unmount
  useEffect(() => {
    // Å½Ã¡dnÃ¡ logika tady - jen cleanup funkce
    return () => {
      // Cleanup POUZE pÅ™i unmount komponenty
      // âš ï¸ POZOR: PouÅ¾ij REF pro pÅ™Ã­stup k aktuÃ¡lnÃ­m hodnotÃ¡m - dependencies musÃ­ bÃ½t prÃ¡zdnÃ©!

      // ðŸ’¾ KRITICKÃ‰: UloÅ¾it draft pÅ™ed unmount (i kdyÅ¾ autosave jeÅ¡tÄ› neprobÄ›hlo)
      // ScÃ©nÃ¡Å™: User zmÄ›nÃ­ pole â†’ navigace pryÄ bÄ›hem 3s delay â†’ bez tohoto by se draft neuklÃ¡dal
      if (isDraftLoaded && user_id && formData) {
        // âš ï¸ OCHRANA: UklÃ¡dat POUZE pokud mÃ¡ formData smysluplnÃ½ obsah
        // MinimÃ¡lnÄ› 40 klÃ­ÄÅ¯ (prÃ¡zdnÃ½ formData mÃ¡ ~78 klÃ­ÄÅ¯)
        const formDataKeys = Object.keys(formData);
        const hasSignificantData = formDataKeys.length >= 40;

        if (!hasSignificantData) {
          return;
        }

        try {
          // ðŸš« ZRUÅ ENO: UklÃ¡dÃ¡nÃ­ scroll pozice pÅ™ed unmount (na Å¾Ã¡dost uÅ¾ivatele)
          // const scrollContainer = scrollableContentRef.current;
          // const scrollPosition = scrollContainer ? scrollContainer.scrollTop : (window.pageYOffset || document.documentElement.scrollTop);

          // âœ… Nastavit current user pÅ™ed uklÃ¡dÃ¡nÃ­m
          draftManager.setCurrentUser(user_id);

          // âœ… SprÃ¡vnÃ© API: saveDraft(formData, options)
          draftManager.saveDraft(formData, {
            orderId: savedOrderId || null
          });

          // ðŸš« ZRUÅ ENO: UklÃ¡dÃ¡nÃ­ scroll pozice
          // draftManager.saveMetadata({ scrollPosition });
        } catch (error) {
        }
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // ðŸŽ¯ PRÃZDNÃ‰ dependencies - spustÃ­ se JEN pÅ™i mount/unmount!
  // âŒ REMOVED: VÅ¡echny unlock states pÅ™esunuty do useWorkflowManager
  // const [isFakturaceUnlocked, setIsFakturaceUnlocked] = useState(false);
  // const [isVecnaSpravnostUnlocked, setIsVecnaSpravnostUnlocked] = useState(false);
  // const [isDokonceniUnlocked, setIsDokonceniUnlocked] = useState(false);
  // const [isRegistrUnlocked, setIsRegistrUnlocked] = useState(false);
  // const [isPotvrzeniUnlocked, setIsPotvrzeniUnlocked] = useState(false);

  const [isChanged, setIsChanged] = useState(false); // Flag pro zmÄ›ny proti DB - Å™Ã­dÃ­ prioritu koncept vs DB
  // âŒ REMOVED: workflowRefreshKey - pÅ™esunut vÃ½Å¡ (pÅ™ed useWorkflowManager)

  // ðŸŽ¯ CENTRÃLNÃ NAÄŒÃTÃNÃ DRAFTU pÅ™i obnovenÃ­ strÃ¡nky (F5)
  // Tento useEffect se spustÃ­ kdyÅ¾ isDraftLoaded=true a nenÃ­ editOrderId v URL
  useEffect(() => {
    // Ochrana: NaÄÃ­st draft pouze pokud:
    // 1. user_id existuje
    // 2. isDraftLoaded=true (inicializace dokonÄena)
    // 3. NENÃ editOrderId (editace se Å™eÅ¡Ã­ v handleDataLoaded)
    if (!user_id || !isDraftLoaded || editOrderId) {
      return;
    }

    if (process.env.NODE_ENV === 'development') {
      console.log('ðŸ”„ Loading draft for NEW order...');
    }

    let isActive = true;

    const loadDraftData = async () => {
      try {
        draftManager.setCurrentUser(user_id);

        // Kontrola existence draftu
        const hasDraft = await draftManager.hasDraft();

        if (!hasDraft) {
          return;
        }

        // NaÄti draft
        const draftData = await draftManager.loadDraft();

        if (!draftData?.formData || !isActive) {
          return;
        }

        // ðŸ”„ DB SYNC CHECK - pouze pro EDIT mode
        if (draftData.savedOrderId) {

          const syncCheck = await draftManager.checkDBSync(
            async (orderId) => {
              try {
                return await getOrderTimestampV2(orderId, token, username);
              } catch (error) {
                return null;
              }
            },
            async (orderId) => {
              try {
                const response = await getOrderV2(orderId, token, username);
                return response?.data || null;
              } catch (error) {
                return null;
              }
            }
          );

          if (!isActive) return;

          if (syncCheck.needsSync && syncCheck.dbData) {
            // ðŸ›¡ï¸ OCHRANA: Zachovat existujÃ­cÃ­ poloÅ¾ky pokud DB data je nemÃ¡
            const mergedData = { ...syncCheck.dbData };
            if (!mergedData.polozky_objednavky || mergedData.polozky_objednavky.length === 0) {
              if (formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
                mergedData.polozky_objednavky = formData.polozky_objednavky;
                // DEBUG: Local items protection - logging removed
              }
            }

            setFormData(mergedData);
            setIsChanged(false);
            setIsEditMode(true);
            setSavedOrderId(syncCheck.dbData.id);
            await draftManager.syncWithDatabase(syncCheck.dbData, syncCheck.dbData.id);
            return;
          }
        }

        // âœ… Aplikuj draft data

        // ðŸ§¹ VYÄŒISTIT objekty ve fa_strediska_kod (pokud tam jsou)
        const cleanedDraftData = { ...draftData.formData };

        if (cleanedDraftData.faktury && Array.isArray(cleanedDraftData.faktury)) {
          cleanedDraftData.faktury = cleanedDraftData.faktury.map(faktura => {
            if (faktura.fa_strediska_kod && Array.isArray(faktura.fa_strediska_kod)) {
              // Extrahovat jen stringy z objektÅ¯
              faktura.fa_strediska_kod = faktura.fa_strediska_kod.map(item => {
                if (typeof item === 'string') return item;
                return item.value || item.kod_stavu || item.id || item;
              });
            }
            return faktura;
          });
        }

        setFormData(prev => ({
          ...prev,  // âœ… KRITICKÃ‰: Zachovat vÅ¡echny vÃ½chozÃ­ hodnoty (78 klÃ­ÄÅ¯)
          ...cleanedDraftData,  // âœ… PÅ™epsat jen zmÄ›nÄ›nÃ© hodnoty z draftu (VYÄŒIÅ TÄšNÃ‰!)
          id: prev?.id || draftData.formData.id,
          datum_posledni_zmeny: prev?.datum_posledni_zmeny || draftData.formData.datum_posledni_zmeny,
          // ðŸ”§ FIX: Zachovat stav_schvaleni a strediska_kod z prev pokud draft neobsahuje validnÃ­ hodnoty
          // prev obsahuje uÅ¾ SPRÃVNÄš TRANSFORMOVANÃ data z useOrderDataLoader
          stav_schvaleni: cleanedDraftData.stav_schvaleni || prev?.stav_schvaleni || '',
          strediska_kod: (cleanedDraftData.strediska_kod && Array.isArray(cleanedDraftData.strediska_kod) && cleanedDraftData.strediska_kod.length > 0)
            ? cleanedDraftData.strediska_kod
            : (prev?.strediska_kod || []),
          // ðŸ”§ FIX: dodavatel_zpusob_potvrzeni - pouÅ¾Ã­t draft JEN pokud mÃ¡ NEPRÃZDNÃ‰ zpusoby
          // Pokud je pole prÃ¡zdnÃ©, zachovat hodnotu z DB (prev)
          dodavatel_zpusob_potvrzeni: (cleanedDraftData.dodavatel_zpusob_potvrzeni?.zpusoby?.length > 0)
            ? cleanedDraftData.dodavatel_zpusob_potvrzeni
            : (prev?.dodavatel_zpusob_potvrzeni || cleanedDraftData.dodavatel_zpusob_potvrzeni)
        }));

        setIsChanged(draftData.isChanged === true);

        if (draftData.savedOrderId) {
          setIsEditMode(true);
          setSavedOrderId(draftData.savedOrderId);
        }

      } catch (error) {
      }
    };

    loadDraftData();

    return () => {
      isActive = false;
    };
  }, [user_id, isDraftLoaded, editOrderId]); // âœ… SpustÃ­ se kdyÅ¾ isDraftLoaded=true a nenÃ­ editOrderId

  // Flag pro kontrolu odeslÃ¡nÃ­ uÅ¾ nenÃ­ potÅ™eba - odvozuje se pÅ™Ã­mo z DB stavu

  // VÅ¡echno odvozenÃ© pÅ™Ã­mo z formData.stav_workflow_kod (DB stav) - useMemo optimalizace
  const isOrderSavedToDB = useMemo(() => !!formData.id, [formData.id]);
  const isApprovedOrder = useMemo(() => {
    const states = Array.isArray(formData.stav_workflow_kod) ? formData.stav_workflow_kod : parseWorkflowStates(formData.stav_workflow_kod);
    return states.includes('SCHVALENA');
  }, [formData.stav_workflow_kod]);

  // âŒ DEPRECATED: getCurrentPhase - nahrazeno workflowManager.getCurrentPhase()
  // âŒ DEPRECATED: mainWorkflowState - nahrazeno workflowManager.mainWorkflowState
  // âŒ DEPRECATED: currentPhase - nahrazeno workflowManager.currentPhase
  // âŒ DEPRECATED: currentPhaseTheme - nahrazeno workflowManager.phaseTheme
  // VÅ¡echny tyto hodnoty jsou nynÃ­ dostupnÃ© pÅ™es workflowManager

  const sectionVisibility = getSectionVisibility(mainWorkflowState, currentPhase, isArchived);

  // MapovÃ¡nÃ­ sekcÃ­ na jejich pevnÃ© barvy podle typu
  const getSectionTheme = (sectionName) => {
    const sectionColorMap = {
      // Å EDÃ‰ sekce (zÃ¡kladnÃ­ info)
      'objednatel': 'section-grey',
      'schvaleni': 'section-grey',

      // ORANÅ½OVÃ‰ sekce (pÅ™Ã­prava objednÃ¡vky)
      'financovani': 'section-orange',
      'dodavatel': 'section-orange',
      'detaily': 'section-orange',
      'dodaci_podminky': 'section-orange',
      'stav_odeslani': 'section-orange',

      // ÄŒERVENÃ sekce (pÅ™Ã­lohy - mimo workflow)
      'prilohy': 'section-red',

      // MODRÃ‰ sekce (potvrzenÃ­ a realizace)
      'potvrzeni_objednavky': 'section-blue',
      'registr_smluv': 'section-blue',
      'prubeh_objednavky': 'section-blue',
      'dodaci_informace': 'section-blue',
      'fakturace': 'section-blue',
      'storno_detail': 'section-blue',

      // FIALOVÃ‰ sekce (registr - potvrzenÃ­ zveÅ™ejnÄ›nÃ­)
      'registr_smluv_vyplneni': 'section-purple'
    };

    return sectionColorMap[sectionName] || 'section-orange'; // default oranÅ¾ovÃ¡
  };

  // ðŸ”§ FIX: Define canEditPhase2 before isSectionActive uses it
  const canEditPhase2 = hasPermission && (hasPermission('ORDER_MANAGE') || hasPermission('ORDER_APPROVE') || hasPermission('ORDER_EDIT_OWN') || hasPermission('ORDER_EDIT_ALL')); // Pro odemykÃ¡nÃ­ FÃZE 2

  // UrÄenÃ­, zda je sekce aktivnÃ­ podle aktuÃ¡lnÃ­ fÃ¡ze
  const isSectionActive = useCallback((sectionName) => {
    const phase = currentPhase; // ðŸ”§ Use pre-calculated currentPhase instead of getCurrentPhase()

    // FÃZE 1: ZÃ¡kladnÃ­ info sekce jsou vÅ¾dy aktivnÃ­ + financovÃ¡nÃ­ a detaily pro uÅ¾ivatele s oprÃ¡vnÄ›nÃ­m
    if (phase === 1) {
      const basicSections = ['objednatel', 'schvaleni'];
      const phase2SectionsForAuthorizedUsers = ['financovani', 'detaily'];

      // ZÃ¡kladnÃ­ sekce jsou vÅ¾dy aktivnÃ­ ve FÃZI 1
      if (basicSections.includes(sectionName)) {
        return true;
      }

      // Pokud mÃ¡ uÅ¾ivatel oprÃ¡vnÄ›nÃ­ k editaci objednÃ¡vek, povolÃ­ takÃ© klÃ­ÄovÃ© sekce FÃZE 2
      if (canEditPhase2 && phase2SectionsForAuthorizedUsers.includes(sectionName)) {
        return true;
      }

      return false;
    }

    // FÃZE 2: PÅ™Ã­prava objednÃ¡vky - oranÅ¾ovÃ© sekce aktivnÃ­
    if (phase === 2) {
      return ['financovani', 'dodavatel', 'detaily', 'dodaci_podminky', 'prilohy', 'stav_odeslani'].includes(sectionName);
    }

    // FÃZE 3+: PotvrzenÃ­ a realizace - modrÃ© sekce aktivnÃ­
    if (phase >= 3) {
      return ['potvrzeni_objednavky', 'registr_smluv', 'prubeh_objednavky', 'dodaci_informace', 'fakturace', 'storno_detail'].includes(sectionName);
    }

    return false; // Default neaktivnÃ­
  }, [currentPhase, canEditPhase2]); // ðŸ”§ Add dependencies for useCallback

  // Kontrola oprÃ¡vnÄ›nÃ­ pro schvalovÃ¡nÃ­ objednÃ¡vek
  const canApproveOrders = hasPermission && hasPermission('ORDER_APPROVE');
  const canManageOrders = hasPermission && hasPermission('ORDER_MANAGE');
  const canManageUsers = hasPermission && hasPermission('USER_MANAGE'); // Pro prÃ¡ci s kontakty
  const canEditPhase3 = hasPermission && (hasPermission('ORDER_MANAGE') || hasPermission('ORDER_EDIT_OWN') || hasPermission('ORDER_EDIT_ALL')); // Pro odemykÃ¡nÃ­ FÃZE 3
  const canEditApprovedSections = canApproveOrders || canManageOrders;
  const canPublishRegistry = hasPermission && hasPermission('ORDER_PUBLISH_REGISTRY'); // ðŸ†• Pro editaci polÃ­ registru smluv
  const canManageInvoices = hasPermission && hasPermission('INVOICE_MANAGE'); // ðŸ†• Pro editaci faktur ve FÃ¡zi 7
  const canSaveOrder = hasPermission && (hasPermission('ORDER_MANAGE') || hasPermission('ORDER_EDIT_OWN') || hasPermission('ORDER_EDIT_ALL')); // Pro uklÃ¡dÃ¡nÃ­ objednÃ¡vek

  // Kontrola rolÃ­ pro speciÃ¡lnÃ­ oprÃ¡vnÄ›nÃ­ - MUSÃ BÃT PÅ˜ED pouÅ¾itÃ­m!
  const isSuperAdmin = userDetail?.roles?.some(role => role.kod_role === 'SUPERADMIN');
  const isAdmin = userDetail?.roles?.some(role => role.kod_role === 'ADMINISTRATOR');
  const hasOrderManagePermission = hasPermission && hasPermission('ORDER_MANAGE');
  const canUnlockAnything = isSuperAdmin || isAdmin || hasOrderManagePermission; // SUPER, ADMIN a ORDER_MANAGE mohou odemknout cokoliv

  // ðŸ”’ WORKFLOW LOCKING - isWorkflowCompleted, isWorkflowRejected, isWorkflowCancelled
  // pÅ™ichÃ¡zejÃ­ z workflowManager. WorkflowManager Å™Ã­dÃ­ zamykÃ¡nÃ­ CENTRÃLNÄš pÅ™es isWorkflowCompleted.
  // isWorkflowCompleted = TRUE pro DOKONCENA, ZAMITNUTA, ZRUSENA (vÅ¡echny koneÄnÃ© stavy workflow)
  // SUPER/ADMIN/ORDER_MANAGE mohou odemknout pÅ™es unlock dialogy.
  
  // ðŸ”’ CENTRÃLNÃ ZAMYKÃNÃ PRO PÅ˜ÃLOHY: PouÅ¾itÃ­ workflowManager.getSectionState() pro sprÃ¡vnÃ© zamykÃ¡nÃ­
  // Sekce 'prilohy' NENÃ v SECTION_DEFINITIONS, takÅ¾e pouÅ¾ijeme fallback na isWorkflowCompleted
  const isPrilohyLocked = useMemo(() => {
    // âœ… SPRÃVNÃ LOGIKA: PÅ™Ã­lohy jsou zamÄenÃ© kdyÅ¾ je workflow dokonÄeno
    // âš ï¸ DÅ®LEÅ½ITÃ‰: PÅ™Ã­lohy jsou zamÄenÃ© PRO VÅ ECHNY vÄetnÄ› adminÅ¯ (nenÃ­ moÅ¾nost odemÄenÃ­)
    // DÅ¯vod: PÅ™Ã­lohy k dokonÄenÃ©/zamÃ­tnutÃ©/stornovanÃ© objednÃ¡vce by nemÄ›ly bÃ½t mÄ›nitelnÃ©
    return isWorkflowCompleted;
  }, [isWorkflowCompleted]);

  // âŒ REMOVED: unlockStates objekt - workflowManager mÃ¡ vlastnÃ­ states
  // Unlock states jsou nynÃ­ pÅ™Ã­mo v workflowManager

  // ðŸŽ¯ NOVÃ‰: PouÅ¾Ã­t centralizovanÃ© section states z workflowManager
  // âœ… WorkflowManager vracÃ­ { visible, enabled } pro kaÅ¾dou sekci (bez unlock states parametru)
  // ï¿½ FIX: Stable section states - pouze zÃ¡vislost na klÃ­ÄovÃ½ch hodnotÃ¡ch, ne na celÃ©m workflowManager
  const allSectionStates = useMemo(() => {
    return workflowManager.getAllSectionStates();
  }, [currentPhase, formData.id, isArchived, formData.stav_workflow_kod, formData.potvrzeni_dokonceni_objednavky, workflowManager]); // âœ… KompletnÃ­ dependencies pro refresh

  // ðŸ› FIX: Memoize formData for FloatingNavigator to prevent re-renders
  // ðŸŽ¯ Include faktury for vÄ›cnÃ¡ sprÃ¡vnost validation badge
  const navigatorFormData = useMemo(() => ({ 
    id: formData.id,
    faktury: formData.faktury,
    max_cena_s_dph: formData.max_cena_s_dph
  }), [formData.id, formData.faktury, formData.max_cena_s_dph]);

  // ðŸŽ¯ RozÅ¡Ã­Å™enÃ© section states pro navigator - zahrnuje inline podmÃ­nky viditelnosti
  const extendedSectionStates = useMemo(() => {
    const states = { ...allSectionStates };
    
    // ðŸ”’ PÅ˜ÃLOHY - manuÃ¡lnÃ­ pÅ™idÃ¡nÃ­ stavu (nenÃ­ v SECTION_DEFINITIONS)
    // ViditelnÃ© pouze kdyÅ¾ mÃ¡ objednÃ¡vka ID, zamÄenÃ© kdyÅ¾ je workflow dokonÄeno
    if (formData.id) {
      states.prilohy = {
        visible: true,  // VÅ¾dy viditelnÃ© kdyÅ¾ mÃ¡ objednÃ¡vka ID
        enabled: !isPrilohyLocked  // OdemÄenÃ© pouze kdyÅ¾ nenÃ­ workflow dokonÄeno
      };
    }
    
    // Fakturace - upravit viditelnost podle prÃ¡v a vyplnÄ›nÃ½ch dat
    const isPlatbaPokladnaObj = formData.financovani?.platba === 'pokladna';
    const isPlatbaPokladnaDodavatel = formData.dodavatel_zpusob_potvrzeni?.platba === 'pokladna';
    const isPokladna = isPlatbaPokladnaObj || isPlatbaPokladnaDodavatel;
    const hasFaktury = formData.faktury && formData.faktury.length > 0;
    
    if (states.fakturace) {
      states.fakturace = {
        ...states.fakturace,
        visible: !isPokladna && (
          canManageInvoices 
            ? currentPhase >= 6 
            : (currentPhase >= 7 || hasFaktury)
        )
      };
    }
    
    // Registr smluv vyplnÄ›nÃ­ - upravit viditelnost podle prÃ¡v a vyplnÄ›nÃ½ch dat
    const isRegistrFilled = formData.dt_zverejneni && formData.registr_iddt;
    if (states.registr_smluv_vyplneni) {
      states.registr_smluv_vyplneni = {
        ...states.registr_smluv_vyplneni,
        visible: states.registr_smluv_vyplneni.visible && (
          canPublishRegistry || isRegistrFilled
        )
      };
    }
    
    // ðŸ”’ DOKONÄŒENÃ - rozÅ¡Ã­Å™it viditelnost pro ADMIN + ORDER_MANAGE
    // WorkflowManager kontroluje stav DOKONCENA, my pÅ™idÃ¡me viditelnost pro adminy ve fÃ¡zi 8+
    if (states.dokonceni && canUnlockAnything && currentPhase >= 8) {
      states.dokonceni = {
        ...states.dokonceni,
        visible: true  // Admin vidÃ­ sekci od fÃ¡ze 8 (i kdyÅ¾ nenÃ­ dokonÄenÃ¡)
      };
    }
    
    return states;
  }, [allSectionStates, currentPhase, canManageInvoices, canPublishRegistry, 
      formData.financovani?.platba, formData.dodavatel_zpusob_potvrzeni?.platba, 
      formData.faktury, formData.dt_zverejneni, formData.registr_iddt, 
      formData.id, isPrilohyLocked, canUnlockAnything]);

  // ðŸ”§ HELPER: ZjistÃ­ jestli je pole disabled (kombinace workflow lock + UI stav)
  const isFieldDisabled = useCallback((sectionState) => {
    return !sectionState.enabled || showSaveProgress || isSaving;
  }, [showSaveProgress, isSaving]);

  // âœ… NOVÃ‰: PouÅ¾Ã­t workflowManager pro section states
  const registrState = allSectionStates.registr_smluv;
  const isRegistrLocked = !registrState.enabled; // Locked = !enabled

  const registrVyplneniState = allSectionStates.registr_smluv_vyplneni;
  const isRegistrVyplneniLocked = !registrVyplneniState.enabled; // Locked = !enabled

  const potvrzeniState = allSectionStates.potvrzeni_objednavky;
  const isPotvrzeniLocked = !potvrzeniState.enabled; // Locked = !enabled

  // âœ… FIX: PouÅ¾Ã­t 'objednatel' sekci (ne 'vytvoreni' - ta neexistuje v SECTION_DEFINITIONS)
  const objednatelState = allSectionStates.objednatel;
  const shouldLockPhase1Sections = isFieldDisabled(objednatelState);

  const schvaleniState = allSectionStates.schvaleni;
  const shouldLockPhase2Sections = isFieldDisabled(schvaleniState);

  // âœ… CHECKBOXY "Stav schvÃ¡lenÃ­" - VÅ½DY odemÄenÃ© ve FÃZI 2, zamÄenÃ© aÅ¾ ve FÃZI 3+
  // ðŸ›ï¸ ARCHIVOVANÃ‰: VÅ¾dy odemÄenÃ© (isArchived = false)
  // Toto je aktivnÃ­ ÄÃ¡st workflow ve FÃZI 2 (uÅ¾ivatel musÃ­ zaÅ¡krtnout SchvÃ¡leno/NeschvÃ¡leno/ÄŒekÃ¡ se)
  const shouldLockSchvaleniCheckboxes = !isArchived && currentPhase >= 3 && !workflowManager.isSectionUnlocked('phase2');

  // âœ… FinancovÃ¡nÃ­ je FÃZE 1-2 (samostatnÃ¡ sekce)
  const financovaniState = allSectionStates.financovani;
  const shouldLockFinancovaniSection = isFieldDisabled(financovaniState);

  // âœ… FÃZE 3: Dodavatel, PoloÅ¾ky, Detaily
  const dodavatelState = allSectionStates.dodavatel;
  const shouldLockPhase3Sections = isFieldDisabled(dodavatelState);

  // âœ… potvrzeniState uÅ¾ je definovanÃ½ vÃ½Å¡e (Å™Ã¡dek 4969)
  const shouldLockPhase4to6Sections = isFieldDisabled(potvrzeniState);

  const fakturaceState = allSectionStates.fakturace;
  const isFakturaceLockedPhase7 = !fakturaceState.enabled && (currentPhase >= 8 || hasWorkflowState(formData.stav_workflow_kod, 'FAKTURACE'));
  const shouldLockFaktury = !fakturaceState.enabled;

  // âŒ ODSTRANÄšNO: vecnaSpravnostState - refaktorovÃ¡no na per-invoice
  // const vecnaSpravnostState = allSectionStates.vecna_spravnost;
  // const isVecnaSpravnostLocked = !vecnaSpravnostState.enabled;

  const dokonceniState = allSectionStates.dokonceni;
  const isDokonceniLocked = !dokonceniState.enabled;

  // ðŸ”’ GLOBÃLNÃ ZÃMEK: Po dokonÄenÃ­ objednÃ¡vky zamknout VÅ ECHNY sekce
  const isOrderCompleted = hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA');
  const shouldLockAllSections = isOrderCompleted && !workflowManager.isSectionUnlocked('dokonceni');
  
  // âœ… VÄšCNÃ SPRÃVNOST: Pole vÄ›cnÃ© sprÃ¡vnosti jsou editovatelnÃ¡ ve FÃZI 7+, i kdyÅ¾ zbytek faktury je zamÄenÃ½
  // âš ï¸ VE FÃZI ZKONTROLOVANA (8) je vÄ›cnÃ¡ sprÃ¡vnost ZAKÃZÃNA
  const isZkontrolovana = hasWorkflowState(formData.stav_workflow_kod, 'ZKONTROLOVANA');
  const shouldLockVecnaSpravnost = currentPhase < 7 || currentPhase >= 8 || isZkontrolovana || shouldLockAllSections || isArchived;

  // Helper promÄ›nnÃ© pro workflow stavy (pouÅ¾Ã­vajÃ­ se v jinÃ½ch ÄÃ¡stech kÃ³du)
  const isOrderSent = hasWorkflowState(formData.stav_workflow_kod, 'ODESLANA');
  const isOrderCancelled = hasWorkflowState(formData.stav_workflow_kod, 'ZRUSENA');

  // ðŸŽ¯ POUÅ½ÃVÃME PÅ˜ÃMO currentPhase a phaseProgress Z WorkflowManager
  // WorkflowManager automaticky pÅ™epoÄÃ­tÃ¡ fÃ¡zi kdyÅ¾ se zmÄ›nÃ­ formData.stav_workflow_kod
  // NenÃ­ potÅ™eba manuÃ¡lnÄ› mÄ›nit fÃ¡zi podle unlock states - WorkflowManager to dÄ›lÃ¡ sÃ¡m

  // =====================================================
  // FÃZE 3 SEKCE (Dodavatelâ†’Stav odeslÃ¡nÃ­): ZAMÄŒENO ve FÃZI 4+
  // âš ï¸ POZNÃMKA: FinancovÃ¡nÃ­ je souÄÃ¡stÃ­ FÃZE 1-2, nikoliv FÃZE 3!
  // =====================================================
  // const shouldLockPhase3Sections = ...

  // ðŸ†• FÃZE 4-6: ZamykÃ¡nÃ­ sekcÃ­ "PotvrzenÃ­" a "Registr smluv" kdyÅ¾ jsme v pozdÄ›jÅ¡Ã­ fÃ¡zi (6+)
  // DEPRECATED - NYNÃ Å˜EÅ ENO PÅ˜ES workflowManager.getSectionState('potvrzeni_objednavky')
  // const shouldLockPhase4to6Sections = ...

  // Kdo mÅ¯Å¾e zobrazit tlaÄÃ­tko pro odemknutÃ­?
  // SUPER/ADMIN mohou vÅ¾dy, bÄ›Å¾nÃ­ uÅ¾ivatelÃ© pouze pokud jsou v aktuÃ¡lnÃ­/poslednÃ­ fÃ¡zi
  const canShowUnlockPhase3Button = canUnlockAnything || (currentPhase >= 3 && currentPhase <= 6);

  // ðŸŽ¯ NOVÃ useEffect: Reset stavu pÅ™i zmÄ›nÄ› editOrderId (proklik z jinÃ© objednÃ¡vky)
  useEffect(() => {
    // Pokud se zmÄ›nÃ­ editOrderId (napÅ™. z notifikace nebo universal search), resetuj stav
    if (editOrderId) {
      setIsDraftLoaded(false);
      setIsInitialized(false);
      // ðŸ”§ KRITICKÃ‰: Reset protection flag aby se pÅ™i F5 sprÃ¡vnÄ› naÄetl draft
      onDataLoadedCalledRef.current = null;
    }
  }, [editOrderId]);

  // ZpracovÃ¡nÃ­ editace objednÃ¡vky z URL parametru
  // ðŸš¨ DEPRECATED: Data se nynÃ­ naÄÃ­tajÃ­ v initializeForm() PÅ˜ED prvnÃ­m renderem
  useEffect(() => {
    // âœ… Tento useEffect je teÄ zÃ¡loÅ¾nÃ­ - pouÅ¾ije se jen pokud initializeForm() selhal
    if (editOrderId && token && username && !isDraftLoaded && areDictionariesReady) {
      // // console.log(`âš ï¸ ZÃLOÅ½NÃ naÄÃ­tÃ¡nÃ­ objednÃ¡vky #${editOrderId} (initializeForm() neprobÄ›hl sprÃ¡vnÄ›)`);
      // NechÅ¥ pÅ¯vodnÃ­ kÃ³d zÅ¯stane jako fallback...
    }
  }, [editOrderId, token, username, isDraftLoaded, areDictionariesReady]);

  // PÅ¯vodnÃ­ useEffect pro editaci - ZAKOMENTOVÃNO, nynÃ­ se dÄ›je v initializeForm()
  /*
  useEffect(() => {
    // âœ… KRITICKÃ KONTROLA: ÄŒekej na explicitnÃ­ flag areDictionariesReady
    if (editOrderId && token && username && !isDraftLoaded && areDictionariesReady) {
      const loadOrderForEdit = async () => {
        try {
          // ðŸŽ¯ NEJDÅ˜ÃV zkontroluj jestli uÅ¾ existuje draft z Orders25List
          draftManager.setCurrentUser(user_id);
          const existingDraft = await draftManager.loadDraft();

          if (existingDraft && existingDraft.formData && existingDraft.formData.id == editOrderId) {
            // âœ… MÃ¡me ÄerstvÃ½ draft z Orders25List - pouÅ¾ij ho!

            // Aplikuj draft data na formData
            setFormData(existingDraft.formData);
            setAttachments(existingDraft.attachments || []);
            setIsChanged(existingDraft.isChanged || false);
            setSavedOrderId(existingDraft.savedOrderId || existingDraft.formData.id);
            setIsDraftLoaded(true);

            return; // HOTOVO - draft naÄten
          }

          // Pokud draft neexistuje, naÄti z databÃ¡ze

          // âœ… V2 API: NaÄti objednÃ¡vku s enriched daty
          const dbOrder = await getOrderV2(editOrderId, token, username, true);

          if (!dbOrder) {
            showToast?.('NepodaÅ™ilo se naÄÃ­st objednÃ¡vku pro editaci', 'error');
            return;
          }

          //  KONTROLA ZAMÄŒENÃ podle novÃ© BE logiky (24.10.2025)
          // BE vracÃ­ locked: true POUZE kdyÅ¾ je zamÄenÃ¡ JINÃM uÅ¾ivatelem
          // locked: false znamenÃ¡ "mÅ¯Å¾u editovat" (volnÃ¡ NEBO moje zamÄenÃ¡)

          if (dbOrder.lock_info?.locked === true) {
            // âŒ ZamÄenÃ¡ JINÃM uÅ¾ivatelem - BLOKUJ a pÅ™esmÄ›ruj
            const lockInfo = dbOrder.lock_info;
            const lockedByUserName = lockInfo.locked_by_user_fullname || `uÅ¾ivatel #${lockInfo.locked_by_user_id}`;

            showToast?.(
              `ObjednÃ¡vka je zamÄena uÅ¾ivatelem ${lockedByUserName}. Nelze ji otevÅ™Ã­t pro editaci.`,
              'warning'
            );

            addDebugLog('warning', 'EDIT', 'locked', `ObjednÃ¡vka ${editOrderId} je zamÄena uÅ¾ivatelem ${lockedByUserName}`);

            // ðŸ”¥ OPRAVENO: PouÅ¾Ã­t React Router navigate mÃ­sto window.location.href
            navigate('/orders25-list', { replace: true });
            return; // ZABLOKOVAT naÄtenÃ­ formulÃ¡Å™e
          } else if (dbOrder.lock_info?.is_owned_by_me === true) {
            // âœ… Moje zamÄenÃ¡ objednÃ¡vka - pokraÄuj v editaci
          } else {
            // ObjednÃ¡vka nenÃ­ zamÄenÃ¡ - normÃ¡lnÃ­ lock
            try {
              const lockResult = await lockOrder25({ token, username, orderId: editOrderId });
              if (lockResult.success) {
                showToast?.(
                  `ObjednÃ¡vka zamknuta pro editaci`,
                  'info'
                );
                addDebugLog('success', 'EDIT', 'locked', `ObjednÃ¡vka ${editOrderId} byla zamknuta pro editaci`);
              }
            } catch (lockError) {

              // Pokud mÃ¡ lockError lock_info, je zamÄenÃ¡ jinÃ½m uÅ¾ivatelem
              if (lockError.lock_info) {
                const lockInfo = lockError.lock_info;
                const userName = lockInfo.locked_by_user_fullname || `uÅ¾ivatel #${lockInfo.locked_by_user_id}`;

                showToast?.(
                  `ObjednÃ¡vka je zamÄena uÅ¾ivatelem ${userName}`,
                  'warning'
                );

                window.history.replaceState({}, '', '/orders25-list');
                return;
              }

              // JinÃ¡ chyba - varovÃ¡nÃ­, ale pokraÄuj
              showToast?.('VarovÃ¡nÃ­: NepodaÅ™ilo se zamknout objednÃ¡vku', 'warning');
            }
          }

          addDebugLog('success', 'EDIT', 'url-loaded', `ObjednÃ¡vka naÄtena z URL parametru: ${dbOrder.cislo_objednavky || dbOrder.ev_cislo}`);

          // ðŸ› DEBUG: Co BE vracÃ­
          if (dbOrder.faktury && dbOrder.faktury.length > 0) {
            if (dbOrder.faktury[0].fa_polozky && dbOrder.faktury[0].fa_polozky.length > 0) {
            }
          }
          // VytvoÅ™ draft pro editaci (stejnÄ› jako v Orders25List.js)
          const orderId = dbOrder.id;

          // NaÄti detaily objednatele
          let objednatelDetails = null;
          if (dbOrder.objednatel_id) {
            try {
              const { getUserDetailApi2 } = await import('../services/api2auth');
              objednatelDetails = await getUserDetailApi2(username, token, dbOrder.objednatel_id);
            } catch (error) {
              objednatelDetails = null;
            }
          }

          // VytvoÅ™ Ãºdaje objednatele
          let objednatelData = {
            objednatel_id: dbOrder.objednatel_id || user_id,
            jmeno: 'Neuvedeno',
            email: '',
            telefon: ''
          };

          if (objednatelDetails) {
            const jmeno = `${objednatelDetails.titul_pred ? objednatelDetails.titul_pred + ' ' : ''}${objednatelDetails.jmeno || ''} ${objednatelDetails.prijmeni || ''}${objednatelDetails.titul_za ? ', ' + objednatelDetails.titul_za : ''}`.replace(/\s+/g, ' ').trim();
            objednatelData = {
              objednatel_id: dbOrder.objednatel_id,
              jmeno: jmeno || 'Neuvedeno',
              email: objednatelDetails.email || '',
              telefon: objednatelDetails.telefon || ''
            };
          }

          // Helper funkce pro workflow stavy
          const hasWorkflowState = (workflowCode, state) => {
            if (!workflowCode) return false;
            try {
              if (typeof workflowCode === 'string' && workflowCode.startsWith('[')) {
                const states = JSON.parse(workflowCode);
                return Array.isArray(states) && states.includes(state);
              }
              return String(workflowCode).includes(state);
            } catch {
              return String(workflowCode).includes(state);
            }
          };

          // OdvozenÃ­ UI stavÅ¯ ze workflow
          const isSchvalena = hasWorkflowState(dbOrder.stav_workflow_kod, 'SCHVALENA');
          const isOdeslana = hasWorkflowState(dbOrder.stav_workflow_kod, 'ODESLANA');
          const isZrusena = hasWorkflowState(dbOrder.stav_workflow_kod, 'ZRUSENA');
          const isZamitnuta = hasWorkflowState(dbOrder.stav_workflow_kod, 'ZAMITNUTA');
          const isCekaSe = hasWorkflowState(dbOrder.stav_workflow_kod, 'CEKA_SE');

          // âœ… MapovÃ¡nÃ­ workflow stavÅ¯ na UI checkbox (stav_schvaleni je POUZE UI helper, neuklÃ¡dÃ¡ se do DB!)
          let stavSchvaleni = '';
          if (isSchvalena) {
            stavSchvaleni = 'schvaleno';
          } else if (isZamitnuta) {
            stavSchvaleni = 'neschvaleno';
          } else if (isCekaSe) {
            stavSchvaleni = 'ceka_se';
          }
          // ODESLANA_KE_SCHVALENI â†’ checkbox zÅ¯stane prÃ¡zdnÃ½ (nenÃ­ vybranÃ½ Å¾Ã¡dnÃ½ stav)

          // VytvoÅ™ fresh draft s DB daty
          // ðŸ”§ KRITICKÃ OPRAVA: PouÅ¾ij transformBackendDataToFrontend pro sprÃ¡vnÃ© mapovÃ¡nÃ­ financovÃ¡nÃ­!
          const transformedDbOrder = transformBackendDataToFrontend(dbOrder);

          // ðŸ”§ VALIDACE STÅ˜EDISEK: Fallback pro neaktivnÃ­ stÅ™ediska
          if (transformedDbOrder.strediska_kod && Array.isArray(transformedDbOrder.strediska_kod)) {
            transformedDbOrder.strediska_kod = validateAndFixStrediska(
              transformedDbOrder.strediska_kod,
              strediskaOptions
            );
          }

          const freshDraft = {
            formData: {
              ...transformedDbOrder,
              uzivatel_id: user_id,
              ev_cislo: dbOrder.cislo_objednavky || dbOrder.ev_cislo || 'CHYBA: ChybÃ­ ÄÃ­slo v DB!',
              stav_schvaleni: stavSchvaleni,
              stav_odeslano: isOdeslana,
              stav_stornovano: isZrusena,
              // ðŸ”§ FÃZE 7: ExplicitnÃ­ parsovÃ¡nÃ­ vÄ›cnÃ© sprÃ¡vnosti z DB
              // âŒ ODSTRANÄšNO: VÄ›cnÃ¡ sprÃ¡vnost global fields - refaktorovÃ¡no na per-invoice
              // vecna_spravnost_potvrzeno: 0,
              // potvrdil_vecnou_spravnost_id: null,
              // dt_vecna_spravnost_potvrzeno: null,
              // vecna_spravnost_umisteni_majetku: '',
              // vecna_spravnost_poznamka: '',
              // ðŸ”§ FÃZE 8: ExplicitnÃ­ parsovÃ¡nÃ­ dokonÄenÃ­ z DB
              potvrzeni_dokonceni_objednavky: dbOrder.potvrzeni_dokonceni_objednavky !== undefined
                ? parseInt(dbOrder.potvrzeni_dokonceni_objednavky, 10)
                : 0,
              dokoncil_id: dbOrder.dokoncil_id || null,
              dt_dokonceni: dbOrder.dt_dokonceni || null,
              dokonceni_poznamka: dbOrder.dokonceni_poznamka || '',

              ...(objednatelData && {
                objednatel_id: objednatelData.objednatel_id,
                jmeno: objednatelData.jmeno,
                email: objednatelData.email,
                telefon: objednatelData.telefon
              }),
              // ðŸ”§ KRITICKÃ OPRAVA: MapovÃ¡nÃ­ faktur z DB na FE formÃ¡t (stejnÄ› jako v Å™Ã¡dku 7867)
              faktury: (() => {
                if (dbOrder.faktury && Array.isArray(dbOrder.faktury)) {
                  return dbOrder.faktury.map(faktura => {
                    // ðŸ†• DETEKCE POKLADNÃHO DOKLADU z rozsirujici_data
                    const rozsirujiciData = typeof faktura.rozsirujici_data === 'string'
                      ? JSON.parse(faktura.rozsirujici_data || '{}')
                      : (faktura.rozsirujici_data || {});

                    const isPokladna = rozsirujiciData.typ_platby === 'pokladna' || rozsirujiciData.pokladni_doklad;

                    const mappedFaktura = {
                      ...faktura,
                      // ðŸ†• PÅ˜ÃZNAK POKLADNY
                      _isPokladna: isPokladna,
                      rozsirujici_data: rozsirujiciData,
                      // ðŸ”§ MAPOVÃNÃ 1:1 mezi DB sloupci a FE poli
                      fa_dorucena: faktura.fa_datum_doruceni ? 1 : 0, // âœ… Boolean flag zda mÃ¡ datum doruÄenÃ­
                      fa_splatnost: faktura.fa_datum_splatnosti ? faktura.fa_datum_splatnosti.split(' ')[0] : '', // DB -> FE: fa_datum_splatnosti -> fa_splatnost
                      // ðŸ”§ PARSOVÃNÃ STÅ˜EDISEK z DB: JSON string kÃ³dÅ¯ â†’ FE objekty s nÃ¡zvy
                    fa_strediska_kod: (() => {
                      try {
                        let parsed = [];

                        if (Array.isArray(faktura.fa_strediska_kod)) {
                          parsed = faktura.fa_strediska_kod; // UÅ¾ je pole
                        } else if (typeof faktura.fa_strediska_kod === 'string') {
                          parsed = JSON.parse(faktura.fa_strediska_kod) || []; // Parsuj JSON: ["KLADNO","BENESOV"]
                        }

                        // ðŸ”§ Transformuj kÃ³dy na objekty s nÃ¡zvy (pro zobrazenÃ­ v SELECTu)
                        const result = parsed.map(item => {
                          if (typeof item === 'object' && item.kod_stavu) {
                            // UÅ¾ je objekt â†’ zkontroluj zda existuje v aktivnÃ­ch
                            const exists = strediskaOptions.find(opt =>
                              opt.kod_stavu === item.kod_stavu || opt.kod === item.kod_stavu || opt.value === item.kod_stavu
                            );
                            if (exists) {
                              return item;
                            }
                            // NeaktivnÃ­ stÅ™edisko â†’ nahradit za 100 SprÃ¡va Kladno
                            const fallback = strediskaOptions.find(opt =>
                              opt.kod_stavu === "100" || opt.kod === "100" || opt.value === "100"
                            );
                            return fallback ? {
                              kod_stavu: fallback.kod_stavu || fallback.kod || fallback.value,
                              nazev_stavu: fallback.nazev_stavu || fallback.nazev || fallback.label
                            } : { kod_stavu: "100", nazev_stavu: "100 SprÃ¡va Kladno" };
                          }
                          // Je to jen kÃ³d (string) â†’ najÃ­t stÅ™edisko v options a vzÃ­t celÃ½ objekt
                          const stredisko = strediskaOptions.find(opt =>
                            opt.kod_stavu === item || opt.kod === item || opt.value === item
                          );
                          if (stredisko) {
                            return {
                              kod_stavu: stredisko.kod_stavu || stredisko.kod || stredisko.value,
                              nazev_stavu: stredisko.nazev_stavu || stredisko.nazev || stredisko.label
                            };
                          }
                          // NeaktivnÃ­ stÅ™edisko â†’ nahradit za 100 SprÃ¡va Kladno
                          const fallback = strediskaOptions.find(opt =>
                            opt.kod_stavu === "100" || opt.kod === "100" || opt.value === "100"
                          );
                          return fallback ? {
                            kod_stavu: fallback.kod_stavu || fallback.kod || fallback.value,
                            nazev_stavu: fallback.nazev_stavu || fallback.nazev || fallback.label
                          } : { kod_stavu: "100", nazev_stavu: "100 SprÃ¡va Kladno" };
                        });

                        return result;

                      } catch (e) {
                        addDebugLog('warning', 'EDIT-FAKTURY-LOAD', 'json-parse-error', `Chyba pÅ™i parsovÃ¡nÃ­ fa_strediska_kod faktury ID ${faktura.id}: ${e.message}, data: ${faktura.fa_strediska_kod}`);
                        return [];
                      }
                    })(),
                    // Zachovat originÃ¡lnÃ­ DB pole pro API odesÃ­lÃ¡nÃ­
                    fa_datum_doruceni: faktura.fa_datum_doruceni,
                    fa_datum_splatnosti: faktura.fa_datum_splatnosti,
                    fa_datum_vystaveni: faktura.fa_datum_vystaveni
                    };

                    return mappedFaktura;
                  });
                } else {
                  return []; // Å½Ã¡dnÃ© faktury
                }
              })()
            },
            timestamp: Date.now(),
            version: '1.4',
            isConceptSaved: true,
            isChanged: false,
            isOrderSavedToDB: true,
            savedOrderId: orderId,
            attachments: []
          };

          // VyÄisti localStorage a uloÅ¾ fresh draft
          for (let i = localStorage.length - 1; i >= 0; i--) {
            const key = localStorage.key(i);
            if (key && (
              key.startsWith('orderForm25_') ||
              key.startsWith('order25_draft_') ||  // ORDER25 STANDARD
              key.startsWith('order25-draft-') ||  // LEGACY cleanup
              key.startsWith('orderForm25-') ||
              key.includes('draft') && key.includes('order')
            )) {
              localStorage.removeItem(key);
            }
          }

          // ðŸ”¥ KRITICKÃ OPRAVA: Pokud DB nemÃ¡ faktury, explicitnÄ› nastav prÃ¡zdnÃ© pole
          if (!freshDraft.formData.faktury || freshDraft.formData.faktury.length === 0) {
            freshDraft.formData.faktury = []; // ExplicitnÄ› prÃ¡zdnÃ© pole
          }

          // âœ… UloÅ¾ draft pÅ™es DraftManager s invalidated: false (editace ze seznamu = validnÃ­ draft)
          draftManager.setCurrentUser(user_id);
          await draftManager.syncWithDatabase(freshDraft.formData, orderId);

          // âœ… PÅ˜IDAT: ExplicitnÄ› uloÅ¾ metadata pro EDIT mode
          draftManager.saveMetadata({
            isEditMode: true,
            savedOrderId: orderId,
            editOrderId: orderId,  // âœ… KLÃÄŒOVÃ‰!
            openConceptNumber: freshDraft.formData.ev_cislo || freshDraft.formData.cislo_objednavky
          });

            orderId,
            ev_cislo: freshDraft.formData.ev_cislo || freshDraft.formData.cislo_objednavky
          });

          // ðŸ”„ REFRESH MENUBAR: OznÃ¡m MenuBaru, Å¾e se naÄetla objednÃ¡vka pro editaci
          window.dispatchEvent(new CustomEvent('orderDraftChange', {
            detail: {
              hasDraft: true,
              isEditMode: true, // EDITACE objednÃ¡vky (ne koncept)
              orderId: orderId,
              orderNumber: dbOrder.cislo_objednavky || dbOrder.ev_cislo,
              isLoading: false
            }
          }));

          // ðŸŽ¯ DEBUG LOG - FÃZE 2: ObjednÃ¡vka naÄtena z URL
          const currentPhaseNum = (() => {
            // Highest phases first
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'DOKONCENA')) return 10;
            // ZKONTROLOVANA - fÃ¡ze 10 (pÅ™ed dokonÄenÃ­m)
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'ZKONTROLOVANA')) return 10;
            // VECNA_SPRAVNOST - fÃ¡ze 9 (vÄ›cnÃ¡ sprÃ¡vnost)
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'VECNA_SPRAVNOST')) return 9;
            // Fakturace (fÃ¡ze 8)
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'FAKTURACE')) return 8;
            // Registr smluv - FÃZE 7
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'DOKONCENA')) return 9;
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'ZKONTROLOVANA')) return 8;
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'VECNA_SPRAVNOST')) return 7;
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'FAKTURACE')) return 6;
            // Pokud UVEREJNENA â†’ FÃZE 6 (Fakturace)
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'UVEREJNENA')) return 6;
            // Pokud bylo rozhodnuto NEUVEREJNIT â†’ FÃZE 6 (Fakturace)
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'NEUVEREJNIT')) return 6;
            // Pokud bylo rozhodnuto UVEREJNIT â†’ FÃZE 5 (VyplnÄ›nÃ­ registru)
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'UVEREJNIT')) return 5;
            // Potvrzeno dodavatelem - ZÅ®STÃVÃ ve FÃZI 4
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'POTVRZENA')) return 4;
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'ODESLANA')) return 4;
            if (hasWorkflowState(dbOrder.stav_workflow_kod, 'SCHVALENA')) return 2;
            return 1;
          })();
          // VyÄisti URL od edit parametru
          const newUrl = window.location.pathname;
          window.history.replaceState({}, '', newUrl);

        } catch (error) {

          showToast?.('NepodaÅ™ilo se naÄÃ­st objednÃ¡vku pro editaci', 'error');
        }
      };

      loadOrderForEdit();
    } else if (editOrderId && !areDictionariesReady) {
      // â³ ÄŒekÃ¡nÃ­ na naÄtenÃ­ slovnÃ­kÅ¯ (tichÃ½ reÅ¾im - bez logovÃ¡nÃ­)
    }
  }, [editOrderId, token, username, isDraftLoaded, showToast, areDictionariesReady]);
  */

  // ðŸ”’ CLEANUP: Odemkni objednÃ¡vku pÅ™i unmount komponenty (zavÅ™enÃ­ formulÃ¡Å™e)
  // OPRAVA: PouÅ¾itÃ­ useRef pro uloÅ¾enÃ­ aktuÃ¡lnÃ­ hodnoty bez triggeru cleanup pÅ™i zmÄ›nÄ› dependencies


  const unlockOrderIdRef = useRef(null);
  const userRoleRef = useRef({ isSuperAdmin: false, isAdmin: false });

  // Aktualizuj ref pÅ™i zmÄ›nÄ› savedOrderId nebo sourceOrderIdForUnlock
  useEffect(() => {
    unlockOrderIdRef.current = sourceOrderIdForUnlock || savedOrderId;
  }, [sourceOrderIdForUnlock, savedOrderId]);

  // Aktualizuj ref s rolemi uÅ¾ivatele
  useEffect(() => {
    const isSuperAdmin = userDetail?.roles?.some(role => role.kod_role === 'SUPERADMIN');
    const isAdmin = userDetail?.roles?.some(role => role.kod_role === 'ADMINISTRATOR');
    userRoleRef.current = { isSuperAdmin, isAdmin };
  }, [userDetail]);

  // âœ… NOVÃ OBJEDNÃVKA: AutomatickÃ© vyplnÄ›nÃ­ ÃºdajÅ¯ pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele
  // SpustÃ­ se POUZE pokud je to novÃ¡ objednÃ¡vka BEZ ÃºdajÅ¯ v formData
  useEffect(() => {
    // PodmÃ­nky: je to novÃ¡ objednÃ¡vka + draft je naÄten + nenÃ­ vyplnÄ›no jmÃ©no + mÃ¡me userDetail
    if (isNewOrder && isDraftLoaded && !formData.jmeno && userDetail && user_id) {

      const jmeno = `${userDetail.titul_pred ? userDetail.titul_pred + ' ' : ''}${userDetail.jmeno || ''} ${userDetail.prijmeni || ''}${userDetail.titul_za ? ', ' + userDetail.titul_za : ''}`.replace(/\s+/g, ' ').trim();

      setFormData(prev => ({
        ...prev,
        jmeno: jmeno,
        email: userDetail.email || '',
        telefon: userDetail.telefon || '',
        uzivatel_id: user_id, // ID uÅ¾ivatele kterÃ½ vytvÃ¡Å™Ã­ objednÃ¡vku
        objednatel_id: user_id // ImplicitnÄ› objednatel = vytvoÅ™il
      }));
    }
  }, [isNewOrder, isDraftLoaded, formData.jmeno, userDetail, user_id]);

  // Cleanup se spustÃ­ POUZE pÅ™i skuteÄnÃ©m unmount (prÃ¡zdnÃ© dependencies)
  useEffect(() => {
    return () => {
      // Cleanup funkce se zavolÃ¡ POUZE pÅ™i unmount komponenty
      const unlockOrderId = unlockOrderIdRef.current;
      const { isSuperAdmin, isAdmin } = userRoleRef.current;

      // ðŸ”’ ADMIN/SUPERADMIN NEMAJÃ AUTO-UNLOCK - zÅ¯stÃ¡vajÃ­ drÅ¾et zÃ¡mek
      // OstatnÃ­ uÅ¾ivatelÃ© se pÅ™i opuÅ¡tÄ›nÃ­ formulÃ¡Å™e odemknou automaticky
      if (unlockOrderId && token && username && !isSuperAdmin && !isAdmin) {
        // Odemkni objednÃ¡vku asynchronnÄ› (bez await v cleanup)
        unlockOrder25({ token, username, orderId: unlockOrderId })
          .then(() => {
          })
          .catch((error) => {
          });
      }
    };
  }, []); // âœ… PrÃ¡zdnÃ© dependencies = cleanup POUZE pÅ™i unmount

  // DEBUG logy odstranÄ›ny - zpÅ¯sobovaly nekoneÄnÃ© re-rendery!  // NastavenÃ­ stavÅ¯ pÅ™i naÄtenÃ­ existujÃ­cÃ­ objednÃ¡vky
  useEffect(() => {
    if (formData.id) {
      setSavedOrderId(formData.id);

      // KRITICKÃ‰: Reset validaÄnÃ­ch stavÅ¯ pouze pÅ™i ZMÄšNÄš ID (naÄÃ­tÃ¡ se jinÃ¡ objednÃ¡vka)
      // âŒ NEÄŒISTIT validationErrors pokud uÅ¾ivatel prÃ¡vÄ› zkusil uloÅ¾it (hasTriedToSubmit)
      // âœ… ÄŒistit pouze kdyÅ¾ se mÄ›nÃ­ ID objednÃ¡vky (naÄÃ­tÃ¡ se jinÃ½ zÃ¡znam)
      if (!hasTriedToSubmit) {
        setValidationErrors({});
        setTouchedSelectFields(new Set());
      }

      // ðŸŽ¯ UloÅ¾it ÄÃ­slo objednÃ¡vky pÅ™es DraftManager pro zvÃ½raznÄ›nÃ­ v seznamu
      if (user_id && formData.ev_cislo) {
        draftManager.saveMetadata({ openConceptNumber: formData.ev_cislo });
      }

      // Flag uÅ¾ nepotÅ™ebujeme - fÃ¡ze se odvozuje pÅ™Ã­mo z workflow stavu
    }
  }, [formData.id]); // âœ… ODSTRANIT stav_workflow_kod z dependencies!

  // ðŸ” Ref pro zabrÃ¡nÄ›nÃ­ duplicitnÃ­ho vytvÃ¡Å™enÃ­ poloÅ¾ek
  const hasCreatedInitialItem = useRef(false);
  const lastPhaseRef = useRef(currentPhase);

  // Inicializace poloÅ¾ek objednÃ¡vky pÅ™i pÅ™echodu do fÃ¡ze 2 nebo po naÄtenÃ­ konceptu
  useEffect(() => {
    // KRITICKÃ‰: VytvoÅ™it prÃ¡zdnou poloÅ¾ku POUZE pokud:
    // 1. Jsme ve fÃ¡zi 2+
    // 2. Nejsou Å¾Ã¡dnÃ© poloÅ¾ky
    // 3. Sekce Detail objednÃ¡vky NENÃ zamÄenÃ¡ (pokud je odemÄenÃ¡, musÃ­ bÃ½t vidÄ›t min. 1 poloÅ¾ka)
    // 4. Draft uÅ¾ byl naÄten (aby se nespustilo bÄ›hem naÄÃ­tÃ¡nÃ­ dat)
    // 5. JeÅ¡tÄ› jsme nevytvoÅ™ili prÃ¡zdnou poloÅ¾ku v tÃ©to fÃ¡zi

    const polozkyLength = formData.polozky_objednavky?.length || 0;

    // ï¿½ DEBUG: LogovÃ¡nÃ­ vÅ¡ech podmÃ­nek
    if (currentPhase >= 3) {
      // DEBUG: POLOZKY phase 3+ debug logging removed for performance
    }

    // ðŸ›¡ï¸ OCHRANA: ZabrÃ¡nit spuÅ¡tÄ›nÃ­ bÄ›hem inicializace
    if (!isDraftLoaded) {
      // DEBUG: Draft loading wait - logging removed
      return;
    }

    // âœ… Pro novÃ© objednÃ¡vky nemusÃ­ bÃ½t vybrÃ¡n druh objednÃ¡vky - poloÅ¾ky se mohou vytvoÅ™it i bez nÄ›j

    // ï¿½ Resetovat pÅ™i zmÄ›nÄ› fÃ¡ze nebo druhu objednÃ¡vky
    if (lastPhaseRef.current !== currentPhase) {
      hasCreatedInitialItem.current = false;
      lastPhaseRef.current = currentPhase;
      // DEBUG: Phase change reset - logging removed
    }

    // âœ… OPRAVA: ZmÄ›na z fÃ¡ze 2+ na fÃ¡ze 3+ (Detail objednÃ¡vky se zobrazuje od fÃ¡ze 3)
    // ðŸ”§ ADDITIONAL FIX: VytvoÅ™it poloÅ¾ku i kdyÅ¾ je sekce zamÄenÃ¡ (aby se zobrazila)
    if (currentPhase >= 3 &&
        polozkyLength === 0 &&
        !hasCreatedInitialItem.current) {

      hasCreatedInitialItem.current = true; // ðŸ”’ Zamknout dalÅ¡Ã­ vytvÃ¡Å™enÃ­

      // DEBUG: Creating empty item - logging removed
      setFormData(prev => ({
        ...prev,
        polozky_objednavky: [
          {
            id: `new_item_${Date.now()}`,
            popis: '',
            mnozstvi: '1',
            jednotka: 'ks',
            cena_bez_dph: '',
            sazba_dph: '21',
            cena_s_dph: ''
          }
        ]
      }));
    }
  }, [currentPhase, isDraftLoaded, formData.druh_objednavky_kod, formData.polozky_objednavky?.length]);

  // DEBUG: SledovÃ¡nÃ­ zmÄ›n v poloÅ¾kÃ¡ch (disabled to prevent console flood)
  // useEffect(() => {
  //   if (formData.polozky_objednavky) {
  //     addDebugLog('info', 'POLOZKY', 'change-detected', `ZmÄ›na v poloÅ¾kÃ¡ch - aktuÃ¡lnÃ­ poÄet: ${formData.polozky_objednavky.length}`);
  //     if (formData.polozky_objednavky.length > 0) {
  //       const firstItem = formData.polozky_objednavky[0];
  //       addDebugLog('info', 'POLOZKY', 'first-item', `PrvnÃ­ poloÅ¾ka: popis="${firstItem.popis}", cena_bez_dph="${firstItem.cena_bez_dph}"`);
  //     }
  //   }
  // }, [formData.polozky_objednavky]);

  // ðŸ’° AUTOMATICKÃ DETEKCE CENY > 50 000 KÄ bez DPH pro "MÃ¡ bÃ½t zveÅ™ejnÄ›na"
  useEffect(() => {
    // Aktivovat pouze ve FÃZI 4 (ODESLANA/POTVRZENA) kdyÅ¾ dodavatel potvrdÃ­ ANO
    if (!formData.polozky_objednavky || formData.polozky_objednavky.length === 0) return;
    if (currentPhase !== 4) return; // Pouze ve FÃZI 4

    // MusÃ­ bÃ½t potvrzeno dodavatelem ANO
    const dodavatelPotvrzeni = formData.dodavatel_zpusob_potvrzeni;
    const potvrdilAno = dodavatelPotvrzeni?.potvrzeni === 'ANO' || dodavatelPotvrzeni?.potvrzeno === true;
    if (!potvrdilAno) return;

    // Pokud uÅ¾ je rozhodnuto (UVEREJNIT nebo NEUVEREJNIT), nepÅ™episuj
    if (hasWorkflowState(formData.stav_workflow_kod, 'UVEREJNIT')) return;
    if (hasWorkflowState(formData.stav_workflow_kod, 'NEUVEREJNIT')) return;

    // Pokud uÅ¾ je hodnota nastavena (uÅ¾ivatel kliknul), nepÅ™episuj
    if (formData.ma_byt_zverejnena !== undefined && formData.ma_byt_zverejnena !== null) return;

    // SeÄti vÅ¡echny ceny bez DPH
    const celkovaCenaBezDPH = formData.polozky_objednavky.reduce((sum, polozka) => {
      // ðŸ”§ FIX: Odstranit formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat
      const cenaBezDPH = parseFloat((polozka.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      const mnozstvi = parseFloat(polozka.mnozstvi) || 1;
      return sum + (cenaBezDPH * mnozstvi);
    }, 0);

    // Nastavit vÃ½chozÃ­ hodnotu podle ceny
    const defaultValue = celkovaCenaBezDPH > 50000;
    setFormData(prev => ({
      ...prev,
      ma_byt_zverejnena: defaultValue
    }));

    addDebugLog('info', 'REGISTR', 'auto-detect',
      `Cena ${celkovaCenaBezDPH.toFixed(2)} KÄ ${defaultValue ? '>' : 'â‰¤'} 50 000 KÄ â†’ vÃ½chozÃ­ hodnota "MÃ¡ bÃ½t zveÅ™ejnÄ›na" = ${defaultValue}`
    );
  }, [currentPhase, formData.polozky_objednavky, formData.dodavatel_zpusob_potvrzeni, formData.stav_workflow_kod, formData.ma_byt_zverejnena]);

  // ðŸ’° HELPER FUNKCE PRO PRÃCI S FAKTURAMI (stejnÃ½ pattern jako poloÅ¾ky)
  const updateFaktury = useCallback((newFaktury) => {
    setFormData(prev => ({
      ...prev,
      faktury: newFaktury
    }));
    // ðŸ”¥ KRITICKÃ‰: Nastavit isChanged pÅ™i zmÄ›nÄ› faktur
    setIsChanged(true);
  }, [formData.faktury]);

  // ZamykÃ¡nÃ­ se Å™eÅ¡Ã­ pÅ™Ã­mo v saveOrderToAPI() po uloÅ¾enÃ­

  // ReaktivnÃ­ logika pro zpusob_financovani: Pokud je vybranÃ¡ Pokladna, zablokuj Dodavatel sekci
  useEffect(() => {
    if (!formData.zpusob_financovani || !financovaniOptions.length) return;

    const selectedFinancovani = financovaniOptions.find(opt =>
      opt.kod === formData.zpusob_financovani ||
      opt.value === formData.zpusob_financovani
    );

    const nazev = selectedFinancovani?.nazev || '';
    const isPokladna = nazev.toLowerCase().includes('pokladna');

    if (isPokladna) {
      // 1. Svinout (collapse) sekci Dodavatel
      setSectionStates(prev => ({
        ...prev,
        dodavatel: true // true = collapsed
      }));

      // 2. Vymazat vÅ¡echny hodnoty polÃ­ dodavatele
      setFormData(prev => ({
        ...prev,
        dodavatel_id: null,
        dodavatel_nazev: '',
        dodavatel_adresa: '',
        dodavatel_ico: '',
        dodavatel_dic: '',
        dodavatel_zastoupeny: '',
        dodavatel_kontakt_jmeno: '',
        dodavatel_kontakt_email: '',
        dodavatel_kontakt_telefon: ''
      }));

      // âŒ REMOVED: MazÃ¡nÃ­ chyb dodavatele - zbyteÄnÃ©
      // Validace probÃ­hÃ¡ POUZE pÅ™i Save, live mazÃ¡nÃ­ chyb nenÃ­ potÅ™eba
    } else {
      // Pokud NENÃ Pokladna, rozbal sekci Dodavatel (aby byla viditelnÃ¡)
      setSectionStates(prev => ({
        ...prev,
        dodavatel: false // false = expanded/rozbalenÃ¡
      }));
    }
  }, [formData.zpusob_financovani, financovaniOptions, hasTriedToSubmit]);

  // GlobÃ¡lnÃ­ drag and drop prevention (zabrÃ¡nÃ­ otevÅ™enÃ­ souboru v prohlÃ­Å¾eÄi)
  useEffect(() => {
    const preventDefaults = (e) => {
      e.preventDefault();
      e.stopPropagation();
    };

    const handleDrop = (e) => {
      preventDefaults(e);
    };

    // PÅ™idat event listenery
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.addEventListener(eventName, preventDefaults, false);
    });

    document.addEventListener('drop', handleDrop, false);

    // Cleanup
    return () => {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.removeEventListener(eventName, preventDefaults, false);
      });
      document.removeEventListener('drop', handleDrop, false);
    };
  }, []);

  // VÃ½poÄet celkovÃ© ceny poloÅ¾ek s DPH (optimalizovÃ¡no s useMemo)
  const totalPrice = useMemo(() => {
    if (!formData.polozky_objednavky || formData.polozky_objednavky.length === 0) {
      return 0;
    }

    return formData.polozky_objednavky.reduce((total, polozka) => {
      // ðŸ”§ FIX: Odstranit formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat
      const cena = parseFloat((polozka.cena_s_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      return total + cena;
    }, 0);
  }, [formData.polozky_objednavky]);

  // PorovnÃ¡nÃ­ s maximÃ¡lnÃ­ cenou
  const maxPrice = useMemo(() => {
    return parseFloat(formData.max_cena_s_dph?.toString().replace(/[^0-9.-]/g, '')) || 0;
  }, [formData.max_cena_s_dph]);

  const priceDifference = maxPrice - totalPrice;
  const isPriceExceeded = totalPrice > maxPrice && maxPrice > 0;
  const isPriceWithinLimit = totalPrice <= maxPrice && maxPrice > 0 && totalPrice > 0;

  // VÃ½poÄet ceny BEZ DPH (pro registr smluv) - sprÃ¡vnÄ› z poloÅ¾ek
  const celkovaCenaBezDPH = useMemo(() => {
    if (!formData.polozky_objednavky || formData.polozky_objednavky.length === 0) {
      return 0;
    }
    return formData.polozky_objednavky.reduce((sum, polozka) => {
      // ðŸ”§ FIX: Odstranit formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat
      const cenaBezDPH = parseFloat((polozka.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      const mnozstvi = parseFloat(polozka.mnozstvi) || 1;
      return sum + (cenaBezDPH * mnozstvi);
    }, 0);
  }, [formData.polozky_objednavky]);

  // DEPRECATED: StarÃ½ vÃ½poÄet DPH
  const totalPriceWithoutDPH = useMemo(() => {
    return totalPrice / 1.21; // PÅ™edpoklÃ¡dÃ¡me 21% DPH
  }, [totalPrice]);

  // AutomatickÃ© zaÅ¡krtÃ¡vÃ¡nÃ­ registru smluv pÅ™i pÅ™echodu do FÃZE 3 (pokud cena BEZ DPH > 50 000 KÄ)
  // âš ï¸ POZOR: Automaticky se nastavÃ­ jen pokud objednÃ¡vka JE ULOÅ½ENÃ v DB (mÃ¡ (formData.id || savedOrderId))
  useEffect(() => {
    const currentPhaseNum = getCurrentPhase();
    const shouldAutoCheck = currentPhaseNum >= 3 &&
                           celkovaCenaBezDPH > 50000 &&
                           !formData.ma_byt_zverejnena &&
                           (formData.id || savedOrderId); // âœ… Kontrola Å¾e objednÃ¡vka je uloÅ¾enÃ¡ v DB

    if (shouldAutoCheck) {
      handleInputChange('ma_byt_zverejnena', true);
    }
  }, [getCurrentPhase(), celkovaCenaBezDPH, formData.id, savedOrderId]); // âœ… PÅ™idÃ¡na zÃ¡vislost na savedOrderId

  // VynucenÃ­ typu Å¡ablony 'po' ve FÃZI 1 (pÅ™ed schvÃ¡lenÃ­m)
  useEffect(() => {
    if (currentPhase < 2 && templateType !== 'po') {
      setTemplateType('po');
    }
  }, [currentPhase, templateType]);

  // Smart naÄtenÃ­ pÅ™Ã­loh pÅ™i refreshi formulÃ¡Å™e (DB + lokÃ¡lnÃ­ neuloÅ¾enÃ©)
  // POZOR: NaÄÃ­tÃ¡ se vÅ¾dy, kdyÅ¾ mÃ¡ objednÃ¡vka ID a sekce pÅ™Ã­loh je viditelnÃ¡ (!sectionStates.prilohy)
  useEffect(() => {
    if ((formData.id || savedOrderId) && token && username && !isNewOrder && !sectionStates.prilohy) {

      loadAttachmentsSmartly();
    }
  }, [formData.id, savedOrderId, token, username, isNewOrder, sectionStates.prilohy]);

  // ðŸ—‘ï¸ REMOVED: useEffect pro naÄÃ­tÃ¡nÃ­ typÅ¯ pÅ™Ã­loh - DEPRECATED
  // Typy pÅ™Ã­loh se naÄÃ­tajÃ­ pÅ™i inicializaci pÅ™es useDictionaries.loadAll()
  // Nejsou potÅ™eba lazy loading - jsou dostupnÃ© ihned v prilohyTypyOptions (alias na dictionaries.data.prilohyTypyOptions)

  // TICHÃ validace pro zobrazenÃ­ ÄervenÃ½ch polÃ­ (pouze pokud jiÅ¾ uÅ¾ivatel se pokusil uloÅ¾it)
  // âŒ DOÄŒASNÄš ZAKOMENTOVÃNO: Tyto useEffecty zpÅ¯sobujÃ­ PÅ˜EPSÃNÃ validationErrors a mizenÃ­ ÄervenÃ½ch rÃ¡meÄkÅ¯
  // Validace se dÄ›lÃ¡ pouze pÅ™i kliknutÃ­ na "UloÅ¾it" v validateFormForSave()
  // Live validace bÄ›hem editace nenÃ­ potÅ™eba a zpÅ¯sobuje race conditions
  
  // useEffect(() => {
  //   // SpusÅ¥ TICHOU validaci pouze pokud se uÅ¾ivatel uÅ¾ jednou pokusil odeslat formulÃ¡Å™
  //   // POUZE pro kritickÃ¡ pole, ne pro vÅ¡echna pole formulÃ¡Å™e
  //   if (hasTriedToSubmit) {
  //     validateFormSilently();
  //   }
  // }, [hasTriedToSubmit, formData.polozky_objednavky?.length, formData.stav_workflow_kod, shouldLockPhase1Sections, shouldLockPhase2Sections, shouldLockPhase3Sections, shouldLockPhase4to6Sections]);

  // useEffect(() => {
  //   // Reset validaÄnÃ­ho stavu pÅ™i pÅ™echodu mezi fÃ¡zemi
  //   if (hasTriedToSubmit) {
  //     validateFormSilently();
  //   }
  // }, [currentPhase, hasTriedToSubmit, formData.stav_workflow_kod, formData.zpusob_financovani, formData.lp_kod, formData.cislo_smlouvy, formData.individualni_schvaleni, formData.pojistna_udalost_cislo, shouldLockPhase1Sections, shouldLockPhase2Sections, financovaniState.visible, financovaniState.enabled, shouldLockPhase3Sections, shouldLockPhase4to6Sections]);

  // ðŸ“Š KompaktnÃ­ debug logging pro workflow tracking
  const addDebugLog = (level, category, action, data) => {
    const styles = {
      workflow: 'background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;',
      autosave: 'background: #2196F3; color: white; padding: 2px 6px; border-radius: 3px;',
      db: 'background: #FF9800; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;',
      error: 'background: #f44336; color: white; padding: 2px 6px; border-radius: 3px;',
    };

    // Workflow stavy - VÅ½DY zobrazuj
    if (category === 'WORKFLOW' || category === 'DB-RESPONSE') {
    }
    // Autosave - pouze dÅ¯leÅ¾itÃ© udÃ¡losti
    else if (category === 'AUTOSAVE' && (action === 'saved' || action === 'triggered')) {
    }
    // DB response - strukturovanÃ½ vÃ½pis
    else if (category === 'DB' || category === 'SAVE') {
    }
    // Chyby - vÅ¾dy
    else if (level === 'error') {
    }
  };

  const clearDebugLogs = () => {}; // No-op

  // Funkce pro zÃ­skÃ¡nÃ­ jmÃ©na uÅ¾ivatele podle ID
  const getUserNameById = (userId) => {
    if (!userId) return '';

    // NejdÅ™Ã­ve hledej mezi vÅ¡emi uÅ¾ivateli
    let user = allUsers.find(u => (u.id || u.user_id) === parseInt(userId));

    // Pokud nenajdeÅ¡, hledej mezi schvalovateli
    if (!user) {
      user = approvers.find(u => (u.id || u.user_id) === parseInt(userId));
    }

    // Pokud je to aktuÃ¡lnÃ­ uÅ¾ivatel
    if (!user && parseInt(userId) === parseInt(user_id) && userDetail) {
      user = userDetail;
    }

    // Zkontroluj cache
    if (!user && userNamesCache[userId]) {
      return userNamesCache[userId];
    }

    if (user) {
      // SprÃ¡vnÃ© poÅ™adÃ­: Titul pÅ™ed + JmÃ©no + PÅ™Ã­jmenÃ­ + Titul za
      const titul_pred = user.titul_pred ? user.titul_pred + ' ' : '';
      const jmeno = user.jmeno || '';
      const prijmeni = user.prijmeni || '';
      const titul_za = user.titul_za ? ', ' + user.titul_za : '';

      return `${titul_pred}${jmeno} ${prijmeni}${titul_za}`.replace(/\s+/g, ' ').trim();
    }

    // Pokud uÅ¾ivatel nenÃ­ v cache, naÄti ho z DB asynchronnÄ›
    if (!userNamesCache[userId]) {
      getUserDetailApi2(username, token, userId)
        .then(userDetail => {
          if (userDetail) {
            const titul_pred = userDetail.titul_pred ? userDetail.titul_pred + ' ' : '';
            const jmeno = userDetail.jmeno || '';
            const prijmeni = userDetail.prijmeni || '';
            const titul_za = userDetail.titul_za ? ', ' + userDetail.titul_za : '';
            const fullName = `${titul_pred}${jmeno} ${prijmeni}${titul_za}`.replace(/\s+/g, ' ').trim();

            // UloÅ¾ do cache
            setUserNamesCache(prev => ({
              ...prev,
              [userId]: fullName
            }));
          } else {
            // UÅ¾ivatel neexistuje
            setUserNamesCache(prev => ({
              ...prev,
              [userId]: `UÅ¾ivatel ID ${userId}`
            }));
          }
        })
        .catch(error => {
          // Error loading user
          setUserNamesCache(prev => ({
            ...prev,
            [userId]: `UÅ¾ivatel ID ${userId}`
          }));
        });
    }

    // MezitÃ­m zobraz placeholder
    return 'NaÄÃ­tÃ¡m...';
  };

  // ðŸ†• Helper funkce pro validaci ev. ÄÃ­sla (Å˜EÅ ENÃ PROBLÃ‰MU #3)
  const isValidEvCislo = (ev_cislo) => {
    if (!ev_cislo) return false;
    if (ev_cislo === 'NaÄÃ­tÃ¡m...') return false;
    if (typeof ev_cislo === 'string' && ev_cislo.trim() === '') return false;
    return true;
  };

  // ðŸ“Š useEffect: NaÄÃ­st neaktivnÃ­ho garanta pokud nenÃ­ v allUsers (pÅ™i editaci)
  // allUsers nynÃ­ obsahuje JEN aktivnÃ­ uÅ¾ivatele (fetchActiveUsers)
  // Pokud editujeme objednÃ¡vku s neaktivnÃ­m garantem, musÃ­me jej explicitnÄ› naÄÃ­st
  useEffect(() => {
    const loadGarantOptions = async () => {
      // ðŸ” PoÄkej neÅ¾ se naÄtou ÄÃ­selnÃ­ky
      if (!areDictionariesReady || allUsers.length === 0) {
        return;
      }

      // 1. Filtruj AKTIVNÃ uÅ¾ivatele z allUsers
      const activeUsers = allUsers.filter(u => u.aktivni === 1 || u.aktivni === '1' || u.active === 1 || u.active === '1');

      // 2. Pokud NENÃ editace nebo nenÃ­ garant, pouÅ¾ij jen aktivnÃ­
      const currentOrderId = formData.id || (formData.id || savedOrderId);

      if (!formData.garant_uzivatel_id || !currentOrderId) {
        setGarantOptions(activeUsers);
        return;
      }

      // 3. EDITACE: Zkontroluj jestli je garant v aktivnÃ­ch
      const garantInActiveList = activeUsers.find(
        u => (u.id === formData.garant_uzivatel_id || u.user_id === formData.garant_uzivatel_id)
      );

      if (garantInActiveList) {
        setGarantOptions(activeUsers);
        return;
      }

      // 4. Garant NENÃ aktivnÃ­ â†’ zkontroluj jestli je v allUsers (neaktivnÃ­)
      const garantInAllUsers = allUsers.find(
        u => (u.id === formData.garant_uzivatel_id || u.user_id === formData.garant_uzivatel_id)
      );

      if (garantInAllUsers) {
        setGarantOptions([garantInAllUsers, ...activeUsers]);
        return;
      }

      // 5. Garant nenÃ­ ani v allUsers â†’ naÄti explicitnÄ› (starÃ½ user)

      if (!username || !token) {
        setGarantOptions(activeUsers);
        return;
      }

      try {
        const inactiveGarantDetail = await getUserDetailApi2(
          username,
          token,
          formData.garant_uzivatel_id
        );

        if (inactiveGarantDetail) {
          // Normalizuj formÃ¡t jako ostatnÃ­ users z allUsers
          const normalizedGarant = {
            id: inactiveGarantDetail.id || inactiveGarantDetail.uzivatel_id,
            user_id: inactiveGarantDetail.id || inactiveGarantDetail.uzivatel_id,
            username: inactiveGarantDetail.username || inactiveGarantDetail.login,
            jmeno: inactiveGarantDetail.jmeno || '',
            prijmeni: inactiveGarantDetail.prijmeni || '',
            titul_pred: inactiveGarantDetail.titul_pred || '',
            titul_za: inactiveGarantDetail.titul_za || '',
            email: inactiveGarantDetail.email || '',
            aktivni: 0 // OznaÄÃ­me jako neaktivnÃ­
          };

          // PÅ™idej neaktivnÃ­ho garanta na zaÄÃ¡tek seznamu
          setGarantOptions([normalizedGarant, ...activeUsers]);
        } else {
          setGarantOptions(activeUsers);
        }
      } catch (error) {
        setGarantOptions(activeUsers);
      }
    };

    loadGarantOptions();
  }, [formData.garant_uzivatel_id, formData.id, allUsers, (formData.id || savedOrderId), username, token, areDictionariesReady]);

  // ï¿½ðŸŽ¯ DEPRECATED: Tyto funkce byly nahrazeny FormDataManager
  // ðŸ’° ============================================
  // FAKTURY - Funkce pro sprÃ¡vu faktur k objednÃ¡vce
  // ============================================

  // NaÄtenÃ­ faktur z API
  // ðŸ’° FAKTURY jsou nynÃ­ souÄÃ¡stÃ­ formData.faktury (naÄtou se s objednÃ¡vkou z BE)

  // ðŸ”¥ FUNKCE: ZajistÃ­, Å¾e vÅ¾dy existuje alespoÅˆ jedna faktura ve fÃ¡zi 7+
  // VolÃ¡ se pÅ™Ã­mo pÅ™i renderovÃ¡nÃ­ sekce Faktury (ne v useEffect)
  const ensureFirstInvoiceExists = React.useCallback(() => {
    if (!(formData.id || savedOrderId) || currentPhase < 7 || fakturyLoading) {
      return;
    }

    // Pokud nejsou Å¾Ã¡dnÃ© faktury, vytvoÅ™ prvnÃ­
    if (!formData.faktury || formData.faktury.length === 0) {
      const dnesniDatum = formatDateForPicker(new Date());

      const novaFaktura = {
        id: `temp-${Date.now()}`, // Temporary ID
        objednavka_id: (formData.id || savedOrderId),
        fa_datum_doruceni: dnesniDatum,
        fa_dorucena: 1,
        fa_castka: '',
        fa_cislo_vema: '',
        fa_strediska_kod: formData.strediska_kod || [],
        fa_splatnost: '',
        fa_poznamka: '',
        vytvoril_uzivatel_id: user_id,
        vytvoril_jmeno: getUserNameById(user_id),
        dt_vytvoreni: new Date().toISOString(),
        dt_aktualizace: null,
        aktivni: 1,
        _isNew: true
      };

      updateFaktury([novaFaktura]);
    }
  }, [(formData.id || savedOrderId), currentPhase, fakturyLoading, formData.faktury, formData.strediska_kod, user_id]);

  // PÅ™idat novou fakturu
  const handleAddFaktura = async () => {
    if (!(formData.id || savedOrderId)) {
      showToast && showToast('Nelze pÅ™idat fakturu - objednÃ¡vka nenÃ­ uloÅ¾ena', { type: 'error' });
      return;
    }

    // Validace povinnÃ½ch polÃ­
    if (!fakturaFormData.fa_datum_doruceni || (typeof fakturaFormData.fa_datum_doruceni === 'string' && fakturaFormData.fa_datum_doruceni.trim() === '')) {
      showToast && showToast('Datum doruÄenÃ­ faktury je povinnÃ©', { type: 'error' });
      return;
    }

    if (!fakturaFormData.fa_castka || parseFloat(fakturaFormData.fa_castka) <= 0) {
      showToast && showToast('ÄŒÃ¡stka faktury je povinnÃ¡ a musÃ­ bÃ½t vÄ›tÅ¡Ã­ neÅ¾ 0', { type: 'error' });
      return;
    }

    if (!fakturaFormData.fa_cislo_vema || (typeof fakturaFormData.fa_cislo_vema === 'string' && fakturaFormData.fa_cislo_vema.trim() === '')) {
      showToast && showToast('VariabilnÃ­ symbol je povinnÃ½', { type: 'error' });
      return;
    }

    if (!fakturaFormData.fa_splatnost || (typeof fakturaFormData.fa_splatnost === 'string' && fakturaFormData.fa_splatnost.trim() === '')) {
      showToast && showToast('Datum splatnosti je povinnÃ©', { type: 'error' });
      return;
    }

    // ðŸŽ¯ POUZE LOKÃLNÃ AKTUALIZACE - faktury se uloÅ¾Ã­ s objednÃ¡vkou
    // ðŸ†• NEPOTÅ˜EBUJEME nastavovat fakturant_id ZDE - nastavÃ­ se automaticky pÅ™i uloÅ¾enÃ­ objednÃ¡vky

    // ðŸ§¹ VYÄŒISTIT fa_strediska_kod - zajistit Å¾e jsou JEN stringy
    const cleanedStrediska = Array.isArray(fakturaFormData.fa_strediska_kod)
      ? fakturaFormData.fa_strediska_kod.map(item => {
          if (typeof item === 'string') return item;
          return item.value || item.kod_stavu || item.id || item;
        })
      : [];

    // VytvoÅ™it novou fakturu s temp ID
    const newFaktura = {
      ...fakturaFormData,
      id: `temp-${Date.now()}`, // DoÄasnÃ© ID - BE pÅ™iÅ™adÃ­ sprÃ¡vnÃ© pÅ™i uloÅ¾enÃ­ objednÃ¡vky
      objednavka_id: (formData.id || savedOrderId),
      fa_strediska_kod: cleanedStrediska, // âœ… POUÅ½ÃT VYÄŒIÅ TÄšNÃ‰ STRINGY
      vytvoril_uzivatel_id: user_id,
      vytvoril_jmeno: getUserNameById(user_id),
      dt_vytvoreni: new Date().toISOString(),
      aktivni: 1,
      _isNew: false, // OznaÄit jako uloÅ¾enou (uloÅ¾Ã­ se s objednÃ¡vkou)
      // fa_dorucena je VÅ½DY 1 (boolean flag Å¾e faktura je doruÄenÃ¡)
      fa_dorucena: 1,
      // ðŸ”§ OPRAVA MAPOVÃNÃ DATUMOVÃCH POLÃ
      fa_datum_doruceni: fakturaFormData.fa_dorucena || new Date().toISOString().split('T')[0], // fa_dorucena obsahuje datum doruÄenÃ­!
      fa_datum_vystaveni: fakturaFormData.fa_datum_vystaveni || new Date().toISOString().split('T')[0], // PÅ™idat datum vystavenÃ­
      fa_datum_splatnosti: fakturaFormData.fa_splatnost || '', // fa_splatnost obsahuje datum splatnosti!
      // ðŸ“Ž PÅ˜ÃLOHY FAKTURY - uklÃ¡dajÃ­ se do konceptu stejnÄ› jako prilohy_dokumenty
      attachments: [], // Pole pÅ™Ã­loh faktury (formÃ¡t stejnÃ½ jako u objednÃ¡vek)
      // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost (FÃZE 7/8) - 1:1 s DB
      vecna_spravnost_umisteni_majetku: fakturaFormData.vecna_spravnost_umisteni_majetku || '',
      vecna_spravnost_poznamka: fakturaFormData.vecna_spravnost_poznamka || '',
      vecna_spravnost_potvrzeno: fakturaFormData.vecna_spravnost_potvrzeno || 0
    };

    // PÅ™idat do formData.faktury
    const currentFaktury = Array.isArray(formData.faktury) ? formData.faktury : [];
    updateFaktury([...currentFaktury, newFaktura]);

    // Reset formulÃ¡Å™e s auto-vyplnÄ›nÃ­m stÅ™edisek z objednÃ¡vky
    const dnesniDatum = formatDateForPicker(new Date());

    setFakturaFormData({
      fa_datum_doruceni: dnesniDatum,
      fa_dorucena: 1, // âœ… Boolean flag
      fa_castka: '', // ðŸ”¥ PrÃ¡zdnÃ© - uÅ¾ivatel vyplnÃ­ sÃ¡m
      fa_cislo_vema: '',
      fa_strediska_kod: formData.strediska_kod || [],
      fa_poznamka: '',
      fa_splatnost: '',
      // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
      vecna_spravnost_umisteni_majetku: '',
      vecna_spravnost_poznamka: '',
      vecna_spravnost_potvrzeno: 0
    });
    setEditingFaktura(null);
    setShowAddFakturaForm(false);

    showToast && showToast('Faktura pÅ™idÃ¡na - uloÅ¾Ã­ se s objednÃ¡vkou', { type: 'success' });

    // Spustit autosave po zmÄ›nÄ› faktur
    triggerAutosave(true);
  };

  const handleUpdateFaktura = async () => {
    if (!editingFaktura) return;

    // Validace
    if (!fakturaFormData.fa_datum_doruceni || (typeof fakturaFormData.fa_datum_doruceni === 'string' && fakturaFormData.fa_datum_doruceni.trim() === '')) {
      showToast && showToast('Datum doruÄenÃ­ faktury je povinnÃ©', { type: 'error' });
      return;
    }

    if (!fakturaFormData.fa_castka || parseFloat(fakturaFormData.fa_castka) <= 0) {
      console.groupEnd();
      showToast && showToast('ÄŒÃ¡stka faktury je povinnÃ¡ a musÃ­ bÃ½t vÄ›tÅ¡Ã­ neÅ¾ 0', { type: 'error' });
      return;
    }

    if (!fakturaFormData.fa_cislo_vema || (typeof fakturaFormData.fa_cislo_vema === 'string' && fakturaFormData.fa_cislo_vema.trim() === '')) {
      console.groupEnd();
      showToast && showToast('VariabilnÃ­ symbol je povinnÃ½', { type: 'error' });
      return;
    }

    if (!fakturaFormData.fa_splatnost || (typeof fakturaFormData.fa_splatnost === 'string' && fakturaFormData.fa_splatnost.trim() === '')) {
      console.groupEnd();
      showToast && showToast('Datum splatnosti je povinnÃ©', { type: 'error' });
      return;
    }

    try {
      // Zkontroluj Å¾e faktura mÃ¡ reÃ¡lnÃ© ID (ne temp-)
      const isRealInvoice = editingFaktura.id && !String(editingFaktura.id).startsWith('temp-');
      
      if (!isRealInvoice) {
        console.groupEnd();
        showToast && showToast('NejdÅ™Ã­v pÅ™idej pÅ™Ã­lohu, aby se faktura uloÅ¾ila do DB', { type: 'error' });
        return;
      }

      // ðŸ§¹ VYÄŒISTIT fa_strediska_kod - zajistit Å¾e jsou JEN stringy
      const cleanedStrediska = Array.isArray(fakturaFormData.fa_strediska_kod)
        ? fakturaFormData.fa_strediska_kod.map(item => {
            if (typeof item === 'string') return item;
            return item.value || item.kod_stavu || item.id || item;
          })
        : [];

      // PÅ™iprav data pro API update
      const updateData = {
        fa_cislo_vema: fakturaFormData.fa_cislo_vema,
        fa_datum_vystaveni: fakturaFormData.fa_datum_vystaveni || fakturaFormData.fa_datum_doruceni,
        fa_castka: fakturaFormData.fa_castka,
        fa_datum_splatnosti: fakturaFormData.fa_splatnost,
        fa_datum_doruceni: fakturaFormData.fa_datum_doruceni,
        fa_dorucena: 1,
        fa_strediska_kod: JSON.stringify(cleanedStrediska),
        fa_poznamka: fakturaFormData.fa_poznamka || null,
        rozsirujici_data: fakturaFormData.rozsirujici_data || null,
        // âœ… RESET: PÅ™i aktualizaci faktury se zruÅ¡Ã­ JEN checkbox (umÃ­stÄ›nÃ­ a poznÃ¡mka zÅ¯stÃ¡vajÃ­)
        vecna_spravnost_umisteni_majetku: fakturaFormData.vecna_spravnost_umisteni_majetku || '',
        vecna_spravnost_poznamka: fakturaFormData.vecna_spravnost_poznamka || '',
        vecna_spravnost_potvrzeno: 0,
        potvrdil_vecnou_spravnost_id: null,
        dt_potvrzeni_vecne_spravnosti: null
      };

      // Volej API update
      const response = await updateInvoiceV2({
        token,
        username,
        invoice_id: editingFaktura.id,
        updateData
      });

      // Aktualizovat fakturu v lokÃ¡lnÃ­m state
      const currentFaktury = Array.isArray(formData.faktury) ? formData.faktury : [];
      const updatedFaktury = currentFaktury.map(faktura =>
        faktura.id === editingFaktura.id
          ? {
              ...faktura,
              ...fakturaFormData,
              fa_strediska_kod: cleanedStrediska,
              dt_aktualizace: new Date().toISOString(),
              fa_dorucena: 1,
              fa_datum_doruceni: fakturaFormData.fa_datum_doruceni,
              fa_datum_vystaveni: fakturaFormData.fa_datum_vystaveni || fakturaFormData.fa_datum_doruceni,
              fa_datum_splatnosti: fakturaFormData.fa_splatnost
            }
          : faktura
      );

      updateFaktury(updatedFaktury);

      // Reset formulÃ¡Å™e
      const dnesniDatum = formatDateForPicker(new Date());
      setFakturaFormData({
        fa_datum_doruceni: dnesniDatum,
        fa_dorucena: 1,
        fa_castka: '',
        fa_cislo_vema: '',
        fa_strediska_kod: formData.strediska_kod || [],
        fa_poznamka: '',
        fa_splatnost: '',
        // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
        vecna_spravnost_umisteni_majetku: '',
        vecna_spravnost_poznamka: '',
        vecna_spravnost_potvrzeno: 0
      });
      setEditingFaktura(null);
      setShowAddFakturaForm(false);

      showToast && showToast('âœ… Faktura ÃºspÄ›Å¡nÄ› aktualizovÃ¡na', { type: 'success' });

    } catch (err) {
      console.group('âŒ CHYBA pÅ™i aktualizaci faktury');
      if (err.response) {
      }
      console.groupEnd();

      showToast && showToast(`Chyba pÅ™i aktualizaci faktury: ${err.message}`, { type: 'error' });
    }
  };

  // ðŸ†• Handler pro vyplnÄ›nÃ­ faktury z ISDOC souboru - NOVÃ ATOMICKÃ WORKFLOW
  const handleISDOCParsed = (isdocData, realFakturaId) => {
    const currentFaktury = Array.isArray(formData.faktury) ? formData.faktury : [];

    // âœ… KONTROLA: MÃ¡ se UPDATOVAT existujÃ­cÃ­ faktura?
    if (isdocData._updateExisting) {

      // UPDATOVAT existujÃ­cÃ­ fakturu novÃ½mi daty z ISDOC
      const updatedFaktury = currentFaktury.map(faktura => {
        if (Number(faktura.id) === Number(realFakturaId)) {
          const updated = {
            ...faktura,
            // âœ… PÅ˜EPSAT data z ISDOC
            fa_cislo_vema: isdocData.fa_cislo_vema || faktura.fa_cislo_vema,
            fa_datum_vystaveni: isdocData.fa_datum_vystaveni || faktura.fa_datum_vystaveni,
            fa_datum_zdanitelneho_plneni: isdocData.fa_datum_zdanitelneho_plneni || faktura.fa_datum_zdanitelneho_plneni,
            fa_datum_splatnosti: isdocData.fa_datum_splatnosti || faktura.fa_datum_splatnosti,
            fa_splatnost: isdocData.fa_datum_splatnosti || faktura.fa_splatnost,
            fa_datum_doruceni: isdocData.fa_datum_doruceni || faktura.fa_datum_doruceni,
            fa_castka: isdocData.fa_castka || faktura.fa_castka,
            fa_castka_bez_dph: isdocData.fa_castka_bez_dph || faktura.fa_castka_bez_dph,
            fa_dph: isdocData.fa_dph || faktura.fa_dph,
            fa_poznamka: isdocData.fa_poznamka || faktura.fa_poznamka,
            fa_strediska_kod: isdocData.fa_strediska_kod || faktura.fa_strediska_kod,
            fa_dorucena: 1,
            dt_aktualizace: new Date().toISOString(),
            _isdoc_parsed: true,
            _isdoc_polozky: isdocData._isdoc_polozky,
            _isdoc_dodavatel: isdocData._isdoc_dodavatel,
            _isdoc_email: isdocData._isdoc_email,
            _fromISDOC: true
          };

          return updated;
        }
        return faktura;
      });

      updateFaktury(updatedFaktury);

      // âœ… NAPLNIT HLAVNÃ POLE FORMDATA
      setFormData(prev => ({
        ...prev,
        cislo_faktury: isdocData.fa_cislo_vema || prev.cislo_faktury,
        datum_faktury: isdocData.fa_datum_vystaveni || prev.datum_faktury,
        datum_splatnosti: isdocData.fa_datum_splatnosti || prev.datum_splatnosti,
        castka_bez_dph: isdocData.fa_castka_bez_dph || prev.castka_bez_dph,
        castka_s_dph: isdocData.fa_castka || prev.castka_s_dph,
        _isdocRefresh: Date.now()
      }));

      // Toast odstranÄ›n - uÅ¾ivatel vidÃ­ vyplnÄ›nÃ¡ data v formulÃ¡Å™i
      setTimeout(() => triggerAutosave(true), 300);

      return; // âœ… KONEC - faktura byla updatovÃ¡na
    }

    // ðŸ†• VYTVOÅ˜ENÃ NOVÃ‰ FAKTURY (pÅ¯vodnÃ­ logika)
    // ðŸ†• VYTVOÅ˜ENÃ NOVÃ‰ FAKTURY (pÅ¯vodnÃ­ logika)

    // VytvoÅ™it novou fakturu s daty z ISDOC + reÃ¡lnÃ½m ID z BE
    const newFaktura = {
      id: realFakturaId, // âœ… REÃLNÃ‰ ID z BE
      objednavka_id: (formData.id || savedOrderId),
      // Data z ISDOC
      fa_cislo_vema: isdocData.fa_cislo_vema || '',
      fa_datum_vystaveni: isdocData.fa_datum_vystaveni || '',
      fa_datum_zdanitelneho_plneni: isdocData.fa_datum_zdanitelneho_plneni || '',
      fa_datum_splatnosti: isdocData.fa_datum_splatnosti || '',
      fa_splatnost: isdocData.fa_datum_splatnosti || '',
      fa_datum_doruceni: isdocData.fa_datum_doruceni || getCurrentDateFormatted(),
      fa_castka: isdocData.fa_castka || '',
      fa_castka_bez_dph: isdocData.fa_castka_bez_dph || '',
      fa_dph: isdocData.fa_dph || '',
      fa_poznamka: isdocData.fa_poznamka || '',
      fa_strediska_kod: isdocData.fa_strediska_kod || (Array.isArray(formData.strediska_kod) ? formData.strediska_kod : []),
      fa_dorucena: 1,
      // Metadata
      vytvoril_uzivatel_id: user_id,
      vytvoril_jmeno: getUserNameById(user_id),
      dt_vytvoreni: new Date().toISOString(),
      dt_aktualizace: null,
      aktivni: 1,
      _isdoc_parsed: true,
      _isdoc_polozky: isdocData._isdoc_polozky,
      _isdoc_dodavatel: isdocData._isdoc_dodavatel,
      _fromISDOC: true, // Flag pro rozpoznÃ¡nÃ­ ISDOC faktury
      // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost (prÃ¡zdnÃ© pÅ™i ISDOC importu)
      vecna_spravnost_umisteni_majetku: '',
      vecna_spravnost_poznamka: '',
      vecna_spravnost_potvrzeno: 0
    };

    // ðŸ”§ KRITICKÃ OPRAVA: Najdi a odstraÅˆ vÅ¡echny temp faktury, pak pÅ™idej reÃ¡lnou
    const updatedFaktury = [
      ...currentFaktury.filter(f => !String(f.id).startsWith('temp-')), // Odstranit vÅ¡echny temp faktury
      newFaktura // PÅ™idat novou reÃ¡lnou fakturu
    ];

    updateFaktury(updatedFaktury);

    // âœ… Nastavit jako editovanou (aby se zobrazila)
    setEditingFaktura(newFaktura);
    setFakturaFormData(newFaktura);

    // âœ… NAPLNIT HLAVNÃ POLE FORMDATA DATA Z ISDOC
    setFormData(prev => ({
      ...prev,
      cislo_faktury: newFaktura.fa_cislo_vema || '',
      datum_faktury: newFaktura.fa_datum_vystaveni || '',
      datum_splatnosti: newFaktura.fa_datum_splatnosti || '',
      castka_bez_dph: newFaktura.fa_castka_bez_dph || '', // âœ… OPRAVENÃ KLÃÄŒ
      castka_s_dph: newFaktura.fa_castka || '',           // âœ… OPRAVENÃ KLÃÄŒ
      _isdocRefresh: Date.now()
    }));

    // Toast odstranÄ›n - uÅ¾ivatel vidÃ­ vyplnÄ›nÃ¡ data v formulÃ¡Å™i

    // Spustit autosave
    setTimeout(() => triggerAutosave(true), 300);
  };

  // Smazat fakturu - zobrazÃ­ confirm dialog
  const handleDeleteFaktura = async (fakturaId) => {
    // Najdi fakturu
    const faktura = formData.faktury?.find(f => f.id === fakturaId);
    if (!faktura) return;

    // Kontrola pÅ™Ã­loh - naÄti ze serveru pokud mÃ¡ reÃ¡lnÃ© ID
    let prilohyCount = 0;

    if (fakturaId && !String(fakturaId).startsWith('temp-')) {
      try {
        const response = await listInvoiceAttachments(
          fakturaId,  // invoiceId
          username,   // username
          token,      // token
          savedOrderId  // orderId
        );

        prilohyCount = (response.data?.attachments || response.data || []).length;
      } catch (err) {
      }
    }

    // Zobrazit confirm dialog
    setDeleteFacturaDialog({
      isOpen: true,
      fakturaId: fakturaId,
      fakturaNazev: faktura.fa_cislo_vema || `Faktura ${faktura.id}`,
      pocetPriloh: prilohyCount
    });
  };

  // PotvrzenÃ­ smazÃ¡nÃ­ faktury z dialogu
  const confirmDeleteFaktura = async () => {
    const { fakturaId, pocetPriloh } = deleteFacturaDialog;

    // ZavÅ™Ã­t dialog
    setDeleteFacturaDialog({ isOpen: false, fakturaId: null, fakturaNazev: '', pocetPriloh: 0 });

    if (!fakturaId) return;

    try {
      // Kontrola, zda je faktura uloÅ¾enÃ¡ v DB (reÃ¡lnÃ© ID, ne temp-xxx)
      const isRealInvoice = fakturaId && !String(fakturaId).startsWith('temp-');

      // 1. Pokud mÃ¡ pÅ™Ã­lohy, smaÅ¾ je ze serveru
      if (isRealInvoice && pocetPriloh > 0) {
        try {
          const response = await listInvoiceAttachments(
            fakturaId,  // invoiceId
            username,   // username
            token,      // token
            savedOrderId  // orderId
          );

          const prilohy = response.data?.attachments || response.data || [];

          // SmaÅ¾ kaÅ¾dou pÅ™Ã­lohu
          for (const priloha of prilohy) {
            try {
              await deleteInvoiceAttachment(
                fakturaId,    // invoiceId
                priloha.id,   // attachmentId
                username,     // username
                token         // token
              );
            } catch (err) {
              // TechnickÃ© detaily odstranÄ›ny - uÅ¾ivatel vidÃ­ jen lidskou zprÃ¡vu
              showToast && showToast('NepodaÅ™ilo se smazat pÅ™Ã­lohu faktury', { type: 'error' });
            }
          }

          // ðŸš« Toast odstranÄ›n - uÅ¾ivatel vidÃ­, Å¾e pÅ™Ã­lohy zmizely ze seznamu
          // if (prilohy.length > 0) {
          //   showToast && showToast(`SmazÃ¡no ${prilohy.length} pÅ™Ã­loh faktury`, { type: 'success' });
          // }
        } catch (err) {
          showToast && showToast('NepodaÅ™ilo se smazat pÅ™Ã­lohy faktury', { type: 'error' });
        }
      }

      // 2. Pokud je faktura uloÅ¾enÃ¡ v DB, smaÅ¾ ji ze serveru (hard delete - smaÅ¾e i soubory)
      if (isRealInvoice) {
        try {
          // âœ… V2 API: deleteInvoiceV2(invoiceId, token, username, hardDelete=true)
          await deleteInvoiceV2(fakturaId, token, username, true);
          showToast && showToast('âœ… Faktura i pÅ™Ã­lohy byly trvale smazÃ¡ny', { type: 'success' });
        } catch (err) {
          showToast && showToast('NepodaÅ™ilo se smazat fakturu', { type: 'error' });
          // PokraÄuj i pÅ™i chybÄ› - odeber fakturu alespoÅˆ lokÃ¡lnÄ›
        }
      }

      // 3. LOKÃLNÃ ODEBRÃNÃ - odstranit fakturu ze seznamu
      const currentFaktury = Array.isArray(formData.faktury) ? formData.faktury : [];
      const updatedFaktury = currentFaktury.filter(f => f.id !== fakturaId);
      updateFaktury(updatedFaktury);

      // ðŸš« Toast odstranÄ›n - autosave v pozadÃ­, faktura zmizela ze seznamu
      // if (!isRealInvoice) {
      //   showToast && showToast('Faktura odebrÃ¡na - zmÄ›na se uloÅ¾Ã­ s objednÃ¡vkou', { type: 'success' });
      // }

      // Spustit autosave po smazÃ¡nÃ­ faktury
      triggerAutosave(true);

    } catch (err) {
      showToast && showToast('NepodaÅ™ilo se smazat fakturu', { type: 'error' });
    }
  };

  // ZaÄÃ­t editovat fakturu
  const handleEditFaktura = (faktura) => {
    setEditingFaktura(faktura);

    // ðŸ”§ PARSOVÃNÃ stÅ™edisek: DB JSON string kÃ³dÅ¯ â†’ FE objekty s nÃ¡zvy
    let strediskaArray = [];
    if (faktura.fa_strediska_kod) {
      if (Array.isArray(faktura.fa_strediska_kod)) {
        strediskaArray = faktura.fa_strediska_kod; // UÅ¾ je pole objektÅ¯
      } else if (typeof faktura.fa_strediska_kod === 'string') {
        try {
          // Parsuj JSON: ["KLADNO","BENESOV"] nebo [{kod_stavu, nazev_stavu}]
          const parsed = JSON.parse(faktura.fa_strediska_kod) || [];
          // Transformuj kÃ³dy na objekty s nÃ¡zvy
          strediskaArray = parsed.map(item => {
            if (typeof item === 'object' && item.kod_stavu) {
              return item; // UÅ¾ je objekt
            }
            // Je to jen kÃ³d â†’ najÃ­t v options
            const stredisko = strediskaOptions.find(opt =>
              opt.kod_stavu === item || opt.kod === item || opt.value === item
            );
            return stredisko ? {
              kod_stavu: stredisko.kod_stavu || stredisko.kod || stredisko.value,
              nazev_stavu: stredisko.nazev_stavu || stredisko.nazev || stredisko.label
            } : { kod_stavu: item, nazev_stavu: item };
          });
        } catch (e) {
          // Fallback pro starÃ½ formÃ¡t (comma-separated stringy)
          strediskaArray = faktura.fa_strediska_kod.split(',').map(s => s.trim()).filter(Boolean);
        }
      }
    }

    // Pro novÃ© faktury nebo faktury bez data doruÄenÃ­ nastavit dneÅ¡nÃ­ datum
    const dnesniDatum = formatDateForPicker(new Date());

    setFakturaFormData({
      fa_datum_doruceni: faktura.fa_datum_doruceni || dnesniDatum,
      fa_dorucena: faktura.fa_dorucena || 1, // âœ… Boolean flag
      fa_castka: faktura.fa_castka || '', // ðŸ”¥ Neauto-vyplÅˆovat pÅ™i editaci
      fa_cislo_vema: faktura.fa_cislo_vema || '',
      fa_strediska_kod: strediskaArray,
      fa_poznamka: faktura.fa_poznamka || '',
      fa_splatnost: faktura.fa_splatnost || (faktura.fa_datum_splatnosti ? faktura.fa_datum_splatnosti.split(' ')[0] : ''), // âœ… DB -> FE: fa_datum_splatnosti -> fa_splatnost
      // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
      vecna_spravnost_umisteni_majetku: faktura.vecna_spravnost_umisteni_majetku || '',
      vecna_spravnost_poznamka: faktura.vecna_spravnost_poznamka || '',
      vecna_spravnost_potvrzeno: faktura.vecna_spravnost_potvrzeno || 0
    });
    setShowAddFakturaForm(true);
  };

  // ZruÅ¡it pÅ™idÃ¡nÃ­/editaci faktury
  const handleCancelFakturaForm = () => {
    const dnesniDatum = formatDateForPicker(new Date());

    setFakturaFormData({
      fa_datum_doruceni: dnesniDatum,
      fa_dorucena: 1, // âœ… Boolean flag
      fa_castka: '', // ðŸ”¥ PrÃ¡zdnÃ© - uÅ¾ivatel vyplnÃ­ sÃ¡m
      fa_cislo_vema: '',
      fa_strediska_kod: formData.strediska_kod || [],
      fa_poznamka: '',
      fa_splatnost: '',
      // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
      vecna_spravnost_umisteni_majetku: '',
      vecna_spravnost_poznamka: '',
      vecna_spravnost_potvrzeno: 0
    });
    setEditingFaktura(null);
    setShowAddFakturaForm(false);
  };

  // ========================================
  // PÅ˜ÃLOHY FAKTUR - SprÃ¡va podle vzoru pÅ™Ã­loh objednÃ¡vek
  // ========================================

  /**
   * Validace faktury pro pÅ™idÃ¡nÃ­ pÅ™Ã­loh
   * @param {Object} faktura - Objekt faktury
   * @param {File} file - NahrÃ¡vanÃ½ soubor (volitelnÃ½, pro detekci ISDOC)
   * @returns {Object} { isValid: boolean, valid: boolean, isISDOC: boolean, missingFields: string[], message: string }
   * 
   * Pravidla:
   * - ISDOC soubory lze nahrÃ¡t KDYKOLIV (i bez vyplnÄ›nÃ½ch polÃ­) - automatickÃ© vytÄ›Å¾enÃ­ hodnot
   * - BÄ›Å¾nÃ© soubory vyÅ¾adujÃ­ vyplnÄ›nÃ¡ povinnÃ¡ pole (fa_cislo_vema, fa_castka, fa_datum_doruceni, fa_splatnost)
   */
  const validateInvoiceForAttachments = useCallback((faktura, file = null) => {
    const missingFields = [];
    
    // Kontrola povinnÃ½ch polÃ­
    if (!faktura.fa_cislo_vema || (typeof faktura.fa_cislo_vema === 'string' && faktura.fa_cislo_vema.trim() === '')) {
      missingFields.push('ÄŒÃ­slo faktury VEMA');
    }
    
    if (!faktura.fa_castka || parseFloat(faktura.fa_castka) <= 0) {
      missingFields.push('ÄŒÃ¡stka');
    }
    
    if (!faktura.fa_datum_doruceni || (typeof faktura.fa_datum_doruceni === 'string' && faktura.fa_datum_doruceni.trim() === '')) {
      missingFields.push('Datum doruÄenÃ­');
    }
    
    if (!faktura.fa_splatnost || (typeof faktura.fa_splatnost === 'string' && faktura.fa_splatnost.trim() === '')) {
      missingFields.push('Datum splatnosti');
    }
    
    // Detekce ISDOC souboru
    const isISDOC = file && (
      file.name?.toLowerCase().endsWith('.isdoc') ||
      file.name?.toLowerCase().endsWith('.isdocx') ||
      file.type === 'text/isdoc'
    );

    // âœ… ISDOC soubory - vÅ¾dy povolit (moÅ¾nost vytÄ›Å¾enÃ­ hodnot)
    if (isISDOC) {
      return {
        isValid: true,          // VÅ¾dy TRUE pro ISDOC
        valid: true,
        isISDOC: true,
        missingFields: missingFields, // InformativnÄ› (pro pÅ™Ã­padnÃ© automatickÃ© doplnÄ›nÃ­)
        message: missingFields.length > 0 
          ? 'ISDOC soubor - data lze automaticky vytÄ›Å¾it po nahrÃ¡nÃ­' 
          : 'ISDOC soubor pÅ™ipraven k nahrÃ¡nÃ­'
      };
    }

    // âš ï¸ BÄ›Å¾nÃ© soubory - vyÅ¾adovat vyplnÄ›nÃ¡ pole
    if (missingFields.length > 0) {
      return {
        isValid: false,         // FALSE - blokovat nahrÃ¡vÃ¡nÃ­
        valid: false,
        isISDOC: false,
        missingFields: missingFields,
        message: `Pro nahrÃ¡nÃ­ pÅ™Ã­lohy vyplÅˆte nejprve: ${missingFields.join(', ')}`
      };
    }
    
    // âœ… VÅ¡echna pole vyplnÄ›na - povolit nahrÃ¡vÃ¡nÃ­
    return {
      isValid: true,
      valid: true,
      isISDOC: false,
      missingFields: [],
      message: 'PÅ™ipraven k nahrÃ¡nÃ­'
    };
  }, []);

  /**
   * Handler pro zmÄ›nu pÅ™Ã­loh faktury
   * VolÃ¡ se z InvoiceAttachmentsCompact komponenty
   * @param {string} fakturaId - ID faktury (temp-xxx nebo reÃ¡lnÃ©)
   * @param {Array} newAttachments - NovÃ© pole pÅ™Ã­loh
   */
  const handleInvoiceAttachmentsChange = useCallback((fakturaId, newAttachments) => {
    // âœ… OPRAVA: Pokud attachments majÃ­ faktura_id, pouÅ¾ij to jako skuteÄnÃ© ID
    let realFakturaId = fakturaId;
    if (newAttachments.length > 0 && newAttachments[0].faktura_id) {
      realFakturaId = newAttachments[0].faktura_id;
    }

    // ðŸ†• DETEKCE POKLADNÃHO DOKLADU podle klasifikace pÅ™Ã­loh
    const hasPokladniDoklad = newAttachments.some(att => {
      const klasifikace = att.klasifikace || att.typ_prilohy || '';
      return klasifikace.toLowerCase().includes('pokladn') ||
             klasifikace.toLowerCase().includes('paragon');
    });

    // âœ… FUNKÄŒNÃ UPDATE - pouÅ¾ij aktuÃ¡lnÃ­ state, ne closure
    setFormData(prev => {
      const updatedFaktury = (prev.faktury || []).map(f => {
        // Porovnej jak pÅ¯vodnÃ­ ID, tak reÃ¡lnÃ© ID
        if (f.id === fakturaId || f.id === realFakturaId || String(f.id) === String(realFakturaId)) {
          return {
            ...f,
            attachments: newAttachments,
            _isPokladna: hasPokladniDoklad // ðŸ†• Nastavit pÅ™Ã­znak podle klasifikace
          };
        }
        return f;
      });

      return { ...prev, faktury: updatedFaktury };
    });

    // Spustit autosave (pÅ™Ã­lohy se uloÅ¾Ã­ do konceptu)
    triggerAutosave(true);
  }, []);

  /**
   * ðŸ†• Handler pro vytvoÅ™enÃ­ faktury v DB (z temp ID na reÃ¡lnÃ© ID)
   * VolÃ¡ se z InvoiceAttachmentsCompact pÅ™i pokusu o upload pÅ™Ã­lohy s temp ID
   * @param {string} tempFakturaId - Temp ID faktury (temp-xxx)
   * @returns {Promise<number>} - ReÃ¡lnÃ© ID faktury z DB
   */
  const handleCreateInvoiceInDB = useCallback(async (tempFakturaId) => {
    try {
      // Najdi fakturu podle temp ID
      const faktura = formData.faktury?.find(f => f.id === tempFakturaId);
      if (!faktura) {
        throw new Error(`Faktura s ID ${tempFakturaId} nebyla nalezena`);
      }

      // Validace povinnÃ½ch polÃ­
      if (!faktura.fa_cislo_vema) {
        throw new Error('VyplÅˆte ÄÃ­slo faktury');
      }
      if (!faktura.fa_datum_doruceni) {
        throw new Error('VyplÅˆte datum doruÄenÃ­');
      }
      if (!faktura.fa_castka) {
        throw new Error('VyplÅˆte ÄÃ¡stku faktury');
      }
      if (!faktura.fa_strediska_kod || faktura.fa_strediska_kod.length === 0) {
        throw new Error('Vyberte alespoÅˆ jedno stÅ™edisko');
      }

      // Zkontroluj Å¾e objednÃ¡vka je uloÅ¾enÃ¡
      const orderId = formData.id || savedOrderId;
      if (!orderId) {
        throw new Error('NejdÅ™Ã­v uloÅ¾te objednÃ¡vku');
      }

      // PÅ™iprav stÅ™ediska - extrahuj jen kÃ³dy z objektÅ¯
      let strediskaKody = [];
      if (faktura.fa_strediska_kod && Array.isArray(faktura.fa_strediska_kod)) {
        strediskaKody = faktura.fa_strediska_kod.map(item => {
          if (typeof item === 'object' && item.kod_stavu) {
            return item.kod_stavu; // Objekt â†’ extrahuj kod_stavu
          }
          return item; // UÅ¾ je string â†’ pouÅ¾ij pÅ™Ã­mo
        });
      }

      // ðŸ” DEBUG: Payload pÅ™ed odeslÃ¡nÃ­m
      const invoicePayload = {
        token,
        username,
        order_id: orderId,
        fa_cislo_vema: faktura.fa_cislo_vema,
        fa_datum_vystaveni: faktura.fa_datum_doruceni,
        fa_castka: faktura.fa_castka,
        fa_datum_splatnosti: faktura.fa_splatnost || null,
        fa_datum_doruceni: faktura.fa_datum_doruceni,
        fa_dorucena: faktura.fa_dorucena || 1,
        fa_strediska_kod: JSON.stringify(strediskaKody),
        fa_poznamka: faktura.fa_poznamka || null,
        rozsirujici_data: faktura.rozsirujici_data || null
      };

      // VytvoÅ™ fakturu v DB pomocÃ­ createInvoiceV2
      const response = await createInvoiceV2(invoicePayload);

      const realFakturaId = response.data?.invoice_id || response.invoice_id;
      if (!realFakturaId) {
        throw new Error('Backend nevrÃ¡til ID faktury');
      }

      // Aktualizuj fakturu v state (temp ID â†’ reÃ¡lnÃ© ID)
      setFormData(prev => {
        const updatedFaktury = (prev.faktury || []).map(f =>
          f.id === tempFakturaId
            ? {
                ...f,
                id: realFakturaId,
                _isNew: false // UÅ¾ nenÃ­ novÃ¡, je v DB
              }
            : f
        );
        return { ...prev, faktury: updatedFaktury };
      });

      return realFakturaId;

    } catch (err) {
      console.group('âŒ CHYBA pÅ™i vytvÃ¡Å™enÃ­ faktury v DB');
      if (err.response) {
      }
      console.groupEnd();
      throw err;
    }
  }, [formData, savedOrderId, token, username]);

  /**
   * Handler po ÃºspÄ›Å¡nÃ©m uploadu pÅ™Ã­lohy faktury
   * Pokud mÃ¡ faktura temp ID, vytvoÅ™Ã­ fakturu v DB a zÃ­skÃ¡ reÃ¡lnÃ© ID
   * @param {string} fakturaId - ID faktury
   * @param {object} uploadedAttachment - NahranÃ¡ pÅ™Ã­loha
   */
  const handleInvoiceAttachmentUploaded = useCallback(async (fakturaId, uploadedAttachment) => {
    // Pokud je ID temp, musÃ­me vytvoÅ™it fakturu v DB
    if (String(fakturaId).startsWith('temp-')) {
      // Faktura se vytvoÅ™Ã­ v DB pÅ™i pÅ™Ã­Å¡tÃ­m uloÅ¾enÃ­ objednÃ¡vky (saveOrderToAPI)
      // Po uloÅ¾enÃ­ dostane reÃ¡lnÃ© ID a pÅ™Ã­lohy se automaticky propojÃ­
    }

    // Spustit autosave
    triggerAutosave(true);
  }, []);

  // ========================================
  // KONEC PÅ˜ÃLOHY FAKTUR
  // ========================================

  // AutomatickÃ© vytvoÅ™enÃ­ prvnÃ­ faktury (pokud nenÃ­ pokladnÃ­ objednÃ¡vka)
  const ensureMinimalFaktura = () => {
    // Pouze pokud je objednÃ¡vka uloÅ¾enÃ¡ a nenÃ­ pokladnÃ­
    if (!(formData.id || savedOrderId)) return;

    // Zkontroluj, zda nenÃ­ pokladnÃ­ objednÃ¡vka (kontrola dodavatele atd.)
    // TODO: Doplnit kontrolu podle logiky dodavatele/pokladny

    if ((formData.faktury?.length || 0) === 0 && !showAddFakturaForm) {
      const dnesniDatum = formatDateForPicker(new Date());

      // Automaticky otevÅ™i formulÃ¡Å™ s pÅ™edvyplnÄ›nÃ½mi stÅ™edisky
      setFakturaFormData({
        fa_datum_doruceni: dnesniDatum, // âœ… SprÃ¡vnÃ© pole pro datum
        fa_dorucena: 1, // âœ… Boolean flag
        fa_castka: '', // ðŸ”¥ PrÃ¡zdnÃ© - uÅ¾ivatel vyplnÃ­ sÃ¡m
        fa_cislo_vema: '',
        fa_strediska_kod: formData.strediska_kod || [],
        fa_poznamka: '',
        fa_splatnost: '',
        // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
        vecna_spravnost_umisteni_majetku: '',
        vecna_spravnost_poznamka: '',
        vecna_spravnost_potvrzeno: 0
      });
      setShowAddFakturaForm(true);
    }
  };

  // ðŸ”¥ ZRUÅ ENO: AutomatickÃ¡ reinicializace ÄÃ¡stky faktury pÅ™i zmÄ›nÄ› cen
  // UÅ¾ivatel vyplnÃ­ ÄÃ¡stku ruÄnÄ›
  // useEffect(() => {
  //   if (totalPrice > 0 &&
  //       (!fakturaFormData.fa_castka || fakturaFormData.fa_castka === '')) {
  //     const predpokladanaCastka = totalPrice.toString();

  // ðŸ†• AUTOMATICKÃ‰ VYTVOÅ˜ENÃ PRVNÃ FAKTURY pÅ™i zobrazenÃ­ sekce Fakturace
  useEffect(() => {
    // Pouze pokud:
    // 1. ObjednÃ¡vka je uloÅ¾enÃ¡ ((formData.id || savedOrderId))
    // 2. Pole faktur je prÃ¡zdnÃ©
    // 3. Sekce nenÃ­ zamÄenÃ¡
    // 4. Jsme ve fÃ¡zi 7+ (UVEREJNENA - zobrazuje se Fakturace)
    const faktury = formData.faktury || [];

    if ((formData.id || savedOrderId) &&
        faktury.length === 0 &&
        !shouldLockFaktury &&
        currentPhase >= 7) {

      const dnesniDatum = formatDateForPicker(new Date());
      const user_id = parseInt(localStorage.getItem('user_id'), 10);

      const firstFaktura = {
        id: `temp-${Date.now()}`,
        objednavka_id: (formData.id || savedOrderId),
        fa_datum_doruceni: dnesniDatum,
        fa_dorucena: 1,
        fa_castka: '',
        fa_cislo_vema: '',
        fa_strediska_kod: Array.isArray(formData.strediska_kod) ? formData.strediska_kod : [],
        fa_poznamka: '',
        fa_splatnost: '',
        vytvoril_uzivatel_id: user_id,
        vytvoril_jmeno: getUserNameById(user_id),
        dt_vytvoreni: new Date().toISOString(),
        dt_aktualizace: null,
        aktivni: 1,
        _isNew: true,
        // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
        vecna_spravnost_umisteni_majetku: '',
        vecna_spravnost_poznamka: '',
        vecna_spravnost_potvrzeno: 0
      };

      // PÅ™idat prvnÃ­ fakturu do state
      updateFaktury([firstFaktura]);
      setEditingFaktura(firstFaktura);
      setFakturaFormData({
        fa_datum_doruceni: dnesniDatum,
        fa_dorucena: 1,
        fa_castka: '',
        fa_cislo_vema: '',
        fa_strediska_kod: formData.strediska_kod || [],
        fa_poznamka: '',
        fa_splatnost: '',
        // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
        vecna_spravnost_umisteni_majetku: '',
        vecna_spravnost_poznamka: '',
        vecna_spravnost_potvrzeno: 0
      });
    }
  }, [(formData.id || savedOrderId), formData.faktury?.length, shouldLockFaktury, currentPhase]);
  //     const dnesniDatum = formatDateForPicker(new Date());
  //
  //     setFakturaFormData(prev => ({
  //       ...prev,
  //       fa_datum_doruceni: prev.fa_datum_doruceni || dnesniDatum,
  //       fa_dorucena: prev.fa_dorucena || 1,
  //       fa_castka: predpokladanaCastka
  //     }));
  //   }
  // }, [totalPrice]);

  // ðŸ—‘ï¸ REMOVED: loadStrediska() - DEPRECATED
  // ÄŒÃ­selnÃ­ky se nynÃ­ naÄÃ­tajÃ­ pÅ™es useFormController â†’ useDictionaries.loadAll()

  // ðŸ—‘ï¸ REMOVED: loadPrilohyTypy() - DEPRECATED
  // ÄŒÃ­selnÃ­ky se nynÃ­ naÄÃ­tajÃ­ pÅ™es useFormController â†’ useDictionaries.loadAll()

  // ðŸ—‘ï¸ REMOVED: loadDruhyObjednavky() - DEPRECATED
  // ÄŒÃ­selnÃ­ky se nynÃ­ naÄÃ­tajÃ­ pÅ™es useFormController â†’ useDictionaries.loadAll()

  // ðŸ—‘ï¸ REMOVED: loadFinancovani() - DEPRECATED
  // ÄŒÃ­selnÃ­ky se nynÃ­ naÄÃ­tajÃ­ pÅ™es useFormController â†’ useDictionaries.loadAll()

  // ðŸ—‘ï¸ REMOVED: loadLpKody() - DEPRECATED
  // ÄŒÃ­selnÃ­ky se nynÃ­ naÄÃ­tajÃ­ pÅ™es useFormController â†’ useDictionaries.loadAll()

  const loadNextOrderNumber = async () => {
    // ðŸ”’ KRITICKÃ‰: Next-number jen pro NOVÃ‰ objednÃ¡vky!
    // Po uloÅ¾enÃ­ do DB â†’ pouÅ¾Ã­vat ev_cislo z DB

    // 1ï¸âƒ£ Zkontrolovat formData.id (uloÅ¾eno v DB)
    if (formData.id) {
      return false;
    }

    // 2ï¸âƒ£ Zkontrolovat metadata
    const metadata = draftManager.getMetadata();
    const isInEditMode = isEditMode || metadata?.isEditMode === true;

    if (isInEditMode) {
      return false;
    }

    // 3ï¸âƒ£ Pokud mÃ¡me ev_cislo (ne "NaÄÃ­tÃ¡m..."), skipnout
    if (formData.ev_cislo && formData.ev_cislo !== 'NaÄÃ­tÃ¡m...') {
      return false;
    }

    // 4ï¸âƒ£ Zkontrolovat URL parametry
    const urlParams = new URLSearchParams(window.location.search);
    const editOrderId = urlParams.get('edit');
    if (editOrderId) {
      return false;
    }

    // ðŸ†• Å˜EÅ ENÃ PROBLÃ‰MU #1: Aktivuj loading state
    setIsLoadingEvCislo(true);

    try {
      // ðŸ†• Å˜EÅ ENÃ PROBLÃ‰MU #2: V2 API s retry mechanismem (bude pÅ™idÃ¡n do apiOrderV2.js)
      const orderNumberData = await getNextOrderNumberV2(token, username);
      const nextNumber = orderNumberData.next_order_string || orderNumberData.order_number_string || orderNumberData.next_number;

      if (!nextNumber) {
        throw new Error(`API nevrÃ¡tilo next_order_string`);
      }

      // ðŸ”’ DOUBLE CHECK pÅ™ed nastavenÃ­m
      if (formData.id || isEditMode || metadata?.isEditMode === true || editOrderId) {
        return false;
      }

      setFormData(prev => ({
        ...prev,
        ev_cislo: nextNumber
      }));

      return true;
    } catch (error) {

      // ðŸ†• Å˜EÅ ENÃ PROBLÃ‰MU #1: Fallback na null mÃ­sto "NaÄÃ­tÃ¡m..."
      setFormData(prev => ({
        ...prev,
        ev_cislo: null
      }));

      // ðŸ†• Zobraz uÅ¾ivateli error toast
      showToast?.('NepodaÅ™ilo se naÄÃ­st evidenÄnÃ­ ÄÃ­slo. Zkuste obnovit strÃ¡nku.', 'error');

      return false;
    } finally {
      // ðŸ†• Å˜EÅ ENÃ PROBLÃ‰MU #1: VÅ¾dy vypni loading state
      setIsLoadingEvCislo(false);
    }
  };

  // Funkce pro prÃ¡ci s koncepty - ORDER25 SYSTEM
  const getOrder25DraftKey = () => `order25_draft_new_${user_id}`;

  // ðŸŽ¯ UloÅ¾enÃ­ stavu sekcÃ­ pÅ™es DraftManager
  const saveSectionStates = (states) => {
    if (!user_id) return;
    try {
      draftManager.saveUIState({ sectionState: states });
    } catch (error) {
      // Error saving section states
    }
  };

  // ðŸŽ¯ NaÄtenÃ­ stavu sekcÃ­ pÅ™es DraftManager
  const loadSectionStates = () => {
    if (!user_id) return null;
    try {
      const uiState = draftManager.getUIState();
      return uiState?.sectionState || null;
    } catch (error) {
      // Error loading section states
      return null;
    }
  };

  // ðŸŽ¯ UloÅ¾enÃ­ pozice scrollu pÅ™es DraftManager

  // ðŸŽ¯ NaÄtenÃ­ pozice scrollu pÅ™es DraftManager
  const loadScrollPosition = () => {
    if (!user_id) return;

    try {
      const uiState = draftManager.getUIState();
      const scrollPos = uiState?.scrollPosition;
      const scrollElementSelector = uiState?.scrollElementSelector || 'main';

      if (scrollPos !== undefined && scrollPos !== null) {
        if (!isNaN(scrollPos) && scrollPos > 0) {
          // Delay pro zajiÅ¡tÄ›nÃ­, Å¾e je obsah naÄten
          setTimeout(() => {
            const targetElement = document.querySelector(scrollElementSelector);

            if (targetElement) {
              targetElement.scrollTop = scrollPos;

              // Pokud scrollTop zÅ¯stal 0, zkus scroll pÅ™es window
              if (targetElement.scrollTop === 0 && scrollPos > 0) {
                window.scrollTo({
                  top: scrollPos,
                  left: 0,
                  behavior: 'instant'
                });

                // Pokud ani window nefunguje, zkus najÃ­t prvnÃ­ scrollovatelnÃ½ child
                const scrollableChild = Array.from(targetElement.querySelectorAll('*')).find(el => {
                  const style = window.getComputedStyle(el);
                  return style.overflowY === 'auto' || style.overflowY === 'scroll';
                });

                if (scrollableChild) {
                  scrollableChild.scrollTop = scrollPos;
                }
              }
            } else {
              window.scrollTo({
                top: scrollPos,
                left: 0,
                behavior: 'instant'
              });
            }

            addDebugLog('success', 'UI', 'scroll-restore', `Obnovena pozice scrollu: ${scrollPos}px`);
          }, 500);
        }
      }
    } catch (error) {
      // Error loading scroll position
    }
  };

  // Progress indikÃ¡tor a pÅ™esmÄ›rovÃ¡nÃ­ po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
  // ðŸ”’ skipUnlock: Pro ADMIN/SUPERADMIN nezamykÃ¡me - zÅ¯stÃ¡vajÃ­ editovat
  const startSaveProgressAndRedirect = (orderNumber, orderId, skipUnlock = false) => {
    // ðŸŽ¯ Spustit progress pÅ™es DraftManager (automaticky zakÃ¡Å¾e autosave)
    setShowSaveProgress(true);
    setSaveProgress(0);
    setSaveProgressText('UklÃ¡dÃ¡m objednÃ¡vku...');

    // Odemkni objednÃ¡vku na pozadÃ­ (POKUD NENÃ skipUnlock)
    (async () => {
      const unlockOrderId = sourceOrderIdForUnlock || orderId;
      if (unlockOrderId && token && username && !skipUnlock) {
        try {
          await unlockOrder25({ token, username, orderId: unlockOrderId });
        } catch (error) {
          // Ignoruj chybu odemykÃ¡nÃ­
        }
      }
      setIsChanged(false);
    })();

    // ðŸš€ Spustit progress pÅ™es DraftManager
    const progressControl = draftManager.startProgress({
      duration: 1000, // âš¡ ZkrÃ¡ceno z 3000ms na 1000ms (2 sekundy kratÅ¡Ã­)
      onProgress: (percent) => {
        setSaveProgress(percent);
      },
      onComplete: () => {
        // ðŸŽ¯ UloÅ¾it highlightOrderId pÅ™es DraftManager
        if (orderNumber && user_id) {
          draftManager.saveUIState({ highlightOrderId: orderNumber });
        }

        // ðŸ”¥ OPRAVENÃ‰ POÅ˜ADÃ PRO BÄšÅ½NÃ‰ UÅ½IVATELE:
        // 1. Nejprve pÅ™epnout na seznam objednÃ¡vek
        navigate('/orders25-list', { replace: true });

        // 2. Pak zruÅ¡it status editace (tlaÄÃ­tko se zmÄ›nÃ­ z "Editace" na "NovÃ¡")
        setIsEditMode(false);

        // 3. Broadcast zmÄ›nu do MenuBaru (tlaÄÃ­tko "NovÃ¡ objednÃ¡vka")
        window.dispatchEvent(new CustomEvent('orderDraftChange', {
          detail: {
            hasDraft: false,
            isEditMode: false,
            orderId: null,
            orderNumber: '',
            isLoading: false
          }
        }));

        // 4. Nakonec skrÃ½t progress a ukonÄit uklÃ¡dÃ¡nÃ­
        setShowSaveProgress(false);
        setIsSaving(false);
      }
    });

    // UloÅ¾it control pro moÅ¾nÃ© zruÅ¡enÃ­
    // (mÅ¯Å¾eme pouÅ¾Ã­t napÅ™. pÅ™i zavÃ­rÃ¡nÃ­ formulÃ¡Å™e)
    window._activeProgressControl = progressControl;
  };

  // PomocnÃ¡ funkce pro odesÃ­lÃ¡nÃ­ notifikacÃ­ pÅ™i zmÄ›nÃ¡ch stavu objednÃ¡vky
  // ðŸ†• MIGRACE NA NOVÃ BACKEND API (commit 3a28a99)
  // Backend automaticky naplnÃ­ 50+ placeholderÅ¯ z order_id
  // ðŸ”” ROZÅ ÃÅ˜ENÃ PRAVIDLA NOTIFIKACÃ (01.11.2025)
  const sendOrderNotifications = async (orderId, orderNumber, newWorkflowState, oldWorkflowState, formData) => {
    try {
      // Pokud se stav nezmÄ›nil, nic neposÃ­lej
      if (oldWorkflowState && newWorkflowState === oldWorkflowState) {
        return;
      }


      // ðŸ†• NOVÃ VERZE - Backend API s automatickÃ½mi placeholdery

      // Detekce typu notifikace podle zmÄ›ny stavu
      let notificationType = null;
      let recipientUserIds = new Set();

      // === 1. NOVÃ OBJEDNÃVKA / ODESLÃNA KE SCHVÃLENÃ ===
      // PÅ™Ã­jemci: garant, pÅ™Ã­kazce, pÅ™Ã­p. schvalovatel
      // VyjÃ­mka: pokud je aktuÃ¡lnÃ­ uÅ¾ivatel pÅ™Ã­kazcem, dostane notifikaci
      const hasKeSchvaleni = hasWorkflowState(newWorkflowState, 'ODESLANA_KE_SCHVALENI');
      const hadKeSchvaleni = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'ODESLANA_KE_SCHVALENI') : false;

      if (hasKeSchvaleni && !hadKeSchvaleni) {
        notificationType = 'order_status_ke_schvaleni';


        if (formData.garant_uzivatel_id) {
          recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        }
        if (formData.prikazce_id) {
          recipientUserIds.add(parseInt(formData.prikazce_id));
        }
        if (formData.schvalovatel_id) {
          recipientUserIds.add(parseInt(formData.schvalovatel_id));
        }
      }

      // === 2. STAV SCHVÃLENÃ - SCHVÃLENA / ZAMÃTNUTA ===
      // PÅ™Ã­jemci: vÅ¾dy objednatel, garant
      // PÅ™Ã­kazce JEN pokud je jinÃ½ neÅ¾ schvalovatel
      const hasSchvalena = hasWorkflowState(newWorkflowState, 'SCHVALENA');
      const hadSchvalena = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'SCHVALENA') : false;

      const hasZamitnuta = hasWorkflowState(newWorkflowState, 'ZAMITNUTA');
      const hadZamitnuta = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'ZAMITNUTA') : false;

      if ((hasSchvalena && !hadSchvalena) || (hasZamitnuta && !hadZamitnuta)) {
        notificationType = hasSchvalena ? 'order_status_schvalena' : 'order_status_zamitnuta';


        // VÅ¾dy: objednatel a garant
        if (formData.objednatel_id) {
          recipientUserIds.add(parseInt(formData.objednatel_id));
        }
        if (formData.garant_uzivatel_id) {
          recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        }

        // PÅ™Ã­kazce JEN pokud je jinÃ½ neÅ¾ schvalovatel
        if (formData.prikazce_id && formData.schvalovatel_id &&
            parseInt(formData.prikazce_id) !== parseInt(formData.schvalovatel_id)) {
          recipientUserIds.add(parseInt(formData.prikazce_id));
        } else if (formData.prikazce_id) {
        }
      }

      // ObjednÃ¡vka ÄekÃ¡ (CEKA_SE) - schvalovatel vrÃ¡til k doplnÄ›nÃ­
      const hasCekaSe = hasWorkflowState(newWorkflowState, 'CEKA_SE');
      const hadCekaSe = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'CEKA_SE') : false;

      if (hasCekaSe && !hadCekaSe) {
        notificationType = 'order_status_ceka_se';

        // Pro ÄekÃ¡: objednatel a garant
        if (formData.objednatel_id) {
          recipientUserIds.add(parseInt(formData.objednatel_id));
        }
        if (formData.garant_uzivatel_id) {
          recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        }
      }

      // === 3. STAV ODESLÃNÃ - ODESLANA DODAVATELI ===
      // PÅ™Ã­jemci: VÅ ICHNI zÃºÄastnÄ›nÃ­ (objednatel, garant, pÅ™Ã­kazce, schvalovatel)
      // UnikÃ¡tnÃ­ *_id - pokud je nÄ›kdo ve vÃ­ce rolÃ­ch, notifikace jen jednou
      const hasOdeslana = hasWorkflowState(newWorkflowState, 'ODESLANA');
      const hadOdeslana = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'ODESLANA') : false;

      if (hasOdeslana && !hadOdeslana) {
        notificationType = 'order_status_odeslana';


        // VÅ ICHNI zÃºÄastnÄ›nÃ­ (Set zajistÃ­ unikÃ¡tnost)
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.prikazce_id) recipientUserIds.add(parseInt(formData.prikazce_id));
        if (formData.schvalovatel_id) recipientUserIds.add(parseInt(formData.schvalovatel_id));
      }

      // === 4. POTVRZENÃ DODAVATELE - POTVRZENA ===
      // PÅ™Ã­jemci: VÅ ICHNI zÃºÄastnÄ›nÃ­ (objednatel, garant, pÅ™Ã­kazce, schvalovatel)
      // UnikÃ¡tnÃ­ *_id - pokud je nÄ›kdo ve vÃ­ce rolÃ­ch, notifikace jen jednou
      const hasPotvrzena = hasWorkflowState(newWorkflowState, 'POTVRZENA');
      const hadPotvrzena = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'POTVRZENA') : false;

      if (hasPotvrzena && !hadPotvrzena) {
        notificationType = 'order_status_potvrzena';


        // VÅ ICHNI zÃºÄastnÄ›nÃ­ (Set zajistÃ­ unikÃ¡tnost)
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.prikazce_id) recipientUserIds.add(parseInt(formData.prikazce_id));
        if (formData.schvalovatel_id) recipientUserIds.add(parseInt(formData.schvalovatel_id));
      }

      // === 5. REGISTR - ÄŒEKÃ NA SCHVÃLENÃ ===
      // TODO: Pokud se mÃ¡ schvalovat, notifikace uÅ¾ivatelÅ¯m s prÃ¡vy VEREJNE_ZAKAZKY
      // ZatÃ­m ponechÃ¡no pro budoucÃ­ implementaci - vyÅ¾aduje naÄtenÃ­ uÅ¾ivatelÅ¯ podle prÃ¡v

      // === 6. REGISTR - ZVEÅ˜EJNÄšNA ===
      // PÅ™Ã­jemci: garant, objednatel, pÅ™Ã­kazce, schvalovatel
      // UnikÃ¡tnÃ­ *_id - pokud je nÄ›kdo ve vÃ­ce rolÃ­ch, notifikace jen jednou
      const hasUverejnena = hasWorkflowState(newWorkflowState, 'UVEREJNENA');
      const hadUverejnena = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'UVEREJNENA') : false;

      if (hasUverejnena && !hadUverejnena) {
        notificationType = 'order_status_registr_zverejnena'; // âœ… OPRAVENO: pouÅ¾Ã­vat sprÃ¡vnÃ½ nÃ¡zev z DB


        // VÅ ICHNI zÃºÄastnÄ›nÃ­ (Set zajistÃ­ unikÃ¡tnost)
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
        if (formData.prikazce_id) recipientUserIds.add(parseInt(formData.prikazce_id));
        if (formData.schvalovatel_id) recipientUserIds.add(parseInt(formData.schvalovatel_id));
      }

      // === 6b. REGISTR - ÄŒEKÃ NA ZVEÅ˜EJNÄšNÃ (NEUVEREJNENA) ===
      // PÅ™Ã­jemci: uÅ¾ivatelÃ© s prÃ¡vy VEREJNE_ZAKAZKY + garant
      const hasNeuverejnena = hasWorkflowState(newWorkflowState, 'NEUVEREJNENA');
      const hadNeuverejnena = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'NEUVEREJNENA') : false;

      if (hasNeuverejnena && !hadNeuverejnena) {
        notificationType = 'order_status_registr_ceka';


        // Garant + TODO: uÅ¾ivatelÃ© s prÃ¡vy VEREJNE_ZAKAZKY
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
      }

      // === 7. FÃZE FAKTURACE - ÄŒEKÃ NA FAKTURU ===
      // PÅ™Ã­jemci: garant a objednatel (pokud nenÃ­ zÃ¡roveÅˆ garantem)
      // UnikÃ¡tnÃ­ *_id - pokud je objednatel = garant, notifikace jen jednou
      const hasFakturace = hasWorkflowState(newWorkflowState, 'FAKTURACE');
      const hadFakturace = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'FAKTURACE') : false;

      if (hasFakturace && !hadFakturace) {
        notificationType = 'order_status_faktura_ceka'; // âœ… OPRAVENO: ÄekÃ¡ na fakturu, ne "fakturace"


        // Garant a objednatel (Set zajistÃ­ unikÃ¡tnost pokud jsou stejnÃ­)
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
      }

      // === 8. FÃZE VÄšCNÃ SPRÃVNOST - ÄŒEKÃ NA KONTROLU ===
      // PÅ™Ã­jemci: garant a objednatel
      const hasVecnaSpravnost = hasWorkflowState(newWorkflowState, 'VECNA_SPRAVNOST');
      const hadVecnaSpravnost = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'VECNA_SPRAVNOST') : false;

      if (hasVecnaSpravnost && !hadVecnaSpravnost) {
        notificationType = 'order_status_kontrola_ceka';


        // Garant a objednatel (Set zajistÃ­ unikÃ¡tnost pokud jsou stejnÃ­)
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
      }

      // === 9. FÃZE ZKONTROLOVÃNA (VÄšCNÃ SPRÃVNOST POTVRZENA) ===
      // PÅ™Ã­jemci: uÅ¾ivatelÃ© s rolemi VEREJNE_ZAKAZKY, HLAVNI_UCETNI, ROZPOCTAR
      // + objednatel (pokud nenÃ­ zÃ¡roveÅˆ garantem)
      // VyjÃ­mka: NENÃ ten, kdo vÄ›cnou kontrolu provÃ¡dÄ›l
      // TODO: VyÅ¾aduje naÄtenÃ­ uÅ¾ivatelÅ¯ podle prÃ¡v - zatÃ­m ponechÃ¡no pro budoucÃ­ implementaci
      const hasZkontrolovana = hasWorkflowState(newWorkflowState, 'ZKONTROLOVANA');
      const hadZkontrolovana = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'ZKONTROLOVANA') : false;

      if (hasZkontrolovana && !hadZkontrolovana) {
        notificationType = 'order_status_kontrola_potvrzena'; // âœ… OPRAVENO: vÄ›cnÃ¡ sprÃ¡vnost potvrzena


        // Objednatel (pokud nenÃ­ garant - Set zajistÃ­ unikÃ¡tnost)
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));

        // TODO: PÅ™idat uÅ¾ivatele s prÃ¡vy VEREJNE_ZAKAZKY, HLAVNI_UCETNI, ROZPOCTAR
        // VyÅ¾aduje volÃ¡nÃ­ API pro zÃ­skÃ¡nÃ­ uÅ¾ivatelÅ¯ podle prÃ¡v
      }

      // === 10. OBJEDNÃVKA DOKONÄŒENA ===
      // PÅ™Ã­jemci: VÅ ICHNI zÃºÄastnÄ›nÃ­ (objednatel, garant, pÅ™Ã­kazce, schvalovatel)
      // UnikÃ¡tnÃ­ *_id - pokud je nÄ›kdo ve vÃ­ce rolÃ­ch, notifikace jen jednou
      const hasDokoncena = hasWorkflowState(newWorkflowState, 'DOKONCENA');
      const hadDokoncena = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'DOKONCENA') : false;

      if (hasDokoncena && !hadDokoncena) {
        notificationType = 'order_status_dokoncena';


        // VÅ ICHNI zÃºÄastnÄ›nÃ­ (Set zajistÃ­ unikÃ¡tnost)
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.prikazce_id) recipientUserIds.add(parseInt(formData.prikazce_id));
        if (formData.schvalovatel_id) recipientUserIds.add(parseInt(formData.schvalovatel_id));
      }

      // === 11. OBJEDNÃVKA ZRUÅ ENA/STORNOVÃNA ===
      const hasZrusena = hasWorkflowState(newWorkflowState, 'ZRUSENA');
      const hadZrusena = oldWorkflowState ? hasWorkflowState(oldWorkflowState, 'ZRUSENA') : false;

      if (hasZrusena && !hadZrusena) {
        notificationType = 'order_status_zrusena';

        // Pro zruÅ¡enÃ­: vÅ¡ichni relevantnÃ­
        if (formData.objednatel_id) recipientUserIds.add(parseInt(formData.objednatel_id));
        if (formData.garant_uzivatel_id) recipientUserIds.add(parseInt(formData.garant_uzivatel_id));
        if (formData.prikazce_id) recipientUserIds.add(parseInt(formData.prikazce_id));
      }

      // âœ… FILTR 1: Odfiltrovat aktuÃ¡lnÄ› pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele (neposÃ­lat sÃ¡m sobÄ›!)
      // âš ï¸ VYJÃMKA: Pokud je aktuÃ¡lnÃ­ uÅ¾ivatel PÅ˜ÃKAZCE objednÃ¡vky, tak notifikaci DOSTAT MÃ
      if (user_id) {
        const currentUserIdInt = parseInt(user_id);
        const isUserCreator = formData.prikazce_id && parseInt(formData.prikazce_id) === currentUserIdInt;

        if (recipientUserIds.has(currentUserIdInt)) {
          if (isUserCreator) {
          } else {
            recipientUserIds.delete(currentUserIdInt);
          }
        }
      }

      // âœ… FILTR 2: Odstranit nevalidnÃ­ ID (null, undefined, NaN)
      const validRecipients = Array.from(recipientUserIds).filter(id => {
        return id && !isNaN(id) && id > 0;
      });


      // Pokud nebyl detekovÃ¡n Å¾Ã¡dnÃ½ typ notifikace, skonÄi
      if (!notificationType) {
        return;
      }

      // Pokud nejsou Å¾Ã¡dnÃ­ pÅ™Ã­jemci, skonÄi
      if (validRecipients.length === 0) {
        return;
      }

      // ðŸ†• NOVÃ BACKEND API - Odeslat notifikaci s automatickÃ½mi placeholdery
      // Backend automaticky naplnÃ­ 50+ placeholderÅ¯ z order_id!

      await notificationService.create({
        token,
        username,
        type: notificationType,
        order_id: orderId,
        action_user_id: user_id,
        recipients: validRecipients // HromadnÃ© odeslÃ¡nÃ­
      });

    } catch (error) {
      // Nezastavuj workflow kvÅ¯li chybÄ› notifikace
    }
  };

  // UloÅ¾enÃ­ objednÃ¡vky do API (kdyÅ¾ je validnÃ­)
  const saveOrderToAPI = async () => {
    
    if (!token || !username) {
      showToast && showToast('Nejste pÅ™ihlÃ¡Å¡en - nelze uloÅ¾it objednÃ¡vku', { type: 'error' });
      return;
    }

    // ðŸ†• Å˜EÅ ENÃ PROBLÃ‰MU #3: Validace ev_cislo PÅ˜ED uloÅ¾enÃ­m
    if (!isValidEvCislo(formData.ev_cislo)) {
      showToast && showToast('EvidenÄnÃ­ ÄÃ­slo se stÃ¡le naÄÃ­tÃ¡. PoÄkejte prosÃ­m na dokonÄenÃ­.', { type: 'warning' });
      return;
    }

    // ðŸ”’ KRITICKÃ‰: VyÄistit workflow update flag na zaÄÃ¡tku
    window.__workflowStateUpdated = false;

    // Nastavit saving state
    setIsSaving(true);

    // ðŸ›ï¸ ARCHIVOVANÃ‰ OBJEDNÃVKY: Partial update - jen vyplnÄ›nÃ¡ pole
    if (isArchivedOrder) {

      try {
        // PARTIAL UPDATE - sestavit orderData STEJNÄš jako u bÄ›Å¾nÃ½ch objednÃ¡vek
        // PosÃ­lat jen skuteÄnÃ¡ DB pole, vyfiltrovat agregovanÃ¡/poÄÃ­tanÃ¡ pole
        const orderData = {};

        // ZÃ¡kladnÃ­ pole - posÃ­lat jen pokud jsou vyplnÄ›nÃ¡
        if (user_id) orderData.uzivatel_id = typeof user_id === 'string' ? parseInt(user_id, 10) : user_id;
        if (formData.objednatel_id) orderData.objednatel_id = typeof formData.objednatel_id === 'string' ? parseInt(formData.objednatel_id, 10) : formData.objednatel_id;
        if (formData.predmet) orderData.predmet = formData.predmet;
        if (formData.garant_uzivatel_id) orderData.garant_uzivatel_id = formData.garant_uzivatel_id;
        if (formData.prikazce_id) orderData.prikazce_id = formData.prikazce_id;
        if (formData.max_cena_s_dph) orderData.max_cena_s_dph = formData.max_cena_s_dph;
        if (formData.druh_objednavky_kod) orderData.druh_objednavky_kod = formData.druh_objednavky_kod;
        if (formData.poznamka) orderData.poznamka = formData.poznamka;

        // StÅ™ediska - normalizovat
        if (formData.strediska_kod && formData.strediska_kod.length > 0) {
          orderData.strediska_kod = normalizeStrediskaForBackend(formData.strediska_kod);
        }

        // FinancovÃ¡nÃ­ - normalizovat
        if (formData.zpusob_financovani) {
          orderData.financovani = normalizeFinancovaniForBackend(formData, financovaniOptions);
        }

        // Workflow pole
        if (formData.stav_objednavky) orderData.stav_objednavky = formData.stav_objednavky;
        if (formData.stav_workflow_kod) orderData.stav_workflow_kod = formData.stav_workflow_kod;
        if (formData.faze_objednavky) orderData.faze_objednavky = formData.faze_objednavky;

        // SchvÃ¡lenÃ­
        if (formData.schvalil_uzivatel_id) orderData.schvalil_uzivatel_id = formData.schvalil_uzivatel_id;
        if (formData.dt_schvaleni) orderData.dt_schvaleni = formData.dt_schvaleni;
        if (formData.poznamka_schvaleni) orderData.poznamka_schvaleni = formData.poznamka_schvaleni;

        // VÄ›cnÃ¡ sprÃ¡vnost
        if (formData.potvrdil_vecnou_spravnost_id) orderData.potvrdil_vecnou_spravnost_id = formData.potvrdil_vecnou_spravnost_id;
        if (formData.dt_potvrzeni_vecne_spravnosti) orderData.dt_potvrzeni_vecne_spravnosti = formData.dt_potvrzeni_vecne_spravnosti;
        if (formData.poznamka_vecna_spravnost) orderData.poznamka_vecna_spravnost = formData.poznamka_vecna_spravnost;

        // PoloÅ¾ky (pokud existujÃ­)
        if (formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
          orderData.polozky = formData.polozky_objednavky.map(polozka => ({
            popis: polozka.popis || '',
            // ðŸ”§ FIX: Odstranit mezery a formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat (parseFloat("67 000") vracÃ­ 67, ne 67000!)
            cena_bez_dph: parseFloat((polozka.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,
            sazba_dph: parseInt(polozka.sazba_dph) || 21,
            cena_s_dph: parseFloat((polozka.cena_s_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,
            usek_kod: polozka.usek_kod || null,
            budova_kod: polozka.budova_kod || null,
            mistnost_kod: polozka.mistnost_kod || null,
            poznamka: polozka.poznamka || null,
            // ðŸŽ¯ LP kÃ³d na Ãºrovni poloÅ¾ky
            lp_id: polozka.lp_id ? parseInt(polozka.lp_id) : null
          }));
        }

        // âœ… KRITICKÃ‰: dt_objednavky = aktuÃ¡lnÃ­ datum a Äas VÅ½DY pÅ™i kaÅ¾dÃ©m uloÅ¾enÃ­
        // ðŸ• PouÅ¾ij stejnou helper funkci jako v bÄ›Å¾nÃ©m saveOrderToAPI
        const getMySQLDateTime = () => {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        };
        const currentDateTime = getMySQLDateTime(); // âœ… LOKÃLNÃ ÄŒAS
        orderData.dt_objednavky = currentDateTime;

        // updateOrderV2 vracÃ­ pÅ™Ã­mo data nebo hodÃ­ error
        const updatedOrder = await updateOrderV2(savedOrderId, orderData, token, username);

        showToast && showToast('âœ… ArchivovanÃ¡ objednÃ¡vka aktualizovÃ¡na', { type: 'success' });

        // Znovu naÄÃ­st aktuÃ¡lnÃ­ data z DB (pouÅ¾ije se getOrderV2)
        if (savedOrderId || formData.id) {
          const freshOrderData = await getOrderV2(parseInt(savedOrderId || formData.id), token, username, true);

          if (freshOrderData?.id) {
            // Aktualizovat formData s novÃ½mi daty z DB
            setFormData(prev => {
              const updatedData = {
                ...prev,
                ...freshOrderData
              };
              
              // ðŸ“¸ AKTUALIZOVAT SNAPSHOT po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ archivovanÃ© objednÃ¡vky
              originalFormDataRef.current = JSON.parse(JSON.stringify(updatedData));
              
              return updatedData;
            });

            // UloÅ¾it do konceptu
            saveDraft(freshOrderData, {
              isOrderSavedToDB: true,
              savedOrderId: freshOrderData.id,
              isChanged: false
            });
          }
        }
      } catch (error) {
        showToast && showToast(`Chyba: ${error.message}`, { type: 'error' });
      } finally {
        setIsSaving(false);
        setIsSavingDraft(false);
      }

      return; // âœ… KONEC pro archivovanÃ© objednÃ¡vky
    }

    // VALIDACE POUZE PÅ˜I POKUSU O ULOÅ½ENÃ DO DATABÃZE (bÄ›Å¾nÃ© objednÃ¡vky)
    const isValid = validateFormForSave();
    if (!isValid) {
      // ChybovÃ¡ zprÃ¡va se zobrazÃ­ v validateFormForSave()
      setIsSaving(false);
      return;
    }

    // VALIDACE NADLIMITU - nepovol uloÅ¾enÃ­ pokud je pÅ™ekroÄen limit
    const totalPrice = (formData.polozky_objednavky || []).reduce((sum, item) =>
      sum + (parseFloat(item.cena_s_dph) || 0), 0
    );
    const maxPrice = parseFloat(formData.max_cena_s_dph) || 0;
    const nadlimit = totalPrice - maxPrice;

    if (nadlimit > 0) {
      showToast && showToast(
        `Nelze uloÅ¾it objednÃ¡vku - pÅ™ekroÄen limit o ${nadlimit.toLocaleString('cs-CZ')} KÄ! Upravte poloÅ¾ky nebo zvyÅ¡te maximÃ¡lnÃ­ cenu.`,
        { type: 'error' }
      );

      // Odrolovat na sekci Detail objednÃ¡vky
      const detailSection = document.querySelector('[data-section="detaily"]');
      if (detailSection) {
        detailSection.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });

        // Rozbalit sekci pokud je sbalenÃ¡
        if (sectionStates.detaily) {
          setSectionStates(prev => ({ ...prev, detaily: false }));
        }
      }

      // KRITICKÃ‰: VyÄistit saving stav pÅ™i chybÄ› validace
      setIsSaving(false);
      return;
    }

    try {
      setIsSavingDraft(true);

      // ðŸ• HELPER: JednotnÃ¡ funkce pro generovÃ¡nÃ­ datetime v MySQL formÃ¡tu
      // VracÃ­: "YYYY-MM-DD HH:MM:SS" (LOKÃLNÃ Äas, ne UTC!)
      const getMySQLDateTime = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      };

      // ðŸ“… HELPER: Pouze datum bez Äasu (LOKÃLNÃ Äas, ne UTC!)
      // VracÃ­: "YYYY-MM-DD"
      const getMySQLDate = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      // KRITICKÃ‰: UrÄit role uÅ¾ivatele na zaÄÃ¡tku - pouÅ¾Ã­vÃ¡ se na vÃ­ce mÃ­stech
      const isSuperAdmin = userDetail?.roles?.some(role => role.kod_role === 'SUPERADMIN');
      const isAdmin = userDetail?.roles?.some(role => role.kod_role === 'ADMINISTRATOR');
      const shouldStayOnForm = isSuperAdmin || isAdmin; // SUPERADMIN/ADMIN zÅ¯stÃ¡vajÃ­ na formulÃ¡Å™i

      // ðŸ†• FÃZE 7: Automaticky nastavit potvrdil_vecnou_spravnost_id a dt_potvrzeni_vecne_spravnosti pÅ™i prvnÃ­m potvrzenÃ­
      // MUSÃ BÃT PÅ˜ED sestavenÃ­m orderData!
      let updatedFormData = { ...formData };

      // ðŸ” DEBUG: Kontrola podmÃ­nek pro nastavenÃ­ ID
      addDebugLog('info', 'VECNA-SPRAVNOST', 'check-conditions', `Kontrola: checkbox=${formData.potvrzeni_vecne_spravnosti}, existing_id=${formData.potvrdil_vecnou_spravnost_id}, user_id=${user_id}`);

      if ((formData.potvrzeni_vecne_spravnosti === 1 || formData.potvrzeni_vecne_spravnosti === true) &&
          !formData.potvrdil_vecnou_spravnost_id &&
          user_id) {
        const timestamp = getMySQLDateTime(); // âœ… JEDNOTNÃ FORMÃT
        updatedFormData.potvrdil_vecnou_spravnost_id = user_id;
        updatedFormData.dt_potvrzeni_vecne_spravnosti = timestamp;
        addDebugLog('info', 'VECNA-SPRAVNOST', 'auto-set-id', `âœ… Automaticky nastaveno pÅ™ed uloÅ¾enÃ­m: user_id=${user_id}, timestamp=${timestamp}`);
      } else {
        addDebugLog('warning', 'VECNA-SPRAVNOST', 'auto-set-skip', `âŒ PÅ™eskoÄeno nastavenÃ­ ID - podmÃ­nka nesplnÄ›na`);
      }

      // PÅ™ipravÃ­m jen vyplnÄ›nÃ© pole pro API
      const orderData = {};

      // âœ… KRITICKÃ‰: ID pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele (VÅ½DY povinnÃ©)
      if (user_id) {
        // PÅ™evÃ©st na ÄÃ­slo, pokud je to string
        const uzivatelIdNumber = typeof user_id === 'string' ? parseInt(user_id, 10) : user_id;
        orderData.uzivatel_id = uzivatelIdNumber;
        addDebugLog('info', 'SAVE', 'uzivatel-id', `Nastaveno uzivatel_id: ${uzivatelIdNumber} (pÅ¯vodnÃ­ typ: ${typeof user_id})`);
      } else {
        addDebugLog('error', 'SAVE', 'uzivatel-id-missing', 'user_id chybÃ­ v AuthContext');
      }

      // ZÃ¡kladnÃ­ povinnÃ© pole
      if (formData.predmet) orderData.predmet = formData.predmet;
      if (formData.garant_uzivatel_id) orderData.garant_uzivatel_id = formData.garant_uzivatel_id;
      if (formData.prikazce_id) orderData.prikazce_id = formData.prikazce_id;

      // âœ… BUGFIX: Objednatel ID - poslat VÅ½DY (INSERT i UPDATE)
      // PÅ™i INSERT: nastavit na user_id (kdo objednÃ¡vku vytvoÅ™il)
      // PÅ™i UPDATE: zachovat pÅ¯vodnÃ­ hodnotu z formData
      if (!isOrderSavedToDB && user_id) {
        // INSERT - novÃ¡ objednÃ¡vka, objednatel = aktuÃ¡lnÃ­ uÅ¾ivatel
        const objednatelIdNumber = typeof user_id === 'string' ? parseInt(user_id, 10) : user_id;
        orderData.objednatel_id = objednatelIdNumber;
        addDebugLog('info', 'SAVE', 'objednatel-id', `Nastaveno objednatel_id: ${objednatelIdNumber} (novÃ¡ objednÃ¡vka)`);
      } else if (isOrderSavedToDB && formData.objednatel_id) {
        // UPDATE - existujÃ­cÃ­ objednÃ¡vka, zachovat pÅ¯vodnÃ­ho objednatele
        const objednatelIdNumber = typeof formData.objednatel_id === 'string' ? parseInt(formData.objednatel_id, 10) : formData.objednatel_id;
        orderData.objednatel_id = objednatelIdNumber;
        addDebugLog('info', 'SAVE', 'objednatel-id-preserved', `ZachovÃ¡n objednatel_id: ${objednatelIdNumber} (UPDATE objednÃ¡vky)`);
      }

      // âœ… STÅ˜EDISKA: Normalizovat do array stringÅ¯ pro backend
      if (formData.strediska_kod && formData.strediska_kod.length > 0) {
        orderData.strediska_kod = normalizeStrediskaForBackend(formData.strediska_kod);
        addDebugLog('info', 'SAVE', 'strediska-normalized', `StÅ™ediska: ${JSON.stringify(formData.strediska_kod)} -> ${JSON.stringify(orderData.strediska_kod)}`);
      }

      if (formData.max_cena_s_dph) orderData.max_cena_s_dph = formData.max_cena_s_dph;
      
      // MimoÅ™Ã¡dnÃ¡ udÃ¡lost (boolean)
      orderData.mimoradna_udalost = formData.mimoradna_udalost || false;

      // âœ… FINANCOVÃNÃ: Normalizovat do objektu pro backend (VÅ ECHNA POLE jdou do financovani objektu!)
      // ðŸ”¥ KRITICKÃ OPRAVA: I kdyÅ¾ je pole disabled, MUSÃME poslat hodnotu!
      // Disabled pole se neposÃ­lajÃ­ v HTML form submit, ale zde mÃ¡me pÅ™Ã­stup k formData
      if (formData.zpusob_financovani) {
        orderData.financovani = normalizeFinancovaniForBackend(formData, financovaniOptions);
        addDebugLog('info', 'SAVE', 'financovani-normalized', `FinancovÃ¡nÃ­: ${JSON.stringify(orderData.financovani)}`);
      } else {
        // ðŸ”¥ OCHRANA: Pokud nenÃ­ financovÃ¡nÃ­ vyplnÄ›no, poÅ¡li null
        orderData.financovani = null;
        addDebugLog('warning', 'SAVE', 'financovani-empty', 'FinancovÃ¡nÃ­ nenÃ­ vyplnÄ›no - posÃ­lÃ¡m null');
      }

      // Druh objednÃ¡vky - transformovat na objekt s kod_stavu a nazev_stavu
      // Pole je vyplÅˆovÃ¡no aÅ¾ ve FÃZI 3, proto ve fÃ¡zi 1-2 mÅ¯Å¾e bÃ½t NULL
      if (formData.druh_objednavky_kod) {
        const druhObj = druhyObjednavkyOptions.find(opt =>
          (opt.kod_stavu && opt.kod_stavu === formData.druh_objednavky_kod) ||
          (opt.kod && opt.kod === formData.druh_objednavky_kod) ||
          (opt.value && opt.value === formData.druh_objednavky_kod)
        );

        const druhObjednavkyObj = {
          kod_stavu: druhObj?.kod_stavu || druhObj?.kod || druhObj?.value || formData.druh_objednavky_kod,
          nazev_stavu: druhObj?.nazev_stavu || druhObj?.nazev || druhObj?.label || formData.druh_objednavky_kod
        };

        orderData.druh_objednavky_kod = JSON.stringify(druhObjednavkyObj);
        addDebugLog('info', 'SAVE', 'druh-transform', `Transformace druhu objednÃ¡vky: ${formData.druh_objednavky_kod} -> ${orderData.druh_objednavky_kod}`);
      } else {
        // Pokud nenÃ­ vyplnÄ›no (fÃ¡ze 1-2), poslat null (po ALTER TABLE na DB)
        orderData.druh_objednavky_kod = null;
        addDebugLog('info', 'SAVE', 'druh-empty', 'Druh objednÃ¡vky nenÃ­ vyplnÄ›n (fÃ¡ze 1-2) - posÃ­lÃ¡m NULL');
      }

      // PoloÅ¾ky objednÃ¡vky - uklÃ¡dajÃ­ se pÅ™i UPDATE (existujÃ­cÃ­ objednÃ¡vka) nebo od FÃZE 3+
      // PosÃ­lajÃ­ se pÅ™Ã­mo jako pole do root objektu, ne jako JSON string
      const isUpdateOperation = isOrderSavedToDB && savedOrderId;

      // âœ… OPRAVA: Pokud existujÃ­ poloÅ¾ky, VÅ½DY je poslat pÅ™i UPDATE (i ve fÃ¡zi 2)
      if (isUpdateOperation) {
        // UPDATE - poslat poloÅ¾ky pokud existujÃ­ (i ve fÃ¡zi 2)
        if (formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
          orderData.polozky = formData.polozky_objednavky.map(polozka => ({
            popis: polozka.popis || '',
            // ðŸ”§ FIX: Odstranit mezery a formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat (parseFloat("67 000") vracÃ­ 67, ne 67000!)
            cena_bez_dph: parseFloat((polozka.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,
            sazba_dph: parseInt(polozka.sazba_dph) || 21,
            cena_s_dph: parseFloat((polozka.cena_s_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,
            // ðŸ¢ VolitelnÃ¡ lokalizace (Ãºsek, budova, mÃ­stnost, poznÃ¡mka)
            usek_kod: polozka.usek_kod || null,
            budova_kod: polozka.budova_kod || null,
            mistnost_kod: polozka.mistnost_kod || null,
            poznamka: polozka.poznamka || null,
            // ðŸŽ¯ LP kÃ³d na Ãºrovni poloÅ¾ky
            lp_id: polozka.lp_id ? parseInt(polozka.lp_id) : null
          }));

          addDebugLog('info', 'SAVE', 'polozky-transform', `Transformace poloÅ¾ek objednÃ¡vky (UPDATE fÃ¡ze ${currentPhase}): ${formData.polozky_objednavky.length} poloÅ¾ek -> pÅ™Ã­mo do root jako 'polozky' pole`);
        } else {
          // PrÃ¡zdnÃ© pole - poslat prÃ¡zdnÃ© pole, aby backend vymazal existujÃ­cÃ­ poloÅ¾ky
          orderData.polozky = [];
          addDebugLog('warning', 'SAVE', 'polozky-empty', `PoloÅ¾ky jsou prÃ¡zdnÃ© (UPDATE fÃ¡ze ${currentPhase}) - posÃ­lÃ¡m prÃ¡zdnÃ© pole`);
        }
      } else if (currentPhase >= 3 && formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
        // INSERT ve fÃ¡zi 3+ - poslat poloÅ¾ky
        orderData.polozky = formData.polozky_objednavky.map(polozka => ({
          popis: polozka.popis || '',
          cena_bez_dph: parseFloat((polozka.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,
          sazba_dph: parseInt(polozka.sazba_dph) || 21,
          cena_s_dph: parseFloat((polozka.cena_s_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,
          usek_kod: polozka.usek_kod || null,
          budova_kod: polozka.budova_kod || null,
          mistnost_kod: polozka.mistnost_kod || null,
          poznamka: polozka.poznamka || null,
          lp_id: polozka.lp_id ? parseInt(polozka.lp_id) : null
        }));
        addDebugLog('info', 'SAVE', 'polozky-transform-insert', `Transformace poloÅ¾ek objednÃ¡vky (INSERT fÃ¡ze ${currentPhase}): ${formData.polozky_objednavky.length} poloÅ¾ek`);
      } else {
        addDebugLog('info', 'SAVE', 'polozky-skip', `PoloÅ¾ky se neposÃ­lajÃ­ - INSERT v FÃZI ${currentPhase}`);
      }

      // PoznÃ¡mka objednÃ¡vky - souÄÃ¡st hlavnÃ­ datovÃ© vÄ›ty
      if (formData.poznamka_objednavky) {
        orderData.poznamka = formData.poznamka_objednavky;
        addDebugLog('info', 'SAVE', 'poznamka-add', `PÅ™idÃ¡na poznÃ¡mka objednÃ¡vky: ${formData.poznamka_objednavky.length} znakÅ¯`);
      }

      // VÄ›cnÃ¡ sprÃ¡vnost - FÃZE 7 (uklÃ¡dat VÅ½DY, i prÃ¡zdnÃ© hodnoty - EXPLICITNÄš)
      // ðŸ”§ KRITICKÃ OPRAVA: TextovÃ¡ pole pouÅ¾Ã­vat z formData (obsahujÃ­ aktuÃ¡lnÃ­ vyplnÄ›nÃ© hodnoty)
      // Checkbox a metadata pouÅ¾Ã­vat z updatedFormData (obsahuje novÄ› nastavenÃ© ID a timestamp)
      orderData.vecna_spravnost_umisteni_majetku = formData.vecna_spravnost_umisteni_majetku || '';
      orderData.vecna_spravnost_poznamka = formData.vecna_spravnost_poznamka || '';
      // ðŸ”§ FIX: Konvertovat prÃ¡zdnÃ½ string na 0, aby MySQL nepÅ™ijal nevalidnÃ­ hodnotu
      const vecnaSpravnostValue = updatedFormData.potvrzeni_vecne_spravnosti;
      orderData.potvrzeni_vecne_spravnosti = (vecnaSpravnostValue === 1 || vecnaSpravnostValue === true) ? 1 : 0;

      // ðŸ” DEBUG: VÄ›cnÃ¡ sprÃ¡vnost - automatickÃ© ID a timestamp (posÃ­lat VÅ½DY, i null)
      orderData.potvrdil_vecnou_spravnost_id = updatedFormData.potvrdil_vecnou_spravnost_id || null;
      orderData.dt_potvrzeni_vecne_spravnosti = updatedFormData.dt_potvrzeni_vecne_spravnosti || null;

      // ðŸ” DEBUG: VÃ½pis vÄ›cnÃ© sprÃ¡vnosti pÅ™ed odeslÃ¡nÃ­m
      addDebugLog('info', 'VECNA-SPRAVNOST', 'save-data', `UklÃ¡dÃ¡m vÄ›cnou sprÃ¡vnost: checkbox=${orderData.potvrzeni_vecne_spravnosti}, umisteni="${orderData.vecna_spravnost_umisteni_majetku}", poznamka="${orderData.vecna_spravnost_poznamka}", user_id=${orderData.potvrdil_vecnou_spravnost_id}, dt=${orderData.dt_potvrzeni_vecne_spravnosti}`);

      // DodacÃ­ a zÃ¡ruÄnÃ­ podmÃ­nky
      if (formData.dt_predpokladany_termin_dodani) orderData.dt_predpokladany_termin_dodani = formData.dt_predpokladany_termin_dodani;
      if (formData.misto_dodani) orderData.misto_dodani = formData.misto_dodani;
      if (formData.zaruka) orderData.zaruka = formData.zaruka;

      // Informace o dodavateli
      if (formData.dodavatel_id) orderData.dodavatel_id = formData.dodavatel_id;
      if (formData.dodavatel_nazev) orderData.dodavatel_nazev = formData.dodavatel_nazev;
      if (formData.dodavatel_adresa) orderData.dodavatel_adresa = formData.dodavatel_adresa;
      if (formData.dodavatel_ico) orderData.dodavatel_ico = formData.dodavatel_ico;
      if (formData.dodavatel_dic) orderData.dodavatel_dic = formData.dodavatel_dic;
      if (formData.dodavatel_zastoupeny) orderData.dodavatel_zastoupeny = formData.dodavatel_zastoupeny;

      // KontaktnÃ­ osoba dodavatele
      if (formData.dodavatel_kontakt_jmeno) orderData.dodavatel_kontakt_jmeno = formData.dodavatel_kontakt_jmeno;
      if (formData.dodavatel_kontakt_email) orderData.dodavatel_kontakt_email = formData.dodavatel_kontakt_email;
      if (formData.dodavatel_kontakt_telefon) orderData.dodavatel_kontakt_telefon = formData.dodavatel_kontakt_telefon;

      // KontaktnÃ­ Ãºdaje objednatele
      if (formData.objednatel_jmeno) orderData.objednatel_jmeno = formData.objednatel_jmeno;
      if (formData.objednatel_email) orderData.objednatel_email = formData.objednatel_email;
      if (formData.objednatel_telefon) orderData.objednatel_telefon = formData.objednatel_telefon;

      // Popis a poznÃ¡mky
      if (formData.popis_pozadavku) orderData.popis_pozadavku = formData.popis_pozadavku;
      if (formData.poznamky) orderData.poznamky = formData.poznamky;

      // PÅ™Ã­lohy (pokud existujÃ­)
      if (formData.prilohy && formData.prilohy.length > 0) {
        orderData.prilohy = formData.prilohy;
      }

      // âœ… SchvÃ¡lenÃ­ objednÃ¡vky - SPRÃVNÃ LOGIKA podle DB struktury
      // stav_schvaleni NEEXISTUJE v DB! MÃ­sto toho pouÅ¾Ã­vÃ¡me:
      // 1. schvalovatel_id - ID uÅ¾ivatele, kterÃ½ schvÃ¡lil
      // 2. dt_schvaleni - datum schvÃ¡lenÃ­
      // 3. stav_workflow_kod - pÅ™idÃ¡me "SCHVALENA" do array

      if (formData.dt_schvaleni) orderData.dt_schvaleni = formData.dt_schvaleni;

      // KomentÃ¡Å™ ke schvÃ¡lenÃ­
      // âœ… PÅ™i schvÃ¡lenÃ­ (stav_schvaleni === 'schvaleno') poslat prÃ¡zdnÃ½ string nebo null
      // Pro zamÃ­tnutÃ­ a ÄekÃ¡_se poslat hodnotu (povinnÃ© pole)
      if (formData.stav_schvaleni === 'schvaleno') {
        // PÅ™i schvÃ¡lenÃ­ VÅ½DY poslat prÃ¡zdnÃ½ string (vymazat komentÃ¡Å™)
        orderData.schvaleni_komentar = '';
      } else if (formData.schvaleni_komentar) {
        // Pro ostatnÃ­ stavy poslat hodnotu (pokud existuje)
        orderData.schvaleni_komentar = formData.schvaleni_komentar;
      }

      // stav_workflow_kod - SESTAVUJ SPRÃVNOU POSLOUPNOST PODLE WORKFLOW KONCEPTU
      // NaÄti existujÃ­cÃ­ stavy z DB
      let existingStates = parseWorkflowStates(formData.stav_workflow_kod);

      // ðŸ”§ OPRAVA WORKFLOW: ZACHOVAT PÅ˜EDCHOZÃ STAVY A PÅ˜IDÃVAT NOVÃ‰ (ne pÅ™episovat)
      // Workflow poÅ™adÃ­: KE_SCHVALENI â†’ SCHVALENA â†’ ROZPRACOVANA â†’ ODESLANA â†’ POTVRZENA â†’ UVEREJNENA â†’ FAKTURACE â†’ DOKONCENA
      let workflowStates = [...existingStates]; // Zachovat existujÃ­cÃ­ stavy z DB

      // âœ… KRITICKÃ‰: Kontrolovat formData.id NEBO savedOrderId pro rozhodnutÃ­ INSERT vs UPDATE
      const hasOrderId = formData.id || savedOrderId;

      // 1. PrvnÃ­ uloÅ¾enÃ­ do DB (INSERT)
      if (!hasOrderId) {
        workflowStates = []; // U novÃ½ch zaÄÃ­t ÄistÄ›

        // âœ… SPRÃVNÃ LOGIKA: Rozhodnout podle radio buttonu v UI
        // formData.stav_schvaleni je POUZE UI helper (neuklÃ¡dÃ¡ se do DB!)
        const approvalChoice = formData.stav_schvaleni; // 'schvaleno', 'neschvaleno', 'ceka_se', nebo ''

        if (approvalChoice === 'schvaleno') {
          // OkamÅ¾itÃ© schvÃ¡lenÃ­ - pÅ™eskoÄit ODESLANA_KE_SCHVALENI
          workflowStates = ['SCHVALENA'];
          addDebugLog('info', 'SAVE', 'workflow-new', 'INSERT: OkamÅ¾itÃ© schvÃ¡lenÃ­ - SCHVALENA');
        } else {
          // NormÃ¡lnÃ­ postup - odeslÃ¡nÃ­ ke schvÃ¡lenÃ­
          workflowStates = ['ODESLANA_KE_SCHVALENI'];
          addDebugLog('info', 'SAVE', 'workflow-new', 'INSERT: OdeslÃ¡nÃ­ ke schvÃ¡lenÃ­ - ODESLANA_KE_SCHVALENI');
        }
      } else {
        // âœ… UPDATE: OÅ¡etÅ™it starÃ½ stav NOVA (deprecated) - nahradit za ODESLANA_KE_SCHVALENI
        if (workflowStates.includes('NOVA') || workflowStates.length === 0 || (workflowStates.length === 1 && workflowStates[0] === 'NOVA')) {
          workflowStates = workflowStates.filter(s => s !== 'NOVA');
          if (!workflowStates.includes('ODESLANA_KE_SCHVALENI')) {
            workflowStates.push('ODESLANA_KE_SCHVALENI');
            addDebugLog('info', 'SAVE', 'workflow-migration', 'UPDATE: MigrovÃ¡n starÃ½ stav NOVA â†’ ODESLANA_KE_SCHVALENI');
          }
        }
      }

      // 2. SchvÃ¡lenÃ­/zamÃ­tnutÃ­ - pÅ™epsat JEN vzÃ¡jemnÄ› se vyluÄujÃ­cÃ­ stavy
      // âœ… POUÅ½ÃVÃ formData.stav_schvaleni POUZE PRO UI LOGIKU (neposÃ­lÃ¡ se do DB!)
      const approvalChoice = formData.stav_schvaleni; // UI helper

      if (approvalChoice === 'schvaleno') {
        // Odstranit POUZE vyluÄujÃ­cÃ­ se schvalovacÃ­ stavy (CEKA_SE, ZAMITNUTA)
        workflowStates = workflowStates.filter(s => !['ODESLANA_KE_SCHVALENI', 'CEKA_SE', 'ZAMITNUTA'].includes(s));
        if (!workflowStates.includes('SCHVALENA')) {
          workflowStates.push('SCHVALENA');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav SCHVALENA');
        }
      } else if (approvalChoice === 'neschvaleno') {
        // Odstranit POUZE vyluÄujÃ­cÃ­ se schvalovacÃ­ stavy (SCHVALENA, CEKA_SE)
        // POZOR: PÅ™i zamÃ­tnutÃ­ NEODSTRAÅ‡OVAT dalÅ¡Ã­ stavy workflow!
        workflowStates = workflowStates.filter(s => !['ODESLANA_KE_SCHVALENI', 'CEKA_SE', 'SCHVALENA'].includes(s));
        if (!workflowStates.includes('ZAMITNUTA')) {
          workflowStates.push('ZAMITNUTA');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav ZAMITNUTA');
        }
      } else if (approvalChoice === 'ceka_se') {
        // Odstranit POUZE vyluÄujÃ­cÃ­ se schvalovacÃ­ stavy (SCHVALENA, ZAMITNUTA)
        workflowStates = workflowStates.filter(s => !['ODESLANA_KE_SCHVALENI', 'ZAMITNUTA', 'SCHVALENA'].includes(s));
        if (!workflowStates.includes('CEKA_SE')) {
          workflowStates.push('CEKA_SE');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav CEKA_SE');
        }
      }

      // 3. ROZPRACOVANA - FÃZE 3 rozpracovanÃ¡ (vyluÄuje se s ODESLANA a ZRUSENA)
      // Pokud jsme ve FÃZI 3 (mÃ¡me SCHVALENA) a NENÃ zaÅ¡krtnutÃ½ checkbox "OdeslÃ¡no" ani "StornovÃ¡no"
      // â†’ pÅ™idej ROZPRACOVANA (uÅ¾ivatel pracuje na objednÃ¡vce, ale jeÅ¡tÄ› ji neodeslal)
      // âœ… OPRAVA: NEPÅ˜IDÃVAT ROZPRACOVANA pÅ™i prvnÃ­m schvÃ¡lenÃ­ (pouze kdyÅ¾ uÅ¾ byla SCHVALENA pÅ™edtÃ­m)
      const wasAlreadyApproved = existingStates?.includes('SCHVALENA') || false;
      const isJustNowApproved = approvalChoice === 'schvaleno' && !wasAlreadyApproved;

      if (workflowStates.includes('SCHVALENA') &&
          !formData.stav_odeslano &&
          !formData.stav_stornovano &&
          !workflowStates.includes('ROZPRACOVANA') &&
          !isJustNowApproved) {  // âœ… NOVÃ PODMÃNKA: nepÅ™idÃ¡vat pÅ™i prvnÃ­m schvÃ¡lenÃ­
        // PÅ™idat ROZPRACOVANA (indikÃ¡tor Å¾e se na objednÃ¡vce pracuje)
        workflowStates.push('ROZPRACOVANA');
        addDebugLog('info', 'SAVE', 'workflow-update', 'âœ… PÅ™idÃ¡n stav ROZPRACOVANA - objednÃ¡vka ve FÃZI 3, jeÅ¡tÄ› neodeslanÃ¡');
      }

      // 4. ODESLANA - po odeslÃ¡nÃ­ dodavateli (nahrazuje ROZPRACOVANA)
      // âœ… KRITICKÃ‰: Workflow MUSÃ bÃ½t ÄŒISTÃ ["SCHVALENA", "ODESLANA"], vymazat vyÅ¡Å¡Ã­ fÃ¡ze
      if (formData.stav_odeslano && !formData.stav_stornovano) {
        // Nastavit ÄistÃ½ workflow FÃZE 4
        workflowStates = ['SCHVALENA', 'ODESLANA'];
        addDebugLog('info', 'SAVE', 'workflow-clean', 'âœ… Workflow nastaven na Äistou FÃZI 4: ["SCHVALENA", "ODESLANA"]');
      } else if (!formData.stav_odeslano && workflowStates.includes('ODESLANA')) {
        // Pokud ODESLANA existuje ale checkbox nenÃ­ zaÅ¡krtnutÃ½ â†’ vrÃ¡tit na SCHVALENA
        workflowStates = ['SCHVALENA'];
        addDebugLog('info', 'SAVE', 'workflow-clean', 'âœ… Workflow vrÃ¡cen na FÃZI 3: ["SCHVALENA"]');
      }

      // 5. ZRUSENA - pÅ™i stornovÃ¡nÃ­
      if (formData.stav_stornovano) {
        if (!workflowStates.includes('ZRUSENA')) {
          workflowStates.push('ZRUSENA');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav ZRUSENA');
        }
        // PÅ™i stornovÃ¡nÃ­ odstranit nÄ›kterÃ© stavy
        workflowStates = workflowStates.filter(s => !['ROZPRACOVANA', 'ODESLANA', 'POTVRZENA'].includes(s));
      } else {
        // Odstranit ZRUSENA pokud nenÃ­ stornovÃ¡no
        workflowStates = workflowStates.filter(s => s !== 'ZRUSENA');
      }

      // 6. POTVRZENA - potvrzenÃ­ od dodavatele
      const isDodavatelPotvrzeno = formData.dodavatel_zpusob_potvrzeni?.potvrzeni === 'ANO' ||
                                  formData.stav_u_dodavatele === 'potvrzeno';
      if (isDodavatelPotvrzeno && !formData.stav_stornovano) {
        if (!workflowStates.includes('POTVRZENA')) {
          workflowStates.push('POTVRZENA');
          addDebugLog('info', 'SAVE', 'workflow-update', 'âœ… PÅ™idÃ¡n stav POTVRZENA - dodavatel potvrdil ANO');
        }
      } else if (!isDodavatelPotvrzeno) {
        // âœ… Dodavatel potvrdil NE â†’ vrÃ¡tit na Äistou FÃZI 4 (vymazat vÅ¡echny vyÅ¡Å¡Ã­ fÃ¡ze)
        workflowStates = workflowStates.filter(s =>
          !['POTVRZENA', 'UVEREJNIT', 'NEUVEREJNIT', 'UVEREJNENA', 'FAKTURACE', 'VECNA_SPRAVNOST', 'ZKONTROLOVANA', 'DOKONCENA'].includes(s)
        );
        addDebugLog('info', 'SAVE', 'workflow-clean', 'âœ… Dodavatel potvrdil NE - workflow vrÃ¡cen na FÃZI 4, vymazÃ¡ny vyÅ¡Å¡Ã­ fÃ¡ze');
      }

      // 7. UVEREJNENA - pÅ™i rozhodnutÃ­ o zveÅ™ejnÄ›nÃ­ v registru smluv
      // FÃZE 4: UÅ¾ivatel s oprÃ¡vnÄ›nÃ­m rozhodne ANO/NE pomocÃ­ checkboxu "MÃ¡ bÃ½t zveÅ™ejnÄ›na"
      //   - Pokud ma_byt_zverejnena = true â†’ UVEREJNIT â†’ FÃZE 5 (vyplnÄ›nÃ­ datum + IDDT)
      //   - Pokud ma_byt_zverejnena = false â†’ NEUVEREJNIT â†’ pÅ™eskoÄÃ­ FÃZI 5 â†’ rovnou FÃZE 6 (Fakturace)

      // UVEREJNOVÃNÃ - rozhodnutÃ­ o zveÅ™ejnÄ›nÃ­
      // Logika:
      // - Pokud dodavatel potvrdil (POTVRZENA) a ma_byt_zverejnena === true â†’ pÅ™idat stav 'UVEREJNIT' (posun na fÃ¡zi 5)
      // - Pokud dodavatel potvrdil a ma_byt_zverejnena === false â†’ pÅ™idat stav 'NEUVEREJNIT' (pÅ™eskoÄit na fÃ¡zi 6 - Fakturace)
      // - Pokud ma_byt_zverejnena nenÃ­ definovÃ¡no, povaÅ¾ovat za false (defaultnÃ­ chovÃ¡nÃ­)
      if (workflowStates.includes('POTVRZENA') && !formData.stav_stornovano) {
        const maBytZverejnena = formData.ma_byt_zverejnena === true || formData.ma_byt_zverejnena === 1;

        if (maBytZverejnena) {
          // Chceme zveÅ™ejnit â†’ pÅ™idat UVEREJNIT
          if (!workflowStates.includes('UVEREJNIT')) {
            // OdstranÃ­me pÅ™Ã­padnÃ© NEUVEREJNIT/UVEREJNENA pro konzistenci
            workflowStates = workflowStates.filter(s => s !== 'NEUVEREJNIT' && s !== 'UVEREJNENA');
            workflowStates.push('UVEREJNIT');
            addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav UVEREJNIT (ma_byt_zverejnena = true)');
          }

          // âœ… NOVÃ‰: Pokud je UVEREJNIT a zÃ¡roveÅˆ jsou vyplnÄ›nÃ© datum + IDDT â†’ posun na UVEREJNENA
          if (workflowStates.includes('UVEREJNIT') && formData.dt_zverejneni && formData.registr_iddt) {
            // Odstranit UVEREJNIT (uÅ¾ je dokonÄeno)
            workflowStates = workflowStates.filter(s => s !== 'UVEREJNIT');
            // PÅ™idat UVEREJNENA â†’ posun do FÃZE 6
            if (!workflowStates.includes('UVEREJNENA')) {
              workflowStates.push('UVEREJNENA');
              addDebugLog('info', 'SAVE', 'workflow-update', 'VyplnÄ›n registr smluv (datum + IDDT) â†’ odstranÄ›n UVEREJNIT â†’ pÅ™idÃ¡n UVEREJNENA â†’ FÃZE 6');
            }
          }
        } else {
          // NemÃ¡ bÃ½t zveÅ™ejnÄ›no (false, 0, undefined, null) â†’ pÅ™idat NEUVEREJNIT
          workflowStates = workflowStates.filter(s => s !== 'UVEREJNIT' && s !== 'UVEREJNENA');
          if (!workflowStates.includes('NEUVEREJNIT')) {
            workflowStates.push('NEUVEREJNIT');
            addDebugLog('info', 'SAVE', 'workflow-update', `PÅ™idÃ¡n stav NEUVEREJNIT (ma_byt_zverejnena = ${formData.ma_byt_zverejnena}) â†’ pÅ™ejÃ­t na FAKTURACE`);
          }
        }
      }

      // Pokud POTVRZENA zmizÃ­ nebo je stornovÃ¡no, odstranit jakÃ©koliv zveÅ™ejÅˆovacÃ­ stavy
      if (!workflowStates.includes('POTVRZENA') || formData.stav_stornovano) {
        workflowStates = workflowStates.filter(s => !['UVEREJNIT', 'NEUVEREJNIT', 'UVEREJNENA'].includes(s));
        addDebugLog('info', 'SAVE', 'workflow-update', 'OdebrÃ¡ny zveÅ™ejÅˆovacÃ­ stavy (nenÃ­ POTVRZENA nebo je stornovÃ¡no)');
      }

      // UrÄit reÅ¾im platby (POKLADNA vs FAKTURA) - pouÅ¾ito pro workflow vÄ›tvenÃ­
      const isPlatbaPokladnaObj = formData.financovani?.platba === 'pokladna';
      const isPlatbaPokladnaDodavatel = formData.dodavatel_zpusob_potvrzeni?.platba === 'pokladna';
      const isPokladna = isPlatbaPokladnaObj || isPlatbaPokladnaDodavatel;

      // ðŸ†• POKLADNA: Po ODESLANA automaticky pÅ™idat VECNA_SPRAVNOST (pÅ™eskoÄÃ­ POTVRZENÃ, REGISTR, FAKTURACI)
      // Pro POKLADNA skÃ¡Äeme pÅ™Ã­mo z FÃZE 3 (ODESLANA) do FÃZE 7 (VECNA_SPRAVNOST)
      if (isPokladna &&
          (workflowStates.includes('ODESLANA') ||
           workflowStates.includes('POTVRZENA') ||
           workflowStates.includes('UVEREJNENA') ||
           workflowStates.includes('NEUVEREJNIT')) &&
          !formData.stav_stornovano) {
        if (!workflowStates.includes('VECNA_SPRAVNOST')) {
          workflowStates.push('VECNA_SPRAVNOST');
          addDebugLog('info', 'SAVE', 'workflow-update', 'ðŸª ReÅ¾im POKLADNA â†’ pÅ™idÃ¡n stav VECNA_SPRAVNOST (pÅ™eskoÄeny fÃ¡ze 4-6) â†’ FÃZE 7/8');
        }
      }

      // 8. FAKTURACE - pÅ™i pÅ™idÃ¡nÃ­ faktury (pouze kdyÅ¾ NENÃ pokladna)

      if (!isPokladna && formData.faktury && formData.faktury.length > 0 && !formData.stav_stornovano) {
        if (!workflowStates.includes('FAKTURACE')) {
          workflowStates.push('FAKTURACE');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav FAKTURACE â†’ FÃZE 6/8');
        }

        // âœ… Automaticky pÅ™idat VECNA_SPRAVNOST (vÄ›cnÃ¡ kontrola) po FAKTURACI
        if (workflowStates.includes('FAKTURACE') && !workflowStates.includes('VECNA_SPRAVNOST')) {
          workflowStates.push('VECNA_SPRAVNOST');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav VECNA_SPRAVNOST - faktury uloÅ¾eny â†’ FÃZE 7/8 (VÄ›cnÃ¡ kontrola)');
        }
      } else if (!formData.faktury || formData.faktury.length === 0 || isPokladna) {
        // Pokud nejsou faktury NEBO je pokladna, odeber FAKTURACE a VECNA_SPRAVNOST
        const hadFakturace = workflowStates.includes('FAKTURACE');
        workflowStates = workflowStates.filter(s => s !== 'FAKTURACE' && s !== 'VECNA_SPRAVNOST');
        if (hadFakturace && isPokladna) {
          addDebugLog('info', 'SAVE', 'workflow-update', 'OdebrÃ¡n stav FAKTURACE a VECNA_SPRAVNOST (reÅ¾im POKLADNA)');
        }
      }

      // 8.5. ZKONTROLOVANA - POUZE pokud VÅ ECHNY faktury majÃ­ potvrzenou per-invoice vÄ›cnou sprÃ¡vnost
      // âœ… NOVÃ LOGIKA: Kontrola per-invoice checkboxÅ¯ pro KAÅ½DOU fakturu
      const allFakturyVecneSpravny = (formData.faktury || []).length > 0 && 
        (formData.faktury || []).every(f => f.vecna_spravnost_potvrzeno === 1 || f.vecna_spravnost_potvrzeno === true);
      
      if (allFakturyVecneSpravny && !formData.stav_stornovano) {
        if (!workflowStates.includes('ZKONTROLOVANA')) {
          workflowStates.push('ZKONTROLOVANA');
          addDebugLog('info', 'SAVE', 'workflow-update', `âœ… VÅ ECHNY faktury (${formData.faktury.length}x) majÃ­ potvrzenou vÄ›cnou sprÃ¡vnost â†’ pÅ™idÃ¡n stav ZKONTROLOVANA â†’ FÃZE 8/8`);
        }
      } else {
        // âœ… Odebrat ZKONTROLOVANA pokud NENÃ potvrzena vÄ›cnÃ¡ sprÃ¡vnost VÅ ECH faktur
        // Automaticky se vrÃ¡tÃ­ na VECNA_SPRAVNOST â†’ FÃZE 7/8
        const hadZkontrolovana = workflowStates.includes('ZKONTROLOVANA');
        workflowStates = workflowStates.filter(s => s !== 'ZKONTROLOVANA');
        if (hadZkontrolovana) {
          const nepotvrzeneFaktury = (formData.faktury || []).filter(f => !(f.vecna_spravnost_potvrzeno === 1 || f.vecna_spravnost_potvrzeno === true)).length;
          addDebugLog('info', 'SAVE', 'workflow-update', `ðŸ”“ NEJSOU potvrzeny vÅ¡echny faktury (${nepotvrzeneFaktury}x chybÃ­) â†’ odebrÃ¡n stav ZKONTROLOVANA â†’ nÃ¡vrat na FÃZI 7/8`);
        }
      }

      // 9. DOKONCENA - pÅ™i potvrzenÃ­ finÃ¡lnÃ­ho dokonÄenÃ­ checkboxem
      // âœ… BEZ kontroly na faktury - objednÃ¡vka mÅ¯Å¾e bÃ½t dokonÄenÃ¡ i bez faktur
      // âœ… Kontrola: obÄ› checkboxy potvrzeny
      const jeDokonceniPotvrzeno = formData.potvrzeni_dokonceni_objednavky === 1 || formData.potvrzeni_dokonceni_objednavky === true;
      // âœ… OPRAVA: Kontrolovat AKTUÃLNÃ stav workflowStates (po pÅ™idÃ¡nÃ­ ZKONTROLOVANA vÃ½Å¡e)
      const jeVecnaSprÃ¡vnostPotvrzena = workflowStates.includes('ZKONTROLOVANA');

      if (jeDokonceniPotvrzeno && jeVecnaSprÃ¡vnostPotvrzena && !formData.stav_stornovano) {
        if (!workflowStates.includes('DOKONCENA')) {
          workflowStates.push('DOKONCENA');
          addDebugLog('info', 'SAVE', 'workflow-update', 'PÅ™idÃ¡n stav DOKONCENA - objednÃ¡vka finÃ¡lnÄ› dokonÄena');
        }

        // ðŸ†• Automaticky nastavit dokoncil_id a dt_dokonceni pÅ™i prvnÃ­m potvrzenÃ­
        if (!formData.dokoncil_id) {
          orderData.dokoncil_id = user_id;
          orderData.dt_dokonceni = getMySQLDateTime(); // âœ… JEDNOTNÃ FORMÃT
          addDebugLog('info', 'SAVE', 'dokonceni', `Nastaveno dokonÄenÃ­ objednÃ¡vky uÅ¾ivatelem ${user_id}`);
        }
      } else {
        // Odstranit DOKONCENA pokud checkbox nenÃ­ zaÅ¡krtnutÃ½
        workflowStates = workflowStates.filter(s => s !== 'DOKONCENA');
      }

      // FINÃLNÃ KONTROLA A ÃšPRAVY
      // OdstraÅˆ duplicity (zachovej poÅ™adÃ­)
      workflowStates = [...new Set(workflowStates)];

      // ðŸ”§ KRITICKÃ OPRAVA: Odstranit STARÃ‰/NEPLATNÃ‰ workflow stavy
      // Odstranit K_DOKONCENI - jiÅ¾ se nepouÅ¾Ã­vÃ¡, nahrazeno ZKONTROLOVANA + DOKONCENA
      workflowStates = workflowStates.filter(s => s !== 'K_DOKONCENI');

      // BEZPEÄŒNOSTNÃ KONTROLA: nikdy prÃ¡zdnÃ© pole
      if (workflowStates.length === 0) {
        workflowStates = ['NOVA'];
        addDebugLog('warning', 'SAVE', 'workflow-fallback', 'PrÃ¡zdnÃ© workflow - fallback na [NOVA]');
      }

      // SeÅ™adit stavy podle logickÃ©ho poÅ™adÃ­ (zachovat vÃ½znam workflow)
      const workflowOrder = [
        'NOVA', 'ODESLANA_KE_SCHVALENI', 'CEKA_SE', 'ZAMITNUTA', 'SCHVALENA',
        'ROZPRACOVANA', 'ODESLANA', 'ZRUSENA', 'POTVRZENA', 'UVEREJNIT', 'NEUVEREJNIT', 'UVEREJNENA', 'FAKTURACE', 'VECNA_SPRAVNOST', 'ZKONTROLOVANA', 'DOKONCENA'
      ];

      workflowStates.sort((a, b) => {
        const indexA = workflowOrder.indexOf(a);
        const indexB = workflowOrder.indexOf(b);
        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
      });

      orderData.stav_workflow_kod = JSON.stringify(workflowStates);

      // ðŸ”§ KRITICKÃ‰: Nastavit stav_objednavky podle poslednÃ­ho workflow kÃ³du
      // âœ… POUÅ½ÃVÃ ÄŒÃSELNÃK Z DB mÃ­sto hardcoded WORKFLOW_STATES
      if (workflowStates.length > 0) {
        const lastWorkflowCode = workflowStates[workflowStates.length - 1];

        // ðŸ†• SPRÃVNÄš: Najdi stav v ÄÃ­selnÃ­ku z DB
        const stavZCiselniku = stavyWorkflowMap[lastWorkflowCode];

        if (stavZCiselniku) {
          // âœ… PouÅ¾ij hodnotu z DB ÄÃ­selnÃ­ku
          orderData.stav_objednavky = stavZCiselniku.nazev;
          addDebugLog('info', 'SAVE', 'stav-objednavky', `âœ… Nastaveno stav_objednavky: "${orderData.stav_objednavky}" (z DB ÄÃ­selnÃ­ku pro workflow: ${lastWorkflowCode})`);
        } else {
          // âš ï¸ FALLBACK: Pokud ÄÃ­selnÃ­k nenÃ­ naÄtenÃ½ nebo chybÃ­ kÃ³d, pouÅ¾ij hardcoded
          const workflowState = WORKFLOW_STATES[lastWorkflowCode];
          orderData.stav_objednavky = workflowState ? workflowState.name : lastWorkflowCode;
          addDebugLog('warning', 'SAVE', 'stav-objednavky-fallback', `âš ï¸ ÄŒÃ­selnÃ­k neobsahuje "${lastWorkflowCode}" - pouÅ¾it fallback: "${orderData.stav_objednavky}"`);
        }
      } else {
        orderData.stav_objednavky = 'NovÃ¡';
        addDebugLog('warning', 'SAVE', 'stav-objednavky-fallback', 'PrÃ¡zdnÃ© workflow stavy - stav_objednavky: "NovÃ¡"');
      }

      // ðŸ†• VÅ½DY pÅ™edat workflow tracking polÃ­ (pokud existujÃ­ v formData) - KROMÄš odesilatel_id
      // odesilatel_id se nastavuje POUZE pÅ™i zaÅ¡krtnutÃ­ checkboxu "Odeslano" (viz nÃ­Å¾e)
      // OstatnÃ­ pole se zachovajÃ­ pÅ™i kaÅ¾dÃ©m UPDATE

      // ðŸ”„ BREAKING CHANGE: potvrdil_id â†’ dodavatel_potvrdil_id
      if (formData.dodavatel_potvrdil_id !== undefined) orderData.dodavatel_potvrdil_id = formData.dodavatel_potvrdil_id;

      // ðŸ†• NOVÃ WORKFLOW POLE (26.10.2025):
      // Registr smluv - ðŸ†• VÅ½DY nastavit zverejnil_id pÅ™i uloÅ¾enÃ­ pokud existuje dt_zverejneni a registr_iddt
      if (formData.dt_zverejneni && formData.registr_iddt) {
        // Pokud jeÅ¡tÄ› nenÃ­ zverejnil_id, nastav aktuÃ¡lnÃ­ho uÅ¾ivatele
        if (!formData.zverejnil_id) {
          orderData.zverejnil_id = user_id;
          addDebugLog('info', 'SAVE', 'registr-tracking', `Automaticky nastaven zverejnil_id: ${user_id}`);
        } else {
          // Zachovat existujÃ­cÃ­ hodnotu
          orderData.zverejnil_id = formData.zverejnil_id;
        }
      } else if (formData.zverejnil_id !== undefined) {
        // Zachovat hodnotu pokud nenÃ­ podmÃ­nka splnÄ›na
        orderData.zverejnil_id = formData.zverejnil_id;
      }

      if (formData.dt_zverejneni_potvrzeni) orderData.dt_zverejneni_potvrzeni = formData.dt_zverejneni_potvrzeni;

      // VÄ›cnÃ¡ sprÃ¡vnost - FÃZE 7 (vÅ¾dy uklÃ¡dat, i null hodnoty)
      orderData.potvrdil_vecnou_spravnost_id = formData.potvrdil_vecnou_spravnost_id !== undefined ? formData.potvrdil_vecnou_spravnost_id : null;
      orderData.dt_potvrzeni_vecne_spravnosti = formData.dt_potvrzeni_vecne_spravnosti || null;

      // Fakturace - ðŸ†• VÅ½DY aktualizovat pÅ™i uloÅ¾enÃ­ ve fÃ¡zi fakturace (poslednÃ­ uÅ¾ivatel)
      if (formData.faktury && formData.faktury.length > 0 && workflowStates.includes('FAKTURACE')) {
        // Aktualizovat fakturant_id a dt_faktura_pridana pÅ™i kaÅ¾dÃ©m uloÅ¾enÃ­ ve fÃ¡zi fakturace
        orderData.fakturant_id = user_id;
        orderData.dt_faktura_pridana = getMySQLDateTime(); // âœ… JEDNOTNÃ FORMÃT
        addDebugLog('info', 'SAVE', 'fakturace-tracking', `AktualizovÃ¡n fakturant_id: ${user_id}, dt_faktura_pridana: ${orderData.dt_faktura_pridana}`);
      } else {
        // Zachovat existujÃ­cÃ­ hodnoty pokud nejsme ve fÃ¡zi fakturace
        if (formData.fakturant_id !== undefined) orderData.fakturant_id = formData.fakturant_id;
        if (formData.dt_faktura_pridana) orderData.dt_faktura_pridana = formData.dt_faktura_pridana;
      }

      // DokonÄenÃ­ - FÃZE 8 (vÅ¾dy uklÃ¡dat, i null hodnoty)
      orderData.dokoncil_id = formData.dokoncil_id !== undefined ? formData.dokoncil_id : null;
      orderData.dt_dokonceni = formData.dt_dokonceni || null;
      orderData.dokonceni_poznamka = formData.dokonceni_poznamka !== undefined ? formData.dokonceni_poznamka : '';
      // ðŸ”§ FIX: Konvertovat prÃ¡zdnÃ½ string na 0, aby MySQL nepÅ™ijal nevalidnÃ­ hodnotu
      const dokonceniValue = formData.potvrzeni_dokonceni_objednavky;
      orderData.potvrzeni_dokonceni_objednavky = (dokonceniValue === 1 || dokonceniValue === true) ? 1 : 0;

      addDebugLog('info', 'SAVE', 'tracking-fields', `Workflow tracking pole: dodavatel_potvrdil=${orderData.dodavatel_potvrdil_id}, zverejnil=${orderData.zverejnil_id}, vecna_spravnost=${orderData.potvrdil_vecnou_spravnost_id}, fakturant=${orderData.fakturant_id}, dokoncil=${orderData.dokoncil_id}`);

      // Storno metadata - pouze pokud je stornovÃ¡no (dt_odeslani se Å™eÅ¡Ã­ vÃ½Å¡e)
      if (formData.stav_stornovano) {
        if (formData.storno_uzivatel_id) orderData.storno_uzivatel_id = formData.storno_uzivatel_id;
        if (formData.storno_provedl) orderData.storno_provedl = formData.storno_provedl;
        // odeslani_storno_duvod se Å™eÅ¡Ã­ v sekci dt_odeslani vÃ½Å¡e
        // datum_storna se mapuje na dt_odeslani vÃ½Å¡e
      }

      // dt_odeslani se pouÅ¾Ã­vÃ¡ jak pro odeslÃ¡nÃ­, tak pro storno
      // âœ… DÅ®LEÅ½ITÃ‰: Workflow data mÄ›nit POUZE pokud je sekce ODEMÄŒENÃ!
      if (formData.stav_odeslano || formData.stav_stornovano) {
        // Kontrola: je sekce FÃZE 3 odemÄenÃ¡?
        const isPhase3Unlocked = !shouldLockPhase3Sections;

        if (isPhase3Unlocked) {
          // Sekce je ODEMÄŒENÃ - mÅ¯Å¾eme mÄ›nit workflow data
          // âœ… odesilatel_id nastavit POUZE pokud jeÅ¡tÄ› neexistuje (pÅ™i prvnÃ­m odeslÃ¡nÃ­/stornu)
          if (!formData.odesilatel_id && user_id) {
            orderData.odesilatel_id = user_id;
            addDebugLog('info', 'SAVE', 'odesilatel-tracking-new', `UloÅ¾en NOVÃ odesilatel_id: ${user_id} (prvnÃ­ odeslÃ¡nÃ­/storno)`);
          } else if (formData.odesilatel_id) {
            // odesilatel_id jiÅ¾ existuje - ZACHOVAT pÅ¯vodnÃ­ hodnotu
            orderData.odesilatel_id = formData.odesilatel_id;
            addDebugLog('info', 'SAVE', 'odesilatel-tracking-preserve', `ZACHOVÃN pÅ¯vodnÃ­ odesilatel_id: ${formData.odesilatel_id}`);
          }

          // Pro ODESLÃNÃ: nastavit datum odeslÃ¡nÃ­ a smazat dÅ¯vod storna
          if (formData.stav_odeslano && !formData.stav_stornovano) {
            // âœ… Datum odeslÃ¡nÃ­ nastavit POUZE pokud jeÅ¡tÄ› neexistuje (pÅ™i prvnÃ­m odeslÃ¡nÃ­)
            if (!formData.dt_odeslani) {
              const datumOdeslani = formData.datum_odeslani || getMySQLDate(); // âœ… JEDNOTNÃ FORMÃT
              orderData.dt_odeslani = datumOdeslani;
              addDebugLog('info', 'SAVE', 'odeslani-datum-new', `Nastaveno NOVÃ‰ dt_odeslani: ${datumOdeslani}`);
            } else {
              // Datum jiÅ¾ existuje - ZACHOVAT pÅ¯vodnÃ­ hodnotu
              orderData.dt_odeslani = formData.dt_odeslani;
              addDebugLog('info', 'SAVE', 'odeslani-datum-preserve', `ZACHOVÃNO pÅ¯vodnÃ­ dt_odeslani: ${formData.dt_odeslani}`);
            }
            orderData.odeslani_storno_duvod = ''; // Vymazat dÅ¯vod storna pÅ™i odeslÃ¡nÃ­
          }
          // Pro STORNO: nastavit datum storna a zachovat dÅ¯vod storna
          else if (formData.stav_stornovano) {
            // âœ… Datum storna nastavit POUZE pokud jeÅ¡tÄ› neexistuje (pÅ™i prvnÃ­m stornovÃ¡nÃ­)
            if (!formData.dt_odeslani) {
              const datumStorna = formData.datum_storna || getMySQLDate(); // âœ… JEDNOTNÃ FORMÃT
              orderData.dt_odeslani = datumStorna;
              addDebugLog('info', 'SAVE', 'storno-datum-new', `Nastaveno NOVÃ‰ dt_odeslani pro STORNO: ${datumStorna}`);
            } else {
              // Datum jiÅ¾ existuje - ZACHOVAT pÅ¯vodnÃ­ hodnotu
              orderData.dt_odeslani = formData.dt_odeslani;
              addDebugLog('info', 'SAVE', 'storno-datum-preserve', `ZACHOVÃNO pÅ¯vodnÃ­ dt_odeslani pro STORNO: ${formData.dt_odeslani}`);
            }
            if (formData.odeslani_storno_duvod) orderData.odeslani_storno_duvod = formData.odeslani_storno_duvod;

            addDebugLog('info', 'SAVE', 'storno-datum', `UloÅ¾eno STORNO s dÅ¯vodem: ${formData.odeslani_storno_duvod}`);
          }
        } else {
          // Sekce je ZAMÄŒENÃ - ZACHOVAT vÅ¡echny existujÃ­cÃ­ workflow hodnoty beze zmÄ›ny!
          if (formData.odesilatel_id) orderData.odesilatel_id = formData.odesilatel_id;
          if (formData.dt_odeslani) orderData.dt_odeslani = formData.dt_odeslani;
          if (formData.odeslani_storno_duvod) orderData.odeslani_storno_duvod = formData.odeslani_storno_duvod;
          addDebugLog('info', 'SAVE', 'odeslani-locked', `FÃZE 3 ZAMÄŒENÃ - workflow data zachovÃ¡na beze zmÄ›ny`);
        }
      } else {
        // ðŸ†• Pokud NENÃ zaÅ¡krtnutÃ© ANI "Odeslano" ANI "StornovÃ¡no" â†’ vymazat odesilatel_id
        // (objednÃ¡vka se vracÃ­ do stavu "neodeslÃ¡na")
        orderData.odesilatel_id = null;
        addDebugLog('info', 'SAVE', 'odesilatel-reset', `VymazÃ¡n odesilatel_id - objednÃ¡vka nenÃ­ odeslÃ¡na ani stornovÃ¡na`);
      }

      // âœ… OPRAVA: dodavatel_zpusob_potvrzeni uklÃ¡dat pokud je workflow >= POTVRZENA
      // Pokud je sekce ODEMÄŒENÃ (editovatelnÃ¡) â†’ uklÃ¡dat NOVÃ‰ hodnoty z formulÃ¡Å™e
      // Pokud je sekce ZAMÄŒENÃ â†’ zachovat hodnotu z DB
      const hasPotvrzena = existingStates.includes('POTVRZENA') || workflowStates.includes('POTVRZENA');
      
      if (hasPotvrzena) {
        // FÃZE 4+ - uklÃ¡dat podle toho jestli je sekce odemÄenÃ¡
        const isSectionUnlocked = !shouldLockPhase4to6Sections;
        
        if (isSectionUnlocked) {
          // âœ… SEKCE ODEMÄŒENÃ â†’ uklÃ¡dat NOVÃ‰ hodnoty z formulÃ¡Å™e
          const potvrzeniData = formData.dodavatel_zpusob_potvrzeni || {};
          const potvrzeni = potvrzeniData.potvrzeni || 'NE';
          
          const dataToSave = {
            potvrzeni: potvrzeni,
            zpusoby: Array.isArray(potvrzeniData.zpusoby) ? potvrzeniData.zpusoby : [],
            platba: potvrzeniData.platba || ''
          };
          
          orderData.dodavatel_zpusob_potvrzeni = JSON.stringify(dataToSave);
          
          addDebugLog('info', 'SAVE', 'dodavatel-potvrzeni-unlocked', `Sekce odemÄenÃ¡ - UloÅ¾eno: ${orderData.dodavatel_zpusob_potvrzeni}`);
        } else {
          // ðŸ”’ SEKCE ZAMÄŒENÃ â†’ ZACHOVAT hodnotu z DB (nebo z formData pokud original chybÃ­)
          if (formData.dodavatel_zpusob_potvrzeni_original) {
            orderData.dodavatel_zpusob_potvrzeni = formData.dodavatel_zpusob_potvrzeni_original;
          } else if (formData.dodavatel_zpusob_potvrzeni) {
            // Fallback: pokud original chybÃ­, pouÅ¾ij aktuÃ¡lnÃ­ hodnotu
            orderData.dodavatel_zpusob_potvrzeni = JSON.stringify(formData.dodavatel_zpusob_potvrzeni);
          }
          addDebugLog('info', 'SAVE', 'dodavatel-potvrzeni-locked', `Sekce zamÄenÃ¡ - Hodnota zachovÃ¡na`);
        }
      } else {
        // FÃZE 3 nebo niÅ¾Å¡Ã­ - NEPOSÃLAT pole
        addDebugLog('info', 'SAVE', 'dodavatel-potvrzeni-skip', `FÃZE 3- - PÅ™eskoÄeno`);
      }

      // Akceptace a zveÅ™ejnÄ›nÃ­
      // âœ… OPRAVA: Konvertovat datetime hodnoty do MySQL formÃ¡tu (odstranit timezone a ms)
      if (formData.dt_akceptace) {
        // Pokud obsahuje 'T' (ISO format), extrahovat jen datum nebo datum+Äas bez timezone
        const akceptaceValue = String(formData.dt_akceptace);
        if (akceptaceValue.includes('T')) {
          // ISO format: 2025-12-05T16:57:42.491Z -> 2025-12-05 nebo 2025-12-05 16:57:42
          orderData.dt_akceptace = akceptaceValue.split('.')[0].replace('T', ' ').replace('Z', '');
        } else {
          orderData.dt_akceptace = akceptaceValue;
        }
      }
      if (formData.dt_zverejneni) {
        const zverejneniValue = String(formData.dt_zverejneni);
        if (zverejneniValue.includes('T')) {
          orderData.dt_zverejneni = zverejneniValue.split('.')[0].replace('T', ' ').replace('Z', '');
        } else {
          orderData.dt_zverejneni = zverejneniValue;
        }
      }
      if (formData.registr_iddt) orderData.registr_iddt = formData.registr_iddt;

      // âŒ SMAZÃNO: dt_splatnosti patÅ™Ã­ k FAKTUÅ˜E, ne k objednÃ¡vce!
      // Pole dt_splatnosti neexistuje v tabulce objednavky25, zpÅ¯sobovalo SQL error

      // âœ… KRITICKÃ‰: dt_objednavky = aktuÃ¡lnÃ­ datum a Äas VÅ½DY pÅ™i kaÅ¾dÃ©m uloÅ¾enÃ­ (CREATE i UPDATE)
      // Toto pole slouÅ¾Ã­ jako timestamp poslednÃ­ zmÄ›ny objednÃ¡vky
      // âœ… OPRAVA: PouÅ¾Ã­t LOKÃLNÃ Äas, ne UTC!
      const currentDateTime = getMySQLDateTime(); // âœ… LOKÃLNÃ ÄŒAS
      orderData.dt_objednavky = currentDateTime;
      
      if (!isOrderSavedToDB) {
        addDebugLog('info', 'SAVE', 'datum-vytvoreni', `NovÃ¡ objednÃ¡vka - dt_objednavky: ${currentDateTime}`);
      } else {
        addDebugLog('info', 'SAVE', 'datum-zmeny', `UPDATE objednÃ¡vky - dt_objednavky aktualizovÃ¡no na: ${currentDateTime}`);
      }

      // schvalovatel_id - pro NOVA neposÃ­lat vÅ¯bec, jinak musÃ­ bÃ½t platnÃ© ÄÃ­slo
      if (!workflowStates.includes('NOVA')) {
        // Pouze pokud NENÃ stav NOVA a mÃ¡me platnÃ© ID
        if (formData.schvalovatel_id && formData.schvalovatel_id > 0) {
          orderData.schvalovatel_id = formData.schvalovatel_id;
        }
        // âš ï¸ Pokud nenÃ­ NOVA ale schvalovatel_id chybÃ­, nechÃ¡me pole prÃ¡zdnÃ©
        // Backend si poradÃ­ s tÃ­m, Å¾e pole nenÃ­ v requestu (partial update)
      }
      // âš ï¸ Pro stav NOVA: NEPOSÃLAT schvalovatel_id vÅ¯bec (ani null, ani '')

      // ðŸ’° FAKTURY - poslat do payload pro uloÅ¾enÃ­ s objednÃ¡vkou (Backend si poradÃ­ s uloÅ¾enÃ­m)
      // Faktury jsou v samostatnÃ© tabulce, ale BE potÅ™ebuje data pro update/create pÅ™es svÃ© faktury API
      if (formData.faktury && formData.faktury.length > 0) {
        orderData.faktury = formData.faktury.map((faktura, index) => {
          let strediskaArray = [];
          if (faktura.fa_strediska_kod && Array.isArray(faktura.fa_strediska_kod) && faktura.fa_strediska_kod.length > 0) {
            // Extrahuj jen kÃ³dy (kod_stavu) z objektÅ¯
            strediskaArray = faktura.fa_strediska_kod.map(item => {
              if (typeof item === 'object' && item.kod_stavu) {
                return item.kod_stavu; // Objekt â†’ extrahuj kod_stavu
              }
              return item; // UÅ¾ je string â†’ pouÅ¾ij pÅ™Ã­mo
            });

            // ðŸ› DEBUG: Transformace stÅ™edisek
          }

          // âœ… KRITICKÃ‰: Pokud mÃ¡ faktura reÃ¡lnÃ© ID (ne temp-), musÃ­me ho poslat pro UPDATE!
          const hasRealId = faktura.id && !String(faktura.id).startsWith('temp-');
          const fakturaId = hasRealId ? Number(faktura.id) : null;

          const fakturaData = {
            id: fakturaId,                                                    // âœ… POSLAT ID - pokud je NULL, BE vytvoÅ™Ã­ novou, jinak UPDATE
            fa_castka: String(parseFloat(faktura.fa_castka) || 0),           // âœ… V2 API: VÅ½DY STRING pro pÅ™esnost!
            fa_cislo_vema: faktura.fa_cislo_vema || '',                       // POVINNÃ‰ - ÄÃ­slo faktury (mÅ¯Å¾e bÃ½t '')
            fa_dorucena: 1,                                                   // POVINNÃ‰ - 0 nebo 1 (boolean)
            fa_datum_vystaveni: faktura.fa_datum_vystaveni || new Date().toISOString().split('T')[0], // DÅ®LEÅ½ITÃ‰ - datum vystavenÃ­
            fa_datum_splatnosti: faktura.fa_splatnost || faktura.fa_datum_splatnosti || '', // âœ… FE -> DB: fa_splatnost -> fa_datum_splatnosti (obousmÄ›rnÃ½ mapping)
            fa_datum_doruceni: (typeof faktura.fa_datum_doruceni === 'string' && faktura.fa_datum_doruceni.match(/^\d{4}-\d{2}-\d{2}$/))
              ? faktura.fa_datum_doruceni
              : new Date().toISOString().split('T')[0], // âœ… OPRAVA: PouÅ¾Ã­t jen pokud je validnÃ­ datum
            fa_strediska_kod: strediskaArray,                                 // âœ… POLE KÃ“DÅ®: ["KLADNO","BENESOV","BEROUN"]
            fa_poznamka: faktura.fa_poznamka || '',                           // VOLITELNÃ‰ - poznÃ¡mka
            // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost (FÃZE 7/8) - 1:1 DB mapping
            vecna_spravnost_umisteni_majetku: faktura.vecna_spravnost_umisteni_majetku || '',
            vecna_spravnost_poznamka: faktura.vecna_spravnost_poznamka || '',
            vecna_spravnost_potvrzeno: (faktura.vecna_spravnost_potvrzeno === 1 || faktura.vecna_spravnost_potvrzeno === true) ? 1 : 0,
            potvrdil_vecnou_spravnost_id: faktura.potvrdil_vecnou_spravnost_id || null,
            dt_potvrzeni_vecne_spravnosti: faktura.dt_potvrzeni_vecne_spravnosti || null,
            rozsirujici_data: faktura._isPokladna
              ? {
                  // ðŸ†• POKLADNÃ DOKLAD - JEN novÃ¡ data (BEZ spreadu!)
                  typ_platby: 'pokladna',
                  pokladni_doklad: {
                    datum_vytvoreni: faktura.dt_vytvoreni || new Date().toISOString(),
                    poznamka: faktura.fa_poznamka || '',
                    prilohy_count: faktura.attachments?.length || 0,
                    vytvoril_uzivatel_id: faktura.vytvoril_uzivatel_id,
                    vytvoril_jmeno: faktura.vytvoril_jmeno
                  }
                }
              : faktura._fromISDOC && faktura._isdoc_polozky
                ? {
                    // ISDOC FAKTURA - JEN novÃ¡ data (BEZ spreadu!)
                    typ_platby: 'faktura',
                    isdoc: {
                      cislo_faktury: faktura.fa_cislo_vema,
                      datum_vystaveni: faktura.fa_datum_vystaveni,
                      datum_splatnosti: faktura.fa_datum_splatnosti,
                      castka_s_dph: faktura.fa_castka,
                      castka_bez_dph: faktura.fa_castka_bez_dph,
                      dph_celkem: faktura.fa_dph,
                      polozky: faktura._isdoc_polozky,
                      dodavatel: faktura._isdoc_dodavatel
                    }
                  }
                : {
                    // STANDARDNÃ FAKTURA - minimÃ¡lnÃ­ data
                    typ_platby: 'faktura'
                  }
          };
          
          // ðŸ” DEBUG LOG - vÄ›cnÃ¡ sprÃ¡vnost pÅ™ed odeslÃ¡nÃ­m
          console.log('[VECNA-SAVE-DEBUG] Faktura #' + faktura.id, {
            vecna_spravnost_potvrzeno: fakturaData.vecna_spravnost_potvrzeno,
            potvrdil_vecnou_spravnost_id: fakturaData.potvrdil_vecnou_spravnost_id,
            dt_potvrzeni_vecne_spravnosti: fakturaData.dt_potvrzeni_vecne_spravnosti,
            SOURCE_faktura: {
              vecna_spravnost_potvrzeno: faktura.vecna_spravnost_potvrzeno,
              potvrdil_vecnou_spravnost_id: faktura.potvrdil_vecnou_spravnost_id,
              dt_potvrzeni_vecne_spravnosti: faktura.dt_potvrzeni_vecne_spravnosti
            }
          });
          
          return fakturaData;
        });
        addDebugLog('info', 'SAVE', 'faktury-transform', `PÅ™idÃ¡no ${formData.faktury.length} faktur do payload`);
        addDebugLog('info', 'SAVE', 'faktury-detail', `Detaily faktur: ${JSON.stringify(formData.faktury, null, 2)}`);
      } else {
        orderData.faktury = []; // PrÃ¡zdnÃ© pole = Å¾Ã¡dnÃ© faktury
        addDebugLog('info', 'SAVE', 'faktury-empty', 'Å½Ã¡dnÃ© faktury k uloÅ¾enÃ­');
      }
      // â„¹ï¸ POZNÃMKA: Backend si poradÃ­ s uloÅ¾enÃ­m faktur pÅ™es svÃ© faktury API
      //              Frontend jen pÅ™edÃ¡vÃ¡ data, BE Å™eÅ¡Ã­ persist do faktury25 tabulky
      
      let result;
      let orderId;              // Deklarace na Ãºrovni celÃ©ho bloku
      let orderNumber;          // Deklarace na Ãºrovni celÃ©ho bloku
      let updatedFormDataImmediate;  // Deklarace na Ãºrovni celÃ©ho bloku

      // âœ… hasOrderId je jiÅ¾ deklarovÃ¡n vÃ½Å¡e (pÅ™ed workflow logikou na Å™Ã¡dku ~6567)
      // POUÅ½IJ ho pro rozhodnutÃ­ INSERT vs UPDATE

      if (!hasOrderId) {
        // âœ¨ V2 API: PrvnÃ­ uloÅ¾enÃ­ - vytvoÅ™enÃ­ novÃ© objednÃ¡vky
        addDebugLog('info', 'SAVE-V2', 'create-start', 'VolÃ¡m createOrderV2()');

        // ðŸš¨ FÃZE 1: Omezit pole na pouze zÃ¡kladnÃ­ Ãºdaje (BEZ faktur!)
        if (currentPhase === 1) {
          const phase1Fields = [
            'uzivatel_id', 'objednatel_id', 'predmet', 'garant_uzivatel_id',
            'prikazce_id', 'strediska_kod', 'max_cena_s_dph', 'financovani',
            'druh_objednavky_kod', 'stav_workflow_kod', 'stav_objednavky', 'dt_objednavky'
          ];

          Object.keys(orderData).forEach(key => {
            if (!phase1Fields.includes(key)) {
              delete orderData[key];
            }
          });
        }

        // âš ï¸ prepareDataForAPI() se volÃ¡ automaticky uvnitÅ™ createOrderV2() - NEMÄšNIT ZNOVU!
        // const preparedData = prepareDataForAPI(orderData);  âŒ DUPLICITNÃ - jiÅ¾ se dÄ›lÃ¡ v createOrderV2()

        result = await createOrderV2(orderData, token, username);

        addDebugLog('info', 'SAVE-V2', 'create-success', `Order created: ID ${result.id}`);

        if (result.lock_info?.locked && !result.lock_info?.locked_by_user_id) {
          try {
            await unlockOrder25({ token, username, orderId: result.id });
            addDebugLog('info', 'SAVE-V2', 'auto-unlock', `Automaticky odemÄena objednÃ¡vka ${result.id} (byla zamÄenÃ¡ bez vlastnÃ­ka)`);
          } catch (unlockError) {
            addDebugLog('warning', 'SAVE-V2', 'auto-unlock-error', `Chyba pÅ™i odemykÃ¡nÃ­: ${unlockError.message}`);
          }
        }

        updatedFormDataImmediate = result;
        orderId = result.id;

        orderNumber = result.ev_cislo || result.cislo_objednavky || formData.ev_cislo;

        if (!orderNumber) {
          addDebugLog('error', 'SAVE-V2', 'missing-ev-cislo', 'Backend nevrÃ¡til evideÄnÃ­ ÄÃ­slo objednÃ¡vky');
        }

        // V2 API: faktury jsou pÅ™Ã­mo v result, ne v result.data
        const fakturyFromBE = result.faktury || [];

        // âœ… DEKLARACE FAKTUR S PÅ˜ÃLOHAMI - MIMO IF BLOK (aby byla dostupnÃ¡ i pozdÄ›ji)
        let fakturyWithAttachments = [];

        if (fakturyFromBE && Array.isArray(fakturyFromBE) && fakturyFromBE.length > 0) {
          // âœ… ZACHOVAT pÅ™Ã­lohy z formData pokud existujÃ­ (pÅ™ed uloÅ¾enÃ­m)
          const originalFaktury = formData.faktury || [];

          // âœ… NaÄÃ­st pÅ™Ã­lohy pro kaÅ¾dou fakturu z DB
          fakturyWithAttachments = await Promise.all(
            fakturyFromBE.map(async (fakturaFromDB) => {
              let attachments = [];

              // 1. NEJDÅ˜ÃV zkusit najÃ­t pÅ™Ã­lohy v pÅ¯vodnÃ­ch datech (pÅ™ed uloÅ¾enÃ­m)
              const originalFaktura = originalFaktury.find(f =>
                String(f.id) === String(fakturaFromDB.id) ||
                f.fa_cislo_vema === fakturaFromDB.fa_cislo_vema
              );

              if (originalFaktura && originalFaktura.attachments && originalFaktura.attachments.length > 0) {
                // PouÅ¾Ã­t pÅ™Ã­lohy z pÅ¯vodnÃ­ho formData
                attachments = originalFaktura.attachments;
              } else if (fakturaFromDB.id && !String(fakturaFromDB.id).startsWith('temp-')) {
                // 2. Pokud nejsou v pÅ¯vodnÃ­ch datech, naÄÃ­st z DB
                try {
                  const attachResponse = await listInvoiceAttachments(
                    fakturaFromDB.id,  // invoiceId
                    username,          // username
                    token,             // token
                    parsedInsertData.id  // orderId
                  );
                  attachments = attachResponse.data?.attachments || attachResponse.data || [];
                } catch (err) {
                }
              }

              // Parsovat ISDOC data z rozsirujici_data pokud existujÃ­
              const isdocData = fakturaFromDB.rozsirujici_data?.isdoc;

              // ðŸ”§ PARSOVÃNÃ STÅ˜EDISEK z DB JSON stringu na pole objektÅ¯
              let parsedStrediska = [];
              try {
                if (Array.isArray(fakturaFromDB.fa_strediska_kod)) {
                  parsedStrediska = fakturaFromDB.fa_strediska_kod;
                } else if (typeof fakturaFromDB.fa_strediska_kod === 'string') {
                  parsedStrediska = JSON.parse(fakturaFromDB.fa_strediska_kod || '[]');
                }

                // âœ… Zachovat celÃ© objekty {kod_stavu, nazev_stavu}, ne jen kÃ³dy + validace
                parsedStrediska = parsedStrediska.map(item => {
                  if (typeof item === 'object' && item.kod_stavu) {
                    // Zkontroluj zda existuje v aktivnÃ­ch
                    const exists = strediskaOptions.find(opt =>
                      opt.kod_stavu === item.kod_stavu || opt.kod === item.kod_stavu || opt.value === item.kod_stavu
                    );
                    if (exists) {
                      return item;
                    }
                    // NeaktivnÃ­ stÅ™edisko â†’ nahradit za 100 SprÃ¡va Kladno
                    const fallback = strediskaOptions.find(opt =>
                      opt.kod_stavu === "100" || opt.kod === "100" || opt.value === "100"
                    );
                    return fallback ? {
                      kod_stavu: fallback.kod_stavu || fallback.kod || fallback.value,
                      nazev_stavu: fallback.nazev_stavu || fallback.nazev || fallback.label
                    } : { kod_stavu: "100", nazev_stavu: "100 SprÃ¡va Kladno" };
                  }
                  // String â†’ zkontroluj zda existuje
                  const stredisko = strediskaOptions.find(opt =>
                    opt.kod_stavu === item || opt.kod === item || opt.value === item
                  );
                  if (stredisko) {
                    return {
                      kod_stavu: stredisko.kod_stavu || stredisko.kod || stredisko.value,
                      nazev_stavu: stredisko.nazev_stavu || stredisko.nazev || stredisko.label
                    };
                  }
                  // NeaktivnÃ­ stÅ™edisko â†’ nahradit za 100 SprÃ¡va Kladno
                  const fallback = strediskaOptions.find(opt =>
                    opt.kod_stavu === "100" || opt.kod === "100" || opt.value === "100"
                  );
                  return fallback ? {
                    kod_stavu: fallback.kod_stavu || fallback.kod || fallback.value,
                    nazev_stavu: fallback.nazev_stavu || fallback.nazev || fallback.label
                  } : { kod_stavu: "100", nazev_stavu: "100 SprÃ¡va Kladno" };
                });

                // ðŸ› DEBUG: Co jsme naparsovali?
              } catch (e) {
                parsedStrediska = [];
              }

              return {
                ...fakturaFromDB,
                // MapovÃ¡nÃ­ DB -> FE (stejnÄ› jako pÅ™i naÄÃ­tÃ¡nÃ­)
                fa_dorucena: fakturaFromDB.fa_datum_doruceni ? 1 : 0,
                fa_splatnost: fakturaFromDB.fa_splatnost || (fakturaFromDB.fa_datum_splatnosti ? fakturaFromDB.fa_datum_splatnosti.split(' ')[0] : ''), // âœ… OPRAVENO: Fallback na fa_datum_splatnosti
                fa_strediska_kod: parsedStrediska, // âœ… OPRAVENO: PouÅ¾ij parsovanÃ© objekty
                // âœ… KRITICKÃ‰: PÅ™idat naÄtenÃ© pÅ™Ã­lohy
                attachments: attachments,
                // Zachovat originÃ¡lnÃ­ DB pole pro API odesÃ­lÃ¡nÃ­
                fa_datum_doruceni: fakturaFromDB.fa_datum_doruceni,
                fa_datum_splatnosti: fakturaFromDB.fa_datum_splatnosti,
                fa_datum_vystaveni: fakturaFromDB.fa_datum_vystaveni,
                // Obnovit ISDOC metadata z rozsirujici_data
                ...(isdocData ? {
                  _isdoc_polozky: isdocData.polozky,
                  _isdoc_dodavatel: isdocData.dodavatel,
                  _fromISDOC: true
                } : {})
              };
            })
          );

          // Aktualizuj faktury ve formData s naÄtenÃ½mi pÅ™Ã­lohami
          setFormData(prev => ({
            ...prev,
            faktury: fakturyWithAttachments
          }));

          addDebugLog('success', 'SAVE', 'faktury-updated', `Faktury aktualizovÃ¡ny s reÃ¡lnÃ½mi ID z DB (${fakturyFromBE.length}) vÄetnÄ› pÅ™Ã­loh`);
        }

        // ðŸ”” Odeslat notifikace pÅ™i vytvoÅ™enÃ­ novÃ© objednÃ¡vky
        try {
          // V2 API: stav_workflow_kod je pÅ™Ã­mo v result (mÅ¯Å¾e bÃ½t undefined nebo JSON string)
          let workflowKod = result?.stav_workflow_kod || orderData.stav_workflow_kod;

          // Pokud je stav_workflow_kod JSON string, parsuj ho
          if (typeof workflowKod === 'string' && workflowKod.startsWith('[')) {
            try {
              workflowKod = JSON.parse(workflowKod);
            } catch (e) {
            }
          }

          // âœ… STANDARDNÃ NOTIFIKACE (zvoneÄek) - VÅ½DY zavolat!
          await sendOrderNotifications(orderId, orderNumber, workflowKod, null, formData);

          // ðŸ†• DUAL-TEMPLATE EMAIL: NovÃ¡ objednÃ¡vka mÃ¡ automaticky ODESLANA_KE_SCHVALENI (NAVÃC k zvoneÄku)
          if (hasWorkflowState(workflowKod, 'ODESLANA_KE_SCHVALENI')) {
            try {
              // PÅ™evÃ©st kÃ³dy stÅ™edisek na nÃ¡zvy (strediskaOptions mÃ¡ strukturu {value, label})
              const strediskaNazvy = (formData.strediska_kod || []).map(kod => {
                const stredisko = strediskaOptions.find(opt => opt.value === kod);
                return stredisko ? stredisko.label : kod;
              });
              
              await notificationServiceDual.sendOrderApprovalNotifications({
                token,
                username,
                orderData: {
                  id: orderId,
                  ev_cislo: orderNumber,
                  predmet: formData.predmet || '',
                  prikazce_id: formData.prikazce_id,
                  garant_id: formData.garant_uzivatel_id,
                  vytvoril: formData.objednatel_id,
                  objednatel_id: formData.objednatel_id,
                  dodavatel_nazev: formData.dodavatel_nazev || 'Neuvedeno',
                  financovani_display: formData.zpusob_financovani || 'Neuvedeno',
                  financovani_cislo: formData.cislo_smlouvy || '',
                  financovani_poznamka: formData.smlouva_poznamka || '',
                  strediska_nazvy: strediskaNazvy,
                  max_price_with_dph: formData.max_cena_s_dph || 0
                }
              });
              addDebugLog('success', 'NOTIFICATION', 'dual-email-sent-new', `Dual-template EMAILY odeslÃ¡ny pro novou objednÃ¡vku ${orderNumber}`);
            } catch (dualError) {
              addDebugLog('warning', 'NOTIFICATION', 'dual-email-error-new', `Chyba pÅ™i dual-template emailech: ${dualError.message}`);
            }
          }
        } catch (notifError) {
          // Nezastavuj workflow kvÅ¯li chybÄ› notifikace
          addDebugLog('warning', 'SAVE', 'notification-error', `Chyba pÅ™i odesÃ­lÃ¡nÃ­ notifikace: ${notifError.message}`);
        }

        // Toast notifikace se zobrazÃ­ aÅ¾ pozdÄ›ji (Å™Ã¡dek ~5150-5160) - jednotnÄ› pro INSERT i UPDATE

        // SUPERADMIN a ADMINISTRATOR zÅ¯stÃ¡vajÃ­ na formulÃ¡Å™i (Å½ÃDNÃ‰ pÅ™esmÄ›rovÃ¡nÃ­)
        // VÅ¡ichni ostatnÃ­ uÅ¾ivatelÃ© vidÃ­ progress a pak pÅ™esmÄ›rovÃ¡nÃ­
        // POUÅ½IJ promÄ›nnÃ© deklarovanÃ© na zaÄÃ¡tku funkce (Å™Ã¡dek ~4817)
        const shouldShowProgress = !shouldStayOnForm; // BÄ›Å¾nÃ­ uÅ¾ivatelÃ© vidÃ­ progress

        // âœ… WORKFLOW REFACTORING: Backend vracÃ­ kompletnÃ­ zÃ¡znam, pouÅ¾ij ho pÅ™Ã­mo
        updatedFormDataImmediate = result;
        orderId = result.id;
        // ðŸ”§ KRITICKÃ‰: Backend by mÄ›l vracet ev_cislo, ale pokud nevrÃ¡tÃ­, pouÅ¾ijeme cislo_objednavky
        // Frontend NIKDY nevymÃ½Å¡lÃ­ ev_cislo - bere POUZE z backendu!
        orderNumber = result.ev_cislo || result.cislo_objednavky;

        // âœ… V2 API: Backend vracÃ­ data PÅ˜ÃMO v result, ne v result.data!
        // âœ… POUÅ½ÃT CENTRÃLNÃ TRANSFORMACI: Backend â†’ Frontend
        const transformedResult = transformBackendDataToFrontend(result);

        // ðŸ”§ VALIDACE STÅ˜EDISEK: Fallback pro neaktivnÃ­ stÅ™ediska
        if (transformedResult.strediska_kod && Array.isArray(transformedResult.strediska_kod)) {
          transformedResult.strediska_kod = validateAndFixStrediska(
            transformedResult.strediska_kod,
            strediskaOptions
          );
        }

        const parsedInsertData = {
          ...transformedResult,
          id: orderId,
          // ðŸ”§ PouÅ¾Ã­t orderNumber (ev_cislo NEBO cislo_objednavky jako fallback)
          ev_cislo: orderNumber
        };

        addDebugLog('success', 'INSERT', 'data-transformed', `Data transformovÃ¡na: strediska=${parsedInsertData.strediska_kod?.join(', ') || 'none'}, financovani=${parsedInsertData.zpusob_financovani || 'none'}`);

        // âœ… KRITICKÃ‰: Aktualizovat formData s PARSOVANÃMI daty z DB PRO VÅ ECHNY
        // TÃ­m zabrÃ¡nÃ­me ztrÃ¡tÄ› dat po uloÅ¾enÃ­ + sprÃ¡vnÄ› parsujeme stÅ™ediska
        // ðŸ”§ BUGFIX: Zachovat faktury s naÄtenÃ½mi pÅ™Ã­lohami (fakturyWithAttachments z Å™Ã¡dku 8030-8107)
        setFormData(prev => ({
          ...prev,
          ...parsedInsertData,  // âœ… PouÅ¾ij parsedInsertData mÃ­sto result.data (obsahuje parsovanÃ¡ stÅ™ediska)
          // âœ… POUÅ½ÃT FAKTURY S NAÄŒTENÃMI PÅ˜ÃLOHAMI (pokud byly naÄteny)
          faktury: fakturyWithAttachments && fakturyWithAttachments.length > 0 ? fakturyWithAttachments : (parsedInsertData.faktury || prev.faktury)
        }));

        addDebugLog('success', 'INSERT', 'formdata-updated', `FormData aktualizovÃ¡n: id=${orderId}, strediska=${parsedInsertData.strediska_kod?.join(', ') || 'none'}, faktury s pÅ™Ã­lohami: ${fakturyWithAttachments?.length || 0}`);
        
        // ðŸŽ¯ NAÄŒÃST LP OPTIONS z enriched response (z financovani.lp_nazvy)
        if (result.financovani?.lp_nazvy && Array.isArray(result.financovani.lp_nazvy)) {
          const lpOptions = result.financovani.lp_nazvy
            .map(lp => ({
              id: lp.id,
              kod: lp.cislo_lp || lp.kod || `LP${lp.id}`,
              nazev: lp.nazev || 'Bez nÃ¡zvu',
              kategorie: lp.kategorie,
              limit: lp.limit || lp.celkovy_limit,
              cerpano: lp.cerpano || lp.skutecne_cerpano,
              zbyva: lp.zbyva || lp.zbyva_skutecne,
              rok: lp.rok,
              label: `${lp.cislo_lp || lp.kod || `LP${lp.id}`} - ${lp.nazev || 'Bez nÃ¡zvu'}`
            }))
            .sort((a, b) => a.nazev.localeCompare(b.nazev, 'cs'));
          
          setLpOptionsForItems(lpOptions);
          addDebugLog('success', 'INSERT', 'lp-options-loaded', `LP options naÄteny z financovani.lp_nazvy: ${lpOptions.length}`);
        }

        // ðŸ”„ FORCE REFRESH workflowManager hned po setFormData
        workflowForceRefresh();

        // ðŸ”’ Reset vÅ¡ech unlock states - sekce se majÃ­ zamknout podle novÃ© fÃ¡ze
        workflowManager.resetAllUnlocks();

        // OznaÄit objednÃ¡vku jako uloÅ¾enou DO DB a uloÅ¾it ID
        if (orderId) {
          setSavedOrderId(orderId);
          // âŒ REMOVED: setPersistedOrderId - duplicitnÃ­ state, pouÅ¾ij savedOrderId
        }

        if (shouldShowProgress) {
          // BÄ›Å¾nÃ½ uÅ¾ivatel - spustÃ­ progress a pÅ™esmÄ›rovÃ¡nÃ­
          // ðŸŽ¯ CENTRALIZOVANÃ‰ MAZÃNÃ pÅ™es DraftManager
          setDisableAutosave(true);
          disableAutosaveRef.current = true; // ðŸš€ OKAMÅ½ITÄš zakÃ¡zat autosave (REF)
          setIsEditMode(false);
          setIsConceptSaved(false);

          // ðŸ”¥ PouÅ¾ij DraftManager pro mazÃ¡nÃ­ VÅ ECH klÃ­ÄÅ¯ (ASYNCHRONNÄš pro verifikaci)
          if (user_id) {
            draftManager.setCurrentUser(user_id);
            const deleted = await draftManager.deleteAllDraftKeys();

            if (deleted) {
              addDebugLog('success', 'INSERT', 'draftmanager-delete', `VÅ¡echny klÃ­Äe smazÃ¡ny pÅ™es DraftManager`);
            } else {
            }
          }

          startSaveProgressAndRedirect(orderNumber, orderId);

        } else {
          // SUPERADMIN/ADMIN - zÅ¯stÃ¡vÃ¡ na formulÃ¡Å™i v edit reÅ¾imu
          // âœ… Povolit autosave zpÄ›t (zÅ¯stÃ¡vajÃ­ editovat)
          setDisableAutosave(false);
          disableAutosaveRef.current = false;
          draftManager.setAutosaveEnabled(true, 'SUPERADMIN/ADMIN stays on form after INSERT');

          // âœ… ADMIN: UloÅ¾it aktualizovanÃ¡ data do draftu
          try {
            draftManager.setCurrentUser(user_id);
            await draftManager.saveDraft(updatedFormDataImmediate, {
              step: getCurrentPhase(),
              attachments: attachments,
              metadata: {
                version: '1.4',
                isConceptSaved: true,
                isOrderSavedToDB: true,
                savedOrderId: orderId,
                isChanged: false,
                dictionaries: {
                  approvers: approvers || [],
                  users: allUsers || [],
                  strediska: strediskaOptions || [],
                  financovani: financovaniOptions || [],
                  druhyObjednavky: druhyObjednavkyOptions || [],
                  lpKody: lpKodyOptions || []
                }
              }
            });
            addDebugLog('success', 'INSERT', 'admin-draft-saved', 'Draft uloÅ¾en pro ADMIN po INSERT');
          } catch (error) {
            addDebugLog('error', 'INSERT', 'admin-draft-error', `Chyba pÅ™i uklÃ¡dÃ¡nÃ­ draftu pro ADMIN: ${error.message}`);
          }

          // NEPROVÃDÃME unlock ani mazÃ¡nÃ­ konceptu - objednÃ¡vka zÅ¯stÃ¡vÃ¡ otevÅ™enÃ¡ pro dalÅ¡Ã­ editaci
          addDebugLog('info', 'SAVE', 'stay-on-form', `SUPERADMIN/ADMIN zÅ¯stÃ¡vÃ¡ na formulÃ¡Å™i - koncept NENÃ smazÃ¡n, formulÃ¡Å™ v edit reÅ¾imu`);

          // ðŸŽ‰ TOAST NOTIFIKACE pro SUPERADMIN/ADMIN - zobrazit ÃºspÄ›ch
          if (showToast) {
            const isNewOrder = !isOrderSavedToDB; // Byla to novÃ¡ objednÃ¡vka nebo update?
            const message = isNewOrder
              ? `ObjednÃ¡vka ${orderNumber} byla ÃºspÄ›Å¡nÄ› vytvoÅ™ena`
              : `ObjednÃ¡vka ${orderNumber} byla ÃºspÄ›Å¡nÄ› aktualizovÃ¡na`;
            showToast(message, { type: 'success' });
          }

          // âœ… ADMIN: Automaticky rozbalit sprÃ¡vnou sekci podle novÃ© fÃ¡ze
          setTimeout(() => {
            const newPhase = getCurrentPhase();
            addDebugLog('info', 'INSERT', 'phase-auto-navigate', `AutomatickÃ¡ navigace na fÃ¡zi: ${newPhase}`);

            // Rozbalit pÅ™Ã­sluÅ¡nou sekci podle fÃ¡ze
            if (newPhase === 2) {
              // FÃ¡ze 2 - rozbalit sekci pÅ™Ã­lohy
              setSectionStates(prev => ({ ...prev, prilohy: false }));
              setTimeout(() => {
                const prilohy = document.querySelector('[data-section="prilohy"]');
                if (prilohy) {
                  prilohy.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }, 100);
            } else if (newPhase === 3) {
              // FÃ¡ze 3 - rozbalit sekci odeslÃ¡nÃ­
              setSectionStates(prev => ({ ...prev, stav_odeslani: false }));
              setTimeout(() => {
                const odeslani = document.querySelector('[data-section="stav_odeslani"]');
                if (odeslani) {
                  odeslani.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }, 100);
            }
          }, 500); // Delay aby se stihlo aktualizovat formData
        }

        // RESET isChanged - data jsou synchronizovÃ¡na s DB
        setIsChanged(false);

        // ðŸ“Š PÅ™epoÄet ÄerpÃ¡nÃ­ smlouvy (pokud je smlouva vybranÃ¡ a objednÃ¡vka ve fÃ¡zi 7-8)
        if (formData.cislo_smlouvy && currentPhase >= 7) {
          try {
            await prepocetCerpaniSmluv({
              token,
              username,
              cislo_smlouvy: formData.cislo_smlouvy
            });
            addDebugLog('success', 'SMLOUVA', 'prepocet-ok', `PÅ™epoÄet ÄerpÃ¡nÃ­ smlouvy ${formData.cislo_smlouvy} ÃºspÄ›Å¡nÃ½`);
          } catch (error) {
            addDebugLog('warning', 'SMLOUVA', 'prepocet-error', `Chyba pÅ™i pÅ™epoÄtu smlouvy: ${error.message}`);
            // NepÅ™eruÅ¡ovat proces uklÃ¡dÃ¡nÃ­, jen logovat
          }
        }

        // ðŸ“Š DB RESPONSE LOGGING (INSERT)
        // âœ… V2 API: result je pÅ™Ã­mo data objednÃ¡vky, NE result.data!
        addDebugLog('info', 'DB-RESPONSE', 'INSERT-complete', {
          orderId: orderId,
          orderNumber: orderNumber,
          workflow: result.stav_workflow_kod,
          fieldsCount: Object.keys(result).length,
          polozky: result.polozky?.length || 0,
          faktury: result.faktury?.length || 0
        });

        // Odvodit checkboxy z workflow stavu (pro zamykÃ¡nÃ­ sekcÃ­)
        // âœ… V2 API: result je pÅ™Ã­mo data objednÃ¡vky, NE result.data!
        const newWorkflowFromDB = result.stav_workflow_kod;
        const isOdeslana = hasWorkflowState(newWorkflowFromDB, 'ODESLANA');
        const isZrusena = hasWorkflowState(newWorkflowFromDB, 'ZRUSENA');

        // âœ… WORKFLOW REFACTORING: Po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ do DB aktualizovat draft s ÄerstvÃ½mi daty
        // Backend vracÃ­ kompletnÃ­ zÃ¡znam, takÅ¾e draft bude synchronizovanÃ½ s DB
        // ðŸ”§ KRITICKÃ‰: Mergovat pÅ¯vodnÃ­ formData (s poloÅ¾kami!) + parsovanÃ¡ DB data
        try {
          draftManager.setCurrentUser(user_id);

          // ðŸ”¥ FIX: Mergovat updatedFormDataImmediate (obsahuje poloÅ¾ky + financovÃ¡nÃ­) + parsedInsertData (DB data)
          // ðŸ”§ BUGFIX: Zachovat objednatel_id z pÅ¯vodnÃ­ho formData pro jistotu
          const mergedDraftData = {
            ...updatedFormDataImmediate, // PÅ¯vodnÃ­ data s poloÅ¾kami
            ...parsedInsertData,         // PÅ™epsat DB daty (ID, workflow, atd.) + PARSOVANÃ‰ FINANCOVÃNÃ!
            // Zachovat poloÅ¾ky a faktury z pÅ¯vodnÃ­ho formData
            polozky_objednavky: updatedFormDataImmediate.polozky_objednavky || [],
            faktury: updatedFormDataImmediate.faktury || [],
            // âœ… ZACHOVAT objednatel_id + osobnÃ­ Ãºdaje objednatele (fallback na pÅ¯vodnÃ­ data)
            objednatel_id: parsedInsertData.objednatel_id || updatedFormDataImmediate.objednatel_id,
            jmeno: parsedInsertData.jmeno || updatedFormDataImmediate.jmeno,
            email: parsedInsertData.email || updatedFormDataImmediate.email,
            telefon: parsedInsertData.telefon || updatedFormDataImmediate.telefon
            // âœ… FINANCOVÃNÃ je uÅ¾ v parsedInsertData - nepÅ™episovat!
          };

          await draftManager.saveDraft(mergedDraftData, {
            step: getCurrentPhase(),
            attachments: attachments,
            metadata: {
              version: '1.4',
              isConceptSaved: true,
              isOrderSavedToDB: true,
              savedOrderId: orderId,
              isChanged: false, // âœ… FALSE = Å¾Ã¡dnÃ© neuloÅ¾enÃ© zmÄ›ny (vÅ¡e je v DB)
              dictionaries: {
                approvers: approvers || [],
                users: allUsers || [],
                strediska: strediskaOptions || [],
                financovani: financovaniOptions || [],
                druhyObjednavky: druhyObjednavkyOptions || [],
                lpKody: lpKodyOptions || []
              }
            }
          });
          addDebugLog('success', 'INSERT', 'draft-updated', `Draft aktualizovÃ¡n s PARSOVANÃMI DB daty (workflow: ${newWorkflowFromDB}, strediska: ${parsedInsertData.strediska_kod.join(', ')}, poloÅ¾ky: ${mergedDraftData.polozky_objednavky?.length || 0}, financovÃ¡nÃ­: ${mergedDraftData.zpusob_financovani || 'none'})`);

          // ðŸ“¸ AKTUALIZOVAT SNAPSHOT po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
          originalFormDataRef.current = JSON.parse(JSON.stringify(mergedDraftData));

          // ðŸš€ BROADCAST: OznÃ¡mit Layout.js zmÄ›nu editaÄnÃ­ho reÅ¾imu
          window.dispatchEvent(new CustomEvent('orderDraftChange', {
            detail: {
              hasDraft: true,
              isEditMode: true,  // Po INSERT se pÅ™epne do editaÄnÃ­ho reÅ¾imu
              orderId: orderId,
              orderNumber: orderNumber,
              isLoading: false
            }
          }));
          addDebugLog('success', 'INSERT', 'broadcast', `Broadcast orderDraftChange odeslÃ¡n (hasDraft: true, isEditMode: true, orderId: ${orderId})`);
        } catch (error) {
          addDebugLog('error', 'INSERT', 'draft-update-error', `Chyba pÅ™i aktualizaci draftu: ${error.message}`);
        }

        // âœ… WORKFLOW REFACTORING: FormData jiÅ¾ byl aktualizovÃ¡n vÃ½Å¡e (Å™Ã¡dek ~7079) s parsovanÃ½mi stÅ™ediskami
        // ODSTRANÄšNO duplicitnÃ­ setFormData(parsedInsertData) - zpÅ¯sobovalo pÅ™epsÃ¡nÃ­ dat

        // FÃ¡ze se odvodÃ­ automaticky z DB stavu - BE vracÃ­ aktuÃ¡lnÃ­ stav
        // âœ… V2 API: result je pÅ™Ã­mo data objednÃ¡vky, NE result.data!
        const newWorkflowKod = result.stav_workflow_kod;
        addDebugLog('success', 'SAVE', 'order-status', `ObjednÃ¡vka oznaÄena jako uloÅ¾enÃ¡. ID: ${orderId}, EV: ${orderNumber}, DB stav: ${newWorkflowKod}`);

        // FÃZE se automaticky pÅ™epoÄÃ­tÃ¡ z aktualizovanÃ©ho formData.stav_workflow_kod
        addDebugLog('success', 'SAVE', 'workflow-state', `DB stav: ${newWorkflowKod} - fÃ¡ze se pÅ™epoÄÃ­tÃ¡ automaticky`);

        // Po ÃºspÄ›Å¡nÃ©m INSERT - reset stavÅ¯ a refresh autosave
        // Reset odemknutÃ­ pouze pokud je objednÃ¡vka skuteÄnÄ› schvÃ¡lenÃ¡
        if (hasWorkflowState(newWorkflowKod, 'SCHVALENA')) {
          setIsPhase1Unlocked(false); // Reset odemknutÃ­ pouze pro schvÃ¡lenou objednÃ¡vku
          addDebugLog('info', 'SAVE', 'lock-sections', 'FÃZE 1 sekce zamÄeny - objednÃ¡vka je schvÃ¡lenÃ¡');
        } else {
          addDebugLog('info', 'SAVE', 'keep-unlocked-phase1', `FÃZE 1 sekce zÅ¯stÃ¡vajÃ­ odemÄenÃ© - stav: ${newWorkflowKod}`);
        }

        // Pro FÃZE 2: Zamknout pokud DB obsahuje ODESLANA/ZRUSENA
        const hasOdeslanaInNewState = hasWorkflowState(newWorkflowKod, 'ODESLANA');
        const hasZrusenaInNewState = hasWorkflowState(newWorkflowKod, 'ZRUSENA');

        // ZamykÃ¡nÃ­ Å™eÅ¡Ã­ useEffect podle formData.stav_workflow_kod

        // ZAMKNOUT FÃZE 2 - pokud je objednÃ¡vka odeslanÃ¡/zruÅ¡enÃ¡
        // KONTROLA POUZE podle DB workflow stavu - NE podle UI checkboxu stav_stornovano!
        addDebugLog('success', 'SAVE', 'no-ui-refresh', `Bez UI refresh - pÅ™Ã­mo zamykÃ¡nÃ­. NovÃ½ stav: ${newWorkflowKod}`);
          const shouldLockPhase2Now = (
            hasWorkflowState(newWorkflowKod, 'ODESLANA') ||
            hasWorkflowState(newWorkflowKod, 'ZRUSENA')
          );

        if (shouldLockPhase2Now) {
          // ðŸŽ¯ Zkontrolovat pÅ™es DraftManager, jestli nenÃ­ Phase 2 ruÄnÄ› odemÄeno
          let isManuallyUnlocked = false;
          try {
            const uiState = draftManager.getUIState();
            if (uiState) {
              const currentOrderId = formData.id;
              // Kontrolovat pouze pokud existuje ID objednÃ¡vky
              if (currentOrderId && uiState.phase2OrderId === currentOrderId && uiState.phase2Unlocked === true) {
                isManuallyUnlocked = true;
              }
            }
          } catch (e) {
            addDebugLog('warning', 'SAVE', 'unlock-check-error', `Chyba pÅ™i kontrole Phase 2 unlock stavu: ${e.message}`);
          }

          if (isManuallyUnlocked) {
            addDebugLog('info', 'SAVE', 'phase2-keep-unlocked', `FÃZE 2 zÅ¯stÃ¡vÃ¡ ODEMÄŒENA - byla ruÄnÄ› odemÄena`);
          } else {
            setIsPhase3SectionsUnlocked(false);
          }
        }        setHasTriedToSubmit(false); // Reset validace po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­

        // AktualizovanÃ¡ data pro localStorage (vÄetnÄ› novÃ©ho workflow stavu)
        const updatedFormDataForSave = {
          ...formData,
          id: orderId,
          ev_cislo: orderNumber,
          stav_workflow_kod: newWorkflowKod,
          ...(result?.dt_schvaleni && { dt_schvaleni: result.dt_schvaleni })
        };

        // Debug: Zkontroluj, zda mÃ¡ workflow stav SCHVALENA (INSERT)
        const hasSchvalenaInsert = hasWorkflowState(newWorkflowKod, 'SCHVALENA');
        addDebugLog('info', 'INSERT', 'phase-check', `MÃ¡ SCHVALENA: ${hasSchvalenaInsert}, novÃ¡ fÃ¡ze by mÄ›la bÃ½t: ${hasSchvalenaInsert ? '2' : '1'}`);

        // KRITICKÃ‰: Aktualizovat formData pro refresh UI (stejnÄ› jako u UPDATE) - s force refresh
        // ðŸ”§ ZACHOVAT parsedInsertData.strediska_kod - nepÅ™episovat!
        setFormData(prev => {
          // ðŸ·ï¸ PÅ™evÃ©st workflow kÃ³d na textovÃ½ popis
          const stavObjednavky = (() => {
            try {
              const stavyArray = Array.isArray(newWorkflowKod)
                ? newWorkflowKod
                : JSON.parse(newWorkflowKod || '["NOVA"]');
              const poslednStav = stavyArray[stavyArray.length - 1];
              const stavInfo = WORKFLOW_STATES[poslednStav];
              return stavInfo?.name || poslednStav || 'NovÃ¡';
            } catch (e) {
              return 'NovÃ¡';
            }
          })();

          const newData = {
            ...prev,
            id: orderId,
            ev_cislo: orderNumber,
            stav_workflow_kod: newWorkflowKod,
            stav_objednavky: stavObjednavky,
            ...(result?.dt_schvaleni && { dt_schvaleni: result.dt_schvaleni }),
            strediska_kod: parsedInsertData.strediska_kod
          };

          return newData;
        });

        // UÅ¾ nenÃ­ potÅ™eba explicitnÃ­ DB reload - BE vracÃ­ spolehlivÃ½ stav v response

        // Zobrazit success message - POUZE pro bÄ›Å¾nÃ© uÅ¾ivatele (SUPERADMIN/ADMIN majÃ­ toast vÃ½Å¡e)
        if (!shouldStayOnForm) {
          if (result.message) {
            showToast && showToast(result.message, { type: 'success' });
          } else if (result.lock_info?.locked_by_user_fullname) {
            showToast && showToast(
              `ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› vytvoÅ™ena (edituje: ${result.lock_info.locked_by_user_fullname})`,
              { type: 'success' }
            );
          } else {
            showToast && showToast(`ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› vytvoÅ™ena`, { type: 'success' });
          }
        }

        // POZNÃMKA: Autosave byl pÅ™esunut do DraftManager.syncWithDatabase()
        // NenÃ­ potÅ™eba volat saveDraftWithData - zpÅ¯sobovalo duplicitnÃ­ zÃ¡pis a race conditions
        addDebugLog('info', 'AUTOSAVE', 'skip-duplicate-insert', `Autosave pÅ™eskoÄen - jiÅ¾ proveden pÅ™es DraftManager.syncWithDatabase()`);

        // === SUPERADMIN/ADMIN zachovÃ¡nÃ­ draftu ===
        // Pro SUPERADMIN a ADMIN NEMAZAT draft - zÅ¯stÃ¡vajÃ­ na formulÃ¡Å™i v edit reÅ¾imu
        // POUÅ½IJ jiÅ¾ deklarovanÃ© promÄ›nnÃ© z nadÅ™azenÃ©ho scope (Å™Ã¡dek ~5203-5205)

        if (!shouldStayOnForm && user_id) {
          // BÄ›Å¾nÃ½ uÅ¾ivatel - smazat draft (bude pÅ™esmÄ›rovÃ¡n)
          draftManager.setCurrentUser(user_id);
          await draftManager.deleteDraft();
          addDebugLog('info', 'DRAFT', 'delete-after-create', 'Draft smazÃ¡n po ÃºspÄ›Å¡nÃ©m CREATE pÅ™es DraftManager (bÄ›Å¾nÃ½ uÅ¾ivatel)');
        } else if (shouldStayOnForm) {
          addDebugLog('info', 'DRAFT', 'keep-after-create', 'Draft ZACHOVÃN po CREATE - SUPERADMIN/ADMIN zÅ¯stÃ¡vÃ¡ na formulÃ¡Å™i');
        }

      } else {
        // Aktualizace existujÃ­cÃ­ objednÃ¡vky - pouÅ¾Ã­vÃ¡me partial-update
        const oldWorkflowKod = formData.stav_workflow_kod;

        addDebugLog('info', 'SAVE-V2', 'update-start', `Volam updateOrderV2(${savedOrderId})`);

        // âš ï¸ prepareDataForAPI() se volÃ¡ automaticky uvnitÅ™ updateOrderV2() - NEMÄšNIT ZNOVU!
        // const preparedData = prepareDataForAPI(orderData);  âŒ DUPLICITNÃ - jiÅ¾ se dÄ›lÃ¡ v updateOrderV2()


        // ðŸ› DEBUG: STÅ˜EDISKA VE FAKTURÃCH PÅ˜ED ODESLÃNÃM (UPDATE)
        if (orderData.faktury && orderData.faktury.length > 0) {
        }

        result = await updateOrderV2(savedOrderId, orderData, token, username);

        addDebugLog('info', 'SAVE-V2', 'update-success', `Order ${savedOrderId} updated`);

        // DB RESPONSE LOGGING (UPDATE)
        // ðŸ”§ V2 API: Backend vracÃ­ cislo_objednavky (ne ev_cislo)
        addDebugLog('info', 'DB-RESPONSE', 'UPDATE-complete', {
          orderId: result.id,
          orderNumber: result.cislo_objednavky || result.ev_cislo,
          workflow: result.stav_workflow_kod,
          fieldsCount: Object.keys(result).length,
          polozky: result.polozky?.length || 0,
          faktury: result.faktury?.length || 0
        });

        // ðŸ” DEBUG: Zkontroluj co backend vracÃ­ v dodavatel_zpusob_potvrzeni

        // Odeslat notifikace pÅ™i zmÄ›nÄ› workflow stavu
        try {
          const orderNumber = formData.ev_cislo || formData.cislo_objednavky || savedOrderId;
          
          // âœ… STANDARDNÃ NOTIFIKACE (zvoneÄek) - VÅ½DY zavolat!
          await sendOrderNotifications(savedOrderId, orderNumber, result.stav_workflow_kod, oldWorkflowKod, formData);
          
          // ðŸ†• DUAL-TEMPLATE EMAIL: PÅ™i prvnÃ­m odeslÃ¡nÃ­ ke schvÃ¡lenÃ­ (NAVÃC k zvoneÄku)
          const hasKeSchvaleni = hasWorkflowState(result.stav_workflow_kod, 'ODESLANA_KE_SCHVALENI');
          const hadKeSchvaleni = oldWorkflowKod ? hasWorkflowState(oldWorkflowKod, 'ODESLANA_KE_SCHVALENI') : false;
          
          if (hasKeSchvaleni && !hadKeSchvaleni) {
            // Odeslat POUZE EMAILY (zvoneÄky uÅ¾ vytoÅ™ila funkce sendOrderNotifications)
            try {
              // PÅ™evÃ©st kÃ³dy stÅ™edisek na nÃ¡zvy (strediskaOptions mÃ¡ strukturu {value, label})
              const strediskaNazvy = (formData.strediska_kod || []).map(kod => {
                const stredisko = strediskaOptions.find(opt => opt.value === kod);
                return stredisko ? stredisko.label : kod;
              });
              
              await notificationServiceDual.sendOrderApprovalNotifications({
                token,
                username,
                orderData: {
                  id: savedOrderId,
                  ev_cislo: orderNumber,
                  predmet: formData.predmet || '',
                  prikazce_id: formData.prikazce_id,
                  garant_id: formData.garant_uzivatel_id,
                  vytvoril: formData.objednatel_id,
                  objednatel_id: formData.objednatel_id,
                  dodavatel_nazev: formData.dodavatel_nazev || 'Neuvedeno',
                  financovani_display: formData.zpusob_financovani || 'Neuvedeno',
                  financovani_cislo: formData.cislo_smlouvy || '',
                  financovani_poznamka: formData.smlouva_poznamka || '',
                  strediska_nazvy: strediskaNazvy,
                  max_price_with_dph: formData.max_cena_s_dph || 0
                }
              });
              addDebugLog('success', 'NOTIFICATION', 'dual-email-sent', `Dual-template EMAILY odeslÃ¡ny pro objednÃ¡vku ${orderNumber}`);
            } catch (dualError) {
              addDebugLog('warning', 'NOTIFICATION', 'dual-email-error', `Chyba pÅ™i dual-template emailech: ${dualError.message}`);
            }
          }
        } catch (notifError) {
        }

        // âœ… WORKFLOW REFACTORING: Backend vracÃ­ kompletnÃ­ zÃ¡znam, pouÅ¾ij ho pÅ™Ã­mo
        const updatedFormDataImmediate = result;
        const updatedWorkflowKod = result.stav_workflow_kod;

        // Odvodit checkboxy z workflow stavu (pro zamykÃ¡nÃ­ sekcÃ­)
        const isOdeslana = hasWorkflowState(updatedWorkflowKod, 'ODESLANA');
        const isZrusena = hasWorkflowState(updatedWorkflowKod, 'ZRUSENA');

        // âœ… V2 API: Backend vracÃ­ data PÅ˜ÃMO v result, ne v result.data!
        // ðŸ”„ POUÅ½ÃT CENTRÃLNÃ TRANSFORMACI: Backend â†’ Frontend
        const transformedResult = transformBackendDataToFrontend(result);

        // ðŸ”§ VALIDACE STÅ˜EDISEK: Fallback pro neaktivnÃ­ stÅ™ediska
        if (transformedResult.strediska_kod && Array.isArray(transformedResult.strediska_kod)) {
          transformedResult.strediska_kod = validateAndFixStrediska(
            transformedResult.strediska_kod,
            strediskaOptions
          );
        }

        // NynÃ­ pracuj s transformovanÃ½mi daty (uÅ¾ obsahuje normalized stÅ™ediska + financovÃ¡nÃ­)
        const parsedUpdateData = {
          ...transformedResult  // âœ… UÅ¾ obsahuje: strediska_kod (array), zpusob_financovani (string), polozky_objednavky (array), atd.
        };

        addDebugLog('success', 'UPDATE', 'data-transformed', `Data transformovÃ¡na: strediska=${parsedUpdateData.strediska_kod?.join(', ') || 'none'}, financovani=${parsedUpdateData.zpusob_financovani || 'none'}`);


        // ðŸ·ï¸ PÅ™evÃ©st workflow kÃ³d na textovÃ½ popis
        const stavObjednavky = (() => {
          try {
            const stavyArray = Array.isArray(updatedWorkflowKod)
              ? updatedWorkflowKod
              : JSON.parse(updatedWorkflowKod || '["NOVA"]');
            const poslednStav = stavyArray[stavyArray.length - 1];
            const stavInfo = WORKFLOW_STATES[poslednStav];
            return stavInfo?.name || poslednStav || 'NovÃ¡';
          } catch (e) {
            return 'NovÃ¡';
          }
        })();

        // PÅ™idat stav_objednavky do parsedUpdateData
        parsedUpdateData.stav_objednavky = stavObjednavky;

        // ðŸ”§ KRITICKÃ‰: Normalizovat dodavatel_zpusob_potvrzeni do jednotnÃ©ho FE formÃ¡tu
        // PodporovanÃ© BE formÃ¡ty:
        // 1. NOVÃ: { potvrzeni: 'ANO', zpusoby: ['email'], platba: 'faktura' }
        // 2. STARÃ: { potvrzeno: true, zpusob: ['email'], platba: 'faktura' }
        // FE oÄekÃ¡vÃ¡: { potvrzeni: 'ANO', zpusoby: ['email'], platba: 'faktura' }

        if (parsedUpdateData.dodavatel_zpusob_potvrzeni && typeof parsedUpdateData.dodavatel_zpusob_potvrzeni === 'object') {
          const beData = parsedUpdateData.dodavatel_zpusob_potvrzeni;

          // âœ… ULOÅ½IT originÃ¡lnÃ­ hodnotu z DB (pro pÅ™Ã­pad zamÄenÃ© sekce)
          parsedUpdateData.dodavatel_zpusob_potvrzeni_original = JSON.stringify(beData);

          // âœ… Pokud uÅ¾ mÃ¡ sprÃ¡vnou FE strukturu (potvrzeni + zpusoby), jen normalizuj hodnoty
          if (beData.potvrzeni !== undefined) {
            parsedUpdateData.dodavatel_zpusob_potvrzeni = {
              potvrzeni: beData.potvrzeni || 'NE',
              zpusoby: Array.isArray(beData.zpusoby) ? beData.zpusoby : [],
              platba: beData.platba || ''
            };
            addDebugLog('info', 'UPDATE', 'normalize-potvrzeni-ok',
              `NormalizovÃ¡n dodavatel_zpusob_potvrzeni (uÅ¾ sprÃ¡vnÃ½ formÃ¡t): ${JSON.stringify(parsedUpdateData.dodavatel_zpusob_potvrzeni)}`);
          }
          // âœ… Transformuj starÃ½ BE formÃ¡t (potvrzeno)
          else if (beData.potvrzeno !== undefined) {
            parsedUpdateData.dodavatel_zpusob_potvrzeni = {
              potvrzeni: beData.potvrzeno ? 'ANO' : 'NE',
              zpusoby: beData.zpusob || beData.zpusob_potvrzeni || [],
              platba: beData.platba || beData.zpusob_platby || ''
            };
            addDebugLog('info', 'UPDATE', 'transform-potvrzeni-old',
              `TransformovÃ¡n dodavatel_zpusob_potvrzeni (starÃ½ BE formÃ¡t): ${JSON.stringify(parsedUpdateData.dodavatel_zpusob_potvrzeni)}`);
          }
          // âœ… Fallback - starÃ½ formÃ¡t BEZ potvrzeno (odvoÄ z dt_akceptace)
          else if (beData.zpusob !== undefined || beData.zpusoby !== undefined) {
            const maAkceptaci = !!(parsedUpdateData.dt_akceptace && parsedUpdateData.dodavatel_potvrdil_id);
            parsedUpdateData.dodavatel_zpusob_potvrzeni = {
              potvrzeni: maAkceptaci ? 'ANO' : 'NE',
              zpusoby: beData.zpusoby || beData.zpusob || beData.zpusob_potvrzeni || [],
              platba: beData.platba || beData.zpusob_platby || ''
            };
            addDebugLog('info', 'UPDATE', 'transform-potvrzeni-fallback',
              `TransformovÃ¡n dodavatel_zpusob_potvrzeni (fallback z dt_akceptace): ${JSON.stringify(parsedUpdateData.dodavatel_zpusob_potvrzeni)}`);
          }
        }

        // ðŸ“Ž NAÄŒÃST PÅ˜ÃLOHY PRO FAKTURY (PÅ˜ED setFormData)
        const fakturyWithAttachments = parsedUpdateData.faktury ? await Promise.all(
          parsedUpdateData.faktury.map(async (fakturaFromDB) => {
            // Parsovat ISDOC data z rozsirujici_data pokud existujÃ­
            const isdocData = fakturaFromDB.rozsirujici_data?.isdoc;

            // ðŸ”§ PARSOVÃNÃ STÅ˜EDISEK z DB JSON stringu na pole STRINGÅ® (NE objektÅ¯!)
            let parsedStrediska = [];
            try {
              if (Array.isArray(fakturaFromDB.fa_strediska_kod)) {
                parsedStrediska = fakturaFromDB.fa_strediska_kod;
              } else if (typeof fakturaFromDB.fa_strediska_kod === 'string') {
                parsedStrediska = JSON.parse(fakturaFromDB.fa_strediska_kod || '[]');
              }

              // âœ… VYÄŒISTIT - zajistit Å¾e jsou JEN STRINGY (extrahovat z objektÅ¯ pokud jsou tam)
              parsedStrediska = parsedStrediska.map(item => {
                if (typeof item === 'string') {
                  return item; // UÅ¾ je string - OK
                }
                // Extrahuj z objektu
                return item.kod_stavu || item.value || item.id || item;
              });

              // ðŸ› DEBUG: Co jsme naparsovali?
            } catch (e) {
              parsedStrediska = [];
            }

            // ðŸ“Ž NAÄŒÃST PÅ˜ÃLOHY FAKTURY Z DB
            let attachments = [];
            if (fakturaFromDB.id && !String(fakturaFromDB.id).startsWith('temp-')) {
              try {
                const attachResponse = await listInvoiceAttachments(
                  fakturaFromDB.id,
                  username,
                  token,
                  savedOrderId  // orderId
                );
                attachments = attachResponse.data?.attachments || attachResponse.data || [];
              } catch (err) {
              }
            }

            return {
              ...fakturaFromDB,
              // MapovÃ¡nÃ­ DB -> FE (stejnÄ› jako pÅ™i INSERT)
              fa_dorucena: fakturaFromDB.fa_datum_doruceni ? 1 : 0,
              fa_splatnost: fakturaFromDB.fa_splatnost || (fakturaFromDB.fa_datum_splatnosti ? fakturaFromDB.fa_datum_splatnosti.split(' ')[0] : ''),
              fa_strediska_kod: parsedStrediska,
              // âœ… KRITICKÃ‰: PÅ™idat naÄtenÃ© pÅ™Ã­lohy
              attachments: attachments,
              // Zachovat originÃ¡lnÃ­ DB pole pro API odesÃ­lÃ¡nÃ­
              fa_datum_doruceni: fakturaFromDB.fa_datum_doruceni,
              fa_datum_splatnosti: fakturaFromDB.fa_datum_splatnosti,
              fa_datum_vystaveni: fakturaFromDB.fa_datum_vystaveni,
              // Obnovit ISDOC metadata z rozsirujici_data
              ...(isdocData ? {
                _isdoc_polozky: isdocData.polozky,
                _isdoc_dodavatel: isdocData.dodavatel,
                _fromISDOC: true
              } : {})
            };
          })
        ) : [];

        // âœ… KRITICKÃ‰: Aktualizovat formData s daty z DB (jedinÃ© volÃ¡nÃ­ s mergem)
        // OPRAVENO: OdstranÄ›no duplicitnÃ­ setFormData(parsedUpdateData) kterÃ© pÅ™episovalo celÃ½ state
        // ðŸ”§ BUGFIX: Zachovat objednatel_id z pÅ¯vodnÃ­ho formData, protoÅ¾e backend ho pÅ™i UPDATE NEVRACÃ
        setFormData(prev => ({
          ...prev,
          ...parsedUpdateData,  // PouÅ¾ij parsedUpdateData mÃ­sto updatedFormDataImmediate (obsahuje parsovanÃ¡ stÅ™ediska + stav_objednavky)
          // âœ… EXPLICITNÄš nastavit workflow kÃ³d z BE odpovÄ›di
          stav_workflow_kod: updatedWorkflowKod,
          // âœ… ZACHOVAT objednatel_id + osobnÃ­ Ãºdaje objednatele z pÅ¯vodnÃ­ho formData
          objednatel_id: prev.objednatel_id || parsedUpdateData.objednatel_id,
          jmeno: prev.jmeno || parsedUpdateData.jmeno,
          email: prev.email || parsedUpdateData.email,
          telefon: prev.telefon || parsedUpdateData.telefon,
          // âœ… POUÅ½ÃT FAKTURY S NAÄŒTENÃMI PÅ˜ÃLOHAMI
          faktury: fakturyWithAttachments.length > 0 ? fakturyWithAttachments : prev.faktury
        }));

        addDebugLog('success', 'UPDATE', 'formdata-updated', `FormData aktualizovÃ¡n: workflow=${updatedWorkflowKod}, strediska=${parsedUpdateData.strediska_kod.join(', ')}`);
        
        // ðŸŽ¯ NAÄŒÃST LP OPTIONS z enriched response (z financovani.lp_nazvy)
        if (result.financovani?.lp_nazvy && Array.isArray(result.financovani.lp_nazvy)) {
          const lpOptions = result.financovani.lp_nazvy
            .map(lp => ({
              id: lp.id,
              kod: lp.cislo_lp || lp.kod || `LP${lp.id}`,
              nazev: lp.nazev || 'Bez nÃ¡zvu',
              kategorie: lp.kategorie,
              limit: lp.limit || lp.celkovy_limit,
              cerpano: lp.cerpano || lp.skutecne_cerpano,
              zbyva: lp.zbyva || lp.zbyva_skutecne,
              rok: lp.rok,
              label: `${lp.cislo_lp || lp.kod || `LP${lp.id}`} - ${lp.nazev || 'Bez nÃ¡zvu'}`
            }))
            .sort((a, b) => a.nazev.localeCompare(b.nazev, 'cs'));
          
          setLpOptionsForItems(lpOptions);
          addDebugLog('success', 'UPDATE', 'lp-options-loaded', `LP options naÄteny z financovani.lp_nazvy: ${lpOptions.length}`);
        }

        // ðŸ“Š PÅ™epoÄet ÄerpÃ¡nÃ­ smlouvy (pokud je smlouva vybranÃ¡ a objednÃ¡vka ve fÃ¡zi 7-8)
        if (formData.cislo_smlouvy && currentPhase >= 7) {
          try {
            await prepocetCerpaniSmluv({
              token,
              username,
              cislo_smlouvy: formData.cislo_smlouvy
            });
            addDebugLog('success', 'SMLOUVA', 'prepocet-ok', `PÅ™epoÄet ÄerpÃ¡nÃ­ smlouvy ${formData.cislo_smlouvy} ÃºspÄ›Å¡nÃ½`);
          } catch (error) {
            addDebugLog('warning', 'SMLOUVA', 'prepocet-error', `Chyba pÅ™i pÅ™epoÄtu smlouvy: ${error.message}`);
            // NepÅ™eruÅ¡ovat proces uklÃ¡dÃ¡nÃ­, jen logovat
          }
        }

        // ðŸ”’ KRITICKÃ‰: Nastavit flag, Å¾e workflow state byl aktualizovÃ¡n
        window.__workflowStateUpdated = true;

        // ðŸ”„ FORCE REFRESH workflowManager hned po setFormData
        workflowForceRefresh();

        // ï¿½ Reset unlock states - sekce se majÃ­ zamknout podle novÃ© fÃ¡ze
        workflowManager.resetAllUnlocks();

        // ï¿½ðŸ”„ PÅ˜EPOÄŒÃTÃNÃ FÃZE: ExplicitnÃ­ vÃ½poÄet fÃ¡ze po UPDATE s NOVÃMI daty z DB
        // Toto zajistÃ­ sprÃ¡vnÃ© zobrazenÃ­ napÅ™. 10/10 mÃ­sto 9/10 po potvrzenÃ­ vÄ›cnÃ© sprÃ¡vnosti
        const calculatePhaseFromWorkflow = (workflowKod, hasId, orderData = {}) => {
          if (!hasId) return 1;
          if (hasWorkflowState(workflowKod, 'DOKONCENA')) return 10;
          // ZKONTROLOVANA - fÃ¡ze 10 (pÅ™ed dokonÄenÃ­m)
          if (hasWorkflowState(workflowKod, 'ZKONTROLOVANA')) return 10;
          // VECNA_SPRAVNOST - fÃ¡ze 9 (vÄ›cnÃ¡ sprÃ¡vnost)
          if (hasWorkflowState(workflowKod, 'VECNA_SPRAVNOST')) return 9;
          if (hasWorkflowState(workflowKod, 'FAKTURACE')) return 8;

          // âš ï¸ FÃZE 7: UVEREJNENA - po vyplnÄ›nÃ­ registru smluv
          if (hasWorkflowState(workflowKod, 'UVEREJNENA')) return 7;

          // âš ï¸ FÃZE 8: NEUVEREJNIT - rozhodnuto Å¾e nebude zveÅ™ejnÄ›na â†’ FÃZE 8 (Fakturace)
          if (hasWorkflowState(workflowKod, 'NEUVEREJNIT')) return 8;

          // âš ï¸ FÃZE 6: UVEREJNIT - rozhodnuto Å¾e mÃ¡ bÃ½t zveÅ™ejnÄ›na â†’ FÃZE 6 (vyplÅˆujÃ­ registr)
          if (hasWorkflowState(workflowKod, 'UVEREJNIT')) return 6;

          if (hasWorkflowState(workflowKod, 'POTVRZENA')) return 5;
          if (hasWorkflowState(workflowKod, 'ODESLANA')) return 4;
          if (hasWorkflowState(workflowKod, 'SCHVALENA') || hasWorkflowState(workflowKod, 'ROZPRACOVANA')) return 3;
          if (hasWorkflowState(workflowKod, 'ODESLANA_KE_SCHVALENI') || hasWorkflowState(workflowKod, 'CEKA_SE')) return 2;
          return 1;
        };

        const newPhase = calculatePhaseFromWorkflow(updatedWorkflowKod, parsedUpdateData.id || savedOrderId, parsedUpdateData);
        addDebugLog('info', 'UPDATE', 'phase-refreshed', `âœ¨ FÃ¡ze EXPLICITNÄš pÅ™epoÄÃ­tÃ¡na: ${newPhase}/10, workflow: ${updatedWorkflowKod}`);


        // âœ… WORKFLOW REFACTORING: Po ÃºspÄ›Å¡nÃ©m UPDATE aktualizovat draft s ÄerstvÃ½mi daty z DB
        // Backend vracÃ­ kompletnÃ­ zÃ¡znam, takÅ¾e draft bude synchronizovanÃ½ s DB
        // ðŸ”§ KRITICKÃ‰: Mergovat pÅ¯vodnÃ­ formData (s poloÅ¾kami!) + parsovanÃ¡ DB data
        try {
          draftManager.setCurrentUser(user_id);

          // ðŸ”¥ FIX: Mergovat updatedFormDataImmediate (obsahuje poloÅ¾ky + financovÃ¡nÃ­) + parsedUpdateData (DB data)
          // ðŸ”§ BUGFIX: Zachovat objednatel_id z pÅ¯vodnÃ­ho formData, protoÅ¾e backend ho pÅ™i UPDATE NEVRACÃ
          // ðŸ”¥ KRITICKÃ OPRAVA: Zachovat financovÃ¡nÃ­ z PÅ®VODNÃHO formData (pÅ™ed UPDATE), ne z odpovÄ›di BE
          const mergedDraftData = {
            ...updatedFormDataImmediate, // PÅ¯vodnÃ­ data s poloÅ¾kami
            ...parsedUpdateData,         // PÅ™epsat DB daty (workflow, atd.) + PARSOVANÃ‰ FINANCOVÃNÃ!
            // Zachovat poloÅ¾ky a faktury z pÅ¯vodnÃ­ho formData
            polozky_objednavky: updatedFormDataImmediate.polozky_objednavky || [],
            faktury: fakturyWithAttachments.length > 0 ? fakturyWithAttachments : updatedFormDataImmediate.faktury || [], // âœ… PÅ˜ÃLOHY!
            // âœ… ZACHOVAT objednatel_id + osobnÃ­ Ãºdaje objednatele z pÅ¯vodnÃ­ho formData
            objednatel_id: updatedFormDataImmediate.objednatel_id || parsedUpdateData.objednatel_id,
            jmeno: updatedFormDataImmediate.jmeno || parsedUpdateData.jmeno,
            email: updatedFormDataImmediate.email || parsedUpdateData.email,
            telefon: updatedFormDataImmediate.telefon || parsedUpdateData.telefon,
            // âœ… KRITICKÃ‰: EXPLICITNÄš zachovat dynamickÃ¡ pole financovÃ¡nÃ­ Z PÅ®VODNÃHO formData
            // Backend pÅ™i UPDATE nemusÃ­ vracet vÅ¡echna pole financovÃ¡nÃ­ â†’ pouÅ¾ij PÅ®VODNÃ hodnoty z formData
            zpusob_financovani: parsedUpdateData.zpusob_financovani || formData.zpusob_financovani || updatedFormDataImmediate.zpusob_financovani,
            lp_kod: parsedUpdateData.lp_kod || formData.lp_kod || updatedFormDataImmediate.lp_kod,
            cislo_smlouvy: parsedUpdateData.cislo_smlouvy || formData.cislo_smlouvy || updatedFormDataImmediate.cislo_smlouvy,
            smlouva_poznamka: parsedUpdateData.smlouva_poznamka || formData.smlouva_poznamka || updatedFormDataImmediate.smlouva_poznamka,
            individualni_schvaleni: parsedUpdateData.individualni_schvaleni || formData.individualni_schvaleni || updatedFormDataImmediate.individualni_schvaleni,
            individualni_poznamka: parsedUpdateData.individualni_poznamka || formData.individualni_poznamka || updatedFormDataImmediate.individualni_poznamka,
            pojistna_udalost_cislo: parsedUpdateData.pojistna_udalost_cislo || formData.pojistna_udalost_cislo || updatedFormDataImmediate.pojistna_udalost_cislo,
            pojistna_udalost_poznamka: parsedUpdateData.pojistna_udalost_poznamka || formData.pojistna_udalost_poznamka || updatedFormDataImmediate.pojistna_udalost_poznamka
          };

          await draftManager.saveDraft(mergedDraftData, {
            step: getCurrentPhase(),
            attachments: attachments,
            metadata: {
              version: '1.4',
              isConceptSaved: true,
              isOrderSavedToDB: true,
              savedOrderId: savedOrderId,
              isChanged: false, // âœ… FALSE = Å¾Ã¡dnÃ© neuloÅ¾enÃ© zmÄ›ny (vÅ¡e je v DB)
              dictionaries: {
                approvers: approvers || [],
                users: allUsers || [],
                strediska: strediskaOptions || [],
                financovani: financovaniOptions || [],
                druhyObjednavky: druhyObjednavkyOptions || [],
                lpKody: lpKodyOptions || []
              }
            }
          });
          addDebugLog('success', 'UPDATE', 'draft-updated', `Draft aktualizovÃ¡n s PARSOVANÃMI DB daty (workflow: ${updatedWorkflowKod}, strediska: ${parsedUpdateData.strediska_kod.join(', ')}, poloÅ¾ky: ${mergedDraftData.polozky_objednavky?.length || 0}, financovÃ¡nÃ­: ${mergedDraftData.zpusob_financovani || 'none'})`);

          // ðŸ“¸ AKTUALIZOVAT SNAPSHOT po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
          originalFormDataRef.current = JSON.parse(JSON.stringify(mergedDraftData));

          // ðŸš€ BROADCAST: OznÃ¡mit Layout.js Å¾e draft byl aktualizovÃ¡n (zÅ¯stÃ¡vÃ¡ v edit reÅ¾imu)
          window.dispatchEvent(new CustomEvent('orderDraftChange', {
            detail: {
              hasDraft: true,
              isEditMode: true,  // StÃ¡le v editaÄnÃ­m reÅ¾imu
              orderId: savedOrderId,
              orderNumber: formData.ev_cislo || formData.cislo_objednavky,
              isLoading: false
            }
          }));
          addDebugLog('success', 'UPDATE', 'broadcast', `Broadcast orderDraftChange odeslÃ¡n (hasDraft: true, isEditMode: true, orderId: ${savedOrderId})`);
        } catch (error) {
          addDebugLog('error', 'UPDATE', 'draft-update-error', `Chyba pÅ™i aktualizaci draftu: ${error.message}`);
        }

        addDebugLog('success', 'UPDATE', 'workflow-update', `Workflow stav aktualizovÃ¡n: ${updatedWorkflowKod}`);

        // FÃZE se automaticky pÅ™epoÄÃ­tÃ¡ z aktualizovanÃ©ho formData.stav_workflow_kod
        addDebugLog('success', 'UPDATE', 'workflow-state', `DB stav: ${updatedWorkflowKod} - fÃ¡ze se pÅ™epoÄÃ­tÃ¡ automaticky`);

        // ðŸŽ‰ TOAST NOTIFIKACE pro UPDATE - zobrazit AÅ½ PO aktualizaci state
        if (shouldStayOnForm) {
          // SUPERADMIN/ADMIN - zÅ¯stÃ¡vÃ¡ na formulÃ¡Å™i, zobrazit toast
          const orderNumber = formData.ev_cislo || formData.cislo_objednavky || savedOrderId;
          showToast && showToast(`ObjednÃ¡vka ${orderNumber} byla ÃºspÄ›Å¡nÄ› aktualizovÃ¡na`, { type: 'success' });
        } else {
          // BÄ›Å¾nÃ½ uÅ¾ivatel - zobrazit obecnou zprÃ¡vu (bude pÅ™esmÄ›rovÃ¡n)
          if (result.message) {
            showToast && showToast(result.message, { type: 'success' });
          } else {
            const orderNumber = formData.ev_cislo || formData.cislo_objednavky || savedOrderId;
            showToast && showToast(`ObjednÃ¡vka ${orderNumber} byla ÃºspÄ›Å¡nÄ› aktualizovÃ¡na`, { type: 'success' });
          }
        }

        // Debug: Zkontroluj, zda mÃ¡ workflow stav SCHVALENA
        const hasSchvalena = hasWorkflowState(updatedWorkflowKod, 'SCHVALENA');
        addDebugLog('info', 'UPDATE', 'phase-check', `MÃ¡ SCHVALENA: ${hasSchvalena}, novÃ¡ fÃ¡ze by mÄ›la bÃ½t: ${hasSchvalena ? '2' : '1'}`);

        // ðŸ”’ DÅ®LEÅ½ITÃ‰: Zachovat stav isPhase3Unlocked po UPDATE
        // Zkontrolovat, zda byla Phase 3 pÅ™ed UPDATE odemÄena
        // âŒ REMOVED: isPhase3Unlocked logic - pouÅ¾Ã­vÃ¡me WorkflowManager

        // Po ÃºspÄ›Å¡nÃ©m UPDATE - reset stavÅ¯ a refresh autosave
        // Reset odemknutÃ­ pouze pokud je objednÃ¡vka skuteÄnÄ› schvÃ¡lenÃ¡
        if (hasWorkflowState(updatedWorkflowKod, 'SCHVALENA')) {
          setIsPhase1Unlocked(false); // Reset odemknutÃ­ pouze pro schvÃ¡lenou objednÃ¡vku
          addDebugLog('info', 'UPDATE', 'lock-sections', 'FÃZE 1 sekce zamÄeny - objednÃ¡vka je schvÃ¡lenÃ¡');
        } else {
          addDebugLog('info', 'UPDATE', 'keep-unlocked-phase1', `FÃZE 1 sekce zÅ¯stÃ¡vajÃ­ odemÄenÃ© - stav: ${updatedWorkflowKod}`);
        }

        // Pro FÃZE 2: Zamknout pokud DB obsahuje ODESLANA/ZRUSENA
        const hasOdeslanaInUpdatedState = hasWorkflowState(updatedWorkflowKod, 'ODESLANA');
        const hasZrusenaInUpdatedState = hasWorkflowState(updatedWorkflowKod, 'ZRUSENA');

        // ZamykÃ¡nÃ­ Å™eÅ¡Ã­ useEffect podle formData.stav_workflow_kod

        // ZAMKNOUT FÃZE 2 - pokud je objednÃ¡vka odeslanÃ¡/zruÅ¡enÃ¡
        // KONTROLA POUZE podle DB workflow stavu - NE podle UI checkboxu stav_stornovano!
        addDebugLog('success', 'UPDATE', 'direct-lock-check', `PÅ™Ã­mÃ© zamykÃ¡nÃ­ FÃZE 2. NovÃ½ stav: ${updatedWorkflowKod}`);
        const shouldLockPhase2Now = (
          hasWorkflowState(updatedWorkflowKod, 'ODESLANA') ||
          hasWorkflowState(updatedWorkflowKod, 'ZRUSENA')
        );

        if (shouldLockPhase2Now) {
          // ðŸŽ¯ Zkontrolovat pÅ™es DraftManager, jestli nenÃ­ Phase 2 ruÄnÄ› odemÄeno
          let isManuallyUnlocked = false;
          try {
            const uiState = draftManager.getUIState();
            if (uiState) {
              const currentOrderId = formData.id;
              // Kontrolovat pouze pokud existuje ID objednÃ¡vky
              if (currentOrderId && uiState.phase2OrderId === currentOrderId && uiState.phase2Unlocked === true) {
                isManuallyUnlocked = true;
              }
            }
          } catch (e) {
            addDebugLog('warning', 'UPDATE', 'unlock-check-error', `Chyba pÅ™i kontrole Phase 2 unlock stavu: ${e.message}`);
          }

          if (isManuallyUnlocked) {
            addDebugLog('info', 'UPDATE', 'phase2-keep-unlocked', `FÃZE 2 zÅ¯stÃ¡vÃ¡ ODEMÄŒENA - byla ruÄnÄ› odemÄena`);
          } else {
            setIsPhase3SectionsUnlocked(false);
          }
        }
        setHasTriedToSubmit(false); // Reset validace po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­

        // KRITICKÃ‰: Synchronizace uÅ¾ probÄ›hla pÅ™es DraftManager.syncWithDatabase()
        // saveDraftWithData() uÅ¾ nenÃ­ potÅ™eba - data jsou uÅ¾ uloÅ¾ena

        // PouÅ¾ij explicitnÃ­ data mÃ­sto aktuÃ¡lnÃ­ho stavu formData
        // KRITICKÃ‰: orderId potÅ™ebujeme pro dalÅ¡Ã­ operace (mÅ¯Å¾e bÃ½t pouÅ¾it i nÃ­Å¾e)
        // âœ… V2 API: result je pÅ™Ã­mo data objednÃ¡vky, NE result.data!
        const updateOrderId = result.id || formData.id || savedOrderId;

        // POZNÃMKA: Autosave byl pÅ™esunut do DraftManager.syncWithDatabase()
        // NenÃ­ potÅ™eba volat saveDraftWithData - zpÅ¯sobovalo duplicitnÃ­ zÃ¡pis
        addDebugLog('info', 'AUTOSAVE', 'skip-duplicate', `Autosave pÅ™eskoÄen - jiÅ¾ proveden pÅ™es DraftManager.syncWithDatabase()`);

        // === SUPERADMIN/ADMIN zachovÃ¡nÃ­ draftu i po UPDATE ===
        // POUÅ½IJ jiÅ¾ deklarovanÃ© promÄ›nnÃ© z nadÅ™azenÃ©ho scope (Å™Ã¡dek ~5203-5205)

        // RESET isChanged - data jsou synchronizovÃ¡na s DB
        setIsChanged(false);

        // KRITICKÃ‰: Pro bÄ›Å¾nÃ© uÅ¾ivatele spustit progress a pÅ™esmÄ›rovÃ¡nÃ­ (stejnÄ› jako u INSERT)
        const shouldShowProgress = !shouldStayOnForm; // BÄ›Å¾nÃ­ uÅ¾ivatelÃ© vidÃ­ progress
        const orderNumber = formData.ev_cislo || formData.cislo_objednavky || savedOrderId;

        if (shouldShowProgress) {
          // ï¿½ SYNCHRONNÃ MAZÃNÃ VÅ ECH KLÃÄŒÅ® - NESMÃ SE DOSTAT DO RACE CONDITION S NAVIGATE()
          setDisableAutosave(true);
          disableAutosaveRef.current = true; // ðŸš€ OKAMÅ½ITÄš zakÃ¡zat autosave (REF)
          setIsEditMode(false);
          setSavedOrderId(null);
          setIsConceptSaved(false);

          // ðŸŽ¯ PouÅ¾ij DraftManager pro CENTRALIZOVANÃ‰ mazÃ¡nÃ­ VÅ ECH klÃ­ÄÅ¯ (ASYNCHRONNÄš pro verifikaci)
          if (user_id) {
            draftManager.setCurrentUser(user_id);
            const deleted = await draftManager.deleteAllDraftKeys();

            if (deleted) {
              addDebugLog('success', 'UPDATE', 'draftmanager-delete', `VÅ¡echny klÃ­Äe smazÃ¡ny pÅ™es DraftManager`);
            } else {
            }
          }

          startSaveProgressAndRedirect(orderNumber, updateOrderId);
        } else {
          // SUPERADMIN/ADMIN - zÅ¯stÃ¡vÃ¡ na formulÃ¡Å™i v edit reÅ¾imu
          // âœ… Povolit autosave zpÄ›t (zÅ¯stÃ¡vajÃ­ editovat)
          setDisableAutosave(false);
          disableAutosaveRef.current = false;
          draftManager.setAutosaveEnabled(true, 'SUPERADMIN/ADMIN stays on form after UPDATE');
          addDebugLog('info', 'UPDATE', 'stay-on-form', `SUPERADMIN/ADMIN zÅ¯stÃ¡vÃ¡ na formulÃ¡Å™i - koncept NENÃ smazÃ¡n`);

          // âœ… ADMIN: Automaticky rozbalit sprÃ¡vnou sekci podle novÃ© fÃ¡ze
          setTimeout(() => {
            const newPhase = getCurrentPhase();
            addDebugLog('info', 'UPDATE', 'phase-auto-navigate', `AutomatickÃ¡ navigace na fÃ¡zi: ${newPhase}`);

            // Rozbalit pÅ™Ã­sluÅ¡nou sekci podle fÃ¡ze
            if (newPhase === 3) {
              // FÃ¡ze 3 - rozbalit sekci odeslÃ¡nÃ­
              setSectionStates(prev => ({ ...prev, stav_odeslani: false }));
              setTimeout(() => {
                const odeslani = document.querySelector('[data-section="stav_odeslani"]');
                if (odeslani) {
                  odeslani.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }, 100);
            } else if (newPhase === 4) {
              // FÃ¡ze 4 - rozbalit sekci potvrzenÃ­
              setSectionStates(prev => ({ ...prev, potvrzeni_objednavky: false }));
              setTimeout(() => {
                const potvrzeni = document.querySelector('[data-section="potvrzeni_objednavky"]');
                if (potvrzeni) {
                  potvrzeni.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              }, 100);
            }
          }, 500); // Delay aby se stihlo aktualizovat formData
        }
      }

    } catch (error) {
      const endpoint = (!isOrderSavedToDB || !savedOrderId) ? 'orders25/partial-insert' : 'orders25/partial-update';
      addDebugLog('error', 'API', endpoint, error.message);

      // Zpracovat HTTP 423 error (zamÄeno jinÃ½m uÅ¾ivatelem)
      if (error.lock_info) {
        const lockInfo = error.lock_info;
        
        // âœ… FIX: Kontrolovat POUZE locked === true (= zamÄeno JINÃM uÅ¾ivatelem)
        // locked === false znamenÃ¡ "mÅ¯Å¾u editovat" (volnÃ¡ NEBO moje zamÄenÃ¡)
        if (lockInfo.locked === true) {
          // âŒ ZamÄeno JINÃM uÅ¾ivatelem - zobrazit chybu o zamÄenÃ­
          const userName = lockInfo.locked_by_user_fullname || `uÅ¾ivatel #${lockInfo.locked_by_user_id}`;
          const lockAge = lockInfo.lock_age_minutes
            ? ` (zamÄeno pÅ™ed ${lockInfo.lock_age_minutes} minutami)`
            : '';

          showToast && showToast(
            `Nelze uloÅ¾it zmÄ›ny. ObjednÃ¡vka je zamÄena uÅ¾ivatelem ${userName}${lockAge}`,
            { type: 'error' }
          );
          
          addDebugLog('error', 'LOCK', 'order-locked-by-other', `ObjednÃ¡vka zamÄena uÅ¾ivatelem ${userName}`);
        } else {
          // âœ… locked === false â†’ MOJE objednÃ¡vka nebo volnÃ¡, zobrazit obecnou chybu
          const errorMsg = translateErrorMessageShort(error.message);
          showToast && showToast(`NepodaÅ™ilo se uloÅ¾it objednÃ¡vku: ${errorMsg}`, { type: 'error' });
          
          addDebugLog('info', 'LOCK', 'order-owned-by-me', `Lock info pÅ™Ã­tomen, ale locked=false (moje objednÃ¡vka)`);
        }
      } else {
        const errorMsg = translateErrorMessageShort(error.message);
        showToast && showToast(`NepodaÅ™ilo se uloÅ¾it objednÃ¡vku: ${errorMsg}`, { type: 'error' });
      }

      // âœ… Povolit autosave zpÄ›t pÅ™i chybÄ› (uÅ¾ivatel mÅ¯Å¾e pokraÄovat v editaci)
      setDisableAutosave(false);
      disableAutosaveRef.current = false;
      draftManager.setAutosaveEnabled(true, 'Error during save - re-enable autosave');

      setIsSaving(false); // VyÄistit saving stav pÅ™i chybÄ›
    } finally {
      // Trigger user activity update after successful save
      triggerActivity();

      setIsSavingDraft(false);

      // ðŸ”’ KRITICKÃ‰: PoÄkat na aktualizaci workflow state pÅ™ed odemÄenÃ­m UI
      if (window.__workflowStateUpdated) {
        addDebugLog('info', 'SAVE', 'waiting-for-workflow', `ÄŒekÃ¡m na propagaci workflow state do React...`);

        // PoÄkat na render cycle pomocÃ­ setTimeout
        setTimeout(() => {
          addDebugLog('info', 'SAVE', 'workflow-propagated', `Workflow state propagovÃ¡n, resetuji isSaving`);
          window.__workflowStateUpdated = false;
          setIsSaving(false);
          addDebugLog('info', 'SAVE', 'finally-cleanup', `isSaving resetovÃ¡no po workflow update`);
        }, 200); // ZvÃ½Å¡il jsem na 200ms pro jistotu
      } else {
        addDebugLog('info', 'SAVE', 'no-workflow-update', 'Workflow nebyl aktualizovÃ¡n, resetuji isSaving hned');
        setTimeout(() => {
          setIsSaving(false);
          addDebugLog('info', 'SAVE', 'finally-cleanup', `isSaving resetovÃ¡no bez workflow update`);
        }, 100);
      }

      // ðŸš€ CACHE: Invaliduj cache po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
      try {
        addDebugLog('info', 'SAVE', 'cache-invalidation', 'Invaliduji orders cache...');
        ordersCacheService.invalidate(user_id);
      } catch (e) {
      }

      // âœ… SpusÅ¥ background refresh objednÃ¡vek + notifikacÃ­
      try {
        addDebugLog('info', 'SAVE', 'background-refresh', 'SpouÅ¡tÃ­m postOrderAction background task...');
        backgroundTaskService.runTaskNow('postOrderAction');
      } catch (e) {
      }

      // ðŸ”„ Broadcast zmÄ›nu stavu do menu baru po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
      try {
        // ï¿½ KRITICKÃ ZMÄšNA: Po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ NEPROVÃDÄšT Å¾Ã¡dnÃ© draft operace
        // Draft byl jiÅ¾ smazÃ¡n v if(shouldShowProgress) bloku vÃ½Å¡e
        // Broadcast by mohl zpÅ¯sobit znovu-vytvoÅ™enÃ­ draftu
        // Zjisti fÃ¡zi a ÄÃ­slo objednÃ¡vky pro orderSaved broadcast
        const orderNumber = formData.ev_cislo || formData.cislo_objednavky || '';
        const orderId = formData.id || savedOrderId;

        // ðŸš« VYPNUTO: ZpÅ¯sobovalo blikÃ¡nÃ­ MenuBaru mezi stavy
        /*
        // Pokud byla objednÃ¡vka uloÅ¾ena do DB, oznÃ¡mit to ostatnÃ­m zÃ¡loÅ¾kÃ¡m
        if (orderId && orderNumber) {
          broadcastOrderSaved(orderId, orderNumber);
        }

        // KRITICKÃ‰: UrÄit znovu role uÅ¾ivatele pro broadcast (musÃ­ bÃ½t i ve finally bloku)
        const isSuperAdmin = userDetail?.roles?.some(role => role.kod_role === 'SUPERADMIN');
        const isAdmin = userDetail?.roles?.some(role => role.kod_role === 'ADMINISTRATOR');
        const shouldStayOnForm = isSuperAdmin || isAdmin;

        // KRITICKÃ‰: UrÄit isEditMode podle toho, zda mÃ¡ objednÃ¡vka ID v DB
        // ALE: Pro bÄ›Å¾nÃ© uÅ¾ivatele (kteÅ™Ã­ budou pÅ™esmÄ›rovÃ¡ni) VÅ½DY poslat false
        // Pro SUPERADMIN/ADMIN (kteÅ™Ã­ zÅ¯stÃ¡vajÃ­) poslat true pokud mÃ¡ orderId
        const isEdit = shouldStayOnForm ? !!orderId : false;

        // ðŸš« KRITICKÃ‰: Po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­ VÅ½DY poslat hasDraft: false
        // Draft byl jiÅ¾ smazÃ¡n v deleteAllDraftKeys() vÃ½Å¡e
        window.dispatchEvent(new CustomEvent('orderDraftChange', {
          detail: {
            hasDraft: false,  // â† VÅ½DY FALSE po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­!
            isEditMode: isEdit,
            orderId: orderId || formData.id,
            orderNumber: orderNumber,
            isLoading: false
          }
        }));
        addDebugLog('success', 'SAVE', 'broadcast', `Broadcast orderDraftChange odeslÃ¡n (hasDraft: false, isEditMode: ${isEdit}, shouldStayOnForm: ${shouldStayOnForm})`);
        */
      } catch (e) {
        // Ignorovat chybu broadcastu
      }
    }
  };

  // ðŸŽ¯ HELPER: SjednocenÃ¡ funkce pro uklÃ¡dÃ¡nÃ­ draftu s konzistentnÃ­m API
  const saveDraftUnified = async (formDataToSave, options = {}) => {
    const {
      isAutoSave = false,
      explicitSavedOrderId,
      attachmentsToSave = attachments,
      isAfterDbSave = false
    } = options;

    if (!user_id) {
      if (!isAutoSave) {
        showToast && showToast('Nelze uloÅ¾it koncept - nejste pÅ™ihlÃ¡Å¡en', { type: 'error' });
      }
      return false;
    }

    // ðŸ”’ KRITICKÃ‰: Kontrola zda je autosave povolen
    if (isAutoSave && !draftManager.isAutosaveEnabled()) {
      return false;
    }

    // ðŸ†• Å˜EÅ ENÃ PROBLÃ‰MU #3: NEuklÃ¡dat draft pokud ev_cislo je "NaÄÃ­tÃ¡m..."
    if (formDataToSave.ev_cislo === 'NaÄÃ­tÃ¡m...') {
      return false;
    }

    try {
      if (isAutoSave) {
        setIsAutoSaving(true);
      } else {
        setIsSavingDraft(true);
      }

      // Nastavit current user
      draftManager.setCurrentUser(user_id);

      // Zkontroluj existujÃ­cÃ­ draft pro firstSaveDate
      const existingDraft = await draftManager.hasDraft();
      let firstSaveDate = null;

      if (!existingDraft && isAutoSave) {
        firstSaveDate = new Date().toISOString();
      } else if (existingDraft) {
        try {
          const existing = await draftManager.loadDraft();
          firstSaveDate = existing?.firstAutoSaveDate || new Date().toISOString();
        } catch {
          firstSaveDate = new Date().toISOString();
        }
      }

      // PÅ™iprav formData kopii - uklÃ¡dÃ¡ se CELÃ formData vÄetnÄ› individualni_schvaleni a pojistna_udalost_cislo
      const draftFormData = { ...formDataToSave };

      // âŒ DEPRECATED: StarÃ½ kÃ³d pro zpracovÃ¡nÃ­ financovÃ¡nÃ­ - NEPOUÅ½ÃVÃ SE (formData.financovani nenÃ­ objekt)
      // NovÃ© API pouÅ¾Ã­vÃ¡: zpusob_financovani, lp_kod, cislo_smlouvy, individualni_schvaleni, pojistna_udalost_cislo atd.
      if (typeof draftFormData.financovani === 'object' && draftFormData.financovani !== null) {
        addDebugLog('warning', 'DRAFT', 'deprecated-financovani-block', 'âš ï¸ DEPRECATED blok se spustil - mÄ›l by bÃ½t mrtvÃ½ kÃ³d!');
        const financovaniObj = {
          typ_financovani: formDataToSave.typ_financovani || '',
          uhrada_faktury: formDataToSave.uhrada_faktury || '',
          doplnujici_data: {}
        };

        if (formDataToSave.kod_strediska_financovani) financovaniObj.doplnujici_data.kod_strediska_financovani = formDataToSave.kod_strediska_financovani;
        if (formDataToSave.organizacni_jednotka) financovaniObj.doplnujici_data.organizacni_jednotka = formDataToSave.organizacni_jednotka;
        if (formDataToSave.ios) financovaniObj.doplnujici_data.ios = formDataToSave.ios;
        if (formDataToSave.zakazka) financovaniObj.doplnujici_data.zakazka = formDataToSave.zakazka;

        if (formDataToSave.typ_financovani === 'pojistne_udalosti') {
          if (formDataToSave.pojistna_udalost_cislo) financovaniObj.doplnujici_data.pojistna_udalost_cislo = formDataToSave.pojistna_udalost_cislo;
          if (formDataToSave.pojistna_udalost_poznamka) financovaniObj.doplnujici_data.pojistna_udalost_poznamka = formDataToSave.pojistna_udalost_poznamka;
        }

        draftFormData.financovani = JSON.stringify(financovaniObj);
      }

      // Serializuj attachments (odstraÅˆ File objekty)
      const serializableAttachments = attachmentsToSave.map(att => {
        if (att.file) {
          const { file, ...rest } = att;
          return { ...rest, _hadFile: true };
        }
        return att;
      });

      // UrÄit savedOrderId
      // ðŸ”§ FIX: Pokud savedOrderId je null, ale formData.id existuje, pouÅ¾ij formData.id
      // (objednÃ¡vka je v DB, ale savedOrderId state nebyl nastaven pÅ™i naÄtenÃ­ draftu)
      const effectiveSavedOrderId = explicitSavedOrderId !== undefined
        ? explicitSavedOrderId
        : (savedOrderId || (formDataToSave.id ? formDataToSave.id : null));

      // ï¿½ FIX: Pokud jsme detekovali savedOrderId z formData.id, aktualizuj state
      if (!savedOrderId && effectiveSavedOrderId && formDataToSave.id) {
        setSavedOrderId(effectiveSavedOrderId);
      }

      // ðŸ” DEBUG: savedOrderId tracking

      // Zkontrolovat fÃ¡ze 7/8 data
      const hasPhase7Or8Data = Boolean(
        draftFormData.vecna_spravnost_umisteni_majetku ||
        draftFormData.vecna_spravnost_poznamka ||
        draftFormData.dokonceni_poznamka
      );

      // âœ… SPRÃVNÃ‰ API: saveDraft(formData, options)
      await draftManager.saveDraft(draftFormData, {
        orderId: effectiveSavedOrderId,
        attachments: serializableAttachments,
        metadata: {
          firstAutoSaveDate: firstSaveDate,
          version: '1.4',
          isConceptSaved: true,
          isOrderSavedToDB,
          savedOrderId: effectiveSavedOrderId,
          isChanged: isAfterDbSave ? hasPhase7Or8Data : true,
          dictionaries: {
            approvers: approvers || [],
            users: allUsers || [],
            strediska: strediskaOptions || [],
            financovani: financovaniOptions || [],
            druhyObjednavky: druhyObjednavkyOptions || [],
            lpKody: lpKodyOptions || []
          }
        }
      });

      setLastAutoSave(new Date().toISOString());
      setIsConceptSaved(true);

      setTimeout(() => {
        setIsAutoSaving(false);
        setDataSource(null);
      }, isAutoSave ? 300 : 0);

      if (!isAutoSave) {
        showToast && showToast('Koncept byl uloÅ¾en do mÃ­stnÃ­ho ÃºloÅ¾iÅ¡tÄ›', { type: 'success' });
      }

      return true;
    } catch (error) {
      if (!isAutoSave) {
        showToast && showToast('NepodaÅ™ilo se uloÅ¾it koncept', { type: 'error' });
      }
      setIsAutoSaving(false);
      setIsSavingDraft(false);
      return false;
    }
  };

  // PomocnÃ¡ funkce pro uloÅ¾enÃ­ draftu s explicitnÃ­mi daty
  const saveDraftWithData = async (explicitFormData, isAutoSave = false, explicitSavedOrderId = undefined) => {
    return saveDraftUnified(explicitFormData, {
      isAutoSave,
      explicitSavedOrderId
    });
  };

  const saveDraft = async (isAutoSave = false, isAfterDbSave = false, customFormData = null) => {
    // ðŸš¨ KRITICKÃ KONTROLA: Pokud se formulÃ¡Å™ zavÃ­rÃ¡, ZABLOKOVAT save
    if (isClosingRef.current) {
      console.log('ðŸš« saveDraft BLOCKED - formulÃ¡Å™ se zavÃ­rÃ¡');
      return { success: false, reason: 'form_closing' };
    }
    
    // ðŸ“¦ PouÅ¾Ã­t custom data nebo aktuÃ¡lnÃ­ formData ze state
    const dataToSave = customFormData || formData;

    return saveDraftUnified(dataToSave, {
      isAutoSave,
      isAfterDbSave
    });
  };

  // ðŸŽ¯ Nastavit callback pro useAutosave hook
  useEffect(() => {
    autosaveCallbackRef.current = saveDraft;
  }, [saveDraft]);

  // Funkce pro revalidaci objednÃ¡vky s DB (ovÄ›Å™Ã­ aktuÃ¡lnÃ­ stav v databÃ¡zi)
  /**
   * ðŸ”§ Helper funkce pro extrakci enriched user data z BE
   * Backend vracÃ­ _enriched objekt s detaily uÅ¾ivatelÅ¯
   * FormÃ¡t: _enriched.objednatel, _enriched.garant, _enriched.prikazce atd.
   */
  const extractEnrichedUserData = (enrichedField) => {
    if (!enrichedField) return null;

    const titul_pred_str = enrichedField.titul_pred ? enrichedField.titul_pred + ' ' : '';
    const jmeno_str = enrichedField.jmeno || '';
    const prijmeni_str = enrichedField.prijmeni || '';
    const titul_za_str = enrichedField.titul_za ? ', ' + enrichedField.titul_za : '';
    const displayName = `${titul_pred_str}${jmeno_str} ${prijmeni_str}${titul_za_str}`.replace(/\s+/g, ' ').trim();

    return {
      displayName: displayName || enrichedField.username || '',
      email: enrichedField.email || '',
      telefon: enrichedField.telefon || ''
    };
  };

  const revalidateOrderWithDB = async (orderId) => {
    if (!orderId || !token || !username) {
      addDebugLog('warning', 'REVALIDATE', 'skip', 'ChybÃ­ orderId, token nebo username - pÅ™eskakuji revalidaci');
      return null;
    }

    try {
      addDebugLog('info', 'REVALIDATE', 'start', `Revaliduji objednÃ¡vku ID ${orderId} s databÃ¡zÃ­... (token: ${token?.substring(0, 10)}..., username: ${username})`);


      // âœ… V2 API: NaÄti objednÃ¡vku s enriched daty
      const dbOrder = await getOrderV2(orderId, token, username, true);

      addDebugLog('info', 'REVALIDATE', 'api-response', `API odpovÄ›Ä pro ID ${orderId}: ${JSON.stringify(dbOrder, null, 2)}`);

      if (!dbOrder) {
        addDebugLog('error', 'REVALIDATE', 'null-response', `API vrÃ¡tilo null pro objednÃ¡vku ID ${orderId}`);
        return null;
      }

      // V2 API vracÃ­ pÅ™Ã­mo data objednÃ¡vky (ne objekt s .data polem)
      const orderData = dbOrder;

      // ï¿½ DEBUG: Zobrazit vÅ¡echna enriched data z backendu
      if (orderData._enriched) {
        addDebugLog('info', 'REVALIDATE', 'enriched-keys', `Enriched klÃ­Äe: ${Object.keys(orderData._enriched).join(', ')}`);
      }

      // ï¿½ðŸ”§ KRITICKÃ‰: Doplnit Ãºdaje objednatele z _enriched NEBO ÄÃ­selnÃ­ku uÅ¾ivatelÅ¯
      if (orderData.objednatel_id) {
        // 1. Priorita: PouÅ¾ij enriched data z backendu (pokud existujÃ­)
        if (orderData._enriched?.objednatel) {
          const enriched = extractEnrichedUserData(orderData._enriched.objednatel);
          if (enriched) {
            orderData.jmeno = enriched.displayName;
            orderData.email = enriched.email;
            orderData.telefon = enriched.telefon;
            addDebugLog('success', 'REVALIDATE', 'objednatel-enriched-be', `PouÅ¾ity enriched data z BE: ${enriched.displayName}`);
          }
        }
        // 2. Fallback: Dohledat v ÄÃ­selnÃ­ku uÅ¾ivatelÅ¯ (pokud enriched data chybÃ­)
        else if (allUsers && allUsers.length > 0) {
          const objednatel = allUsers.find(u =>
            (u.id && u.id === orderData.objednatel_id) ||
            (u.user_id && u.user_id === orderData.objednatel_id)
          );

          if (objednatel) {
            const titul_pred_str = objednatel.titul_pred ? objednatel.titul_pred + ' ' : '';
            const jmeno_str = objednatel.jmeno || '';
            const prijmeni_str = objednatel.prijmeni || '';
            const titul_za_str = objednatel.titul_za ? ', ' + objednatel.titul_za : '';
            const displayName = `${titul_pred_str}${jmeno_str} ${prijmeni_str}${titul_za_str}`.replace(/\s+/g, ' ').trim();

            orderData.jmeno = displayName || objednatel.username || '';
            orderData.email = objednatel.email || '';
            orderData.telefon = objednatel.telefon || '';

            addDebugLog('success', 'REVALIDATE', 'objednatel-enriched-fe', `DoplnÄ›ny Ãºdaje z FE ÄÃ­selnÃ­ku: ${displayName}`);
          } else {
            addDebugLog('warning', 'REVALIDATE', 'objednatel-not-found', `Objednatel ID ${orderData.objednatel_id} nenalezen`);
          }
        }
      }

      addDebugLog('success', 'REVALIDATE', 'loaded', `NaÄtena objednÃ¡vka z DB: ID=${orderData.id}, stav_workflow_kod="${orderData.stav_workflow_kod}", ev_cislo="${orderData.cislo_objednavky || orderData.ev_cislo}"`);

      return orderData;
    } catch (error) {
      addDebugLog('error', 'REVALIDATE', 'failed', `Chyba pÅ™i revalidaci: ${error.message}`);
      return null;
    }
  };
  const deleteDraft = async () => {
    if (!user_id) return;

    try {
      // ðŸŽ¯ CENTRALIZOVANÃ‰ MAZÃNÃ pÅ™es DraftManager (ASYNCHRONNÄš pro verifikaci)
      draftManager.setCurrentUser(user_id);
      const deleted = await draftManager.deleteAllDraftKeys();

      if (!deleted) {
      }

      // ðŸ”¥ RESET STATES po smazÃ¡nÃ­ draftu
      setIsEditMode(false);
      setIsConceptSaved(false);
      setSavedOrderId(null);

      // ðŸ”¥ SmaÅ¾ draft pÅ™es DraftManager (centralizovanÄ›)
      try {
        draftManager.setCurrentUser(user_id);
        await draftManager.deleteDraft();
      } catch (e) {
      }
    } catch (error) {
    }
  };

  // VyÄistit pouze Phase 2 unlock stav (pÅ™i nÃ¡vratu do pÅ™edchozÃ­ fÃ¡ze)
  const clearPhase2UnlockState = () => {
    if (!user_id) return;

    try {
      // ðŸŽ¯ PouÅ¾Ã­t DraftManager pro vyÄiÅ¡tÄ›nÃ­
      draftManager.saveUIState({ phase2Unlocked: false });
      setIsPhase3SectionsUnlocked(false);
    } catch (error) {
    }
  };

  // ResetovÃ¡nÃ­ formulÃ¡Å™e do vÃ½chozÃ­ho stavu
  const resetForm = () => {
    // Reset formData do zÃ¡kladnÃ­ho stavu a nastavenÃ­ pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele jako objednatele
    setFormData({
      uzivatel_id: user_id || '',
      objednatel_id: user_id || '', // Nastav pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele jako objednatele
      jmeno: userDetail?.jmeno || '', // NaÄti jmÃ©no z userDetail
      email: userDetail?.email || '', // NaÄti email z userDetail
      telefon: userDetail?.telefon || '', // NaÄti telefon z userDetail
      predmet: '',
      popis_pozadavku: '',
      garant_uzivatel_id: '',
      prikazce_id: '',
      strediska_kod: [],
      max_cena_s_dph: '',
      // Objednatel Ãºdaje - naplÅˆ z userDetail
      objednatel_jmeno: userDetail ? getUserNameById(user_id) : '',
      objednatel_email: userDetail?.email || '',
      objednatel_telefon: userDetail?.telefon || '',
      poznamky: '',
      prilohy: [],
      ev_cislo: 'NaÄÃ­tÃ¡m...',
      // Reset polÃ­ pro schvÃ¡lenÃ­
      stav_schvaleni: '',
      schvalovatel_id: '',
      dt_schvaleni: '',
      schvaleni_komentar: '',
      stav_workflow_kod: '["ODESLANA_KE_SCHVALENI"]', // âœ… NovÃ¡ objednÃ¡vka zaÄÃ­nÃ¡ rovnou stavem ODESLANA_KE_SCHVALENI
      // ðŸ”§ KRITICKÃ OPRAVA: Nastavit datumovÃ© Ãºdaje pro novou objednÃ¡vku
      temp_datum_objednavky: new Date().toISOString().split('T')[0], // DoÄasnÃ© datum objednÃ¡vky
      datum_vytvoreni: '', // Datum vytvoÅ™enÃ­ se nastavÃ­ aÅ¾ pÅ™i prvnÃ­m uloÅ¾enÃ­ do DB
      datum_splatnosti: '' // Datum splatnosti zatÃ­m prÃ¡zdnÃ©
    });

    // Reset stavÅ¯ uloÅ¾enÃ© objednÃ¡vky
    setIsConceptSaved(false);
    // isOrderSavedToDB se odvodÃ­ automaticky z formData.id
    setSavedOrderId(null);

    // Reset validaÄnÃ­ch chyb a touched fields
    setValidationErrors({});
    setTouchedSelectFields(new Set());

    // Reset auto-save ÄasovÃ©ho razÃ­tka
    setLastAutoSave(null);

    // Reset editaÄnÃ­ho reÅ¾imu
    setIsEditMode(false);

    // Reset flagÅ¯
    setIsDraftLoaded(false);

    // âœ… Povolit autosave pÅ™i resetu formulÃ¡Å™e (novÃ¡ objednÃ¡vka)
    setDisableAutosave(false);
    disableAutosaveRef.current = false;
    draftManager.setAutosaveEnabled(true, 'Form reset - new order');

    // ðŸŽ¯ VyÄistit uloÅ¾enÃ© stavy UI pÅ™es DraftManager
    if (user_id) {
      try {
        draftManager.saveUIState({
          sectionState: {},
          scrollPosition: 0
        });
      } catch (error) {
      }
    }

    addDebugLog('info', 'FORM', 'reset', 'FormulÃ¡Å™ resetovÃ¡n do vÃ½chozÃ­ho stavu');
  };

  const hasDraft = () => {
    if (!user_id) return false;
    draftManager.setCurrentUser(user_id);
    return draftManager.hasDraft();
  };

  // HlavnÃ­ inicializaÄnÃ­ funkce s progress barem
  const initializeForm = async () => {

    if (!token || !username) {
      setIsFormInitializing(false);
      setIsLoadingCiselniky(false); // ðŸŽ¯ NOVÃ‰: ÄŒÃ­selnÃ­ky nejsou naÄtenÃ© (chyba)
      setInitializationError('Nejste pÅ™ihlÃ¡Å¡en');
      return;
    }

    try {
      setIsFormInitializing(true);
      setIsLoadingCiselniky(true); // ðŸŽ¯ NOVÃ‰: ZaÄÃ­nÃ¡me naÄÃ­tat ÄÃ­selnÃ­ky
      setInitializationError(null);

      // âŒ DEPRECATED: dictionariesReadyPromiseRef - pouÅ¾ij areDictionariesReady
      // dictionariesReadyPromiseRef.current = new Promise((resolve) => {
      //   dictionariesReadyResolveRef.current = resolve;
      // });

      // Start progress bar
      if (startGlobalProgress) startGlobalProgress();
      if (setGlobalProgress) setGlobalProgress(10);

      // ðŸ—‘ï¸ REMOVED: FormDataManager.registerStateCallbacks
      // ÄŒÃ­selnÃ­ky se nynÃ­ naÄÃ­tajÃ­ pÅ™es useFormController â†’ useDictionaries
      // State settery uÅ¾ neexistujÃ­ - data jsou v dictionariesReducer

      if (setGlobalProgress) setGlobalProgress(30);

      // ðŸŽ¯ INICIALIZACE PÅ˜ES MANAGER - NEJDÅ˜ÃV naÄti slovnÃ­ky
      const cache = await formDataManager.initialize({
        token,
        username,
        formDataId: formData.id
      });

      if (setGlobalProgress) setGlobalProgress(60);

      if (setGlobalProgress) setGlobalProgress(90);

      // Kontrola, jestli jsou data naÄtenÃ¡
      const hasData = (
        cache.users.length > 0 ||
        cache.approvers.length > 0 ||
        cache.strediska.length > 0 ||
        cache.lpKody.length > 0
      );

      if (!hasData) {
        const errorMsg = 'NepodaÅ™ilo se naÄÃ­st Å¾Ã¡dnÃ¡ data z API';
        setInitializationError(errorMsg);
        setIsLoadingCiselniky(false); // ðŸŽ¯ NOVÃ‰: ÄŒÃ­selnÃ­ky se nepodaÅ™ilo naÄÃ­st

        if (showToast) showToast(errorMsg, { type: 'error' });
        if (failGlobalProgress) failGlobalProgress();
      } else {
        // ðŸ—‘ï¸ REMOVED: setAreDictionariesReady - uÅ¾ se nepouÅ¾Ã­vÃ¡
        // Flag areDictionariesReady je nynÃ­ alias na dictionaries.isReady
        setIsLoadingCiselniky(false); // ðŸŽ¯ NOVÃ‰: ÄŒÃ­selnÃ­ky jsou naÄtenÃ©!
        setIsInitialized(true);

        // ðŸŽ¯ RESOLVE PROMISE se dÄ›lÃ¡ v useEffect, kterÃ½ ÄekÃ¡ na skuteÄnou zmÄ›nu options
        // NE tady - tady se jen nastavÃ­ flag

        if (doneGlobalProgress) doneGlobalProgress();

        // ðŸš« ZRUÅ ENO: ObnovenÃ­ pozice scrollu (na Å¾Ã¡dost uÅ¾ivatele)
        // if (hasDraft() && user_id) {
        //   draftManager.setCurrentUser(user_id);
        //   loadScrollPosition();
        // }
      }

    } catch (error) {
      const errorMsg = 'NepodaÅ™ilo se inicializovat formulÃ¡Å™';
      setInitializationError(errorMsg);
      setIsLoadingCiselniky(false); // ðŸŽ¯ NOVÃ‰: Chyba pÅ™i naÄÃ­tÃ¡nÃ­ ÄÃ­selnÃ­kÅ¯

      // âŒ DEPRECATED: dictionariesReadyResolveRef - use areDictionariesReady
      // if (dictionariesReadyResolveRef.current) {
      //   dictionariesReadyResolveRef.current(false);
      // }

      if (showToast) showToast(errorMsg, { type: 'error' });
      if (failGlobalProgress) failGlobalProgress();
    }
  };

  // NaÄÃ­tÃ¡nÃ­ Phase 2 unlock stavu z localStorage po naÄtenÃ­ objednÃ¡vky
  // POUZE pokud nebylo zamÄenÃ­ uÅ¾ zpracovÃ¡no pÅ™i naÄÃ­tÃ¡nÃ­ z DB
  useEffect(() => {
    if (formData.id && user_id && formData.stav_workflow_kod && !isPhase3SectionsLockProcessedFromDB) {

      try {
        // ðŸŽ¯ NaÄÃ­st stav pÅ™es DraftManager
        const uiState = draftManager.getUIState();
        if (uiState && uiState.phase2Unlocked) {
          // OvÄ›Å™it, Å¾e se jednÃ¡ o stejnou objednÃ¡vku (podle ID)
          if (uiState.phase2OrderId === formData.id && uiState.phase2Unlocked === true) {

            // Kontrola oprÃ¡vnÄ›nÃ­ a aktuÃ¡lnÃ­ho workflow stavu
            const isOrderSent = hasWorkflowState(formData.stav_workflow_kod, 'ODESLANA');
            const isOrderCancelled = hasWorkflowState(formData.stav_workflow_kod, 'ZRUSENA');
            // KONTROLA POUZE podle DB workflow stavu - NE podle UI checkboxu!
            const isOrderInPhase3OrHigher = isOrderSent || isOrderCancelled;

            // FINÃLNÃ TVRDÃ KONTROLA: I kdyÅ¾ uiState Å™Ã­kÃ¡ unlock, ZKONTROLUJ workflow stav!
            const currentWorkflowState = formData.stav_workflow_kod || 'NOVA';
            const hasOdeslano = hasWorkflowState(currentWorkflowState, 'ODESLANA');
            const hasZruseno = hasWorkflowState(currentWorkflowState, 'ZRUSENA');

            // Smazat unlock stav a zamknout POUZE pokud je stav v DB ODESLANA nebo ZRUSENA
            if (hasOdeslano || hasZruseno) {
              draftManager.saveUIState({ phase2Unlocked: false }); // SmaÅ¾ neplatnÃ½ stav
              setIsPhase3SectionsUnlocked(false);
            } else {
              setIsPhase3SectionsUnlocked(true);
            }
          }
        }
      } catch (e) {
        // Chyba pÅ™i naÄÃ­tÃ¡nÃ­ stavu
      }
    }
  }, [formData.id, user_id, formData.stav_workflow_kod, isPhase3SectionsLockProcessedFromDB]);

  // DODATEÄŒNÃ OCHRANA: SledovÃ¡nÃ­ setTimeout re-render a blokace dalÅ¡Ã­ localStorage kontroly
  const [preventLocalStorageCheck, setPreventLocalStorageCheck] = useState(false);

  useEffect(() => {
    if (isPhase3SectionsLockProcessedFromDB && !preventLocalStorageCheck) {
      setPreventLocalStorageCheck(true);
      addDebugLog('info', 'PHASE2-UNLOCK', 'prevention-set', `Nastavena prevence localStorage kontroly - zamÄenÃ­ zpracovÃ¡no z DB`);
    }
  }, [isPhase3SectionsLockProcessedFromDB, preventLocalStorageCheck]);

  // SledovÃ¡nÃ­ zmÄ›n workflow stavu pro vynucenÃ© zamÄenÃ­ Phase 2
  useEffect(() => {
    if (formData.id && formData.stav_workflow_kod && user_id) {
      const isOrderSent = hasWorkflowState(formData.stav_workflow_kod, 'ODESLANA');
      const isOrderCancelled = hasWorkflowState(formData.stav_workflow_kod, 'ZRUSENA');
      // KONTROLA POUZE podle DB workflow stavu - NE podle UI checkboxu!
      const isOrderInPhase3OrHigher = isOrderSent || isOrderCancelled;

      // VÅ½DY ZAMKNOUT pokud je objednÃ¡vka ve fÃ¡zi 3+ (ODESLANA/ZRUÅ ENA) a nenÃ­ ruÄnÄ› odemÄena
      if (isOrderInPhase3OrHigher && isPhase3SectionsUnlocked) {
        // ðŸŽ¯ Zkontrolovat jestli nenÃ­ ruÄnÄ› odemÄeno pÅ™es DraftManager
        let isManuallyUnlocked = false;
        try {
          const uiState = draftManager.getUIState();
          if (uiState) {
            // Kontrolovat pouze pokud existuje ID objednÃ¡vky
            if (formData.id && uiState.phase2OrderId === formData.id && uiState.phase2Unlocked === true) {
              isManuallyUnlocked = true;
            }
          }
        } catch (e) {
          // Chyba pÅ™i kontrole stavu
        }

        if (!isManuallyUnlocked) {
          setIsPhase3SectionsUnlocked(false);

          // ðŸŽ¯ VyÄistit stav pÅ™es DraftManager pokud nenÃ­ ruÄnÄ› odemÄeno
          try {
            draftManager.saveUIState({ phase2Unlocked: false });
          } catch (e) {
            // Chyba pÅ™i mazÃ¡nÃ­ stavu
          }
        }
      }
    }
  }, [formData.stav_workflow_kod, formData.id, user_id, isPhase3SectionsUnlocked]);

  // Reset stavu pÅ™i pÅ™echodu na novou objednÃ¡vku (po zruÅ¡enÃ­ editace)
  useEffect(() => {
    if (isNewOrder && userDetail && user_id) {

      // Reset stavu naÄÃ­tÃ¡nÃ­ draftu
      setIsDraftLoaded(false);
      setDataSource(null);
      setIsPhase3SectionsLockProcessedFromDB(false); // Reset flag pro novou objednÃ¡vku

      // VyplÅˆ Ãºdaje aktuÃ¡lnÄ› pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele
      const jmeno = `${userDetail.titul_pred ? userDetail.titul_pred + ' ' : ''}${userDetail.jmeno || ''} ${userDetail.prijmeni || ''}${userDetail.titul_za ? ', ' + userDetail.titul_za : ''}`.replace(/\s+/g, ' ').trim();

      setFormData(prev => ({
        ...prev,
        uzivatel_id: user_id,
        objednatel_id: user_id,
        jmeno: jmeno,
        email: userDetail.email || '',
        telefon: userDetail.telefon || '',
        // VymazÃ¡nÃ­ dat z pÅ™edchozÃ­ editace
        id: null,
        ev_cislo: '',
        cislo_objednavky: null,
        predmet: '',
        popis_pozadavku: '',
        max_cena_s_dph: '',
        polozky_objednavky: [{ id: Date.now(), popis: '', cena_bez_dph: '', sazba_dph: '21', cena_s_dph: '' }]
      }));

      // Reset validaÄnÃ­ho stavu
      setHasTriedToSubmit(false);
      setValidationErrors({});
      setTouchedSelectFields(new Set());

      // Success log odstranÄ›n
    }
  }, [isNewOrder, userDetail, user_id]);

  // NaÄtenÃ­ stavu sekcÃ­ pÅ™i mount komponentu
  useEffect(() => {
    if (user_id) {
      const savedSectionStates = loadSectionStates();
      if (savedSectionStates) {
        setSectionStates(prev => ({
          ...prev,
          ...savedSectionStates
        }));
        addDebugLog('success', 'UI', 'section-states', `NaÄten uloÅ¾enÃ½ stav sekcÃ­: ${JSON.stringify(savedSectionStates)}`);
      }
    }
  }, [user_id]);

  // Debug logger DOÄŒASNÄš VYPNUT - zpÅ¯sobuje nekoneÄnou smyÄku
  // useEffect(() => {
  //   setDebugLogger(addDebugLog);
  // }, []);

  // ï¿½ JEDNODUCHÃ LOGIKA: VÅ½DY pÅ™i mount spusÅ¥ INIT
  useEffect(() => {
    // // console.log('ðŸš€ MOUNT OrderForm25 - spouÅ¡tÃ­m INIT');

    if (token && username) {
      // âŒ DEPRECATED: initializeForm() zakÃ¡zÃ¡n - nynÃ­ Å™Ã­dÃ­ useFormController
      // initializeForm();
    } // else {
    //   console.warn('âš ï¸ Token nebo username chybÃ­, ÄekÃ¡m...');
    // }

    return () => {
      // // console.log('ðŸ§¹ UNMOUNT OrderForm25 - ÄistÃ­m state');
      setIsInitialized(false);
      // ðŸ—‘ï¸ REMOVED: setAreDictionariesReady - uÅ¾ se nepouÅ¾Ã­vÃ¡ (alias na dictionaries.isReady)
    };
  }, []);

  // ðŸ”„ NAVIGATION FIX: Reset initialization state when editOrderId changes
  // This ensures form re-initializes when navigating between different orders
  useEffect(() => {
    // Reset flags to allow re-initialization
    setIsInitialized(false);
    setIsDraftLoaded(false);
    setIsFormInitializing(true);

    // Reset hasLoadedNextNumberRef to allow loading new order number
    if (hasLoadedNextNumberRef.current) {
      hasLoadedNextNumberRef.current = false;
    }

    // ðŸ”¥ KRITICKÃ‰: Vymazat formData pÅ™i zmÄ›nÄ› order ID
    // ZabrÃ¡nÃ­me zobrazenÃ­ dat ze STARÃ‰ objednÃ¡vky bÄ›hem naÄÃ­tÃ¡nÃ­ NOVÃ‰
    if (editOrderId) {
      // Zachovat pouze zÃ¡kladnÃ­ strukturu formData, vymazat vÅ¡echny hodnoty
      setFormData({
        objednatel_id: user_id || '',
        uzivatel_id: user_id || '',
        garant_uzivatel_id: user_id || '',
        jmeno: '',
        email: '',
        telefon: '',
        ev_cislo: 'NaÄÃ­tÃ¡m...',
        druh_objednavky_kod: '',
        strediska_kod: [],
        zpusob_financovani: '',
        poznamka: '',
        polozky_objednavky: [{
          nazev: '',
          specifikace: '',
          mnozstvi: 1,
          merna_jednotka: '',
          jednotkova_cena: '',
          celkova_cena: 0
        }],
        dodavatel: {},
        faktury: [],
        stav_workflow_kod: ['NOVA'],
        stav_schvaleni: 'ÄekÃ¡ na schvÃ¡lenÃ­'
      });
    }
  }, [editOrderId, user_id]);

  // ï¿½ï¸ REMOVED: Deprecated useEffect pro naÄÃ­tÃ¡nÃ­ objednÃ¡vky (177 Å™Ã¡dkÅ¯)
  // ArchivovÃ¡no v: _DEPRECATED/OrderForm25-deprecated-useEffects.js
  // Nahrazeno: useFormController.initializeForm()

  // ðŸŽ¯ UKONÄŒENÃ SPLASH SCREEN - aÅ¾ kdyÅ¾ jsou data skuteÄnÄ› VYKRESLENÃ (ÄÃ­selnÃ­ky + objednÃ¡vka naÄtena)
  useEffect(() => {
    // Pro novou objednÃ¡vku: Äekej jen na ÄÃ­selnÃ­ky + draft loaded
    if (!editOrderId) {
      if (areDictionariesReady && isInitialized && isDraftLoaded) {
        setIsFormInitializing(false);
      }
      return;
    }

    // Pro editaci: Äekaj na ÄÃ­selnÃ­ky + draft loaded
    if (areDictionariesReady && isInitialized && isDraftLoaded) {
      setIsFormInitializing(false);
    }
  }, [editOrderId, areDictionariesReady, isInitialized, isDraftLoaded]);

  // ðŸ”’ REF: Sleduje zda uÅ¾ bylo ev_cislo naÄteno (JEDNOU a dost!)
  const hasLoadedNextNumberRef = useRef(false);

  // ðŸŽ¯ REF: PÅ™Ã­mÃ¡ reference na ScrollableContent element pro scroll pozici
  const scrollableContentRef = useRef(null);

  // ðŸŽ¯ REF: PÅ™Ã­mÃ¡ reference na FixedHeader pro dynamickÃ© mÄ›Å™enÃ­ vÃ½Å¡ky
  const fixedHeaderRef = useRef(null);

  // âœ… SdÃ­let ref pÅ™es window pro pÅ™Ã­stup z onDataLoaded
  useEffect(() => {
    window.__orderForm_hasLoadedNextNumberRef = hasLoadedNextNumberRef;
  }, []);

  // ðŸ“ DynamickÃ© mÄ›Å™enÃ­ vÃ½Å¡ky FixedHeader a nastavenÃ­ CSS variable
  // VÃ½Å¡ka headeru + konstantnÃ­ gap 20px = padding-top pro ScrollableInner
  useLayoutEffect(() => {
    const GAP = 20; // KonstantnÃ­ mezera mezi headerem a obsahem

    const updateHeaderHeight = () => {
      if (fixedHeaderRef.current) {
        const height = fixedHeaderRef.current.offsetHeight;
        // Nastavit CSS custom property: vÃ½Å¡ka headeru + konstantnÃ­ gap
        document.documentElement.style.setProperty('--fixed-header-height', `${height + GAP}px`);
      }
    };

    // Aktualizovat OKAMÅ½ITÄš pÅ™i mount
    updateHeaderHeight();
    
    // Opakovat nÄ›kolikrÃ¡t po mount pro jistotu (dynamickÃ½ obsah se mÅ¯Å¾e renderovat postupnÄ›)
    const timeouts = [
      setTimeout(updateHeaderHeight, 50),
      setTimeout(updateHeaderHeight, 100),
      setTimeout(updateHeaderHeight, 200),
      setTimeout(updateHeaderHeight, 500)
    ];

    window.addEventListener('resize', updateHeaderHeight);

    // Aktualizovat takÃ© pÅ™i zmÄ›nÃ¡ch obsahu headeru (ResizeObserver)
    const observer = new ResizeObserver(() => {
      updateHeaderHeight();
    });

    if (fixedHeaderRef.current) {
      observer.observe(fixedHeaderRef.current);
    }

    return () => {
      timeouts.forEach(t => clearTimeout(t));
      window.removeEventListener('resize', updateHeaderHeight);
      observer.disconnect();
    };
  }, []);
  
  // ðŸ”„ PÅ™epoÄÃ­tat vÃ½Å¡ku headeru pÅ™i zmÄ›nÄ› stavu objednÃ¡vky nebo workflow
  useEffect(() => {
    if (fixedHeaderRef.current) {
      const height = fixedHeaderRef.current.offsetHeight;
      document.documentElement.style.setProperty('--fixed-header-height', `${height + 20}px`);
    }
  }, [isOrderCompleted, shouldLockAllSections, formData.stav_workflow_kod, formData.ev_cislo, formData.dokoncil_id]);

  // NaÄtenÃ­ evidenÄnÃ­ho ÄÃ­sla - POUZE pro novÃ© objednÃ¡vky, POUZE JEDNOU!
  useEffect(() => {
    // ðŸ”’ KRITICKÃ‰: NaÄÃ­st ÄÃ­slo JEN JEDNOU!

    // 0ï¸âƒ£ UÅ¾ bylo naÄteno â†’ SKIP
    if (hasLoadedNextNumberRef.current) {
      return;
    }

    // 1ï¸âƒ£ Pokud mÃ¡ ID â†’ uloÅ¾eno v DB â†’ SKIP
    if (formData.id) {
      return;
    }

    // 2ï¸âƒ£ Pokud je v EDIT mode â†’ SKIP
    if (isEditMode) {
      return;
    }

    // 3ï¸âƒ£ Pokud uÅ¾ mÃ¡ ev_cislo (ne "NaÄÃ­tÃ¡m...") â†’ SKIP
    if (formData.ev_cislo && formData.ev_cislo !== 'NaÄÃ­tÃ¡m...') {
      hasLoadedNextNumberRef.current = true; // OznaÄit Å¾e uÅ¾ mÃ¡me ÄÃ­slo
      return;
    }

    // âœ… Vygeneruj ÄÃ­slo JEN KDYÅ½:
    // - NenÃ­ ID, nenÃ­ edit mode, nenÃ­ ev_cislo, mÃ¡me API pÅ™Ã­stup
    if (token && username) {
      loadNextOrderNumber().then(success => {
        if (success) {
          hasLoadedNextNumberRef.current = true; // OznaÄit Å¾e uÅ¾ bylo naÄteno
        }
      });
    }
  }, [formData.id, isEditMode, token, username]); // âœ… REMOVED: formData.ev_cislo z dependencies!

  // ðŸ’° Funkce pro naÄtenÃ­ detailÅ¯ LP (zbÃ½vajÃ­cÃ­ ÄÃ¡stka)
  const loadLPDetail = useCallback(async (lp_id_or_kod) => {
    if (!lp_id_or_kod || !token || !username) return;

    // NajÃ­t LP option pro zÃ­skÃ¡nÃ­ cislo_lp
    const lpOption = lpKodyOptions.find(opt => opt.id === lp_id_or_kod || opt.kod === lp_id_or_kod);
    if (!lpOption) {
      return;
    }

    // Backend oÄekÃ¡vÃ¡ cislo_lp (textovÃ½ kÃ³d typu "LPIA1")
    const cislo_lp = lpOption.cislo_lp || lpOption.label || lpOption.kod;
    if (!cislo_lp) {
      return;
    }

    setLoadingLpDetails(prev => {
      // Pokud uÅ¾ mÃ¡me detaily nebo se prÃ¡vÄ› naÄÃ­tajÃ­, nemusÃ­me naÄÃ­tat znovu
      if (prev[lp_id_or_kod]) return prev;
      return { ...prev, [lp_id_or_kod]: true };
    });

    try {
      const detail = await fetchLPDetail({ token, username, cislo_lp });
      if (detail) {
        setLpDetails(prev => ({ ...prev, [lp_id_or_kod]: detail }));
      }
    } catch (error) {
      // Netobrazovat toast pokud je to jen 404 - LP nemusÃ­ existovat
      if (!error.message.includes('404') && !error.message.includes('400')) {
        showToast(`NepodaÅ™ilo se naÄÃ­st detail LP: ${error.message}`, 'error');
      }
    } finally {
      setLoadingLpDetails(prev => ({ ...prev, [lp_id_or_kod]: false }));
    }
  }, [token, username, showToast, lpKodyOptions]);

  // ðŸ“„ Funkce pro naÄtenÃ­ seznamu smluv (pro autocomplete)
  const loadSmlouvyList = useCallback(async () => {
    if (!token || !username) return;
    if (loadingSmlouvyList) return; // ZabrÃ¡nit duplicitnÃ­mu naÄÃ­tÃ¡nÃ­

    setLoadingSmlouvyList(true);

    try {
      const response = await getSmlouvyList({
        token,
        username,
        show_inactive: false,
        limit: 500 // NaÄÃ­st max 500 aktivnÃ­ch smluv
      });

      if (response?.data && Array.isArray(response.data)) {
        setSmlouvyList(response.data);
      } else {
        setSmlouvyList([]);
      }
    } catch (error) {
      // Nebudeme zobrazovat toast - mÅ¯Å¾e to bÃ½t jen chybÄ›jÃ­cÃ­ oprÃ¡vnÄ›nÃ­
      setSmlouvyList([]);
    } finally {
      setLoadingSmlouvyList(false);
    }
  }, [token, username, loadingSmlouvyList]);

  // ðŸ“„ Funkce pro naÄtenÃ­ detailu smlouvy (zbÃ½vajÃ­cÃ­ ÄÃ¡stka)
  const loadSmlouvaDetail = useCallback(async (cislo_smlouvy) => {
    if (!cislo_smlouvy || !token || !username) {
      setSmlouvaDetail(null);
      return;
    }

    setLoadingSmlouvaDetail(true);

    try {
      // NajÃ­t smlouvu podle ÄÃ­sla v naÄtenÃ©m seznamu
      const smlouva = smlouvyList.find(s => 
        s.cislo_smlouvy === cislo_smlouvy || 
        s.evidencni_cislo === cislo_smlouvy
      );

      if (smlouva) {
        // PouÅ¾Ã­t data pÅ™Ã­mo ze seznamu - uÅ¾ obsahujÃ­ vÅ¡echny potÅ™ebnÃ© informace
        setSmlouvaDetail(smlouva);
      } else {
        // Smlouva nebyla nalezena v seznamu - umoÅ¾nit uÅ¾ivateli zadat vlastnÃ­ ÄÃ­slo
        setSmlouvaDetail({ notFound: true });
      }
    } catch (error) {
      setSmlouvaDetail({ notFound: true });
    } finally {
      setLoadingSmlouvaDetail(false);
    }
  }, [token, username, smlouvyList, formData.cislo_smlouvy]);

  // ðŸ› DEBUG: Monitor formData checkboxy changes
  // DEBUG: SledovÃ¡nÃ­ zmÄ›n checkboxÅ¯ pro zamykÃ¡nÃ­ sekcÃ­
  useEffect(() => {
    // Removed verbose logging - checkbox states tracked internally
  }, [formData.potvrzeni_vecne_spravnosti, formData.potvrzeni_dokonceni_objednavky, formData.id]);

  // ðŸŽ¯ ODSTRANÄšNO: Reload uÅ¾ivatelÅ¯ - FormDataManager to dÄ›lÃ¡ automaticky pÅ™i inicializaci
  // useEffect(() => {
  //   if (token && username && !isFormInitializing) {
  //     loadAllUsers();
  //   }
  // AutomatickÃ© naplnÄ›nÃ­ ÃºdajÅ¯ objednatele pÅ™i prvnÃ­ interakci s formulÃ¡Å™em
  useEffect(() => {
    // Kontrola: MÃ¡ uÅ¾ivatel Ãºdaje, jsou Ãºdaje objednatele prÃ¡zdnÃ©, nenÃ­ editaÄnÃ­ reÅ¾im, nenÃ­ jiÅ¾ naÄten draft
    const shouldFillOrdererData = userDetail &&
                                  user_id &&
                                  !isEditMode &&
                                  !isDraftLoaded &&
                                  !formData.objednatel_id &&
                                  !formData.jmeno &&
                                  !formData.email;

    // Kontrola: MÃ¡ formulÃ¡Å™ nÄ›jakÃ½ obsah (uÅ¾ivatel zaÄal vyplÅˆovat)?
    const hasUserInput = (formData.predmet && String(formData.predmet).trim()) ||
                        formData.garant_uzivatel_id ||
                        formData.prikazce_id ||
                        (formData.strediska_kod && Array.isArray(formData.strediska_kod) && formData.strediska_kod.length > 0) ||
                        (formData.max_cena_s_dph && parseFloat(formData.max_cena_s_dph) > 0) ||
                        (formData.popis_pozadavku && String(formData.popis_pozadavku).trim());

    if (shouldFillOrdererData && hasUserInput) {

      const jmeno = `${userDetail.titul_pred ? userDetail.titul_pred + ' ' : ''}${userDetail.jmeno || ''} ${userDetail.prijmeni || ''}${userDetail.titul_za ? ', ' + userDetail.titul_za : ''}`.replace(/\s+/g, ' ').trim();

      setFormData(prev => ({
        ...prev,
        objednatel_id: user_id,
        jmeno: jmeno || 'Neuvedeno',
        email: userDetail.email || '',
        telefon: userDetail.telefon || ''
      }));
    }
  }, [userDetail, user_id, isEditMode, isDraftLoaded, formData.objednatel_id, formData.jmeno, formData.email,
      formData.predmet, formData.garant_uzivatel_id, formData.prikazce_id, formData.strediska_kod,
      formData.max_cena_s_dph, formData.popis_pozadavku]);

  // ðŸ’° AutomatickÃ¡ detekce: MÃ¡ bÃ½t zveÅ™ejnÄ›na (cena > 50 000 KÄ bez DPH)
  useEffect(() => {
    // Pouze pokud mÃ¡me poloÅ¾ky objednÃ¡vky
    if (!formData.polozky_objednavky || formData.polozky_objednavky.length === 0) {
      return;
    }

    // VypoÄÃ­tat celkovou cenu BEZ DPH ze vÅ¡ech poloÅ¾ek
    const celkovaCenaBezDPH = formData.polozky_objednavky.reduce((sum, polozka) => {
      // ðŸ”§ FIX: Odstranit formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat
      const cena = parseFloat((polozka.cena_bez_dph || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      const mnozstvi = parseFloat(polozka.mnozstvi || 0);
      return sum + (cena * mnozstvi);
    }, 0);

    // Pokud je cena > 50 000 KÄ bez DPH a checkbox nenÃ­ jeÅ¡tÄ› zaÅ¡krtnutÃ½
    if (celkovaCenaBezDPH > 50000 && !formData.ma_byt_zverejnena) {
      setFormData(prev => ({
        ...prev,
        ma_byt_zverejnena: true
      }));
    }
  }, [formData.polozky_objednavky, formData.ma_byt_zverejnena]);

  // Fix: ZajiÅ¡tÄ›nÃ­ sprÃ¡vnÃ©ho zobrazenÃ­ LP kÃ³dÅ¯ po naÄtenÃ­ options
  // KdyÅ¾ se naÄtou lpKodyOptions a formData.lp_kod uÅ¾ obsahuje ID,
  // komponenta se musÃ­ pÅ™ekreslit, aby zobrazila nÃ¡zvy mÃ­sto ID
  useEffect(() => {
    // Kontrola: MÃ¡me naÄtenÃ© LP kÃ³dy options a formData obsahuje lp_kod pole?
    if (lpKodyOptions.length > 0 &&
        Array.isArray(formData.lp_kod) &&
        formData.lp_kod.length > 0) {

      // Zkontroluj, jestli vÅ¡echna ID v lp_kod existujÃ­ v lpKodyOptions
      const allFound = formData.lp_kod.every(id =>
        lpKodyOptions.some(opt => (opt.id || opt.kod) === id)
      );

      if (allFound) {
        // VÅ¡echny LP kÃ³dy jsou v options - nenÃ­ potÅ™eba nic dÄ›lat
        // Ale mÅ¯Å¾eme vynutit re-render nastavenÃ­m dummy state
        // (toto pomÅ¯Å¾e kdyÅ¾ se options naÄetly aÅ¾ po formData)
        // NenÃ­ potÅ™eba - React automaticky pÅ™ekreslÃ­ kdyÅ¾ se zmÄ›nÃ­ lpKodyOptions
      } else {
        // NÄ›kterÃ© ID nejsou v options - moÅ¾nÃ¡ se jeÅ¡tÄ› nenaÄetly
        // PoÄkÃ¡me na dalÅ¡Ã­ render cyklus
      }
    }
  }, [lpKodyOptions, formData.lp_kod]);

  // ðŸ’° AutomatickÃ© naÄÃ­tÃ¡nÃ­ detailÅ¯ LP pÅ™i vÃ½bÄ›ru
  useEffect(() => {
    if (!Array.isArray(formData.lp_kod) || formData.lp_kod.length === 0) {
      return; // Å½Ã¡dnÃ© LP vybrÃ¡ny
    }

    // NaÄÃ­st detaily pro kaÅ¾dÃ© vybranÃ© LP (pokud jeÅ¡tÄ› nejsou naÄtenÃ©)
    formData.lp_kod.forEach(lp_id => {
      if (!lpDetails[lp_id] && !loadingLpDetails[lp_id]) {
        loadLPDetail(lp_id);
      }
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [formData.lp_kod]);

  // ðŸ“„ NaÄtenÃ­ seznamu smluv pÅ™i mount (pro autocomplete)
  useEffect(() => {
    if (token && username && smlouvyList.length === 0 && !loadingSmlouvyList) {
      loadSmlouvyList();
    }
  }, [token, username, smlouvyList.length, loadingSmlouvyList, loadSmlouvyList]);

  // ðŸ“„ AutomatickÃ© naÄtenÃ­ detailu smlouvy pÅ™i zmÄ›nÄ› ÄÃ­sla smlouvy
  useEffect(() => {
    if (formData.cislo_smlouvy && formData.cislo_smlouvy.trim()) {
      loadSmlouvaDetail(formData.cislo_smlouvy.trim());
    } else {
      setSmlouvaDetail(null);
    }
  }, [formData.cislo_smlouvy, loadSmlouvaDetail]);

  // ðŸ”„ AUTOFILL DODAVATELE po schvÃ¡lenÃ­ ADMINem
  // KdyÅ¾ se objevÃ­ stav SCHVALENA + financovÃ¡nÃ­ SMLOUVA + dodavatel prÃ¡zdnÃ½, spustit autofill
  useEffect(() => {
    const shouldAutoFill = async () => {
      // Kontrola podmÃ­nek
      const hasSchvalena = hasWorkflowState(formData.stav_workflow_kod, 'SCHVALENA');
      const isSmlouva = formData.zpusob_financovani?.toUpperCase() === 'SMLOUVA';
      const hasCisloSmlouvy = !!formData.cislo_smlouvy?.trim();
      const nemaDodavatele = !formData.dodavatel_nazev?.trim() && !formData.dodavatel_ico?.trim();
      
      if (hasSchvalena && isSmlouva && hasCisloSmlouvy && nemaDodavatele && smlouvaDetail && !smlouvaDetail.notFound) {
        try {
          const supplierData = await autoFillSupplierFromContract(formData, currentPhase);
          
          if (supplierData) {
            setFormData(prev => ({
              ...prev,
              ...supplierData
            }));
            setSupplierAutoFillSource(supplierData.source);
            setIsChanged(true);
          }
        } catch (error) {
        }
      }
    };
    
    shouldAutoFill();
  }, [formData.stav_workflow_kod, formData.zpusob_financovani, formData.cislo_smlouvy, formData.dodavatel_nazev, formData.dodavatel_ico, smlouvaDetail, autoFillSupplierFromContract, currentPhase, hasWorkflowState]);

  // Auto-save konceptu pÅ™i zmÄ›nÃ¡ch formData (s debounce 2000ms)
  useEffect(() => {
    // NeuklÃ¡dej prÃ¡zdnÃ½ formulÃ¡Å™ - spustÃ­ se pokud je vyplnÄ›n pÅ™edmÄ›t NEBO garant NEBO jakÃ©koli relevantnÃ­ pole
    const hasRelevantData = (
      formData.predmet ||
      formData.garant_uzivatel_id ||
      formData.popis_pozadavku ||
      formData.max_cena_s_dph ||
      formData.poznamky ||
      formData.dodavatel_nazev ||
      (formData.strediska_kod && formData.strediska_kod.length > 0) ||
      (formData.polozky_objednavky && formData.polozky_objednavky.some(p => p.popis))
    );

    // ðŸ” Kontrola zda je strÃ¡nka viditelnÃ¡ (uÅ¾ivatel je aktivnÃ­ na tÃ©to zÃ¡loÅ¾ce)
    const isPageVisible = !document.hidden;

    // âŒ ZABLOKUJ autosave pokud:
    // - probÃ­hÃ¡ uklÃ¡dÃ¡nÃ­ do DB
    // - je viditelnÃ½ progress bar
    // - byl ÃºspÄ›Å¡nÄ› uloÅ¾en do DB (disableAutosave flag/ref)
    // - DraftManager mÃ¡ autosave zakÃ¡zÃ¡n (centrÃ¡lnÃ­ kontrola)
    // - StrÃ¡nka nenÃ­ viditelnÃ¡ (uÅ¾ivatel je na jinÃ© zÃ¡loÅ¾ce/aplikaci)
    // - KRITICKÃ‰: Draft jeÅ¡tÄ› nebyl naÄten pÅ™i mount (prevence pÅ™epsÃ¡nÃ­ existujÃ­cÃ­ho draftu)
    if (!user_id || !hasRelevantData || isSaving || showSaveProgress || disableAutosave || disableAutosaveRef.current || !draftManager.isAutosaveEnabled() || !isPageVisible || !isDraftLoaded) {
      return; // TichÃ½ return - Å¾Ã¡dnÃ½ debug log pÅ™i bÄ›Å¾nÃ©m psanÃ­
    }

    // DEBOUNCED autosave - uloÅ¾Ã­ se aÅ¾ 3000ms po poslednÃ­ zmÄ›nÄ›
    // (nastaveno na 3s + autosave pÅ™i opuÅ¡tÄ›nÃ­ pole)
    // Timer se ruÅ¡Ã­ a nastavuje novÃ½ pÅ™i kaÅ¾dÃ© zmÄ›nÄ› formData
    const debounceTimer = setTimeout(() => {
      saveDraft(true); // auto-save = true
    }, 3000);

    // Cleanup - vyÄisti timer pÅ™i dalÅ¡Ã­ zmÄ›nÄ› nebo unmount
    return () => clearTimeout(debounceTimer);
  }, [formData, user_id, isSaving, showSaveProgress, disableAutosave, isDraftLoaded]);

  // ðŸ” Page Visibility listener - pozastavÃ­ autosave kdyÅ¾ uÅ¾ivatel pÅ™epne zÃ¡loÅ¾ku
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (document.hidden) {
      } else {
        // NEDÄšLÃME okamÅ¾itÃ½ autosave - nechÅ¥ ho spustÃ­ hlavnÃ­ useEffect s debouncem
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, [formData, user_id]);
  // Ochrana pÅ™ed opuÅ¡tÄ›nÃ­m strÃ¡nky s neuloÅ¾enÃ½mi pÅ™Ã­lohami
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      // ðŸŽ¯ UloÅ¾ scroll pozici pÅ™ed opuÅ¡tÄ›nÃ­m strÃ¡nky (pomocÃ­ ref)
      try {
        const scrollContainer = scrollableContentRef.current;
        const scrollPosition = scrollContainer ? scrollContainer.scrollTop : (window.pageYOffset || document.documentElement.scrollTop);
        draftManager.saveMetadata({ scrollPosition });
      } catch (error) {
      }

      // âŒ EMERGENCY SAVE VYPNUT - zpÅ¯soboval problÃ©my s pÅ™epsÃ¡nÃ­m dat
      // SpolÃ©hÃ¡me se na rychlÃ½ autosave (500ms debounce)
      // Emergency save nelze spolehlivÄ› implementovat kvÅ¯li:
      // 1) Å ifrovanÃ¡ data nelze synchronnÄ› deÅ¡ifrovat
      // 2) formData state mÅ¯Å¾e bÃ½t starÃ½ (React batching)
      // 3) beforeunload event je synchronnÃ­ a nemÅ¯Å¾e Äekat na async operace
      // Zjisti, jestli mÃ¡me nÄ›jakÃ© neuloÅ¾enÃ© pÅ™Ã­lohy
      const unsavedAttachments = attachments.filter(att =>
        !att.serverId && // NemÃ¡ server ID = nenÃ­ nahrÃ¡no na server
        att.status !== 'uploaded' && // NenÃ­ oznaÄeno jako nahranÃ©
        !att.fromServer && // NenÃ­ ze serveru
        att.file // MÃ¡ skuteÄnÃ½ soubor
      );

      const unclassifiedAttachments = attachments.filter(att =>
        !att.klasifikace || att.klasifikace.trim() === '' // NenÃ­ klasifikovÃ¡no
      );

      if (unsavedAttachments.length > 0 || unclassifiedAttachments.length > 0) {
        const message = `MÃ¡te ${unsavedAttachments.length} neuloÅ¾enÃ½ch a ${unclassifiedAttachments.length} neklasifikovanÃ½ch pÅ™Ã­loh. Opravdu chcete opustit strÃ¡nku? NeuloÅ¾enÃ© pÅ™Ã­lohy budou ztraceny.`;
        e.preventDefault();
        e.returnValue = message; // For Chrome
        return message; // For other browsers
      }
    };

    const handlePopState = () => {
      // StejnÃ¡ kontrola pro browser back/forward
      const unsavedAttachments = attachments.filter(att =>
        !att.serverId && att.status !== 'uploaded' && !att.fromServer && att.file
      );
      const unclassifiedAttachments = attachments.filter(att =>
        !att.klasifikace || att.klasifikace.trim() === ''
      );

      if (unsavedAttachments.length > 0 || unclassifiedAttachments.length > 0) {
        showToast && showToast(
          `MÃ¡te ${unsavedAttachments.length} neuloÅ¾enÃ½ch a ${unclassifiedAttachments.length} neklasifikovanÃ½ch pÅ™Ã­loh.\n\nOpravdu chcete opustit strÃ¡nku? NeuloÅ¾enÃ© pÅ™Ã­lohy budou ztraceny.`, {
          type: 'warning',
          timeout: 0,
          action: {
            confirmText: 'ANO, OPUSTIT',
            cancelText: 'ZÅ¯stat',
            onConfirm: () => {
              // PokraÄuj s opuÅ¡tÄ›nÃ­m strÃ¡nky - nemusÃ­me nic dÄ›lat, prohlÃ­Å¾eÄ se postarÃ¡
            },
            onCancel: () => {
              // ðŸ”§ FIX: Zachovat query parametry (napÅ™. ?edit=123)
              const fullUrl = window.location.pathname + window.location.search;
              window.history.pushState(null, '', fullUrl);
            }
          }
        });
      }
    };

    // PÅ™idej event listenery
    window.addEventListener('beforeunload', handleBeforeUnload);
    window.addEventListener('popstate', handlePopState);

    // Cleanup
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      window.removeEventListener('popstate', handlePopState);
    };
  }, [attachments, formData, user_id, isOrderSavedToDB, savedOrderId]); // AktuÃ¡lnÃ­ data pro emergency save

  // Funkce pro vyÄiÅ¡tÄ›nÃ­ validaÄnÃ­ chyby pÅ™i ztrÃ¡tÄ› fokusu
  const handleFieldBlur = useCallback((fieldName, value) => {
    // âŒ REMOVED: AutomatickÃ© mazÃ¡nÃ­ chyb pÅ™i blur - zpÅ¯sobuje mizenÃ­ ÄervenÃ½ch rÃ¡meÄkÅ¯
    // Chyby se majÃ­ mazat POUZE pÅ™i novÃ© validaci, ne pÅ™i kaÅ¾dÃ©m blur!
    // if (validationErrors[fieldName] && value) {
    //   setValidationErrors(prev => {
    //     const { [fieldName]: removed, ...rest } = prev;
    //     return rest;
    //   });
    // }

    // ðŸ’¾ AUTO-SAVE pÅ™i opuÅ¡tÄ›nÃ­ pole (onBlur) - NOVÃ CENTRALIZOVANÃ SYSTÃ‰M
    // PouÅ¾itÃ­ triggerAutosave s debounce 3 sekundy
    const canAutosave = !disableAutosaveRef.current && draftManager.isAutosaveEnabled() && !isSaving && !showSaveProgress && isDraftLoaded;

    if (canAutosave) {
      triggerAutosave(false); // false = s debouncem 3s
    } else {
    }
  }, [validationErrors, isSaving, showSaveProgress, isDraftLoaded, triggerAutosave]);

  // UseEffect pro inicializaci Å¡ablon
  useEffect(() => {
    // NaÄÃ­st Å¡ablony z localStorage pÅ™i mount
    try {
      const key = user_id ? `order_templates_${user_id}` : 'order_templates';
      const stored = localStorage.getItem(key);
      if (stored) {
        const templates = JSON.parse(stored);
        if (Array.isArray(templates)) {
          setSavedTemplates(templates);
        }
      }
    } catch (error) {
    }

    // Automaticky naÄÃ­st Å¡ablony z DB pÅ™i mount (po F5 refresh)
    if (token && username && user_id) {

      fetchAndMergeTemplates();
    }
  }, [user_id, token, username]);

  const toggleSection = (sectionKey) => {
    setSectionStates(prev => {
      const newStates = {
        ...prev,
        [sectionKey]: !prev[sectionKey]
      };
      // UloÅ¾it stav sekcÃ­
      saveSectionStates(newStates);

      // AUTOMATICKÃ‰ NAÄŒTENÃ PÅ˜ÃLOH pÅ™i rozbalenÃ­ sekce pÅ™Ã­loh
      if (sectionKey === 'prilohy' && prev[sectionKey] && !newStates[sectionKey]) {
        // Sekce byla sbalenÃ¡ (true) a teÄ se rozbaluje (false)

        // PodmÃ­nka pro automatickÃ© naÄtenÃ­ pÅ™i rozbalenÃ­
        // POUZE od FÃZE 3+ (SCHVALENA) - FÃZE 1 a 2 pÅ™Ã­lohy neÅ™eÅ¡Ã­
        if ((formData.id || savedOrderId) && token && username && !isNewOrder && currentPhase >= 3) {
          setTimeout(() => {
            loadAttachmentsSmartly();
          }, 100); // KrÃ¡tkÃ© zpoÅ¾dÄ›nÃ­ pro sprÃ¡vnÃ© vykreslenÃ­ UI
        }
      }

      return newStates;
    });
  };

  // Funkce pro formÃ¡tovÃ¡nÃ­ mÄ›ny
  const formatCurrency = (value) => {
    if (!value) return '';

    // PÅ™evÃ©st na ÄÃ­slo
    const numValue = parseFloat(value);
    if (isNaN(numValue)) return '';

    // FormÃ¡tovÃ¡nÃ­ s mezerami jako oddÄ›lovaÄe tisÃ­cÅ¯
    const formatted = numValue.toLocaleString('cs-CZ', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2,
    }).replace(/\s/g, ' '); // Zajistit sprÃ¡vnÃ© mezery

    return formatted + ' KÄ';
  };

  // Parser pro pÅ™evod z formÃ¡tovanÃ© mÄ›ny zpÄ›t na ÄÃ­slo
  const parseCurrency = (formattedValue) => {
    if (!formattedValue) return '';

    // Odstranit "KÄ" a vÅ¡echny mezery
    let cleanValue = formattedValue
      .replace(/\s/g, '') // Odstranit vÅ¡echny mezery
      .replace(/KÄ/g, ''); // Odstranit "KÄ"

    // Pokud obsahuje ÄÃ¡rku jako desetinnÃ½ oddÄ›lovaÄ (ÄeskÃ© formÃ¡tovÃ¡nÃ­)
    if (cleanValue.includes(',')) {
      cleanValue = cleanValue.replace(',', '.');
    }

    const numValue = parseFloat(cleanValue);
    return isNaN(numValue) ? '' : numValue.toString();
  };

  // SpeciÃ¡lnÃ­ handler pro mÄ›novÃ© inputy s debouncing pro zachovÃ¡nÃ­ pozice kurzoru
  const handleCurrencyChange = (field, formattedValue) => {
    // PÅ™evÃ©st formÃ¡tovanou hodnotu zpÄ›t na ÄÃ­slo
    const numericValue = parseCurrency(formattedValue);

    // âŒ REMOVED: MazÃ¡nÃ­ chyby validace - zbyteÄnÃ©
    // Validace probÃ­hÃ¡ POUZE pÅ™i Save, live mazÃ¡nÃ­ chyb nenÃ­ potÅ™eba

    // UloÅ¾it ÄÃ­selnou hodnotu do formData
    // POZOR: Toto zpÅ¯sobuje re-render a resetuje pozici kurzoru!
    setFormData(prev => ({
      ...prev,
      [field]: numericValue
    }));

    // Nastavit flag, Å¾e doÅ¡lo ke zmÄ›nÄ›
    setIsChanged(true);
  };

  // Detekce duplicitnÃ­ch nÃ¡zvÅ¯ souborÅ¯ - MUSÃ BÃT PÅ˜ED handleFileUpload
  const checkDuplicateFileName = (newFileName) => {
    const existingFiles = attachments.filter(file =>
      file.name.toLowerCase() === newFileName.toLowerCase()
    );
    return existingFiles.length > 0 ? existingFiles[0] : null;
  };

  // Funkce pro prÃ¡ci s pÅ™Ã­lohami - Orders25 API
  const handleFileUpload = (files) => {
    // ðŸ”’ CENTRÃLNÃ ZAMYKÃNÃ: Blokovat upload pokud je objednÃ¡vka dokonÄena/zamÃ­tnuta/zruÅ¡ena
    if (isWorkflowCompleted && !canUnlockAnything) {
      showToast && showToast('Nelze nahrÃ¡t pÅ™Ã­lohy - objednÃ¡vka je dokonÄena/zamÃ­tnuta/zruÅ¡ena', { type: 'warning' });
      return;
    }

    if (!files || files.length === 0) {
      return;
    }

    setUploadingFiles(true);

    // PÅ™idÃ¡me soubory do lokÃ¡lnÃ­ho stavu pro klasifikaci
    const newFiles = Array.from(files).map((file, index) => {
      // Validace souboru
      if (!isAllowedFileType25(file.name)) {
        showToast(`Soubor ${file.name}: NepodporovanÃ½ typ souboru`, 'error');
        return null;
      }

      if (!isAllowedFileSize25(file.size, 20)) {
        showToast(`Soubor ${file.name}: PÅ™Ã­liÅ¡ velkÃ½ (max 20MB)`, 'error');
        return null;
      }

      // Kontrola duplicitnÃ­ho nÃ¡zvu
      const duplicate = checkDuplicateFileName(file.name);
      if (duplicate) {
      }

      // PouÅ¾ij Orders25 metadata generÃ¡tor
      const metadata = createAttachmentMetadata25(file);

      return {
        id: metadata.id,
        guid: metadata.guid,
        name: file.name,
        originalName: metadata.originalName,
        generatedName: metadata.generatedName,
        systemovy_nazev: metadata.systemovy_nazev,
        size: file.size,
        type: file.type,
        klasifikace: '', // Bude se vybÃ­rat uÅ¾ivatelem - po vÃ½bÄ›ru se nahraje na server
        uploadDate: metadata.createdAt,
        status: 'pending_classification', // ÄŒekÃ¡ na klasifikaci
        file: file, // Pro budoucÃ­ upload po klasifikaci
        uploadError: null,
        serverId: null,
        serverGuid: null,
        isDuplicate: !!duplicate, // Flag pro duplicitnÃ­ soubor
        duplicateOf: duplicate?.id || null // ID pÅ¯vodnÃ­ho souboru
      };
    }).filter(Boolean); // Odfiltruj nevalidnÃ­ soubory

    // Aktualizuj oba state - formData i attachments
    setFormData(prev => ({
      ...prev,
      prilohy_dokumenty: [...(prev.prilohy_dokumenty || []), ...newFiles]
    }));

    setAttachments(prev => [...prev, ...newFiles]);

    setUploadingFiles(false);

    // TOAST ODSTRANÄšN - zobrazÃ­ se aÅ¾ pÅ™i skuteÄnÃ©m nahrÃ¡nÃ­ na server po klasifikaci
    // const duplicateCount = newFiles.filter(f => f.isDuplicate).length;
    // if (duplicateCount > 0) {
    //   showToast(`PÅ™idÃ¡no ${newFiles.length} souborÅ¯ ke klasifikaci\nâš ï¸ ${duplicateCount} soubor(Å¯) mÃ¡ stejnÃ½ nÃ¡zev jako existujÃ­cÃ­ pÅ™Ã­loha - po nastavenÃ­ klasifikace bude nahrazen!`, 'warning');
    // } else {
    //   showToast(`PÅ™idÃ¡no ${newFiles.length} souborÅ¯ ke klasifikaci`, 'success');
    // }
  };

  // ðŸ†• Funkce pro nahrÃ¡nÃ­ dodateÄnÃ½ch dokladÅ¯ (automatickÃ¡ klasifikace jako "JINE")
  const handleDodatecneDokladyUpload = async (files) => {
    if (!files || files.length === 0) {
      return;
    }

    setUploadingFiles(true);

    // PÅ™idÃ¡me soubory s automatickou klasifikacÃ­ "JINE"
    const newFiles = Array.from(files).map((file, index) => {
      // Validace souboru
      if (!isAllowedFileType25(file.name)) {
        showToast(`Soubor ${file.name}: NepodporovanÃ½ typ souboru`, { type: 'error' });
        return null;
      }

      if (!isAllowedFileSize25(file.size, 20)) {
        showToast(`Soubor ${file.name}: PÅ™Ã­liÅ¡ velkÃ½ (max 20MB)`, { type: 'error' });
        return null;
      }

      // Kontrola duplicitnÃ­ho nÃ¡zvu
      const duplicate = checkDuplicateFileName(file.name);

      // PouÅ¾ij Orders25 metadata generÃ¡tor
      const metadata = createAttachmentMetadata25(file);

      const newFile = {
        id: metadata.id,
        guid: metadata.guid,
        name: file.name,
        originalName: metadata.originalName,
        generatedName: metadata.generatedName,
        systemovy_nazev: metadata.systemovy_nazev,
        size: file.size,
        type: file.type,
        klasifikace: 'JINE', // âœ… AutomatickÃ¡ klasifikace jako "JINE"
        file_prefix: 'dd-', // âœ… Prefix pro dodateÄnÃ© dokumenty
        uploadDate: metadata.createdAt,
        status: 'pending_upload', // âœ… Ready k uploadu (mÃ¡ jiÅ¾ klasifikaci)
        file: file,
        uploadError: null,
        serverId: null,
        serverGuid: null,
        isDuplicate: !!duplicate,
        duplicateOf: duplicate?.id || null
      };

      return newFile;
    }).filter(Boolean);

    if (newFiles.length === 0) {
      setUploadingFiles(false);
      return;
    }

    // Aktualizuj oba state
    setFormData(prev => ({
      ...prev,
      prilohy_dokumenty: [...(prev.prilohy_dokumenty || []), ...newFiles]
    }));

    setAttachments(prev => [...prev, ...newFiles]);

    // âœ… Automaticky nahraj vÅ¡echny soubory na server s prefixem "dd-"
    for (const file of newFiles) {
      await uploadFileToServer25(file.id, 'JINE', 'dd-');
    }

    setUploadingFiles(false);
  };

  // ðŸ†• PomocnÃ© funkce pro Dropzone dodateÄnÃ½ch dokladÅ¯
  const handleDodatecneDokladyDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setDragOver(false);

    // Zkus zÃ­skat soubory z items (modernÃ­ zpÅ¯sob)
    let files = null;

    if (e.dataTransfer.items && e.dataTransfer.items.length > 0) {
      files = Array.from(e.dataTransfer.items)
        .filter(item => item.kind === 'file')
        .map(item => item.getAsFile())
        .filter(Boolean);
    } else if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      files = e.dataTransfer.files;
    }

    if (files && files.length > 0) {
      handleDodatecneDokladyUpload(files);
    }
  };

  const handleDodatecneDokladySelect = (e) => {
    const files = e.target.files;

    if (files && files.length > 0) {
      handleDodatecneDokladyUpload(files);
    }
    e.target.value = '';
  };

  const handleFileDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setDragOver(false);

    const files = e.dataTransfer.files;

    if (files && files.length > 0) {
      handleFileUpload(files);
    }
  };

  const handleFileSelect = (e) => {
    const files = e.target.files;
    if (files.length > 0) {
      handleFileUpload(files);
    }
    // Reset input pro opÄ›tovnÃ© nahrÃ¡nÃ­ stejnÃ©ho souboru
    e.target.value = '';
  };

  const updateFileKlasifikace = async (fileId, klasifikace) => {
    const file = attachments.find(f => f.id === fileId);
    if (!file) {
      return;
    }

    // Aktualizuj oba state - formData i attachments
    setFormData(prev => ({
      ...prev,
      prilohy_dokumenty: (prev.prilohy_dokumenty || []).map(file =>
        file.id === fileId ? { ...file, klasifikace } : file
      )
    }));

    setAttachments(prev => prev.map(file =>
      file.id === fileId ? { ...file, klasifikace } : file
    ));

    // ðŸŽ¯ AUTOSAVE po zmÄ›nÄ› klasifikace (select) - okamÅ¾itÄ›
    if (!disableAutosaveRef.current && draftManager.isAutosaveEnabled() && !isSaving && !showSaveProgress && isDraftLoaded) {
      triggerAutosave(true); // immediate
    }

    // ROZHODOVÃNÃ: LokÃ¡lnÃ­ soubor vs. jiÅ¾ nahranÃ½ na serveru
    if (file.serverId && file.status === 'uploaded') {
      // âœ… SOUBOR JE JIÅ½ NA SERVERU - Aktualizuj klasifikaci v DB

      if (!klasifikace || klasifikace.trim() === '') {
        showToast('âš ï¸ Nelze uloÅ¾it prÃ¡zdnou klasifikaci pro nahranÃ© soubory', 'warning');
        return;
      }

      try {
        const result = await updateAttachment25({
          token,
          username,
          objednavka_id: savedOrderId, // âœ… OPRAVENO: pÅ™idÃ¡n objednavka_id
          attachment_id: file.serverId,
          typ_prilohy: klasifikace
        });

        if (result.status === 'ok' || result.status === 'success') { // âœ… OPRAVENO: backend mÅ¯Å¾e vracet 'success'

          // âœ… Aktualizuj lokÃ¡lnÃ­ stav s daty z backendu
          if (result.data) {
            const updatedData = {
              typ_prilohy: result.data.type || klasifikace,
              dt_aktualizace: result.data.updated_at,
              klasifikace: result.data.type || klasifikace
            };

            setFormData(prev => ({
              ...prev,
              prilohy_dokumenty: (prev.prilohy_dokumenty || []).map(f =>
                f.id === fileId ? { ...f, ...updatedData } : f
              )
            }));

            setAttachments(prev => prev.map(f =>
              f.id === fileId ? { ...f, ...updatedData } : f
            ));
          }

          // Zkontroluj existence souboru po aktualizaci (pomocÃ­ sync kontroly)
          await checkAttachmentsSynchronization25(true); // silentMode = true

          showToast('âœ… Klasifikace aktualizovÃ¡na v databÃ¡zi + kontrola existence OK', 'success');
          // Success log odstranÄ›n

          addDebugLog('success', 'ATTACHMENTS', 'update-classification-db',
            `Klasifikace zmÄ›nÄ›na v DB: ${file.name} â†’ ${klasifikace}`
          );
        }
      } catch (error) {

        const errorMsg = translateErrorMessageShort(error.message);

        showToast(`âŒ Chyba pÅ™i aktualizaci klasifikace: ${errorMsg}`, 'error');

        addDebugLog('error', 'ATTACHMENTS', 'update-classification-db-failed',
          `Chyba aktualizace klasifikace v DB: ${errorMsg}`
        );

        // VraÅ¥ zpÄ›t pÅ¯vodnÃ­ klasifikaci pÅ™i chybÄ›
        setFormData(prev => ({
          ...prev,
          prilohy_dokumenty: (prev.prilohy_dokumenty || []).map(f =>
            f.id === fileId ? { ...f, klasifikace: file.klasifikace } : f
          )
        }));

        setAttachments(prev => prev.map(f =>
          f.id === fileId ? { ...f, klasifikace: file.klasifikace } : f
        ));
      }
    } else {
      // âœ… LOKÃLNÃ SOUBOR - StandardnÃ­ chovÃ¡nÃ­ pro nahrÃ¡nÃ­ na server

      // Pokud je klasifikace nastavena a objednÃ¡vka je uloÅ¾enÃ¡, nahraj soubor na server
      if (klasifikace && klasifikace.trim() !== '' && savedOrderId && token && username) {
        // âœ… PouÅ¾ij pÅ¯vodnÃ­ file_prefix souboru mÃ­sto hardcoded 'obj-'
        const filePrefix = file.file_prefix || 'obj-';
        await uploadFileToServer25(fileId, klasifikace, filePrefix);
      }
    }
  };

  // Upload souboru na server Orders25 po klasifikaci
  const uploadFileToServer25 = async (fileId, klasifikace, filePrefix = 'obj-') => {
    const file = formData.prilohy_dokumenty?.find(f => f.id === fileId);
    if (!file || !file.file || file.status === 'uploaded') {
      return;
    }

    try {
      // OznaÄ jako nahrÃ¡vajÃ­cÃ­ se v obou state
      setFormData(prev => ({
        ...prev,
        prilohy_dokumenty: prev.prilohy_dokumenty.map(f =>
          f.id === fileId
            ? { ...f, status: 'uploading', uploadError: null, file_prefix: filePrefix }
            : f
        )
      }));

      setAttachments(prev => prev.map(f =>
        f.id === fileId
          ? { ...f, status: 'uploading', uploadError: null, file_prefix: filePrefix }
          : f
      ));

      addDebugLog('info', 'ATTACHMENTS', 'upload-start',
        `NahrÃ¡vÃ¡m soubor ${file.name} s klasifikacÃ­ ${klasifikace} a prefixem ${filePrefix} na server V2 API...`);

      // KONTROLA: pokud nenÃ­ savedOrderId, zastav upload a zobraz chybu
      if (!savedOrderId) {
        showToast('âŒ Nelze nahrÃ¡t pÅ™Ã­lohu - objednÃ¡vka nemÃ¡ ID! Nejprve uloÅ¾ objednÃ¡vku.', 'error');
        throw new Error('Missing savedOrderId - order must be saved first');
      }

      const result = await uploadOrderAttachment(
        savedOrderId,      // orderId
        file.file,         // file
        username,          // username
        token,             // token
        klasifikace,       // typ_prilohy
        filePrefix         // file_prefix
      );

      addDebugLog('success', 'ATTACHMENTS', 'upload-success',
        `Soubor ${file.name} nahrÃ¡n ÃºspÄ›Å¡nÄ›`, result);

      // V2 API vracÃ­: result.data.attachment_id nebo result.data.id
      const attachmentId = result.data?.attachment_id || result.data?.id;

      // Aktualizuj stav s vÃ½sledky ze serveru v obou state
      setFormData(prev => ({
        ...prev,
        prilohy_dokumenty: prev.prilohy_dokumenty.map(f =>
          f.id === fileId
            ? {
                ...f,
                status: 'uploaded',
                serverId: attachmentId,
                serverGuid: result.data?.guid || file.systemovy_nazev,
                uploadError: null,
                file: null // Uvolnit pamÄ›Å¥ - soubor je uÅ¾ na serveru
              }
            : f
        )
      }));

      setAttachments(prev => prev.map(f =>
        f.id === fileId
          ? {
              ...f,
              status: 'uploaded',
              serverId: attachmentId,
              serverGuid: result.data?.guid || file.systemovy_nazev,
              uploadError: null,
              file: null // Uvolnit pamÄ›Å¥ - soubor je uÅ¾ na serveru
            }
          : f
      ));

      // Toast pÅ™i ÃºspÄ›Å¡nÃ©m nahrÃ¡nÃ­ na server
      showToast(`âœ… PÅ™Ã­loha "${file.name}" byla ÃºspÄ›Å¡nÄ› nahrÃ¡na na server`, 'success');

    } catch (error) {
      addDebugLog('error', 'ATTACHMENTS', 'upload-error',
        `Chyba pÅ™i uploadu ${file.name}: ${error.message}`);

      // OznaÄ chybu v lokÃ¡lnÃ­m stavu v obou state
      setFormData(prev => ({
        ...prev,
        prilohy_dokumenty: prev.prilohy_dokumenty.map(f =>
          f.id === fileId
            ? {
                ...f,
                status: 'error',
                uploadError: error.message
              }
            : f
        )
      }));

      setAttachments(prev => prev.map(f =>
        f.id === fileId
          ? {
              ...f,
              status: 'error',
              uploadError: error.message
            }
          : f
      ));

      // Toast s chybou pÅ™i uploadu
      const errorMsg = error.response?.data?.message || error.message || 'NeznÃ¡mÃ¡ chyba';
      showToast(`âŒ Chyba pÅ™i nahrÃ¡vÃ¡nÃ­ pÅ™Ã­lohy "${file.name}": ${errorMsg}`, 'error');
    }
  };

  // Kontrola synchronizace pÅ™Ã­loh s DB a diskem
  const checkAttachmentsSynchronization25 = async (silentMode = false) => {
    if (!savedOrderId) {
      showToast('NenÃ­ ID objednÃ¡vky pro kontrolu synchronizace', 'warning');
      return;
    }

    try {
      setIsCheckingSyncAttachments(true);

      // 1. NAÄŒTI PÅ˜ÃLOHY VEDENÃ‰ V DB

      const serverResult = await listOrderAttachments(
        savedOrderId,      // orderId
        username,          // username
        token              // token
      );

      // V2 API vracÃ­: result.data.attachments nebo result.data (array)
      const dbAttachments = serverResult?.data?.attachments || serverResult?.data || [];

      // 2. OVÄšÅ˜ EXISTENCI SOUBORÅ® NA VZDÃLENÃ‰M SERVERU

      let verifyResult = null;
      if (dbAttachments.length > 0) {
        try {
          verifyResult = await verifyOrderAttachments(
            savedOrderId,  // orderId
            username,      // username
            token          // token
          );

        } catch (verifyError) {
        }
      }

      // 3. ZKONTROLUJ LOKÃLNÃ KONCEPT PROTI DB

      const issues = {
        hasIssues: false,
        // Kategorie problÃ©mÅ¯
        conceptUnclassified: [],     // LokÃ¡lnÃ­ pÅ™Ã­lohy bez klasifikace (po F5)
        conceptOrphaned: [],         // LokÃ¡lnÃ­ pÅ™Ã­lohy kterÃ© nejsou v DB
        dbMissingFiles: [],          // DB zÃ¡znamy bez souborÅ¯ na disku
        dbOrphaned: [],              // DB zÃ¡znamy kterÃ© nejsou v konceptu
        uploadErrors: [],            // PÅ™Ã­lohy s chybami nahrÃ¡vÃ¡nÃ­
        inconsistentState: []        // NekonzistentnÃ­ stavy
      };

      // ANALÃZA LOKÃLNÃHO KONCEPTU
      attachments.forEach((localAtt, index) => {
        try {
          // A) NeklasifikovanÃ© lokÃ¡lnÃ­ pÅ™Ã­lohy (dÅ¯leÅ¾itÃ© po F5)
          if (!localAtt.klasifikace || localAtt.klasifikace === '') {
            issues.conceptUnclassified.push(localAtt);
            issues.hasIssues = true;
          }

          // B) Chyby nahrÃ¡vÃ¡nÃ­
          if (localAtt.status === 'error') {
            issues.uploadErrors.push(localAtt);
            issues.hasIssues = true;
          }

          // C) LokÃ¡lnÃ­ pÅ™Ã­lohy kterÃ© nejsou v DB (osiÅ™elÃ©)
          if (localAtt.serverId) {
            const serverIdStr = String(localAtt.serverId); // Zajistit string pro .replace()
            const foundInDB = dbAttachments.find(dbAtt =>
              dbAtt.id.toString() === serverIdStr ||
              dbAtt.id.toString() === serverIdStr.replace('server_', '')
            );
            if (!foundInDB) {
              issues.conceptOrphaned.push(localAtt);
              issues.hasIssues = true;
            }
          } else if (localAtt.status !== 'uploaded' && localAtt.status !== 'uploading') {
            // LokÃ¡lnÃ­ soubor kterÃ½ nebyl jeÅ¡tÄ› nahrÃ¡n
            issues.conceptOrphaned.push(localAtt);
            issues.hasIssues = true;
          }
        } catch (attachmentError) {
          // PokraÄuj s dalÅ¡Ã­mi pÅ™Ã­lohami
        }
      });

      // ANALÃZA DB ZÃZNAMÅ®
      dbAttachments.forEach((dbAtt, index) => {
        try {
          // D) DB zÃ¡znamy kterÃ© nejsou v konceptu (moÅ¾nÃ¡ ztracenÃ© po F5)
          const foundInConcept = attachments.find(localAtt => {
            if (!localAtt.serverId) {
              // Pokud lokÃ¡lnÃ­ pÅ™Ã­loha nemÃ¡ serverId, pokus o shodu podle nÃ¡zvu souboru
              return localAtt.name === dbAtt.originalni_nazev_souboru && localAtt.status === 'uploaded';
            }

            const serverIdStr = String(localAtt.serverId); // Zajistit string pro .replace()
            const dbIdStr = dbAtt.id.toString();
            return (
              serverIdStr === dbIdStr ||
              serverIdStr === `server_${dbIdStr}` ||
              serverIdStr.replace('server_', '') === dbIdStr ||
              (localAtt.name === dbAtt.originalni_nazev_souboru && localAtt.status === 'uploaded')
            );
          });
          if (!foundInConcept) {
            issues.dbOrphaned.push(dbAtt);
            issues.hasIssues = true;
          }
        } catch (dbAttError) {
          // PokraÄuj s dalÅ¡Ã­mi zÃ¡znamy
        }
      });

      // E) SOUBORY CHYBÄšJÃCÃ NA DISKU nebo POÅ KOZENÃ‰ (z verify API)
      // V2 API vracÃ­: verifyResult.data.attachments s detaily o kaÅ¾dÃ©m souboru
      const verifiedAttachments = verifyResult?.data?.attachments || [];
      if (verifiedAttachments.length > 0) {
        verifiedAttachments.forEach(att => {
          // file_exists: false = soubor chybÃ­ na disku
          if (att.file_exists === false) {
            issues.dbMissingFiles.push({
              name: att.original_name || 'neznÃ¡mÃ½',
              serverId: att.attachment_id || att.id,
              path: att.system_path || att.guid,
              systemName: att.guid,
              status: att.status
            });
            issues.hasIssues = true;
          }
          // size_match: false = velikost nesouhlasÃ­ (poÅ¡kozenÃ½ soubor)
          else if (att.size_match === false) {
            issues.inconsistentState.push({
              name: att.original_name || 'neznÃ¡mÃ½',
              serverId: att.attachment_id || att.id,
              issue: `SIZE MISMATCH: DB=${att.db_size}B, Disk=${att.actual_size}B`,
              status: att.status
            });
            issues.hasIssues = true;
          }
        });
      }

      // ZOBRAZ VÃSLEDKY (pouze od FÃZE 3+ a pouze warningy/errory)
      if (!issues.hasIssues) {
        // âŒ ODSTRANÄšNO: ZbyteÄnÃ½ success toast "âœ… Synchronizace OK"
        // UÅ¾ivatel nepotÅ™ebuje vÄ›dÄ›t Å¾e vÅ¡e je OK - to je default stav
      } else {
        // âš ï¸ Zobrazit problÃ©my POUZE od FÃZE 3+ (kdy se pÅ™Ã­lohy Å™eÅ¡Ã­)
        if (currentPhase >= 3 && !silentMode) {
          let reportText = 'ðŸš¨ SYNC KONTROLA - NalezenÃ© problÃ©my:\n';

          if (issues.conceptUnclassified.length > 0) {
            reportText += `\nðŸ“ KONCEPT - NEKLASIFIKOVANÃ‰ (${issues.conceptUnclassified.length}):\n`;
            issues.conceptUnclassified.forEach(att => {
              reportText += `  â€¢ ${att.name} - potÅ™ebuje klasifikaci\n`;
            });
          }

        if (issues.conceptOrphaned.length > 0) {
          reportText += `\nðŸ“„ KONCEPT - NENAHRANÃ‰/OSIÅ˜ELÃ‰ (${issues.conceptOrphaned.length}):\n`;
          issues.conceptOrphaned.forEach(att => {
            reportText += `  â€¢ ${att.name} - ${att.serverId ? 'osiÅ™elÃ¡' : 'nenahrÃ¡na'}\n`;
          });
        }

        if (issues.dbOrphaned.length > 0) {
          reportText += `\nðŸ“‹ DB - CHYBÃ V KONCEPTU (${issues.dbOrphaned.length}):\n`;
          issues.dbOrphaned.forEach(att => {
            reportText += `  â€¢ ${att.originalni_nazev_souboru} (ID: ${att.id}) - moÅ¾nÃ¡ ztraceno po F5\n`;
          });
        }

        if (issues.dbMissingFiles.length > 0) {
          reportText += `\nðŸ’¾ SERVER - CHYBÃ SOUBORY (${issues.dbMissingFiles.length}):\n`;
          issues.dbMissingFiles.forEach(att => {
            reportText += `  â€¢ ${att.name} (${att.path || att.systemName})\n`;
          });
        }

        if (issues.inconsistentState.length > 0) {
          reportText += `\nâš ï¸ POÅ KOZENÃ‰ SOUBORY (${issues.inconsistentState.length}):\n`;
          issues.inconsistentState.forEach(att => {
            reportText += `  â€¢ ${att.name} - ${att.issue}\n`;
          });
        }

        if (issues.uploadErrors.length > 0) {
          reportText += `\nâŒ CHYBY NAHRÃVÃNÃ (${issues.uploadErrors.length}):\n`;
          issues.uploadErrors.forEach(att => {
            reportText += `  â€¢ ${att.name}\n`;
          });
        }

        showToast(reportText, 'error');

        // NABÃDKA AUTOMATICKÃCH OPRAV (pouze v interaktivnÃ­m mÃ³du)
        if (issues.dbOrphaned.length > 0) {
          showToast && showToast(
            `Nalezeno ${issues.dbOrphaned.length} pÅ™Ã­lohy v databÃ¡zi, kterÃ© chybÃ­ v konceptu (moÅ¾nÃ¡ ztracenÃ© po obnovenÃ­ strÃ¡nky F5).\n\n` +
            `Chcete je automaticky obnovit do konceptu?`, {
            type: 'info',
            timeout: 0,
            action: {
              confirmText: 'ANO, OBNOVIT',
              cancelText: 'Ne',
              onConfirm: async () => {
                await restoreAttachmentsFromDB(issues.dbOrphaned);
              }
            }
          });
        }
        } // Konec: currentPhase >= 3 && !silentMode
      }

      return issues;

    } catch (error) {

      showToast(
        `Chyba kontroly synchronizace pÅ™Ã­loh:\n${error.message}\n\n` +
        `Zkuste:\n` +
        `â€¢ Obnovit strÃ¡nku (F5)\n` +
        `â€¢ Zkontrolovat pÅ™ipojenÃ­ k serveru\n` +
        `â€¢ Zkontrolovat konzoli prohlÃ­Å¾eÄe (F12)`,
        'error'
      );
    } finally {
      setIsCheckingSyncAttachments(false);
    }
  };

  // AutomatickÃ© obnovenÃ­ pÅ™Ã­loh z DB do konceptu (po F5)
  const restoreAttachmentsFromDB = async (dbAttachments) => {
    try {
      // Pokud nejsou pÅ™edanÃ© data, naÄti z API
      if (!dbAttachments || !Array.isArray(dbAttachments)) {
        if (!savedOrderId) {
          showToast('NenÃ­ ID objednÃ¡vky pro naÄtenÃ­ pÅ™Ã­loh z DB', 'warning');
          return;
        }

        try {
          const result = await listOrderAttachments(
            savedOrderId,  // orderId
            username,      // username
            token          // token
          );

          const rawAttachments = result?.data?.attachments || result?.data || [];

          if (!Array.isArray(rawAttachments)) {
            showToast('Chyba API: neplatnÃ¡ struktura odpovÄ›di pro pÅ™Ã­lohy', 'error');
            return;
          }

          dbAttachments = rawAttachments;
        } catch (error) {
          showToast('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ pÅ™Ã­loh z databÃ¡ze', 'error');
          return;
        }
      }

      const restoredAttachments = dbAttachments.map(attachment => ({
        ...mapApiAttachmentToLocal(attachment),
        isRestored: true // Flag pro rozpoznÃ¡nÃ­ obnovenÃ½ch
      }));

      // PÅ™idej obnovenÃ© pÅ™Ã­lohy k existujÃ­cÃ­m (bez duplicit)
      setAttachments(prev => {
        const existingIds = new Set(prev.map(att => att.serverId || att.id));
        const newAttachments = restoredAttachments.filter(att =>
          !existingIds.has(att.serverId) && !existingIds.has(att.id)
        );

        // Success log odstranÄ›n
        return [...prev, ...newAttachments];
      });

      showToast(
        `âœ… Obnoveno ${restoredAttachments.length} pÅ™Ã­loh z databÃ¡ze do konceptu`,
        'success'
      );

    } catch (error) {
      showToast(`Chyba obnovovÃ¡nÃ­: ${error.message}`, 'error');
    }
  };

  // Smart naÄtenÃ­: slouÄÃ­ DB pÅ™Ã­lohy + lokÃ¡lnÃ­ neuloÅ¾enÃ© z konceptu
  // POZOR: NaÄÃ­tÃ¡ se pouze pokud je sekce pÅ™Ã­loh viditelnÃ¡
  // POZOR: NaÄÃ­tÃ¡ se POUZE od FÃZE 3+ (SCHVALENA) - FÃZE 1 a 2 pÅ™Ã­lohy neÅ™eÅ¡Ã­
  const loadAttachmentsSmartly = async () => {
    if (!savedOrderId || !token || !username) {
      return;
    }

    if (sectionStates.prilohy) {
      return;
    }

    // âœ… NaÄÃ­st pÅ™Ã­lohy z DB hned, jak mÃ¡ objednÃ¡vka ID
    try {

      // 1. Zachovej lokÃ¡lnÃ­ neuloÅ¾enÃ© pÅ™Ã­lohy z konceptu
      const localUnsavedAttachments = attachments.filter(att =>
        !att.serverId &&
        att.status !== 'uploaded' &&
        !att.fromServer
      );

      // 2. NaÄti pÅ™Ã­lohy z DB
      const rawAttachments = await fetchAttachmentsFromAPI();
      const dbAttachments = rawAttachments.map(mapApiAttachmentToLocal);

      // 3. SlouÄit: DB pÅ™Ã­lohy + lokÃ¡lnÃ­ neuloÅ¾enÃ©
      const mergedAttachments = [
        ...dbAttachments,
        ...localUnsavedAttachments
      ];

      // 4. Nastavit slouÄenÃ© pÅ™Ã­lohy
      setAttachments(mergedAttachments);

      // 5. AutomatickÃ¡ sync kontrola po naÄtenÃ­
      if (mergedAttachments.length > 0) {

        setTimeout(() => {
          checkAttachmentsSynchronization25(true); // TichÃ½ mÃ³d pro auto-kontrolu
        }, 1000); // KrÃ¡tkÃ© zpoÅ¾dÄ›nÃ­ aby se UI stihlo aktualizovat
      }

    } catch (error) {
      showToast(`Chyba smart load: ${error.message}`, 'error');
    }
  };

  // NaÄtenÃ­ existujÃ­cÃ­ch pÅ™Ã­loh ze serveru (nahrazuje celÃ½ koncept)
  // POZOR: NaÄÃ­tÃ¡ se pouze pokud je sekce pÅ™Ã­loh viditelnÃ¡
  // POZOR: NaÄÃ­tÃ¡ se POUZE od FÃZE 3+ (SCHVALENA) - FÃZE 1 a 2 pÅ™Ã­lohy neÅ™eÅ¡Ã­
  const loadAttachmentsFromServer25 = async () => {
    if (!savedOrderId || !token || !username) {
      return;
    }

    if (sectionStates.prilohy) {
      return;
    }

    // ðŸš« FÃZE 1 a 2: PÅ™Ã­lohy se neÅ™eÅ¡Ã­ - zbyteÄnÃ© zatÄ›Å¾ovÃ¡nÃ­
    if (currentPhase < 3) {
      return;
    }

    try {
      addDebugLog('info', 'ATTACHMENTS', 'load-start',
        `NaÄÃ­tÃ¡m pÅ™Ã­lohy pro objednÃ¡vku ${savedOrderId} ze serveru V2 API...`);

      const result = await listOrderAttachments(
        savedOrderId,  // orderId
        username,      // username
        token          // token
      );

      // V2 API vracÃ­: result.data.attachments nebo result.data (array)
      const rawAttachments = result?.data?.attachments || result?.data || [];

      if (!Array.isArray(rawAttachments)) {
        showToast('Chyba API: neplatnÃ¡ struktura odpovÄ›di pro pÅ™Ã­lohy', 'error');
        return;
      }

      const serverAttachments = rawAttachments.map(mapApiAttachmentToLocal);
      
      addDebugLog('success', 'ATTACHMENTS', 'load-success',
        `NaÄteno ${serverAttachments.length} pÅ™Ã­loh ze serveru`);

      // NahraÄ lokÃ¡lnÃ­ pÅ™Ã­lohy tÄ›mi ze serveru
      setAttachments(serverAttachments);

      // Success log odstranÄ›n
      // showToast(`âœ… NaÄteno ${serverAttachments.length} pÅ™Ã­loh z databÃ¡ze`, 'success'); // ODSTRANÄšNO - info je vidÄ›t v bloku pÅ™Ã­loh

    } catch (error) {

      addDebugLog('error', 'ATTACHMENTS', 'load-error',
        `Chyba pÅ™i naÄÃ­tÃ¡nÃ­ pÅ™Ã­loh: ${error.message}`);

      // Toast s chybou
      showToast(`Chyba naÄÃ­tÃ¡nÃ­ pÅ™Ã­loh z DB: ${error.message}`, 'error');
    }
  };

  // StaÅ¾enÃ­ pÅ™Ã­lohy ze serveru
  const downloadAttachmentFromServer25 = async (attachment) => {
    if (!attachment.serverId || !token || !username) {
      showToast('Nelze stÃ¡hnout pÅ™Ã­lohu - chybÃ­ server ID', 'error');
      return;
    }

    // Pro archivovanÃ©/importovanÃ© pÅ™Ã­lohy - stÃ¡hnout pÅ™Ã­mo ze starÃ© URL
    if (attachment.typ_prilohy === 'IMPORT' && attachment.originalni_nazev_souboru) {
      const oldAttachmentsUrl = process.env.REACT_APP_OLD_ATTACHMENTS_URL || 'https://erdms.zachranka.cz/prilohy/';
      const oldUrl = `${oldAttachmentsUrl}${attachment.originalni_nazev_souboru}`;

      addDebugLog('info', 'ATTACHMENTS', 'download-import',
        `StahovÃ¡nÃ­ importovanÃ© pÅ™Ã­lohy ${attachment.name} ze starÃ©ho systÃ©mu: ${oldUrl}`);

      // StÃ¡hnout pÅ™Ã­mo bez dialogu
      const link = document.createElement('a');
      link.href = oldUrl;
      link.download = attachment.originalni_nazev_souboru;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast(`ðŸ“¥ PÅ™Ã­loha "${attachment.originalni_nazev_souboru}" se stahuje ze starÃ©ho systÃ©mu`, 'info');
      return;
    }

    try {
      addDebugLog('info', 'ATTACHMENTS', 'download-start',
        `StahovÃ¡nÃ­ pÅ™Ã­lohy ${attachment.name} ze serveru...`);

      const blob = await downloadOrderAttachment(
        savedOrderId,           // orderId
        attachment.serverId,    // attachmentId
        username,               // username
        token                   // token
      );

      // PÅ™Ã­mo stÃ¡hnout soubor bez dialogÅ¯
      const { createDownloadLink25 } = await import('../services/api25orders');
      createDownloadLink25(blob, attachment.name);

      addDebugLog('success', 'ATTACHMENTS', 'download-success',
        `PÅ™Ã­loha ${attachment.name} staÅ¾ena ÃºspÄ›Å¡nÄ›`);

      // Toast s detaily downloadu - ODSTRANÄšNO (download je okamÅ¾itÃ½ a viditelnÃ½)
      // const downloadInfo = `BE Response: ServerID=${attachment.serverId}, GUID=${attachment.serverGuid || 'N/A'}, Size=${blob.size}B`;
      // showToast(`â¬‡ï¸ Download OK: ${attachment.name}\n${downloadInfo}`, 'success');

    } catch (error) {
      // Error uÅ¾ byl zpracovÃ¡n v API vrstvÄ›, staÄÃ­ zobrazit error.message
      const errorMessage = error.message || 'NepodaÅ™ilo se stÃ¡hnout pÅ™Ã­lohu';
      
      showToast(errorMessage, 'error');
      
      addDebugLog('error', 'ATTACHMENTS', 'download-error',
        `Chyba pÅ™i stahovÃ¡nÃ­ ${attachment.name}: ${errorMessage}`);
    }
  };

  // SmazÃ¡nÃ­ pÅ™Ã­lohy ze serveru a lokÃ¡lnÃ­ho stavu
  const deleteAttachmentFromServer25 = async (fileId) => {
    const attachment = attachments.find(f => f.id === fileId);
    if (!attachment) {
      return;
    }

    // UloÅ¾ attachment k potvrzenÃ­ smazÃ¡nÃ­
    setAttachmentToDelete({ fileId, attachment, isFromServer: true });
    setShowDeleteAttachmentDialog(true);
  };

  const performDeleteAttachmentFromServer = async (fileId, attachment, attachmentName) => {
    if (attachment.serverId && token && username) {
      try {
        addDebugLog('info', 'ATTACHMENTS', 'delete-start',
          `MazÃ¡nÃ­ pÅ™Ã­lohy ${attachment.name} ze serveru...`);

        const deleteResult = await deleteOrderAttachment(
          savedOrderId,           // orderId
          attachment.serverId,    // attachmentId
          username,               // username
          token                   // token
        );

        addDebugLog('success', 'ATTACHMENTS', 'delete-success',
          `PÅ™Ã­loha ${attachment.name} smazÃ¡na ze serveru`);

        // Toast pÅ™i ÃºspÄ›Å¡nÃ©m smazÃ¡nÃ­
        showToast(`ðŸ—‘ï¸ PÅ™Ã­loha "${attachment.name}" byla ÃºspÄ›Å¡nÄ› smazÃ¡na`, 'success');

      } catch (error) {

        addDebugLog('error', 'ATTACHMENTS', 'delete-error',
          `Chyba pÅ™i mazÃ¡nÃ­ ${attachment.name}: ${error.message}`);

        // Toast pÅ™i chybÄ› smazÃ¡nÃ­
        const errorMsg = error.response?.data?.message || error.message || 'NeznÃ¡mÃ¡ chyba';
        showToast(`âŒ Chyba pÅ™i mazÃ¡nÃ­ pÅ™Ã­lohy "${attachment.name}": ${errorMsg}`, 'error');
        return; // NepokraÄuj v mazÃ¡nÃ­ z lokÃ¡lnÃ­ho stavu
      }
    }

    // SmaÅ¾ z lokÃ¡lnÃ­ho stavu BEZ confirm dialogu (uÅ¾ byl potvrzen vÃ½Å¡e)
    removeFileDirectly(fileId);
  };

  // SmazÃ¡nÃ­ pÅ™Ã­lohy z lokÃ¡lnÃ­ho stavu BEZ confirm dialogu (pro volÃ¡nÃ­ z jinÃ½ch funkcÃ­)
  const removeFileDirectly = (fileId) => {
    // Aktualizuj oba state - formData i attachments
    setFormData(prev => ({
      ...prev,
      prilohy_dokumenty: (prev.prilohy_dokumenty || []).filter(file => file.id !== fileId)
    }));

    setAttachments(prev => prev.filter(file => file.id !== fileId));
  };

  // SmazÃ¡nÃ­ pÅ™Ã­lohy s confirm dialogem (pro lokÃ¡lnÃ­ nepÅ™ipojenÃ© soubory)
  const removeFile = (fileId) => {
    const file = attachments.find(f => f.id === fileId);
    if (!file) return;

    // UloÅ¾ attachment k potvrzenÃ­ smazÃ¡nÃ­
    setAttachmentToDelete({ fileId, attachment: file, isFromServer: false });
    setShowDeleteAttachmentDialog(true);
  };

  // PotvrzenÃ­ smazÃ¡nÃ­ pÅ™Ã­lohy z ConfirmDialogu
  const handleConfirmDeleteAttachment = async () => {
    if (!attachmentToDelete) return;

    const { fileId, attachment, isFromServer } = attachmentToDelete;

    if (isFromServer) {
      // SmazÃ¡nÃ­ ze serveru
      await performDeleteAttachmentFromServer(fileId, attachment, attachment.name || 'soubor');
    } else {
      // SmazÃ¡nÃ­ lokÃ¡lnÃ­ho souboru
      removeFileDirectly(fileId);
      showToast('Soubor byl odstranÄ›n', 'info');
    }

    // ZavÅ™i dialog a reset state
    setShowDeleteAttachmentDialog(false);
    setAttachmentToDelete(null);
  };

  // ZruÅ¡enÃ­ smazÃ¡nÃ­ pÅ™Ã­lohy
  const handleCancelDeleteAttachment = () => {
    setShowDeleteAttachmentDialog(false);
    setAttachmentToDelete(null);
  };

  const removeAllFiles = () => {
    if (attachments.length === 0) {
      showToast('Å½Ã¡dnÃ© pÅ™Ã­lohy k odstranÄ›nÃ­', 'info');
      return;
    }

    // OtevÅ™i confirm dialog
    setShowDeleteAllAttachmentsDialog(true);
  };

  // Handler pro potvrzenÃ­ smazÃ¡nÃ­ vÅ¡ech pÅ™Ã­loh
  const handleConfirmDeleteAllAttachments = () => {
    // Aktualizuj oba state - formData i attachments
    setFormData(prev => ({
      ...prev,
      prilohy_dokumenty: []
    }));

    setAttachments([]);

    showToast(`VÅ¡echny pÅ™Ã­lohy (${attachments.length} souborÅ¯) byly odstranÄ›ny`, 'warning');
    
    // ZavÅ™i dialog
    setShowDeleteAllAttachmentsDialog(false);
  };

  // Handler pro zruÅ¡enÃ­ smazÃ¡nÃ­ vÅ¡ech pÅ™Ã­loh
  const handleCancelDeleteAllAttachments = () => {
    setShowDeleteAllAttachmentsDialog(false);
  };

  // CentrÃ¡lnÃ­ funkce pro naÄtenÃ­ pÅ™Ã­loh z API
  // POZOR: NaÄÃ­tÃ¡ se pouze pokud je sekce pÅ™Ã­loh viditelnÃ¡
  const fetchAttachmentsFromAPI = async () => {
    if (!savedOrderId || !token || !username) {
      throw new Error('ChybÃ­ potÅ™ebnÃ© Ãºdaje pro naÄtenÃ­ pÅ™Ã­loh');
    }

    if (sectionStates.prilohy) {
      throw new Error('Sekce pÅ™Ã­loh je sbalenÃ¡ - naÄÃ­tÃ¡nÃ­ pÅ™eskoÄeno');
    }

    const result = await listOrderAttachments(
      savedOrderId,  // orderId
      username,      // username
      token          // token
    );

    // V2 API vracÃ­: result.data.attachments nebo result.data (array)
    const rawAttachments = result?.data?.attachments || result?.data || [];

    if (!Array.isArray(rawAttachments)) {
      throw new Error('API nevrÃ¡tilo pole pÅ™Ã­loh');
    }

    return rawAttachments;
  };

  // CentrÃ¡lnÃ­ mapovÃ¡nÃ­ pÅ™Ã­lohy z API response na lokÃ¡lnÃ­ objekt - 1:1 mapovÃ¡nÃ­ bez transformacÃ­
  const mapApiAttachmentToLocal = (attachment) => {
    // V2 API pouÅ¾Ã­vÃ¡: original_name, file_size, upload_date, uploaded_by_user_id, type, system_path

    // ðŸ” EXTRAKCE file_prefix ze system_path (backend pole)
    const systemPath = attachment.system_path || attachment.systemovy_nazev || attachment.final_filename || '';
    const fileName = systemPath.split('/').pop() || systemPath; // Vezmi nÃ¡zev souboru (poslednÃ­ ÄÃ¡st cesty)

    let filePrefix = 'obj-'; // Default
    if (fileName.startsWith('dd-')) {
      filePrefix = 'dd-';
    } else if (fileName.startsWith('obj-')) {
      filePrefix = 'obj-';
    }

    const mapped = {
      // PÅ™Ã­mÃ© mapovÃ¡nÃ­ z DB/API struktury
      id: `server_${attachment.id}`,
      serverId: attachment.id,
      objednavka_id: attachment.order_id || attachment.objednavka_id,
      guid: attachment.guid,
      typ_prilohy: attachment.type || attachment.typ_prilohy,
      originalni_nazev_souboru: attachment.original_name || attachment.originalni_nazev_souboru,
      systemovy_nazev: attachment.system_path, // âœ… Backend vracÃ­ system_path
      systemova_cesta: attachment.system_path, // âœ… Backend vracÃ­ system_path
      velikost: attachment.file_size || attachment.velikost || attachment.velikost_souboru_b,
      dt_vytvoreni: attachment.upload_date || attachment.created_at || attachment.dt_vytvoreni,
      dt_aktualizace: attachment.updated_at || attachment.dt_aktualizace,
      nahrano_uzivatel_id: attachment.uploaded_by_user_id || attachment.nahrano_uzivatel_id,
      nahrano_uzivatel: attachment.nahrano_uzivatel,
      file_exists: attachment.file_exists,
      file_prefix: filePrefix, // âœ… ExtrahovÃ¡no ze system_path

      // Kompatibilita s frontendem (aliasy)
      name: attachment.original_name || attachment.originalni_nazev_souboru,
      size: attachment.file_size || attachment.velikost || attachment.velikost_souboru_b,
      type: 'application/octet-stream',
      lastModified: new Date(attachment.upload_date || attachment.created_at || attachment.dt_vytvoreni || Date.now()).getTime(),
      klasifikace: attachment.type || attachment.typ_prilohy,
      cesta_k_souboru: attachment.system_path, // âœ… Backend vracÃ­ system_path

      // Status a metadata
      status: 'uploaded',
      uploadDate: attachment.upload_date || attachment.created_at || attachment.dt_vytvoreni || new Date().toISOString(),
      serverGuid: attachment.guid,
      fromServer: true
    };

    return mapped;
  };

  // PomocnÃ¡ funkce pro detekci file_prefix ze systemovÃ© cesty nebo file_prefix
  const getFilePrefix = (file) => {
    // Pokud uÅ¾ mÃ¡ file_prefix, pouÅ¾ij ho
    if (file.file_prefix) {
      return file.file_prefix;
    }

    // Extrahuj nÃ¡zev souboru ze systemovÃ© cesty
    const systemPath = file.systemova_cesta || file.systemovy_nazev || file.cesta_k_souboru || '';
    const fileName = systemPath.split('/').pop() || systemPath;

    // Kontrola prefixu nÃ¡zvu souboru
    if (fileName.startsWith('dd-')) {
      return 'dd-';
    }
    if (fileName.startsWith('obj-')) {
      return 'obj-';
    }

    return 'obj-'; // Default
  };

  // PomocnÃ© funkce pro UI styling pÅ™Ã­loh
  const getFileBorderColor = (file) => {
    if (file.status === 'error') return '#fca5a5';
    if (!file.klasifikace) return '#fca5a5';
    if (file.isDuplicate) return '#f59e0b'; // OranÅ¾ovÃ¡ pro duplicity
    if (file.status === 'uploading') return '#f59e0b';
    if (file.status === 'uploaded') return '#10b981';
    return '#e5e7eb';
  };

  const getFileBackgroundColor = (file) => {
    if (file.status === 'error') return '#fef2f2';
    if (!file.klasifikace) return '#fef2f2';
    if (file.isDuplicate) return '#fffbeb'; // SvÄ›tle oranÅ¾ovÃ¡ pro duplicity
    if (file.status === 'uploading') return '#fffbeb';
    if (file.status === 'uploaded') return '#f0fdf4';
    return 'white';
  };

  const getFileIconColor = (file) => {
    if (file.status === 'error') return '#dc2626';
    if (file.status === 'uploading') return '#f59e0b';
    if (file.status === 'uploaded') return '#10b981';
    return '#6b7280';
  };

  const getFileStatusIndicator = (file) => {
    switch (file.status) {
      case 'pending_classification':
        return (
          <span style={{
            color: '#dc2626',
            fontSize: '0.75rem',
            marginLeft: '0.5rem',
            fontWeight: '600'
          }}>
            âš ï¸ ÄŒekÃ¡ na klasifikaci
          </span>
        );
      case 'uploading':
        return (
          <span style={{
            color: '#f59e0b',
            fontSize: '0.75rem',
            marginLeft: '0.5rem',
            fontWeight: '600'
          }}>
            â³ NahrÃ¡vÃ¡ se...
          </span>
        );
      case 'uploaded':
        return (
          <span style={{
            color: '#10b981',
            fontSize: '0.75rem',
            marginLeft: '0.5rem',
            fontWeight: '600'
          }}>
            âœ… NahrÃ¡no na server
          </span>
        );
      case 'error':
        return (
          <span style={{
            color: '#dc2626',
            fontSize: '0.75rem',
            marginLeft: '0.5rem',
            fontWeight: '600'
          }}>
            âŒ Chyba uploadu
          </span>
        );
      default:
        return null;
    }
  };

  // Funkce pro prÃ¡ci s poloÅ¾kami objednÃ¡vky
  const addPolozka = () => {
    setFormData(prev => ({
      ...prev,
      polozky_objednavky: [
        ...(prev.polozky_objednavky || []),
        {
          id: Date.now(),
          popis: '',
          cena_bez_dph: '',
          sazba_dph: '21',
          cena_s_dph: '',
          // ðŸ¢ VolitelnÃ¡ lokalizace - inicializace prÃ¡zdnÃ½ch hodnot
          usek_kod: '',
          budova_kod: '',
          mistnost_kod: '',
          poznamka: '',
          // ðŸŽ¯ LP kÃ³d na Ãºrovni poloÅ¾ky
          lp_id: null
        }
      ]
    }));

    // Auto-save po pÅ™idÃ¡nÃ­ poloÅ¾ky
    setTimeout(() => saveDraft(true), 100);
  };

  const removePolozka = (id) => {
    const currentPolozky = formData.polozky_objednavky || [];
    if (currentPolozky.length <= 1) return; // MinimÃ¡lnÄ› jedna poloÅ¾ka

    setFormData(prev => ({
      ...prev,
      polozky_objednavky: (prev.polozky_objednavky || []).filter(p => p.id !== id)
    }));

    // Auto-save po odebrÃ¡nÃ­ poloÅ¾ky
    setTimeout(() => saveDraft(true), 100);
  };

  const updatePolozka = (id, field, value) => {
    setFormData(prev => ({
      ...prev,
      polozky_objednavky: (prev.polozky_objednavky || []).map(polozka => {
        if (polozka.id === id) {
          const updatedPolozka = { ...polozka, [field]: value };

          // Pokud se mÄ›nÃ­ cena bez DPH nebo DPH sazba, pÅ™epoÄÃ­tej cenu s DPH
          if (field === 'cena_bez_dph' || field === 'sazba_dph') {
            const cenaBezDph = parseFloat((updatedPolozka.cena_bez_dph || '0').replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            const dphSazba = parseFloat(updatedPolozka.sazba_dph) || 0;
            const cenaSdph = cenaBezDph * (1 + dphSazba / 100);
            // Pro faktury/ÃºÄetnictvÃ­ pÅ™esnÄ› 2 desetinnÃ¡ mÃ­sta
            updatedPolozka.cena_s_dph = cenaSdph.toFixed(2);
          }

          // Pokud se mÄ›nÃ­ cena s DPH, pÅ™epoÄÃ­tej cenu bez DPH
          if (field === 'cena_s_dph') {
            const cenaSdph = parseFloat((updatedPolozka.cena_s_dph || '0').replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            const dphSazba = parseFloat(updatedPolozka.sazba_dph) || 0;
            const cenaBezDph = cenaSdph / (1 + dphSazba / 100);
            // Pro faktury/ÃºÄetnictvÃ­ pÅ™esnÄ› 2 desetinnÃ¡ mÃ­sta
            updatedPolozka.cena_bez_dph = cenaBezDph.toFixed(2);
          }

          return updatedPolozka;
        }
        return polozka;
      })
    }));

    // ðŸŽ¯ NOVÃ AUTOSAVE pro poloÅ¾ky objednÃ¡vky
    // Pro select DPH - okamÅ¾itÄ›, pro text/ceny - pÅ™i blur (Å™eÅ¡Ã­ se ve FormatNumberInput)
    if (field === 'sazba_dph') {
      // Select DPH - okamÅ¾itÃ© uloÅ¾enÃ­
      if (!disableAutosaveRef.current && draftManager.isAutosaveEnabled() && !isSaving && !showSaveProgress && isDraftLoaded) {
        triggerAutosave(true); // immediate
      }
    }
    // Pro popis a ceny se autosave spustÃ­ pÅ™i onBlur z input pole
  };

  // PokroÄilÃ© funkce pro dodavatele
  const handleSupplierLocalSearch = async () => {
    // Pre-fill search with current supplier name or ICO if available
    const currentName = formData.dodavatel_nazev || '';
    const currentIco = formData.dodavatel_ico || '';
    const searchTerm = currentName || currentIco;

    setSupplierSearchTerm(searchTerm);
    setSupplierSearchResults([]);
    setShowSupplierSearchDialog(true);

    // Load all available contacts and apply initial filter if we have search term
    await loadAllSupplierContacts(searchTerm);
  };

  // ðŸŽ¯ Kontrola zda jsou vyplnÄ›nÃ© vÅ¡echny povinnÃ© Ãºdaje dodavatele pro pÅ™idÃ¡nÃ­ do adresÃ¡Å™e
  const checkSupplierRequiredFields = () => {
    return !!(
      formData.dodavatel_nazev?.trim() &&
      formData.dodavatel_adresa?.trim() &&
      formData.dodavatel_ico?.trim() &&
      /^\d{8}$/.test(formData.dodavatel_ico?.trim()) // IÄŒO musÃ­ mÃ­t 8 ÄÃ­slic
    );
  };

  // ðŸŽ¯ Handler pro kliknutÃ­ na ikonu "PÅ™idat do adresÃ¡Å™e"
  const handleAddSupplierToDirectory = async () => {
    // DEBUG: Add to directory button click - logging removed
    // DEBUG: ADD TO DIRECTORY logging removed for performance
    /*// console.log('ðŸ“Š [ADD TO DIRECTORY] formData dodavatele:', {
      nazev: formData.dodavatel_nazev,
      adresa: formData.dodavatel_adresa,
      ico: formData.dodavatel_ico,
      dic: formData.dodavatel_dic,
      zastoupeny: formData.dodavatel_zastoupeny,
      kontakt_jmeno: formData.dodavatel_kontakt_jmeno,
      kontakt_email: formData.dodavatel_kontakt_email,
      kontakt_telefon: formData.dodavatel_kontakt_telefon
    });*/

    if (!checkSupplierRequiredFields()) {
      showToast?.('VyplÅˆte vÅ¡echny povinnÃ© Ãºdaje dodavatele (nÃ¡zev, adresa, IÄŒO)', 'warning');
      return;
    }

    // Detekce existence dodavatele v DB
    try {
      setExistingSupplierCheck({ loading: true });

      // Kontrola podle IÄŒO
      const ico = formData.dodavatel_ico.trim();
      const result = await fetchSupplierContacts({
        token,
        username,
        user_id,
        usek_zkr: userDetail?.usek_zkr,
        ico: ico, // Filtruj podle IÄŒO
        load_all: hasPermission && hasPermission('CONTACT_MANAGE')
      });

      // PrÃ¡va pro vÃ½bÄ›r Global scope
      const canManageGlobal = hasPermission && hasPermission('CONTACT_MANAGE');

      // ðŸ” DEBUG: Co backend vrÃ¡til

      // Filtruj vÃ½sledky podle IÄŒO (stejnÃ© IÄŒO mÅ¯Å¾e bÃ½t vÃ­ckrÃ¡t s rÅ¯znÃ½m scope)
      const filteredResults = Array.isArray(result)
        ? result.filter(supplier => supplier.ico?.trim() === ico)
        : [];


      if (filteredResults.length > 0) {

        // Pro kaÅ¾dÃ© IÄŒO mÅ¯Å¾e existovat max 3 zÃ¡znamy (Personal, Ãšsek, Global)
        // PRAVIDLA DETEKCE:
        // 1. usek_zkr vyplnÄ›nÃ© â†’ ÃšSEK (priorita! ignoruje user_id)
        // 2. user_id > 0 && usek_zkr prÃ¡zdnÃ© â†’ PERSONAL
        // 3. user_id = 0 && usek_zkr prÃ¡zdnÃ© â†’ GLOBAL

        // 1. ÃšSEK: MÃ¡ vyplnÄ›nÃ© usek_zkr (NEJVYÅ Å Ã PRIORITA)
        const existsInUsek = filteredResults.find(s => {
          const hasUsek = s.usek_zkr && s.usek_zkr.trim() !== '' && s.usek_zkr !== '[]' && s.usek_zkr !== 'null';

          if (hasUsek) {
            try {
              const supplierUseky = JSON.parse(s.usek_zkr);
              const myUsekRaw = userDetail?.usek_zkr;

              // MÅ¯j Ãºsek mÅ¯Å¾e bÃ½t string nebo array
              const myUseky = Array.isArray(myUsekRaw) ? myUsekRaw : [myUsekRaw];


              // Zkontroluj jestli NÄšJAKÃ z mÃ½ch ÃºsekÅ¯ je v ÃºsecÃ­ch dodavatele
              const hasCommonUsek = Array.isArray(supplierUseky) &&
                                   myUseky.some(myUsek => myUsek && supplierUseky.includes(myUsek));

              return hasCommonUsek;
            } catch (e) {
              return false;
            }
          }
          return false;
        });

        // 2. PERSONAL: user_id > 0 && usek_zkr prÃ¡zdnÃ©
        const existsInPersonal = filteredResults.find(s => {
          const hasUsek = s.usek_zkr && s.usek_zkr.trim() !== '' && s.usek_zkr !== '[]' && s.usek_zkr !== 'null';
          const isPersonal = (s.user_id && s.user_id !== 0 && s.user_id !== '0') && !hasUsek;
          return isPersonal;
        });

        // 3. GLOBAL: user_id = 0 && usek_zkr prÃ¡zdnÃ©
        const existsInGlobal = filteredResults.find(s => {
          const hasUsek = s.usek_zkr && s.usek_zkr.trim() !== '' && s.usek_zkr !== '[]' && s.usek_zkr !== 'null';
          const isGlobal = (s.user_id === 0 || s.user_id === '0') && !hasUsek;
          return isGlobal;
        });


        // PÅ™edÃ¡me info o tom, ve kterÃ½ch scope dodavatel existuje
        setExistingSupplierCheck({
          exists: true,
          existsInPersonal: existsInPersonal || null,
          existsInUsek: existsInUsek || null,
          existsInGlobal: existsInGlobal || null,
          // Pro zpÄ›tnou kompatibilitu - preferuj Personal > Ãšsek > Global
          supplier: existsInPersonal || existsInUsek || existsInGlobal
        });
      } else {
        // Dodavatel neexistuje
        setExistingSupplierCheck({
          exists: false,
          existsInPersonal: null,
          existsInUsek: null,
          existsInGlobal: null,
          supplier: null
        });
      }

      // OtevÅ™Ã­t dialog
      setShowSupplierAddDialog(true);
    } catch (error) {
      showToast?.('Chyba pÅ™i kontrole dodavatele v databÃ¡zi', 'error');
      setExistingSupplierCheck(null);
    }
  };

  // ðŸŽ¯ Handler pro uloÅ¾enÃ­ dodavatele do adresÃ¡Å™e
  const handleSaveSupplierToDirectory = async (supplierData, scope, useky = null) => {
    // DEBUG: SAVE TO DIRECTORY logging removed for performance
    /*// console.log('ðŸ’¾ [SAVE TO DIRECTORY] ZaÄÃ¡tek uklÃ¡dÃ¡nÃ­');
    // console.log('ðŸ“Š [SAVE TO DIRECTORY] PÅ™Ã­chozÃ­ supplierData:', supplierData);
    // console.log('ðŸŽ¯ [SAVE TO DIRECTORY] Scope:', scope, 'Ãšseky:', useky);*/

    try {
      // UrÄenÃ­ user_id a usek_zkr podle scope
      let userId;
      let usekZkr;

      if (scope === 'personal') {
        userId = user_id; // ID pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele
        usekZkr = '';  // âœ… PrÃ¡zdnÃ½ string (NIKDY null!) - Personal scope
      } else if (scope === 'usek') {
        userId = 0; // 0 = nenÃ­ osobnÃ­
        usekZkr = useky || []; // Array zkratek ÃºsekÅ¯
      } else { // global
        userId = 0;
        usekZkr = '';  // âœ… PrÃ¡zdnÃ½ string (NIKDY null!) - Global scope
      }

      // ðŸ”§ FIX: SupplierAddDialog pouÅ¾Ã­vÃ¡ UNPREFIXED nÃ¡zvy (nazev, ico, adresa)
      // OrderForm25 mu ale pÅ™edÃ¡vÃ¡ PREFIXED data (dodavatel_nazev, dodavatel_ico, ...)
      // SupplierAddDialog je internÄ› mapuje na unprefixed â†’ supplierData obsahuje uÅ¾ .nazev, .ico atd.
      const dataToSave = {
        nazev: supplierData.nazev || supplierData.dodavatel_nazev || '',
        adresa: supplierData.adresa || supplierData.dodavatel_adresa || '',
        ico: supplierData.ico || supplierData.dodavatel_ico || '',
        dic: supplierData.dic || supplierData.dodavatel_dic || '',
        zastoupeny: supplierData.zastoupeny || supplierData.dodavatel_zastoupeny || '',
        kontakt_jmeno: supplierData.kontakt_jmeno || supplierData.dodavatel_kontakt_jmeno || '',
        kontakt_email: supplierData.kontakt_email || supplierData.dodavatel_kontakt_email || '',
        kontakt_telefon: supplierData.kontakt_telefon || supplierData.dodavatel_kontakt_telefon || '',
        user_id: userId,
        usek_zkr: usekZkr // Backend oÄekÃ¡vÃ¡ array nebo null (NE JSON string!)
      };

      // console.log('ðŸ“¦ [SAVE TO DIRECTORY] Data pÅ™ipravenÃ¡ k odeslÃ¡nÃ­:', dataToSave);

      let result;

      if (existingSupplierCheck?.exists && scope === existingSupplierCheck.scope) {
        // Aktualizace existujÃ­cÃ­ho dodavatele ve stejnÃ©m scope
        // console.log('ðŸ”„ [SAVE TO DIRECTORY] Aktualizace existujÃ­cÃ­ho dodavatele');
        /*console.log('ðŸ“¤ [SAVE TO DIRECTORY] Parametry pro updateSupplierByIco:', {
          ico: dataToSave.ico,
          nazev: dataToSave.nazev,
          adresa: dataToSave.adresa,
          userId,
          usekZkr
        });*/

        result = await updateSupplierByIco({
          token,
          username,
          user_id: userId,
          usek_zkr: usekZkr,
          ico: dataToSave.ico,
          nazev: dataToSave.nazev,
          adresa: dataToSave.adresa,
          dic: dataToSave.dic,
          zastoupeny: dataToSave.zastoupeny,
          kontakt_jmeno: dataToSave.kontakt_jmeno,
          kontakt_email: dataToSave.kontakt_email,
          kontakt_telefon: dataToSave.kontakt_telefon
        });

        // console.log('âœ… [SAVE TO DIRECTORY] Update ÃºspÄ›Å¡nÃ½, odpovÄ›Ä:', result);
        showToast?.('Dodavatel byl ÃºspÄ›Å¡nÄ› aktualizovÃ¡n v adresÃ¡Å™i', 'success');
      } else {
        // VytvoÅ™enÃ­ novÃ©ho dodavatele (nebo pÅ™idÃ¡nÃ­ do jinÃ©ho scope)
        // console.log('âž• [SAVE TO DIRECTORY] VytvÃ¡Å™enÃ­ novÃ©ho dodavatele');
        /*console.log('ðŸ“¤ [SAVE TO DIRECTORY] Parametry pro createSupplier:', {
          userId,  // â† SprÃ¡vnÃ½ userId podle scope
          usekZkr,  // â† SprÃ¡vnÃ½ usekZkr podle scope
          ...dataToSave
        });*/

        // ðŸ”§ FIX: createSupplier oÄekÃ¡vÃ¡ FLAT parametry, ne data objekt!
        // ðŸ”§ FIX 2: PouÅ¾Ã­t SPRÃVNÃ userId a usekZkr podle vybranÃ©ho scope!
        //   - Personal: userId = user_id, usekZkr = null
        //   - Ãšsek: userId = 0, usekZkr = [array ÃºsekÅ¯]
        //   - Global: userId = 0, usekZkr = null
        result = await createSupplier({
          token,
          username,
          user_id: userId,  // âœ… Z promÄ›nnÃ© userId (ne user_id!)
          usek_zkr: usekZkr,  // âœ… Z promÄ›nnÃ© usekZkr (ne userDetail.usek_zkr!)
          // Rozbalit dataToSave FLAT do parametrÅ¯
          nazev: dataToSave.nazev,
          adresa: dataToSave.adresa,
          ico: dataToSave.ico,
          dic: dataToSave.dic,
          zastoupeny: dataToSave.zastoupeny,
          kontakt_jmeno: dataToSave.kontakt_jmeno,
          kontakt_email: dataToSave.kontakt_email,
          kontakt_telefon: dataToSave.kontakt_telefon
        });

        // console.log('âœ… [SAVE TO DIRECTORY] Create ÃºspÄ›Å¡nÃ½, odpovÄ›Ä:', result);
        showToast?.('Dodavatel byl ÃºspÄ›Å¡nÄ› pÅ™idÃ¡n do adresÃ¡Å™e', 'success');
      }

      // VyÄistit cache naÄtenÃ½ch kontaktÅ¯ (aby se znovu naÄetly s novÃ½m zÃ¡znamem)
      setAllSupplierContacts([]);

      // ZavÅ™Ã­t dialog
      // console.log('ðŸšª [SAVE TO DIRECTORY] ZavÃ­rÃ¡nÃ­ dialogu');
      setShowSupplierAddDialog(false);
      setExistingSupplierCheck(null);
    } catch (error) {
      throw new Error(error.message || 'Chyba pÅ™i uklÃ¡dÃ¡nÃ­ dodavatele do databÃ¡ze');
    }
  };

  const loadAllSupplierContacts = async (initialSearchTerm = '') => {
    // Pokud uÅ¾ jsou kontakty naÄtenÃ©, nedÄ›lÃ¡me nic - jen aplikujeme filtr
    if (allSupplierContacts.length > 0) {
      if (initialSearchTerm && initialSearchTerm.length >= 2) {
        performSupplierSearch(initialSearchTerm);
      } else {
        setSupplierSearchResults(allSupplierContacts);
      }
      return;
    }

    setSupplierSearchLoading(true);

    try {
      const result = await fetchSupplierContacts({
        token: token,
        username: username,
        user_id: user_id,
        usek_zkr: userDetail?.usek_zkr || undefined,
        load_all: hasPermission && hasPermission('CONTACT_MANAGE') // Load all contacts for CONTACT_MANAGE users
      });

      if (Array.isArray(result)) {
        setAllSupplierContacts(result); // UloÅ¾Ã­me si vÅ¡echny kontakty

        // Aplikovat filtr pokud mÃ¡me vyhledÃ¡vacÃ­ termÃ­n, jinak zobrazit vÅ¡echny
        if (initialSearchTerm && initialSearchTerm.length >= 2) {
          // Normalizovat vyhledÃ¡vacÃ­ termÃ­n
          const searchNormalized = normalizeText(initialSearchTerm);

          // Filtruji pÅ™Ã­mo novÄ› naÄtenÃ¡ data
          const filtered = result.filter(supplier => {
            const name = normalizeText(supplier.nazev || supplier.name || '');
            const ico = (supplier.ico || '').toLowerCase(); // IÄŒO nenÃ­ tÅ™eba normalizovat
            const email = (supplier.kontakt_email || supplier.email || '').toLowerCase();
            const contact = normalizeText(supplier.kontakt_jmeno || '');

            return name.includes(searchNormalized) ||
                   ico.includes(initialSearchTerm.toLowerCase()) || // Pro IÄŒO pouÅ¾Ã­t pÅ¯vodnÃ­ termÃ­n
                   email.includes(initialSearchTerm.toLowerCase()) || // Pro email pouÅ¾Ã­t pÅ¯vodnÃ­ termÃ­n
                   contact.includes(searchNormalized);
          });
          setSupplierSearchResults(filtered);
        } else {
          setSupplierSearchResults(result); // ZobrazÃ­me vÅ¡echny kontakty
        }
      } else {
        setAllSupplierContacts([]);
        setSupplierSearchResults([]);
      }

    } catch (error) {
      showToast && showToast('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ kontaktÅ¯: ' + error.message, { type: 'error' });
      setAllSupplierContacts([]);
      setSupplierSearchResults([]);
    } finally {
      setSupplierSearchLoading(false);
    }
  };

  const performSupplierSearch = (searchTerm) => {
    if (!searchTerm || searchTerm.length < 2) {
      // Zobrazit vÅ¡echny kontakty pokud je search prÃ¡zdnÃ½
      setSupplierSearchResults(allSupplierContacts);
      return;
    }

    // Normalizovat vyhledÃ¡vacÃ­ termÃ­n
    const searchNormalized = normalizeText(searchTerm);

    // LokÃ¡lnÃ­ filtrovÃ¡nÃ­ naÄtenÃ½ch kontaktÅ¯ - bez API volÃ¡nÃ­!
    const filtered = allSupplierContacts.filter(supplier => {
      const name = normalizeText(supplier.nazev || supplier.name || '');
      const ico = (supplier.ico || '').toLowerCase(); // IÄŒO nenÃ­ tÅ™eba normalizovat
      const email = (supplier.kontakt_email || supplier.email || '').toLowerCase();
      const contact = normalizeText(supplier.kontakt_jmeno || '');

      return name.includes(searchNormalized) ||
             ico.includes(searchTerm.toLowerCase()) || // Pro IÄŒO pouÅ¾Ã­t pÅ¯vodnÃ­ termÃ­n
             email.includes(searchTerm.toLowerCase()) || // Pro email pouÅ¾Ã­t pÅ¯vodnÃ­ termÃ­n
             contact.includes(searchNormalized);
    });

    setSupplierSearchResults(filtered);
  };

  const handleSupplierSearchChange = (e) => {
    const value = e.target.value;
    setSupplierSearchTerm(value);

    // OkamÅ¾itÃ© lokÃ¡lnÃ­ filtrovÃ¡nÃ­ - Å¾Ã¡dnÃ½ debounce ani API volÃ¡nÃ­!
    performSupplierSearch(value);
  };

  const handleSupplierSearchSelect = (supplier) => {
    // Fill form with selected supplier data using correct field names
    setFormData(prev => ({
      ...prev,
      dodavatel_nazev: supplier.nazev || supplier.name || '',
      dodavatel_adresa: supplier.adresa || supplier.address || '',
      dodavatel_ico: supplier.ico || '',
      dodavatel_dic: supplier.dic || '',
      dodavatel_zastoupeny: supplier.zastoupeny || supplier.represented || '',
      dodavatel_kontakt_jmeno: supplier.kontakt_jmeno || (supplier.contactPerson && supplier.contactPerson.name) || '',
      dodavatel_kontakt_email: supplier.kontakt_email || (supplier.contactPerson && supplier.contactPerson.email) || supplier.email || '',
      dodavatel_kontakt_telefon: supplier.kontakt_telefon || (supplier.contactPerson && supplier.contactPerson.phone) || supplier.telefon || ''
    }));

    setShowSupplierSearchDialog(false);
    setSupplierSearchTerm('');
    setSupplierSearchResults([]);
    showToast && showToast('Dodavatel byl vybrÃ¡n', { type: 'success' });
  };

  const handleSupplierSearchClose = () => {
    setShowSupplierSearchDialog(false);
    setSupplierSearchTerm('');
    setSupplierSearchResults([]);
  };

  const handleSupplierAresSearch = () => {
    // Pre-fill search with current supplier name or IÄŒO if available
    const currentName = formData.dodavatel_nazev || '';
    const currentICO = formData.dodavatel_ico || '';
    const searchTerm = currentName || currentICO;

    setAresSearch(searchTerm);
    setAresPopupOpen(true);
    if (searchTerm && searchTerm.length >= 2) {
      fetchAresData(searchTerm);
    }
  };

  const fetchAresData = async (searchTerm = '') => {
    const trimmedSearchTerm = searchTerm?.trim();
    if (!trimmedSearchTerm || trimmedSearchTerm.length < 3) {
      setAresResults([]);
      return;
    }

    try {
      setLoadingAres(true);

      // Check if search term is numeric (IÄŒO) or text (nÃ¡zev)
      const isICO = /^\d+$/.test(trimmedSearchTerm);

      let url, requestData;

      if (isICO) {
        // Search by IÄŒO - direct endpoint
        url = `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${trimmedSearchTerm}`;
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (response.ok) {
          const data = await response.json();
          const result = {
            ico: data.ico,
            dic: data.dic || '',
            nazev: data.obchodniJmeno || '',
            adresa: data.sidlo?.textovaAdresa || '',
            sidlo: data.sidlo?.textovaAdresa || ''
          };
          setAresResults([result]);
        } else {
          setAresResults([]);
          if (trimmedSearchTerm.length >= 8) {
            showToast && showToast('Dodavatel nebyl v ARES nalezen', { type: 'warning' });
          }
        }
      } else {
        // Search by nÃ¡zev - search endpoint
        url = 'https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/vyhledat';

        // ZkusÃ­me vyhledat jak s pÅ¯vodnÃ­m textem, tak s normalizovanÃ½m
        const searchVariants = [
          trimmedSearchTerm, // PÅ¯vodnÃ­ text
          normalizeText(trimmedSearchTerm) // NormalizovanÃ½ text (bez diakritiky)
        ].filter((term, index, arr) => arr.indexOf(term) === index); // OdstranÃ­ duplikÃ¡ty

        let allResults = [];

        // VyhledÃ¡me pro kaÅ¾dou variantu
        for (const searchVariant of searchVariants) {
          if (!searchVariant) continue;

          requestData = {
            obchodniJmeno: searchVariant,
            pocet: 25
          };

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
          });

          if (response.ok) {
            const data = await response.json();
            const results = (data.ekonomickeSubjekty || []).map(item => ({
              ico: item.ico,
              dic: item.dic || '',
              nazev: item.obchodniJmeno || '',
              adresa: item.sidlo?.textovaAdresa || '',
              sidlo: item.sidlo?.textovaAdresa || ''
            }));
            allResults.push(...results);
          }
        }

        // Odstranit duplikÃ¡ty podle IÄŒO
        const uniqueResults = allResults.filter((item, index, arr) =>
          arr.findIndex(other => other.ico === item.ico) === index
        );

        // SeÅ™adit podle relevance - nejdÅ™Ã­ve ty kterÃ© obsahujÃ­ pÅ¯vodnÃ­ vyhledÃ¡vacÃ­ termÃ­n
        const normalizedSearchTerm = normalizeText(trimmedSearchTerm);
        uniqueResults.sort((a, b) => {
          const aNameNorm = normalizeText(a.nazev);
          const bNameNorm = normalizeText(b.nazev);

          const aContainsOriginal = aNameNorm.includes(normalizedSearchTerm);
          const bContainsOriginal = bNameNorm.includes(normalizedSearchTerm);

          if (aContainsOriginal && !bContainsOriginal) return -1;
          if (!aContainsOriginal && bContainsOriginal) return 1;
          return 0;
        });

        setAresResults(uniqueResults);

        // ðŸŽ¯ Detekce scope pro kaÅ¾dÃ½ vÃ½sledek
        if (uniqueResults.length > 0) {
          const scopeInfoMap = {};

          // Pro kaÅ¾dÃ½ vÃ½sledek zkontroluj zda existuje v DB
          for (const aresItem of uniqueResults) {
            if (!aresItem.ico) continue;

            try {
              const dbResults = await fetchSupplierContacts({
                token,
                username,
                user_id,
                usek_zkr: userDetail?.usek_zkr,
                ico: aresItem.ico,
                load_all: hasPermission && hasPermission('CONTACT_MANAGE')
              });

              const filteredResults = Array.isArray(dbResults)
                ? dbResults.filter(s => s.ico?.trim() === aresItem.ico.trim())
                : [];

              if (filteredResults.length > 0) {
                // Normalizace userDetail.usek_zkr na pole
                const myUseky = Array.isArray(userDetail?.usek_zkr)
                  ? userDetail.usek_zkr
                  : [userDetail?.usek_zkr];

                // 1. ÃšSEK: MÃ¡ vyplnÄ›nÃ© usek_zkr
                const existsInUsek = filteredResults.find(s => {
                  const hasUsek = s.usek_zkr && s.usek_zkr.trim() !== '' && s.usek_zkr !== '[]' && s.usek_zkr !== 'null';
                  if (hasUsek) {
                    try {
                      const supplierUseky = JSON.parse(s.usek_zkr);
                      const hasCommonUsek = myUseky.some(myUsek => myUsek && supplierUseky.includes(myUsek));
                      return hasCommonUsek;
                    } catch (e) {
                      return false;
                    }
                  }
                  return false;
                });

                // 2. PERSONAL: user_id > 0 && user_id === currentUserId && usek_zkr prÃ¡zdnÃ©
                const existsInPersonal = filteredResults.find(s => {
                  const hasUsek = s.usek_zkr && s.usek_zkr.trim() !== '' && s.usek_zkr !== '[]' && s.usek_zkr !== 'null';
                  return s.user_id > 0 && s.user_id === user_id && !hasUsek;
                });

                // 3. GLOBAL: user_id = 0 && usek_zkr prÃ¡zdnÃ©
                const existsInGlobal = filteredResults.find(s => {
                  const hasUsek = s.usek_zkr && s.usek_zkr.trim() !== '' && s.usek_zkr !== '[]' && s.usek_zkr !== 'null';
                  return s.user_id === 0 && !hasUsek;
                });

                scopeInfoMap[aresItem.ico] = {
                  existsInPersonal: !!existsInPersonal,
                  existsInUsek: !!existsInUsek,
                  existsInGlobal: !!existsInGlobal
                };
              } else {
                scopeInfoMap[aresItem.ico] = {
                  existsInPersonal: false,
                  existsInUsek: false,
                  existsInGlobal: false
                };
              }
            } catch (error) {
              scopeInfoMap[aresItem.ico] = {
                existsInPersonal: false,
                existsInUsek: false,
                existsInGlobal: false
              };
            }
          }

          setAresScopeInfo(scopeInfoMap);
        }

        if (uniqueResults.length === 0) {
          // Å½Ã¡dnÃ© vÃ½sledky nenalezeny ani s normalizacÃ­
        }
      }

    } catch (error) {
      setAresResults([]);
      setAresScopeInfo({});
      showToast && showToast('Chyba pÅ™i pÅ™ipojenÃ­ k ARES', { type: 'error' });
    } finally {
      setLoadingAres(false);
    }
  };

  // ðŸ¢ Handler pro pÅ™epnutÃ­ vÃ½bÄ›ru Ãºseku v ARES dialogu (stejnÃ½ jako v SupplierAddDialog)
  const handleAresUsekToggle = (usekZkr) => {
    setAresSelectedUseky(prev => {
      if (prev.includes(usekZkr)) {
        return prev.filter(zkr => zkr !== usekZkr);
      } else {
        return [...prev, usekZkr];
      }
    });
  };

  const handleAresSearchChange = (e) => {
    const value = e.target.value;
    setAresSearch(value);

    // Debounce search
    if (value.length >= 2) {
      clearTimeout(window.aresSearchTimeout);
      window.aresSearchTimeout = setTimeout(() => {
        fetchAresData(value);
      }, 500);
    } else {
      setAresResults([]);
    }
  };

  const handleAresSelect = (aresItem) => {
    setFormData(prev => ({
      ...prev,
      dodavatel_nazev: aresItem.nazev || '',
      dodavatel_adresa: aresItem.adresa || aresItem.sidlo || '',
      dodavatel_ico: aresItem.ico || '',
      dodavatel_dic: aresItem.dic || ''
    }));

    setAresPopupOpen(false);
    setAresSearch('');
    setAresResults([]);
    showToast && showToast('Dodavatel naÄten z ARES', { type: 'success' });
  };

  // Funkce pro uklÃ¡dÃ¡nÃ­ ARES zÃ¡znamu do lokÃ¡lnÃ­ databÃ¡ze
  const handleSaveToLocal = async (aresItem, saveLocation) => {
    if (!token || !username || !user_id) {
      showToast && showToast('ChybÃ­ pÅ™ihlaÅ¡ovacÃ­ Ãºdaje', { type: 'error' });
      return;
    }

    setSavingToLocal(aresItem.ico);

    try {
      // Debug informace
      addDebugLog('info', 'ARES-SAVE', 'permissions-check', `UÅ¾ivatel: ${username}, USER_MANAGE: ${canManageUsers}, Ãšsek: ${userDetail?.usek_zkr}, UklÃ¡dÃ¡m do: ${JSON.stringify(saveLocation)}`);

      // ðŸŽ¯ UrÄit user_id a usek_zkr podle vybranÃ©ho umÃ­stÄ›nÃ­
      let targetUserId = 0; // 0 = globÃ¡lnÃ­ nebo ÃºsekovÃ½
      let targetUsekZkr = '';

      if (saveLocation === 'personal') {
        targetUserId = user_id; // OsobnÃ­ kontakt - jen pro vlastnÃ­ka
        targetUsekZkr = '';
        addDebugLog('info', 'ARES-SAVE', 'target-personal', `CÃ­l: OsobnÃ­ kontakt pro user_id=${targetUserId}`);
      } else if (saveLocation?.scope === 'usek' || saveLocation === 'department') {
        // ðŸ¢ ÃšSEKOVÃ KONTAKT - pouÅ¾Ã­t vybranÃ© Ãºseky
        targetUserId = 0;
        const selectedUseky = saveLocation?.useky || [userDetail?.usek_zkr || ''];
        targetUsekZkr = JSON.stringify(selectedUseky);
        addDebugLog('info', 'ARES-SAVE', 'target-usek', `CÃ­l: Kontakty Ãºseku pro Ãºseky=${selectedUseky.join(', ')}, usek_zkr=${targetUsekZkr}`);
      } else if (saveLocation === 'global') {
        targetUserId = 0; // GlobÃ¡lnÃ­ kontakt - vidÃ­ vÅ¡ichni
        targetUsekZkr = '';
        addDebugLog('info', 'ARES-SAVE', 'target-global', `CÃ­l: GlobÃ¡lnÃ­ kontakt (user_id=0, usek_zkr='')`);
      }

      // NejdÅ™Ã­ve zkusit aktualizovat existujÃ­cÃ­ zÃ¡znam
      try {
        await updateSupplierByIco({
          token,
          username,
          ico: aresItem.ico,
          nazev: aresItem.nazev,
          adresa: aresItem.adresa || aresItem.sidlo || '',
          dic: aresItem.dic || '',
          zastoupeny: '',
          kontakt_jmeno: '',
          kontakt_email: '',
          kontakt_telefon: '',
          user_id: targetUserId,
          usek_zkr: targetUsekZkr
        });

        showToast && showToast('Dodavatel byl aktualizovÃ¡n v lokÃ¡lnÃ­ databÃ¡zi', { type: 'success' });

      } catch (updateError) {
        // Pokud aktualizace selÅ¾e (zÃ¡znam neexistuje), vytvoÅ™ novÃ½
        await createSupplier({
          token,
          username,
          nazev: aresItem.nazev,
          adresa: aresItem.adresa || aresItem.sidlo || '',
          ico: aresItem.ico,
          dic: aresItem.dic || '',
          zastoupeny: '',
          kontakt_jmeno: '',
          kontakt_email: '',
          kontakt_telefon: '',
          user_id: targetUserId,
          usek_zkr: targetUsekZkr
        });

        showToast && showToast('Dodavatel byl pÅ™idÃ¡n do lokÃ¡lnÃ­ databÃ¡ze', { type: 'success' });
      }

      // Refresh lokÃ¡lnÃ­ch kontaktÅ¯ po ÃºspÄ›Å¡nÃ©m uloÅ¾enÃ­
      setAllSupplierContacts([]); // VymaÅ¾ cache aby se pÅ™i pÅ™Ã­Å¡tÃ­m otevÅ™enÃ­ naÄetly novÃ© data

    } catch (error) {
      showToast && showToast(`Chyba pÅ™i uklÃ¡dÃ¡nÃ­: ${error.message}`, { type: 'error' });
    } finally {
      setSavingToLocal(null);
    }
  };

  const handleSelectAndSave = async (aresItem) => {
    // NejdÅ™Ã­ve vyplÅˆ formulÃ¡Å™
    handleAresSelect(aresItem);

    // Pak uloÅ¾ do lokÃ¡lnÃ­ DB s vÃ½chozÃ­m umÃ­stÄ›nÃ­m
    const defaultLocation = 'personal'; // VÃ½chozÃ­ je osobnÃ­ kontakt
    await handleSaveToLocal(aresItem, defaultLocation);
  };

  // AutomatickÃ© vyhledÃ¡vÃ¡nÃ­ IÄŒO pÅ™i zmÄ›nÄ› focus
  const handleIcoBlur = (ico) => {
    const trimmedIco = ico?.trim();

    // Auto-save pÅ™i blur
    handleFieldBlur('dodavatel_ico', trimmedIco);

    if (trimmedIco && trimmedIco.length >= 8 && /^\d+$/.test(trimmedIco)) {
      checkSupplierByIco(trimmedIco);
    }
  };

  // Kontrola dodavatele podle IÄŒO (nejdÅ™Ã­ve lokÃ¡lnÃ­ DB, pak ARES)
  const checkSupplierByIco = async (ico) => {
    const trimmedIco = ico?.trim();
    if (!trimmedIco || trimmedIco.length < 8) return;

    setIsIcoOperation(true);
    setIcoCheckStatus('checking');
    setIcoCheckData(null);
    setShowIcoCheck(true);

    try {
      // NejdÅ™Ã­ve zkusÃ­me lokÃ¡lnÃ­ databÃ¡zi
      const localResult = await searchSupplierByIco({
        token: token,
        username: username,
        ico: trimmedIco
      });

      if (localResult?.data && Array.isArray(localResult.data) && localResult.data.length > 0) {
        // Nalezeno v lokÃ¡lnÃ­ databÃ¡zi
        const supplier = localResult.data[0];
        setIcoCheckStatus('found-local');
        setIcoCheckData({
          ...supplier,
          source: 'local'
        });
      } else {
        // NenÃ­ v lokÃ¡lnÃ­ DB, zkusÃ­me ARES
        const aresUrl = `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${trimmedIco}`;
        const aresResponse = await fetch(aresUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (aresResponse.ok) {
          const aresData = await aresResponse.json();
          setIcoCheckStatus('found-ares');
          setIcoCheckData({
            ico: aresData.ico,
            dic: aresData.dic || '',
            nazev: aresData.obchodniJmeno || '',
            adresa: aresData.sidlo?.textovaAdresa || '',
            source: 'ares'
          });
        } else {
          setIcoCheckStatus('not-found');
          setIcoCheckData(null);
        }
      }
    } catch (error) {
      setIcoCheckStatus('not-found');
      setIcoCheckData(null);
    } finally {
      setIsIcoOperation(false);
    }
  };

  // Akce pro IÄŒO dialog - pÅ™idÃ¡nÃ­ do osobnÃ­ch kontaktÅ¯
  const handleIcoUpdate = async () => {
    if (!icoCheckData) return;

    if (icoCheckData.source === 'ares') {
      // Z ARES - pÅ™idÃ¡me do osobnÃ­ch kontaktÅ¯ pod user_id
      try {
        const result = await createSupplier({
          token: token,
          username: username,
          nazev: icoCheckData.nazev,
          ico: icoCheckData.ico,
          dic: icoCheckData.dic || '',
          adresa: icoCheckData.adresa || '',
          zastoupeny: '',
          kontakt_jmeno: '',
          kontakt_email: '',
          kontakt_telefon: '',
          user_id: user_id,
          usek_zkr: '' // OsobnÃ­ kontakt = bez Ãºseku
        });

        if (result?.ok || result?.status === 'ok') {
          showToast && showToast('Dodavatel byl pÅ™idÃ¡n do vaÅ¡ich osobnÃ­ch kontaktÅ¯', { type: 'success' });
        } else {
          throw new Error(result?.message || 'NeznÃ¡mÃ¡ chyba');
        }
      } catch (error) {
        showToast && showToast(`Chyba pÅ™i pÅ™idÃ¡vÃ¡nÃ­ do kontaktÅ¯: ${error.message}`, { type: 'error' });
        return; // NepokraÄujeme s vyplnÄ›nÃ­m
      }
    }

    // VyplnÃ­me formulÃ¡Å™
    handleIcoFillForm();
  };

  const handleIcoFillForm = () => {
    if (!icoCheckData) return;

    setFormData(prev => ({
      ...prev,
      dodavatel_nazev: icoCheckData.nazev || icoCheckData.name || '',
      dodavatel_adresa: icoCheckData.adresa || icoCheckData.address || '',
      dodavatel_ico: icoCheckData.ico || '',
      dodavatel_dic: icoCheckData.dic || '',
      dodavatel_zastoupeny: icoCheckData.zastoupeny || '',
      dodavatel_kontakt_jmeno: icoCheckData.kontakt_jmeno || '',
      dodavatel_kontakt_email: icoCheckData.kontakt_email || '',
      dodavatel_kontakt_telefon: icoCheckData.kontakt_telefon || ''
    }));

    setShowIcoCheck(false);
    setIcoCheckStatus(null);
    setIcoCheckData(null);
    // showToast && showToast('Ãšdaje dodavatele byly vyplnÄ›ny', { type: 'success' }); // OdstranÄ›no - nenÃ­ tÅ™eba
  };

  const handleIcoCancel = () => {
    setShowIcoCheck(false);
    setIcoCheckStatus(null);
    setIcoCheckData(null);
  };

  // ====================== Å ABLONY - POMOCNÃ‰ FUNKCE ======================

  // Kontrola zda Å¡ablona odpovÃ­dÃ¡ vyhledÃ¡vacÃ­mu dotazu
  const matchesTemplateQuery = (entry, query) => {
    if (!query || !query.trim()) return true;
    const normalizedQuery = normalizeText(query);
    const entryName = normalizeText(entry.name || entry.dbName || '');
    const entryPredmet = normalizeText(entry.data?.poApproval?.predmet || '');
    const entryFirstItem = normalizeText(entry.data?.polozky?.[0]?.popis || '');
    return entryName.includes(normalizedQuery) || entryPredmet.includes(normalizedQuery) || entryFirstItem.includes(normalizedQuery);
  };

  // KompaktnÃ­ nÃ¡hled poloÅ¾ek Å¡ablony (pÅ™evzato z OrderFormComponent)
  const compactTemplatePreview = (data) => {
    try {
      const preview = {};
      if (data?.poApproval?.predmet) preview.predmet = data.poApproval.predmet;
      if (data?.poApproval?.max_cena_s_dph) preview.maxCena = data.poApproval.max_cena_s_dph;
      if (data?.orderDetails?.dodavatel_nazev) preview.dodavatel = data.orderDetails.dodavatel_nazev;
      if (Array.isArray(data?.polozky) && data.polozky.length) {
        preview.polozky = data.polozky.length;
        if (data.polozky[0]?.popis) preview.prvniPolozka = data.polozky[0].popis;
      }
      return preview;
    } catch { return {}; }
  };

  // PokroÄilÃ¡ preview funkce pro detailnÃ­ nÃ¡hled Å¡ablony
  const createDetailedTemplatePreview = (template, data) => {
    try {
      const preview = {
        templateInfo: {
          name: template.name || 'Bez nÃ¡zvu',
          type: template.type || 'mixed',
          created: template.ts ? formatDateOnly(new Date(template.ts)) : 'NeznÃ¡mo',
          isGlobal: template.user_id === 0
        },
        poApproval: null,
        orderDetails: null,
        items: []
      };

      // PO Approval sekce
      if (data?.poApproval) {
        const po = data.poApproval;
        preview.poApproval = {
          predmet: po.predmet || '',
          maxCena: po.max_cena_s_dph || '',
          popisPozadavku: po.popis_pozadavku || '',
          strediska: Array.isArray(po.strediska_kod) ? po.strediska_kod : [],
          objednatel: po.objednatel_id || '',
          garant: po.garant_uzivatel_id || '',
          prikazce: po.prikazce_id || ''
        };
      }

      // Order Details sekce
      if (data?.orderDetails) {
        const od = data.orderDetails;
        preview.orderDetails = {
          dodavatelNazev: od.dodavatel_nazev || '',
          dodavatelAdresa: od.dodavatel_adresa || '',
          dodavatelIco: od.dodavatel_ico || '',
          dodavatelDic: od.dodavatel_dic || '',
          zpusobFinancovani: od.zpusob_financovani || '',
          lpKod: od.lp_kod || '',
          druhObjednavky: od.druh_objednavky_kod || '',
          poznamka: od.poznamka || '',
          datumDodani: od.datum_dodani || '',
          fakturovatNa: od.fakturovat_na || '',
          dodaciAdresa: od.dodaci_adresa || ''
        };
      }

      // PoloÅ¾ky
      if (Array.isArray(data?.polozky)) {
        preview.items = data.polozky.map((item, index) => ({
          index: index + 1,
          popis: item.popis || '',
          pocet: item.pocet || 1,
          jednotka: item.jednotka || '',
          cenaJednotka: item.cena_jednotka || 0,
          cenaTotal: (item.pocet || 1) * (item.cena_jednotka || 0)
        }));
      }

      return preview;
    } catch (error) {
      return null;
    }
  };

  // Funkce pro otevÅ™enÃ­ preview modalu
  const showTemplatePreview = (template, data) => {
    const previewData = createDetailedTemplatePreview(template, data);
    if (previewData) {
      setPreviewModalData({ template, data, preview: previewData });
    }
  };

  // Extrakce poloÅ¾ek ze Å¡ablony pro nÃ¡hled
  const extractTemplateItems = (entry) => {
    try {
      const data = entry?.data;
      if (Array.isArray(data?.polozky)) return data.polozky;
      return [];
    } catch { return []; }
  };

  // LogovÃ¡nÃ­ akcÃ­ se Å¡ablonami
  const logTemplateAction = (action, details) => {
    try {
      const logEntry = {
        ts: Date.now(),
        action,
        details: details || {},
        user: username || 'unknown'
      };
      setTemplateActionsLog(prev => [logEntry, ...prev.slice(0, 49)]);
    } catch {}
  };

  const handleInputChange = useCallback((field, value) => {
    // ðŸ” DEBUG: Loguj zmÄ›ny critickÃ½ch polÃ­
    if (field === 'druh_objednavky_kod') {
      // DEBUG: Order type change - logging removed
    }

    // NASTAVIT isChanged = true pÅ™i kaÅ¾dÃ© zmÄ›nÄ›
    setIsChanged(true);

    // ðŸŽ¯ AUTOMATICKÃ AUTOSAVE - aktivovat isDraftLoaded pÅ™i prvnÃ­ zmÄ›nÄ›
    if (!isDraftLoaded) {
      setIsDraftLoaded(true);
    }

    // ðŸŽ¯ SPUSTIT AUTOSAVE s debounce (3 sekundy po poslednÃ­ zmÄ›nÄ›)
    triggerAutosave();

    // Validace pro povinnÃ¡ pole v reÃ¡lnÃ©m Äase
    const criticalFields = [
      'garant_uzivatel_id',
      'prikazce_id',
      'strediska_kod',
      'predmet',
      'max_cena_s_dph',
      'lp_kod',  // ðŸ†• LP kÃ³dy jsou takÃ© povinnÃ© v nÄ›kterÃ½ch fÃ¡zÃ­ch
      'zpusob_financovani',  // ðŸ†• ZpÅ¯sob financovÃ¡nÃ­ je povinnÃ½
      'druh_objednavky_kod'  // ðŸ†• Druh objednÃ¡vky je povinnÃ½
    ];
    if (criticalFields.includes(field)) {
      // Pro stÅ™ediska a LP kÃ³dy kontroluj dÃ©lku pole
      const valueToValidate = (field === 'strediska_kod' || field === 'lp_kod') ? value : value;
      validateField(field, valueToValidate);
    } else {
      // âŒ REMOVED: MazÃ¡nÃ­ chyby - zbyteÄnÃ©
      // Validace probÃ­hÃ¡ POUZE pÅ™i Save, live mazÃ¡nÃ­ chyb nenÃ­ potÅ™eba
    }

    setFormData(prev => {
      let processedValue = value;

      // StÅ™ediska se uklÃ¡dajÃ­ jako pole kÃ³dÅ¯ ve frontend, transformace aÅ¾ pÅ™i uklÃ¡dÃ¡nÃ­ do DB

      const newData = {
        ...prev,
        [field]: processedValue
      };

      // ðŸ”„ PÅ™i zmÄ›nÄ› zpÅ¯sobu financovÃ¡nÃ­ VYÄŒISTIT vÅ¡echny dynamickÃ© hodnoty z pÅ™edchozÃ­ho typu
      // âš ï¸ KRITICKÃ‰: MusÃ­ se vyÄistit VÅ E, aby se do DB i LS uloÅ¾ila jen data pro novÃ½ typ
      if (field === 'zpusob_financovani') {
        // VyÄistit VÅ ECHNY dynamickÃ© fieldy z vÅ¡ech typÅ¯ financovÃ¡nÃ­
        newData.lp_kod = [];
        newData.cislo_smlouvy = '';
        newData.smlouva_poznamka = '';
        newData.individualni_schvaleni = '';
        newData.individualni_poznamka = '';
        newData.pojistna_udalost_cislo = '';
        newData.pojistna_udalost_poznamka = '';
        // Pokladna nemÃ¡ Å¾Ã¡dnÃ© extra fieldy
      }

      // FinancovÃ¡nÃ­ se uklÃ¡dÃ¡ jako kÃ³d ve frontend, transformace aÅ¾ pÅ™i uklÃ¡dÃ¡nÃ­ do DB

      // Funkce pro pÅ™evod na MySQL datetime formÃ¡t
      const toMySQLDateTime = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      };

      // Funkce pro aktuÃ¡lnÃ­ datum ve formÃ¡tu YYYY-MM-DD
      const getCurrentDate = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      // Pokud se mÄ›nÃ­ stav schvÃ¡lenÃ­, nastav pÅ™Ã­sluÅ¡nÃ© Ãºdaje
      // âš ï¸ DÅ®LEÅ½ITÃ‰: stav_workflow_kod se NIKDY NEMÄšNÃ zde - jen pÅ™i uklÃ¡dÃ¡nÃ­ do DB!
      if (field === 'stav_schvaleni') {

        if (value === 'schvaleno' && user_id) {
          // âœ… DÅ®LEÅ½ITÃ‰: schvalovatel_id a dt_schvaleni nastavit POUZE pokud jeÅ¡tÄ› neexistujÃ­
          if (!prev.schvalovatel_id) {
            newData.schvalovatel_id = user_id;
            newData.dt_schvaleni = toMySQLDateTime();
          } else {
            // UÅ¾ existuje - ZACHOVAT pÅ¯vodnÃ­ hodnoty
            newData.schvalovatel_id = prev.schvalovatel_id;
            newData.dt_schvaleni = prev.dt_schvaleni;
          }
          // âœ… PÅ™i schvÃ¡lenÃ­ VYMAZAT komentÃ¡Å™ (schvÃ¡lenÃ­ nepotÅ™ebuje zdÅ¯vodnÄ›nÃ­)
          newData.schvaleni_komentar = '';
          // stav_workflow_kod se zmÄ›nÃ­ aÅ¾ pÅ™i uloÅ¾enÃ­ v backendu
        }
        else if (value === 'neschvaleno') {
          // âœ… DÅ®LEÅ½ITÃ‰: schvalovatel_id a dt_schvaleni nastavit POUZE pokud jeÅ¡tÄ› neexistujÃ­
          if (!prev.schvalovatel_id) {
            newData.schvalovatel_id = user_id;
            newData.dt_schvaleni = toMySQLDateTime();
          } else {
            // UÅ¾ existuje - ZACHOVAT pÅ¯vodnÃ­ hodnoty
            newData.schvalovatel_id = prev.schvalovatel_id;
            newData.dt_schvaleni = prev.dt_schvaleni;
          }
          // KomentÃ¡Å™ ZÅ®STÃVÃ (dÅ¯vod zamÃ­tnutÃ­ je povinnÃ½)
          // stav_workflow_kod se zmÄ›nÃ­ aÅ¾ pÅ™i uloÅ¾enÃ­ v backendu
        }
        else if (value === 'ceka_se') {
          // âœ… DÅ®LEÅ½ITÃ‰: schvalovatel_id a dt_schvaleni nastavit POUZE pokud jeÅ¡tÄ› neexistujÃ­
          if (!prev.schvalovatel_id) {
            newData.schvalovatel_id = user_id;
            newData.dt_schvaleni = toMySQLDateTime();
          } else {
            // UÅ¾ existuje - ZACHOVAT pÅ¯vodnÃ­ hodnoty
            newData.schvalovatel_id = prev.schvalovatel_id;
            newData.dt_schvaleni = prev.dt_schvaleni;
          }
          // KomentÃ¡Å™ ZÅ®STÃVÃ (dÅ¯vod vrÃ¡cenÃ­ je povinnÃ½)
          // stav_workflow_kod se zmÄ›nÃ­ aÅ¾ pÅ™i uloÅ¾enÃ­ v backendu
        }
        else if (value === '') {
          // Reset pÅ™i zruÅ¡enÃ­ vÃ½bÄ›ru - Å¾Ã¡dnÃ© radio nenÃ­ zaÅ¡krtnutÃ©
          newData.schvalovatel_id = '';
          newData.dt_schvaleni = '';
          // âš ï¸ NESMÃME mÄ›nit stav_workflow_kod! Ten se mÄ›nÃ­ jen v DB pÅ™i uloÅ¾enÃ­!
          // Viditelnost bloku schvÃ¡lenÃ­ zÃ¡visÃ­ POUZE na stavu z DB, ne na checkboxu!
        }
      }

      // Pokud se mÄ›nÃ­ stav odeslÃ¡nÃ­, automaticky nastav datum
      if (field === 'stav_odeslano') {
        if (value === true && !prev.datum_odeslani) {
          // PÅ™i zaÅ¡krtnutÃ­ "OdeslÃ¡no" automaticky vyplÅˆ aktuÃ¡lnÃ­ datum, pokud nenÃ­ vyplnÄ›no
          newData.datum_odeslani = getCurrentDate();

          // âš ï¸ WORKFLOW se NEMÄšNÃ pÅ™i zaÅ¡krtnutÃ­ checkboxu!
          // ZmÄ›nÃ­ se aÅ¾ pÅ™i ULOÅ½ENÃ formulÃ¡Å™e (handleSave)
          addDebugLog('info', 'WORKFLOW', 'odeslano-checked', `Checkbox OdeslÃ¡no zaÅ¡krtnut - workflow se zmÄ›nÃ­ aÅ¾ pÅ™i uloÅ¾enÃ­`);

        } else if (value === false) {
          // PÅ™i zruÅ¡enÃ­ zaÅ¡krtnutÃ­ vymaÅ¾ datum odeslÃ¡nÃ­
          newData.datum_odeslani = '';

          // âš ï¸ WORKFLOW se NEMÄšNÃ pÅ™i zruÅ¡enÃ­ zaÅ¡krtnutÃ­!
          // ZmÄ›nÃ­ se aÅ¾ pÅ™i ULOÅ½ENÃ formulÃ¡Å™e (handleSave)
          addDebugLog('info', 'WORKFLOW', 'odeslano-unchecked', `Checkbox OdeslÃ¡no odÅ¡krtnut - workflow se zmÄ›nÃ­ aÅ¾ pÅ™i uloÅ¾enÃ­`);

          // KRITICKÃ KONTROLA: NIKDY nevolat clearPhase2UnlockState pokud je objednÃ¡vka ODESLANÃ/ZRUÅ ENÃ
          const currentWorkflowState = prev.stav_workflow_kod || 'NOVA';
          const hasOdeslano = hasWorkflowState(currentWorkflowState, 'ODESLANA');
          const hasZruseno = hasWorkflowState(currentWorkflowState, 'ZRUSENA');

          // Pokud je objednÃ¡vka ODESLANÃ/ZRUÅ ENÃ - NIKDY NEÄŒISTIT zamÄenÃ­
          if (hasOdeslano || hasZruseno || prev.stav_stornovano) {
            addDebugLog('warning', 'PHASE2-UNLOCK', 'clear-blocked-final', `BLOKACE clearPhase2UnlockState - objednÃ¡vka je ODESLANÃ/ZRUÅ ENÃ (workflow=${currentWorkflowState})`);
          } else {
            // Pouze pro objednÃ¡vky kterÃ© NEJSOU odeslanÃ¡/zruÅ¡enÃ¡
            addDebugLog('info', 'PHASE2-UNLOCK', 'clear-allowed', `ÄŒiÅ¡tÄ›nÃ­ Phase 2 unlock povoleno - objednÃ¡vka nenÃ­ v zamÄenÃ©m stavu`);
            clearPhase2UnlockState();
          }
        }
      }

      // Pokud se mÄ›nÃ­ stav stornovÃ¡nÃ­, automaticky nastav datum
      if (field === 'stav_stornovano') {
        if (value === true && !prev.datum_storna) {
          // PÅ™i zaÅ¡krtnutÃ­ "StornovÃ¡no" automaticky vyplÅˆ aktuÃ¡lnÃ­ datum, pokud nenÃ­ vyplnÄ›no
          newData.datum_storna = getCurrentDate();

          // PÅ™idat ID pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele do storno dat (pro DB)
          if (user_id && !prev.storno_uzivatel_id) {
            newData.storno_uzivatel_id = user_id;
          }

          // PÅ™idat jmÃ©no pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele do storno dat (pro zobrazenÃ­)
          if (userDetail && !prev.storno_provedl) {
            const jmeno = `${userDetail.titul_pred ? userDetail.titul_pred + ' ' : ''}${userDetail.jmeno || ''} ${userDetail.prijmeni || ''}${userDetail.titul_za ? ', ' + userDetail.titul_za : ''}`.replace(/\s+/g, ' ').trim();
            newData.storno_provedl = jmeno;
          }
        } else if (value === false) {
          // PÅ™i zruÅ¡enÃ­ zaÅ¡krtnutÃ­ vymaÅ¾ datum storna a souvisejÃ­cÃ­ data
          newData.datum_storna = '';
          newData.storno_uzivatel_id = '';
          newData.storno_provedl = '';
          newData.odeslani_storno_duvod = '';

          // KRITICKÃ KONTROLA: NIKDY nevolat clearPhase2UnlockState pokud je objednÃ¡vka ODESLANÃ/ZRUÅ ENÃ
          const currentWorkflowState = prev.stav_workflow_kod || 'NOVA';
          const hasOdeslano = hasWorkflowState(currentWorkflowState, 'ODESLANA');
          const hasZruseno = hasWorkflowState(currentWorkflowState, 'ZRUSENA');

          // Pokud je objednÃ¡vka ODESLANÃ/ZRUÅ ENÃ - NIKDY NEÄŒISTIT zamÄenÃ­
          if (hasOdeslano || hasZruseno) {
            addDebugLog('warning', 'PHASE2-UNLOCK', 'clear-blocked-storno-final', `BLOKACE clearPhase2UnlockState pÅ™i storno zmÄ›nÄ› - objednÃ¡vka je ODESLANÃ/ZRUÅ ENÃ (workflow=${currentWorkflowState})`);
          } else {
            // Pouze pro objednÃ¡vky kterÃ© NEJSOU odeslanÃ¡/zruÅ¡enÃ¡
            addDebugLog('info', 'PHASE2-UNLOCK', 'clear-allowed-storno', `ÄŒiÅ¡tÄ›nÃ­ Phase 2 unlock po storno zmÄ›nÄ› povoleno - objednÃ¡vka nenÃ­ v zamÄenÃ©m stavu`);
            clearPhase2UnlockState();
          }
        }
      }

      // ðŸ†• FÃZE 7: Checkbox vÄ›cnÃ© sprÃ¡vnosti
      // DÅ®LEÅ½ITÃ‰: Nastavit ID a timestamp IHNED po zaÅ¡krtnutÃ­, aby byly dostupnÃ© pro autosave!
      if (field === 'potvrzeni_vecne_spravnosti') {
        if (value === 1 || value === true) {
          // PÅ™i zaÅ¡krtnutÃ­ checkboxu VÅ½DY nastav potvrzujÃ­cÃ­ho uÅ¾ivatele a Äas
          if (user_id && !prev.potvrdil_vecnou_spravnost_id) {
            // âœ… OPRAVA: PouÅ¾Ã­t lokÃ¡lnÃ­ Äas mÃ­sto UTC (.toISOString())
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const localTimestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            // Nastavit ID a timestamp pouze pÅ™i prvnÃ­m zaÅ¡krtnutÃ­ (pokud jeÅ¡tÄ› nejsou)
            newData.potvrdil_vecnou_spravnost_id = user_id;
            newData.dt_potvrzeni_vecne_spravnosti = localTimestamp;
            addDebugLog('info', 'VECNA-SPRAVNOST', 'checkbox-set', `Automaticky nastaveno: potvrdil_vecnou_spravnost_id=${user_id}, dt=${newData.dt_potvrzeni_vecne_spravnosti}, checkbox_value=${value}`);
          } else if (!user_id) {
            addDebugLog('error', 'VECNA-SPRAVNOST', 'no-user-id', 'user_id nenÃ­ definovÃ¡no - nemÅ¯Å¾u nastavit potvrdil_vecnou_spravnost_id');
          } else {
            addDebugLog('info', 'VECNA-SPRAVNOST', 'checkbox-already-set', `ID uÅ¾ je nastaveno: ${prev.potvrdil_vecnou_spravnost_id}`);
          }
        } else if (value === 0 || value === false) {
          // PÅ™i odÅ¡krtnutÃ­ checkboxu NEMAZAT ID a Äas - nechÅ¥ zÅ¯stanou pro historii
          addDebugLog('info', 'VECNA-SPRAVNOST', 'checkbox-unset', 'Checkbox odÅ¡krtnut - ID a datum zÅ¯stÃ¡vajÃ­ zachovÃ¡ny');
        }
      }

      // ðŸ†• FÃZE 8: Pokud se mÄ›nÃ­ checkbox dokonÄenÃ­ objednÃ¡vky, automaticky nastav ID a timestamp
      if (field === 'potvrzeni_dokonceni_objednavky') {
        if (value === 1 || value === true) {
          // âœ… OPRAVA: PouÅ¾Ã­t lokÃ¡lnÃ­ Äas mÃ­sto UTC (.toISOString())
          if (user_id) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const localTimestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            
            newData.dokoncil_id = user_id;
            newData.dt_dokonceni = localTimestamp;
          } else {
            addDebugLog('error', 'DOKONCENI', 'no-user-id', 'user_id nenÃ­ definovÃ¡no');
          }
        } else if (value === 0 || value === false) {
          // PÅ™i odÅ¡krtnutÃ­ checkboxu vymaÅ¾ ID a Äas
          newData.dokoncil_id = null;
          newData.dt_dokonceni = null;
        }
      }

      return newData;
    });

    // ðŸŽ¯ NOVÃ AUTOSAVE SYSTÃ‰M:
    // Pro SELECT/CHECKBOX pole - spusÅ¥ autosave OKAMÅ½ITÄš (s debouncem proti opakovanÃ©mu volÃ¡nÃ­)
    // Pro textovÃ¡ pole - autosave se spustÃ­ pÅ™i onBlur v handleFieldBlur
    // POZNÃMKA: potvrzeni_vecne_spravnosti a textovÃ¡ pole vÄ›cnÃ© sprÃ¡vnosti se NEUKLÃDAJÃ automaticky
    // - uÅ¾ivatel musÃ­ kliknout na Save button, aby se uloÅ¾ily sprÃ¡vnÄ› vÄetnÄ› vÅ¡ech dat
    // POZNÃMKA 2: potvrzeni_dokonceni_objednavky a dokonceni_poznamka se TAKÃ‰ NEUKLÃDAJÃ automaticky
    // - stejnÃ¡ logika jako FÃ¡ze 7 - uloÅ¾enÃ­ aÅ¾ pÅ™i Save button
    const selectFields = [
      'garant_uzivatel_id',
      'prikazce_id',
      'strediska_kod',
      'zpusob_financovani',
      'lp_kod',
      'druh_objednavky_kod',
      'stav_schvaleni',
      'stav_odeslano',
      'stav_stornovano',
      // 'potvrzeni_vecne_spravnosti',         // ðŸš« FÃZE 7: VYPNUTO - uloÅ¾enÃ­ aÅ¾ pÅ™i Save button
      // 'potvrzeni_dokonceni_objednavky'      // ðŸš« FÃZE 8: VYPNUTO - uloÅ¾enÃ­ aÅ¾ pÅ™i Save button (stejnÄ› jako FÃ¡ze 7)
    ];

    if (selectFields.includes(field)) {
      // SELECT/CHECKBOX - autosave okamÅ¾itÄ› (s min. intervalem 1s)
      if (!disableAutosaveRef.current && draftManager.isAutosaveEnabled() && !isSaving && !showSaveProgress && isDraftLoaded) {
        triggerAutosave(true); // true = immediate (s min intervalem)
      }
    }
    // Pro textovÃ¡ pole se autosave spustÃ­ v handleFieldBlur (s debouncem 3s)
  }, [validationErrors, formData, user_id, disableAutosaveRef, draftManager, isSaving, showSaveProgress, isDraftLoaded, triggerAutosave, setIsDraftLoaded]);

  // SpeciÃ¡lnÃ­ handler pro radio buttony - umoÅ¾Åˆuje zruÅ¡it vÃ½bÄ›r opakovanÃ½m kliknutÃ­m
  const handleRadioClick = useCallback((value) => {
    if (formData.stav_schvaleni === value) {
      // OpakovanÃ© kliknutÃ­ na stejnÃ½ radio - zruÅ¡ vÃ½bÄ›r
      handleInputChange('stav_schvaleni', '');
      // Vynuluj i komentÃ¡Å™ pÅ™i zruÅ¡enÃ­ vÃ½bÄ›ru
      handleInputChange('schvaleni_komentar', '');
      // Vynuluj i schvalovatele pÅ™i zruÅ¡enÃ­
      handleInputChange('schvalovatel_id', '');
    } else {
      // NormÃ¡lnÃ­ vÃ½bÄ›r
      handleInputChange('stav_schvaleni', value);

      // âœ… AUTOMATICKY nastavit schvalovatele na aktuÃ¡lnÄ› pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele
      // kdyÅ¾ vybere "SchvÃ¡leno", "NeschvÃ¡leno" nebo "ÄŒekÃ¡ se"
      if (user_id && (value === 'schvaleno' || value === 'neschvaleno' || value === 'ceka_se')) {
        handleInputChange('schvalovatel_id', user_id);
      }
    }

    // ðŸŽ¯ Radio button - autosave okamÅ¾itÄ›
    if (!disableAutosaveRef.current && draftManager.isAutosaveEnabled() && !isSaving && !showSaveProgress && isDraftLoaded) {
      triggerAutosave(true); // true = immediate
    }
  }, [formData.stav_schvaleni, user_id, disableAutosaveRef, draftManager, isSaving, showSaveProgress, isDraftLoaded]);

  // Handler pro uloÅ¾enÃ­ aktuÃ¡lnÃ­ho formulÃ¡Å™e jako Å¡ablonu
  const handleSaveAsTemplate = useCallback(() => {
    setShowTemplateSaveModal(true);
    setSaveMode('new');
    setSelectedTargetTemplate(null);
    setTemplateName('');
    setTemplateType('po');
  }, []);

  // Handler pro toggle sbalenÃ­/rozbalenÃ­ sekcÃ­
  const handleToggleSections = useCallback(() => {
    if (areSectionsCollapsed) {
      // ðŸ”“ EXPAND ALL - Rozbalit vÅ¡echny sekce
      setSectionStates(prev => {
        const newStates = { ...prev };
        Object.keys(newStates).forEach(key => {
          newStates[key] = false; // false = expanded
        });
        return newStates;
      });
      setAreSectionsCollapsed(false);
    } else {
      // ðŸ”’ COLLAPSE ALL - Sbalit POUZE zamÄenÃ© sekce
      setSectionStates(prev => {
        const newStates = { ...prev };

        // âœ… NOVÃ‰: PouÅ¾Ã­t allSectionStates pÅ™Ã­mo - obsahuje uÅ¾ unlock states z workflowManager
        const lockedSections = [];
        Object.keys(newStates).forEach(sectionKey => {
          // âš ï¸ VÃJIMKA: Sekci "registr_smluv" NIKDY nesbalovat automaticky
          // DÅ¯vod: I kdyÅ¾ je zamÄenÃ¡ (read-only), musÃ­ zÅ¯stat viditelnÃ¡ pro bÄ›Å¾nÃ©ho uÅ¾ivatele,
          // aby mohl vidÄ›t a pÅ™Ã­padnÄ› potvrdit checkbox "MÃ¡ bÃ½t zveÅ™ejnÄ›na v registru"
          if (sectionKey === 'registr_smluv') {
            return; // PÅ™eskoÄ tuto sekci - zÅ¯stane v aktuÃ¡lnÃ­m stavu
          }

          // âœ… PouÅ¾Ã­t allSectionStates - workflowManager uÅ¾ zahrnuje unlock states
          const sectionState = allSectionStates[sectionKey];
          const isLocked = sectionState && !sectionState.enabled;

          if (isLocked) {
            newStates[sectionKey] = true; // true = collapsed (sbalit zamÄenÃ©)
            lockedSections.push(sectionKey);
          }
        });

        // ðŸ”’ [SECTION LOCK] LogovÃ¡nÃ­ zamÄenÃ½ch sekcÃ­
        if (lockedSections.length > 0) {
        }

        return newStates;
      });
      setAreSectionsCollapsed(true);
    }
  }, [
    areSectionsCollapsed,
    allSectionStates, // âœ… NOVÃ‰: jedinÃ¡ zÃ¡vislost - obsahuje vÅ¡echny section states vÄetnÄ› unlock
    workflowManager
  ]);

  // ðŸŽ¯ SCROLL K SEKCI - umoÅ¾Åˆuje scrollovÃ¡nÃ­ i k zamÄenÃ½m sekcÃ­m pro ÄtenÃ­ dat
  const scrollToSection = useCallback((sectionKey, behavior = 'smooth') => {
    // âœ… ScrollovÃ¡nÃ­ funguje i pro zamÄenÃ© sekce - uÅ¾ivatel mÅ¯Å¾e ÄÃ­st jiÅ¾ vyplnÄ›nÃ¡ data

    // Najdi element sekce pomocÃ­ data-section atributu
    const scrollContainer = scrollableContentRef.current;
    if (!scrollContainer) {
      return false;
    }

    const sectionElement = scrollContainer.querySelector(`[data-section="${sectionKey}"]`);
    if (!sectionElement) {
      return false;
    }

    // ðŸŽ¯ SPRÃVNÃ‰ Å˜EÅ ENÃ: Scroll na Å¾lutÃ½ roh + vÃ½Å¡ka titulku
    try {
      // CÃLOVKA: Zobrazit Å¾lutÃ½ roh sekce + titulek nad nÃ­m
      // Struktura sekce:
      // - FormSection (obsahuje data-section atribut) <- sectionElement
      //   - SectionHeader (Å¾lutÃ© pozadÃ­ s titulkem) <- tohle chceme vidÄ›t celÃ©
      //   - SectionBody (obsah)
      //
      // scrollIntoView() na FormSection by zobrazil jen zaÄÃ¡tek FormSection
      // PotÅ™ebujeme scrollovat o vÃ½Å¡ku SectionHeader vÃ½Å¡

      // Najdi SectionHeader uvnitÅ™ sekce
      const sectionHeader = sectionElement.querySelector('[class*="SectionHeader"]') ||
                           sectionElement.querySelector('div:first-child');

      const targetElement = sectionHeader || sectionElement;

      // VypoÄÃ­tej pozici elementu relativnÄ› k scroll containeru
      const elementTop = targetElement.offsetTop;

      // ðŸ“ DynamickÃ½ offset: pÅ™eÄti CSS variable --fixed-header-height (vÃ½Å¡ka headeru + 20px gap)
      const fixedHeaderHeight = parseInt(
        getComputedStyle(document.documentElement).getPropertyValue('--fixed-header-height') || '200'
      );

      // OdeÄti dynamickou vÃ½Å¡ku headeru pro sprÃ¡vnÃ© zobrazenÃ­ pod FixedHeader
      const targetScrollTop = elementTop - fixedHeaderHeight;

      // Smooth scroll
      if (behavior === 'smooth') {
        scrollContainer.scrollTo({
          top: targetScrollTop,
          behavior: 'smooth'
        });
      } else {
        scrollContainer.scrollTop = targetScrollTop;
      }

      return true;
    } catch (error) {
      return false;
    }
  }, [
    allSectionStates, // âœ… NOVÃ‰: jedinÃ¡ zÃ¡vislost - obsahuje vÅ¡echny section states vÄetnÄ› unlock
    canEditApprovedSections,
    workflowManager,
    showToast
  ]);

  // ðŸ§­ Handler pro kliknutÃ­ na sekci v FloatingNavigator
  const handleNavigatorSectionClick = useCallback((sectionId) => {
    // âœ… VÄšCNÃ SPRÃVNOST: Scrolluj na FAKTURACE (vÄ›cnÃ¡ sprÃ¡vnost je per-invoice v rÃ¡mci faktur)
    const targetSection = sectionId === 'vecna_spravnost' ? 'fakturace' : sectionId;
    scrollToSection(targetSection, 'smooth');
  }, [scrollToSection]);

  // ðŸ“Ž Handler pro drop souborÅ¯ z FloatingNavigator
  const handleNavigatorFilesDrop = useCallback((files) => {
    if (files && files.length > 0) {
      handleFileUpload(files);
      showToast && showToast(`ðŸ“Ž NahrÃ¡vÃ¡m ${files.length} soubor(Å¯)...`, { type: 'info' });
    }
  }, [handleFileUpload, showToast]);

  const handleReloadFromDB = useCallback(async () => {
    if (!formData.id) {
      showToast && showToast('Nelze naÄÃ­st stav z databÃ¡ze - objednÃ¡vka nenÃ­ uloÅ¾ena', { type: 'error' });
      return;
    }

    if (!userDetail?.id) {
      showToast && showToast('Nelze naÄÃ­st stav z databÃ¡ze - nenÃ­ pÅ™ihlÃ¡Å¡en uÅ¾ivatel', { type: 'error' });
      return;
    }

    try {
      addDebugLog('info', 'STATUS-RELOAD', 'start', `NaÄÃ­tÃ¡m aktuÃ¡lnÃ­ stav objednÃ¡vky ID: ${formData.id}, uÅ¾ivatel: ${userDetail.id}`);

      // âœ… V2 API: GET order by ID (enriched=false pro rychlejÅ¡Ã­ reload)
      const orderData = await getOrderV2(parseInt(formData.id), token, username, false);

      if (!orderData || !orderData.id) {
        throw new Error('NepodaÅ™ilo se naÄÃ­st stav objednÃ¡vky z databÃ¡ze');
      }

      addDebugLog('success', 'STATUS-RELOAD', 'loaded', `NaÄten aktuÃ¡lnÃ­ stav: stav_objednavky="${orderData.stav_objednavky}", stav_workflow_kod="${orderData.stav_workflow_kod}"`);

      // Aktualizuj POUZE workflow stavy v formData
      setFormData(prev => ({
        ...prev,
        stav_workflow_kod: orderData.stav_workflow_kod,
        stav_objednavky: orderData.stav_objednavky
      }));

      // UloÅ¾it aktualizovanÃ½ stav do konceptu
      const updatedFormData = {
        ...formData,
        stav_workflow_kod: orderData.stav_workflow_kod,
        stav_objednavky: orderData.stav_objednavky
      };

      saveDraft(updatedFormData, {
        isOrderSavedToDB: true,
        savedOrderId: formData.id,
        isChanged: isChanged
      });

      // Toast odstranÄ›n - zbyteÄnÃ½ Å¡um, stav se aktualizuje automaticky

      addDebugLog('success', 'STATUS-RELOAD', 'complete', 'Stav aktualizovÃ¡n a uloÅ¾en do konceptu');

    } catch (error) {
      addDebugLog('error', 'STATUS-RELOAD', 'failed', error.message);
      showToast && showToast(`Chyba pÅ™i naÄÃ­tÃ¡nÃ­ stavu z databÃ¡ze: ${error.message}`, { type: 'error' });
    }
  }, [formData, userDetail, token, username, showToast, isChanged]);

  // ðŸ“„ Helper pro kontrolu, zda je moÅ¾nÃ© generovat DOCX
  const canGenerateDocx = useCallback(() => {
    // Kontrola: objednÃ¡vka musÃ­ bÃ½t uloÅ¾ena v DB
    if (!formData.id) {
      return false;
    }

    // Kontrola: minimÃ¡lnÄ› fÃ¡ze 3 (schvÃ¡lenÃ¡ + rozpracovanÃ¡ nebo vyÅ¡Å¡Ã­)
    if (currentPhase < 3) {
      return false;
    }

    // Kontrola: stav workflow musÃ­ bÃ½t alespoÅˆ "ROZPRACOVANA" nebo vyÅ¡Å¡Ã­
    // PouÅ¾ij workflowManager.hasWorkflowState() pro sprÃ¡vnou kontrolu
    const hasRozpracovana = hasWorkflowState(formData.stav_workflow_kod, 'ROZPRACOVANA');
    const hasOdeslana = hasWorkflowState(formData.stav_workflow_kod, 'ODESLANA');
    const hasPotvrzena = hasWorkflowState(formData.stav_workflow_kod, 'POTVRZENA');
    const hasSchvalena = hasWorkflowState(formData.stav_workflow_kod, 'SCHVALENA');

    // MusÃ­ mÃ­t SCHVALENA A (ROZPRACOVANA nebo vyÅ¡Å¡Ã­ stav)
    if (!hasSchvalena) {
      return false;
    }

    if (!hasRozpracovana && !hasOdeslana && !hasPotvrzena) {
      return false;
    }

    return true;
  }, [formData.id, formData.stav_workflow_kod, currentPhase, hasWorkflowState, mainWorkflowState]);

  // ðŸ“„ Handler pro generovÃ¡nÃ­ DOCX dokumentu
  const handleGenerateDocx = useCallback(() => {
    if (!canGenerateDocx()) {
      // Zobraz specifickou chybu podle toho, co chybÃ­
      if (!formData.id) {
        showToast && showToast('DOCX lze generovat pouze u uloÅ¾enÃ½ch objednÃ¡vek', { type: 'warning' });
      } else if (currentPhase < 3) {
        showToast && showToast('DOCX lze generovat aÅ¾ od fÃ¡ze "OdesÃ­lÃ¡nÃ­ objednÃ¡vky"', { type: 'warning' });
      } else {
        showToast && showToast('DOCX lze generovat aÅ¾ kdyÅ¾ je objednÃ¡vka v procesu zpracovÃ¡nÃ­', { type: 'warning' });
      }
      return;
    }

    try {
      addDebugLog('info', 'DOCX-GENERATOR', 'open-dialog', `OtevÃ­rÃ¡m DOCX generÃ¡tor pro objednÃ¡vku ID: ${formData.id}`);

      // VytvoÅ™ order objekt kompatibilnÃ­ s DocxGeneratorModal
      const orderForDocx = {
        objednavka_id: formData.id,
        cislo_objednavky: formData.cislo_objednavky,
        nazev_objednavky: formData.nazev_objednavky || formData.nazev,
        ...formData
      };

      setDocxModalOrder(orderForDocx);
      setDocxModalOpen(true);

    } catch (error) {
      addDebugLog('error', 'DOCX-GENERATOR', 'error', error.message);
      showToast && showToast(`Chyba pÅ™i otevÃ­rÃ¡nÃ­ DOCX generÃ¡toru: ${error.message}`, { type: 'error' });
    }
  }, [formData, currentPhase, showToast]);

  const handleDocxModalClose = useCallback(() => {
    setDocxModalOpen(false);
    setDocxModalOrder(null);
  }, []);

  const handleCancelOrder = useCallback(async () => {
    // ðŸŽ¯ Pokud je objednÃ¡vka DOKONÄŒENA, zavÅ™i rovnou bez dotazu
    // (uÅ¾ je uloÅ¾enÃ¡ v DB, nenÃ­ co ztratit)
    if (isOrderCompleted) {
      try {
        // ðŸš¨ðŸš¨ðŸš¨ KRITICKÃ‰: OKAMÅ½ITÄš ZABLOKOVAT VÅ ECHNY SAVE OPERACE ðŸš¨ðŸš¨ðŸš¨
        
        // 0. GLOBÃLNÃ FLAG - zablokuje saveDraft na Ãºrovni funkce (prvnÃ­ linie obrany)
        isClosingRef.current = true;
        
        // 1. Zablokovat autosave v DraftManager
        draftManager.setAutosaveEnabled(false, 'Closing completed order');
        
        // 2. Zablokovat autosave pÅ™es ref (okamÅ¾itÃ¡ kontrola)
        disableAutosaveRef.current = true;
        
        // 3. Zablokovat autosave pÅ™es state (pro useEffect)
        setDisableAutosave(true);
        
        // 4. ZruÅ¡it useAutosave hook timer
        if (cancelAutosave) {
          cancelAutosave();
        }
        
        // 5. ZruÅ¡it vÅ¡echny setTimeout pro autosave
        if (autoSaveTimerRef.current) {
          clearTimeout(autoSaveTimerRef.current);
          autoSaveTimerRef.current = null;
        }

        // VyÄistit draft data
        if (user_id) {
          draftManager.setCurrentUser(user_id);
          await draftManager.deleteAllDraftKeys();
        }
        
        // ðŸ§¹ KRITICKÃ‰: Vymazat VÅ ECHNY orderID z localStorage
        localStorage.removeItem('activeOrderEditId');
        
        // ðŸ§¹ VyÄistit i starÃ© formÃ¡ty (pro jistotu)
        if (user_id) {
          localStorage.removeItem(`order_form_savedOrderId_${user_id}`);
          localStorage.removeItem(`savedOrderId-${user_id}`);
          localStorage.removeItem(`highlightOrderId-${user_id}`);
        }
        
        // ðŸ§¹ Resetovat vÅ¡echny state promÄ›nnÃ© souvisejÃ­cÃ­ s orderID
        setSavedOrderId(null);
        setSourceOrderIdForUnlock(null);

        // Odemkni objednÃ¡vku (pokud je editace)
        const unlockOrderId = sourceOrderIdForUnlock || savedOrderId;
        if (unlockOrderId && token && username) {
          try {
            await unlockOrder25({ token, username, orderId: unlockOrderId });
            // ðŸ”’ KRITICKÃ‰: ZabrÃ¡nit duplicitnÃ­mu unlock z useEffect cleanup
            unlockOrderIdRef.current = null;
          } catch (error) {
            // Ignoruj chybu odemykÃ¡nÃ­
          }
        }

        // Broadcast zmÄ›nu stavu
        try {
          broadcastDraftDeleted(user_id);
          window.dispatchEvent(new CustomEvent('orderDraftChange', {
            detail: {
              hasDraft: false,
              isEditMode: false,
              orderId: null,
              orderNumber: '',
              isLoading: false
            }
          }));
        } catch (e) {
          // Ignoruj chybu broadcastu
        }

        // PÅ™esmÄ›ruj na seznam s force reload z DB
        navigate('/orders25-list', { state: { forceReload: true } });
      } catch (error) {
        showToast && showToast(`Chyba pÅ™i zavÃ­rÃ¡nÃ­: ${error.message}`, { type: 'error' });
      }
      return;
    }

    // Zkontroluj neuloÅ¾enÃ© a neklasifikovanÃ© pÅ™Ã­lohy
    const unsavedAttachments = attachments.filter(att =>
      !att.serverId && att.status !== 'uploaded' && !att.fromServer && att.file
    );
    const unclassifiedAttachments = attachments.filter(att =>
      !att.klasifikace || att.klasifikace.trim() === ''
    );

    let warningMessage = 'Koncept bude zruÅ¡en a neuloÅ¾enÃ© zmÄ›ny nebudou uloÅ¾eny.';

    if (unsavedAttachments.length > 0 || unclassifiedAttachments.length > 0) {
      warningMessage += `\n\nâ„¹ï¸ Informace o pÅ™Ã­lohÃ¡ch:\nâ€¢ ${unsavedAttachments.length} neuloÅ¾enÃ½ch pÅ™Ã­loh\nâ€¢ ${unclassifiedAttachments.length} neklasifikovanÃ½ch pÅ™Ã­loh`;
    }

    // Zobraz confirm modal mÃ­sto toast
    setCancelWarningMessage(warningMessage);
    setShowCancelConfirmModal(true);
  }, [attachments, isOrderCompleted, user_id, sourceOrderIdForUnlock, savedOrderId, token, username, showToast, navigate]);

  const handleCancelConfirm = useCallback(async () => {
    // ðŸŽ¯ ZJEDNODUÅ ENÃ‰ ZAVÅ˜ENÃ pÅ™es DraftManager
    addDebugLog('info', 'CANCEL', 'draftmanager-close', 'ZavÃ­rÃ¡m formulÃ¡Å™ pÅ™es DraftManager');
    
    // ðŸ§¹ KRITICKÃ‰: Vymazat VÅ ECHNY orderID z localStorage
    localStorage.removeItem('activeOrderEditId');
    
    // ðŸ§¹ VyÄistit i starÃ© formÃ¡ty (pro jistotu)
    if (user_id) {
      localStorage.removeItem(`order_form_savedOrderId_${user_id}`);
      localStorage.removeItem(`savedOrderId-${user_id}`);
      localStorage.removeItem(`highlightOrderId-${user_id}`);
    }

    try {
      // ðŸš¨ðŸš¨ðŸš¨ KRITICKÃ‰: OKAMÅ½ITÄš ZABLOKOVAT VÅ ECHNY SAVE OPERACE ðŸš¨ðŸš¨ðŸš¨
      
      // 0. GLOBÃLNÃ FLAG - zablokuje saveDraft na Ãºrovni funkce (prvnÃ­ linie obrany)
      isClosingRef.current = true;
      
      // 1. Zablokovat autosave v DraftManager
      draftManager.setAutosaveEnabled(false, 'Form closing - prevent save during cleanup');
      
      // 2. Zablokovat autosave pÅ™es ref (okamÅ¾itÃ¡ kontrola)
      disableAutosaveRef.current = true;
      
      // 3. Zablokovat autosave pÅ™es state (pro useEffect)
      setDisableAutosave(true);
      
      // 4. ZruÅ¡it useAutosave hook timer
      if (cancelAutosave) {
        cancelAutosave();
      }
      
      // 5. ZruÅ¡it vÅ¡echny setTimeout pro autosave
      if (autoSaveTimerRef.current) {
        clearTimeout(autoSaveTimerRef.current);
        autoSaveTimerRef.current = null;
      }

      // ðŸš¨ OKAMÅ½ITÄš resetovat vÅ¡echny saving stavy
      setIsSaving(false);
      setShowSaveProgress(false);
      setSaveProgressText('');
      setSaveProgress(0);
      setIsConceptSaved(false);

      // ðŸš¨ ZruÅ¡it aktivnÃ­ progress (pokud bÄ›Å¾Ã­)
      if (window._activeProgressControl) {
        window._activeProgressControl.cancel();
        window._activeProgressControl = null;
      }

      // ðŸš¨ Nastavit flag pro unmount - zabrÃ¡nÃ­me duplicitnÃ­mu unlock
      unlockOrderIdRef.current = null;
      
      // ðŸ§¹ Resetovat vÅ¡echny state promÄ›nnÃ© souvisejÃ­cÃ­ s orderID
      setSavedOrderId(null);
      setSourceOrderIdForUnlock(null);

      // ðŸŽ¯ 1. VyÄistit VÅ ECHNY draft data pÅ™es DraftManager (centralizovanÄ›)
      if (user_id) {
        draftManager.setCurrentUser(user_id);
        const deleted = await draftManager.deleteAllDraftKeys();

        if (deleted) {
          addDebugLog('success', 'CANCEL', 'draftmanager-cleanup', 'VÅ¡echny draft klÃ­Äe smazÃ¡ny pÅ™es DraftManager');
        } else {
        }

        // ðŸ” VERIFIKACE: Zkontroluj Å¾e draft opravdu neexistuje
        const stillHasDraft = await draftManager.hasDraft();
        if (stillHasDraft) {
          // Zkus znovu smazat
          await draftManager.deleteAllDraftKeys();
        } else {
        }
      }

      // 2. Odemkni objednÃ¡vku (pokud je editace) - graceful handling
      const unlockOrderId = sourceOrderIdForUnlock || savedOrderId;
      if (unlockOrderId && token && username) {
        try {
          await unlockOrder25({ token, username, orderId: unlockOrderId });
          addDebugLog('success', 'CANCEL', 'unlock', `ObjednÃ¡vka ${unlockOrderId} byla odemknuta`);
        } catch (error) {
          addDebugLog('warning', 'CANCEL', 'unlock-error', `Chyba pÅ™i odemykÃ¡nÃ­: ${error.message} - ignorovÃ¡no`);
          // Ignoruj chybu - formulÃ¡Å™ se zavÅ™e i kdyÅ¾ odemykÃ¡nÃ­ selÅ¾e
        }
      }

      // 3. Broadcast zmÄ›nu stavu - SYNCHRONNÄš s await pro dokonÄenÃ­
      try {
        broadcastDraftDeleted(user_id);

        // PoÄkej krÃ¡tce, aby se broadcast stihl zpracovat v jinÃ½ch tabech
        await new Promise(resolve => setTimeout(resolve, 50));

        window.dispatchEvent(new CustomEvent('orderDraftChange', {
          detail: {
            hasDraft: false,
            isEditMode: false,
            orderId: null,
            orderNumber: '',
            isLoading: false
          }
        }));

        addDebugLog('success', 'CANCEL', 'broadcast', 'Broadcast odeslÃ¡n a zpracovÃ¡n');
      } catch (e) {
        addDebugLog('warning', 'CANCEL', 'broadcast-error', `Chyba pÅ™i broadcastu: ${e.message}`);
      }

      // 4. ZavÅ™i modal
      setShowCancelConfirmModal(false);
      setCancelWarningMessage('');

      addDebugLog('info', 'CANCEL', 'redirect', 'PÅ™esmÄ›rovÃ¡vÃ¡m na seznam objednÃ¡vek');

      // 5. PÅ™esmÄ›ruj s dostateÄnÃ½m zpoÅ¾dÄ›nÃ­m, aby se stihly dokonÄit vÅ¡echny async operace
      setTimeout(() => {
        navigate('/orders25-list', { state: { forceReload: true } });
      }, 200);

    } catch (error) {
      addDebugLog('error', 'CANCEL', 'error', `Chyba pÅ™i zavÃ­rÃ¡nÃ­: ${error.message}`);
      showToast && showToast(`Chyba pÅ™i zavÃ­rÃ¡nÃ­: ${error.message}`, { type: 'error' });

      // I pÅ™i chybÄ› resetuj stavy a pÅ™esmÄ›ruj
      setIsSaving(false);
      setShowSaveProgress(false);
      setShowCancelConfirmModal(false);
      setCancelWarningMessage('');

      // PÅ™esmÄ›ruj i pÅ™es chybu (lepÅ¡Ã­ neÅ¾ zÅ¯stat na formulÃ¡Å™i)
      setTimeout(() => {
        navigate('/orders25-list', { state: { forceReload: true } });
      }, 100);
    }
  }, [user_id, draftManager, sourceOrderIdForUnlock, savedOrderId, token, username, showToast, navigate]);

  const handleCancelCancel = useCallback(() => {
    setShowCancelConfirmModal(false);
    setCancelWarningMessage('');
  }, []);

  // Funkce pro odemykÃ¡nÃ­ FÃZE 1 sekcÃ­ - ÄŒISTÃ FUNKCE BEZ TOAST
  // ðŸ”“ Handler pro odemÄenÃ­ FÃZE 1 - nynÃ­ pouÅ¾Ã­vÃ¡ workflowManager.unlockPhase2()
  // âœ… SJEDNOCENO s handleResetToPhase3Sections (unlock z PO sekce)
  const handleResetToPhase1 = async () => {
    // âœ… PouÅ¾ij centralizovanou logiku z WorkflowManager
    const { updatedFormData, unlockState, newPhase } = workflowManager.unlockPhase2();

    // Aktualizuj formData state okamÅ¾itÄ›
    setFormData(updatedFormData);

    // âœ… WorkflowManager se automaticky pÅ™epoÄÃ­tÃ¡ dÃ­ky zmÄ›nÄ› formData.stav_workflow_kod

    // OkamÅ¾itÃ© uloÅ¾enÃ­ do localStorage pÅ™es triggerAutosave
    setTimeout(() => {
      triggerAutosave(true);
      addDebugLog('success', 'UNLOCK', unlockState, `FÃZE ${newPhase} odemÄena, workflow: ${updatedFormData.stav_workflow_kod}`);
    }, 100);
  };

  const [pendingUnlock, setPendingUnlock] = useState(false);

  // useEffect pro automatickÃ© uloÅ¾enÃ­ po odemÄenÃ­ FÃZE 2
  useEffect(() => {
    // ðŸ”’ GUARD: NespouÅ¡tÄ›t pokud uÅ¾ probÃ­hÃ¡ jinÃ© uklÃ¡dÃ¡nÃ­ (napÅ™. z saveOrderToAPI)
    if (pendingUnlock && isPhase3SectionsUnlocked && !isSaving) {
      const doSave = async () => {
        try {
          // â­ TICHÃ‰ ULOÅ½ENÃ - bez progress baru a pÅ™esmÄ›rovÃ¡nÃ­
          setIsSaving(true);

          // PÅ™iprav data pro UPDATE (stejnÃ¡ logika jako saveOrderToAPI)
          const orderData = {};
          if (formData.predmet) orderData.predmet = formData.predmet;
          if (formData.garant_uzivatel_id) orderData.garant_uzivatel_id = formData.garant_uzivatel_id;

          // Workflow stav (bez ODESLANA/ZRUSENA)
          const existingStates = parseWorkflowStates(formData.stav_workflow_kod);
          const cleanStates = existingStates.filter(s => s !== 'ODESLANA' && s !== 'ZRUSENA');
          orderData.stav_workflow_kod = JSON.stringify(cleanStates);

          // Storno checkboxy - false
          orderData.stav_odeslano = false;
          orderData.stav_stornovano = false;

          // Zavolej API pÅ™Ã­mo (bez progress baru) - V2 API
          // âš ï¸ prepareDataForAPI() se volÃ¡ automaticky uvnitÅ™ updateOrderV2() - NEMÄšNIT ZNOVU!
          // const preparedData = prepareDataForAPI(orderData);  âŒ DUPLICITNÃ - jiÅ¾ se dÄ›lÃ¡ v updateOrderV2()
          await updateOrderV2(savedOrderId, orderData, token, username);

        } catch (error) {
          showToast && showToast(`Chyba pÅ™i uklÃ¡dÃ¡nÃ­: ${error.message}`, { type: 'error' });
        } finally {
          setPendingUnlock(false);
          setIsSaving(false);
        }
      };
      doSave();
    }
  }, [pendingUnlock, isPhase3SectionsUnlocked, isSaving]); // PÅ™idÃ¡na zÃ¡vislost isSaving

  // ðŸ”„ UniverzÃ¡lnÃ­ helper pro reset vyÅ¡Å¡Ã­ch fÃ¡zÃ­ pÅ™i odemÄenÃ­ niÅ¾Å¡Ã­ sekce
  const resetHigherPhaseCheckboxes = (sectionName) => {
    addDebugLog('info', 'UNLOCK', sectionName, 'OdemÄenÃ­ niÅ¾Å¡Ã­ sekce â†’ automaticky ruÅ¡Ã­m checkboxy vyÅ¡Å¡Ã­ch fÃ¡zÃ­');

    // ZruÅ¡it checkbox VÄ›cnÃ© sprÃ¡vnosti
    handleInputChange('potvrzeni_vecne_spravnosti', 0);

    // ZruÅ¡it checkbox DokonÄenÃ­ objednÃ¡vky
    handleInputChange('potvrzeni_dokonceni_objednavky', 0);

    // Force re-render pro aktualizaci viditelnosti sekcÃ­
    workflowForceRefresh();

    // ðŸ”„ OKAMÅ½ITÃ‰ ULOÅ½ENÃ: Trigger autosave pro aktualizaci stavu
    setTimeout(() => triggerAutosave(true), 100);
  };

  // ðŸ”“ Funkce pro odemykÃ¡nÃ­ FÃZE 2 sekcÃ­ - DELEGOVÃNO na WorkflowManager
  const handleResetToPhase3Sections = async () => {
    // ï¿½ PÅ˜ÃMO ODEMKNI - confirm dialog je vnÄ›jÅ¡Ã­ (showUnlockPhase2Confirm)
    // ðŸŽ¯ DELEGACE NA WORKFLOWMANAGER
    const { updatedFormData, unlockState, newPhase } = workflowManager.unlockPhase2();

    // Aktualizuj formData state okamÅ¾itÄ›
    setFormData(updatedFormData);

    // âš ï¸ FÃZE 2 se odemykÃ¡ zmÄ›nou workflow na ODESLANA_KE_SCHVALENI

    // âœ… WorkflowManager se automaticky pÅ™epoÄÃ­tÃ¡ dÃ­ky zmÄ›nÄ› formData.stav_workflow_kod

    // OkamÅ¾itÃ© uloÅ¾enÃ­ do localStorage pÅ™es triggerAutosave
    setTimeout(() => {
      triggerAutosave(true);
      addDebugLog('success', 'UNLOCK', unlockState, `FÃZE ${newPhase} odemÄena, workflow: ${updatedFormData.stav_workflow_kod}`);
    }, 100);
  };

  // ðŸ”“ Handler pro odemknutÃ­ FÃZE 3 (Dodavatel aÅ¾ Stav odeslÃ¡nÃ­) - DELEGOVÃNO na WorkflowManager
  // âš ï¸ POZNÃMKA: FinancovÃ¡nÃ­ je souÄÃ¡stÃ­ FÃZE 1-2, ne FÃZE 3!
  const handleResetToPhase3Workflow = async () => {
    // ðŸŽ¯ DELEGACE NA WORKFLOWMANAGER
    const { updatedFormData, unlockState, newPhase } = workflowManager.unlockPhase3();

    // ðŸ”“ KRITICKÃ‰: Nastav unlock state pro FÃZI 3 PÅ˜ED zmÄ›nou formData!
    setIsPhase3SectionsUnlocked(true);

    // Aktualizuj formData state s malÃ½m zpoÅ¾dÄ›nÃ­m pro zajiÅ¡tÄ›nÃ­ sprÃ¡vnÃ©ho poÅ™adÃ­
    setTimeout(() => {
      setFormData(updatedFormData);

      // Reset vyÅ¡Å¡Ã­ch checkboxÅ¯
      resetHigherPhaseCheckboxes('phase3');

      // OkamÅ¾itÃ© uloÅ¾enÃ­ do DB pÅ™es triggerAutosave
      setTimeout(() => {
        triggerAutosave(true);
        addDebugLog('success', 'UNLOCK', unlockState, `FÃZE ${newPhase} odemÄena, workflow: ${updatedFormData.stav_workflow_kod}`);
      }, 100);
    }, 10);
  };

  // ðŸ”“ Handler pro odemknutÃ­ FÃZE 4 (PotvrzenÃ­ dodavatele) - DELEGOVÃNO na WorkflowManager
  const handleResetToPhase4Confirmation = async () => {
    // Kontrola jestli je uÅ¾ivatel SUPER/ADMIN nebo mÃ¡ prÃ¡va
    if (!canUnlockAnything && currentPhase > 4) {
      showToast && showToast('BÄ›Å¾nÃ½ uÅ¾ivatel mÅ¯Å¾e odemknout pouze poslednÃ­ fÃ¡zi!', { type: 'error' });
      return;
    }

    // ðŸ†• Zobraz ConfirmDialog mÃ­sto Toast
    setConfirmDialog({
      isOpen: true,
      title: "Odemknout sekci PotvrzenÃ­ dodavatele",
      message: "âš ï¸ OdemÄenÃ­ sekce umoÅ¾nÃ­ editaci, ale objednÃ¡vka je jiÅ¾ POTVRZENA!\n\nOpravdu chcete pokraÄovat?",
      onConfirm: async () => {
        // ðŸŽ¯ DELEGACE NA WORKFLOWMANAGER
        const { updatedFormData, unlockState, newPhase } = workflowManager.unlockPhase4();

        // ðŸ”“ KRITICKÃ‰: Nastav unlock state pro potvrzenÃ­ PÅ˜ED zmÄ›nou formData!
        workflowManager.unlockSection('potvrzeni');
        workflowManager.unlockSection('registr');

        // Aktualizuj formData state s malÃ½m zpoÅ¾dÄ›nÃ­m pro zajiÅ¡tÄ›nÃ­ sprÃ¡vnÃ©ho poÅ™adÃ­
        setTimeout(() => {
          setFormData(updatedFormData);

          // ðŸ”„ Reset vyÅ¡Å¡Ã­ch checkboxÅ¯
          resetHigherPhaseCheckboxes('phase4');

          // OkamÅ¾itÃ© uloÅ¾enÃ­ do localStorage pÅ™es triggerAutosave
          setTimeout(() => {
            triggerAutosave(true);
            addDebugLog('success', 'UNLOCK', unlockState, `FÃZE ${newPhase} odemÄena, workflow: ${updatedFormData.stav_workflow_kod}`);
          }, 100);
        }, 10);

        // ZavÅ™i ConfirmDialog
        setConfirmDialog({ isOpen: false, title: '', message: '', onConfirm: null });
      }
    });
  };

  // Funkce pro validaci jednoho pole
  const validateField = (fieldName, value) => {
    // PouÅ¾ij aktuÃ¡lnÃ­ formData s novou hodnotou pro validaci
    const tempFormData = { ...formData, [fieldName]: value };
    // KRITICKÃ‰: Validovat podle aktuÃ¡lnÃ­ VIDITELNÃ‰ fÃ¡ze i pro jednotlivÃ¡ pole
    const validationWorkflowCode = currentPhase === 1 ? 'NOVA' : mainWorkflowState;
    const allErrors = validateWorkflowData(tempFormData, validationWorkflowCode);

    // Aktualizuj pouze chybu pro toto pole
    setValidationErrors(prev => {
      const newErrors = { ...prev };
      if (allErrors[fieldName]) {
        newErrors[fieldName] = allErrors[fieldName];
      } else {
        delete newErrors[fieldName];
      }
      return newErrors;
    });
  };

  // Funkce pro validace formulÃ¡Å™e s novÃ½m workflow systÃ©mem
  // VALIDACE SE SPOUÅ TÃ JEN PÅ˜I POKUSU O ULOÅ½ENÃ DO DATABÃZE
  const validateFormForSave = () => {
    // ðŸ›ï¸ SPECIÃLNÃ PRAVIDLA: ArchivovanÃ© objednÃ¡vky - BEZ VALIDACE
    // UmoÅ¾nit partial update bez kontroly povinnÃ½ch polÃ­
    if (isArchivedOrder) {
      setValidationErrors({});
      return true; // âœ… VÅ¾dy platnÃ¡
    }

    // âœ… OPRAVA: Nastavit hasTriedToSubmit synchronnÄ› pomocÃ­ flushSync
    // aby se ÄervenÃ© orÃ¡movÃ¡nÃ­ zobrazilo IHNED pÅ™i prvnÃ­m pokusu
    flushSync(() => {
      setHasTriedToSubmit(true);
    });

    let errors = {};

    // SPECIÃLNÃ LOGIKA: PÅ™i stornovÃ¡nÃ­ validovat pouze storno pole
    if (formData.stav_stornovano) {
      // Pro stornovanÃ© objednÃ¡vky validovat pouze dÅ¯vod stornovÃ¡nÃ­
      if (!formData.odeslani_storno_duvod?.trim()) {
        errors.odeslani_storno_duvod = 'DÅ¯vod stornovÃ¡nÃ­ je povinnÃ½';
      }
    } else {
      // NormÃ¡lnÃ­ validace pro nestornovanÃ© objednÃ¡vky
      // KRITICKÃ‰: Validovat podle aktuÃ¡lnÃ­ VIDITELNÃ‰ fÃ¡ze, ne podle stav_workflow_kod!
      // Pokud jsme v FÃZI 1, validovat jen FÃZI 1, i kdyÅ¾ je zaÅ¡krtnuto "schvÃ¡leno"
      const validationWorkflowCode = currentPhase === 1 ? 'NOVA' : mainWorkflowState;

      // âœ… PÅ™iprav informaci o viditelnosti a zamÄenÃ­ sekcÃ­
      const sectionStates = {
        phase1: { visible: currentPhase >= 1, locked: shouldLockPhase1Sections },
        phase2: { visible: currentPhase >= 2, locked: shouldLockPhase2Sections },
        financovani: { visible: financovaniState.visible, locked: !financovaniState.enabled }, // SamostatnÃ¡ sekce pro financovÃ¡nÃ­
        phase3: { visible: currentPhase >= 3, locked: shouldLockPhase3Sections },
        phase4to6: { visible: currentPhase >= 4, locked: shouldLockPhase4to6Sections },
        registr_smluv_vyplneni: { visible: registrVyplneniState.visible, locked: isRegistrVyplneniLocked } // FÃZE 5: ZveÅ™ejnÄ›nÃ­
      };

      // âœ… FIX: Merge errors mÃ­sto pÅ™epsÃ¡nÃ­ - jinak ztratÃ­me FÃZE 5 validaci!
      const workflowErrors = validateWorkflowData(formData, validationWorkflowCode, sectionStates);
      errors = { ...errors, ...workflowErrors };

      // ðŸ’° VALIDACE DYNAMICKÃCH POLÃ PODLE ZDROJE FINANCOVÃNÃ
      // âœ… Kontrola povinnÃ½ch dynamickÃ½ch polÃ­ od FÃZE 1+ (pokud je financovÃ¡nÃ­ vyplnÄ›no)
      // âœ… Validovat POUZE pokud je sekce financovÃ¡nÃ­ viditelnÃ¡ A odemÄenÃ¡
      const shouldValidateFinancovani = sectionStates.financovani.visible && !sectionStates.financovani.locked;
      if (currentPhase >= 1 && formData.zpusob_financovani && shouldValidateFinancovani) {
        const selectedFinancovani = financovaniOptions.find(opt =>
          opt.kod === formData.zpusob_financovani ||
          opt.kod_stavu === formData.zpusob_financovani ||
          opt.value === formData.zpusob_financovani
        );

        if (selectedFinancovani) {
          const nazev = selectedFinancovani.nazev_stavu || selectedFinancovani.nazev || '';

          // LimitovanÃ½ pÅ™Ã­slib - LP kÃ³d je POVINNÃ
          if (nazev.includes('Limitovan') || nazev.includes('pÅ™Ã­slib')) {
            if (!formData.lp_kod ||
                (Array.isArray(formData.lp_kod) && formData.lp_kod.length === 0)) {
              errors.lp_kod = "LP kÃ³d je povinnÃ½ pÅ™i financovÃ¡nÃ­ z LimitovanÃ©ho pÅ™Ã­slibu";
            }
            
            // ðŸ†• VALIDACE LP U POLOÅ½EK: Pokud je financovÃ¡nÃ­ LP, vÅ¡echny poloÅ¾ky MUSÃ mÃ­t vyplnÄ›nÃ© LP
            // âœ… VALIDOVAT POUZE VE FÃZI 3+ (poloÅ¾ky jsou dostupnÃ© aÅ¾ od fÃ¡ze 3)
            if (currentPhase >= 3 && formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
              formData.polozky_objednavky.forEach((polozka, index) => {
                if (!polozka.polozka_lp_id && !polozka.lp_id) {
                  errors[`polozka_${index}_lp`] = `PoloÅ¾ka ${index + 1}: LP je povinnÃ© pÅ™i financovÃ¡nÃ­ z LimitovanÃ©ho pÅ™Ã­slibu`;
                }
              });
            }
          }

          // Smlouva - ÄŒÃ­slo smlouvy je POVINNÃ‰ a musÃ­ existovat v seznamu aktivnÃ­ch smluv
          if (nazev.includes('Smlouva')) {
            if (!formData.cislo_smlouvy?.trim()) {
              errors.cislo_smlouvy = 'ÄŒÃ­slo smlouvy je povinnÃ© pÅ™i financovÃ¡nÃ­ ze Smlouvy';
            } else {
              // ðŸ”’ PÅ˜ÃSNÃ VALIDACE: OvÄ›Å™it, Å¾e ÄÃ­slo smlouvy existuje v seznamu aktivnÃ­ch smluv
              const existujeSmlouva = smlouvyList.some(s => 
                (s.aktivni !== 0 && s.aktivni !== false) &&
                (s.cislo_smlouvy === formData.cislo_smlouvy || s.evidencni_cislo === formData.cislo_smlouvy)
              );
              
              if (!existujeSmlouva) {
                errors.cislo_smlouvy = 'ZadanÃ© ÄÃ­slo smlouvy neexistuje v seznamu aktivnÃ­ch smluv. Vyberte prosÃ­m platnou smlouvu.';
              }
            }
          }

          // IndividuÃ¡lnÃ­ schvÃ¡lenÃ­ - IdentifikÃ¡tor je POVINNÃ
          if (nazev.includes('IndividuÃ¡lnÃ­')) {
            const individualniValue = typeof formData.individualni_schvaleni === 'string'
              ? formData.individualni_schvaleni
              : '';
            if (!individualniValue.trim()) {
              errors.individualni_schvaleni = 'IdentifikÃ¡tor schvÃ¡lenÃ­ je povinnÃ½ pÅ™i IndividuÃ¡lnÃ­m schvÃ¡lenÃ­';
            }
          }

          // PojistnÃ¡ udÃ¡lost - ÄŒÃ­slo udÃ¡losti je POVINNÃ‰
          if (nazev.includes('Pojistn')) {
            if (!formData.pojistna_udalost_cislo?.trim()) {
              errors.pojistna_udalost_cislo = 'ÄŒÃ­slo pojistnÃ© udÃ¡losti je povinnÃ© pÅ™i financovÃ¡nÃ­ z PojistnÃ© udÃ¡losti';
            }
          }
        }
      }

      // SPECIÃLNÃ VALIDACE PRO FÃZI 4: PotvrzenÃ­ dodavatele
      // âœ… VALIDOVAT POUZE VE FÃZI 4 (ODESLANA) - ve FÃZI 3 jeÅ¡tÄ› nemusÃ­ bÃ½t vyplnÄ›no
      if (currentPhase === 4 && formData.dodavatel_zpusob_potvrzeni?.potvrzeni === "ANO") {
        // ZpÅ¯sob potvrzenÃ­ je povinnÃ½ (alespoÅˆ jeden zpÅ¯sob musÃ­ bÃ½t v poli zpusoby)
        const zpusobyPotvrzeni = formData.dodavatel_zpusob_potvrzeni;
        const maZpusob = zpusobyPotvrzeni?.zpusoby && zpusobyPotvrzeni.zpusoby.length > 0;

        if (!maZpusob) {
          errors.dodavatel_zpusob_potvrzeni = 'ZpÅ¯sob potvrzenÃ­ - pÅ™i odpovÄ›di "ANO" musÃ­ bÃ½t vybrÃ¡n alespoÅˆ jeden zpÅ¯sob';
        }

        // âœ… ZpÅ¯sob platby - kontrola, Å¾e je nastavena hodnota (vÅ¾dy "faktura")
        // POZNÃMKA: Platba je v kÃ³du pevnÄ› nastavena na "faktura" (readonly checkbox)
        if (!zpusobyPotvrzeni?.platba || zpusobyPotvrzeni.platba.trim() === '') {
          errors.zpusob_platby = 'ZpÅ¯sob platby je povinnÃ½ pÅ™i potvrzenÃ­ dodavatele "ANO"';
        }

        // âœ… Datum akceptace je VÅ½DY povinnÃ© (nezÃ¡visle na zpÅ¯sobu potvrzenÃ­)
        if (!formData.dt_akceptace?.trim()) {
          errors.dt_akceptace = 'Datum akceptace je povinnÃ© pÅ™i potvrzenÃ­ dodavatele "ANO"';
        }
      }

      // POZNÃMKA: IÄŒO, NÃ¡zev, Adresa dodavatele patÅ™Ã­ do bloku "Dodavatel" ve FÃZI 3
      // ValidujÃ­ se pÅ™es validateWorkflowData(), ne zde!

      // âœ… VALIDACE ZVEÅ˜EJNÄšNÃ: PÅ™esunuto do workflowUtils.js (validateWorkflowData)
      // Validace dt_zverejneni a registr_iddt se provÃ¡dÃ­ automaticky pÅ™es workflow manager
      // kdyÅ¾ je zaÅ¡krtnuto ma_byt_zverejnena a sekce registr_smluv_vyplneni je viditelnÃ¡ a odemÄenÃ¡

      // ðŸ†• VALIDACE ÃšSEK, BUDOVA, MÃSTNOST U POLOÅ½EK: Pouze u majetkovÃ½ch objednÃ¡vek
      // âœ… VALIDOVAT POUZE VE FÃZI 3+ (lokalizaÄnÃ­ pole jsou dostupnÃ¡ aÅ¾ od fÃ¡ze 3)
      const isMaterialOrder = formData.druh_objednavky_kod && 
        formData.druh_objednavky_kod.toUpperCase().includes('MAJETEK');
      
      if (currentPhase >= 3 && isMaterialOrder && formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
        formData.polozky_objednavky.forEach((polozka, index) => {
          if (!polozka.usek_kod || !polozka.usek_kod.trim()) {
            errors[`polozka_${index}_usek_kod`] = `PoloÅ¾ka ${index + 1}: Ãšsek je povinnÃ½ u majetkovÃ½ch objednÃ¡vek`;
          }
          if (!polozka.budova_kod || !polozka.budova_kod.trim()) {
            errors[`polozka_${index}_budova_kod`] = `PoloÅ¾ka ${index + 1}: Budova je povinnÃ¡ u majetkovÃ½ch objednÃ¡vek`;
          }
          if (!polozka.mistnost_kod || !polozka.mistnost_kod.trim()) {
            errors[`polozka_${index}_mistnost_kod`] = `PoloÅ¾ka ${index + 1}: MÃ­stnost je povinnÃ¡ u majetkovÃ½ch objednÃ¡vek`;
            console.log(`âŒ PoloÅ¾ka ${index + 1}: ChybÃ­ mÃ­stnost`);
          }
        });
      }

      // VALIDACE FAKTUR - kontrola povinnÃ½ch polÃ­
      // âœ… POUZE validovat faktury ve FÃZI 6+ (kdyÅ¾ je sekce Fakturace viditelnÃ¡)
      // âœ… NEvalidovat faktury kdyÅ¾ je vybranÃ¡ POKLADNA (faktury se v tom pÅ™Ã­padÄ› nezobrazujÃ­)
      const isPlatbaPokladnaObj = formData.financovani?.platba === 'pokladna';
      const isPlatbaPokladnaDodavatel = formData.dodavatel_zpusob_potvrzeni?.platba === 'pokladna';
      const isPokladna = isPlatbaPokladnaObj || isPlatbaPokladnaDodavatel;

      if (currentPhase >= 6 && !isPokladna && formData.faktury && formData.faktury.length > 0) {
        formData.faktury.forEach((faktura, index) => {
          const fakturaPrefix = `faktura_${index + 1}`;

          // VariabilnÃ­ symbol je povinnÃ½
          if (!faktura.fa_cislo_vema || (typeof faktura.fa_cislo_vema === 'string' && faktura.fa_cislo_vema.trim() === '')) {
            errors[`${fakturaPrefix}_cislo`] = `Faktura ${index + 1}: VariabilnÃ­ symbol je povinnÃ½`;
          }

          // ÄŒÃ¡stka je povinnÃ¡ a musÃ­ bÃ½t vÄ›tÅ¡Ã­ neÅ¾ 0
          if (!faktura.fa_castka || parseFloat(faktura.fa_castka) <= 0) {
            errors[`${fakturaPrefix}_castka`] = `Faktura ${index + 1}: ÄŒÃ¡stka je povinnÃ¡ a musÃ­ bÃ½t vÄ›tÅ¡Ã­ neÅ¾ 0`;
          }

          // Datum doruÄenÃ­ je povinnÃ© - kontroluj fa_datum_doruceni (ne fa_dorucena, to je boolean)
          if (!faktura.fa_datum_doruceni || (typeof faktura.fa_datum_doruceni === 'string' && faktura.fa_datum_doruceni.trim() === '')) {
            errors[`${fakturaPrefix}_dorucena`] = `Faktura ${index + 1}: Datum doruÄenÃ­ je povinnÃ©`;
          }

          // Datum splatnosti je povinnÃ©
          if (!faktura.fa_splatnost || (typeof faktura.fa_splatnost === 'string' && faktura.fa_splatnost.trim() === '')) {
            errors[`${fakturaPrefix}_splatnost`] = `Faktura ${index + 1}: Datum splatnosti je povinnÃ©`;
          }

          // ðŸ¢ StÅ™ediska faktury jsou VOLITELNÃ a NEvalidujÃ­ se proti strediskaOptions
          // DÅ¯vod: StÅ™ediska z faktury mohou bÃ½t jinÃ¡ neÅ¾ stÅ™ediska v naÅ¡em systÃ©mu
          // (mohou pÅ™ijÃ­t od dodavatele s vlastnÃ­m ÄÃ­slovÃ¡nÃ­m)
          // POZNÃMKA: Validace byla odstranÄ›na - stÅ™ediska jsou ÄistÄ› informativnÃ­ pole
        });
      }

      // âœ… FÃZE 7+: VALIDACE VÄšCNÃ‰ SPRÃVNOSTI (per-invoice)
      if (currentPhase >= 7 && !isPokladna && formData.faktury && formData.faktury.length > 0) {
        const maxCena = parseFloat(formData.max_cena_s_dph) || 0;
        
        formData.faktury.forEach((faktura, index) => {
          // PotvrzenÃ­ vÄ›cnÃ© sprÃ¡vnosti je POVINNÃ‰ ve FÃZI 7+
          if (faktura.vecna_spravnost_potvrzeno !== 1 && faktura.vecna_spravnost_potvrzeno !== true) {
            errors[`faktura_${index + 1}_vecna_spravnost`] = `Faktura ${index + 1}: MusÃ­te potvrdit vÄ›cnou sprÃ¡vnost`;
          }
          
          // PoznÃ¡mka je POVINNÃ pokud faktura pÅ™ekraÄuje MAX cenu objednÃ¡vky
          const fakturaCastka = parseFloat(faktura.fa_castka) || 0;
          if (fakturaCastka > maxCena && (!faktura.vecna_spravnost_poznamka || faktura.vecna_spravnost_poznamka.trim() === '')) {
            errors[`faktura_${index + 1}_poznamka_vs`] = `Faktura ${index + 1}: PoznÃ¡mka je povinnÃ¡ - faktura pÅ™ekraÄuje maximÃ¡lnÃ­ cenu objednÃ¡vky`;
          }
        });
      }
    }

    const hasErrors = Object.keys(errors).length > 0;
    
    // ðŸž DEBUG: VÃ½pis validaÄnÃ­ch chyb ve fÃ¡zi 7/8
    if ((currentPhase === 7 || currentPhase === 8) && hasErrors) {
      console.log('ðŸ” VALIDACE ve fÃ¡zi', currentPhase, '- NalezenÃ© chyby:');
      console.log('ðŸ“‹ PoÄet chyb:', Object.keys(errors).length);
      console.log('ðŸ“ Detail chyb:', errors);
      console.log('ðŸŽ¯ ValidaÄnÃ­ workflow kÃ³d:', currentPhase === 1 ? 'NOVA' : mainWorkflowState);
      console.log('ðŸ“¦ FormData stav:', {
        stav_stornovano: formData.stav_stornovano,
        ma_byt_zverejnena: formData.ma_byt_zverejnena,
        faktury: formData.faktury?.length || 0,
        polozky: formData.polozky_objednavky?.length || 0
      });
    }
    
    // âš¡ KRITICKÃ‰: PouÅ¾Ã­t flushSync k okamÅ¾itÃ©mu nastavenÃ­ validationErrors
    // PÅ˜ED otevÅ™enÃ­m panelÅ¯ - jinak se panely otevÅ™ou ale chyby jeÅ¡tÄ› nebudou v DOM
    flushSync(() => {
      setValidationErrors(errors);
    });

    // ðŸ”§ AUTOMATICKÃ‰ OTEVÅ˜ENÃ LOKALIZAÄŒNÃCH PANELÅ® u poloÅ¾ek s chybami
    // Pokud jsou chyby v lokaÄnÃ­ch polÃ­ch (ÃšSEK, BUDOVA, MÃSTNOST), musÃ­me otevÅ™Ã­t panel,
    // jinak se ÄervenÃ© rÃ¡meÄky nezobrazÃ­ (protoÅ¾e pole jsou podmÃ­nÄ›nÄ› renderovÃ¡na)
    const locationErrorKeys = Object.keys(errors).filter(k => 
      k.includes('_usek_kod') || k.includes('_budova_kod') || k.includes('_mistnost_kod')
    );
    
    if (locationErrorKeys.length > 0) {
      // Najdi indexy poloÅ¾ek s chybami
      const polozkyIndexesWithErrors = new Set();
      locationErrorKeys.forEach(key => {
        const match = key.match(/polozka_(\d+)_/);
        if (match) {
          polozkyIndexesWithErrors.add(parseInt(match[1]));
        }
      });
      
      // OtevÅ™i panely pro tyto poloÅ¾ky - TAKÃ‰ pomocÃ­ flushSync
      const newLokalizacePanelStates = { ...lokalizacePanelStates };
      formData.polozky_objednavky?.forEach((polozka, index) => {
        if (polozkyIndexesWithErrors.has(index)) {
          newLokalizacePanelStates[polozka.id] = true;
        }
      });
      
      flushSync(() => {
        setLokalizacePanelStates(newLokalizacePanelStates);
      });
    }

    // Zobrazit toast s konkrÃ©tnÃ­mi chybami a scrollovat na prvnÃ­ chybu
    if (hasErrors) {
      const errorCount = Object.keys(errors).length;
      
      const errorMessage = formData.stav_stornovano
        ? `Nelze stornovat - zkontrolujte vyznaÄenÃ¡ pole`
        : `FormulÃ¡Å™ obsahuje ${errorCount} ${errorCount === 1 ? 'chybu' : errorCount < 5 ? 'chyby' : 'chyb'} - zkontrolujte ÄervenÄ› oznaÄenÃ¡ pole`;

      showToast && showToast(errorMessage, { type: 'error' });

      // Scroll na prvnÃ­ chybovÃ½ element s mÃ­rnÃ½m zpoÅ¾dÄ›nÃ­m
      setTimeout(() => {
        scrollToFirstError(errors);
      }, 100);
    }

    return !hasErrors;
  };

  // LehkÃ¡ validace pro zobrazenÃ­ ÄervenÃ½ch polÃ­ (bez toast zprÃ¡v)
  const validateFormSilently = () => {
    let errors = {};

    // SPECIÃLNÃ LOGIKA: PÅ™i stornovÃ¡nÃ­ validovat pouze storno pole
    if (formData.stav_stornovano) {
      if (!formData.odeslani_storno_duvod?.trim()) {
        errors.odeslani_storno_duvod = 'DÅ¯vod stornovÃ¡nÃ­ je povinnÃ½';
      }
    } else {
      // âœ… Validace podle workflow - validuj ve VÅ ECH fÃ¡zÃ­ch
      const validationWorkflowCode = currentPhase === 1 ? 'NOVA' : mainWorkflowState;

      // âœ… PÅ™iprav informaci o viditelnosti a zamÄenÃ­ sekcÃ­
      const sectionStates = {
        phase1: { visible: currentPhase >= 1, locked: shouldLockPhase1Sections },
        phase2: { visible: currentPhase >= 2, locked: shouldLockPhase2Sections },
        financovani: { visible: financovaniState.visible, locked: !financovaniState.enabled }, // SamostatnÃ¡ sekce pro financovÃ¡nÃ­
        phase3: { visible: currentPhase >= 3, locked: shouldLockPhase3Sections },
        phase4to6: { visible: currentPhase >= 4, locked: shouldLockPhase4to6Sections }
      };

      // âœ… FIX: Merge errors mÃ­sto pÅ™epsÃ¡nÃ­ - jinak ztratÃ­me FÃZE 5 validaci!
      const workflowErrors = validateWorkflowData(formData, validationWorkflowCode, sectionStates);
      errors = { ...errors, ...workflowErrors };

      // ðŸ’° VALIDACE DYNAMICKÃCH POLÃ PODLE ZDROJE FINANCOVÃNÃ (tichÃ¡ validace)
      // âœ… FinancovÃ¡nÃ­ je souÄÃ¡stÃ­ FÃZE 1-2 (validuje se hned od zaÄÃ¡tku!)
      // âœ… Validovat POUZE pokud je sekce financovÃ¡nÃ­ viditelnÃ¡ A odemÄenÃ¡
      const shouldValidateFinancovani = financovaniState.visible && financovaniState.enabled;
      if (currentPhase >= 1 && formData.zpusob_financovani && shouldValidateFinancovani) {
        const selectedFinancovani = financovaniOptions.find(opt =>
          opt.kod === formData.zpusob_financovani ||
          opt.kod_stavu === formData.zpusob_financovani ||
          opt.value === formData.zpusob_financovani
        );

        if (selectedFinancovani) {
          const nazev = selectedFinancovani.nazev_stavu || selectedFinancovani.nazev || '';

          // LimitovanÃ½ pÅ™Ã­slib - LP kÃ³d je POVINNÃ
          if (nazev.includes('Limitovan') || nazev.includes('pÅ™Ã­slib')) {
            if (!formData.lp_kod ||
                (Array.isArray(formData.lp_kod) && formData.lp_kod.length === 0)) {
              errors.lp_kod = 'LP kÃ³d je povinnÃ½';
            }
            
            // ðŸ†• VALIDACE LP U POLOÅ½EK: Pokud je financovÃ¡nÃ­ LP, vÅ¡echny poloÅ¾ky MUSÃ mÃ­t vyplnÄ›nÃ© LP
            // âœ… VALIDOVAT POUZE VE FÃZI 3+ (poloÅ¾ky jsou dostupnÃ© aÅ¾ od fÃ¡ze 3)
            if (currentPhase >= 3 && formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
              formData.polozky_objednavky.forEach((polozka, index) => {
                if (!polozka.polozka_lp_id && !polozka.lp_id) {
                  errors[`polozka_${index}_lp`] = `PoloÅ¾ka ${index + 1}: LP je povinnÃ©`;
                }
              });
            }
          }

          // Smlouva - ÄŒÃ­slo smlouvy je POVINNÃ‰ a musÃ­ existovat v seznamu aktivnÃ­ch smluv
          if (nazev.includes('Smlouva')) {
            if (!formData.cislo_smlouvy?.trim()) {
              errors.cislo_smlouvy = 'ÄŒÃ­slo smlouvy je povinnÃ©';
            } else {
              // ðŸ”’ PÅ˜ÃSNÃ VALIDACE: OvÄ›Å™it, Å¾e ÄÃ­slo smlouvy existuje v seznamu aktivnÃ­ch smluv
              const existujeSmlouva = smlouvyList.some(s => 
                (s.aktivni !== 0 && s.aktivni !== false) &&
                (s.cislo_smlouvy === formData.cislo_smlouvy || s.evidencni_cislo === formData.cislo_smlouvy)
              );
              
              if (!existujeSmlouva) {
                errors.cislo_smlouvy = 'ZadanÃ© ÄÃ­slo smlouvy nenÃ­ platnÃ©';
              }
            }
          }

          // IndividuÃ¡lnÃ­ schvÃ¡lenÃ­ - IdentifikÃ¡tor je POVINNÃ
          if (nazev.includes('IndividuÃ¡lnÃ­')) {
            if (!formData.individualni_schvaleni?.trim()) {
              errors.individualni_schvaleni = 'IdentifikÃ¡tor je povinnÃ½';
            }
          }

          // PojistnÃ¡ udÃ¡lost - ÄŒÃ­slo udÃ¡losti je POVINNÃ‰
          if (nazev.includes('Pojistn')) {
            if (!formData.pojistna_udalost_cislo?.trim()) {
              errors.pojistna_udalost_cislo = 'ÄŒÃ­slo pojistnÃ© udÃ¡losti je povinnÃ©';
            }
          }
        }
      }

      // ðŸ†• VALIDACE ÃšSEK, BUDOVA, MÃSTNOST U POLOÅ½EK: Pouze u majetkovÃ½ch objednÃ¡vek
      // âœ… VALIDOVAT POUZE VE FÃZI 3+ (lokalizaÄnÃ­ pole jsou dostupnÃ¡ aÅ¾ od fÃ¡ze 3)
      const isMaterialOrderSilent = formData.druh_objednavky_kod && 
        formData.druh_objednavky_kod.toUpperCase().includes('MAJETEK');
      
      if (currentPhase >= 3 && isMaterialOrderSilent && formData.polozky_objednavky && formData.polozky_objednavky.length > 0) {
        formData.polozky_objednavky.forEach((polozka, index) => {
          if (!polozka.usek_kod || !polozka.usek_kod.trim()) {
            errors[`polozka_${index}_usek_kod`] = `PoloÅ¾ka ${index + 1}: Ãšsek je povinnÃ½ u majetkovÃ½ch objednÃ¡vek`;
          }
          if (!polozka.budova_kod || !polozka.budova_kod.trim()) {
            errors[`polozka_${index}_budova_kod`] = `PoloÅ¾ka ${index + 1}: Budova je povinnÃ¡ u majetkovÃ½ch objednÃ¡vek`;
          }
          if (!polozka.mistnost_kod || !polozka.mistnost_kod.trim()) {
            errors[`polozka_${index}_mistnost_kod`] = `PoloÅ¾ka ${index + 1}: MÃ­stnost je povinnÃ¡ u majetkovÃ½ch objednÃ¡vek`;
          }
        });
      }

      // SPECIÃLNÃ VALIDACE PRO FÃZI 4: PotvrzenÃ­ dodavatele
      // âœ… VALIDOVAT POUZE VE FÃZI 4 (ODESLANA) - ve FÃZI 3 jeÅ¡tÄ› nemusÃ­ bÃ½t vyplnÄ›no
      if (currentPhase === 4 && formData.dodavatel_zpusob_potvrzeni?.potvrzeni === "ANO") {
        const zpusobyPotvrzeni = formData.dodavatel_zpusob_potvrzeni;
        const maZpusob = zpusobyPotvrzeni?.zpusoby && zpusobyPotvrzeni.zpusoby.length > 0;

        if (!maZpusob) {
          errors.dodavatel_zpusob_potvrzeni = 'PÅ™i potvrzenÃ­ "ANO" musÃ­ bÃ½t vybrÃ¡n alespoÅˆ jeden zpÅ¯sob potvrzenÃ­';
        }

        // âœ… ZpÅ¯sob platby - kontrola, Å¾e je nastavena hodnota (vÅ¾dy "faktura")
        // POZNÃMKA: Platba je v kÃ³du pevnÄ› nastavena na "faktura" (readonly checkbox)
        if (!zpusobyPotvrzeni?.platba || zpusobyPotvrzeni.platba.trim() === '') {
          errors.zpusob_platby = 'PÅ™i potvrzenÃ­ dodavatele "ANO" je zpÅ¯sob platby povinnÃ½';
        }

        // âœ… Datum akceptace je VÅ½DY povinnÃ© (nezÃ¡visle na zpÅ¯sobu potvrzenÃ­)
        if (!formData.dt_akceptace?.trim()) {
          errors.dt_akceptace = 'PÅ™i potvrzenÃ­ dodavatele "ANO" je datum akceptace povinnÃ©';
        }
      }

      // ï¿½ TICHÃ VALIDACE REGISTRU SMLUV - pouze pro zobrazenÃ­ ÄervenÃ½ch polÃ­
      // âœ… POUZE validovat ve FÃZI 5 (VyplnÄ›nÃ­ registru smluv) - pokud mÃ¡ bÃ½t zveÅ™ejnÄ›na
      // âœ… VALIDOVAT POUZE pokud mÃ¡ uÅ¾ivatel prÃ¡vo ORDER_PUBLISH_REGISTRY (sekce musÃ­ bÃ½t viditelnÃ¡)
      if ((formData.ma_byt_zverejnena === true || formData.ma_byt_zverejnena === 1) && 
          currentPhase === 5 && 
          sectionStates.phase4to6?.visible && 
          !sectionStates.phase4to6?.locked) {
        if (!formData.dt_zverejneni?.trim()) {
          errors.dt_zverejneni = 'Datum zveÅ™ejnÄ›nÃ­ je povinnÃ©';
        }
        if (!formData.registr_iddt?.trim()) {
          errors.registr_iddt = 'IdentifikÃ¡tor IDDT je povinnÃ½';
        }
      }

      // ï¿½ðŸ’° TICHÃ VALIDACE FAKTUR - pouze pro zobrazenÃ­ ÄervenÃ½ch polÃ­
      // âœ… POUZE validovat faktury ve FÃZI 6+ (kdyÅ¾ je sekce Fakturace viditelnÃ¡)
      if (currentPhase >= 6 && formData.faktury && formData.faktury.length > 0) {
        formData.faktury.forEach((faktura, index) => {
          const fakturaPrefix = `faktura_${index + 1}`;

          if (!faktura.fa_cislo_vema || (typeof faktura.fa_cislo_vema === 'string' && faktura.fa_cislo_vema.trim() === '')) {
            errors[`${fakturaPrefix}_cislo`] = `VariabilnÃ­ symbol je povinnÃ½`;
          }

          if (!faktura.fa_castka || parseFloat(faktura.fa_castka) <= 0) {
            errors[`${fakturaPrefix}_castka`] = `ÄŒÃ¡stka je povinnÃ¡`;
          }

          // Datum doruÄenÃ­ - kontroluj fa_datum_doruceni (ne fa_dorucena, to je boolean)
          if (!faktura.fa_datum_doruceni || (typeof faktura.fa_datum_doruceni === 'string' && faktura.fa_datum_doruceni.trim() === '')) {
            errors[`${fakturaPrefix}_dorucena`] = `Datum doruÄenÃ­ je povinnÃ©`;
          }

          if (!faktura.fa_splatnost || (typeof faktura.fa_splatnost === 'string' && faktura.fa_splatnost.trim() === '')) {
            errors[`${fakturaPrefix}_splatnost`] = `Datum splatnosti je povinnÃ©`;
          }
        });
      }
    }

    setValidationErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // âŒ ZAKOMENTOVÃNO: Tento useEffect zpÅ¯sobuje PÅ˜EPSÃNÃ validaÄnÃ­ch chyb!
  // ProblÃ©m: Po validateFormForSave() (kterÃ¡ vytvoÅ™Ã­ vÅ¡echny chyby vÄetnÄ› lokacÃ­),
  // se tento useEffect spustÃ­ a zavolÃ¡ validateFormSilently(), kterÃ¡ PÅ˜EPÃÅ E chyby
  // ðŸ”§ Å˜EÅ ENÃ: Live validace nenÃ­ potÅ™eba - validujeme pouze pÅ™i kliknutÃ­ na "UloÅ¾it"
  /*
  useEffect(() => {
    // Spustit validaci pouze pokud uÅ¾ uÅ¾ivatel zkusil uloÅ¾it
    if (hasTriedToSubmit) {
      validateFormSilently();
    }
    // âœ… FIX: hasTriedToSubmit NENÃ v dependencies!
    // DÅ¯vod: Nechceme spustit validaci pÅ™i zmÄ›nÄ› hasTriedToSubmit z falseâ†’true
    // To by zpÅ¯sobilo race condition s validateFormForSave()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    formData.dodavatel_zpusob_potvrzeni,
    formData.dt_akceptace,
    formData.dodavatel_ico,
    formData.dodavatel_nazev,
    formData.dodavatel_adresa,
    formData.zpusob_financovani,
    formData.lp_kod,
    formData.cislo_smlouvy,
    formData.individualni_schvaleni,
    formData.pojistna_udalost_cislo,
    formData.ma_byt_zverejnena,
    formData.dt_zverejneni,
    formData.registr_iddt
    // âŒ REMOVED: hasTriedToSubmit - zpÅ¯sobovalo race condition!
  ]);
  */

  // Kontrola, zda je formulÃ¡Å™ validnÃ­ pro zÃ¡kladnÃ­ poÅ¾adavky (pro sekci schvÃ¡lenÃ­)
  const isFormBasicallyValid = () => {
    const errors = validateWorkflowData(formData, 'NOVA');
    return Object.keys(errors).length === 0;
  };

  // Funkce pro kontrolu zÃ¡kladnÃ­ch polÃ­ (bez stavu schvÃ¡lenÃ­)
  // Ignoruje pole "schvaleni_komentar" - to se validuje aÅ¾ pÅ™i uloÅ¾enÃ­
  const areBasicFieldsValid = () => {
    const errors = validateWorkflowData(formData, 'NOVA');
    // Vyfiltrovat chybu schvaleni_komentar
    const { schvaleni_komentar, ...otherErrors } = errors;
    return Object.keys(otherErrors).length === 0;
  };

  // Funkce pro scroll na prvnÃ­ chybovÃ½ element
  const scrollToFirstError = (errors) => {
    if (!errors || Object.keys(errors).length === 0) return;

    // Definice poÅ™adÃ­ polÃ­ podle vizuÃ¡lnÃ­ho poÅ™adÃ­ ve formulÃ¡Å™i
    const fieldOrder = [
      'jmeno',
      'email',
      'garant_uzivatel_id',
      'predmet',
      'prikazce_id',
      'max_cena_s_dph',
      'strediska_kod',
      'schvaleni_komentar',
      'dodavatel_nazev',
      'dodavatel_adresa',
      'dodavatel_ico',
      'druh_objednavky_kod',
      'polozky_objednavky',
      'zpusob_financovani',
      'lp_kod',
      'datum_odeslani',
      'dodavatel_zpusob_potvrzeni',
      'zpusob_platby',
      'dt_akceptace',
      'dt_zverejneni',        // âœ… FÃZE 5: Datum zveÅ™ejnÄ›nÃ­ VZ
      'registr_iddt'          // âœ… FÃZE 5: IdentifikÃ¡tor IDDT
    ];

    // Najdi prvnÃ­ chybovÃ© pole podle poÅ™adÃ­
    for (const field of fieldOrder) {
      if (errors[field]) {
        // MapovÃ¡nÃ­ field names na selektory
        let element = null;
        let parentSection = null;

        switch (field) {
          case 'jmeno':
            element = document.querySelector('input[name="jmeno"]');
            break;
          case 'email':
            element = document.querySelector('input[type="email"][name="email"]');
            break;
          case 'garant_uzivatel_id':
            element = document.querySelector('[data-field="garant"]');
            break;
          case 'predmet':
            element = document.querySelector('input[name="predmet"]');
            break;
          case 'prikazce_id':
            element = document.querySelector('[data-field="prikazce"]');
            break;
          case 'max_cena_s_dph':
            element = document.querySelector('input[name="max_cena_s_dph"]');
            break;
          case 'strediska_kod':
            element = document.querySelector('[data-field="strediska"]');
            break;
          case 'schvaleni_komentar':
            element = document.querySelector('textarea[name="schvaleni_komentar"]');
            break;
          case 'dodavatel_nazev':
            element = document.querySelector('input[name="dodavatel_nazev"]');
            break;
          case 'dodavatel_adresa':
            element = document.querySelector('input[name="dodavatel_adresa"]');
            break;
          case 'dodavatel_ico':
            element = document.querySelector('input[name="dodavatel_ico"]');
            break;
          case 'druh_objednavky_kod':
            element = document.querySelector('[data-field="druh_objednavky_kod"]');
            break;
          case 'polozky_objednavky':
            // Najdi prvnÃ­ nevalidnÃ­ poloÅ¾ku
            const polozkyKeys = Object.keys(errors).filter(k => k.startsWith('polozka_'));
            if (polozkyKeys.length > 0) {
              const firstPolozkaError = polozkyKeys[0];
              const index = parseInt(firstPolozkaError.split('_')[1]);
              element = document.querySelector(`[data-polozka-index="${index}"]`);
              if (!element) {
                // Fallback - najdi sekci s poloÅ¾kami
                element = document.querySelector('[data-section="detaily"]');
              }
            }
            break;
          case 'zpusob_financovani':
            element = document.querySelector('[data-field="zpusob_financovani"]');
            break;
          case 'lp_kod':
            element = document.querySelector('[data-field="lp_kod"]');
            break;
          case 'datum_odeslani':
            element = document.querySelector('input[name="datum_odeslani"]');
            break;
          case 'dodavatel_zpusob_potvrzeni':
            element = document.querySelector('[name="dodavatel_zpusob_potvrzeni"]');
            break;
          case 'zpusob_platby':
            element = document.querySelector('[name="zpusob_platby"]');
            break;
          case 'dt_akceptace':
            element = document.querySelector('input[name="dt_akceptace"]');
            break;
          case 'dt_zverejneni':
            // DatePicker nemÃ¡ input s name, ale mÃ¡ fieldName prop - najdi button
            element = document.querySelector('[data-field="dt_zverejneni"]') ||
                      document.querySelector('button[data-datepicker="dt_zverejneni"]');
            break;
          case 'registr_iddt':
            element = document.querySelector('input[name="registr_iddt"]');
            break;
          default:
            // Fallback - hledej podle nÃ¡zvu pole
            element = document.querySelector(`[name="${field}"], [data-field="${field}"]`);
        }

        if (element) {
          // Najdi parent sekci a rozbal ji, pokud je sbalenÃ¡
          parentSection = element.closest('[data-section]');
          if (parentSection) {
            const sectionName = parentSection.getAttribute('data-section');
            if (sectionName && sectionStates[sectionName]) {
              // Sekce je sbalenÃ¡, rozbal ji
              setSectionStates(prev => ({ ...prev, [sectionName]: false }));

              // PoÄkej na rozbalenÃ­ a pak scrolluj
              setTimeout(() => {
                element.scrollIntoView({
                  behavior: 'smooth',
                  block: 'center',
                  inline: 'nearest'
                });

                // Pokus o focus s mÃ­rnÃ½m zpoÅ¾dÄ›nÃ­m
                setTimeout(() => {
                  try {
                    // Pro custom select komponenty, najdi input uvnitÅ™
                    const inputInside = element.querySelector('input');
                    if (inputInside) {
                      inputInside.focus();
                    } else {
                      element.focus();
                    }
                  } catch (e) {
                    // Focus mÅ¯Å¾e selhat u nÄ›kterÃ½ch komponent
                  }
                }, 300);
              }, 300);
              break;
            }
          }

          // Sekce je jiÅ¾ rozbalenÃ¡, scrolluj ihned
          element.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'nearest'
          });

          // Pokus o focus s mÃ­rnÃ½m zpoÅ¾dÄ›nÃ­m
          setTimeout(() => {
            try {
              // Pro custom select komponenty, najdi input uvnitÅ™
              const inputInside = element.querySelector('input');
              if (inputInside) {
                inputInside.focus();
              } else {
                element.focus();
              }
            } catch (e) {
              // Focus mÅ¯Å¾e selhat u nÄ›kterÃ½ch komponent
            }
          }, 300);
          break;
        }
      }
    }
  };

  const handleSaveOrder = async () => {
    // Vymazat debug konzoli pÅ™ed uloÅ¾enÃ­m
    clearDebugLogs();
    addDebugLog('info', 'SAVE', 'order-save-start', 'ZaÄÃ­nÃ¡m uklÃ¡dÃ¡nÃ­ objednÃ¡vky...');

    // âŒ REMOVED: setValidationErrors({}) - neÄistit chyby pÅ™ed validacÃ­!
    // Validace se provede v saveOrderToAPI() a chyby se nastavÃ­ tam

    // Zavolej naÅ¡i API funkci
    await saveOrderToAPI();
  };

  // ====================== Å ABLONY - POKROÄŒILÃ‰ FUNKCE ======================

  // KopÃ­rovÃ¡nÃ­ pÅ™eddefinovanÃ© Å¡ablony do uÅ¾ivatelskÃ½ch Å¡ablon
  const copyPredefinedToUser = async (predefinedEntry) => {
    if (!token || !user_id || !predefinedEntry) {
      return;
    }

    try {
      const templateData = predefinedEntry.data || {};
      const templateName = predefinedEntry.name || predefinedEntry.dbName || 'Kopie Å¡ablony';
      const copyName = `${templateName} (kopie)`;

      // PÅ™Ã­prava dat pro API
      const polozky_po = (templateData.poApproval) ? JSON.stringify(templateData.poApproval) : '';
      const polozky_detail = (templateData.orderDetails) ? JSON.stringify(templateData.orderDetails) : '';

      // UrÄenÃ­ typu Å¡ablony
      const typ = predefinedEntry.type?.toString().toUpperCase() || 'OBEJD';

      const resp = await createTemplate({
        username: user?.username || username,
        token,
        user_id: user_id || 0,
        nazev_sablony: copyName,
        polozky_po,
        polozky_detail,
        typ,
        kategorie: 'OBJEDNAVKA25'
      });

      if (resp && (resp.success || resp.status === 'ok')) {
        const created = resp.data || resp || {};
        const entry = {
          name: copyName,
          data: templateData,
          ts: Date.now(),
          type: typ === 'PO' ? 'po' : (typ === 'DETAIL' ? 'details' : 'mixed'),
          id: created.id || created.insertId,
          user_id: user_id,
          __fromServer: true
        };

        // PÅ™idat do uÅ¾ivatelskÃ½ch Å¡ablon
        setSavedTemplates(prev => {
          const existing = Array.isArray(prev) ? prev : [];
          const filtered = existing.filter(e => (e.name || '').trim().toLowerCase() !== copyName.trim().toLowerCase());
          const updatedTemplates = [entry, ...filtered].slice(0, 200);

          // UloÅ¾it do localStorage
          try {
            const key = user_id ? `order_templates_${user_id}` : 'order_templates';
            localStorage.setItem(key, JSON.stringify(updatedTemplates));
          } catch (error) {
          }

          return updatedTemplates;
        });

        logTemplateAction('copy', { originalName: templateName, copyName, type: typ.toLowerCase(), mode: 'server' });

        if (showToast) {
          showToast(`Å ablona "${templateName}" byla zkopÃ­rovÃ¡na jako "${copyName}"`, { type: 'success' });
        }

        return entry;
      }
    } catch (err) {
      if (showToast) {
        showToast(`Chyba pÅ™i kopÃ­rovÃ¡nÃ­ Å¡ablony: ${err?.message || 'NeznÃ¡mÃ¡ chyba'}`, { type: 'error' });
      }
    }
  };

  // KopÃ­rovÃ¡nÃ­ uÅ¾ivatelskÃ© Å¡ablony do globÃ¡lnÃ­ch Å¡ablon (jen pro TEMPLATE_MANAGE)
  const copyUserTemplateToGlobal = async (userEntry) => {
    if (!userEntry || !token || !user_id) {
      return;
    }

    try {
      const templateName = userEntry.name || userEntry.dbName || 'Kopie uÅ¾ivatelskÃ© Å¡ablony';
      const globalName = `${templateName} (GLO)`;

      // UrÄit typ Å¡ablony
      const data = userEntry.data || {};
      const hasPo = data.poApproval && Object.keys(data.poApproval).length > 0;
      const hasDet = data.orderDetails && Object.keys(data.orderDetails).length > 0;
      let typ = 'PO';
      if (hasPo && hasDet) typ = 'PO+detail';
      else if (hasDet) typ = 'detail';

      const result = await createTemplate({
        username: user?.username || username,
        token,
        user_id: 0, // GlobÃ¡lnÃ­ Å¡ablona (user_id = 0)
        nazev_sablony: globalName,
        polozky_po: hasPo ? JSON.stringify(data.poApproval) : '',
        polozky_detail: hasDet ? JSON.stringify(data.orderDetails) : '',
        typ: typ.toLowerCase(),
        kategorie: 'OBJEDNAVKA25'
      });

      if (result?.status === 'ok') {

        // Refresh Å¡ablon pro aktualizaci
        await fetchAndMergeTemplates();

        logTemplateAction('copyToGlobal', { originalName: templateName, globalName, type: typ.toLowerCase(), mode: 'global' });

        if (showToast) {
          showToast(`Å ablona "${templateName}" byla zkopÃ­rovÃ¡na do globÃ¡lnÃ­ch jako "${globalName}"`, { type: 'success' });
        }
      } else {
        const errorMsg = result?.message || result?.data?.message || 'NepodaÅ™ilo se zkopÃ­rovat Å¡ablonu do globÃ¡lnÃ­ch';
        throw new Error(errorMsg);
      }
    } catch (err) {
      if (showToast) {
        showToast(`Chyba pÅ™i kopÃ­rovÃ¡nÃ­ do globÃ¡lnÃ­ch Å¡ablon: ${err?.message || 'NeznÃ¡mÃ¡ chyba'}`, { type: 'error' });
      }
    }
  };

  // PotvrzenÃ­ mazÃ¡nÃ­ Å¡ablony
  const confirmDeleteSavedTemplate = () => {
    if (!templatePendingDelete) return;

    try {
      const target = templatePendingDelete;

      // Pokud je Å¡ablona na serveru, smaÅ¾ ji tam
      if (target && (target.__fromServer || target.id) && token && username) {
        (async () => {
          try {
            const payloadUserId = (target && (target.user_id !== undefined && target.user_id !== null)) ? target.user_id : (user_id || 0);

            // Pokud mazÃ¡nÃ­ globÃ¡lnÃ­ Å¡ablony (user_id === 0), zkontroluj prÃ¡va
            if (Number(payloadUserId) === 0 && (!hasPermission || !hasPermission('TEMPLATE_MANAGE'))) {
              if (showToast) {
                showToast('NemÃ¡te oprÃ¡vnÄ›nÃ­ smazat pÅ™eddefinovanou Å¡ablonu.', { type: 'error' });
              }
              return;
            }

            const resp = await deleteTemplate({
              username: user?.username || username,
              token,
              user_id: payloadUserId || 0,
              id: target.id
            });

            const serverStatus = resp && resp.data && (resp.data.status || resp.data.result || (resp.data.ok ? 'ok' : null));
            const serverData = resp && resp.data && (resp.data.data || resp.data);
            const isDeleted = serverStatus && String(serverStatus).toLowerCase() === 'ok' && serverData && (serverData.deleted === true || serverData.deleted === 'true');

            if (isDeleted || resp?.success || resp?.status === 'ok') {
              // Odstranit ze serverTemplates pokud je tam
              setServerTemplates(prev => Array.isArray(prev) ? prev.filter(p => String(p.id) !== String(target.id)) : prev);

              // Odstranit z uÅ¾ivatelskÃ½ch Å¡ablon
              setSavedTemplates(prev => {
                const updatedTemplates = prev.filter(e => !(e.id && target.id && String(e.id) === String(target.id)));
                // UloÅ¾it do localStorage
                try {
                  const key = user_id ? `order_templates_${user_id}` : 'order_templates';
                  localStorage.setItem(key, JSON.stringify(updatedTemplates));
                } catch (error) {
                }
                return updatedTemplates;
              });

              logTemplateAction('delete', { name: target?.name, id: target?.id, mode: 'server' });

              if (showToast) {
                showToast('Å ablona byla smazÃ¡na.', { type: 'success' });
              }
            } else {
              throw new Error('SmazÃ¡nÃ­ na serveru se nezdaÅ™ilo');
            }
          } catch (err) {

            // Fallback na lokÃ¡lnÃ­ mazÃ¡nÃ­
            setSavedTemplates(prev => {
              const updatedTemplates = prev.filter(e => !(e.ts === target.ts && e.name === target.name));
              // UloÅ¾it do localStorage
              try {
                const key = user_id ? `order_templates_${user_id}` : 'order_templates';
                localStorage.setItem(key, JSON.stringify(updatedTemplates));
              } catch (error) {
              }
              return updatedTemplates;
            });

            if (showToast) {
              showToast(`SmazÃ¡nÃ­ Å¡ablony selhalo: ${err?.message || 'Chyba serveru'}`, { type: 'error' });
            }
          }
        })();
      } else {
        // Pouze lokÃ¡lnÃ­ Å¡ablona
        setSavedTemplates(prev => {
          const updatedTemplates = prev.filter(e => !(e.ts === templatePendingDelete.ts && e.name === templatePendingDelete.name));
          // UloÅ¾it do localStorage
          try {
            const key = user_id ? `order_templates_${user_id}` : 'order_templates';
            localStorage.setItem(key, JSON.stringify(updatedTemplates));
          } catch (error) {
          }
          return updatedTemplates;
        });

        logTemplateAction('delete', { name: templatePendingDelete?.name, ts: templatePendingDelete?.ts, mode: 'local' });
      }
    } finally {
      setShowDeleteTemplateConfirm(false);
      setTemplatePendingDelete(null);
    }
  };

  // ZruÅ¡enÃ­ mazÃ¡nÃ­ Å¡ablony
  const cancelDeleteSavedTemplate = () => {
    setShowDeleteTemplateConfirm(false);
    setTemplatePendingDelete(null);
  };

  // ZaÄÃ¡tek editace nÃ¡zvu Å¡ablony
  const startEditingTemplateName = (template) => {
    setEditingTemplateId(template.id || template.ts);
    setEditingTemplateName(template.name || '');
  };

  // ZruÅ¡enÃ­ editace nÃ¡zvu Å¡ablony
  const cancelEditingTemplateName = () => {
    setEditingTemplateId(null);
    setEditingTemplateName('');
  };

  // UloÅ¾enÃ­ novÃ©ho nÃ¡zvu Å¡ablony
  const saveTemplateName = async (template) => {
    if (!editingTemplateName.trim()) {
      if (showToast) {
        showToast('NÃ¡zev Å¡ablony nemÅ¯Å¾e bÃ½t prÃ¡zdnÃ½', { type: 'error' });
      }
      return;
    }

    try {
      const newName = editingTemplateName.trim();

      if (template.__fromServer && template.id) {
        // ServerovÃ¡ Å¡ablona - aktualizace na serveru

        const result = await updateTemplate({
          username: user?.username || username,
          token,
          user_id: template.user_id || 0, // Zachovej pÅ¯vodnÃ­ user_id Å¡ablony
          id: template.id,
          nazev_sablony: newName,
          kategorie: "OBJEDNAVKA25"
        });

        if (result?.status === 'ok' && result?.data?.updated) {

          // Refresh Å¡ablon pro aktualizaci
          await fetchAndMergeTemplates();

          logTemplateAction('rename', { oldName: template.name, newName, id: template.id, mode: 'server' });

          if (showToast) {
            showToast(`Å ablona pÅ™ejmenovÃ¡na na "${newName}"`, { type: 'success' });
          }
        } else {
          const errorMsg = result?.message || result?.data?.message || 'NepodaÅ™ilo se pÅ™ejmenovat Å¡ablonu na serveru';
          throw new Error(errorMsg);
        }
      } else {
        // LokÃ¡lnÃ­ Å¡ablona - aktualizace v localStorage
        setSavedTemplates(prev => {
          const updated = prev.map(t => {
            if ((t.id && template.id && String(t.id) === String(template.id)) ||
                (t.ts === template.ts && t.name === template.name)) {
              return { ...t, name: newName };
            }
            return t;
          });

          // UloÅ¾it do localStorage
          try {
            const key = user_id ? `order_templates_${user_id}` : 'order_templates';
            localStorage.setItem(key, JSON.stringify(updated));
          } catch (error) {
          }

          return updated;
        });

        logTemplateAction('rename', { oldName: template.name, newName, mode: 'local' });

        if (showToast) {
          showToast(`Å ablona pÅ™ejmenovÃ¡na na "${newName}"`, { type: 'success' });
        }
      }

      // Reset editace
      setEditingTemplateId(null);
      setEditingTemplateName('');

    } catch (err) {
      if (showToast) {
        showToast(`Chyba pÅ™i pÅ™ejmenovÃ¡nÃ­ Å¡ablony: ${err?.message || 'NeznÃ¡mÃ¡ chyba'}`, { type: 'error' });
      }
    }
  };

  // ====================== Å ABLONY - HLAVNÃ FUNKCE ======================

  // NaÄÃ­tÃ¡nÃ­ Å¡ablon ze serveru
  const fetchAndMergeTemplates = async () => {
    if (!token || !user_id) return;

    setTemplatesLoading(true);
    try {

      // ZkusÃ­me nejprve OBJEDNAVKA25, pokud nebudou vÃ½sledky, zkusÃ­me OBJEDNAVKA
      let response = await fetchTemplatesListWithMeta({
        username: user?.username || username,
        token,
        user_id: user_id || 0,
        kategorie: 'OBJEDNAVKA25', // DÅ®LEÅ½ITÃ‰: Pro novÃ© objednÃ¡vky pouÅ¾Ã­vÃ¡me kategorii OBJEDNAVKA25
        debug: true // PÅ™idÃ¡me debug parameter jako v pÅ¯vodnÃ­ implementaci
      });

      // Pro OrderForm25 pouÅ¾Ã­vÃ¡me vÃ½hradnÄ› OBJEDNAVKA25 kategorie - bez fallbacku na OBJEDNAVKA

      // ZpracovÃ¡nÃ­ odpovÄ›di podle pÅ¯vodnÃ­ logiky z OrderFormComponent
      let templates = [];
      if (Array.isArray(response?.items)) {
        templates = response.items;
      } else if (Array.isArray(response?.data)) {
        templates = response.data;
      } else if (response?.success && Array.isArray(response?.data)) {
        templates = response.data;
      }

      if (templates.length > 0) {
        // RozdÄ›lenÃ­ Å¡ablon na serverovÃ© a uÅ¾ivatelskÃ©
        const serverTpls = templates.filter(t => t.user_id === 0 || String(t.user_id) === '0');
        const userTpls = templates.filter(t => t.user_id !== 0 && String(t.user_id) !== '0');

        // ZpracovÃ¡nÃ­ serverovÃ½ch Å¡ablon s nÃ¡zvy podle pÅ¯vodnÃ­ logiky
        const processedServerTemplates = serverTpls.map(t => {
          const name = t.nazev_sablony || t.nazev || t.name || `sablona-${t.id}`;
          const ts = t.dt_aktualizace || t.dt_vytvoreni || Date.now();
          const data = parseTemplateData(t);

          // UrÄenÃ­ typu Å¡ablony podle pÅ¯vodnÃ­ logiky
          const rawTyp = (t.typ || t.type || '');
          const rawTypStr = (typeof rawTyp === 'string' ? rawTyp : String(rawTyp || '')).trim().toLowerCase();
          let serverType = null;
          if (rawTypStr) {
            if (rawTypStr === 'po' || rawTypStr === 'p_o' || rawTypStr === 'p.o' || rawTypStr === 'p') serverType = 'PO';
            else if (rawTypStr === 'detail' || rawTypStr === 'det' || rawTypStr === 'details') serverType = 'DETAIL';
            else if (rawTypStr === 'obejd' || rawTypStr === 'po+detail' || rawTypStr === 'po_detail' || rawTypStr === 'both') serverType = 'OBEJD';
            else {
              // Heuristika: obsahuje klÃ­ÄovÃ¡ slova
              if (rawTypStr.includes('po') && rawTypStr.includes('detail')) serverType = 'OBEJD';
              else if (rawTypStr.includes('po')) serverType = 'PO';
              else if (rawTypStr.includes('det')) serverType = 'DETAIL';
            }
          }

          // Pokud typ nenÃ­ urÄen ze serveru, odvoÄ z dat
          const type = serverType || ((data.poApproval && data.orderDetails) ? 'OBEJD' : (data.poApproval ? 'PO' : (data.orderDetails ? 'DETAIL' : 'PO')));

          return {
            ...t,
            name,
            dbName: t.nazev_sablony || null,
            ts: (new Date(ts)).getTime ? (new Date(ts)).getTime() : Date.now(),
            type,
            __fromServer: true,
            data
          };
        });

        setServerTemplates(processedServerTemplates);

        // ZpracovÃ¡nÃ­ uÅ¾ivatelskÃ½ch Å¡ablon s nÃ¡zvy
        const processedUserTemplates = userTpls.map(t => {
          const name = t.nazev_sablony || t.nazev || t.name || `sablona-${t.id}`;
          const ts = t.dt_aktualizace || t.dt_vytvoreni || Date.now();
          const data = parseTemplateData(t);

          // UrÄenÃ­ typu Å¡ablony podle pÅ¯vodnÃ­ logiky
          const rawTyp = (t.typ || t.type || '');
          const rawTypStr = (typeof rawTyp === 'string' ? rawTyp : String(rawTyp || '')).trim().toLowerCase();
          let serverType = null;
          if (rawTypStr) {
            if (rawTypStr === 'po' || rawTypStr === 'p_o' || rawTypStr === 'p.o' || rawTypStr === 'p') serverType = 'PO';
            else if (rawTypStr === 'detail' || rawTypStr === 'det' || rawTypStr === 'details') serverType = 'DETAIL';
            else if (rawTypStr === 'obejd' || rawTypStr === 'po+detail' || rawTypStr === 'po_detail' || rawTypStr === 'both') serverType = 'OBEJD';
            else {
              // Heuristika: obsahuje klÃ­ÄovÃ¡ slova
              if (rawTypStr.includes('po') && rawTypStr.includes('detail')) serverType = 'OBEJD';
              else if (rawTypStr.includes('po')) serverType = 'PO';
              else if (rawTypStr.includes('det')) serverType = 'DETAIL';
            }
          }

          // Pokud typ nenÃ­ urÄen ze serveru, odvoÄ z dat
          const type = serverType || ((data.poApproval && data.orderDetails) ? 'OBEJD' : (data.poApproval ? 'PO' : (data.orderDetails ? 'DETAIL' : 'PO')));

          return {
            ...t,
            name,
            dbName: t.nazev_sablony || null,
            ts: (new Date(ts)).getTime ? (new Date(ts)).getTime() : Date.now(),
            type,
            __fromServer: true,
            data
          };
        });

        setSavedTemplates(processedUserTemplates);

        // UloÅ¾it uÅ¾ivatelskÃ© Å¡ablony do localStorage pro cache
        try {
          const key = user_id ? `order_templates_${user_id}` : 'order_templates';
          localStorage.setItem(key, JSON.stringify(processedUserTemplates));

        } catch (error) {
        }

        // Debug: ukÃ¡zat zpracovanÃ© nÃ¡zvy Å¡ablon - nynÃ­ skryto pro produkci

        setTemplatesFetchStatus({
          status: response?.status || 'success',
          error: response?.error || null,
          raw: response?.raw || null
        });
        logTemplateAction('fetch', { count: templates.length, serverCount: processedServerTemplates.length, userCount: processedUserTemplates.length });
      } else {
        setTemplatesFetchStatus({
          status: response?.status || 'empty',
          error: response?.error || 'Å½Ã¡dnÃ© Å¡ablony nenalezeny',
          raw: response?.raw || null
        });
      }
    } catch (error) {
      setTemplatesFetchStatus({ status: 'error', error: error.message });
    } finally {
      setTemplatesLoading(false);
    }
  };

  // ParsovÃ¡nÃ­ dat Å¡ablony z DB podle pÅ¯vodnÃ­ logiky z OrderFormComponent
  const parseTemplateData = (template) => {
    try {
      // Helper funkce pro bezpeÄnÃ© parsovÃ¡nÃ­ template polÃ­ (pÅ™evzato z OrderFormComponent)
      const safeParseTemplateField = (val) => {
        if (val === null || val === undefined) return null;
        if (typeof val !== 'string') return val;
        const raw = val.trim();
        if (!raw) return null;

        // ZkusÃ­me pÅ™Ã­mÃ½ JSON parse
        try { return JSON.parse(raw); } catch (e) {}

        // Normalizace: odstranÄ›nÃ­ novÃ½ch Å™Ã¡dkÅ¯, trim
        let s = raw.replace(/\r?\n/g, ' ').trim();

        // Quote unquoted object keys: {key: -> {"key": a takÃ© po ÄÃ¡rkÃ¡ch
        try {
          s = s.replace(/([\{,\s])(\w[\w\-]*)\s*:/g, '$1"$2":');
        } catch (e) {}

        // NahrazenÃ­ single quotes za double quotes
        s = s.replace(/'/g, '"');

        // ZkusÃ­me parsovat normalizovanÃ½ string
        try { return JSON.parse(s); } catch (e) {}

        // PoslednÃ­ moÅ¾nost: evaluace JS-like objektu pomocÃ­ Function
        try {
          // eslint-disable-next-line no-new-func
          const fn = new Function('return (' + raw + ');');
          return fn();
        } catch (e) {
          return null;
        }
      };

      const rawPo = template.polozky_po ? safeParseTemplateField(template.polozky_po) : null;
      const rawDetail = template.polozky_detail ? safeParseTemplateField(template.polozky_detail) : null;

      // Helper: expand flat/dotted keys do nested object struktury
      const expandFlatKeys = (obj) => {
        if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return obj;
        const out = {};
        Object.keys(obj).forEach(k => {
          const val = obj[k];
          if (k.includes('.')) {
            const parts = k.split('.');
            let cur = out;
            parts.forEach((p, idx) => {
              if (idx === parts.length - 1) {
                cur[p] = val;
              } else {
                if (!cur[p] || typeof cur[p] !== 'object') cur[p] = {};
                cur = cur[p];
              }
            });
          } else {
            // Merge objects if needed
            if (typeof val === 'object' && val !== null && !Array.isArray(val) && typeof out[k] === 'object') {
              out[k] = { ...out[k], ...val };
            } else {
              out[k] = val;
            }
          }
        });
        return out;
      };

      const parsedPo = rawPo ? expandFlatKeys(rawPo) : null;
      const parsedDetail = rawDetail ? expandFlatKeys(rawDetail) : null;

      const data = {};
      if (parsedPo) data.poApproval = parsedPo;
      if (parsedDetail) data.orderDetails = parsedDetail;

      return data;
    } catch (error) {
      return {};
    }
  };

  // NaÄÃ­tÃ¡nÃ­ PO ze Å¡ablony
  const fillPoApprovalSaved = (entry) => {
    if (currentPhase >= 2) return; // Nelze mÄ›nit PO po schvÃ¡lenÃ­

    const data = entry?.data;
    if (data?.poApproval) {
      const prev = { ...formData };
      const next = {
        ...prev,
        ...data.poApproval,
        // Zachovat ID a evidenÄnÃ­ ÄÃ­slo
        id: prev.id,
        ev_cislo: prev.ev_cislo
      };

      setFormData(next);
      logTemplateAction('apply-po', {
        name: entry.name,
        source: 'saved',
        ts: entry.ts,
        preview: compactTemplatePreview(data)
      });

      // ðŸ”„ KRITICKÃ‰: Po naÄtenÃ­ Å¡ablony POVOLIT autosave a okamÅ¾itÄ› uloÅ¾it draft
      draftManager.setAutosaveEnabled(true); // âœ… Povolit autosave

      // âœ… SYNCHRONNÃ volÃ¡nÃ­ saveDraft s pÅ™edanÃ½mi daty (bez setTimeout)
      saveDraft(true, false, next).catch(e => {
      });
    }
  };

  // Helper: MapovÃ¡nÃ­ polÃ­ na sekce (FÃZE 2)
  const getFieldsForSections = () => ({
    financovani: [
      'zpusob_financovani', 'financovani', 'lp_kod', 'cislo_smlouvy', 'smlouva_poznamka',
      'individualni_schvaleni', 'individualni_poznamka', 'pojistna_udalost_cislo', 'pojistna_udalost_poznamka'
    ],
    dodavatel: [
      'dodavatel_id', 'dodavatel_nazev', 'dodavatel_adresa', 'dodavatel_ico',
      'dodavatel_dic', 'dodavatel_zastoupeny'
    ],
    kontakt: [
      'dodavatel_kontakt_jmeno', 'dodavatel_kontakt_email', 'dodavatel_kontakt_telefon'
    ],
    detaily: [
      'druh_objednavky', 'druh_objednavky_kod', 'poznamka_objednavky'
    ],
    dodaci_podminky: [
      'dt_predpokladany_termin_dodani', 'misto_dodani', 'zaruka'
    ],
    polozky: ['polozky_objednavky'] // SpeciÃ¡lnÃ­ pole - poloÅ¾ky objednÃ¡vky
  });

  // NaÄÃ­tÃ¡nÃ­ detailÅ¯ ze Å¡ablony - respektuje viditelnost sekcÃ­ podle fÃ¡ze
  const fillAllFieldsSaved = (entry) => {
    if (currentPhase < 2) return; // Detaily lze plnit aÅ¾ po schvÃ¡lenÃ­

    const data = entry?.data;
    if (!data?.orderDetails) {
      return;
    }

    // Zjistit, kterÃ© sekce jsou viditelnÃ© v aktuÃ¡lnÃ­ fÃ¡zi
    const visibility = getSectionVisibility(mainWorkflowState, currentPhase, isArchived);
    const fieldMap = getFieldsForSections();

    const prev = { ...formData };
    const next = { ...prev };

    // Naplnit pouze pole z viditelnÃ½ch sekcÃ­
    Object.entries(fieldMap).forEach(([sectionKey, fields]) => {
      // Zkontrolovat, zda je sekce viditelnÃ¡ (kromÄ› poloÅ¾ek, kterÃ© majÃ­ speciÃ¡lnÃ­ kontrolu)
      const isSectionVisible = sectionKey === 'polozky' ? visibility.detaily : visibility[sectionKey];

      if (isSectionVisible) {
        fields.forEach(field => {
          if (data.orderDetails[field] !== undefined) {
            next[field] = data.orderDetails[field];
          }
        });
      }
    });

    // PÅ™idÃ¡nÃ­ poloÅ¾ek pokud jsou v Å¡ablonÄ› a sekce detaily je viditelnÃ¡
    if (visibility.detaily && Array.isArray(data.polozky) && data.polozky.length > 0) {
      next.polozky_objednavky = data.polozky;
    }

    // Zachovat PO data a ID (vÅ¾dy)
    next.predmet = prev.predmet;
    next.prikazce_id = prev.prikazce_id;
    next.max_cena_s_dph = prev.max_cena_s_dph;
    next.strediska_kod = prev.strediska_kod;
    next.garant_uzivatel_id = prev.garant_uzivatel_id;
    next.id = prev.id;
    next.ev_cislo = prev.ev_cislo;

    // âœ… Zachovat financovÃ¡nÃ­ (souÄÃ¡st PO sekce ve FÃZI 1)
    next.zpusob_financovani = prev.zpusob_financovani;
    next.lp_kod = prev.lp_kod;
    next.cislo_smlouvy = prev.cislo_smlouvy;
    next.smlouva_poznamka = prev.smlouva_poznamka;
    next.individualni_schvaleni = prev.individualni_schvaleni;
    next.individualni_poznamka = prev.individualni_poznamka;
    next.pojistna_udalost_cislo = prev.pojistna_udalost_cislo;
    next.pojistna_udalost_poznamka = prev.pojistna_udalost_poznamka;

    setFormData(next);
    logTemplateAction('apply-details', {
      name: entry.name,
      source: 'saved',
      ts: entry.ts,
      preview: compactTemplatePreview(data),
      appliedSections: Object.keys(fieldMap).filter(k => k === 'polozky' ? visibility.detaily : visibility[k])
    });

    // ðŸ”„ KRITICKÃ‰: Po naÄtenÃ­ Å¡ablony POVOLIT autosave a okamÅ¾itÄ› uloÅ¾it draft
    draftManager.setAutosaveEnabled(true); // âœ… Povolit autosave

    // âœ… SYNCHRONNÃ volÃ¡nÃ­ saveDraft s pÅ™edanÃ½mi daty (bez setTimeout)
    saveDraft(true, false, next).catch(e => {
    });

  };

  // UloÅ¾enÃ­ Å¡ablony
  const saveTemplateToStorage = async (name, data, type) => {
    if (!token || !user_id) {
      return;
    }

    try {
      // PÅ™Ã­prava dat pro API
      const polozky_po = (type === 'po' || type === 'mixed') && data.poApproval
        ? JSON.stringify(data.poApproval)
        : '';
      const polozky_detail = (type === 'details' || type === 'mixed') && data.orderDetails
        ? JSON.stringify(data.orderDetails)
        : '';

      const typ = type === 'po' ? 'PO' : type === 'details' ? 'DETAIL' : 'OBEJD';

      const response = await createTemplate({
        username: user?.username || username,
        token,
        user_id: user_id || 0,
        nazev_sablony: name,
        polozky_po,
        polozky_detail,
        typ,
        kategorie: 'OBJEDNAVKA25' // DÅ®LEÅ½ITÃ‰: Pro novÃ© objednÃ¡vky
      });

      if (response?.success || response?.status === 'ok') {
        // Aktualizace lokÃ¡lnÃ­ho stavu
        const newTemplate = {
          name,
          data,
          ts: Date.now(),
          type,
          id: response.insertId || response.id || response.data?.id,
          user_id,
          __fromServer: true
        };

        setSavedTemplates(prev => {
          const updatedTemplates = [newTemplate, ...prev];
          // UloÅ¾it do localStorage
          try {
            const key = user_id ? `order_templates_${user_id}` : 'order_templates';
            localStorage.setItem(key, JSON.stringify(updatedTemplates));
          } catch (error) {
          }
          return updatedTemplates;
        });

        logTemplateAction('save', { name, type, mode: 'server' });

        if (showToast) {
          showToast(`Å ablona "${name}" byla uloÅ¾ena`, { type: 'success' });
        }
      } else {
        const errorMsg = response?.message || response?.data?.message || 'Chyba pÅ™i uklÃ¡dÃ¡nÃ­';
        throw new Error(errorMsg);
      }
    } catch (error) {
      if (showToast) {
        showToast(`Chyba pÅ™i uklÃ¡dÃ¡nÃ­ Å¡ablony: ${error.message}`, { type: 'error' });
      }
    }
  };

  // Funkce pro ovlÃ¡dÃ¡nÃ­ vlastnÃ­ch selectÅ¯
  const toggleSelect = (selectName) => {
    setSelectStates(prev => {
      // ZavÅ™i vÅ¡echny selecty
      const newState = {
        garant: false,
        prikazce: false,
        strediska: false,
        financovani: false,
      };
      // OtevÅ™i pouze vybranÃ½ select (pokud byl zavÅ™enÃ½)
      newState[selectName] = !prev[selectName];
      return newState;
    });
  };

  const closeAllSelects = () => {
    setSelectStates({
      garant: false,
      prikazce: false,
      strediska: false,
      financovani: false,
      lp_kod: false,
    });
  };

  // Funkce pro filtraci moÅ¾nostÃ­ podle vyhledÃ¡vÃ¡nÃ­
  const filterOptions = (options, searchTerm, searchField) => {
    if (!searchTerm) return options;
    return options.filter(option => {
      const label = getOptionLabel(option, searchField);
      return label.toLowerCase().includes(searchTerm.toLowerCase());
    });
  };

  // Funkce pro zÃ­skÃ¡nÃ­ labelu moÅ¾nosti
  const getOptionLabel = useCallback((option, field) => {
    if (!option) return '';

    switch (field) {
      case 'garant':
        return `${option.titul_pred ? option.titul_pred + ' ' : ''}${option.jmeno || ''} ${option.prijmeni || ''}${option.titul_za ? ', ' + option.titul_za : ''}`.replace(/\s+/g, ' ').trim();
      case 'prikazce':
        // Pokud je option null, 0 nebo prÃ¡zdnÃ© ID, vraÅ¥ "NeznÃ¡mÃ½"
        if (!option || option === 0 || option.id === 0 || option.user_id === 0 || option.id === null || option.user_id === null) {
          return 'NeznÃ¡mÃ½';
        }
        const fullName = `${option.titul_pred ? option.titul_pred + ' ' : ''}${option.jmeno || ''} ${option.prijmeni || ''}${option.titul_za ? ', ' + option.titul_za : ''}`.replace(/\s+/g, ' ').trim();
        return fullName || 'NeznÃ¡mÃ½';
      case 'strediska':
      case 'strediska_kod':
        // Pro hierarchickÃ© stÅ™ediska pouÅ¾ij label (uÅ¾ obsahuje odsazenÃ­)
        if (option.label) {
          return option.label;
        }
        // Fallback pro pÅ¯vodnÃ­ formÃ¡t
        return option.name || option.nazev_stavu || option.toString();
      case 'financovani':
      case 'zpusob_financovani':
        // âš ï¸ OPRAVA: PouÅ¾Ã­vat nazev_stavu stejnÄ› jako u stÅ™edisek
        return option.nazev_stavu || option.nazev || option.label || (typeof option === 'string' ? option : 'NeznÃ¡mÃ½');
      case 'lp_kod':
        // ðŸ†• OPRAVA: PouÅ¾Ã­t cislo_lp a nazev_uctu mÃ­sto kod a nazev
        return option.cislo_lp
          ? `${option.cislo_lp} - ${option.nazev_uctu || 'Bez nÃ¡zvu'}`
          : `${option.id || option} - ${option.nazev_uctu || option.nazev || option.label || 'Bez nÃ¡zvu'}`;
      case 'druh_objednavky_kod':
        // âš ï¸ OPRAVA: PouÅ¾Ã­vat nazev_stavu stejnÄ› jako u stÅ™edisek
        return option.nazev_stavu || option.nazev || option.label || (typeof option === 'string' ? option : 'NeznÃ¡mÃ½');
      // Pro Orders25List compatibility
      case 'statusFilter':
        return option.nazev_stavu || option.nazev || option.popis || option.kod_stavu || option.kod || String(option);
      case 'selectedObjednatel':
      case 'selectedGarant':
        return option.displayName || `${option.jmeno || ''} ${option.prijmeni || ''}`.trim() || 'Bez jmÃ©na';
      case 'selectedSchvalovatel':
        // Pokud je option null, 0 nebo prÃ¡zdnÃ© ID, vraÅ¥ "NeznÃ¡mÃ½"
        if (!option || option === 0 || option.id === 0 || option.user_id === 0 || option.id === null || option.user_id === null) {
          return 'NeznÃ¡mÃ½';
        }
        return option.displayName || option.jmeno_prijmeni || `${option.jmeno || ''} ${option.prijmeni || ''}`.trim() || 'NeznÃ¡mÃ½';
      case 'pageSize':
        return option.label || String(option.value || option);
      default:
        // ðŸŽ¯ FALLBACK: Pokud field zaÄÃ­nÃ¡ na "polozka_" a konÄÃ­ na "_lp", je to LP poloÅ¾ky
        if (field && typeof field === 'string' && field.startsWith('polozka_') && field.endsWith('_lp')) {
          // LP pro poloÅ¾ky - pouÅ¾ij label nebo vytvoÅ™it z kod a nazev
          return option.label || (option.kod && option.nazev ? `${option.kod} - ${option.nazev}` : String(option));
        }
        // ObecnÃ½ fallback - pokud mÃ¡ option.label, pouÅ¾ij ho
        return option.label || (typeof option === 'string' ? option : String(option));
    }
  }, []); // Å½Ã¡dnÃ© dependencies - funkce je ÄistÄ› zÃ¡vislÃ¡ na vstupnÃ­ch parametrech

  // React komponenty pro vlastnÃ­ selecty
  // CustomSelect wrapper - pouÅ¾Ã­vÃ¡ globÃ¡lnÃ­ komponentu
  const CustomSelectLocal = (props) => (
    <CustomSelect
      {...props}
      selectStates={selectStates}
      setSelectStates={setSelectStates}
      searchStates={searchStates}
      setSearchStates={setSearchStates}
      touchedSelectFields={touchedSelectFields}
      setTouchedSelectFields={setTouchedSelectFields}
      hasTriedToSubmit={hasTriedToSubmit}
      toggleSelect={toggleSelect}
      filterOptions={filterOptions}
      getOptionLabel={getOptionLabel}
    />
  );

  // Multi-select komponenta pro stÅ™ediska
  const MultiSelect = ({
    values = [],
    onChange,
    options = [],
    placeholder,
    disabled = false,
    hasError = false,
    icon = null
  }) => {
    // Zajistit, Å¾e values je vÅ¾dy pole
    const safeValues = Array.isArray(values) ? values : [];
    const isOpen = selectStates.strediska;
    const searchTerm = searchStates.strediska;
    const dropdownRef = useRef(null);
    const buttonRef = useRef(null);
    const searchInputRef = useRef(null);

    const filteredOptions = filterOptions(options, searchTerm, 'strediska');

    // PozicovÃ¡nÃ­ pro fixed dropdown s optimalizovanÃ½m scroll handlerem
    useEffect(() => {
      if (isOpen && buttonRef.current && dropdownRef.current) {
        const updatePosition = () => {
          if (!buttonRef.current || !dropdownRef.current) return;
          const buttonRect = buttonRef.current.getBoundingClientRect();
          const dropdown = dropdownRef.current;

          const dropdownMaxHeight = 300;
          const footerHeight = 54; // VÃ½Å¡ka fixnÃ­ patiÄky
          const buffer = 20; // Extra buffer pro bezpeÄnost
          const spaceBelow = window.innerHeight - buttonRect.bottom - footerHeight - buffer;
          const spaceAbove = buttonRect.top - buffer;
          // OtevÅ™i nahoru pokud: nenÃ­ dost mÃ­sta dole NEBO je nahoÅ™e vÃ½raznÄ› vÃ­ce mÃ­sta
          const shouldOpenUpward = spaceBelow < 200 || (spaceBelow < dropdownMaxHeight && spaceAbove > spaceBelow + 50);

          dropdown.style.left = buttonRect.left + 'px';
          dropdown.style.width = buttonRect.width + 'px';
          dropdown.style.maxHeight = dropdownMaxHeight + 'px';

          if (shouldOpenUpward) {
            // OtevÅ™Ã­t nahoru
            dropdown.style.bottom = (window.innerHeight - buttonRect.top + 2) + 'px';
            dropdown.style.top = 'auto';
          } else {
            // OtevÅ™Ã­t dolÅ¯ (standardnÃ­ chovÃ¡nÃ­)
            dropdown.style.top = (buttonRect.bottom + 2) + 'px';
            dropdown.style.bottom = 'auto';
          }
        };

        updatePosition();

        const handleScroll = (event) => {
          // OPRAVA: Neaktualizovat pozici pÅ™i scrollu uvnitÅ™ dropdown menu
          if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
            // Pro scroll celÃ© strÃ¡nky - okamÅ¾itÃ¡ aktualizace bez throttling
            updatePosition();
          }
        };

        // PouÅ¾Ã­vat passive listener pro lepÅ¡Ã­ performance
        window.addEventListener('scroll', handleScroll, { passive: true, capture: true });
        window.addEventListener('resize', updatePosition, { passive: true });

        return () => {
          window.removeEventListener('scroll', handleScroll, { capture: true });
          window.removeEventListener('resize', updatePosition);
        };
      }
    }, [isOpen]);

    // Auto-focus search inputu pÅ™i otevÅ™enÃ­ (pouze prvnÃ­ otevÅ™enÃ­)
    useEffect(() => {
      if (isOpen && searchInputRef.current) {
        // MalÃ© zpoÅ¾dÄ›nÃ­ pro zajiÅ¡tÄ›nÃ­, Å¾e dropdown je uÅ¾ vyrendrovanÃ½
        // Ale pouze pokud nenÃ­ jiÅ¾ focused jinÃ½ element v dropdown
        setTimeout(() => {
          if (searchInputRef.current && !document.activeElement?.closest('[data-custom-select]')) {
            searchInputRef.current.focus();
          }
        }, 100);
      }
    }, [isOpen]);

    const displayValue = safeValues.length > 0
      ? safeValues.map(val => {
          const option = options.find(opt => opt.value === val || opt === val);
          return option ? getOptionLabel(option, 'strediska') : val;
        }).join(', ')
      : placeholder;

    const handleToggleOption = (option) => {
      const optionValue = option.value || option;
      const newValues = safeValues.includes(optionValue)
        ? safeValues.filter(v => v !== optionValue)
        : [...safeValues, optionValue];

      // Zachovat scroll pozici pÅ™ed zmÄ›nou
      const scrollPosition = dropdownRef.current?.scrollTop || 0;

      onChange({ target: { value: newValues } });

      // OPRAVA: Obnovit scroll pozici a focus bez skoku na zaÄÃ¡tek
      requestAnimationFrame(() => {
        if (dropdownRef.current) {
          dropdownRef.current.scrollTop = scrollPosition;
        }
        if (searchInputRef.current) {
          // Deaktivovat automatickÃ½ focus, kterÃ½ zpÅ¯sobuje problÃ©my
          // searchInputRef.current.focus();
        }
      });
    };

    return (
      <MultiSelectWrapper data-custom-select isOpen={isOpen}>
        <MultiSelectButton
          ref={buttonRef}
          onClick={() => !disabled && toggleSelect('strediska')}
          disabled={disabled}
          hasError={hasError}
          placeholder={safeValues.length === 0 ? "true" : "false"}
          value={safeValues.length > 0 ? 'selected' : ''}
          isOpen={isOpen}
          data-field="strediska"
          tabIndex={disabled ? -1 : 0}
          onKeyDown={(e) => {
            if (!disabled && e.key === 'Enter') {
              toggleSelect('strediska');
            }
          }}
          hasIcon={!!icon}
        >
          {icon && <span style={{
            position: 'absolute',
            left: '12px',
            color: '#9ca3af',
            width: '16px',
            height: '16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            {React.cloneElement(icon, { size: 16 })}
          </span>}
          <SelectedValue isEmpty={safeValues.length === 0} title={displayValue}>{displayValue}</SelectedValue>
        </MultiSelectButton>

        {isOpen && !disabled && (
          <CustomSelectDropdown ref={dropdownRef}>
            <SearchBox>
              <SearchIcon>
                <Search size={16} />
              </SearchIcon>
              <SearchInput
                ref={searchInputRef}
                type="text"
                placeholder="Vyhledat stÅ™edisko..."
                value={searchTerm}
                onChange={(e) => setSearchStates(prev => ({
                  ...prev,
                  strediska: e.target.value
                }))}
                onKeyDown={(e) => {
                  if (e.key === 'ArrowDown') {
                    // Å ipka dolÅ¯ - pÅ™ejdi na prvnÃ­ option
                    e.preventDefault();
                    if (filteredOptions.length > 0) {
                      const firstOption = dropdownRef.current?.querySelector('[role="option"]');
                      if (firstOption) {
                        firstOption.focus();
                      }
                    }
                  } else if (e.key === 'ArrowUp') {
                    // Å ipka nahoru - pÅ™ejdi na poslednÃ­ option
                    e.preventDefault();
                    if (filteredOptions.length > 0) {
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]') || []);
                      const lastOption = options[options.length - 1];
                      if (lastOption) {
                        lastOption.focus();
                      }
                    }
                  } else if (e.key === 'Tab') {
                    // Pokud je dropdown otevÅ™enÃ½, pÅ™ejdi na prvnÃ­ option mÃ­sto zavÅ™enÃ­
                    if (filteredOptions.length > 0) {
                      e.preventDefault();
                      const firstOption = dropdownRef.current?.querySelector('[class*="SelectOption"]');
                      if (firstOption) {
                        firstOption.focus();
                      }
                    } else {
                      // Pokud nejsou Å¾Ã¡dnÃ© options, zavÅ™i dropdown a pokraÄuj na dalÅ¡Ã­ prvek
                      toggleSelect('strediska');
                    }
                  } else if (e.key === 'Escape') {
                    e.preventDefault();
                    toggleSelect('strediska');
                  } else if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                  }
                }}
              />
            </SearchBox>

            {filteredOptions.map((option, index) => {
              const optionValue = option.value || option;
              const isChecked = safeValues.includes(optionValue);

              return (
                <MultiSelectOption
                  key={option.value || index}
                  level={option.level || 0}
                  tabIndex={0}
                  role="option"
                  aria-selected={isChecked}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleToggleOption(option);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      handleToggleOption(option);
                    } else if (e.key === 'ArrowDown') {
                      // Å ipka dolÅ¯ - pÅ™ejdi na dalÅ¡Ã­ option
                      e.preventDefault();
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]') || []);
                      const currentIdx = options.indexOf(e.target);
                      const nextIdx = currentIdx + 1;
                      if (nextIdx < options.length) {
                        options[nextIdx].focus();
                      } else {
                        // Cyklicky na zaÄÃ¡tek
                        options[0]?.focus();
                      }
                    } else if (e.key === 'ArrowUp') {
                      // Å ipka nahoru - pÅ™ejdi na pÅ™edchozÃ­ option
                      e.preventDefault();
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]') || []);
                      const currentIdx = options.indexOf(e.target);
                      const prevIdx = currentIdx - 1;
                      if (prevIdx >= 0) {
                        options[prevIdx].focus();
                      } else {
                        // Cyklicky zpÄ›t do search inputu
                        if (searchInputRef.current) {
                          searchInputRef.current.focus();
                        } else {
                          options[options.length - 1]?.focus();
                        }
                      }
                    } else if (e.key === 'Escape') {
                      e.preventDefault();
                      toggleSelect('strediska');
                    } else if (e.key === 'Tab') {
                      // Tab navigace v rÃ¡mci dropdownu
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]') || []);
                      const currentIdx = options.indexOf(e.target);

                      if (e.shiftKey) {
                        // Shift+Tab - pokud jsme na prvnÃ­ option, vraÅ¥ se na search input
                        if (currentIdx === 0) {
                          e.preventDefault();
                          if (searchInputRef.current) {
                            searchInputRef.current.focus();
                          }
                        }
                      } else {
                        // Tab - pokud jsme na poslednÃ­ option, zavÅ™i dropdown
                        if (currentIdx === options.length - 1) {
                          e.preventDefault();
                          toggleSelect('strediska');
                        }
                      }
                    }
                  }}
                >
                  <input
                    type="checkbox"
                    checked={isChecked}
                    readOnly
                  />
                  <span>
                    {getOptionLabel(option, 'strediska')}
                  </span>
                </MultiSelectOption>
              );
            })}

            {filteredOptions.length === 0 && (
              <CustomSelectOption>Å½Ã¡dnÃ© vÃ½sledky</CustomSelectOption>
            )}
          </CustomSelectDropdown>
        )}
      </MultiSelectWrapper>
    );
  };

  // Clicked outside handler
  useEffect(() => {
    const handleClickOutside = (event) => {
      // ZavÅ™Ã­t vÅ¡echny selecty pÅ™i kliknutÃ­ mimo
      if (!event.target.closest('[data-custom-select]')) {
        closeAllSelects();
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  // AUTOSAVE JE VYPNUTÃ - uklÃ¡dÃ¡nÃ­ pouze pÅ™i onBlur (handleFieldBlur)
  // PÅ¯vodnÃ­ useEffect s debouncem byl odstranÄ›n, aby se autosave nespouÅ¡tÄ›l pÅ™i kaÅ¾dÃ© zmÄ›nÄ›
  // Autosave se nynÃ­ spouÅ¡tÃ­ POUZE pÅ™i ztrÃ¡tÄ› fokusu input pole (viz handleFieldBlur)

  // ðŸŽ¯ TAB NAVIGATION HANDLER - inteligentnÃ­ navigace pouze po viditelnÃ½ch a ne-disabled prvcÃ­ch
  const handleFormKeyDown = useCallback((e) => {
    if (e.key !== 'Tab') return;

    // Najdi aktuÃ¡lnÄ› fokusnutÃ½ prvek
    const activeElement = document.activeElement;

    // Pokud jsme v otevÅ™enÃ©m dropdownu, nech dropdown zvlÃ¡dat tab sÃ¡m
    const isInDropdown = activeElement?.closest('[class*="Dropdown"]') ||
                        activeElement?.closest('[class*="SelectDropdown"]') ||
                        activeElement?.closest('[class*="TemplateDropdown"]');

    if (isInDropdown) {
      // NechÃ¡me dropdown zvlÃ¡dat tab navigaci
      return;
    }

    // ZÃ­skej ScrollableContent kontejner - pouze prvky uvnitÅ™ nÄ›j
    const formContainer = document.querySelector('[class*="ScrollableContent"]');
    if (!formContainer) return;

    // Kontrola zda je aktivnÃ­ prvek uvnitÅ™ formulÃ¡Å™e
    if (!formContainer.contains(activeElement)) {
      // Pokud jsme mimo formulÃ¡Å™, nech prohlÃ­Å¾eÄ zvlÃ¡dat tab normÃ¡lnÄ›
      return;
    }

    const focusableSelectors = [
      'input:not([disabled]):not([tabindex="-1"])',
      'textarea:not([disabled]):not([tabindex="-1"])',
      'select:not([disabled]):not([tabindex="-1"])',
      'button:not([disabled]):not([tabindex="-1"])',
      '[tabindex]:not([tabindex="-1"]):not([disabled])',
      '[data-field]:not([disabled]):not([tabindex="-1"])'
    ].join(',');

    const allElements = Array.from(formContainer.querySelectorAll(focusableSelectors));

    // Filtruj pouze viditelnÃ© prvky (offsetParent !== null znamenÃ¡ Å¾e je prvek viditelnÃ½)
    const visibleElements = allElements.filter(el => {
      // Kontrola viditelnosti
      if (!el.offsetParent && el.tagName !== 'INPUT' && el.tagName !== 'TEXTAREA') {
        return false;
      }

      // Kontrola zda nenÃ­ skrytÃ½ pomocÃ­ display: none nebo visibility: hidden
      const style = window.getComputedStyle(el);
      if (style.display === 'none' || style.visibility === 'hidden') {
        return false;
      }

      // Kontrola zda nenÃ­ disabled (i kdyÅ¾ uÅ¾ mÃ¡me v selektoru, dvojitÃ¡ kontrola)
      if (el.disabled || el.getAttribute('aria-disabled') === 'true') {
        return false;
      }

      return true;
    });

    if (visibleElements.length === 0) return;

    // Najdi index aktuÃ¡lnÃ­ho prvku
    const currentIndex = visibleElements.indexOf(activeElement);

    if (currentIndex === -1) {
      // Pokud aktuÃ¡lnÃ­ prvek nenÃ­ v seznamu, fokusni prvnÃ­ prvek
      e.preventDefault();
      visibleElements[0]?.focus();
      return;
    }

    // VypoÄÃ­tej novÃ½ index podle smÄ›ru (Tab vs Shift+Tab)
    let newIndex;
    if (e.shiftKey) {
      // Shift+Tab - jdi zpÄ›t
      newIndex = currentIndex - 1;
      if (newIndex < 0) {
        newIndex = visibleElements.length - 1; // Cyklicky na konec
      }
    } else {
      // Tab - jdi vpÅ™ed
      newIndex = currentIndex + 1;
      if (newIndex >= visibleElements.length) {
        newIndex = 0; // Cyklicky na zaÄÃ¡tek
      }
    }

    // Fokusni novÃ½ prvek
    e.preventDefault();
    visibleElements[newIndex]?.focus();

    // Pokud je to dropdown button, NEOTEVÃREJ ho automaticky - uÅ¾ivatel mÅ¯Å¾e pouÅ¾Ã­t Enter
    // Toto zjednoduÅ¡uje UX - tab jen naviguje, Enter otvÃ­rÃ¡
  }, []);

  // âŒ ZAKOMENTOVÃNO: Tento useEffect zpÅ¯sobuje PÅ˜EPSÃNÃ validaÄnÃ­ch chyb!
  // ProblÃ©m: Po validateFormForSave() (kterÃ¡ vytvoÅ™Ã­ vÅ¡echny chyby vÄetnÄ› lokacÃ­),
  // se tento useEffect spustÃ­ (kvÅ¯li zmÄ›nÄ› hasTriedToSubmit z falseâ†’true) a zavolÃ¡
  // validateWorkflowData(), kterÃ¡ NEVALIDUJE lokalizaÄnÃ­ pole (Ãºsek, budova, mÃ­stnost).
  // TÃ­m dojde k PÅ˜EPSÃNÃ validationErrors objektem BEZ lokalizaÄnÃ­ch chyb!
  // ðŸ”§ Å˜EÅ ENÃ: Live validace nenÃ­ potÅ™eba - validujeme pouze pÅ™i kliknutÃ­ na "UloÅ¾it"
  //            ve funkci validateFormForSave(), kterÃ¡ validuje VÅ E vÄetnÄ› lokacÃ­.
  /*
  useEffect(() => {
    // KRITICKÃ‰: SpusÅ¥ validaci pouze pokud uÅ¾ivatel uÅ¾ se pokusil odeslat formulÃ¡Å™!
    if (currentPhase >= 2 && formData.id && hasTriedToSubmit) {
      // MalÃ© zpoÅ¾dÄ›nÃ­ aby se stihly pÅ™epoÄÃ­tat vÅ¡echny derived values
      const timeout = setTimeout(() => {
        const validationWorkflowCode = mainWorkflowState;
        const errors = validateWorkflowData(formData, validationWorkflowCode);
        setValidationErrors(errors);
      }, 100);

      return () => clearTimeout(timeout);
    }
  }, [currentPhase, mainWorkflowState, formData.id, hasTriedToSubmit]);
  */

  // ðŸŽ¯ NOVÃ LOADING GATE: Souhrn vÅ¡ech naÄÃ­tÃ¡nÃ­ pro RACE CONDITION FIX
  // Tato promÄ›nnÃ¡ urÄuje, zda jsou vÅ¡echna potÅ™ebnÃ¡ data pÅ™ipravena
  const isFormLoading = React.useMemo(() => {
    // 1. Pokud se naÄÃ­tajÃ­ ÄÃ­selnÃ­ky, formulÃ¡Å™ NENÃ pÅ™ipraven
    if (isLoadingCiselniky) {
      return true;
    }

    // 2. Pokud se naÄÃ­tajÃ­ data formulÃ¡Å™e (editace NEBO novÃ¡ objednÃ¡vka s draftem), formulÃ¡Å™ NENÃ pÅ™ipraven
    if (isLoadingFormData) {
      return true;
    }

    // 3. VÅ¡echna data jsou pÅ™ipravena!
    return false;
  }, [isLoadingCiselniky, isLoadingFormData]);

  // ðŸ›¡ï¸ AUTH GATE: Pokud nenÃ­ token/username, zobrazit loading a poÄkat
  // MUSÃ BÃT AÅ½ PO VÅ ECH HOOKS (React Rules of Hooks)
  if (!token || !username) {
    return (
      <LoadingOverlay $visible={true}>
        <LoadingSpinner $visible={true} />
        <LoadingMessage $visible={true}>OvÄ›Å™uji pÅ™ihlÃ¡Å¡enÃ­...</LoadingMessage>
        <LoadingSubtext $visible={true}>ÄŒekÃ¡m na autentizaci...</LoadingSubtext>
      </LoadingOverlay>
    );
  }

  // âŒ DEPRECATED: StarÃ½ loading gate - zakÃ¡zÃ¡n, pouÅ¾Ã­vÃ¡ starÃ© flagy kterÃ© se nenastavujÃ­
  // if (isFormLoading) {
  //   return (
  //     <LoadingOverlay $visible={true}>
  //       <LoadingSpinner $visible={true} />
  //       <LoadingMessage $visible={true}>
  //         {isLoadingCiselniky && !isLoadingFormData && 'NaÄÃ­tÃ¡m ÄÃ­selnÃ­ky...'}
  //         {isLoadingCiselniky && isLoadingFormData && 'NaÄÃ­tÃ¡m ÄÃ­selnÃ­ky a data objednÃ¡vky...'}
  //         {!isLoadingCiselniky && isLoadingFormData && 'NaÄÃ­tÃ¡m data objednÃ¡vky...'}
  //       </LoadingMessage>
  //       <LoadingSubtext $visible={true}>
  //         {isLoadingCiselniky && 'ZpracovÃ¡vÃ¡m seznamy pro vÃ½bÄ›rovÃ¡ pole...'}
  //         {!isLoadingCiselniky && isLoadingFormData && 'ZpracovÃ¡vÃ¡m data z databÃ¡ze...'}
  //       </LoadingSubtext>
  //     </LoadingOverlay>
  //   );
  // }

  // ðŸŽ¯ NOVÃ LOADING GATE: Zobrazit splash screen dokud nenÃ­ lifecycle.isReady
  // Å˜Ã­dÃ­ useFormController lifecycle phases: MOUNTING â†’ LOADING_DICTIONARIES â†’ READY

  if (!lifecycle.isReady) {
    return (
      <LoadingOverlay $visible={true}>
        <LoadingSpinner $visible={true} />
        <LoadingMessage $visible={true}>
          {lifecycle.phase === 'MOUNTING' && 'Inicializuji formulÃ¡Å™...'}
          {lifecycle.phase === 'LOADING_DICTIONARIES' && 'NaÄÃ­tÃ¡m ÄÃ­selnÃ­ky...'}
          {lifecycle.phase === 'READY_FOR_DATA' && 'PÅ™ipravuji data...'}
          {lifecycle.phase === 'LOADING_DATA' && 'NaÄÃ­tÃ¡m data objednÃ¡vky...'}
          {lifecycle.phase === 'DATA_LOADED' && 'DokonÄuji naÄÃ­tÃ¡nÃ­...'}
          {lifecycle.phase === 'READY' && 'PÅ™ipravuji formulÃ¡Å™...'}
          {!lifecycle.phase && 'NaÄÃ­tÃ¡m formulÃ¡Å™ objednÃ¡vky'}
        </LoadingMessage>
        <LoadingSubtext $visible={true}>
          {!dictionaries.isReady && `NaÄÃ­tÃ¡m ${dictionaries.loadedCount || 0}/${dictionaries.totalToLoad || 8} ÄÃ­selnÃ­kÅ¯...`}
          {dictionaries.isReady && lifecycle.isLoadingFormData && 'NaÄÃ­tÃ¡m data objednÃ¡vky...'}
          {dictionaries.isReady && !lifecycle.isLoadingFormData && !lifecycle.isReady && 'ZpracovÃ¡vÃ¡m data...'}
        </LoadingSubtext>
      </LoadingOverlay>
    );
  }

  // âŒ DEPRECATED: StarÃ½ loading overlay - nahrazeno lifecycle.isReady
  // if (isFormInitializing) {
  //   return (
  //     <LoadingOverlay $visible={true}>
  //       <LoadingSpinner $visible={true} />
  //       <LoadingMessage $visible={true}>NaÄÃ­tÃ¡m formulÃ¡Å™ objednÃ¡vky</LoadingMessage>
  //       <LoadingSubtext $visible={true}>ZpracovÃ¡vÃ¡m data z databÃ¡ze...</LoadingSubtext>
  //     </LoadingOverlay>
  //   );
  // }

  // Error state pÅ™i inicializaci
  if (initializationError && !token) {
    return (
      <Container isFullscreen={isFullscreen}>
        <div style={{ padding: '2rem', textAlign: 'center' }}>
          <ErrorMessage>
            Chyba inicializace: {initializationError}
          </ErrorMessage>
        </div>
      </Container>
    );
  }

  // Obsah formulÃ¡Å™e
  const formContent = (
    <Container isFullscreen={isFullscreen}>
      {/* ðŸ§­ PlovoucÃ­ navigÃ¡tor po sekcÃ­ch formulÃ¡Å™e */}
      <FloatingNavigator
        onSectionClick={handleNavigatorSectionClick}
        onFilesDrop={handleNavigatorFilesDrop}
        onToggleSections={handleToggleSections}
        areSectionsCollapsed={areSectionsCollapsed}
        currentPhase={getCurrentPhase()}
        validationErrors={validationErrors}
        formData={navigatorFormData}
        isFullscreen={isFullscreen}
        isSectionActive={isSectionActive}
        allSectionStates={extendedSectionStates}
        isWorkflowCompleted={isWorkflowCompleted}
        canPublishRegistry={canPublishRegistry}
        canUnlockAnything={canUnlockAnything}
        onSaveAsTemplate={handleSaveAsTemplate}
        onGenerateDocx={handleGenerateDocx}
        onToggleFullscreen={() => setIsFullscreen(!isFullscreen)}
        canGenerateDocx={canGenerateDocx() && !isOrderCompleted}
        canSaveTemplate={!showSaveProgress && !isSaving && !!token && !!user_id && !isOrderCompleted}
        serverTemplates={serverTemplates}
        savedTemplates={savedTemplates}
        templatesLoading={templatesLoading}
        searchQuery={searchPredefs}
        showSearch={showSearchPredefs}
        token={token}
        hasPermission={hasPermission}
        onTemplateSearch={setSearchPredefs}
        onToggleTemplateSearch={() => setShowSearchPredefs(s => !s)}
        onRefreshTemplates={fetchAndMergeTemplates}
        onFillPoApproval={fillPoApprovalSaved}
        onFillDetails={fillAllFieldsSaved}
        canFillTemplate={!isOrderCompleted}
        onCopyTemplateToUser={copyPredefinedToUser}
        onCopyTemplateToGlobal={copyUserTemplateToGlobal}
        onShowTemplatePreview={showTemplatePreview}
        onDeleteTemplate={(template) => { setTemplatePendingDelete(template); setShowDeleteTemplateConfirm(true); }}
        onEditTemplateName={startEditingTemplateName}
        editingTemplateId={editingTemplateId}
        editingTemplateName={editingTemplateName}
        matchesTemplateQuery={matchesTemplateQuery}
        isArchived={isArchived}
      />

      {/* ðŸŽ¤ IndikÃ¡tor hlasovÃ©ho nahrÃ¡vÃ¡nÃ­ je v Layout.js - globÃ¡lnÃ­ pro celou aplikaci */}

      {/* âŒ DEPRECATED: Loading overlay pro ÄÃ¡steÄnÃ© operace - ODSTRANÄšNO */}
      {/* ÄŒÃ­selnÃ­ky se naÄÃ­tajÃ­ v lifecycle fÃ¡zi, takÅ¾e tento overlay je zbyteÄnÃ½ */}
      {/* Pokud potÅ™ebujeme loading bÄ›hem runtime operacÃ­, pÅ™idÃ¡me specifickÃ½ indicator */}

      {/* VarovÃ¡nÃ­ pÅ™i ÄÃ¡steÄnÃ© chybÄ› inicializace */}
      {initializationError && (
        <ErrorMessage style={{ margin: '1rem' }}>
          ÄŒÃ¡steÄnÃ¡ chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat: {initializationError}
        </ErrorMessage>
      )}

      <FormWrapper>
        {/* FixnÃ­ hlaviÄka */}
        <FixedHeader ref={fixedHeaderRef}>
          <FixedHeaderContent>
            {/* HlaviÄka formulÃ¡Å™e */}
            <FormHeader>
              <HeaderLeft>
                <TitleWithButtons>
                  <HeaderTitle
                    title={isEditMode && formData.ev_cislo ? `Editace objednÃ¡vky ev.Ä. ${formData.ev_cislo}` : ''}
                  >
                    ObjednÃ¡vka
                    {formData.id && (
                      <span className="order-id-badge"> #{formData.id}</span>
                    )}
                  </HeaderTitle>
                  {/* ðŸ“‹ Å ablony pÅ™esunuty do FloatingNavigator toolbaru */}
                </TitleWithButtons>

                {/* ðŸ’° Souhrn cen vedle nadpisu */}
                {maxPrice > 0 && (
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '4px 10px',
                    marginLeft: '0.5rem',
                    background: isPriceExceeded
                      ? 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'
                      : 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)',
                    border: `2px solid ${isPriceExceeded ? '#fca5a5' : '#bbf7d0'}`,
                    borderRadius: '6px',
                    fontSize: '0.75rem',
                    fontWeight: 600,
                    color: isPriceExceeded ? '#991b1b' : '#166534',
                    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.05)',
                    whiteSpace: 'nowrap'
                  }}>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1px', alignItems: 'flex-start' }}>
                      <div style={{ fontSize: '0.6rem', opacity: 0.8, fontWeight: 500 }}>MAX CENA</div>
                      <div style={{ fontSize: '0.85rem', fontWeight: 700 }}>
                        {maxPrice.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ
                      </div>
                    </div>
                    <div style={{ fontSize: '14px', fontWeight: 'bold', opacity: 0.5 }}>â†’</div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1px', alignItems: 'flex-end' }}>
                      <div style={{ fontSize: '0.6rem', opacity: 0.8, fontWeight: 500 }}>SOUÄŒET POLOÅ½EK</div>
                      <div style={{ fontSize: '0.85rem', fontWeight: 700 }}>
                        {totalPrice.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ
                      </div>
                    </div>
                  </div>
                )}
              </HeaderLeft>

              {/* EV. ÄŒÃSLO a ÄÃ­slo objednÃ¡vky - vpravo */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end' }}>
                  <div style={{ fontSize: '12px', color: '#666', marginBottom: '2px' }}>
                    {isOrderSavedToDB ? 'EV. ÄŒÃSLO' : 'PÅ˜EDPOKLÃDANÃ‰ EV. ÄŒÃSLO'}
                  </div>
                  {/* Status informace - pod EV. ÄŒÃSLO */}
                  {(lastAutoSave || isAutoSaving || dataSource) && (
                    <div style={{
                      fontSize: '10px',
                      color: '#666',
                      padding: '2px 6px',
                      borderRadius: '4px',
                      textAlign: 'right',
                      backgroundColor: isAutoSaving
                        ? '#fef2f2'  // ðŸ”´ ÄervenÃ¡ pÅ™i uklÃ¡dÃ¡nÃ­
                        : dataSource === 'database'
                          ? '#eff6ff'  // ðŸ”µ modrÃ¡ pro DB
                          : dataSource === 'concept'
                            ? '#fefbf2'  // ðŸŸ¡ Å¾lutÃ¡ pro koncept
                            : '#f0fdf4', // ðŸŸ¢ zelenÃ¡ pro auto-save
                      border: `1px solid ${
                        isAutoSaving
                          ? '#fca5a5'  // ÄervenÃ¡
                          : dataSource === 'database'
                            ? '#bfdbfe'  // modrÃ¡
                            : dataSource === 'concept'
                              ? '#fed7aa'  // oranÅ¾ovÃ¡
                              : '#bbf7d0'  // zelenÃ¡
                      }`,
                      transition: 'all 0.2s ease'
                    }}>
                      {isAutoSaving ? (
                        <span style={{ color: '#dc2626' }}>â³ UklÃ¡dÃ¡nÃ­ konceptu...</span>
                      ) : dataSource === 'database' ? (
                        <span style={{ color: '#2563eb' }}>ðŸ’¾ NaÄteno z DB</span>
                      ) : dataSource === 'concept' ? (
                        <span style={{ color: '#d97706' }}>ðŸ“ FormulÃ¡Å™ naÄten z Konceptu</span>
                      ) : lastAutoSave ? (
                        <>
                          <span style={{ color: '#16a34a' }}>âœ“ {isOrderSavedToDB ? 'UloÅ¾eno' : 'Koncept'}</span> {new Date(lastAutoSave).toLocaleTimeString('cs-CZ', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                          })}
                        </>
                      ) : null}
                    </div>
                  )}
                </div>
                <EvidenceNumber>
                  <EvidenceValue $isEmergency={formData.mimoradna_udalost || false}>
                    {/* API next-number vracÃ­ next_order_string nebo order_number_string */}
                    {/* âš ï¸ DÅ®LEÅ½ITÃ‰: Toto ÄÃ­slo je POUZE pro ZOBRAZENÃ! */}
                    {/* Backend si pÅ™idÄ›lÃ­ finÃ¡lnÃ­ ÄÃ­slo pÅ™i CREATE - my ho NIKDY neposÃ­lÃ¡me */}
                    {isLoadingEvCislo ? (
                      <span style={{
                        color: '#666',
                        fontStyle: 'italic',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem'
                      }}>
                        <Spinner />
                        NaÄÃ­tÃ¡m...
                      </span>
                    ) : !isValidEvCislo(formData.ev_cislo) ? (
                      <span style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        color: '#d97706'
                      }}>
                        <FontAwesomeIcon icon={faExclamationTriangle} style={{ color: '#f59e0b' }} />
                        <span style={{ fontSize: '13px' }}>NaÄÃ­tÃ¡nÃ­ selhalo</span>
                        <RetryButton
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            loadNextOrderNumber();
                          }}
                          title="Zkusit naÄÃ­st ev. ÄÃ­slo znovu"
                        >
                          â†» Zkusit znovu
                        </RetryButton>
                      </span>
                    ) : typeof formData.ev_cislo === 'object' ? (
                      formData.ev_cislo?.next_order_string ||
                      formData.ev_cislo?.order_number_string ||
                      formData.ev_cislo?.next_number ||
                      'NaÄÃ­tÃ¡m...'
                    ) : (
                      formData.ev_cislo || 'NaÄÃ­tÃ¡m...'
                    )}
                  </EvidenceValue>
                </EvidenceNumber>
              </div>
            </FormHeader>

            {/* ðŸŽ¯ ÄŒERPÃNÃ LP - zobrazit ve fÃ¡zi 3+ kdyÅ¾ jsou vyplnÄ›na LP u poloÅ¾ek */}
            {(() => {
              // Zobrazit pouze ve fÃ¡zi 3+ a kdyÅ¾ mÃ¡me LP financovÃ¡nÃ­
              if (currentPhase < 3) return null;
              
              const selectedSource = financovaniOptions.find(opt => opt.kod_stavu === formData.zpusob_financovani || opt.kod === formData.zpusob_financovani);
              const nazev = selectedSource?.nazev_stavu || selectedSource?.nazev || '';
              const hasLPFinancing = (nazev.includes('Limitovan') || nazev.includes('pÅ™Ã­slib')) && Array.isArray(formData.lp_kod) && formData.lp_kod.length > 0;
              
              if (!hasLPFinancing) return null;
              
              // SpoÄÃ­tat ÄerpÃ¡nÃ­ z poloÅ¾ek
              const lpCerpani = {};
              formData.polozky_objednavky?.forEach(polozka => {
                if (polozka.lp_id) {
                  const cena = parseFloat(polozka.cena_s_dph) || 0;
                  if (!lpCerpani[polozka.lp_id]) {
                    lpCerpani[polozka.lp_id] = { suma: 0, count: 0 };
                  }
                  lpCerpani[polozka.lp_id].suma += cena;
                  lpCerpani[polozka.lp_id].count++;
                }
              });
              
              // Pokud nejsou Å¾Ã¡dnÃ¡ LP pÅ™iÅ™azenÃ¡, nezobrazovat
              if (Object.keys(lpCerpani).length === 0) return null;
              
              return (
                <div style={{
                  marginTop: '0.75rem',
                  padding: '0.5rem 0.75rem',
                  background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)',
                  border: '1px solid #93c5fd',
                  borderRadius: '6px',
                  fontSize: '0.7rem',
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: '0.5rem',
                  alignItems: 'center'
                }}>
                  <div style={{ fontWeight: 700, color: '#1e40af', fontSize: '0.65rem', letterSpacing: '0.5px' }}>
                    ÄŒERPÃNÃ LP:
                  </div>
                  {Object.entries(lpCerpani).map(([lpId, data]) => {
                    const lpOption = lpOptionsForItems.find(opt => opt.id === parseInt(lpId));
                    if (!lpOption) return null;
                    
                    const lpKod = lpOption.kod || `LP #${lpId}`;
                    
                    // Data z API - ROBUSTNÃ AKTUÃLNÃ STAVY LP
                    const lpStav = lpStavy[parseInt(lpId)];
                    const lpLimit = lpStav?.limit || 0;
                    const lpCerpano = lpStav?.cerpano || 0;
                    const lpZbyva = lpStav?.zbyva || 0;
                    
                    // ÄŒerpÃ¡nÃ­ v tÃ©to objednÃ¡vce
                    const cerpaniTato = data.suma;
                    
                    // Zbude po uloÅ¾enÃ­ tÃ©to objednÃ¡vky (AKTUÃLNÃ ZÅ®STATEK - ÄŒERPÃNÃ TEÄŽKA)
                    const zbyvaPoUlozeni = lpZbyva - cerpaniTato;
                    
                    const procento = lpLimit > 0 ? ((lpCerpano + cerpaniTato) / lpLimit * 100) : 0;
                    
                    return (
                      <div key={lpId} style={{
                        padding: '0.3rem 0.6rem',
                        background: zbyvaPoUlozeni < 0 ? '#fee2e2' : 'white',
                        border: `1px solid ${zbyvaPoUlozeni < 0 ? '#fca5a5' : '#bfdbfe'}`,
                        borderRadius: '4px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.4rem',
                        fontSize: '0.7rem'
                      }}>
                        <div style={{ fontWeight: 700, color: '#1e40af', fontSize: '0.7rem' }}>
                          {lpKod}
                        </div>
                        <div style={{ color: '#64748b', fontSize: '0.65rem' }}>
                          {lpZbyva.toLocaleString('cs-CZ', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} KÄ
                        </div>
                        <div style={{ fontSize: '0.65rem', color: '#94a3b8' }}>â†’</div>
                        <div style={{ fontWeight: 700, color: zbyvaPoUlozeni < 0 ? '#dc2626' : '#059669', fontSize: '0.7rem' }}>
                          {zbyvaPoUlozeni.toLocaleString('cs-CZ', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} KÄ
                        </div>
                        <div style={{ fontSize: '0.6rem', color: '#94a3b8' }}>
                          ({procento.toFixed(0)}%)
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })()}

            {/* Å˜Ã¡dek s fÃ¡zÃ­ a akcemi NEBO zelenÃ½ info box pro dokonÄenou objednÃ¡vku NEBO ÄervenÃ½ pro zamÃ­tnutou NEBO oranÅ¾ovÃ½ pro stornovanou */}
            {isWorkflowRejected ? (
              // ðŸ”´ ÄŒervenÃ½ info box pro zamÃ­tnutou objednÃ¡vku
              <div style={{
                padding: '1rem 1.5rem',
                marginTop: '1rem',
                backgroundColor: '#fee2e2',
                border: '2px solid #dc2626',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '1rem',
                fontWeight: '600',
                color: '#991b1b'
              }}>
                <Lock size={20} style={{ marginTop: '0.25rem', flexShrink: 0 }} />
                <div style={{ flex: 1 }}>
                  <div style={{ marginBottom: '0.5rem', fontSize: '1.1rem' }}>
                    âŒ ObjednÃ¡vka zamÃ­tnuta
                  </div>
                  {formData.schvaleni_komentar && (
                    <div style={{ fontWeight: 'normal', fontSize: '0.875rem', marginBottom: '0.5rem' }}>
                      <strong>DÅ¯vod zamÃ­tnutÃ­:</strong> {formData.schvaleni_komentar}
                    </div>
                  )}
                  {formData.schvalovatel_id && (
                    <div style={{ fontWeight: 'normal', fontSize: '0.875rem' }}>
                      <strong>ZamÃ­tl:</strong> {getUserNameById(formData.schvalovatel_id)}
                      {formData.dt_schvaleni && ` â€¢ ${new Date(formData.dt_schvaleni).toLocaleDateString('cs-CZ')} ${new Date(formData.dt_schvaleni).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}`}
                    </div>
                  )}
                </div>
                {/* TlaÄÃ­tka vpravo */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', flexShrink: 0 }}>
                  <ActionButton
                    className="cancel-btn"
                    onClick={handleCancelOrder}
                    title="ZavÅ™Ã­t formulÃ¡Å™ a vrÃ¡tit se na seznam objednÃ¡vek"
                    style={{
                      padding: '0.5rem 1rem',
                      fontSize: '0.875rem',
                      backgroundColor: '#dc2626',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontWeight: '600',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      whiteSpace: 'nowrap',
                      transition: 'background-color 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#b91c1c'}
                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#dc2626'}
                  >
                    <FontAwesomeIcon icon={faTimes} />
                    ZavÅ™Ã­t
                  </ActionButton>
                  {/* ðŸ”“ TlaÄÃ­tko Odemknout pro admin/ORDER_MANAGE */}
                  {canUnlockAnything && (
                    <ActionButton
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowUnlockPhase2Confirm(true);
                      }}
                      title="Odemknout zamÃ­tnutou objednÃ¡vku (vrÃ¡tit na FÃZI 2 - ODESLANA_KE_SCHVALENI)"
                      style={{
                        padding: '0.5rem 1rem',
                        fontSize: '0.875rem',
                        backgroundColor: '#f59e0b',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        whiteSpace: 'nowrap',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#d97706'}
                      onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f59e0b'}
                    >
                      <Unlock size={16} />
                      Odemknout
                    </ActionButton>
                  )}
                </div>
              </div>
            ) : isWorkflowCancelled ? (
              // ðŸŸ  OranÅ¾ovÃ½ info box pro stornovanou objednÃ¡vku
              <div style={{
                padding: '1rem 1.5rem',
                marginTop: '1rem',
                backgroundColor: '#fff7ed',
                border: '2px solid #f97316',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '1rem',
                fontWeight: '600',
                color: '#9a3412'
              }}>
                <Lock size={20} style={{ marginTop: '0.25rem', flexShrink: 0 }} />
                <div style={{ flex: 1 }}>
                  <div style={{ marginBottom: '0.5rem', fontSize: '1.1rem' }}>
                    ðŸš« ObjednÃ¡vka stornovÃ¡na
                  </div>
                  {formData.odeslani_storno_duvod && (
                    <div style={{ fontWeight: 'normal', fontSize: '0.875rem', marginBottom: '0.5rem' }}>
                      <strong>DÅ¯vod stornovÃ¡nÃ­:</strong> {formData.odeslani_storno_duvod}
                    </div>
                  )}
                  {formData.odesilatel_id && (
                    <div style={{ fontWeight: 'normal', fontSize: '0.875rem' }}>
                      <strong>Stornoval:</strong> {getUserNameById(formData.odesilatel_id)}
                      {formData.dt_odeslani && ` â€¢ ${new Date(formData.dt_odeslani).toLocaleDateString('cs-CZ')} ${new Date(formData.dt_odeslani).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}`}
                    </div>
                  )}
                </div>
                {/* TlaÄÃ­tka vpravo */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', flexShrink: 0 }}>
                  <ActionButton
                    className="cancel-btn"
                    onClick={handleCancelOrder}
                    title="ZavÅ™Ã­t formulÃ¡Å™ a vrÃ¡tit se na seznam objednÃ¡vek"
                    style={{
                      padding: '0.5rem 1rem',
                      fontSize: '0.875rem',
                      backgroundColor: '#f97316',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontWeight: '600',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      whiteSpace: 'nowrap',
                      transition: 'background-color 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ea580c'}
                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f97316'}
                  >
                    <FontAwesomeIcon icon={faTimes} />
                    ZavÅ™Ã­t
                  </ActionButton>
                  {canUnlockAnything && (
                    <ActionButton
                      className="unlock-btn"
                      onClick={() => setShowUnlockStornoConfirm(true)}
                      title="Odemknout stornovanou objednÃ¡vku"
                      style={{
                        padding: '0.5rem 1rem',
                        fontSize: '0.875rem',
                        backgroundColor: '#f97316',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        whiteSpace: 'nowrap',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ea580c'}
                      onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f97316'}
                    >
                      <Unlock size={16} />
                      Odemknout
                    </ActionButton>
                  )}
                </div>
              </div>
            ) : isWorkflowCompleted ? (
              // ðŸ”’ ZelenÃ½ info box pro dokonÄenou objednÃ¡vku
              <div style={{
                padding: '1rem 1.5rem',
                marginTop: '1rem',
                backgroundColor: '#dcfce7',
                border: '2px solid #16a34a',
                borderRadius: '8px',
                display: 'flex',
                alignItems: 'flex-start',
                gap: '1rem',
                fontWeight: '600',
                color: '#166534'
              }}>
                <Lock size={20} style={{ marginTop: '0.25rem', flexShrink: 0 }} />
                <div style={{ flex: 1 }}>
                  <div style={{ marginBottom: '0.5rem' }}>
                    âœ… ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› dokonÄena. VÅ¡echny kroky byly splnÄ›ny.
                  </div>
                  {formData.dokoncil_id && (
                    <div style={{ fontWeight: 'normal', fontSize: '0.875rem' }}>
                      <strong>DokonÄil:</strong> {getUserNameById(formData.dokoncil_id)}
                      {formData.dt_dokonceni && ` â€¢ ${new Date(formData.dt_dokonceni).toLocaleDateString('cs-CZ')} ${new Date(formData.dt_dokonceni).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}`}
                    </div>
                  )}
                </div>

                {/* TlaÄÃ­tka vpravo - POD sebou */}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', flexShrink: 0 }}>
                  <ActionButton
                    className="cancel-btn"
                    onClick={handleCancelOrder}
                    title="ZavÅ™Ã­t formulÃ¡Å™ a vrÃ¡tit se na seznam objednÃ¡vek"
                    style={{
                      padding: '0.5rem 1rem',
                      fontSize: '0.875rem',
                      backgroundColor: '#16a34a',
                      color: 'white',
                      border: 'none',
                      borderRadius: '6px',
                      cursor: 'pointer',
                      fontWeight: '600',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      whiteSpace: 'nowrap',
                      transition: 'background-color 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#15803d'}
                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#16a34a'}
                  >
                    <FontAwesomeIcon icon={faTimes} />
                    ZavÅ™Ã­t
                  </ActionButton>

                  {/* ðŸ”“ TlaÄÃ­tko Odemknout pro admin/ORDER_MANAGE - POD tlaÄÃ­tkem ZavÅ™Ã­t */}
                  {canUnlockAnything && (
                    <ActionButton
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowUnlockDokonceniConfirm(true);
                      }}
                      title="Odemknout dokonÄenou objednÃ¡vku (vrÃ¡tit na FÃZI 8 - ZKONTROLOVANA)"
                      style={{
                        padding: '0.5rem 1rem',
                        fontSize: '0.875rem',
                        backgroundColor: '#f59e0b',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        whiteSpace: 'nowrap',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#d97706'}
                      onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f59e0b'}
                    >
                      <Unlock size={16} />
                      Odemknout
                    </ActionButton>
                  )}
                </div>
              </div>
            ) : (
            // ðŸ“Š StandardnÃ­ Å™Ã¡dek s fÃ¡zÃ­ a akcemi
            <PhaseRow>
              <div style={{ display: 'flex', alignItems: 'center', gap: '2rem', flex: 1 }}>
                <PhaseProgressContainer>
                  <PhaseText>
                    {(() => {
                      // PouÅ¾Ã­vÃ¡ novou 8-fÃ¡zovou logiku
                      if (formData.stav_stornovano || hasWorkflowState(formData.stav_workflow_kod, 'ZRUSENA')) {
                        return "StornovanÃ¡ objednÃ¡vka";
                      }

                      // PouÅ¾itÃ­ currentPhase z getCurrentPhase()
                      const phaseLabels = {
                        1: "FÃ¡ze 1/8: NovÃ¡ objednÃ¡vka",
                        2: "FÃ¡ze 2/8: Ke schvÃ¡lenÃ­",
                        3: "FÃ¡ze 3/8: SchvÃ¡lenÃ¡ objednÃ¡vka",
                        4: "FÃ¡ze 4/8: Dodavatel + Registr",
                        5: "FÃ¡ze 5/8: VyplnÄ›nÃ­ registru",
                        6: "FÃ¡ze 6/8: Fakturace",
                        7: "FÃ¡ze 7/8: VÄ›cnÃ¡ sprÃ¡vnost",
                        8: "FÃ¡ze 8/8: ZkontrolovÃ¡no"
                      };

                      return phaseLabels[currentPhase] || "FÃ¡ze 1/8: NovÃ¡ objednÃ¡vka";
                    })()}
                  </PhaseText>

                  {/* ProgresnÃ­ barevnÃ½ indikÃ¡tor */}
                  <PhaseProgressBar>
                    {phaseProgressOverride.phases.map((phase, index) => (
                      <PhaseSegment key={phase.id}>
                        <PhaseSegmentFill
                          className={phase.fillClass}
                          style={{
                            opacity: phase.isVisible ? 1 : 0.15,
                            transform: phase.isVisible ? 'scaleX(1)' : 'scaleX(0.1)',
                            transformOrigin: 'left'
                          }}
                        />
                      </PhaseSegment>
                    ))}
                  </PhaseProgressBar>
                </PhaseProgressContainer>

                {/* ðŸ’° ZbÃ½vajÃ­cÃ­ ÄÃ¡stka LP - zobrazit pouze pokud je vybrÃ¡n zpÅ¯sob "LimitovanÃ½ pÅ™Ã­slib" */}
                {(() => {
                  const selectedSource = financovaniOptions.find(opt => opt.kod === formData.zpusob_financovani);
                  const nazev = selectedSource?.nazev || '';
                  const isLpActive = nazev.includes('LimitovanÃ½ pÅ™Ã­slib');
                  return isLpActive;
                })() && Array.isArray(formData.lp_kod) && formData.lp_kod.length > 0 && formData.lp_kod.map(lp_id => {
                  const detail = lpDetails[lp_id];
                  if (!detail) return null;
                  
                  // ðŸŽ¯ Vybrat sprÃ¡vnÃ½ typ ÄerpÃ¡nÃ­ podle fÃ¡ze
                  let zbyva, typCerpani;
                  if (currentPhase <= 2) {
                    // FÃ¡ze 1-2: Rezervace (max_cena_s_dph)
                    zbyva = parseFloat(detail.zbyva_rezervace || 0);
                    typCerpani = 'Rezervace';
                  } else if (currentPhase >= 3 && currentPhase <= 6) {
                    // FÃ¡ze 3-6: PÅ™edpoklÃ¡danÃ© ÄerpÃ¡nÃ­ (souÄet poloÅ¾ek)
                    zbyva = parseFloat(detail.zbyva_predpoklad || 0);
                    typCerpani = 'PÅ™edpoklad';
                  } else {
                    // FÃ¡ze 7-8: SkuteÄnÃ© ÄerpÃ¡nÃ­ (faktury)
                    zbyva = parseFloat(detail.zbyva_skutecne || 0);
                    typCerpani = 'SkuteÄnÃ©';
                  }
                  
                  const isNegative = zbyva < 0;
                  
                  return (
                    <div key={lp_id} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      padding: '4px 10px',
                      background: isNegative
                        ? 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'
                        : 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)',
                      border: `2px solid ${isNegative ? '#fca5a5' : '#86efac'}`,
                      borderRadius: '6px',
                      fontSize: '0.75rem',
                      fontWeight: 600,
                      color: isNegative ? '#991b1b' : '#15803d',
                      boxShadow: '0 2px 4px rgba(0, 0, 0, 0.05)',
                      whiteSpace: 'nowrap'
                    }}>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '1px' }}>
                        <div style={{ fontSize: '0.6rem', opacity: 0.8, fontWeight: 500 }}>
                          LP {lpKodyOptions.find(opt => (opt.id || opt.kod) === lp_id)?.cislo_lp || lp_id} ({typCerpani})
                        </div>
                        <div style={{ fontSize: '0.85rem', fontWeight: 700 }}>
                          {Math.abs(zbyva).toLocaleString('cs-CZ', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} KÄ
                        </div>
                      </div>
                    </div>
                  );
                })}

                {/* ðŸ“„ ZbÃ½vajÃ­cÃ­ ÄÃ¡stka Smlouvy - zobrazit pouze pokud je vybrÃ¡n zpÅ¯sob "Smlouva" */}
                {(() => {
                  const selectedSource = financovaniOptions.find(opt => opt.kod === formData.zpusob_financovani);
                  const nazev = selectedSource?.nazev || '';
                  const isSmlouvaActive = nazev.includes('Smlouva');
                  return isSmlouvaActive;
                })() && formData.cislo_smlouvy && smlouvaDetail && !smlouvaDetail.notFound && !loadingSmlouvaDetail && (
                  (() => {
                    const celkovaCastka = parseFloat(
                      smlouvaDetail.hodnota_s_dph || 
                      smlouvaDetail.celkova_castka || 
                      0
                    );
                    const cerpano = parseFloat(
                      smlouvaDetail.cerpano_celkem ||
                      smlouvaDetail.cerpano || 
                      0
                    );
                    
                    // ðŸŽ¯ VÃ½poÄet rezervovanÃ© ÄÃ¡stky podle fÃ¡ze objednÃ¡vky
                    let rezervovanaCastka = 0;
                    
                    // Pro EDITOVANOU objednÃ¡vku (mÃ¡ ID) ve fÃ¡zi 7-8:
                    // Backend jiÅ¾ mÃ¡ tuto objednÃ¡vku zapoÄÃ­tanou v cerpano_celkem
                    // Proto neodeÄÃ­tÃ¡me znovu, jinak bychom odeÄetli dvakrÃ¡t!
                    const jeUlozenaObjednavka = formData.id && formData.id > 0;
                    const jeVeFazi78 = currentPhase >= 7; // VECNA_SPRAVNOST, DOKONCENA
                    
                    if (!jeUlozenaObjednavka || !jeVeFazi78) {
                      // Pro NOVOU objednÃ¡vku NEBO pro objednÃ¡vku pÅ™ed fÃ¡zÃ­ 7-8:
                      // OdeÄÃ­tÃ¡me rezervovanou ÄÃ¡stku
                      
                      const isPhase12 = currentPhase <= 2; // NOVA, KE_SCHVALENI
                      const isPhase36 = currentPhase >= 3 && currentPhase <= 6; // SCHVALENA aÅ¾ FAKTURACE
                      
                      if (isPhase12) {
                        // FÃ¡ze 1-2: Rezervovat max_cena_s_dph
                        rezervovanaCastka = parseFloat(formData.max_cena_s_dph || 0);
                      } else if (isPhase36) {
                        // FÃ¡ze 3-6: Rezervovat souÄet poloÅ¾ek objednÃ¡vky
                        if (formData.polozky_objednavky && Array.isArray(formData.polozky_objednavky) && formData.polozky_objednavky.length > 0) {
                          rezervovanaCastka = formData.polozky_objednavky.reduce((sum, polozka) => {
                            // ðŸ”§ FIX: Odstranit formÃ¡tovÃ¡nÃ­ pÅ™ed parseFloat
                            const cena = parseFloat((polozka.cena_s_dph || polozka.celkova_cena || '0').toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
                            const mnozstvi = parseFloat(polozka.mnozstvi || 1);
                            return sum + (cena * mnozstvi);
                          }, 0);
                        }
                        // Pokud nejsou poloÅ¾ky nebo je souÄet 0, pouÅ¾ij max_cena_s_dph
                        if (rezervovanaCastka === 0) {
                          rezervovanaCastka = parseFloat(formData.max_cena_s_dph || 0);
                        }
                      } else if (jeVeFazi78) {
                        // FÃ¡ze 7-8 pro NOVOU objednÃ¡vku: Rezervovat skuteÄnou ÄÃ¡stku z faktur
                        if (formData.faktury && Array.isArray(formData.faktury)) {
                          rezervovanaCastka = formData.faktury.reduce((sum, faktura) => {
                            return sum + parseFloat(faktura.celkova_castka || faktura.castka || 0);
                          }, 0);
                        }
                      }
                    }
                    
                    // ZbÃ½vajÃ­cÃ­ ÄÃ¡stka = celkovÃ¡ ÄÃ¡stka smlouvy - ÄerpÃ¡no - rezervovÃ¡no (pokud nenÃ­ zapoÄÃ­tÃ¡no)
                    const zbyva = celkovaCastka - cerpano - rezervovanaCastka;
                    const isNegative = zbyva < 0;
                    
                    return (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        padding: '4px 10px',
                        background: isNegative
                          ? 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'
                          : 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)',
                        border: `2px solid ${isNegative ? '#fca5a5' : '#86efac'}`,
                        borderRadius: '6px',
                        fontSize: '0.75rem',
                        fontWeight: 600,
                        color: isNegative ? '#991b1b' : '#15803d',
                        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.05)',
                        whiteSpace: 'nowrap'
                      }}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1px', alignItems: 'flex-end' }}>
                          <div style={{ fontSize: '0.6rem', opacity: 0.8, fontWeight: 500 }}>
                            SMLOUVA {formData.cislo_smlouvy}
                          </div>
                          <div style={{ fontSize: '0.85rem', fontWeight: 700 }}>
                            {Math.abs(zbyva).toLocaleString('cs-CZ', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} KÄ
                          </div>
                        </div>
                      </div>
                    );
                  })()
                )}
              </div>
              <PhaseDivider />

              <FormActions>
                <ActionButton
                  className="save-btn"
                  onClick={handleSaveOrder}
                  disabled={
                    isSaving ||
                    showSaveProgress ||
                    !canSaveOrder ||
                    (isWorkflowCompleted && !canUnlockAnything) ||
                    isLoadingEvCislo ||  // ðŸ†• Å˜EÅ ENÃ #1: Blokovat bÄ›hem loading
                    !isValidEvCislo(formData.ev_cislo)  // ðŸ†• Å˜EÅ ENÃ #3: Blokovat pokud nenÃ­ platnÃ©
                  }
                  title={
                    isLoadingEvCislo
                      ? 'NaÄÃ­tÃ¡ se evidenÄnÃ­ ÄÃ­slo...'
                      : !isValidEvCislo(formData.ev_cislo)
                        ? 'EvidenÄnÃ­ ÄÃ­slo se nepodaÅ™ilo naÄÃ­st'
                        : (isWorkflowCompleted && !canUnlockAnything)
                          ? 'ObjednÃ¡vka je dokonÄena/zamÃ­tnuta/stornovÃ¡na a uzamÄena'
                          : !canSaveOrder
                            ? 'NemÃ¡te oprÃ¡vnÄ›nÃ­ k uklÃ¡dÃ¡nÃ­ objednÃ¡vek'
                            : 'UloÅ¾it objednÃ¡vku'
                  }
                >
                  <FontAwesomeIcon icon={faSave} />
                  {isLoadingEvCislo ? 'NaÄÃ­tÃ¡m ÄÃ­slo...' : isSaving ? 'UklÃ¡dÃ¡m...' : 'ULOÅ½IT'}
                </ActionButton>

                <ActionButton
                  className="cancel-btn"
                  onClick={handleCancelOrder}
                  title="ZavÅ™Ã­t formulÃ¡Å™"
                  disabled={showSaveProgress || isSaving}
                >
                  <FontAwesomeIcon icon={faTimes} />
                  ZAVÅ˜ÃT
                </ActionButton>
              </FormActions>
            </PhaseRow>
            )}

            {/* Progress indikÃ¡tor po uloÅ¾enÃ­ objednÃ¡vky */}
            {showSaveProgress && (
              <div style={{
                padding: '1rem',
                backgroundColor: '#f0f9ff',
                borderTop: '1px solid #0ea5e9',
                borderBottom: '1px solid #0ea5e9',
              }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '1rem',
                  marginBottom: '0.75rem'
                }}>
                  <div style={{
                    fontSize: '1.5rem'
                  }}>
                    âœ…
                  </div>
                  <div>
                    <div style={{
                      fontWeight: '600',
                      color: '#0c4a6e',
                      fontSize: '1rem',
                      marginBottom: '0.25rem'
                    }}>
                      ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› uloÅ¾ena!
                    </div>
                    <div style={{
                      color: '#075985',
                      fontSize: '0.875rem'
                    }}>
                      {saveProgressText}
                    </div>
                  </div>
                </div>

                {/* Progress bar */}
                <div style={{
                  width: '100%',
                  height: '8px',
                  backgroundColor: '#e0f2fe',
                  borderRadius: '4px',
                  overflow: 'hidden'
                }}>
                  <div style={{
                    width: `${saveProgress}%`,
                    height: '100%',
                    backgroundColor: '#0ea5e9',
                    transition: 'width 2s linear',
                    borderRadius: '4px'
                  }} />
                </div>

                <div style={{
                  marginTop: '0.5rem',
                  fontSize: '0.75rem',
                  color: '#0369a1',
                  textAlign: 'center'
                }}>
                  PÅ™esmÄ›rovÃ¡vÃ¡m na seznam objednÃ¡vek...
                </div>
              </div>
            )}
          </FixedHeaderContent>
        </FixedHeader>

        {/* ScrollovatelnÃ½ obsah s tab navigacÃ­ */}
        <ScrollableContent ref={scrollableContentRef} onKeyDown={handleFormKeyDown}>
          <ScrollableInner>

          {/* Sekce: Informace o objednateli */}
          <FormSection data-section="objednatel">
        <SectionHeader
          sectionTheme={getSectionTheme('objednatel')}
          isActive={isSectionActive('objednatel')}
        >
          <SectionTitle sectionTheme={getSectionTheme('objednatel')}>
            <SectionIcon sectionTheme={getSectionTheme('objednatel')}>
              <FontAwesomeIcon icon={faUser} />
            </SectionIcon>
            Informace o objednateli
            {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
            {shouldLockPhase1Sections && !shouldLockAllSections && (
              <LockWarning title="FÃZE 1 a FÃZE 2 sekce jsou zamÄeny pokud je aktivnÃ­ FÃZE 3. OdemÄenÃ­ resetuje workflow na ODESLÃNA KE SCHVÃLENÃ a vymaÅ¾e data FÃZE 3+.">
                ðŸ”’ Sekce zamÄena
              </LockWarning>
            )}
          </SectionTitle>
          <SectionControls>
            {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
            {shouldLockPhase1Sections && !shouldLockAllSections && canEditApprovedSections && (
              <UnlockButton
                onClick={(e) => {
                  e.stopPropagation();
                  setShowUnlockPhase1Confirm(true);
                }}
                title="Odemknout FÃZI 2 (Info o objednateli) - resetuje workflow na ODESLÃNA KE SCHVÃLENÃ"
              >
                <Unlock />
              </UnlockButton>
            )}
            <CollapseIcon
              collapsed={sectionStates.objednatel}
              sectionTheme={getSectionTheme('objednatel')}
              onClick={() => toggleSection('objednatel')}
              style={{ cursor: 'pointer' }}
            >
              <FontAwesomeIcon icon={faChevronUp} />
            </CollapseIcon>
          </SectionControls>
        </SectionHeader>
        <SectionContent collapsed={sectionStates.objednatel}>
          <FormRow>
            <FormGroup>
              <Label required>JMÃ‰NO</Label>
              <InputWithIcon hasIcon>
                <User />
                <Input
                  type="text"
                  name="jmeno"
                  placeholder="JmÃ©no objednatele"
                  value={formData.jmeno || ''}
                  disabled
                  title={isEditMode ? "NaÄteno z DB podle objednatele objednÃ¡vky" : (formData.jmeno ? "NaÄteno z profilu pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele" : "VyplnÃ­ se automaticky pÅ™i prvnÃ­ interakci")}
                  hasError={!!validationErrors.jmeno}
                  hasIcon
                />
              </InputWithIcon>
              {validationErrors.jmeno && (
                <ErrorText>{validationErrors.jmeno}</ErrorText>
              )}
            </FormGroup>
            <FormGroup>
              <Label required>E-MAIL</Label>
              <InputWithIcon hasIcon>
                <Mail />
                <Input
                  type="email"
                  name="email"
                  value={formData.email || ''}
                  disabled
                  title={isEditMode ? "NaÄteno z DB podle objednatele objednÃ¡vky" : (formData.email ? "NaÄteno z profilu pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele" : "VyplnÃ­ se automaticky pÅ™i prvnÃ­ interakci")}
                  hasError={!!validationErrors.email}
                  hasIcon
                />
              </InputWithIcon>
              {validationErrors.email && (
                <ErrorText>{validationErrors.email}</ErrorText>
              )}
            </FormGroup>
            <FormGroup>
              <Label>TELEFON</Label>
              <InputWithIcon hasIcon>
                <Phone />
                <Input
                  type="tel"
                  value={formData.telefon || ''}
                  disabled
                  placeholder={formData.telefon ? '' : (isEditMode ? "Telefon nenÃ­ v DB uveden" : "VyplnÃ­ se automaticky pÅ™i prvnÃ­ interakci")}
                  title={isEditMode ? "NaÄteno z DB podle objednatele objednÃ¡vky" : (formData.telefon ? "NaÄteno z profilu pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele" : "VyplnÃ­ se automaticky pÅ™i prvnÃ­ interakci")}
                  hasIcon
                />
              </InputWithIcon>
            </FormGroup>
          </FormRow>
          <FormRow>
            <FormGroup data-custom-select>
              <Label required>GARANT</Label>
              <StableCustomSelect
                value={formData.garant_uzivatel_id || ''}
                onChange={(selectedValue) => handleInputChange('garant_uzivatel_id', selectedValue)}
                onBlur={(field, value) => handleFieldBlur('garant_uzivatel_id', value)}
                options={garantOptions}
                placeholder="Vyberte garanta"
                disabled={shouldLockPhase1Sections}
                hasError={!!validationErrors.garant_uzivatel_id}
                required={true}
                field="garant"
                loading={false}
                loadingText=""
                icon={<User />}
                isClearable={true}
                getOptionLabel={getOptionLabel}
                getOptionValue={(option, field) => option.id || option.user_id || option}
                hasTriedToSubmit={hasTriedToSubmit}
              />
              {(validationErrors.garant_uzivatel_id || (hasTriedToSubmit && !formData.garant_uzivatel_id)) && (
                <ErrorText>
                  {validationErrors.garant_uzivatel_id || 'Garant je povinnÃ½'}
                </ErrorText>
              )}
            </FormGroup>
          </FormRow>
        </SectionContent>
      </FormSection>

      {/* Sekce: SchvÃ¡lenÃ­ nÃ¡kupu PO */}
      <FormSection data-section="schvaleni">
        <SectionHeader
          sectionTheme={getSectionTheme('schvaleni')}
          isActive={isSectionActive('schvaleni')}
        >
          <SectionTitle sectionTheme={getSectionTheme('schvaleni')}>
            <SectionIcon sectionTheme={getSectionTheme('schvaleni')}>
              <FontAwesomeIcon icon={faClipboardCheck} />
            </SectionIcon>
            SchvÃ¡lenÃ­ nÃ¡kupu PO
            {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
            {shouldLockPhase1Sections && !shouldLockAllSections && (
              <LockWarning title="FÃZE 1 a FÃZE 2 sekce jsou zamÄeny pokud je aktivnÃ­ FÃZE 3. OdemÄenÃ­ umoÅ¾nÃ­ editaci FÃZE 1 a 2.">
                ðŸ”’ Sekce zamÄena
              </LockWarning>
            )}
          </SectionTitle>
          <SectionControls>
            {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
            {shouldLockPhase1Sections && !shouldLockAllSections && canEditApprovedSections && (
              <UnlockButton
                onClick={(e) => {
                  e.stopPropagation();
                  setShowUnlockPhase2Confirm(true);
                }}
                title="Odemknout FÃZI 2 (PO sekce) - resetuje workflow na ODESLÃNA KE SCHVÃLENÃ"
              >
                <Unlock />
              </UnlockButton>
            )}
            <CollapseIcon
              collapsed={sectionStates.schvaleni}
              sectionTheme={getSectionTheme('schvaleni')}
              onClick={() => toggleSection('schvaleni')}
              style={{ cursor: 'pointer' }}
            >
              <FontAwesomeIcon icon={faChevronUp} />
            </CollapseIcon>
          </SectionControls>
        </SectionHeader>
        <SectionContent collapsed={sectionStates.schvaleni}>
          <FormRow>
            <FormGroup style={{gridColumn: '1 / -1'}}>
              <Label required>PÅ˜EDMÄšT</Label>
              <InputWithIcon hasIcon>
                <FileText />
                <Input
                  type="text"
                  name="predmet"
                  placeholder="Zadejte pÅ™edmÄ›t objednÃ¡vky"
                  value={formData.predmet || ''}
                  onChange={(e) => handleInputChange('predmet', e.target.value)}
                  onBlur={() => handleFieldBlur('predmet', formData.predmet)}
                  disabled={shouldLockPhase1Sections}
                  hasError={!!validationErrors.predmet}
                  hasIcon
                />
              </InputWithIcon>
              {validationErrors.predmet && (
                <ErrorText>{validationErrors.predmet}</ErrorText>
              )}
            </FormGroup>
          </FormRow>
          <FormRow>
            <FormGroup data-custom-select>
              <Label required>PÅ˜ÃKAZCE</Label>
              <StableCustomSelect
                value={formData.prikazce_id || ''}
                onChange={(selectedValue) => handleInputChange('prikazce_id', selectedValue)}
                onBlur={(field, value) => handleFieldBlur('prikazce_id', value)}
                options={approvers}
                placeholder="Vyberte pÅ™Ã­kazce operace"
                disabled={shouldLockPhase1Sections}
                hasError={!!validationErrors.prikazce_id}
                required={true}
                field="prikazce"
                loading={false}
                loadingText=""
                icon={<Users />}
                isClearable={true}
                getOptionLabel={getOptionLabel}
                getOptionValue={(option, field) => option.id || option.user_id || option}
                hasTriedToSubmit={hasTriedToSubmit}
              />
              {(validationErrors.prikazce_id || (hasTriedToSubmit && !formData.prikazce_id)) && (
                <ErrorText>
                  {validationErrors.prikazce_id || 'PÅ™Ã­kazce je povinnÃ½'}
                </ErrorText>
              )}
            </FormGroup>
            <FormGroup>
              <Label required>MAXIMÃLNÃ CENA S DPH</Label>
              <CurrencyInput
                fieldName="max_cena_s_dph"
                value={formData.max_cena_s_dph || ''}
                onChange={handleCurrencyChange}
                onBlur={handleFieldBlur}
                disabled={shouldLockPhase1Sections}
                hasError={!!validationErrors.max_cena_s_dph}
                placeholder="380 000 KÄ"
              />
              {validationErrors.max_cena_s_dph && (
                <ErrorText>{validationErrors.max_cena_s_dph}</ErrorText>
              )}
            </FormGroup>
            <FormGroup>
              <Label>MIMOÅ˜ÃDNÃ UDÃLOST</Label>
              <EmergencyToggleWrapper disabled={shouldLockPhase1Sections} style={{ height: '50px' }}>
                <EmergencyToggleSwitch 
                  checked={formData.mimoradna_udalost || false}
                  disabled={shouldLockPhase1Sections}
                >
                  <input
                    type="checkbox"
                    checked={formData.mimoradna_udalost || false}
                    onChange={(e) => handleInputChange('mimoradna_udalost', e.target.checked)}
                    disabled={shouldLockPhase1Sections}
                  />
                  <span />
                </EmergencyToggleSwitch>
                <EmergencyToggleLabel checked={formData.mimoradna_udalost || false}>
                  {formData.mimoradna_udalost ? 'Krize / HavÃ¡rie' : 'BÄ›Å¾nÃ¡ objednÃ¡vka'}
                </EmergencyToggleLabel>
              </EmergencyToggleWrapper>
            </FormGroup>
          </FormRow>
          <FormRow>
            <FormGroup data-custom-select style={{gridColumn: '1 / -1'}}>
              <Label required>STÅ˜EDISKO</Label>
              <StableCustomSelect
                value={formData.strediska_kod || []}
                onChange={(selectedValues) => handleInputChange('strediska_kod', selectedValues)}
                onBlur={(field, value) => handleFieldBlur('strediska_kod', value)}
                options={strediskaOptions}
                placeholder="Vyberte stÅ™ediska pro objednÃ¡vku"
                field="strediska"
                disabled={shouldLockPhase1Sections}
                hasError={!!validationErrors.strediska_kod}
                required={true}
                multiple={true}
                icon={<Building />}
                isClearable={true}
                getOptionLabel={getOptionLabel}
                getOptionValue={(option, field) => option.value || option.id || option}
                hasTriedToSubmit={hasTriedToSubmit}
              />
              {validationErrors.strediska_kod && (
                <ErrorText style={{ marginTop: '0.5rem', display: 'block' }}>
                  {validationErrors.strediska_kod}
                </ErrorText>
              )}
            </FormGroup>
          </FormRow>

          {/* ðŸ’° Sekce: FinancovÃ¡nÃ­ objednÃ¡vky - PÅ˜ESUNUTO Z FÃZE 3 DO FÃZE 1/2 */}
          <FormRow style={{ marginTop: '1.5rem' }}>
            <FormGroup style={{gridColumn: '1 / -1'}}>
              {/* Å edivÃ¡ oddÄ›lovacÃ­ linka NAD sekcÃ­ financovÃ¡nÃ­ */}
              <div style={{
                borderTop: '1px solid #d1d5db',
                marginBottom: '1.5rem'
              }} />

              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label required>ZPÅ®SOB FINANCOVÃNÃ</Label>
                  <StableCustomSelect
                    value={formData.zpusob_financovani || ''}
                    onChange={(selectedValue) => handleInputChange('zpusob_financovani', selectedValue)}
                    onBlur={(field, value) => handleFieldBlur('zpusob_financovani', value)}
                    options={financovaniOptions}
                    placeholder="Vyberte zdroj financovÃ¡nÃ­..."
                    field="zpusob_financovani"
                    loading={false}
                    loadingText=""
                    icon={<Coins />}
                    isClearable={true}
                    disabled={shouldLockFinancovaniSection}
                    hasError={!!validationErrors.zpusob_financovani}
                    required={true}
                    getOptionLabel={getOptionLabel}
                    getOptionValue={(option, field) => option.kod_stavu || option.kod || option.id || option}
                  />
                  {validationErrors.zpusob_financovani && (
                    <ErrorText>{validationErrors.zpusob_financovani}</ErrorText>
                  )}
                </FormGroup>
              </FormRow>

              {/* DynamickÃ¡ pole podle vybranÃ©ho zdroje financovÃ¡nÃ­ */}
              {(() => {
                const selectedSource = financovaniOptions.find(opt => opt.kod_stavu === formData.zpusob_financovani || opt.kod === formData.zpusob_financovani);
                const nazev = selectedSource?.nazev_stavu || selectedSource?.nazev || '';
                return nazev.includes('Limitovan') || nazev.includes('pÅ™Ã­slib');
              })() && (
                <FormRow>
                  <FormGroup style={{gridColumn: '1 / -1'}}>
                    <Label required>LP KÃ“D</Label>
                    <StableCustomSelect
                      value={formData.lp_kod || []}
                      onChange={(selectedValues) => handleInputChange('lp_kod', selectedValues)}
                      onBlur={(field, value) => handleFieldBlur('lp_kod', value)}
                      options={lpKodyOptions}
                      placeholder="Vyberte LP kÃ³dy..."
                      field="lp_kod"
                      loading={false}
                      loadingText=""
                      icon={<Hash />}
                      isClearable={true}
                      disabled={shouldLockFinancovaniSection}
                      hasError={!!validationErrors.lp_kod}
                      required={true}
                      multiple={true}
                      getOptionLabel={getOptionLabel}
                      // getOptionValue ODEBRÃN - pouÅ¾ij default (opt.id || opt.value || opt)
                    />
                    {validationErrors.lp_kod && (
                      <ErrorText>{validationErrors.lp_kod}</ErrorText>
                    )}
                  </FormGroup>
                </FormRow>
              )}

              {(() => {
                const selectedSource = financovaniOptions.find(opt => opt.kod === formData.zpusob_financovani);
                const nazev = selectedSource?.nazev || '';
                return nazev.includes('Smlouva');
              })() && (
                <>
                  <FormRow style={{gridTemplateColumns: '1fr 2fr'}}>
                    <FormGroup>
                      <Label required>ÄŒÃSLO SMLOUVY</Label>
                      <SmlouvaAutocompleteContainer>
                        <InputWithIcon hasIcon style={
                          formData.cislo_smlouvy && smlouvaDetail && !smlouvaDetail.notFound && 
                          (smlouvaDetail.stav === 'VYPRSELA' || smlouvaDetail.stav === 'UKONCENA')
                            ? { border: '2px solid #f97316', borderRadius: '6px' }
                            : {}
                        }>
                          <Search />
                          <Input
                            type="text"
                            name="cislo_smlouvy"
                            placeholder="ZaÄnÄ›te psÃ¡t ÄÃ­slo smlouvy..."
                            value={smlouvaSearchTerm}
                            onChange={(e) => {
                              const value = e.target.value;
                              setSmlouvaSearchTerm(value);
                              setShowSmlouvySuggestions(value.length > 0);
                              setSelectedSmlouvaSuggestionIndex(-1);
                              
                              // Pokud uÅ¾ivatel maÅ¾e text, vyÄistit i formData
                              if (!value) {
                                handleInputChange('cislo_smlouvy', '');
                              }
                            }}
                            onKeyDown={(e) => {
                              if (!showSmlouvySuggestions) return;
                              
                              const searchLower = normalizeText(smlouvaSearchTerm);
                              const filtered = smlouvyList.filter(s => {
                                if (s.aktivni == 0 || s.aktivni === false) return false;
                                const cislo = normalizeText(s.cislo_smlouvy || s.evidencni_cislo || '');
                                const nazev = normalizeText(s.nazev_smlouvy || s.predmet || '');
                                const firma = normalizeText(s.nazev_firmy || '');
                                const ico = normalizeText(s.ico || '');
                                const usek = normalizeText(s.usek_zkr || '');
                                return cislo.includes(searchLower) || 
                                       nazev.includes(searchLower) || 
                                       firma.includes(searchLower) || 
                                       ico.includes(searchLower) || 
                                       usek.includes(searchLower);
                              }).slice(0, 10);
                              
                              if (e.key === 'ArrowDown') {
                                e.preventDefault();
                                setSelectedSmlouvaSuggestionIndex(prev => 
                                  prev < filtered.length - 1 ? prev + 1 : prev
                                );
                              } else if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                setSelectedSmlouvaSuggestionIndex(prev => 
                                  prev > 0 ? prev - 1 : -1
                                );
                              } else if (e.key === 'Enter' && selectedSmlouvaSuggestionIndex >= 0) {
                                e.preventDefault();
                                const selected = filtered[selectedSmlouvaSuggestionIndex];
                                if (selected) {
                                  const cislo = selected.cislo_smlouvy || selected.evidencni_cislo;
                                  handleInputChange('cislo_smlouvy', cislo);
                                  setSmlouvaSearchTerm(cislo);
                                  setShowSmlouvySuggestions(false);
                                  setSelectedSmlouvaSuggestionIndex(-1);
                                }
                              } else if (e.key === 'Escape') {
                                setShowSmlouvySuggestions(false);
                                setSelectedSmlouvaSuggestionIndex(-1);
                              }
                            }}
                            onFocus={() => {
                              // Zobrazit suggestions pÅ™i focusu, pokud uÅ¾ mÃ¡ nÄ›jakÃ½ search term
                              if (smlouvaSearchTerm && smlouvaSearchTerm.length > 0) {
                                setShowSmlouvySuggestions(true);
                              }
                            }}
                            onBlur={(e) => {
                              // Delay hiding to allow click on suggestion
                              setTimeout(() => {
                                setShowSmlouvySuggestions(false);
                                setSelectedSmlouvaSuggestionIndex(-1);
                                
                                // ðŸ”’ VALIDACE: Pokud search term neodpovÃ­dÃ¡ Å¾Ã¡dnÃ© aktivnÃ­ smlouvÄ›, vyÄistit pole
                                const searchValue = smlouvaSearchTerm.trim();
                                if (searchValue) {
                                  const existsInList = smlouvyList.some(s => 
                                    (s.aktivni !== 0 && s.aktivni !== false) &&
                                    (s.cislo_smlouvy === searchValue || s.evidencni_cislo === searchValue)
                                  );
                                  
                                  if (existsInList) {
                                    // Je platnÃ¡ smlouva - zajistit, Å¾e je uloÅ¾enÃ¡ do formData
                                    if (formData.cislo_smlouvy !== searchValue) {
                                      handleInputChange('cislo_smlouvy', searchValue);
                                    }
                                  } else {
                                    // Nevybral Å¾Ã¡dnou platnou smlouvu - vyÄistit
                                    handleInputChange('cislo_smlouvy', '');
                                    setSmlouvaSearchTerm('');
                                    showToast('Vyberte prosÃ­m smlouvu ze seznamu', 'warning');
                                  }
                                }
                              }, 200);
                            }}
                            disabled={shouldLockFinancovaniSection}
                            hasError={!!validationErrors.cislo_smlouvy}
                            hasIcon
                          />
                        </InputWithIcon>
                        
                        {/* Autocomplete dropdown */}
                        {showSmlouvySuggestions && smlouvaSearchTerm && smlouvaSearchTerm.length > 0 && (
                          <SmlouvaSuggestionsList>
                            {(() => {
                              const searchLower = normalizeText(smlouvaSearchTerm);
                              // âœ… FILTR: VylouÄit neaktivnÃ­ smlouvy (aktivni == 0)
                              const filtered = smlouvyList.filter(s => {
                                // VylouÄit neaktivnÃ­ (aktivni == 0)
                                if (s.aktivni == 0 || s.aktivni === false) return false;
                                
                                const cislo = normalizeText(s.cislo_smlouvy || s.evidencni_cislo || '');
                                const nazev = normalizeText(s.nazev_smlouvy || s.predmet || '');
                                const firma = normalizeText(s.nazev_firmy || '');
                                const ico = normalizeText(s.ico || '');
                                const usek = normalizeText(s.usek_zkr || '');
                                
                                return cislo.includes(searchLower) || 
                                       nazev.includes(searchLower) || 
                                       firma.includes(searchLower) || 
                                       ico.includes(searchLower) || 
                                       usek.includes(searchLower);
                              }).slice(0, 10);

                              if (loadingSmlouvyList) {
                                return (
                                  <SmlouvaSuggestionEmpty>
                                    â³ NaÄÃ­tÃ¡m smlouvy...
                                  </SmlouvaSuggestionEmpty>
                                );
                              }

                              if (filtered.length === 0) {
                                return (
                                  <SmlouvaSuggestionEmpty>
                                    âŒ Å½Ã¡dnÃ¡ smlouva nenalezena
                                  </SmlouvaSuggestionEmpty>
                                );
                              }

                              return filtered.map((smlouva, index) => {
                                // âš ï¸ Kontrola vyprÅ¡enÃ© smlouvy
                                const jeVyprsela = smlouva.stav === 'VYPRSELA' || smlouva.stav === 'UKONCENA';
                                const isSelected = index === selectedSmlouvaSuggestionIndex;
                                
                                return (
                                  <SmlouvaSuggestionItem
                                    key={smlouva.id}
                                    onMouseDown={(e) => {
                                      // onMouseDown se spustÃ­ PÅ˜ED onBlur inputu, takÅ¾e hodnota se nastavÃ­ vÄas
                                      e.preventDefault(); // ZabrÃ¡nÃ­ blur eventu
                                      const cislo = smlouva.cislo_smlouvy || smlouva.evidencni_cislo;
                                      handleInputChange('cislo_smlouvy', cislo);
                                      setSmlouvaSearchTerm(cislo);
                                      setShowSmlouvySuggestions(false);
                                      setSelectedSmlouvaSuggestionIndex(-1);
                                    }}
                                    style={{
                                      ...(jeVyprsela ? { borderLeft: '3px solid #f97316', opacity: 0.8 } : {}),
                                      ...(isSelected ? { backgroundColor: '#eff6ff', borderLeft: '3px solid #3b82f6' } : {})
                                    }}
                                  >
                                    <SmlouvaSuggestionTitle>
                                      {smlouva.cislo_smlouvy || smlouva.evidencni_cislo}
                                      {jeVyprsela && <span style={{ color: '#f97316', marginLeft: '8px', fontSize: '0.85em' }}>âš ï¸ VYPRÅ ELA</span>}
                                    </SmlouvaSuggestionTitle>
                                    <SmlouvaSuggestionMeta>
                                      {smlouva.nazev_smlouvy && <span>{smlouva.nazev_smlouvy}</span>}
                                      {smlouva.celkova_castka && (
                                        <span>
                                          {new Intl.NumberFormat('cs-CZ', { 
                                            style: 'currency', 
                                            currency: 'CZK',
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                          }).format(smlouva.celkova_castka)}
                                        </span>
                                      )}
                                    </SmlouvaSuggestionMeta>
                                    {smlouva.nazev_firmy && (
                                      <SmlouvaSuggestionMeta style={{ fontSize: '0.8em', color: '#6b7280', marginTop: '2px' }}>
                                        <span>ðŸ¢ {smlouva.nazev_firmy}{smlouva.ico ? ` (${smlouva.ico})` : ''}{smlouva.usek_zkr ? ` | ${smlouva.usek_zkr}` : ''}</span>
                                      </SmlouvaSuggestionMeta>
                                    )}
                                  </SmlouvaSuggestionItem>
                                );
                              });
                            })()}
                          </SmlouvaSuggestionsList>
                        )}
                      </SmlouvaAutocompleteContainer>
                      
                      {validationErrors.cislo_smlouvy && (
                        <ErrorText>{validationErrors.cislo_smlouvy}</ErrorText>
                      )}
                    </FormGroup>
                    <FormGroup>
                      <Label>POZNÃMKA KE SMLOUVÄš</Label>
                      <InputWithIcon hasIcon>
                        <FileText />
                        <Input
                          type="text"
                          name="smlouva_poznamka"
                          placeholder="DodateÄnÃ© informace o smlouvÄ›"
                          value={formData.smlouva_poznamka || ''}
                          onChange={(e) => handleInputChange('smlouva_poznamka', e.target.value)}
                          onBlur={() => handleFieldBlur('smlouva_poznamka', formData.smlouva_poznamka)}
                          disabled={shouldLockFinancovaniSection}
                          hasError={!!validationErrors.smlouva_poznamka}
                          hasIcon
                        />
                      </InputWithIcon>
                      {validationErrors.smlouva_poznamka && (
                        <ErrorText>{validationErrors.smlouva_poznamka}</ErrorText>
                      )}
                    </FormGroup>
                  </FormRow>
                  
                  {/* âš ï¸ VAROVÃNÃ PRO VYPRÅ ELOU SMLOUVU - pÅ™es celou Å¡Ã­Å™ku */}
                  {formData.cislo_smlouvy && smlouvaDetail && !smlouvaDetail.notFound && 
                    (smlouvaDetail.stav === 'VYPRSELA' || smlouvaDetail.stav === 'UKONCENA') && (
                    <div style={{
                      marginTop: '-8px',
                      marginBottom: '16px',
                      padding: '8px 12px',
                      background: '#fff7ed',
                      border: '2px solid #f97316',
                      borderRadius: '6px',
                      color: '#c2410c',
                      fontSize: '0.9rem',
                      fontWeight: 600,
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}>
                      âš ï¸ Smlouva jiÅ¾ vyprÅ¡ela!!! 
                      {smlouvaDetail.platnost_do && (
                        <span style={{ fontSize: '0.85rem', fontWeight: 500 }}>
                          Platnost byla do {new Date(smlouvaDetail.platnost_do).toLocaleDateString('cs-CZ')}
                        </span>
                      )}
                    </div>
                  )}


                </>
              )}

              {(() => {
                const selectedSource = financovaniOptions.find(opt => opt.kod === formData.zpusob_financovani);
                const nazev = selectedSource?.nazev || '';
                return nazev.includes('IndividuÃ¡lnÃ­') && !nazev.includes('PojistnÃ¡');
              })() && (
                <FormRow style={{gridTemplateColumns: '1fr 2fr'}}>
                  <FormGroup>
                    <Label required>IDENTIFIKÃTOR SCHVÃLENÃ</Label>
                    <InputWithIcon hasIcon>
                      <Hash />
                      <Input
                        type="text"
                        name="individualni_schvaleni"
                        placeholder="ÄŒÃ­slo nebo kÃ³d schvÃ¡lenÃ­"
                        value={formData.individualni_schvaleni || ''}
                        onChange={(e) => handleInputChange('individualni_schvaleni', e.target.value)}
                        disabled={shouldLockFinancovaniSection}
                        hasError={!!validationErrors.individualni_schvaleni}
                        hasIcon
                      />
                    </InputWithIcon>
                    {validationErrors.individualni_schvaleni && (
                      <ErrorText>{validationErrors.individualni_schvaleni}</ErrorText>
                    )}
                  </FormGroup>
                  <FormGroup>
                    <Label>POZNÃMKA</Label>
                    <InputWithIcon hasIcon>
                      <FileText />
                      <Input
                        type="text"
                        name="individualni_poznamka"
                        placeholder="DÅ¯vod nebo podmÃ­nky schvÃ¡lenÃ­"
                        value={formData.individualni_poznamka || ''}
                        onChange={(e) => handleInputChange('individualni_poznamka', e.target.value)}
                        disabled={shouldLockFinancovaniSection}
                        hasError={!!validationErrors.individualni_poznamka}
                        hasIcon
                      />
                    </InputWithIcon>
                    {validationErrors.individualni_poznamka && (
                      <ErrorText>{validationErrors.individualni_poznamka}</ErrorText>
                    )}
                  </FormGroup>
                </FormRow>
              )}

              {(() => {
                const selectedSource = financovaniOptions.find(opt => opt.kod === formData.zpusob_financovani);
                const nazev = selectedSource?.nazev || '';
                return nazev.includes('PojistnÃ¡') && nazev.includes('udÃ¡lost');
              })() && (
                <FormRow style={{gridTemplateColumns: '1fr 2fr'}}>
                  <FormGroup>
                    <Label required>ÄŒÃSLO POJISTNÃ‰ UDÃLOSTI</Label>
                    <InputWithIcon hasIcon>
                      <Hash />
                      <Input
                        type="text"
                        name="pojistna_udalost_cislo"
                        placeholder="EvidenÄnÃ­ ÄÃ­slo Å¡kody/udÃ¡losti"
                        value={formData.pojistna_udalost_cislo || ''}
                        onChange={(e) => handleInputChange('pojistna_udalost_cislo', e.target.value)}
                        disabled={shouldLockFinancovaniSection}
                        hasError={!!validationErrors.pojistna_udalost_cislo}
                        hasIcon
                      />
                    </InputWithIcon>
                    {validationErrors.pojistna_udalost_cislo && (
                      <ErrorText>{validationErrors.pojistna_udalost_cislo}</ErrorText>
                    )}
                  </FormGroup>
                  <FormGroup>
                    <Label>POZNÃMKA K POJISTNÃ‰ UDÃLOSTI</Label>
                    <InputWithIcon hasIcon>
                      <FileText />
                      <Input
                        type="text"
                        name="pojistna_udalost_poznamka"
                        placeholder="Popis Å¡kody nebo okolnostÃ­ udÃ¡losti"
                        value={formData.pojistna_udalost_poznamka || ''}
                        onChange={(e) => handleInputChange('pojistna_udalost_poznamka', e.target.value)}
                        disabled={shouldLockFinancovaniSection}
                        hasError={!!validationErrors.pojistna_udalost_poznamka}
                        hasIcon
                      />
                    </InputWithIcon>
                    {validationErrors.pojistna_udalost_poznamka && (
                      <ErrorText>{validationErrors.pojistna_udalost_poznamka}</ErrorText>
                    )}
                  </FormGroup>
                </FormRow>
              )}
            </FormGroup>
          </FormRow>

          {/* ðŸ“‹ Sekce: Stav schvÃ¡lenÃ­ - v samostatnÃ©m bloku */}
          <FormRow>
            <FormGroup style={{gridColumn: '1 / -1'}}>
              {/* ðŸ”§ Sekce STAV SCHVÃLENÃ se zobrazÃ­ kdyÅ¾:
                  1. ObjednÃ¡vka je uloÅ¾ena v DB (mÃ¡ ID)
                  2. Workflow NENÃ ve stavu NOVA (tzn. mÃ¡ jinÃ½ stav neÅ¾ novÃ¡ objednÃ¡vka)
                  3. UÅ¾ivatel mÃ¡ oprÃ¡vnÄ›nÃ­ ke schvalovÃ¡nÃ­ (admin nebo ORDER_APPROVAL role)

                  Zobrazuje se pro stavy: CEKA_SE, ZAMITNUTO, SCHVALENO, ODESLAN_KE_SCHVALENI a dalÅ¡Ã­
                  SkrÃ½vÃ¡ se pouze pro stav NOVA nebo pokud uÅ¾ivatel nemÃ¡ oprÃ¡vnÄ›nÃ­ */}
              {!!formData.id &&
               !hasWorkflowState(formData.stav_workflow_kod, 'NOVA') &&
               (canApproveOrders || canManageOrders) && (
                <>
                  {/* Å edivÃ¡ oddÄ›lovacÃ­ linka NAD celou sekcÃ­ schvÃ¡lenÃ­ */}
                  <div style={{
                    borderTop: '1px solid #d1d5db',
                    marginBottom: '1.5rem',
                    marginTop: '1rem'
                  }} />

                  <div style={{gridColumn: '1 / -1'}}>
                    {/* Checkboxy - zobrazit JEN kdyÅ¾ je objednÃ¡vka ULOÅ½ENA v DB */}
                    {!!formData.id && (
                      <>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                          <Label style={{ fontSize: '1rem', fontWeight: '600', margin: 0 }}>
                            STAV SCHVÃLENÃ OBJEDNÃVKY
                          </Label>
                          {isFormBasicallyValid() && formData.stav_schvaleni && (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                              <span style={{ fontWeight: 'bold' , color: '#374151', fontSize: '0.875rem' }}>
                                Schvaluje:
                              </span>
                              <span style={{
                                fontWeight: '600',
                                color: '#059669',
                                backgroundColor: '#d1fae5',
                                padding: '0.25rem 0.5rem',
                                borderRadius: '4px',
                                fontSize: '0.875rem'
                              }}>
                                {getUserNameById(user_id)}
                              </span>
                            </div>
                          )}
                        </div>

                    {/* ÄŒekÃ¡ se */}
                    <label style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '1rem',
                      padding: '1rem',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      backgroundColor: formData.stav_schvaleni === 'ceka_se' ? '#fef3c7' : '#f9fafb',
                      cursor: shouldLockSchvaleniCheckboxes ? 'not-allowed' : 'pointer',
                      opacity: shouldLockSchvaleniCheckboxes ? 0.6 : 1,
                      marginBottom: '1rem',
                      fontSize: '1rem',
                      fontWeight: '500',
                      color: formData.stav_schvaleni === 'ceka_se' ? '#f59e0b' : '#374151',
                      pointerEvents: shouldLockSchvaleniCheckboxes ? 'none' : 'auto'
                    }}
                    onClick={(e) => {
                      e.preventDefault();
                      handleRadioClick('ceka_se');
                    }}
                    >
                      <input
                        type="radio"
                        name="stav_schvaleni"
                        value="ceka_se"
                        checked={formData.stav_schvaleni === 'ceka_se'}
                        onChange={() => {}}
                        disabled={shouldLockSchvaleniCheckboxes}
                        style={{
                          width: '20px',
                          height: '20px',
                          accentColor: '#f59e0b',
                          margin: 0,
                          flexShrink: 0
                        }}
                      />
                      <FontAwesomeIcon icon={faClock} size="lg" />
                      ÄŒekÃ¡ se
                      {formData.stav_schvaleni === 'ceka_se' && (
                        <span style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          color: '#f59e0b',
                          fontWeight: '600'
                        }}>
                          â³
                        </span>
                      )}
                    </label>

                    {/* NeschvÃ¡leno */}
                    <label style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '1rem',
                      padding: '1rem',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      backgroundColor: formData.stav_schvaleni === 'neschvaleno' ? '#fef2f2' : '#f9fafb',
                      cursor: shouldLockSchvaleniCheckboxes ? 'not-allowed' : 'pointer',
                      opacity: shouldLockSchvaleniCheckboxes ? 0.6 : 1,
                      marginBottom: '1rem',
                      fontSize: '1rem',
                      fontWeight: '500',
                      color: formData.stav_schvaleni === 'neschvaleno' ? '#dc2626' : '#374151',
                      pointerEvents: shouldLockSchvaleniCheckboxes ? 'none' : 'auto'
                    }}
                    onClick={(e) => {
                      e.preventDefault();
                      handleRadioClick('neschvaleno');
                    }}
                    >
                      <input
                        type="radio"
                        name="stav_schvaleni"
                        value="neschvaleno"
                        checked={formData.stav_schvaleni === 'neschvaleno'}
                        onChange={() => {}}
                        disabled={shouldLockSchvaleniCheckboxes}
                        style={{
                          width: '20px',
                          height: '20px',
                          accentColor: '#dc2626',
                          margin: 0,
                          flexShrink: 0
                        }}
                      />
                      <FontAwesomeIcon icon={faTimes} size="lg" />
                      NeschvÃ¡leno
                      {formData.stav_schvaleni === 'neschvaleno' && (
                        <span style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          color: '#dc2626',
                          fontWeight: '600'
                        }}>
                          âœ—
                        </span>
                      )}
                    </label>

                    {/* SchvÃ¡leno */}
                    <label style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '1rem',
                      padding: '1rem',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      backgroundColor: formData.stav_schvaleni === 'schvaleno' ? '#f0fdf4' : '#f9fafb',
                      cursor: shouldLockSchvaleniCheckboxes ? 'not-allowed' : 'pointer',
                      opacity: shouldLockSchvaleniCheckboxes ? 0.6 : 1,
                      fontSize: '1rem',
                      fontWeight: '500',
                      color: formData.stav_schvaleni === 'schvaleno' ? '#15803d' : '#374151',
                      pointerEvents: shouldLockSchvaleniCheckboxes ? 'none' : 'auto'
                    }}
                    onClick={(e) => {
                      e.preventDefault();
                      handleRadioClick('schvaleno');
                    }}
                    >
                      <input
                        type="radio"
                        name="stav_schvaleni"
                        value="schvaleno"
                        checked={formData.stav_schvaleni === 'schvaleno'}
                        onChange={() => {}}
                        disabled={shouldLockSchvaleniCheckboxes}
                        style={{
                          width: '20px',
                          height: '20px',
                          accentColor: '#16a34a',
                          margin: 0,
                          flexShrink: 0
                        }}
                      />
                      <FontAwesomeIcon icon={faCheck} size="lg" />
                      SchvÃ¡leno
                      {formData.stav_schvaleni === 'schvaleno' && (
                        <span style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          color: '#15803d',
                          fontWeight: '600'
                        }}>
                          âœ“
                        </span>
                      )}
                    </label>

                    {/* DÅ¯vod na stejnÃ©m Å™Ã¡dku */}
                    {(formData.stav_schvaleni === 'neschvaleno' || formData.stav_schvaleni === 'ceka_se') && (
                      <div style={{ flex: '1', minWidth: '300px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          <label style={{
                            fontWeight: '500',
                            color: '#374151',
                            fontSize: '0.875rem',
                            whiteSpace: 'nowrap'
                          }}>
                            DÅ¯vod:
                            <span style={{ color: '#dc2626', marginLeft: '2px' }}>*</span>
                          </label>
                          <InputWithIcon hasIcon style={{ flex: 1 }}>
                            <FileText />
                            <Input
                              type="text"
                              value={formData.schvaleni_komentar || ''}
                              onChange={(e) => handleInputChange('schvaleni_komentar', e.target.value)}
                              onBlur={() => handleFieldBlur('schvaleni_komentar', formData.schvaleni_komentar)}
                              placeholder={
                                formData.stav_schvaleni === 'neschvaleno'
                                  ? "UveÄte dÅ¯vod neschvÃ¡lenÃ­..."
                                  : "UveÄte dÅ¯vod ÄekÃ¡nÃ­ na schvÃ¡lenÃ­..."
                              }
                              hasIcon
                              hasError={!!validationErrors.schvaleni_komentar}
                            />
                          </InputWithIcon>
                        </div>
                        {validationErrors.schvaleni_komentar && (
                          <ErrorText style={{ marginTop: '0.25rem' }}>{validationErrors.schvaleni_komentar}</ErrorText>
                        )}
                      </div>
                    )}
                    </>
                  )}

                  {/* ðŸ“Š INFO BOX - ZobrazÃ­ se POD checkboxy AÅ½ PO ULOÅ½ENÃ DO DATABÃZE */}
                  {/* ZobrazÃ­ se pouze kdyÅ¾ workflow stav obsahuje SCHVALENA (= uloÅ¾eno v DB se schvÃ¡lenÃ­m) */}
                  {hasWorkflowState(formData.stav_workflow_kod, 'SCHVALENA') && formData.stav_schvaleni && !!formData.schvalovatel_id && formData.dt_schvaleni && (
                    <div style={{
                      marginTop: '1rem',
                      padding: '1rem',
                      backgroundColor: formData.stav_schvaleni === 'schvaleno' ? '#dcfce7' :
                                      formData.stav_schvaleni === 'neschvaleno' ? '#fef2f2' : '#fef3c7',
                      border: formData.stav_schvaleni === 'schvaleno' ? '1px solid #16a34a' :
                              formData.stav_schvaleni === 'neschvaleno' ? '1px solid #f87171' : '1px solid #f59e0b',
                      borderRadius: '8px',
                      color: formData.stav_schvaleni === 'schvaleno' ? '#166534' :
                             formData.stav_schvaleni === 'neschvaleno' ? '#991b1b' : '#92400e',
                    }}>
                      <div style={{
                        fontSize: '1rem',
                        fontWeight: '600',
                        marginBottom: '0.75rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem'
                      }}>
                        <span style={{ fontSize: '1.25rem' }}>
                          {formData.stav_schvaleni === 'schvaleno' ? 'âœ…' :
                           formData.stav_schvaleni === 'neschvaleno' ? 'âŒ' : 'â³'}
                        </span>
                        {formData.stav_schvaleni === 'schvaleno' ? 'ObjednÃ¡vka mÃ¡ stav: SchvÃ¡lenÃ¡ objednÃ¡vka' :
                         formData.stav_schvaleni === 'neschvaleno' ? 'ObjednÃ¡vka mÃ¡ stav: ZamÃ­tnuta objednÃ¡vka' :
                         'ObjednÃ¡vka ÄekÃ¡ na doplnÄ›nÃ­ podkladÅ¯'}
                      </div>
                      <div style={{ fontSize: '0.875rem', lineHeight: '1.6' }}>
                        <div style={{ marginBottom: '0.5rem' }}>
                          <strong>Datum schvÃ¡lenÃ­:</strong> {prettyDate(formData.dt_schvaleni)} â€¢ <strong>
                            {formData.stav_schvaleni === 'schvaleno' ? 'SchvÃ¡lil:' :
                             formData.stav_schvaleni === 'neschvaleno' ? 'ZamÃ­tl:' : 'VrÃ¡til:'}
                          </strong> {getUserNameById(formData.schvalovatel_id)}
                        </div>
                        {/* KomentÃ¡Å™ se NEZOBRAZUJE pro stav schvaleno (schvÃ¡lenÃ­ nepotÅ™ebuje zdÅ¯vodnÄ›nÃ­) */}
                        {formData.schvaleni_komentar && formData.stav_schvaleni !== 'schvaleno' && (
                          <div>
                            <strong>
                              {formData.stav_schvaleni === 'neschvaleno' ? 'DÅ¯vod zamÃ­tnutÃ­:' :
                               formData.stav_schvaleni === 'ceka_se' ? 'DÅ¯vod vrÃ¡cenÃ­:' : 'KomentÃ¡Å™:'}
                            </strong> {formData.schvaleni_komentar}
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  </div>
                </>
              )}

              {/* ðŸ“Š INFO BOX PRO UÅ½IVATELE BEZ PRÃV SCHVALOVÃNÃ */}
              {/* ZobrazÃ­ se uÅ¾ivatelÅ¯m bez prÃ¡va ke schvalovÃ¡nÃ­, pokud mÃ¡ objednÃ¡vka stav schvÃ¡lenÃ­ */}
              {!!formData.id &&
               !hasWorkflowState(formData.stav_workflow_kod, 'NOVA') &&
               !(canApproveOrders || canManageOrders) &&
               formData.stav_schvaleni && !!formData.schvalovatel_id && formData.dt_schvaleni && (
                <div style={{
                  marginTop: '1rem',
                  padding: '1rem',
                  backgroundColor: formData.stav_schvaleni === 'schvaleno' ? '#dcfce7' :
                                  formData.stav_schvaleni === 'neschvaleno' ? '#fef2f2' : '#fef3c7',
                  border: formData.stav_schvaleni === 'schvaleno' ? '1px solid #16a34a' :
                          formData.stav_schvaleni === 'neschvaleno' ? '1px solid #f87171' : '1px solid #f59e0b',
                  borderRadius: '8px',
                  color: formData.stav_schvaleni === 'schvaleno' ? '#166534' :
                         formData.stav_schvaleni === 'neschvaleno' ? '#991b1b' : '#92400e',
                }}>
                  <div style={{
                    fontSize: '1rem',
                    fontWeight: '600',
                    marginBottom: '0.75rem',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}>
                    <span style={{ fontSize: '1.25rem' }}>
                      {formData.stav_schvaleni === 'schvaleno' ? 'âœ…' :
                       formData.stav_schvaleni === 'neschvaleno' ? 'âŒ' : 'â³'}
                    </span>
                    {formData.stav_schvaleni === 'schvaleno' ? 'ObjednÃ¡vka mÃ¡ stav: SchvÃ¡lenÃ¡ objednÃ¡vka' :
                     formData.stav_schvaleni === 'neschvaleno' ? 'ObjednÃ¡vka mÃ¡ stav: ZamÃ­tnuta objednÃ¡vka' :
                     'ObjednÃ¡vka ÄekÃ¡ na doplnÄ›nÃ­ podkladÅ¯'}
                  </div>
                  <div style={{ fontSize: '0.875rem', lineHeight: '1.6' }}>
                    <div style={{ marginBottom: '0.5rem' }}>
                      <strong>Datum schvÃ¡lenÃ­:</strong> {prettyDate(formData.dt_schvaleni)} â€¢ <strong>
                        {formData.stav_schvaleni === 'schvaleno' ? 'SchvÃ¡lil:' :
                         formData.stav_schvaleni === 'neschvaleno' ? 'ZamÃ­tl:' : 'VrÃ¡til:'}
                      </strong> {getUserNameById(formData.schvalovatel_id)}
                    </div>
                    {/* KomentÃ¡Å™ se NEZOBRAZUJE pro stav schvaleno (schvÃ¡lenÃ­ nepotÅ™ebuje zdÅ¯vodnÄ›nÃ­) */}
                    {formData.schvaleni_komentar && formData.stav_schvaleni !== 'schvaleno' && (
                      <div>
                        <strong>
                          {formData.stav_schvaleni === 'neschvaleno' ? 'DÅ¯vod zamÃ­tnutÃ­:' :
                           formData.stav_schvaleni === 'ceka_se' ? 'DÅ¯vod vrÃ¡cenÃ­:' : 'KomentÃ¡Å™:'}
                        </strong> {formData.schvaleni_komentar}
                      </div>
                    )}
                  </div>
                </div>
              )}

            </FormGroup>
          </FormRow>
        </SectionContent>
      </FormSection>

      {/* INFORMAÄŒNÃ BLOK - KONEC FÃZE 1 */}
      {(isArchived || currentPhase === 1) && !formData.stav_schvaleni && (
        <div style={{
          margin: '2rem 0',
          padding: '1rem 1.25rem',
          backgroundColor: '#f0f9ff',
          border: '1px solid #0ea5e9',
          borderRadius: '8px',
          color: '#0c4a6e'
        }}>
          <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            â„¹ï¸ ObjednÃ¡vka zatÃ­m nebyla schvÃ¡lena
          </div>
          <div style={{ fontSize: '0.875rem' }}>
            Abyste mohli pokraÄovat ve vyplÅˆovÃ¡nÃ­ detailÅ¯ objednÃ¡vky, pÅ™idÃ¡vÃ¡nÃ­ pÅ™Ã­loh a zadÃ¡vÃ¡nÃ­ informacÃ­ o dodavateli, je nutnÃ© nejprve objednÃ¡vku nechat schvÃ¡lit.
          </div>
        </div>
      )}

      {/* ROZÅ ÃÅ˜ENÃ‰ SEKCE - VIDITELNÃ‰ PODLE WORKFLOW STAVU */}
      {sectionVisibility.financovani && (
        <>
          {/* Sekce: Informace o dodavateli */}
          <FormSection data-section="dodavatel">
            {(() => {
              // Helper: Check if Pokladna is selected
              const selectedFinancovani = financovaniOptions.find(opt =>
                opt.kod === formData.zpusob_financovani ||
                opt.value === formData.zpusob_financovani
              );
              const nazev = selectedFinancovani?.nazev || '';
              const isPokladna = nazev.toLowerCase().includes('pokladna');

              return (
                <>
                  <SectionHeader
                    sectionTheme={getSectionTheme('dodavatel')}
                    isActive={isSectionActive('dodavatel')}
                  >
                    <SectionTitle sectionTheme={getSectionTheme('dodavatel')}>
                      <SectionIcon sectionTheme={getSectionTheme('dodavatel')}>
                        <Building />
                      </SectionIcon>
                      Dodavatel
                      {isPokladna && (
                        <LockWarning title="Sekce Dodavatel nenÃ­ potÅ™ebnÃ¡ pro objednÃ¡vky financovanÃ© z pokladny" style={{ marginLeft: '8px', color: '#ff9800' }}>
                          ðŸ’° Pokladna - dodavatel nenÃ­ vyÅ¾adovÃ¡n
                        </LockWarning>
                      )}
                    </SectionTitle>
                    <SectionControls>
                      {/* ðŸ¢ Ikona "PÅ™idat do adresÃ¡Å™e" - zobrazÃ­ se pouze pokud mÃ¡ prÃ¡vo CONTACT_MANAGE nebo CONTACT_EDIT */}
                      {checkSupplierRequiredFields() &&
                       !shouldLockPhase3Sections &&
                       !isPokladna &&
                       hasPermission &&
                       (hasPermission('CONTACT_MANAGE') || hasPermission('CONTACT_EDIT')) && (
                        <AddToDirectoryIcon
                          isActive={true}
                          onClick={handleAddSupplierToDirectory}
                          title="PÅ™idat dodavatele do adresÃ¡Å™e"
                          style={{
                            position: 'relative',
                            right: 'auto',
                            top: 'auto',
                            transform: 'none',
                            marginRight: '8px'
                          }}
                        >
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <line x1="20" y1="8" x2="20" y2="14"/>
                            <line x1="23" y1="11" x2="17" y2="11"/>
                          </svg>
                        </AddToDirectoryIcon>
                      )}
                      {isPokladna ? (
                        <CollapseIcon
                          collapsed={true}
                          sectionTheme={getSectionTheme('dodavatel')}
                          style={{ cursor: 'not-allowed', opacity: 0.5 }}
                          title="Sekce je zablokovanÃ¡ pro platbu z pokladny"
                        >
                          <FontAwesomeIcon icon={faTimes} />
                        </CollapseIcon>
                      ) : (
                        <CollapseIcon
                          collapsed={sectionStates.dodavatel}
                          sectionTheme={getSectionTheme('dodavatel')}
                          onClick={() => toggleSection('dodavatel')}
                          style={{ cursor: 'pointer' }}
                        >
                          <FontAwesomeIcon icon={faChevronUp} />
                        </CollapseIcon>
                      )}
                    </SectionControls>
                  </SectionHeader>
                </>
              );
            })()}
            <SectionContent collapsed={sectionStates.dodavatel}>
              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label required>
                    NÃZEV DODAVATELE
                    {supplierAutoFillSource && (
                      <span style={{fontWeight: 'normal', fontSize: '0.85em', color: '#666', marginLeft: '8px'}}>
                        (vyplnÄ›no z {
                          supplierAutoFillSource === 'local' ? 'lokÃ¡lnÃ­ho adresÃ¡Å™e' :
                          supplierAutoFillSource === 'ares' ? 'ARES' :
                          supplierAutoFillSource === 'smlouva' ? 'smlouvy' :
                          supplierAutoFillSource === 'smlouva-fallback' ? 'smlouvy' :
                          'automatickÃ©ho zdroje'
                        })
                      </span>
                    )}
                  </Label>
                  <InputWithIcon hasIcon style={{position: 'relative'}}>
                    <Building />
                    <Input
                      type="text"
                      name="dodavatel_nazev"
                      placeholder="NÃ¡zev spoleÄnosti"
                      value={formData.dodavatel_nazev || ''}
                      onChange={(e) => {
                        handleInputChange('dodavatel_nazev', e.target.value);
                        // Reset source pÅ™i manuÃ¡lnÃ­ ÃºpravÄ›
                        if (supplierAutoFillSource) {
                          setSupplierAutoFillSource(null);
                        }
                      }}
                      onBlur={() => handleFieldBlur('dodavatel_nazev', formData.dodavatel_nazev)}
                      hasError={!!validationErrors.dodavatel_nazev}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                      style={{paddingRight: '80px'}}
                    />
                    {/* Ikony pro vÃ½bÄ›r dodavatele */}
                    <div style={{
                      position: 'absolute',
                      right: '8px',
                      top: '50%',
                      transform: 'translateY(-50%)',
                      display: 'flex',
                      gap: '4px',
                      zIndex: 10
                    }}>
                      <SupplierSearchIcon
                        onClick={shouldLockPhase3Sections ? undefined : handleSupplierLocalSearch}
                        title={shouldLockPhase3Sections ? "ZamÄeno - sekce FÃZE 3" : "Vyhledat v lokÃ¡lnÃ­ databÃ¡zi dodavatelÅ¯"}
                        style={{ opacity: shouldLockPhase3Sections ? 0.5 : 1, cursor: shouldLockPhase3Sections ? 'not-allowed' : 'pointer' }}
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                          <circle cx="9" cy="7" r="4"/>
                          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                      </SupplierSearchIcon>
                      <AresSearchIcon
                        onClick={shouldLockPhase3Sections ? undefined : handleSupplierAresSearch}
                        title={shouldLockPhase3Sections ? "ZamÄeno - sekce FÃZE 3" : "Vyhledat v ARES registru"}
                        style={{ opacity: shouldLockPhase3Sections ? 0.5 : 1, cursor: shouldLockPhase3Sections ? 'not-allowed' : 'pointer' }}
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <ellipse cx="12" cy="5" rx="9" ry="3"/>
                          <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/>
                          <path d="M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3"/>
                        </svg>
                      </AresSearchIcon>
                    </div>
                  </InputWithIcon>
                  {validationErrors.dodavatel_nazev && (
                    <ErrorText>{validationErrors.dodavatel_nazev}</ErrorText>
                  )}
                </FormGroup>
              </FormRow>
              <FormRow style={{gridTemplateColumns: '2fr 1fr 1fr'}}>
                <FormGroup>
                  <Label required>ADRESA</Label>
                  <InputWithIcon hasIcon>
                    <MapPin />
                    <Input
                      type="text"
                      name="dodavatel_adresa"
                      placeholder="Adresa sÃ­dla"
                      value={formData.dodavatel_adresa || ''}
                      onChange={(e) => handleInputChange('dodavatel_adresa', e.target.value)}
                      onBlur={() => handleFieldBlur('dodavatel_adresa', formData.dodavatel_adresa)}
                      hasError={!!validationErrors.dodavatel_adresa}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                    />
                  </InputWithIcon>
                  {validationErrors.dodavatel_adresa && (
                    <ErrorText>{validationErrors.dodavatel_adresa}</ErrorText>
                  )}
                </FormGroup>
                <FormGroup>
                  <Label required>IÄŒO</Label>
                  <InputWithIcon hasIcon style={{position: 'relative'}}>
                    <Hash />
                    <Input
                      type="text"
                      name="dodavatel_ico"
                      placeholder="12345678"
                      value={formData.dodavatel_ico || ''}
                      onChange={(e) => handleInputChange('dodavatel_ico', e.target.value)}
                      onBlur={(e) => handleIcoBlur(e.target.value)}
                      hasError={!!validationErrors.dodavatel_ico}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                      style={{paddingRight: '36px'}}
                    />
                    {/* Ikona pro ARES vyhledÃ¡vÃ¡nÃ­ */}
                    <AresSearchIcon
                      onClick={shouldLockPhase3Sections ? undefined : handleSupplierAresSearch}
                      title={shouldLockPhase3Sections ? "ZamÄeno - sekce FÃZE 3" : "Vyhledat IÄŒO v ARES registru"}
                      style={{ opacity: shouldLockPhase3Sections ? 0.5 : 1, cursor: shouldLockPhase3Sections ? 'not-allowed' : 'pointer' }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/>
                        <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/>
                        <path d="M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3"/>
                      </svg>
                    </AresSearchIcon>

                    {/* IÄŒO Check Notification */}
                    {showIcoCheck && (
                      <IcoNotification data-status={icoCheckStatus}>
                        {icoCheckStatus === 'checking' && (
                          <>
                            <IcoNotificationTitle status="checking">Kontroluji IÄŒO...</IcoNotificationTitle>
                            <IcoNotificationMessage status="checking">
                              VyhledÃ¡vÃ¡m dodavatele podle IÄŒO v databÃ¡zi a ARES.
                            </IcoNotificationMessage>
                          </>
                        )}

                        {(icoCheckStatus === 'found-local' || icoCheckStatus === 'found-ares') && icoCheckData && (
                          <>
                            <IcoNotificationTitle status="found">
                              {icoCheckStatus === 'found-local' ? 'Dodavatel v databÃ¡zi!' : 'Dodavatel nalezen v ARES!'}
                            </IcoNotificationTitle>
                            <IcoNotificationMessage status="found">
                              <strong>{icoCheckData.nazev || icoCheckData.name || 'NÃ¡zev nenÃ­ k dispozici'}</strong><br/>
                              IÄŒO: {icoCheckData.ico}<br/>
                              {icoCheckData.dic && (<>DIÄŒ: {icoCheckData.dic}<br/></>)}
                              {(icoCheckData.adresa || icoCheckData.address) && <>{icoCheckData.adresa || icoCheckData.address}<br/></>}
                              {icoCheckData.zastoupeny && (<>ZastoupenÃ½: {icoCheckData.zastoupeny}<br/></>)}
                              {icoCheckData.kontakt_jmeno && (
                                <>Kontakt: {icoCheckData.kontakt_jmeno}
                                {icoCheckData.kontakt_email && (<>, {icoCheckData.kontakt_email}</>)}
                                {icoCheckData.kontakt_telefon && (<>, {icoCheckData.kontakt_telefon}</>)}
                                <br/></>
                              )}
                              <div style={{fontSize: '11px', color: '#666', marginTop: '8px'}}>
                                Zdroj: {icoCheckData.source === 'local' ? 'LokÃ¡lnÃ­ databÃ¡ze' : 'ARES registr'}
                              </div>
                            </IcoNotificationMessage>
                            <IcoNotificationActions>
                              <IcoActionButton className="fill-form" onClick={handleIcoFillForm}>
                                Vyplnit formulÃ¡Å™
                              </IcoActionButton>
                              {icoCheckStatus === 'found-ares' && (
                                <IcoActionButton className="primary" onClick={handleIcoUpdate}>
                                  PÅ™idat do osobnÃ­ch kontaktÅ¯
                                </IcoActionButton>
                              )}
                              <IcoActionButton className="secondary" onClick={handleIcoCancel}>
                                ZruÅ¡it
                              </IcoActionButton>
                            </IcoNotificationActions>
                          </>
                        )}

                        {icoCheckStatus === 'not-found' && (
                          <>
                            <IcoNotificationTitle status="not-found">Dodavatel nebyl nalezen</IcoNotificationTitle>
                            <IcoNotificationMessage status="not-found">
                              Dodavatel s tÃ­mto IÄŒO nenÃ­ v lokÃ¡lnÃ­ databÃ¡zi ani v ARES. MÅ¯Å¾ete pokraÄovat s ruÄnÃ­m zadÃ¡nÃ­m.
                            </IcoNotificationMessage>
                            <IcoNotificationActions>
                              <IcoActionButton className="secondary" onClick={handleIcoCancel}>
                                PokraÄovat ruÄnÄ›
                              </IcoActionButton>
                            </IcoNotificationActions>
                          </>
                        )}
                      </IcoNotification>
                    )}
                  </InputWithIcon>
                  {validationErrors.dodavatel_ico && (
                    <ErrorText>{validationErrors.dodavatel_ico}</ErrorText>
                  )}
                </FormGroup>
                <FormGroup>
                  <Label>DIÄŒ</Label>
                  <InputWithIcon hasIcon>
                    <Hash />
                    <Input
                      type="text"
                      name="dodavatel_dic"
                      placeholder="CZ12345678"
                      value={formData.dodavatel_dic || ''}
                      onChange={(e) => handleInputChange('dodavatel_dic', e.target.value)}
                      onBlur={() => handleFieldBlur('dodavatel_dic', formData.dodavatel_dic)}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                    />
                  </InputWithIcon>
                </FormGroup>
              </FormRow>
              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label>ZASTOUPENÃ</Label>
                  <InputWithIcon hasIcon>
                    <User />
                    <Input
                      type="text"
                      name="dodavatel_zastoupeny"
                      placeholder="Zastoupen JiÅ™Ã­m NovÃ¡kem"
                      value={formData.dodavatel_zastoupeny || ''}
                      onChange={(e) => handleInputChange('dodavatel_zastoupeny', e.target.value)}
                      onBlur={() => handleFieldBlur('dodavatel_zastoupeny', formData.dodavatel_zastoupeny)}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                    />
                  </InputWithIcon>
                </FormGroup>
              </FormRow>

              {/* KontaktnÃ­ osoba dodavatele */}
              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  {/* DÄ›lÃ­cÃ­ ÄÃ¡ra */}
                  <div style={{
                    width: '100%',
                    height: '1px',
                    background: 'linear-gradient(to right, #e5e7eb, transparent)',
                    margin: '1.5rem 0 1rem 0'
                  }}></div>
                  <Label style={{
                    fontSize: '1rem',
                    fontWeight: '600',
                    color: '#374151',
                    marginBottom: '1rem',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    marginTop: '0.5rem'
                  }}>
                    <User size={18} />
                    KontaktnÃ­ osoba dodavatele
                  </Label>
                </FormGroup>
              </FormRow>
              <FormRow>
                <FormGroup>
                  <Label>JMÃ‰NO A PÅ˜ÃJMENÃ</Label>
                  <InputWithIcon hasIcon>
                    <User />
                    <Input
                      type="text"
                      name="dodavatel_kontakt_jmeno"
                      placeholder="Jan NovÃ¡k"
                      value={formData.dodavatel_kontakt_jmeno || ''}
                      onChange={(e) => handleInputChange('dodavatel_kontakt_jmeno', e.target.value)}
                      onBlur={() => handleFieldBlur('dodavatel_kontakt_jmeno', formData.dodavatel_kontakt_jmeno)}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                    />
                  </InputWithIcon>
                </FormGroup>
                <FormGroup>
                  <Label>E-MAIL</Label>
                  <InputWithIcon hasIcon>
                    <Mail />
                    <Input
                      type="email"
                      name="dodavatel_kontakt_email"
                      placeholder="jan.novak@dodavatel.cz"
                      value={formData.dodavatel_kontakt_email || ''}
                      onChange={(e) => handleInputChange('dodavatel_kontakt_email', e.target.value)}
                      onBlur={() => handleFieldBlur('dodavatel_kontakt_email', formData.dodavatel_kontakt_email)}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                    />
                  </InputWithIcon>
                </FormGroup>
                <FormGroup>
                  <Label>TELEFON</Label>
                  <InputWithIcon hasIcon>
                    <Phone />
                    <Input
                      type="tel"
                      name="dodavatel_kontakt_telefon"
                      placeholder="+420 123 456 789"
                      value={formData.dodavatel_kontakt_telefon || ''}
                      onChange={(e) => handleInputChange('dodavatel_kontakt_telefon', e.target.value)}
                      onBlur={() => handleFieldBlur('dodavatel_kontakt_telefon', formData.dodavatel_kontakt_telefon)}
                      hasIcon
                      disabled={shouldLockPhase3Sections}
                    />
                  </InputWithIcon>
                </FormGroup>
              </FormRow>
            </SectionContent>
          </FormSection>

          {/* Sekce: Detaily objednÃ¡vky */}
          {(isArchived || currentPhase >= 3) && (() => {
            // ðŸ”§ FAILSAFE: Pokud se sekce zobrazÃ­, ale nejsou Å¾Ã¡dnÃ© poloÅ¾ky, vytvoÅ™it jednu
            if (currentPhase >= 3 && (!formData.polozky_objednavky || formData.polozky_objednavky.length === 0)) {
              // DEBUG: FAILSAFE item creation - logging removed
              setTimeout(() => {
                if (!formData.polozky_objednavky || formData.polozky_objednavky.length === 0) {
                  setFormData(prev => ({
                    ...prev,
                    polozky_objednavky: [{
                      id: `failsafe_item_${Date.now()}`,
                      popis: '',
                      mnozstvi: '1',
                      jednotka: 'ks',
                      cena_bez_dph: '',
                      sazba_dph: '21',
                      cena_s_dph: ''
                    }]
                  }));
                }
              }, 100);
            }
            return true;
          })() && (
          <FormSection data-section="detaily">
            <SectionHeader
              sectionTheme={getSectionTheme('detaily')}
              isActive={isSectionActive('detaily')}
            >
              <SectionTitle sectionTheme={getSectionTheme('detaily')}>
                <SectionIcon sectionTheme={getSectionTheme('detaily')}>
                  <Package />
                </SectionIcon>
                Detaily objednÃ¡vky
                {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                {shouldLockPhase3Sections && !shouldLockAllSections && (
                  <LockWarning title="FÃZE 3 sekce je zamÄena ve FÃZI 4+. OdemÄenÃ­ umoÅ¾nÃ­ editaci FÃZE 3.">
                    ðŸ”’ Sekce zamÄena
                  </LockWarning>
                )}
              </SectionTitle>
              <SectionControls>
                {/* CelkovÃ¡ cena s DPH a porovnÃ¡nÃ­ s maximem */}
                <div style={{
                  fontSize: '0.875rem',
                  fontWeight: '600',
                  color: '#92400e',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  <span>Celkem s DPH: {totalPrice.toLocaleString('cs-CZ')} KÄ</span>
                  {maxPrice > 0 && (
                    <span style={{
                      color: totalPrice > maxPrice ? '#dc2626' : '#059669',
                      fontSize: '0.75rem',
                      padding: '2px 6px',
                      borderRadius: '4px',
                      backgroundColor: totalPrice > maxPrice ? '#fef2f2' : '#f0fdf4',
                      border: `1px solid ${totalPrice > maxPrice ? '#fecaca' : '#bbf7d0'}`
                    }}>
                      {totalPrice > maxPrice
                        ? `+${(totalPrice - maxPrice).toLocaleString('cs-CZ')} KÄ nad limit`
                        : `${(maxPrice - totalPrice).toLocaleString('cs-CZ')} KÄ do limitu`
                      }
                    </span>
                  )}
                </div>
                <CollapseIcon
                  collapsed={sectionStates.detaily}
                  sectionTheme={getSectionTheme('detaily')}
                  onClick={() => toggleSection('detaily')}
                  style={{ cursor: 'pointer' }}
                >
                  <FontAwesomeIcon icon={faChevronUp} />
                </CollapseIcon>
              </SectionControls>
            </SectionHeader>
            <SectionContent collapsed={sectionStates.detaily}>
              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label required>DRUH OBJ.</Label>
                  <StableCustomSelect
                    value={formData.druh_objednavky_kod}
                    onChange={(selectedValue) => handleInputChange('druh_objednavky_kod', selectedValue)}
                    onBlur={(field, value) => handleFieldBlur('druh_objednavky_kod', value)}
                    options={druhyObjednavkyOptions}
                    placeholder="Vyberte druh objednÃ¡vky..."
                    field="druh_objednavky_kod"
                    icon={<Package />}
                    isClearable={true}
                    disabled={shouldLockPhase3Sections}
                    hasError={!!validationErrors.druh_objednavky_kod}
                    required={true}
                    loading={false}
                    getOptionLabel={getOptionLabel}
                    getOptionValue={(option, field) => option.kod_stavu || option.value || option.kod || option.id || option}
                  />
                  {validationErrors.druh_objednavky_kod && (
                    <ErrorText>{validationErrors.druh_objednavky_kod}</ErrorText>
                  )}
                </FormGroup>
              </FormRow>

              {/* PoloÅ¾ky objednÃ¡vky */}
              <div style={{marginTop: '1.5rem'}}>
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '1rem'
                }}>
                  <h4 style={{margin: 0, fontSize: '1rem', fontWeight: '600', color: '#374151'}}>
                    PoloÅ¾ky objednÃ¡vky <span style={{color: '#ef4444'}}>*</span>
                  </h4>
                </div>

                {validationErrors.polozky_objednavky && (
                  <ErrorText style={{marginBottom: '1rem'}}>{validationErrors.polozky_objednavky}</ErrorText>
                )}

                {(formData.polozky_objednavky || []).map((polozka, index) => (
                  <div key={polozka.id} style={{
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    padding: '1rem',
                    marginBottom: '1rem',
                    background: '#fafafa'
                  }}>
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      marginBottom: '1rem'
                    }}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '1rem', flex: 1}}>
                        <span style={{fontWeight: '600', color: '#374151', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                          <ShoppingCart size={18} style={{ color: '#10b981' }} />
                          POLOÅ½KA {index + 1} {index === 0 && <span style={{color: '#ef4444'}}>*</span>}
                        </span>
                        
                        {/* ðŸŽ¯ LP Select - POUZE ve fÃ¡zi 3+ s LP financovÃ¡nÃ­m */}
                        {currentPhase >= 3 && (() => {
                          // Zkontrolovat LP financovÃ¡nÃ­
                          const selectedSource = financovaniOptions.find(opt => opt.kod_stavu === formData.zpusob_financovani || opt.kod === formData.zpusob_financovani);
                          const nazev = selectedSource?.nazev_stavu || selectedSource?.nazev || '';
                          const hasLPFinancing = (nazev.includes('Limitovan') || nazev.includes('pÅ™Ã­slib')) && Array.isArray(formData.lp_kod) && formData.lp_kod.length > 0;
                          
                          if (!hasLPFinancing) return null;
                          
                          return (
                            <div style={{flex: 1, marginRight: '0.5rem', display: 'flex', flexDirection: 'column', gap: '0.25rem'}} data-custom-select>
                              <StableCustomSelect
                                value={polozka.lp_id || ''}
                                onChange={(selectedValue) => updatePolozka(polozka.id, 'lp_id', selectedValue)}
                                options={lpOptionsForItems}
                                placeholder={
                                  !formData.id 
                                    ? 'UloÅ¾te objednÃ¡vku...' 
                                    : lpOptionsForItems.length === 0 
                                      ? 'Å½Ã¡dnÃ© LP dostupnÃ©' 
                                      : '-- Vybrat LP --'
                                }
                                field={`polozka_${polozka.id}_lp`}
                                disabled={shouldLockPhase3Sections || !formData.id}
                                hasError={!!validationErrors[`polozka_${index}_lp`]}
                                required={true}
                                hasTriedToSubmit={hasTriedToSubmit}
                                icon={<Hash />}
                                isClearable={true}
                                getOptionLabel={getOptionLabel}
                                getOptionValue={(option) => option.id}
                              />
                              {validationErrors[`polozka_${index}_lp`] && (
                                <ErrorText style={{fontSize: '0.7rem', marginTop: '0.1rem'}}>
                                  {validationErrors[`polozka_${index}_lp`]}
                                </ErrorText>
                              )}
                            </div>
                          );
                        })()}
                      </div>
                      <div style={{display: 'flex', gap: '0.5rem'}}>
                        {/* TlaÄÃ­tko pÅ™idat dalÅ¡Ã­ poloÅ¾ku */}
                        <button
                          type="button"
                          onClick={shouldLockPhase3Sections ? undefined : addPolozka}
                          title={shouldLockPhase3Sections ? "ZamÄeno - sekce FÃZE 3" : "PÅ™idat dalÅ¡Ã­ poloÅ¾ku"}
                          disabled={shouldLockPhase3Sections}
                          style={{
                            background: shouldLockPhase3Sections ? '#9ca3af' : '#10b981',
                            color: 'white',
                            border: 'none',
                            borderRadius: '6px',
                            padding: '0.4rem',
                            fontSize: '0.875rem',
                            fontWeight: '500',
                            cursor: shouldLockPhase3Sections ? 'not-allowed' : 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            width: '32px',
                            height: '32px'
                          }}
                        >
                          <Plus size={16} />
                        </button>

                        {/* TlaÄÃ­tko smazat poloÅ¾ku */}
                        {(formData.polozky_objednavky || []).length > 1 && (
                          <DeleteItemButton
                            type="button"
                            onClick={shouldLockPhase3Sections ? undefined : () => removePolozka(polozka.id)}
                            disabled={shouldLockPhase3Sections}
                            title={shouldLockPhase3Sections ? "ZamÄeno - sekce FÃZE 3" : "Smazat poloÅ¾ku"}
                            style={{ opacity: shouldLockPhase3Sections ? 0.5 : 1, cursor: shouldLockPhase3Sections ? 'not-allowed' : 'pointer' }}
                          >
                            <Trash size={16} />
                          </DeleteItemButton>
                        )}
                      </div>
                    </div>

                    <FormRow style={{marginBottom: '1rem'}}>
                      <FormGroup style={{gridColumn: '1 / -1'}}>
                        <Label required>NÃ¡zev / popis</Label>
                        <InputWithIcon hasIcon>
                          <FileText />
                          <Input
                            type="text"
                            placeholder="NÃ¡zev / popis poloÅ¾ky"
                            value={polozka.popis}
                            onChange={(e) => updatePolozka(polozka.id, 'popis', e.target.value)}
                            onBlur={() => handleFieldBlur(`polozka_${index}_popis`, polozka.popis)}
                            hasError={!!validationErrors[`polozka_${index}_popis`]}
                            hasIcon={true}
                            disabled={shouldLockPhase3Sections}
                          />
                        </InputWithIcon>
                        {validationErrors[`polozka_${index}_popis`] && (
                          <ErrorText>{validationErrors[`polozka_${index}_popis`]}</ErrorText>
                        )}
                      </FormGroup>
                    </FormRow>

                    <FormRow style={{gridTemplateColumns: '1fr auto 1fr', gap: '1rem', alignItems: 'end'}}>
                      <FormGroup>
                        <Label required>CENA BEZ DPH</Label>
                        <CurrencyInput
                          fieldName={`polozka_${index}_cena_bez_dph`}
                          value={polozka.cena_bez_dph || ''}
                          onChange={(field, value) => updatePolozka(polozka.id, 'cena_bez_dph', value)}
                          onBlur={(field, value) => handleFieldBlur(`polozka_${index}_cena_bez_dph`, value)}
                          disabled={shouldLockPhase3Sections}
                          placeholder="0.00"
                          hasError={!!validationErrors[`polozka_${index}_cena_bez_dph`]}
                        />
                        {validationErrors[`polozka_${index}_cena_bez_dph`] && (
                          <ErrorText>{validationErrors[`polozka_${index}_cena_bez_dph`]}</ErrorText>
                        )}
                      </FormGroup>

                      <FormGroup>
                        <Label>DPH</Label>
                        <select
                          value={polozka.sazba_dph}
                          onChange={(e) => updatePolozka(polozka.id, 'sazba_dph', e.target.value)}
                          onBlur={() => handleFieldBlur(`polozka_${index}_sazba_dph`, polozka.sazba_dph)}
                          disabled={shouldLockPhase3Sections}
                          style={{
                            padding: '0.75rem',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '0.875rem',
                            backgroundColor: 'white',
                            width: '80px'
                          }}
                        >
                          <option value="12">12%</option>
                          <option value="21">21%</option>
                        </select>
                      </FormGroup>

                      <FormGroup>
                        <Label required>CENA S DPH</Label>
                        <CurrencyInput
                          fieldName={`polozka_${index}_cena_s_dph`}
                          value={polozka.cena_s_dph || ''}
                          onChange={(field, value) => updatePolozka(polozka.id, 'cena_s_dph', value)}
                          onBlur={(field, value) => handleFieldBlur(`polozka_${index}_cena_s_dph`, value)}
                          disabled={shouldLockPhase3Sections}
                          placeholder="0.00"
                          hasError={!!validationErrors[`polozka_${index}_cena_s_dph`]}
                        />
                        {validationErrors[`polozka_${index}_cena_s_dph`] && (
                          <ErrorText>{validationErrors[`polozka_${index}_cena_s_dph`]}</ErrorText>
                        )}
                      </FormGroup>
                    </FormRow>

                    {/* ðŸ¢ Lokalizace poloÅ¾ky - rozklÃ¡dacÃ­ panel */}
                    <div style={{ marginTop: '1rem' }}>
                      {(() => {
                        // Zkontrolovat, zda KÃ“D druhu objednÃ¡vky obsahuje MAJETEK
                        const isMaterialOrder = formData.druh_objednavky_kod && 
                          formData.druh_objednavky_kod.toUpperCase().includes('MAJETEK');
                        
                        return (
                          <button
                            type="button"
                            onClick={() => {
                              // Pro materiÃ¡lovÃ© objednÃ¡vky nelze panel zavÅ™Ã­t
                              if (!isMaterialOrder) {
                                setLokalizacePanelStates(prev => ({
                                  ...prev,
                                  [polozka.id]: !prev[polozka.id]
                                }));
                              }
                            }}
                            disabled={shouldLockPhase3Sections || isMaterialOrder}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem',
                              padding: '0.5rem 0',
                              background: 'transparent',
                              border: 'none',
                              color: isMaterialOrder ? '#ef4444' : '#6b7280',
                              fontSize: '0.875rem',
                              fontWeight: isMaterialOrder ? '600' : '500',
                              cursor: (shouldLockPhase3Sections || isMaterialOrder) ? 'not-allowed' : 'pointer',
                              opacity: shouldLockPhase3Sections ? 0.5 : 1,
                              transition: 'color 0.2s'
                            }}
                            onMouseOver={(e) => !shouldLockPhase3Sections && !isMaterialOrder && (e.currentTarget.style.color = '#374151')}
                            onMouseOut={(e) => !shouldLockPhase3Sections && !isMaterialOrder && (e.currentTarget.style.color = '#6b7280')}
                          >
                            {!isMaterialOrder && (
                              <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                strokeWidth="2"
                                style={{
                                  transform: lokalizacePanelStates[polozka.id] ? 'rotate(180deg)' : 'rotate(0deg)',
                                  transition: 'transform 0.2s'
                                }}
                              >
                                <polyline points="6 9 12 15 18 9"></polyline>
                              </svg>
                            )}
                            UpÅ™esnÄ›nÃ­ mÃ­sta dodÃ¡nÃ­ {isMaterialOrder ? (<span style={{color: '#ef4444'}}>*</span>) : '(volitelnÃ©)'}
                          </button>
                        );
                      })()}

                      {lokalizacePanelStates[polozka.id] && (() => {
                        // Zkontrolovat, zda KÃ“D druhu objednÃ¡vky obsahuje MAJETEK
                        const isMaterialOrder = formData.druh_objednavky_kod && 
                          formData.druh_objednavky_kod.toUpperCase().includes('MAJETEK');
                        
                        return (
                          <div style={{
                            marginTop: '0.75rem',
                            padding: '1rem',
                            background: isMaterialOrder ? '#fef2f2' : '#f9fafb',
                            borderRadius: '6px',
                            border: isMaterialOrder ? '1px solid #fca5a5' : '1px dashed #d1d5db'
                          }}>
                            <FormRow style={{gridTemplateColumns: '1fr 1fr 1fr'}}>
                              <FormGroup>
                                <Label>ÃšSEK {isMaterialOrder && <span style={{color: '#ef4444'}}>*</span>}</Label>
                                <InputWithIcon hasIcon>
                                  <MapPin size={16} />
                                  <Input
                                    type="text"
                                    name={`polozka_${index}_usek_kod`}
                                    placeholder="Ãšsek..."
                                    value={polozka.usek_kod || ''}
                                    onChange={(e) => updatePolozka(polozka.id, 'usek_kod', e.target.value)}
                                    onBlur={() => handleFieldBlur(`polozka_${index}_usek_kod`, polozka.usek_kod)}
                                    disabled={shouldLockPhase3Sections}
                                    hasError={!!validationErrors[`polozka_${index}_usek_kod`]}
                                    style={{ paddingLeft: '2.5rem' }}
                                  />
                                </InputWithIcon>
                                {validationErrors[`polozka_${index}_usek_kod`] && (
                                  <ErrorText>{validationErrors[`polozka_${index}_usek_kod`]}</ErrorText>
                                )}
                              </FormGroup>

                              <FormGroup>
                                <Label>BUDOVA {isMaterialOrder && <span style={{color: '#ef4444'}}>*</span>}</Label>
                                <InputWithIcon hasIcon>
                                  <MapPin size={16} />
                                  <Input
                                    type="text"
                                    name={`polozka_${index}_budova_kod`}
                                    placeholder="Budova..."
                                    value={polozka.budova_kod || ''}
                                    onChange={(e) => updatePolozka(polozka.id, 'budova_kod', e.target.value)}
                                    onBlur={() => handleFieldBlur(`polozka_${index}_budova_kod`, polozka.budova_kod)}
                                    disabled={shouldLockPhase3Sections}
                                    hasError={!!validationErrors[`polozka_${index}_budova_kod`]}
                                    style={{ paddingLeft: '2.5rem' }}
                                  />
                                </InputWithIcon>
                                {validationErrors[`polozka_${index}_budova_kod`] && (
                                  <ErrorText>{validationErrors[`polozka_${index}_budova_kod`]}</ErrorText>
                                )}
                              </FormGroup>

                              <FormGroup>
                                <Label>MÃSTNOST {isMaterialOrder && <span style={{color: '#ef4444'}}>*</span>}</Label>
                                <InputWithIcon hasIcon>
                                  <MapPin size={16} />
                                  <Input
                                    type="text"
                                    name={`polozka_${index}_mistnost_kod`}
                                    placeholder="MÃ­stnost..."
                                    value={polozka.mistnost_kod || ''}
                                    onChange={(e) => updatePolozka(polozka.id, 'mistnost_kod', e.target.value)}
                                    onBlur={() => handleFieldBlur(`polozka_${index}_mistnost_kod`, polozka.mistnost_kod)}
                                    disabled={shouldLockPhase3Sections}
                                    hasError={!!validationErrors[`polozka_${index}_mistnost_kod`]}
                                    style={{ paddingLeft: '2.5rem' }}
                                  />
                                </InputWithIcon>
                                {validationErrors[`polozka_${index}_mistnost_kod`] && (
                                  <ErrorText>{validationErrors[`polozka_${index}_mistnost_kod`]}</ErrorText>
                                )}
                              </FormGroup>
                            </FormRow>

                            <FormRow style={{gridTemplateColumns: '1fr'}}>
                              <FormGroup>
                                <Label>POZNÃMKA K MÃSTU</Label>
                                <TextArea
                                  name={`polozka_${index}_poznamka_lokalizace`}
                                  placeholder="DoplÅˆujÃ­cÃ­ informace k mÃ­stu dodÃ¡nÃ­..."
                                  value={polozka.poznamka || ''}
                                  onChange={(e) => updatePolozka(polozka.id, 'poznamka', e.target.value)}
                                  onBlur={() => handleFieldBlur(`polozka_${index}_poznamka_lokalizace`, polozka.poznamka)}
                                  disabled={shouldLockPhase3Sections}
                                  rows={2}
                                />
                              </FormGroup>
                            </FormRow>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                ))}
              </div>

              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label>POZNÃMKA:</Label>
                  <TextArea
                    name="poznamka_objednavky"
                    placeholder="DodateÄnÃ© poznÃ¡mky a poÅ¾adavky..."
                    value={formData.poznamka_objednavky || ''}
                    onChange={(e) => handleInputChange('poznamka_objednavky', e.target.value)}
                    onBlur={(e) => handleFieldBlur('poznamka_objednavky', e.target.value)}
                    disabled={shouldLockPhase3Sections}
                    rows={3}
                  />
                </FormGroup>
              </FormRow>
            </SectionContent>
          </FormSection>
          )}

          {/* Sekce: DodacÃ­ a zÃ¡ruÄnÃ­ podmÃ­nky */}
          <FormSection data-section="dodaci_podminky">
            <SectionHeader
              sectionTheme={getSectionTheme('dodaci_podminky')}
              isActive={isSectionActive('dodaci_podminky')}
            >
              <SectionTitle sectionTheme={getSectionTheme('dodaci_podminky')}>
                <SectionIcon sectionTheme={getSectionTheme('dodaci_podminky')}>
                  <Calendar />
                </SectionIcon>
                DodacÃ­ a zÃ¡ruÄnÃ­ podmÃ­nky
                {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                {shouldLockPhase3Sections && !shouldLockAllSections && (
                  <LockWarning title="FÃZE 3 sekce je zamÄena ve FÃZI 4+. OdemÄenÃ­ umoÅ¾nÃ­ editaci FÃZE 3.">
                    ðŸ”’ Sekce zamÄena
                  </LockWarning>
                )}
              </SectionTitle>
              <SectionControls>
                <CollapseIcon
                  collapsed={sectionStates.dodaci_podminky}
                  sectionTheme={getSectionTheme('dodaci_podminky')}
                  onClick={() => toggleSection('dodaci_podminky')}
                  style={{ cursor: 'pointer' }}
                >
                  <FontAwesomeIcon icon={faChevronUp} />
                </CollapseIcon>
              </SectionControls>
            </SectionHeader>
            <SectionContent collapsed={sectionStates.dodaci_podminky}>
              <FormRow style={{gridTemplateColumns: '2fr 3fr'}}>
                <FormGroup>
                  <Label>PÅ˜EDPOKLÃDANÃ TERMÃN DODÃNÃ</Label>
                  <DatePicker
                    fieldName="dt_predpokladany_termin_dodani"
                    value={formData.dt_predpokladany_termin_dodani}
                    onChange={(value) => handleInputChange('dt_predpokladany_termin_dodani', value)}
                    onBlur={(value) => handleFieldBlur('dt_predpokladany_termin_dodani', value)}
                    disabled={shouldLockPhase3Sections}
                    hasError={!!validationErrors.dt_predpokladany_termin_dodani}
                    placeholder="Vyberte datum"
                  />
                </FormGroup>
                <FormGroup>
                  <Label>MÃSTO DODÃNÃ</Label>
                  <InputWithIcon hasIcon>
                    <MapPin />
                    <Input
                      type="text"
                      name="misto_dodani"
                      placeholder="Adresa mÃ­sta dodÃ¡nÃ­"
                      value={formData.misto_dodani || ''}
                      onChange={(e) => handleInputChange('misto_dodani', e.target.value)}
                      onBlur={(e) => handleFieldBlur('misto_dodani', e.target.value)}
                      disabled={shouldLockPhase3Sections}
                      hasIcon
                    />
                  </InputWithIcon>
                </FormGroup>
              </FormRow>
              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label>ZÃRUKA</Label>
                  <InputWithIcon hasIcon>
                    <FileText />
                    <Input
                      type="text"
                      name="zaruka"
                      placeholder="ZÃ¡ruÄnÃ­ podmÃ­nky a lhÅ¯ty"
                      value={formData.zaruka || ''}
                      onChange={(e) => handleInputChange('zaruka', e.target.value)}
                      onBlur={(e) => handleFieldBlur('zaruka', e.target.value)}
                      disabled={shouldLockPhase3Sections}
                      hasIcon
                    />
                  </InputWithIcon>
                </FormGroup>
              </FormRow>
            </SectionContent>
          </FormSection>

          {/* âŒ SEKCE PÅ˜ÃLOHY ODEBRÃNA - bude pÅ™idÃ¡na na konec formulÃ¡Å™e jako vÅ¾dy aktivnÃ­ */}

          {/* FÃZE 3: Sekce: Stav odeslÃ¡nÃ­ objednÃ¡vky */}
          <FormSection data-section="stav_odeslani">
            <SectionHeader
              sectionTheme={getSectionTheme('stav_odeslani')}
              isActive={isSectionActive('stav_odeslani')}
            >
              <SectionTitle sectionTheme={getSectionTheme('stav_odeslani')}>
                <SectionIcon sectionTheme={getSectionTheme('stav_odeslani')}>
                  <Package />
                </SectionIcon>
                Stav odeslÃ¡nÃ­ objednÃ¡vky
                {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                {shouldLockPhase3Sections && !shouldLockAllSections && (
                  <LockWarning title="FÃZE 3 sekce je zamÄena ve FÃZI 4+. OdemÄenÃ­ umoÅ¾nÃ­ editaci FÃZE 3.">
                    ðŸ”’ Sekce zamÄena
                  </LockWarning>
                )}
              </SectionTitle>
              <SectionControls>
                {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                {shouldLockPhase3Sections && !shouldLockAllSections && canEditPhase3 && (
                  <UnlockButton
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowUnlockPhase3Confirm(true);
                    }}
                    title="Odemknout FÃZE 3 sekce"
                  >
                    <Unlock />
                  </UnlockButton>
                )}
                <CollapseIcon
                  collapsed={sectionStates.stav_odeslani}
                  sectionTheme={getSectionTheme('stav_odeslani')}
                  onClick={() => toggleSection('stav_odeslani')}
                  style={{ cursor: 'pointer' }}
                >
                  <FontAwesomeIcon icon={faChevronUp} />
                </CollapseIcon>
              </SectionControls>
            </SectionHeader>
              <SectionContent collapsed={sectionStates.stav_odeslani}>
              <FormRow>
                <FormGroup style={{gridColumn: '1 / -1'}}>
                  <Label style={{ marginBottom: '1rem', fontSize: '1rem', fontWeight: '600' }}>
                    KONEÄŒNÃ STAV OBJEDNÃVKY
                  </Label>

                  {/* OdeslÃ¡no */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '1rem',
                    padding: '1rem',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    backgroundColor: formData.stav_odeslano ? '#f0fdf4' : '#f9fafb',
                    marginBottom: '1rem',
                    opacity: (shouldLockPhase3Sections || showSaveProgress || isSaving) ? 0.6 : 1
                  }}>
                    <label style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.75rem',
                      fontSize: '1rem',
                      fontWeight: '500',
                      cursor: (shouldLockPhase3Sections || showSaveProgress || isSaving) ? 'not-allowed' : 'pointer',
                      color: formData.stav_odeslano ? '#15803d' : '#374151'
                    }}>
                      <input
                        type="checkbox"
                        name="stav_odeslano"
                        checked={formData.stav_odeslano || false}
                        disabled={shouldLockPhase3Sections || showSaveProgress || isSaving}
                        onChange={(e) => {
                          const isChecked = e.target.checked;

                          // PÅ™i zaÅ¡krtnutÃ­ "OdeslÃ¡no" odÅ¡krtnout "StornovÃ¡no" a smazat storno data
                          if (isChecked) {
                            handleInputChange('stav_stornovano', false);
                            handleInputChange('datum_storna', '');
                            handleInputChange('odeslani_storno_duvod', ''); // Smazat dÅ¯vod storna pÅ™i odeslÃ¡nÃ­
                            handleInputChange('storno_uzivatel_id', '');
                            handleInputChange('storno_provedl', '');
                          }

                          // HlavnÃ­ zmÄ›na stavu - handleInputChange uÅ¾ obsahuje logiku pro nastavenÃ­ datumu
                          handleInputChange('stav_odeslano', isChecked);
                        }}
                        style={{
                          width: '20px',
                          height: '20px',
                          accentColor: '#16a34a'
                        }}
                      />
                      <Package size={20} />
                      OdeslÃ¡no
                      {formData.stav_odeslano && (
                        <span style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          color: '#15803d',
                          fontWeight: '600'
                        }}>
                          âœ“
                        </span>
                      )}
                    </label>

                    {/* Datum odeslÃ¡nÃ­ vedle checkboxu */}
                    {(formData.stav_odeslano || formData.dt_odeslani) && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        marginLeft: 'auto'
                      }}>
                        <Label style={{ margin: 0, fontSize: '0.875rem' }}>DATUM:</Label>
                        <div style={{ width: '280px' }}>
                          <DatePicker
                            fieldName="datum_odeslani"
                            value={formData.datum_odeslani}
                            onChange={(value) => handleInputChange('datum_odeslani', value)}
                            onBlur={(value) => handleFieldBlur('datum_odeslani', value)}
                            disabled={shouldLockPhase3Sections}
                            hasError={!!validationErrors.datum_odeslani}
                            placeholder="Datum"
                          />
                        </div>
                      </div>
                    )}
                  </div>

                  {/* StornovÃ¡no */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '1rem',
                    padding: '1rem',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    backgroundColor: formData.stav_stornovano ? '#fef2f2' : '#f9fafb',
                    opacity: (shouldLockPhase3Sections || showSaveProgress || isSaving) ? 0.6 : 1
                  }}>
                    <label style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.75rem',
                      fontSize: '1rem',
                      fontWeight: '500',
                      cursor: (shouldLockPhase3Sections || showSaveProgress || isSaving) ? 'not-allowed' : 'pointer',
                      color: formData.stav_stornovano ? '#dc2626' : '#374151'
                    }}>
                      <input
                        type="checkbox"
                        name="stav_stornovano"
                        checked={formData.stav_stornovano || false}
                        disabled={shouldLockPhase3Sections || showSaveProgress || isSaving}
                        onChange={(e) => {
                          const isChecked = e.target.checked;

                          // PÅ™i zaÅ¡krtnutÃ­ "StornovÃ¡no" odÅ¡krtnout "OdeslÃ¡no"
                          if (isChecked) {
                            handleInputChange('stav_odeslano', false);
                            handleInputChange('datum_odeslani', '');
                          }

                          // âœ… HLAVNÃ ZMÄšNA - handleInputChange automaticky nastavÃ­ datum v logice
                          handleInputChange('stav_stornovano', isChecked);
                        }}
                        style={{
                          width: '20px',
                          height: '20px',
                          accentColor: '#dc2626'
                        }}
                      />
                      <FontAwesomeIcon icon={faTimes} size="lg" />
                      StornovÃ¡no
                      {formData.stav_stornovano && (
                        <span style={{
                          marginLeft: '0.5rem',
                          fontSize: '0.875rem',
                          color: '#dc2626',
                          fontWeight: '600'
                        }}>
                          âœ—
                        </span>
                      )}
                    </label>

                    {/* Datum storna vedle checkboxu */}
                    {(formData.stav_stornovano || formData.datum_storna) && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        marginLeft: 'auto'
                      }}>
                        <Label style={{ margin: 0, fontSize: '0.875rem' }}>DATUM:</Label>
                        <div style={{ width: '280px' }}>
                          <DatePicker
                            fieldName="datum_storna"
                            value={formData.datum_storna}
                            onChange={(value) => handleInputChange('datum_storna', value)}
                            onBlur={(value) => handleFieldBlur('datum_storna', value)}
                            disabled={shouldLockPhase3Sections}
                            hasError={!!validationErrors.datum_storna}
                            placeholder="Vyberte datum..."
                          />
                        </div>
                      </div>
                    )}
                  </div>

                  {/* DÅ¯vod stornovÃ¡nÃ­ - zobrazÃ­ se pouze kdyÅ¾ je stornovÃ¡no zaÅ¡krtnuto */}
                  {formData.stav_stornovano && (
                    <div style={{ marginTop: '1rem' }}>
                      <Label style={{ marginBottom: '0.5rem' }}>
                        DÅ®VOD STORNOVÃNÃ
                        <span style={{ color: '#dc2626', marginLeft: '0.25rem' }}>*</span>
                      </Label>
                      <TextArea
                        name="odeslani_storno_duvod"
                        placeholder="UveÄte dÅ¯vod stornovÃ¡nÃ­ objednÃ¡vky..."
                        value={formData.odeslani_storno_duvod || ''}
                        onChange={(e) => handleInputChange('odeslani_storno_duvod', e.target.value)}
                        onBlur={(e) => handleFieldBlur('odeslani_storno_duvod', e.target.value)}
                        rows={3}
                        style={{
                          border: '1px solid #fca5a5',
                          backgroundColor: '#fef2f2'
                        }}
                      />
                      {validationErrors.odeslani_storno_duvod && (
                        <ErrorText style={{ marginTop: '0.5rem' }}>{validationErrors.odeslani_storno_duvod}</ErrorText>
                      )}
                    </div>
                  )}

                  {validationErrors.datum_odeslani && (
                    <ErrorText style={{ marginTop: '0.5rem' }}>{validationErrors.datum_odeslani}</ErrorText>
                  )}
                  {validationErrors.datum_storna && (
                    <ErrorText style={{ marginTop: '0.5rem' }}>{validationErrors.datum_storna}</ErrorText>
                  )}

                  {/* Informace o stavu */}
                  {formData.stav_odeslano ? (
                    <div style={{
                      marginTop: '1rem',
                      padding: '0.75rem 1rem',
                      backgroundColor: '#dcfce7',
                      border: '1px solid #16a34a',
                      borderRadius: '6px',
                      color: '#166534',
                      fontSize: '0.875rem'
                    }}>
                      <div style={{ fontWeight: '600' }}>
                        {formData.dt_odeslani && formData.odesilatel_id && hasWorkflowState(formData.stav_workflow_kod, 'ODESLANA') ? (
                          // Data existujÃ­ + stav ODESLANA = byla jiÅ¾ odeslÃ¡na
                          <>
                            âœ… ObjednÃ¡vka byla odeslÃ¡na
                            <div style={{ marginTop: '0.25rem', fontSize: '0.875rem', fontWeight: 'normal' }}>
                              <strong>Datum odeslÃ¡nÃ­:</strong> {(() => {
                                // FormÃ¡tovÃ¡nÃ­ jen data bez Äasu (dt_odeslani z DB mÅ¯Å¾e obsahovat datetime)
                                const dateStr = formData.dt_odeslani.split(' ')[0]; // Odstranit Äas
                                const [year, month, day] = dateStr.split('-');
                                return `${day}. ${month}. ${year}`;
                              })()} â€¢ <strong>Odeslal:</strong> {getUserNameById(formData.odesilatel_id)}
                            </div>
                          </>
                        ) : formData.datum_odeslani ? (
                          // MÃ¡ datum ale jeÅ¡tÄ› nebyla odeslÃ¡na - bude odeslÃ¡na
                          `âœ… ObjednÃ¡vka bude oznaÄena jako odeslanÃ¡ dne ${formatDateOnly(new Date(formData.datum_odeslani))}`
                        ) : (
                          // NemÃ¡ datum - bude odeslÃ¡na po uloÅ¾enÃ­
                          `âœ… ObjednÃ¡vka bude oznaÄena jako odeslanÃ¡ po uloÅ¾enÃ­`
                        )}
                      </div>
                    </div>
                  ) : formData.stav_stornovano ? (
                    <div style={{
                      marginTop: '1rem',
                      padding: '0.75rem 1rem',
                      backgroundColor: '#fef2f2',
                      border: '1px solid #f87171',
                      borderRadius: '6px',
                      color: '#991b1b',
                      fontSize: '0.875rem'
                    }}>
                      <div style={{ fontWeight: '600' }}>
                        {formData.dt_odeslani && formData.odesilatel_id && hasWorkflowState(formData.stav_workflow_kod, 'STORNOVANA') ? (
                          // Data existujÃ­ + stav STORNOVANA = byla jiÅ¾ stornovÃ¡na
                          <>
                            âŒ ObjednÃ¡vka byla stornovÃ¡na
                            <div style={{ marginTop: '0.5rem', fontSize: '0.875rem', fontWeight: 'normal' }}>
                              <strong>Datum stornovÃ¡nÃ­:</strong> {formData.dt_odeslani}
                              {' â€¢ '}
                              <strong>Stornoval:</strong> {getUserNameById(formData.odesilatel_id)}
                            </div>
                            {formData.odeslani_storno_duvod && (
                              <div style={{ marginTop: '0.5rem', fontSize: '0.875rem', fontWeight: 'normal' }}>
                                <strong>DÅ¯vod stornovÃ¡nÃ­:</strong> {formData.odeslani_storno_duvod}
                              </div>
                            )}
                          </>
                        ) : (
                          // Byla stornovÃ¡na po uloÅ¾enÃ­
                          <>
                            âŒ ObjednÃ¡vka byla stornovÃ¡na {formData.datum_storna ? `dne ${formatDateOnly(new Date(formData.datum_storna))}` : 'po uloÅ¾enÃ­'}
                            {formData.odeslani_storno_duvod && (
                              <div style={{ marginTop: '0.5rem', fontSize: '0.875rem', fontWeight: 'normal' }}>
                                <strong>DÅ¯vod stornovÃ¡nÃ­:</strong> {formData.odeslani_storno_duvod}
                              </div>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                  ) : null}
                </FormGroup>
              </FormRow>
            </SectionContent>
          </FormSection>

          {/* INFORMAÄŒNÃ BLOK - KONEC FÃZE 2 */}
          {(isArchived || currentPhase >= 2) && hasWorkflowState(formData.stav_workflow_kod, 'SCHVALENA') && !formData.stav_odeslano && !formData.stav_stornovano && (
            <div style={{
              margin: '2rem 0',
              padding: '1rem 1.25rem',
              backgroundColor: '#fef3c7',
              border: '1px solid #f59e0b',
              borderRadius: '8px',
              color: '#92400e'
            }}>
              <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                ðŸ“‹ ObjednÃ¡vka zatÃ­m nebyla dokonÄena
              </div>
              <div style={{ fontSize: '0.875rem' }}>
                ZaÅ¡krtnÄ›te "OdeslÃ¡no" kdyÅ¾ bude objednÃ¡vka skuteÄnÄ› odeslÃ¡na dodavateli, nebo "StornovÃ¡no" pokud se objednÃ¡vka nebude realizovat.
              </div>
            </div>
          )}

          {/* FÃZE 3: DalÅ¡Ã­ sekce zobrazenÃ© ve FÃZI 3 (pouze pokud nenÃ­ stornovÃ¡no) */}
          {(isArchived || currentPhase >= 3) && !formData.stav_stornovano && (
            <>
              {/* FÃZE 4+: Sekce potvrzenÃ­ dodavatelem - zobrazÃ­ se aÅ¾ po ODESLÃNÃ dodavateli */}

              {/* Sekce: PotvrzenÃ­ objednÃ¡vky dodavatelem */}
              {/* âœ… ZOBRAZIT vÅ¾dy kdyÅ¾ workflow proÅ¡lo pÅ™es ODESLANA nebo POTVRZENA - jako HISTORIE */}
              {(() => {
                const phaseCheck = currentPhase >= 4;
                const workflowCheck = hasWorkflowState(formData.stav_workflow_kod, 'ODESLANA') ||
                                       hasWorkflowState(formData.stav_workflow_kod, 'POTVRZENA');
                const shouldShow = phaseCheck && workflowCheck;

                return shouldShow;
              })() && (
              <FormSection data-section="potvrzeni_objednavky">
                <SectionHeader
                  sectionTheme={getSectionTheme('potvrzeni_objednavky')}
                  isActive={isSectionActive('potvrzeni_objednavky')}
                >
                  <SectionTitle sectionTheme={getSectionTheme('potvrzeni_objednavky')}>
                    <SectionIcon sectionTheme={getSectionTheme('potvrzeni_objednavky')}>
                      <FontAwesomeIcon icon={faCheckCircle} />
                    </SectionIcon>
                    PotvrzenÃ­ objednÃ¡vky dodavatelem
                    {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                    {isPotvrzeniLocked && !shouldLockAllSections && (
                      <LockWarning title="Sekce z minulÃ© fÃ¡ze je uzamÄena (read-only historie). Odemknout mÅ¯Å¾e administrÃ¡tor nebo uÅ¾ivatel s prÃ¡vem ORDER_MANAGE.">
                        ðŸ”’ Sekce zamÄena
                      </LockWarning>
                    )}
                  </SectionTitle>
                  <SectionControls>
                    {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                    {isPotvrzeniLocked && !shouldLockAllSections && canUnlockAnything && (
                      <UnlockButton
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowUnlockPotvrzeniConfirm(true);
                        }}
                        title="Odemknout sekci PotvrzenÃ­ od dodavatele"
                      >
                        <Unlock />
                      </UnlockButton>
                    )}

                    <CollapseIcon
                      collapsed={sectionStates.potvrzeni_objednavky}
                      sectionTheme={getSectionTheme('potvrzeni_objednavky')}
                      onClick={() => toggleSection('potvrzeni_objednavky')}
                      style={{ cursor: 'pointer' }}
                    >
                      <FontAwesomeIcon icon={faChevronUp} />
                    </CollapseIcon>
                  </SectionControls>
                </SectionHeader>
                <SectionContent collapsed={sectionStates.potvrzeni_objednavky} data-section="potvrzeni_objednavky">
                  <FormRow>
                    <FormGroup style={{gridColumn: '1 / -1'}}>
                      {/* PotvrzenÃ­ od dodavatele - ANO/NE */}
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '1rem',
                        padding: '1rem',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        backgroundColor: formData.dodavatel_zpusob_potvrzeni?.potvrzeni === 'ANO' ? '#f0fdf4' : '#f9fafb',
                        marginBottom: '1rem'
                      }}>
                        <span style={{
                          fontSize: '1rem',
                          fontWeight: '500',
                          color: '#374151'
                        }}>
                          Dodavatel objednÃ¡vku potvrdil:
                        </span>
                        <div style={{ display: 'flex', gap: '1rem' }}>
                          {['ANO', 'NE'].map(option => (
                            <label key={option} style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem',
                              padding: '0.5rem 1rem',
                              border: '1px solid #e5e7eb',
                              borderRadius: '6px',
                              cursor: shouldLockPhase4to6Sections ? 'not-allowed' : 'pointer',
                              backgroundColor: formData.dodavatel_zpusob_potvrzeni?.potvrzeni === option ? '#f0f9ff' : '#fff',
                              opacity: shouldLockPhase4to6Sections ? 0.6 : 1,
                              fontWeight: '500'
                            }}>
                              <input
                                type="radio"
                                name="potvrzeni_dodavatele"
                                value={option}
                                checked={formData.dodavatel_zpusob_potvrzeni?.potvrzeni === option}
                                disabled={shouldLockPhase4to6Sections}
                                onChange={() => {}} // PrÃ¡zdnÃ© onChange
                                onClick={(e) => {
                                  const currentValue = formData.dodavatel_zpusob_potvrzeni?.potvrzeni;
                                  let newValue;

                                  // Pokud klikÃ¡m na jiÅ¾ vybranou moÅ¾nost, odÅ¡krtni ji
                                  if (currentValue === e.target.value) {
                                    newValue = '';
                                  } else {
                                    newValue = e.target.value;
                                  }

                                  const newData = {
                                    ...formData.dodavatel_zpusob_potvrzeni,
                                    potvrzeni: newValue,
                                    zpusoby: newValue === 'ANO' ? formData.dodavatel_zpusob_potvrzeni?.zpusoby || [] : [],
                                    platba: newValue === 'ANO' ? 'faktura' : '' // âœ… VÅ¾dy "faktura" kdyÅ¾ je ANO
                                  };
                                  handleInputChange('dodavatel_zpusob_potvrzeni', newData);

                                  // ðŸ†• AUTOMATICKY nastavit dodavatel_potvrdil_id pÅ™i zmÄ›nÄ› potvrzenÃ­
                                  if (newValue === 'ANO' && user_id) {
                                    handleInputChange('dodavatel_potvrdil_id', user_id);
                                    addDebugLog('info', 'AKCEPTACE', 'dodavatel-potvrdil', `Automaticky nastaven dodavatel_potvrdil_id: ${user_id}`);
                                  } else if (newValue !== 'ANO') {
                                    handleInputChange('dodavatel_potvrdil_id', null);
                                    addDebugLog('info', 'AKCEPTACE', 'dodavatel-reset', `VymazÃ¡n dodavatel_potvrdil_id (potvrzenÃ­ nenÃ­ ANO)`);
                                  }
                                }}
                                style={{ cursor: 'pointer' }}
                              />
                              {option}
                            </label>
                          ))}
                        </div>
                      </div>

                      {/* ZpÅ¯sob potvrzenÃ­ - zobrazÃ­ se pouze pokud je ANO */}
                      {formData.dodavatel_zpusob_potvrzeni?.potvrzeni === 'ANO' && (
                        <>
                          <FormRow>
                            {/* LevÃ½ sloupec: ZpÅ¯sob potvrzenÃ­ */}
                            <FormGroup>
                              <Label required>ZpÅ¯sob potvrzenÃ­</Label>
                              <div style={{
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '0.5rem',
                                marginTop: '0.5rem'
                              }}>
                                {[
                                  { value: 'email', label: 'E-mail' },
                                  { value: 'telefon', label: 'TelefonÃ¡t' },
                                  { value: 'podepsana_objednavka', label: 'PodepsanÃ¡ objednÃ¡vka' },
                                  { value: 'eshop', label: 'e-Shop' }
                                ].map(option => {
                                  const isChecked = Array.isArray(formData.dodavatel_zpusob_potvrzeni?.zpusoby)
                                    ? formData.dodavatel_zpusob_potvrzeni.zpusoby.includes(option.value)
                                    : false;

                                  const isDisabled = formData.dodavatel_zpusob_potvrzeni?.potvrzeni !== 'ANO' ||
                                    shouldLockPhase4to6Sections ||
                                    showSaveProgress ||
                                    isSaving;

                                  const hasValidationError = !!validationErrors.dodavatel_zpusob_potvrzeni;

                                  return (
                                    <label key={option.value} style={{
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '0.5rem',
                                      padding: '0.5rem 1rem',
                                      border: hasValidationError ? '2px solid #dc2626' : '1px solid #e5e7eb',
                                      borderRadius: '6px',
                                      cursor: isDisabled ? 'not-allowed' : 'pointer',
                                      backgroundColor: isChecked ? '#f0f9ff' : '#fff',
                                      opacity: isDisabled ? 0.5 : 1
                                    }}>
                                      <input
                                        type="checkbox"
                                        checked={isChecked}
                                        disabled={isDisabled}
                                        onChange={(e) => {
                                          const currentZpusoby = Array.isArray(formData.dodavatel_zpusob_potvrzeni?.zpusoby)
                                            ? formData.dodavatel_zpusob_potvrzeni.zpusoby
                                            : [];

                                          let newZpusoby;
                                          if (e.target.checked) {
                                            newZpusoby = [...currentZpusoby, option.value];
                                          } else {
                                            newZpusoby = currentZpusoby.filter(val => val !== option.value);
                                          }

                                          const newData = {
                                            ...formData.dodavatel_zpusob_potvrzeni,
                                            zpusoby: newZpusoby
                                          };
                                          
                                          // âœ… OPRAVA: Aktualizovat OBA fieldy NAJEDNOU pomocÃ­ setFormData
                                          const now = new Date().toISOString();
                                          setFormData(prev => ({
                                            ...prev,
                                            dodavatel_zpusob_potvrzeni: newData,
                                            dt_akceptace: newZpusoby.length > 0 ? now : ''
                                          }));
                                          setIsChanged(true);
                                        }}
                                        style={{ cursor: 'pointer' }}
                                      />
                                      {option.label}
                                    </label>
                                  );
                                })}
                              </div>
                              {validationErrors.dodavatel_zpusob_potvrzeni && (
                                <div style={{
                                  color: '#dc2626',
                                  fontSize: '0.875rem',
                                  marginTop: '0.5rem',
                                  fontWeight: '500'
                                }}>
                                  {validationErrors.dodavatel_zpusob_potvrzeni}
                                </div>
                              )}
                            </FormGroup>

                            {/* PravÃ½ sloupec: Datum akceptace + ZpÅ¯sob platby */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                              {/* Datum akceptace - zobrazÃ­ se vÅ¾dy kdyÅ¾ je ANO zaÅ¡krtnuto */}
                              {formData.dodavatel_zpusob_potvrzeni?.potvrzeni === 'ANO' && (
                              <FormGroup>
                                <Label required>Datum akceptace</Label>
                                <DatePicker
                                  fieldName="dt_akceptace"
                                  value={formData.dt_akceptace}
                                  onChange={(value) => handleInputChange('dt_akceptace', value)}
                                  onBlur={(value) => handleFieldBlur('dt_akceptace', value)}
                                  disabled={
                                    shouldLockPhase4to6Sections ||
                                    showSaveProgress ||
                                    isSaving
                                  }
                                  hasError={!!validationErrors.dt_akceptace}
                                  placeholder="Vyberte datum..."
                                />
                                {validationErrors.dt_akceptace && (
                                  <div style={{
                                    color: '#dc2626',
                                    fontSize: '0.875rem',
                                    marginTop: '0.5rem',
                                    fontWeight: '500'
                                  }}>
                                    {validationErrors.dt_akceptace}
                                  </div>
                                )}
                              </FormGroup>
                              )}

                              {/* ZpÅ¯sob platby - pouze Faktura */}
                              <FormGroup style={{ marginTop: 'calc(2.5rem + 2px)' }}>
                                <Label required>ZpÅ¯sob platby</Label>
                                <div style={{
                                  display: 'flex',
                                  flexDirection: 'column',
                                  gap: '0.5rem',
                                  marginTop: '0.5rem'
                                }}>
                                  <label style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    padding: '0.5rem 1rem',
                                    border: '1px solid #e5e7eb',
                                    borderRadius: '6px',
                                    cursor: 'default',
                                    backgroundColor: '#f0f9ff',
                                    marginTop: '2px'
                                  }}>
                                    <input
                                      type="radio"
                                      name="platba_dodavatel"
                                      value="faktura"
                                      checked={true}
                                      disabled={shouldLockPhase4to6Sections || showSaveProgress || isSaving}
                                      readOnly
                                      style={{ cursor: 'default' }}
                                    />
                                    Faktura
                                  </label>
                                </div>
                                {validationErrors.zpusob_platby && (
                                  <div style={{
                                    color: '#dc2626',
                                    fontSize: '0.875rem',
                                    marginTop: '0.5rem',
                                    fontWeight: '500'
                                  }}>
                                    {validationErrors.zpusob_platby}
                                  </div>
                                )}
                              </FormGroup>
                            </div>
                          </FormRow>
                        </>
                      )}

                      {/* InformaÄnÃ­ zprÃ¡va o dalÅ¡Ã­ch sekcÃ­ch - zobrazÃ­ se po potvrzenÃ­ dodavatelem, ale ne kdyÅ¾ je jiÅ¾ odeslÃ¡no */}
                      {formData.dodavatel_zpusob_potvrzeni?.potvrzeni === 'ANO' &&
                       formData.dodavatel_zpusob_potvrzeni?.zpusoby?.length > 0 &&
                       formData.dodavatel_zpusob_potvrzeni?.platba &&
                       !formData.stav_odeslano &&
                       currentPhase < 4 && (
                        <div style={{
                          backgroundColor: '#f0f9ff',
                          border: '1px solid #bfdbfe',
                          borderRadius: '8px',
                          padding: '1rem',
                          marginTop: '1rem',
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '0.5rem'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <FontAwesomeIcon
                              icon={faInfoCircle}
                              style={{ color: '#3b82f6', fontSize: '1rem' }}
                            />
                            <span style={{ fontSize: '0.875rem', color: '#1e40af' }}>
                              Po vyplnÄ›nÃ­ ÃºdajÅ¯ o dodavateli budou dostupnÃ© dalÅ¡Ã­ sekce.
                            </span>
                          </div>
                          {formData.dt_akceptace && (
                            <div style={{ fontSize: '0.875rem', color: '#1e40af', marginTop: '0.25rem' }}>
                              <strong>Datum potvrzenÃ­:</strong> {formatDateOnly(formData.dt_akceptace)}
                              {formData.dodavatel_potvrdil_id && (
                                <div style={{ marginTop: '0.25rem' }}>
                                  <strong>Potvrdil:</strong> {getUserNameById(formData.dodavatel_potvrdil_id)}
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      )}
                    </FormGroup>
                  </FormRow>

                  {/* Info blok - Dodavatel potvrdil objednÃ¡vku */}
                  {/* âš ï¸ ZOBRAZÃ SE JEN PO ULOÅ½ENÃ DO DB (workflow POTVRZENA) */}
                  {hasWorkflowState(formData.stav_workflow_kod, 'POTVRZENA') && formData.dodavatel_potvrdil_id && formData.dt_akceptace ? (
                    <div style={{
                      backgroundColor: '#dcfce7',
                      border: '1px solid #16a34a',
                      borderRadius: '6px',
                      padding: '1rem',
                      marginTop: '1rem',
                      color: '#166534',
                      fontSize: '0.875rem'
                    }}>
                      <div style={{ fontWeight: '600', marginBottom: '0.25rem' }}>
                        âœ… Dodavatel potvrdil objednÃ¡vku
                      </div>
                      <div>
                        <strong>Datum potvrzenÃ­:</strong> {formatDateOnly(formData.dt_akceptace)} â€¢ <strong>Potvrdil:</strong> {getUserNameById(formData.dodavatel_potvrdil_id)}
                      </div>
                      {/* ZpÅ¯sob potvrzenÃ­ a platba - na jednom Å™Ã¡dku */}
                      {(formData.dodavatel_zpusob_potvrzeni?.zpusoby?.length > 0 || formData.dodavatel_zpusob_potvrzeni?.platba) && (
                        <div>
                          {formData.dodavatel_zpusob_potvrzeni?.zpusoby?.length > 0 && (
                            <>
                              <strong>ZpÅ¯sob potvrzenÃ­:</strong> {formData.dodavatel_zpusob_potvrzeni.zpusoby.map(zpusob => {
                                const labels = {
                                  'email': 'E-mail',
                                  'telefon': 'TelefonÃ¡t',
                                  'podepsana_objednavka': 'PodepsanÃ¡ objednÃ¡vka',
                                  'eshop': 'e-Shop'
                                };
                                return labels[zpusob] || zpusob;
                              }).join(', ')}
                            </>
                          )}
                          {formData.dodavatel_zpusob_potvrzeni?.zpusoby?.length > 0 && formData.dodavatel_zpusob_potvrzeni?.platba && ' â€¢ '}
                          {formData.dodavatel_zpusob_potvrzeni?.platba && (
                            <>
                              <strong>Platba:</strong> {formData.dodavatel_zpusob_potvrzeni.platba === 'faktura' ? 'Fakturou' :
                                                          formData.dodavatel_zpusob_potvrzeni.platba === 'hotove' ? 'HotovÄ› (pokladna)' :
                                                          formData.dodavatel_zpusob_potvrzeni.platba}
                            </>
                          )}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div style={{
                      backgroundColor: '#dbeafe',
                      border: '2px solid #3b82f6',
                      borderRadius: '8px',
                      padding: '1rem',
                      marginTop: '1rem',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}>
                      <FontAwesomeIcon
                        icon={faInfoCircle}
                        style={{ color: '#3b82f6', fontSize: '1.25rem' }}
                      />
                      <div style={{ flex: 1 }}>
                        <div style={{ fontWeight: '600', color: '#1e40af', marginBottom: '0.25rem' }}>
                          â„¹ï¸ ÄŒekÃ¡ se na potvrzenÃ­ dodavatelem
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#1e40af' }}>
                          Po potvrzenÃ­ objednÃ¡vky dodavatelem se zde zobrazÃ­ Ãºdaje o potvrzenÃ­.
                        </div>
                      </div>
                    </div>
                  )}

                </SectionContent>
              </FormSection>
              )}

              {/* Sekce: UveÅ™ejnÄ›nÃ­ v registru smluv */}
              {/* âœ… FÃZE 4: Pouze checkbox "MÃ¡ bÃ½t zveÅ™ejnÄ›na" */}
              {registrState.visible && (
              <FormSection data-section="registr_smluv">
                <SectionHeader
                  sectionTheme={getSectionTheme('registr_smluv')}
                  isActive={isSectionActive('registr_smluv')}
                >
                  <SectionTitle sectionTheme={getSectionTheme('registr_smluv')}>
                    <SectionIcon sectionTheme={getSectionTheme('registr_smluv')}>
                      <FontAwesomeIcon icon={faFileContract} />
                    </SectionIcon>
                    <span>RozhodnutÃ­ o zveÅ™ejnÄ›nÃ­ v registru smluv</span>

                    {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                    {isRegistrLocked && !shouldLockAllSections && (
                      <LockWarning title={
                        (formData.dt_zverejneni && formData.registr_iddt && formData.ma_byt_zverejnena)
                          ? 'Registr je zveÅ™ejnÄ›n a zamÄen. Odemknout mÅ¯Å¾e pouze uÅ¾ivatel s oprÃ¡vnÄ›nÃ­m ORDER_PUBLISH_REGISTRY.'
                          : ((formData.ma_byt_zverejnena === false && currentPhase >= 6)
                            ? 'Registr nenÃ­ k zveÅ™ejnÄ›nÃ­ a je zamÄen. Odemknout mÅ¯Å¾e pouze uÅ¾ivatel s oprÃ¡vnÄ›nÃ­m ORDER_PUBLISH_REGISTRY.'
                            : 'Registr je zamÄen. Odemknout mÅ¯Å¾e pouze uÅ¾ivatel s oprÃ¡vnÄ›nÃ­m ORDER_PUBLISH_REGISTRY.'
                          )
                      }>
                        ðŸ”’ Sekce zamÄena
                      </LockWarning>
                    )}
                  </SectionTitle>

                  <SectionControls>
                    {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                    {isRegistrLocked && !shouldLockAllSections && canPublishRegistry && (
                      <UnlockButton
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowUnlockRegistrConfirm(true);
                        }}
                        title="Odemknout sekci Registr smluv"
                      >
                        <Unlock />
                      </UnlockButton>
                    )}

                    <CollapseIcon
                      collapsed={sectionStates.registr_smluv}
                      sectionTheme={getSectionTheme('registr_smluv')}
                      onClick={() => toggleSection('registr_smluv')}
                      style={{ cursor: 'pointer' }}
                    >
                      <FontAwesomeIcon icon={faChevronUp} />
                    </CollapseIcon>
                  </SectionControls>
                </SectionHeader>
                <SectionContent collapsed={sectionStates.registr_smluv}>
                  {/* CHECKBOX "MÃ¡ bÃ½t zveÅ™ejnÄ›na" - zobrazÃ­ se vÅ¾dy kdyÅ¾ je sekce viditelnÃ¡ */}
                  <div style={{ marginBottom: '1.5rem' }}>
                    <Label style={{ marginBottom: '0.5rem' }}>ZveÅ™ejnÄ›nÃ­</Label>
                    <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        padding: '0.625rem 1rem',
                        backgroundColor: formData.ma_byt_zverejnena ? '#dcfce7' : '#fff',
                        border: formData.ma_byt_zverejnena ? '2px solid #16a34a' : '2px solid #e5e7eb',
                        borderRadius: '8px',
                        cursor: (isRegistrLocked) ? 'not-allowed' : 'pointer',
                        fontSize: '0.95rem',
                        fontWeight: '500',
                        color: formData.ma_byt_zverejnena ? '#166534' : '#374151',
                        opacity: (isRegistrLocked) ? 0.6 : 1,
                        minHeight: '44px',
                        boxSizing: 'border-box'
                      }}>
                        <input
                          type="checkbox"
                          checked={formData.ma_byt_zverejnena || false}
                          onChange={(e) => {
                            // Pokud je sekce zamÄena, nedÄ›lej nic
                            if (isRegistrLocked) return;

                            // Pokud odÅ¡krtÃ¡vÃ¡ a cena >= 50K, zobrazit confirm dialog
                            if (!e.target.checked && formData.ma_byt_zverejnena && celkovaCenaBezDPH >= 50000) {
                              setShowCancelPublishConfirm(true);
                            } else {
                              // BuÄ zaÅ¡krtÃ¡vÃ¡, nebo odÅ¡krtÃ¡vÃ¡ pod 50K â†’ prostÄ› zmÄ›Åˆ
                              handleInputChange('ma_byt_zverejnena', e.target.checked);
                            }
                          }}
                          disabled={isRegistrLocked}
                          style={{
                            width: '18px',
                            height: '18px',
                            cursor: (isRegistrLocked) ? 'not-allowed' : 'pointer',
                            flexShrink: 0
                          }}
                        />
                        <span style={{ flex: 1 }}>
                          {currentPhase >= 5
                            ? 'ObjednÃ¡vka mÃ¡ bÃ½t zveÅ™ejnÄ›na v registru smluv'
                            : 'MÃ¡ bÃ½t zveÅ™ejnÄ›na'}
                        </span>
                      </label>

                      {/* InformaÄnÃ­ text o povinnosti zveÅ™ejnÄ›nÃ­ */}
                      <div style={{
                        marginTop: '0.75rem',
                        padding: '0.75rem 1rem',
                        backgroundColor: celkovaCenaBezDPH >= 50000 ? '#dbeafe' : '#f3f4f6',
                        border: `1px solid ${celkovaCenaBezDPH >= 50000 ? '#3b82f6' : '#d1d5db'}`,
                        borderRadius: '6px',
                        fontSize: '0.875rem',
                        color: celkovaCenaBezDPH >= 50000 ? '#1e40af' : '#6b7280'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem' }}>
                          <FontAwesomeIcon
                            icon={faInfoCircle}
                            style={{ fontSize: '1rem', marginTop: '0.125rem', flexShrink: 0 }}
                          />
                          <div>
                            <div style={{ fontWeight: '600', marginBottom: '0.25rem' }}>
                              {celkovaCenaBezDPH >= 50000 ? 'PovinnÃ© zveÅ™ejnÄ›nÃ­' : 'VolitelnÃ© zveÅ™ejnÄ›nÃ­'}
                            </div>
                            <div>
                              {celkovaCenaBezDPH >= 50000 ? (
                                <>
                                  CelkovÃ¡ cena <strong>{celkovaCenaBezDPH.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ bez DPH</strong> je nad limitem 50 000 KÄ.
                                  ObjednÃ¡vka <strong>musÃ­ bÃ½t zveÅ™ejnÄ›na</strong> v registru smluv podle zÃ¡kona.
                                </>
                              ) : (
                                <>
                                  CelkovÃ¡ cena <strong>{celkovaCenaBezDPH.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ bez DPH</strong> je pod limitem 50 000 KÄ.
                                  ZveÅ™ejnÄ›nÃ­ v registru smluv je volitelnÃ©.
                                </>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                  {/* FÃZE 4: Instrukce a varovÃ¡nÃ­ */}
                  {(isArchived || currentPhase === 4) && (
                    <>
                      {!formData.ma_byt_zverejnena && celkovaCenaBezDPH < 50000 && (
                        <div style={{
                          padding: '1rem',
                          backgroundColor: '#fef3c7',
                          border: '1px solid #f59e0b',
                          borderRadius: '6px',
                          fontSize: '0.875rem',
                          color: '#92400e'
                        }}>
                          â„¹ï¸ Po uloÅ¾enÃ­ s odÅ¡krtnutÃ½m checkboxem se pÅ™eskoÄÃ­ vyplÅˆovÃ¡nÃ­ registru smluv a pokraÄuje se pÅ™Ã­mo k fakturaci.
                        </div>
                      )}
                    </>
                  )}
                </SectionContent>
              </FormSection>
              )}
              {/* KONEC: Sekce Registr smluv (FÃZE 4 - checkbox) */}

              {/* ðŸ“ INFORMAÄŒNÃ BLOK: Pro uÅ¾ivatele BEZ prÃ¡va ORDER_PUBLISH_REGISTRY - pouze kdyÅ¾ ÄŒEKÃ na vyplnÄ›nÃ­ */}
              {(() => {
                const isRegistrFilled = formData.dt_zverejneni && formData.registr_iddt;
                const showInfoBlock = registrVyplneniState.visible && !canPublishRegistry && !isRegistrFilled;
                return showInfoBlock && (
                  <div style={{
                    margin: '2rem 0',
                    padding: '1rem 1.25rem',
                    backgroundColor: '#fef3c7',
                    border: '1px solid #f59e0b',
                    borderRadius: '8px',
                    color: '#92400e'
                  }}>
                    <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      ðŸ”’ ZveÅ™ejnÄ›nÃ­ v registru smluv
                    </div>
                    <div style={{ fontSize: '0.875rem' }}>
                      ObjednÃ¡vka ÄekÃ¡ na zveÅ™ejnÄ›nÃ­ v registru smluv. Tuto akci mÅ¯Å¾e provÃ©st pouze uÅ¾ivatel s oprÃ¡vnÄ›nÃ­m pro sprÃ¡vu registru.
                    </div>
                  </div>
                );
              })()}

              {/* ðŸ“ SEKCE: VYPLNÄšNÃ REGISTRU SMLUV - ZOBRAZÃ SE VE FÃZI 5 (UVEREJNIT) */}
              {/* âœ… FÃZE 5: Datum + IDDT + checkbox (VOLITELNÃ - pouze kdyÅ¾ ANO ve FÃZI 4) */}
              {/* ðŸ”’ PRÃVA: 
                  - UÅ¾ivatelÃ© S prÃ¡vem ORDER_PUBLISH_REGISTRY vidÃ­ sekci ve FÃZI 5 (mohou vyplnit registr)
                  - UÅ¾ivatelÃ© BEZ prÃ¡va vidÃ­ sekci kdyÅ¾ je jiÅ¾ vyplnÄ›nÃ¡ (dt_zverejneni + registr_iddt)
              */}
              {(() => {
                const isRegistrFilled = formData.dt_zverejneni && formData.registr_iddt;
                const shouldShowRegistrVyplneni = registrVyplneniState.visible && (
                  canPublishRegistry || isRegistrFilled
                );
                return shouldShowRegistrVyplneni && (
              <FormSection data-section="registr_smluv_vyplneni">
                <SectionHeader
                  sectionTheme={getSectionTheme('registr_smluv_vyplneni')}
                  isActive={isSectionActive('registr_smluv_vyplneni')}
                >
                  <SectionTitle sectionTheme={getSectionTheme('registr_smluv_vyplneni')}>
                    <SectionIcon sectionTheme={getSectionTheme('registr_smluv_vyplneni')}>
                      <FontAwesomeIcon icon={faFileContract} />
                    </SectionIcon>
                    <span>PotvrzenÃ­ zveÅ™ejnÄ›nÃ­ objednÃ¡vky v registru smluv</span>

                    {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                    {isRegistrVyplneniLocked && !shouldLockAllSections && (
                      <LockWarning title="Registr je zamÄen. Odemknout mÅ¯Å¾e pouze uÅ¾ivatel s oprÃ¡vnÄ›nÃ­m ORDER_PUBLISH_REGISTRY.">
                        ðŸ”’ Sekce zamÄena
                      </LockWarning>
                    )}
                  </SectionTitle>

                  <SectionControls>
                    {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                    {isRegistrVyplneniLocked && !shouldLockAllSections && canPublishRegistry && (
                      <UnlockButton
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowUnlockRegistrConfirm(true);
                        }}
                        title="Odemknout sekci Registr smluv"
                      >
                        <Unlock />
                      </UnlockButton>
                    )}

                    <CollapseIcon
                      collapsed={sectionStates.registr_smluv_vyplneni}
                      sectionTheme={getSectionTheme('registr_smluv_vyplneni')}
                      onClick={() => toggleSection('registr_smluv_vyplneni')}
                      style={{ cursor: 'pointer' }}
                    >
                      <FontAwesomeIcon icon={faChevronUp} />
                    </CollapseIcon>
                  </SectionControls>
                </SectionHeader>
                <SectionContent collapsed={sectionStates.registr_smluv_vyplneni}>
                  {/* Grid 3 sloupce: Checkbox | Datum | IdentifikÃ¡tor */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: '300px 1fr 1fr',
                    gap: '1.5rem',
                    alignItems: 'start'
                  }}>
                    {/* 1. CHECKBOX - MÃ¡ bÃ½t zveÅ™ejnÄ›na */}
                    <div>
                      <Label style={{ marginBottom: '0.5rem' }}>ZveÅ™ejnÄ›nÃ­</Label>
                      <label style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        padding: '0.625rem 1rem',
                        backgroundColor: formData.ma_byt_zverejnena ? '#dcfce7' : '#fff',
                        border: formData.ma_byt_zverejnena ? '2px solid #16a34a' : '2px solid #e5e7eb',
                        borderRadius: '8px',
                        cursor: isRegistrVyplneniLocked ? 'not-allowed' : 'pointer',
                        fontSize: '0.95rem',
                        fontWeight: '500',
                        color: formData.ma_byt_zverejnena ? '#166534' : '#374151',
                        opacity: isRegistrVyplneniLocked ? 0.6 : 1,
                        minHeight: '44px',
                        boxSizing: 'border-box'
                      }}>
                        <input
                          type="checkbox"
                          checked={formData.ma_byt_zverejnena || false}
                          onChange={(e) => {
                            if (isRegistrVyplneniLocked) return;

                            // Pokud odÅ¡krtÃ¡vÃ¡ a cena >= 50K, zobrazit confirm dialog
                            if (!e.target.checked && formData.ma_byt_zverejnena && celkovaCenaBezDPH >= 50000) {
                              setShowCancelPublishConfirm(true);
                            } else {
                              handleInputChange('ma_byt_zverejnena', e.target.checked);
                            }
                          }}
                          disabled={isRegistrVyplneniLocked}
                          style={{
                            width: '18px',
                            height: '18px',
                            cursor: isRegistrVyplneniLocked ? 'not-allowed' : 'pointer',
                            flexShrink: 0
                          }}
                        />
                        <span style={{ flex: 1, whiteSpace: 'nowrap' }}>MÃ¡ bÃ½t zveÅ™ejnÄ›na</span>
                      </label>
                    </div>

                    {/* 2. DATUM ZVEÅ˜EJNÄšNÃ */}
                    <div>
                      <Label required={formData.ma_byt_zverejnena}>Datum zveÅ™ejnÄ›nÃ­ (VZ)</Label>
                      <DatePicker
                        fieldName="dt_zverejneni"
                        value={formData.dt_zverejneni}
                        onChange={(value) => {
                          handleInputChange('dt_zverejneni', value);
                          if (value && !formData.zverejnil_id) {
                            const user_id = localStorage.getItem('user_id');
                            if (user_id) {
                              handleInputChange('zverejnil_id', parseInt(user_id, 10));
                            }
                          }
                        }}
                        onBlur={(value) => handleFieldBlur('dt_zverejneni', value)}
                        disabled={!formData.ma_byt_zverejnena || isRegistrVyplneniLocked}
                        hasError={!!validationErrors.dt_zverejneni}
                        placeholder="Vyberte datum..."
                      />
                      {validationErrors.dt_zverejneni && (
                        <ErrorText style={{ marginTop: '0.5rem' }}>{validationErrors.dt_zverejneni}</ErrorText>
                      )}
                    </div>

                    {/* 3. IDENTIFIKÃTOR */}
                    <div>
                      <Label required={formData.ma_byt_zverejnena}>IdentifikÃ¡tor</Label>
                      <InputWithIcon hasIcon>
                        <FontAwesomeIcon icon={faHashtag} />
                        <Input
                          type="text"
                          name="registr_iddt"
                          value={formData.registr_iddt || ''}
                          onChange={(e) => {
                            handleInputChange('registr_iddt', e.target.value);
                            if (e.target.value && !formData.zverejnil_id) {
                              const user_id = localStorage.getItem('user_id');
                              if (user_id) {
                                handleInputChange('zverejnil_id', parseInt(user_id, 10));
                              }
                            }
                          }}
                          disabled={!formData.ma_byt_zverejnena || isRegistrVyplneniLocked}
                          hasError={!!validationErrors.registr_iddt}
                          hasIcon
                          placeholder="Zadejte identifikÃ¡tor..."
                        />
                      </InputWithIcon>
                      {validationErrors.registr_iddt && (
                        <ErrorText style={{ marginTop: '0.5rem' }}>{validationErrors.registr_iddt}</ErrorText>
                      )}
                    </div>
                  </div>

                  {/* Å½LUTÃ ALERT - kdyÅ¾ NENÃ zaÅ¡krtnuto */}
                  {!formData.ma_byt_zverejnena && (
                    <div style={{
                      padding: '0.875rem 1rem',
                      backgroundColor: '#fef3c7',
                      border: '1px solid #f59e0b',
                      borderRadius: '6px',
                      fontSize: '0.875rem',
                      color: '#92400e',
                      marginTop: '1rem',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}>
                      <FontAwesomeIcon icon={faInfoCircle} style={{ fontSize: '1rem' }} />
                      <div>
                        <strong>ObjednÃ¡vka nebude zveÅ™ejnÄ›na v registru smluv.</strong>
                      </div>
                    </div>
                  )}

                  {/* âœ… ZELENÃ BOX - ObjednÃ¡vka byla zveÅ™ejnÄ›na (pouze kdyÅ¾ UVEREJNENA) */}
                  {hasWorkflowState(formData.stav_workflow_kod, 'UVEREJNENA') && (
                    <div style={{
                      marginTop: '1.5rem',
                      padding: '1rem',
                      backgroundColor: '#dcfce7',
                      border: '1px solid #16a34a',
                      borderRadius: '6px',
                      fontSize: '0.875rem',
                      color: '#166534'
                    }}>
                      <div style={{ fontWeight: '600', marginBottom: '0.25rem' }}>
                        âœ… ObjednÃ¡vka byla zveÅ™ejnÄ›na v registru smluv
                      </div>
                      <div>
                        <strong>Datum zveÅ™ejnÄ›nÃ­:</strong> {formatDateOnly(formData.dt_zverejneni)} â€¢ <strong>ZveÅ™ejnil:</strong> {getUserNameById(formData.zverejnil_id)}
                        {formData.registr_iddt && (
                          <>
                            {' â€¢ '}
                            <strong>ID registru:</strong> {formData.registr_iddt}
                          </>
                        )}
                      </div>
                    </div>
                  )}
                </SectionContent>
              </FormSection>
                );
              })()}
              {/* KONEC: Sekce VyplnÄ›nÃ­ registru smluv (FÃZE 5 - volitelnÃ¡) */}

              {/* ðŸ’° SEKCE: FAKTURACE / DOKLADY - ZOBRAZÃ SE VE FÃZI 6+ (FAKTURACE a vÃ½Å¡e) */}
              {/* PodmÃ­nky zobrazenÃ­:
                  1. currentPhase >= 6 (FÃZE 6 a vÃ½Å¡e - 6, 7, 8, 9)
                  2. âœ… Zobrazuje se i ve vyÅ¡Å¡Ã­ch fÃ¡zÃ­ch, ale je zamÄenÃ¡ (lockLogic v workflowManager)
                  3. ðŸ†• SKRÃT kdyÅ¾ platba = 'pokladna' (mÃ­sto toho se zobrazÃ­ DodateÄnÃ© dokumenty)
                  4. ðŸ†• Pokud platba = 'faktura' â†’ "Fakturace" s plnÃ½m blokem faktur
              */}
              {(() => {
                // ðŸ†• UrÄit typ platby: pokladna nebo faktura
                // Kontroluje platbu z financovÃ¡nÃ­ objednÃ¡vky A z potvrzenÃ­ dodavatele
                const isPlatbaPokladnaObj = formData.financovani?.platba === 'pokladna';
                const isPlatbaPokladnaDodavatel = formData.dodavatel_zpusob_potvrzeni?.platba === 'pokladna';
                const isPokladna = isPlatbaPokladnaObj || isPlatbaPokladnaDodavatel;

                // âŒ SKRÃT sekci Fakturace kdyÅ¾ je pokladna
                // ðŸ”’ PRÃVA: 
                // - UÅ¾ivatelÃ© S prÃ¡vem INVOICE_MANAGE vidÃ­ sekci od FÃZE 6 (mohou pÅ™idÃ¡vat faktury)
                // - UÅ¾ivatelÃ© BEZ prÃ¡va vidÃ­ sekci kdyÅ¾:
                //   a) jsou ve FÃZI 7+ (aktivnÃ­ fÃ¡ze po fakturaci)
                //   b) existujÃ­ faktury (sekce je jiÅ¾ vyplnÄ›nÃ¡)
                const hasFaktury = formData.faktury && formData.faktury.length > 0;
                const shouldShow = !isPokladna && (
                  canManageInvoices 
                    ? currentPhase >= 6  // S prÃ¡vem: vidÃ­ od FÃZE 6
                    : (currentPhase >= 7 || hasFaktury)  // Bez prÃ¡va: vidÃ­ od FÃZE 7 nebo kdyÅ¾ jsou faktury
                );

                // Pokud nenÃ­ urÄen typ platby, zobrazit jako fakturu (default)
                const sectionTitle = 'Fakturace k objednÃ¡vce';
                const sectionDescription = `(poÄet: ${formData.faktury?.length || 0})`;

                return shouldShow ? (
                <FormSection data-section="fakturace">
                  <SectionHeader
                    sectionTheme="section-invoice"
                    isActive={true}
                    style={{
                      background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                      borderColor: '#2563eb'
                    }}
                  >
                    <SectionTitle sectionTheme="section-invoice" style={{ color: '#fff' }}>
                      <SectionIcon sectionTheme="section-invoice" style={{ color: '#fff' }}>
                        <FontAwesomeIcon icon={faCreditCard} />
                      </SectionIcon>
                      {sectionTitle}
                      <span style={{
                        fontSize: '0.75rem',
                        marginLeft: '0.5rem',
                        fontWeight: '400',
                        opacity: 0.9
                      }}>
                        {sectionDescription}
                      </span>
                      {/* âŒ Nezobrazovat zÃ¡mek kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) - odemknout lze pouze z hlaviÄky */}
                      {isFakturaceLockedPhase7 && !shouldLockAllSections && (
                        <LockWarning title="Sekce je zamÄena. Odemknout mÅ¯Å¾e administrÃ¡tor nebo uÅ¾ivatel s prÃ¡vem ORDER_MANAGE.">
                          ðŸ”’ Sekce zamÄena
                        </LockWarning>
                      )}
                    </SectionTitle>

                    <SectionControls>
                      {/* âŒ Nezobrazovat tlaÄÃ­tko odemknutÃ­ kdyÅ¾ je globÃ¡lnÃ­ lock (shouldLockAllSections) */}
                      {isFakturaceLockedPhase7 && !shouldLockAllSections && canManageInvoices && (
                        <UnlockButton
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowUnlockFakturaceConfirm(true);
                          }}
                          title="Odemknout sekci Fakturace"
                        >
                          <Unlock />
                        </UnlockButton>
                      )}

                      <CollapseIcon
                        collapsed={sectionStates.fakturace}
                        onClick={() => toggleSection('fakturace')}
                        style={{ color: '#fff', cursor: 'pointer' }}
                      >
                        <FontAwesomeIcon icon={faChevronUp} />
                      </CollapseIcon>
                    </SectionControls>
                  </SectionHeader>

                  <SectionContent collapsed={sectionStates.fakturace}>
                    <div>
                      {/* ðŸ†• POKLADNA: Zobrazit jen dropzone pro pÅ™Ã­lohy (paragony) */}
                      {isPokladna ? (
                        <div style={{ padding: '1.5rem' }}>
                          {(() => {
                            // ðŸ”¥ ZAJISTIT: VÅ¾dy alespoÅˆ jedna "faktura" (pokladnÃ­ doklad) ve fÃ¡zi 7+
                            if ((!formData.faktury || formData.faktury.length === 0) && !fakturyLoading) {
                              const dnesniDatum = formatDateForPicker(new Date());
                              const pokladniDoklad = {
                                id: `temp-pokladna-${Date.now()}`,
                                objednavka_id: (formData.id || savedOrderId),
                                fa_datum_doruceni: dnesniDatum,
                                fa_dorucena: 1,
                                fa_castka: null, // NepovinnÃ© pro pokladnu
                                fa_cislo_vema: '', // NepovinnÃ© pro pokladnu
                                fa_strediska_kod: formData.strediska_kod || [],
                                fa_splatnost: null, // NepovinnÃ© pro pokladnu
                                fa_poznamka: '',
                                vytvoril_uzivatel_id: user_id,
                                vytvoril_jmeno: getUserNameById(user_id),
                                dt_vytvoreni: new Date().toISOString(),
                                dt_aktualizace: null,
                                aktivni: 1,
                                _isNew: true,
                                _isPokladna: true, // ðŸ†• PÅ™Ã­znak pro pokladnÃ­ doklad
                                attachments: []
                              };

                              setTimeout(() => {
                                updateFaktury([pokladniDoklad]);
                              }, 0);
                            }
                            return null;
                          })()}

                          <div style={{
                            background: '#f8fafc',
                            border: '2px solid #e2e8f0',
                            borderRadius: '8px',
                            padding: '2rem'
                          }}>
                            <div style={{
                              fontSize: '2.5rem',
                              marginBottom: '1rem',
                              textAlign: 'center',
                              color: '#64748b'
                            }}>
                              ðŸ“„
                            </div>
                            <div style={{
                              fontSize: '1.125rem',
                              fontWeight: '500',
                              color: '#334155',
                              marginBottom: '0.5rem',
                              textAlign: 'center'
                            }}>
                              PÅ™Ã­lohy dokladÅ¯ z pokladny
                            </div>
                            <div style={{
                              fontSize: '0.875rem',
                              color: '#64748b',
                              marginBottom: '1.5rem',
                              textAlign: 'center'
                            }}>
                              Nahrajte paragony, pokladnÃ­ doklady a dalÅ¡Ã­ dokumenty k platbÄ›
                            </div>

                            {/* DROPZONE PRO PÅ˜ÃLOHY POKLADNY - pouÅ¾Ã­vÃ¡ stejnou logiku jako faktury */}
                            {formData.faktury && formData.faktury.length > 0 && formData.faktury[0] && (
                              <>
                                <InvoiceAttachmentsCompact
                                  key={`pokladna-attachments-${formData.faktury[0].id}-${formData.id}`}
                                  fakturaId={formData.faktury[0].id}
                                  objednavkaId={formData.id}
                                  fakturaTypyPrilohOptions={fakturaTypyPrilohOptions}
                                  readOnly={shouldLockFaktury}
                                  onISDOCParsed={handleISDOCParsed}
                                  formData={formData}
                                  faktura={formData.faktury[0]}
                                  validateInvoiceForAttachments={validateInvoiceForAttachments}
                                  isPokladna={true}
                                  attachments={formData.faktury[0].attachments || []}
                                  onAttachmentsChange={(newAttachments) => {
                                    handleInvoiceAttachmentsChange(formData.faktury[0].id, newAttachments);
                                  }}
                                  onAttachmentUploaded={(uploadedAttachment) => {
                                    handleInvoiceAttachmentUploaded(formData.faktury[0].id, uploadedAttachment);
                                  }}
                                  onCreateInvoiceInDB={handleCreateInvoiceInDB}
                                />

                                {/* POLE POZNÃMKA */}
                                <FormRow style={{ marginTop: '1.5rem' }}>
                                  <FormGroup style={{ gridColumn: '1 / -1' }}>
                                    <Label>
                                      PoznÃ¡mka k platbÄ›
                                      <span style={{ fontSize: '0.75rem', color: '#64748b', fontWeight: 'normal', marginLeft: '0.5rem' }}>
                                        (VolitelnÃ©)
                                      </span>
                                    </Label>
                                    <TextArea
                                      value={formData.faktury[0].fa_poznamka || ''}
                                      onChange={(e) => {
                                        const updatedFaktury = formData.faktury.map((f, idx) =>
                                          idx === 0
                                            ? { ...f, fa_poznamka: e.target.value }
                                            : f
                                        );
                                        updateFaktury(updatedFaktury);
                                      }}
                                      disabled={shouldLockFaktury}
                                      placeholder="NapÅ™.: Platba za materiÃ¡l, paragony ze dne 1.11.2025, apod."
                                      rows={3}
                                    />
                                  </FormGroup>
                                </FormRow>
                              </>
                            )}

                            {/* Info poznÃ¡mka */}
                            <div style={{
                              marginTop: '1.5rem',
                              padding: '1rem',
                              background: '#fef3c7',
                              border: '1px solid #fbbf24',
                              borderRadius: '6px',
                              fontSize: '0.875rem',
                              color: '#92400e',
                              textAlign: 'left'
                            }}>
                              <strong>â„¹ï¸ PoznÃ¡mka:</strong> PÅ™i platbÄ› pokladnou nenÃ­ nutnÃ© vyplÅˆovat ÄÃ­sla faktur ani ÄÃ¡stky.
                              StaÄÃ­ nahrÃ¡t paragony nebo pokladnÃ­ doklady jako pÅ™Ã­lohy a pÅ™Ã­padnÄ› doplnit poznÃ¡mku.
                            </div>
                          </div>
                        </div>
                      ) : (
                        /* FAKTURA: PlnÃ½ blok s fakturami */
                        <>
                      {(() => {
                        // ðŸ”¥ ZAJISTIT: VÅ¾dy alespoÅˆ jedna faktura ve fÃ¡zi 7+
                        // Pokud pole je prÃ¡zdnÃ©, okamÅ¾itÄ› ho naplÅˆ
                        if ((!formData.faktury || formData.faktury.length === 0) && !fakturyLoading) {
                          const dnesniDatum = formatDateForPicker(new Date());
                          const novaFaktura = {
                            id: `temp-${Date.now()}`,
                            objednavka_id: (formData.id || savedOrderId),
                            fa_datum_doruceni: dnesniDatum,
                            fa_dorucena: 1,
                            fa_castka: '',
                            fa_cislo_vema: '',
                            fa_strediska_kod: formData.strediska_kod || [],
                            fa_splatnost: '',
                            fa_poznamka: '',
                            vytvoril_uzivatel_id: user_id,
                            vytvoril_jmeno: getUserNameById(user_id),
                            dt_vytvoreni: new Date().toISOString(),
                            dt_aktualizace: null,
                            aktivni: 1,
                            _isNew: true,
                            attachments: [] // PrÃ¡zdnÃ© pole pro pÅ™Ã­lohy
                          };

                          // OkamÅ¾itÄ› aktualizuj stav
                          setTimeout(() => {
                            updateFaktury([novaFaktura]);
                          }, 0);
                        }
                        return null;
                      })()}

                      {fakturyLoading ? (
                        <div style={{ textAlign: 'center', padding: '2rem', color: '#64748b' }}>
                          NaÄÃ­tÃ¡nÃ­ faktur...
                        </div>
                      ) : (
                        <div style={{ marginTop: '1.5rem' }}>
                          {/* ðŸ”¥ FALLBACK: Pokud i pÅ™es vÃ½Å¡e uvedenÃ© je pole prÃ¡zdnÃ©, zobraz placeholder */}
                          {(!formData.faktury || formData.faktury.length === 0) ? (
                            <div style={{
                              border: '2px dashed #cbd5e1',
                              borderRadius: '8px',
                              padding: '2rem',
                              textAlign: 'center',
                              color: '#64748b',
                              background: '#f8fafc'
                            }}>
                              <div style={{ fontSize: '1.25rem', marginBottom: '0.5rem' }}>ðŸ“„</div>
                              <div style={{ fontWeight: '500', marginBottom: '0.5rem' }}>NaÄÃ­tÃ¡m prvnÃ­ fakturu...</div>
                              <div style={{ fontSize: '0.875rem' }}>ProsÃ­m chvÃ­li strpenÃ­</div>
                            </div>
                          ) : (
                            formData.faktury.map((faktura, index) => {
                            const isEditing = editingFaktura?.id === faktura.id;
                            const currentData = isEditing ? fakturaFormData : faktura;
                            const isVecnaPotvrzena = faktura.vecna_spravnost_potvrzeno === 1;

                            return (
                            <div key={faktura.id} style={{
                              border: '2px solid #3b82f6',
                              borderRadius: '12px',
                              padding: '0',
                              marginBottom: '1.5rem',
                              background: isEditing ? '#f0f9ff' : (isVecnaPotvrzena ? '#f0fdf4' : '#ffffff'),
                              boxShadow: '0 2px 8px rgba(0, 0, 0, 0.08)',
                              overflow: 'hidden'
                            }}>
                              {/* ZÃ¡hlavÃ­ faktury - vÃ½raznÃ© */}
                              <div style={{
                                background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                                color: 'white',
                                padding: '1rem 1.25rem',
                                fontWeight: '700',
                                fontSize: '1.1rem',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                gap: '1rem',
                                borderBottom: '3px solid #1e40af',
                                letterSpacing: '0.5px',
                                textTransform: 'uppercase'
                              }}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                                  <FontAwesomeIcon icon={faCreditCard} style={{ fontSize: '1.2rem' }} />
                                  Faktura #{index + 1}
                                  {index === 0 && <span style={{color: '#fef3c7', fontSize: '1.3rem'}}>*</span>}
                                  {faktura.fa_cislo_vema && (
                                    <span style={{ 
                                      fontWeight: '600',
                                      fontSize: '0.9rem',
                                      background: 'rgba(255, 255, 255, 0.2)',
                                      padding: '0.25rem 0.75rem',
                                      borderRadius: '6px',
                                      letterSpacing: 'normal',
                                      textTransform: 'none'
                                    }}>
                                      {faktura.fa_cislo_vema}
                                    </span>
                                  )}

                                  {/* ðŸ†• Info tooltip s detaily faktury */}
                                  <FakturaInfoIconWrapper>
                                    <FakturaInfoIcon className="help-icon">
                                      <Info />
                                    </FakturaInfoIcon>
                                    <FakturaTooltipBubble className="tooltip-bubble">
                                      {/* DODAVATEL z ISDOC */}
                                      {faktura._isdoc_dodavatel && (
                                        <>
                                          <FakturaTooltipRow>
                                            <FakturaTooltipLabel>Vystavil:</FakturaTooltipLabel>
                                            <FakturaTooltipValue style={{ display: 'flex', alignItems: 'center', gap: '6px', fontWeight: '600' }}>
                                              {faktura._isdoc_dodavatel.nazev || '---'}
                                              {faktura._isdoc_dodavatel.nazev && (
                                                <Copy
                                                  size={14}
                                                  style={{ cursor: 'pointer', color: '#6b7280' }}
                                                  onClick={() => {
                                                    navigator.clipboard.writeText(faktura._isdoc_dodavatel.nazev);
                                                    showToast && showToast('NÃ¡zev zkopÃ­rovÃ¡n', { type: 'success' });
                                                  }}
                                                  title="ZkopÃ­rovat nÃ¡zev"
                                                />
                                              )}
                                            </FakturaTooltipValue>
                                          </FakturaTooltipRow>
                                          <FakturaTooltipRow>
                                            <FakturaTooltipLabel>IÄŒO:</FakturaTooltipLabel>
                                            <FakturaTooltipValue style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                              {faktura._isdoc_dodavatel.ico || '---'}
                                              {faktura._isdoc_dodavatel.ico && (
                                                <Copy
                                                  size={14}
                                                  style={{ cursor: 'pointer', color: '#6b7280' }}
                                                  onClick={() => {
                                                    navigator.clipboard.writeText(faktura._isdoc_dodavatel.ico);
                                                    showToast && showToast('IÄŒO zkopÃ­rovÃ¡no', { type: 'success' });
                                                  }}
                                                  title="ZkopÃ­rovat IÄŒO"
                                                />
                                              )}
                                            </FakturaTooltipValue>
                                          </FakturaTooltipRow>
                                          <div style={{ borderTop: '1px solid #e5e7eb', margin: '8px 0' }}></div>
                                        </>
                                      )}

                                      {/* ðŸ†• EMAIL SMÄšROVÃNÃ z ISDOC */}
                                      {faktura._isdoc_email && (
                                        <>
                                          <FakturaTooltipRow>
                                            <FakturaTooltipLabel>SmÄ›rovÃ¡no na:</FakturaTooltipLabel>
                                            <FakturaTooltipValue style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                              {faktura._isdoc_email}
                                              <Copy
                                                size={14}
                                                style={{ cursor: 'pointer', color: '#6b7280' }}
                                                onClick={() => {
                                                  navigator.clipboard.writeText(faktura._isdoc_email);
                                                  showToast && showToast('Email zkopÃ­rovÃ¡n', { type: 'success' });
                                                }}
                                                title="ZkopÃ­rovat email"
                                              />
                                            </FakturaTooltipValue>
                                          </FakturaTooltipRow>
                                          <div style={{ borderTop: '1px solid #e5e7eb', margin: '8px 0' }}></div>
                                        </>
                                      )}

                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>ÄŒÃ­slo faktury:</FakturaTooltipLabel>
                                        <FakturaTooltipValue>{faktura.fa_cislo_vema || '---'}</FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>ÄŒÃ¡stka:</FakturaTooltipLabel>
                                        <FakturaTooltipValue>
                                          {faktura.fa_castka ? `${parseFloat(faktura.fa_castka).toLocaleString('cs-CZ')} KÄ` : '---'}
                                        </FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>Datum vystavenÃ­:</FakturaTooltipLabel>
                                        <FakturaTooltipValue>
                                          {faktura.fa_datum_vystaveni ? formatDateOnly(faktura.fa_datum_vystaveni) : '---'}
                                        </FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>Datum splatnosti:</FakturaTooltipLabel>
                                        <FakturaTooltipValue>
                                          {(faktura.fa_datum_splatnosti || faktura.fa_splatnost)
                                            ? formatDateOnly(faktura.fa_datum_splatnosti || faktura.fa_splatnost)
                                            : '---'}
                                        </FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>Datum doruÄenÃ­:</FakturaTooltipLabel>
                                        <FakturaTooltipValue>
                                          {faktura.fa_datum_doruceni ? formatDateOnly(faktura.fa_datum_doruceni) : '---'}
                                        </FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>VÄ›cnÃ¡ sprÃ¡vnost:</FakturaTooltipLabel>
                                        <FakturaTooltipValue>
                                          {faktura.vecna_spravnost_potvrzeno === 'ANO' && (
                                            <span style={{ 
                                              display: 'inline-flex', 
                                              alignItems: 'center', 
                                              gap: '0.25rem',
                                              background: '#d1fae5',
                                              color: '#065f46',
                                              padding: '2px 8px',
                                              borderRadius: '4px',
                                              fontSize: '0.75rem',
                                              fontWeight: '600'
                                            }}>
                                              <FontAwesomeIcon icon={faCheckCircle} />
                                              ANO
                                            </span>
                                          )}
                                          {faktura.vecna_spravnost_potvrzeno === 'NE' && (
                                            <span style={{ 
                                              display: 'inline-flex', 
                                              alignItems: 'center', 
                                              gap: '0.25rem',
                                              background: '#fee2e2',
                                              color: '#991b1b',
                                              padding: '2px 8px',
                                              borderRadius: '4px',
                                              fontSize: '0.75rem',
                                              fontWeight: '600'
                                            }}>
                                              <FontAwesomeIcon icon={faTimesCircle} />
                                              NE
                                            </span>
                                          )}
                                          {!faktura.vecna_spravnost_potvrzeno && (
                                            <span style={{ color: '#9ca3af', fontSize: '0.875rem' }}>
                                              NeovÄ›Å™eno
                                            </span>
                                          )}
                                        </FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                      {faktura.vecna_spravnost_umisteni_majetku && (
                                        <FakturaTooltipRow>
                                          <FakturaTooltipLabel>UmÃ­stÄ›nÃ­ majetku:</FakturaTooltipLabel>
                                          <FakturaTooltipValue>
                                            {faktura.vecna_spravnost_umisteni_majetku}
                                          </FakturaTooltipValue>
                                        </FakturaTooltipRow>
                                      )}
                                      {faktura.vecna_spravnost_poznamka && (
                                        <FakturaTooltipRow>
                                          <FakturaTooltipLabel>PoznÃ¡mka VS:</FakturaTooltipLabel>
                                          <FakturaTooltipValue>
                                            {faktura.vecna_spravnost_poznamka}
                                          </FakturaTooltipValue>
                                        </FakturaTooltipRow>
                                      )}
                                      <FakturaTooltipRow>
                                        <FakturaTooltipLabel>StÅ™ediska:</FakturaTooltipLabel>
                                        <FakturaTooltipValue title={
                                          (() => {
                                            const strediska = faktura.fa_strediska_kod;
                                            if (!strediska) return '---';
                                            if (Array.isArray(strediska)) {
                                              return strediska
                                                .map(s => typeof s === 'object' ? (s.label || s.nazev || s.value || s.kod || s) : s)
                                                .filter(Boolean)
                                                .join(', ') || '---';
                                            }
                                            if (typeof strediska === 'string') {
                                              return strediska || '---';
                                            }
                                            return '---';
                                          })()
                                        }>
                                          {(() => {
                                            const strediska = faktura.fa_strediska_kod;
                                            if (!strediska) return '---';
                                            if (Array.isArray(strediska)) {
                                              return strediska
                                                .map(s => typeof s === 'object' ? (s.label || s.nazev || s.value || s.kod || s) : s)
                                                .filter(Boolean)
                                                .join(', ') || '---';
                                            }
                                            if (typeof strediska === 'string') {
                                              return strediska || '---';
                                            }
                                            return '---';
                                          })()}
                                        </FakturaTooltipValue>
                                      </FakturaTooltipRow>
                                    </FakturaTooltipBubble>
                                  </FakturaInfoIconWrapper>
                                </div>
                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                  {/* TlaÄÃ­tko pÅ™idat dalÅ¡Ã­ fakturu */}
                                  <button
                                    type="button"
                                    disabled={shouldLockFaktury}
                                    onClick={() => {
                                      // NejdÅ™Ã­v uloÅ¾it aktuÃ¡lnÄ› editovanou fakturu (pokud je editace aktivnÃ­)
                                      if (isEditing) {
                                        handleUpdateFaktura();
                                      }

                                      // VytvoÅ™it novou fakturu BEZ auto-vyplnÄ›nÃ­ ceny (uÅ¾ivatel vyplnÃ­ a ovÄ›Å™Ã­ sÃ¡m)
                                      const dnesniDatum = formatDateForPicker(new Date());

                                      const newFaktura = {
                                        id: `temp-${Date.now()}`,
                                        objednavka_id: (formData.id || savedOrderId),
                                        fa_datum_doruceni: dnesniDatum, // âœ… SprÃ¡vnÃ© pole pro datum
                                        fa_dorucena: 1, // âœ… Boolean flag
                                        fa_castka: '', // âŒ NEBUDEME auto-vyplÅˆovat - uÅ¾ivatel ovÄ›Å™Ã­ sÃ¡m
                                        fa_cislo_vema: '',
                                        fa_strediska_kod: Array.isArray(formData.strediska_kod) ? formData.strediska_kod : [],
                                        fa_poznamka: '',
                                        fa_splatnost: '',
                                        vytvoril_uzivatel_id: user_id,
                                        vytvoril_jmeno: getUserNameById(user_id),
                                        dt_vytvoreni: new Date().toISOString(),
                                        dt_aktualizace: null,
                                        aktivni: 1,
                                        _isNew: true,
                                        // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
                                        vecna_spravnost_umisteni_majetku: '',
                                        vecna_spravnost_poznamka: '',
                                        vecna_spravnost_potvrzeno: 0
                                      };

                                      const currentFaktury = Array.isArray(formData.faktury) ? formData.faktury : [];
                                      updateFaktury([...currentFaktury, newFaktura]);
                                      setEditingFaktura(newFaktura);
                                      setFakturaFormData({
                                        fa_datum_doruceni: dnesniDatum, // âœ… SprÃ¡vnÃ© pole pro datum
                                        fa_dorucena: 1, // âœ… Boolean flag
                                        fa_castka: '', // âŒ NEBUDEME auto-vyplÅˆovat - uÅ¾ivatel ovÄ›Å™Ã­ sÃ¡m
                                        fa_cislo_vema: '',
                                        fa_strediska_kod: formData.strediska_kod || [],
                                        fa_poznamka: '',
                                        fa_splatnost: '',
                                        // âœ… NOVÃ‰: Per-invoice vÄ›cnÃ¡ sprÃ¡vnost
                                        vecna_spravnost_umisteni_majetku: '',
                                        vecna_spravnost_poznamka: '',
                                        vecna_spravnost_potvrzeno: 0
                                      });
                                    }}
                                    title="PÅ™idat dalÅ¡Ã­ fakturu"
                                    style={{
                                      background: shouldLockFaktury ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.2)',
                                      color: 'white',
                                      border: '1px solid rgba(255,255,255,0.5)',
                                      borderRadius: '6px',
                                      padding: '0.4rem',
                                      fontSize: '0.875rem',
                                      fontWeight: '500',
                                      cursor: shouldLockFaktury ? 'not-allowed' : 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      width: '32px',
                                      height: '32px',
                                      opacity: shouldLockFaktury ? 0.6 : 1,
                                      transition: 'all 0.2s ease'
                                    }}
                                  >
                                    <Plus size={16} />
                                  </button>

                                  {/* TlaÄÃ­tko smazat fakturu - umoÅ¾nit smazÃ¡nÃ­ i jednÃ© faktury */}
                                  <button
                                    type="button"
                                    disabled={shouldLockFaktury}
                                    onClick={() => {
                                      if (faktura._isNew) {
                                        // Pokud je novÃ¡ (neuloÅ¾enÃ¡), jen odebrat ze seznamu
                                        const currentFaktury = Array.isArray(formData.faktury) ? formData.faktury : [];
                                        updateFaktury(currentFaktury.filter(f => f.id !== faktura.id));
                                        if (isEditing) {
                                          setEditingFaktura(null);
                                          const predpokladanaCastka = totalPrice.toString();
                                          const dnesniDatum = formatDateForPicker(new Date());

                                          setFakturaFormData({
                                            fa_datum_doruceni: dnesniDatum,
    fa_dorucena: 1, // âœ… Boolean flag
                                            fa_castka: predpokladanaCastka,
                                            fa_cislo_vema: '',
                                            fa_strediska_kod: formData.strediska_kod || [],
                                            fa_poznamka: '',
                                            fa_splatnost: ''
                                          });
                                        }
                                      } else {
                                        // Pokud je uloÅ¾enÃ¡, smazat pÅ™es API
                                        handleDeleteFaktura(faktura.id);
                                      }
                                    }}
                                    title="Smazat fakturu"
                                    style={{
                                      background: shouldLockFaktury ? 'rgba(255,255,255,0.3)' : 'rgba(220, 38, 38, 0.9)',
                                      color: 'white',
                                      border: '1px solid rgba(255,255,255,0.5)',
                                      borderRadius: '6px',
                                      padding: '0.4rem',
                                      cursor: shouldLockFaktury ? 'not-allowed' : 'pointer',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      width: '32px',
                                      height: '32px',
                                      opacity: shouldLockFaktury ? 0.6 : 1,
                                      transition: 'all 0.2s ease'
                                    }}
                                  >
                                    <Trash size={16} />
                                  </button>
                                </div>
                              </div>

                              {/* Content wrapper pro fakturu */}
                              <div style={{ padding: '1.25rem' }}>

                              {/* INLINE EDITOVATELNÃ POLE - 3 sloupce: datum fixnÃ­, zbytek proporcionÃ¡lnÄ› */}
                              <FormRow style={{gridTemplateColumns: '280px 1fr 1fr'}}>
                                <FormGroup>
                                  <Label required>Datum doruÄenÃ­</Label>
                                  <DatePicker
                                    fieldName="fa_datum_doruceni"
                                    value={isEditing ? currentData.fa_datum_doruceni : (faktura.fa_datum_doruceni || formatDateForPicker(new Date()))}
                                    hasError={!!validationErrors[`faktura_${index + 1}_datum_doruceni`]}
                                    disabled={shouldLockFaktury}
                                    onChange={(value) => {
                                      if (!isEditing) {
                                        handleEditFaktura(faktura);
                                      }
                                      setFakturaFormData(prev => ({
                                        ...prev,
                                        fa_datum_doruceni: value
                                      }));

                                      // ðŸ”¥ OKAMÅ½ITÃ AKTUALIZACE - zachovat vÅ¡echna existujÃ­cÃ­ data
                                      const updatedFaktury = formData.faktury.map(f =>
                                        f.id === faktura.id
                                          ? {
                                              ...f,
                                              fa_datum_doruceni: value,
                                              fa_dorucena: 1,
                                              // Zachovat aktuÃ¡lnÃ­ hodnoty z fakturaFormData pokud je editace aktivnÃ­
                                              ...(isEditing ? {
                                                fa_cislo_vema: fakturaFormData.fa_cislo_vema || f.fa_cislo_vema,
                                                fa_castka: fakturaFormData.fa_castka || f.fa_castka,
                                                fa_splatnost: fakturaFormData.fa_splatnost || f.fa_splatnost,
                                                fa_strediska_kod: fakturaFormData.fa_strediska_kod || f.fa_strediska_kod,
                                                fa_poznamka: fakturaFormData.fa_poznamka || f.fa_poznamka
                                              } : {})
                                            }
                                          : f
                                      );
                                      updateFaktury(updatedFaktury);
                                    }}
                                    onBlur={() => {
                                      if (isEditing && !faktura._isNew) {
                                        handleUpdateFaktura();
                                      }
                                    }}
                                    placeholder="Vyberte datum doruÄenÃ­"
                                  />
                                </FormGroup>

                                <FormGroup>
                                  <Label required>VariabilnÃ­ symbol</Label>
                                  <InputWithIcon hasIcon>
                                    <FontAwesomeIcon icon={faHashtag} />
                                    <Input
                                      type="text"
                                      value={isEditing ? currentData.fa_cislo_vema : (faktura.fa_cislo_vema || '')}
                                      hasError={!!validationErrors[`faktura_${index + 1}_cislo`]}
                                      disabled={shouldLockFaktury}
                                      onChange={(e) => {
                                        if (!isEditing) {
                                          handleEditFaktura(faktura);
                                        }
                                        setFakturaFormData(prev => ({
                                          ...prev,
                                          fa_cislo_vema: e.target.value
                                        }));

                                        // ðŸ”¥ OKAMÅ½ITÃ AKTUALIZACE - zachovat vÅ¡echna existujÃ­cÃ­ data
                                        const updatedFaktury = formData.faktury.map(f =>
                                          f.id === faktura.id
                                            ? {
                                                ...f,
                                                fa_cislo_vema: e.target.value,
                                                // Zachovat aktuÃ¡lnÃ­ hodnoty z fakturaFormData pokud je editace aktivnÃ­
                                                ...(isEditing ? {
                                                  fa_datum_doruceni: fakturaFormData.fa_datum_doruceni || f.fa_datum_doruceni,
                                                  fa_dorucena: fakturaFormData.fa_dorucena || f.fa_dorucena,
                                                  fa_castka: fakturaFormData.fa_castka || f.fa_castka,
                                                  fa_splatnost: fakturaFormData.fa_splatnost || f.fa_splatnost,
                                                  fa_strediska_kod: fakturaFormData.fa_strediska_kod || f.fa_strediska_kod,
                                                  fa_poznamka: fakturaFormData.fa_poznamka || f.fa_poznamka
                                                } : {})
                                              }
                                            : f
                                        );
                                        updateFaktury(updatedFaktury);
                                      }}
                                      onBlur={() => {
                                        if (isEditing && !faktura._isNew) {
                                          handleUpdateFaktura();
                                        }
                                      }}
                                      required
                                      placeholder="12345678"
                                      hasIcon
                                    />
                                  </InputWithIcon>
                                </FormGroup>

                                <FormGroup>
                                  <Label required>ÄŒÃ¡stka vÄ. DPH</Label>
                                  <CurrencyInput
                                    fieldName="fa_castka"
                                    value={isEditing ? (currentData.fa_castka ?? '') : (faktura.fa_castka ?? '')}
                                    hasError={!!validationErrors[`faktura_${index + 1}_castka`]}
                                    disabled={shouldLockFaktury}
                                    onChange={(field, value) => {
                                      if (!isEditing) {
                                        handleEditFaktura(faktura);
                                      }
                                      setFakturaFormData(prev => ({
                                        ...prev,
                                        fa_castka: value
                                      }));

                                      // ðŸ”¥ OKAMÅ½ITÃ AKTUALIZACE - zachovat vÅ¡echna existujÃ­cÃ­ data
                                      const updatedFaktury = formData.faktury.map(f =>
                                        f.id === faktura.id
                                          ? {
                                              ...f,
                                              fa_castka: value,
                                              // Zachovat aktuÃ¡lnÃ­ hodnoty z fakturaFormData pokud je editace aktivnÃ­
                                              ...(isEditing ? {
                                                fa_datum_doruceni: fakturaFormData.fa_datum_doruceni || f.fa_datum_doruceni,
                                                fa_dorucena: fakturaFormData.fa_dorucena || f.fa_dorucena,
                                                fa_cislo_vema: fakturaFormData.fa_cislo_vema || f.fa_cislo_vema,
                                                fa_splatnost: fakturaFormData.fa_splatnost || f.fa_splatnost,
                                                fa_strediska_kod: fakturaFormData.fa_strediska_kod || f.fa_strediska_kod,
                                                fa_poznamka: fakturaFormData.fa_poznamka || f.fa_poznamka
                                              } : {})
                                            }
                                          : f
                                      );
                                      updateFaktury(updatedFaktury);
                                    }}
                                    onBlur={() => {
                                      if (isEditing && !faktura._isNew) {
                                        handleUpdateFaktura();
                                      }
                                    }}
                                    placeholder="25000.50"
                                  />
                                </FormGroup>
                              </FormRow>

                              <FormRow style={{gridTemplateColumns: '280px 1fr'}}>
                                <FormGroup>
                                  <Label required>Datum splatnosti</Label>
                                  <DatePicker
                                    fieldName="fa_splatnost"
                                    value={isEditing ? currentData.fa_splatnost : (() => {
                                      // ðŸ”§ Priorita: fa_splatnost (FE formÃ¡t) > fa_datum_splatnosti (DB formÃ¡t)
                                      if (faktura.fa_splatnost) return faktura.fa_splatnost;
                                      if (faktura.fa_datum_splatnosti) {
                                        // OÅ™ezat Äas, vzÃ­t jen datum
                                        return faktura.fa_datum_splatnosti.split(' ')[0];
                                      }
                                      return '';
                                    })()}
                                    hasError={!!validationErrors[`faktura_${index + 1}_splatnost`]}
                                    disabled={shouldLockFaktury}
                                    onChange={(value) => {
                                      if (!isEditing) {
                                        handleEditFaktura(faktura);
                                      }
                                      setFakturaFormData(prev => ({
                                        ...prev,
                                        fa_splatnost: value
                                      }));

                                      // ðŸ”¥ OKAMÅ½ITÃ AKTUALIZACE - zachovat vÅ¡echna existujÃ­cÃ­ data
                                      const updatedFaktury = formData.faktury.map(f =>
                                        f.id === faktura.id
                                          ? {
                                              ...f,
                                              fa_splatnost: value,
                                              // Zachovat aktuÃ¡lnÃ­ hodnoty z fakturaFormData pokud je editace aktivnÃ­
                                              ...(isEditing ? {
                                                fa_datum_doruceni: fakturaFormData.fa_datum_doruceni || f.fa_datum_doruceni,
                                                fa_dorucena: fakturaFormData.fa_dorucena || f.fa_dorucena,
                                                fa_cislo_vema: fakturaFormData.fa_cislo_vema || f.fa_cislo_vema,
                                                fa_castka: fakturaFormData.fa_castka || f.fa_castka,
                                                fa_strediska_kod: fakturaFormData.fa_strediska_kod || f.fa_strediska_kod,
                                                fa_poznamka: fakturaFormData.fa_poznamka || f.fa_poznamka
                                              } : {})
                                            }
                                          : f
                                      );
                                      updateFaktury(updatedFaktury);
                                    }}
                                    onBlur={() => {
                                      if (isEditing && !faktura._isNew) {
                                        handleUpdateFaktura();
                                      }
                                    }}
                                    placeholder="Vyberte datum splatnosti"
                                  />
                                </FormGroup>

                                <FormGroup data-custom-select style={{gridColumn: '2 / -1'}}>
                                  <Label>StÅ™ediska</Label>
                                  <StableCustomSelect
                                    value={(() => {
                                      // ðŸ”§ NORMALIZE: Parse string â†’ array pokud je potÅ™eba
                                      const rawValue = isEditing
                                        ? (currentData.fa_strediska_kod || formData.strediska_kod || [])
                                        : (faktura.fa_strediska_kod || formData.strediska_kod || []);

                                      // Pokud je string (napÅ™. "STR01,STR02"), parsuj na array
                                      if (typeof rawValue === 'string' && rawValue.trim()) {
                                        return rawValue.split(',').map(s => s.trim()).filter(Boolean);
                                      }

                                      // Pokud uÅ¾ je array, vraÅ¥ ho
                                      return Array.isArray(rawValue) ? rawValue : [];
                                    })()}
                                    disabled={shouldLockFaktury}
                                    isClearable={true}
                                    onChange={(selectedValues) => {
                                      if (!isEditing) {
                                        handleEditFaktura(faktura);
                                      }

                                      // âœ… EXTRAHOVAT JEN STRINGY (kÃ³dy) z objektÅ¯/stringÅ¯
                                      const strediskaKody = Array.isArray(selectedValues)
                                        ? selectedValues.map(item => {
                                            if (typeof item === 'string') return item; // UÅ¾ je string
                                            return item.value || item.kod_stavu || item.id || item; // Extrahuj z objektu
                                          })
                                        : [];

                                      setFakturaFormData(prev => ({
                                        ...prev,
                                        fa_strediska_kod: strediskaKody
                                      }));

                                      // ðŸ”¥ OKAMÅ½ITÃ AKTUALIZACE - zachovat vÅ¡echna existujÃ­cÃ­ data
                                      const updatedFaktury = formData.faktury.map(f =>
                                        f.id === faktura.id
                                          ? {
                                              ...f,
                                              fa_strediska_kod: strediskaKody,
                                              // Zachovat aktuÃ¡lnÃ­ hodnoty z fakturaFormData pokud je editace aktivnÃ­
                                              ...(isEditing ? {
                                                fa_datum_doruceni: fakturaFormData.fa_datum_doruceni || f.fa_datum_doruceni,
                                                fa_dorucena: fakturaFormData.fa_dorucena || f.fa_dorucena,
                                                fa_cislo_vema: fakturaFormData.fa_cislo_vema || f.fa_cislo_vema,
                                                fa_castka: fakturaFormData.fa_castka || f.fa_castka,
                                                fa_splatnost: fakturaFormData.fa_splatnost || f.fa_splatnost,
                                                fa_poznamka: fakturaFormData.fa_poznamka || f.fa_poznamka
                                              } : {})
                                            }
                                          : f
                                      );
                                      updateFaktury(updatedFaktury);
                                    }}
                                    options={strediskaOptions}
                                    placeholder="Vyberte stÅ™ediska (auto-vyplnÄ›no z objednÃ¡vky)"
                                    field="strediska"
                                    required={false}
                                    multiple={true}
                                    icon={<Building />}
                                    getOptionLabel={getOptionLabel}
                                    getOptionValue={(option, field) => option.value || option.id || option}
                                  />
                                </FormGroup>
                              </FormRow>

                              <FormRow>
                                <FormGroup style={{gridColumn: '1 / -1'}}>
                                  <Label>PoznÃ¡mka</Label>
                                  <TextArea
                                    value={isEditing ? currentData.fa_poznamka : (faktura.fa_poznamka || '')}
                                    disabled={shouldLockFaktury}
                                    onChange={(e) => {
                                      if (!isEditing) {
                                        handleEditFaktura(faktura);
                                      }
                                      setFakturaFormData(prev => ({
                                        ...prev,
                                        fa_poznamka: e.target.value
                                      }));

                                      // ðŸ”¥ OKAMÅ½ITÃ AKTUALIZACE - zachovat vÅ¡echna existujÃ­cÃ­ data
                                      const updatedFaktury = formData.faktury.map(f =>
                                        f.id === faktura.id
                                          ? {
                                              ...f,
                                              fa_poznamka: e.target.value,
                                              // Zachovat aktuÃ¡lnÃ­ hodnoty z fakturaFormData pokud je editace aktivnÃ­
                                              ...(isEditing ? {
                                                fa_datum_doruceni: fakturaFormData.fa_datum_doruceni || f.fa_datum_doruceni,
                                                fa_dorucena: fakturaFormData.fa_dorucena || f.fa_dorucena,
                                                fa_cislo_vema: fakturaFormData.fa_cislo_vema || f.fa_cislo_vema,
                                                fa_castka: fakturaFormData.fa_castka || f.fa_castka,
                                                fa_splatnost: fakturaFormData.fa_splatnost || f.fa_splatnost,
                                                fa_strediska_kod: fakturaFormData.fa_strediska_kod || f.fa_strediska_kod
                                              } : {})
                                            }
                                          : f
                                      );
                                      updateFaktury(updatedFaktury);
                                    }}
                                    onBlur={() => {
                                      if (isEditing && !faktura._isNew) {
                                        handleUpdateFaktura();
                                      }
                                    }}
                                    placeholder="VolitelnÃ¡ poznÃ¡mka..."
                                    rows={2}
                                  />
                                </FormGroup>
                              </FormRow>

                              {/* âœ… NOVÃ‰: Per-invoice VÄšCNÃ SPRÃVNOST (FÃZE 7/8) */}
                              {currentPhase >= 7 && (
                                <div style={{
                                  marginTop: '1.5rem',
                                  padding: '1rem',
                                  background: isVecnaPotvrzena 
                                    ? 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)' 
                                    : 'linear-gradient(135deg, #fefefe 0%, #f3f4f6 100%)',
                                  border: isVecnaPotvrzena ? '2px solid #22c55e' : '2px solid #d1d5db',
                                  borderRadius: '8px'
                                }}>
                                  <div style={{ 
                                    fontWeight: '700', 
                                    fontSize: '0.95rem', 
                                    color: '#166534', 
                                    marginBottom: '1rem',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem'
                                  }}>
                                    <FontAwesomeIcon icon={faCheckCircle} />
                                    VÄ›cnÃ¡ sprÃ¡vnost faktury #{index + 1}
                                  </div>

                                  {/* PorovnÃ¡nÃ­ MAX CENA vs FAKTURA */}
                                  {(() => {
                                    const maxCena = parseFloat(formData.max_cena_s_dph) || 0;
                                    const fakturaCastka = parseFloat(faktura.fa_castka) || 0;
                                    const rozdil = fakturaCastka - maxCena;
                                    const prekroceno = rozdil > 0;

                                    return (
                                      <div style={{
                                        background: prekroceno ? '#fef2f2' : '#f0fdf4',
                                        border: `1px solid ${prekroceno ? '#ef4444' : '#22c55e'}`,
                                        borderRadius: '6px',
                                        padding: '0.75rem',
                                        marginBottom: '1rem',
                                        fontSize: '0.85rem'
                                      }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                          <span style={{ color: '#6b7280' }}>Max. cena objednÃ¡vky s DPH:</span>
                                          <span style={{ fontWeight: '600', color: '#374151' }}>
                                            {maxCena.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ
                                          </span>
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                          <span style={{ color: '#6b7280' }}>ÄŒÃ¡stka faktury s DPH:</span>
                                          <span style={{ fontWeight: '600', color: '#374151' }}>
                                            {fakturaCastka.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ
                                          </span>
                                        </div>
                                        <div style={{ 
                                          display: 'flex', 
                                          justifyContent: 'space-between', 
                                          paddingTop: '0.5rem', 
                                          borderTop: '1px solid #e5e7eb',
                                          fontWeight: '700'
                                        }}>
                                          <span style={{ color: prekroceno ? '#dc2626' : '#16a34a' }}>
                                            {prekroceno ? 'âš ï¸ PÅ™ekroÄenÃ­:' : 'âœ… RozdÃ­l:'}
                                          </span>
                                          <span style={{ color: prekroceno ? '#dc2626' : '#16a34a' }}>
                                            {prekroceno ? '+' : ''}{rozdil.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ
                                          </span>
                                        </div>
                                      </div>
                                    );
                                  })()}

                                  <FormRow>
                                    <FormGroup style={{gridColumn: '1 / -1'}}>
                                      <Label>UmÃ­stÄ›nÃ­ majetku</Label>
                                      <Input
                                        value={isEditing ? (currentData.vecna_spravnost_umisteni_majetku || '') : (faktura.vecna_spravnost_umisteni_majetku || '')}
                                        disabled={shouldLockVecnaSpravnost}
                                        onChange={(e) => {
                                          if (!isEditing) {
                                            handleEditFaktura(faktura);
                                          }
                                          setFakturaFormData(prev => ({
                                            ...prev,
                                            vecna_spravnost_umisteni_majetku: e.target.value
                                          }));

                                          // OkamÅ¾itÃ¡ aktualizace
                                          const updatedFaktury = formData.faktury.map(f =>
                                            f.id === faktura.id
                                              ? { ...f, vecna_spravnost_umisteni_majetku: e.target.value }
                                              : f
                                          );
                                          updateFaktury(updatedFaktury);
                                        }}
                                        placeholder="NapÅ™. Kladno, budova K2, mÃ­stnost 203"
                                      />
                                    </FormGroup>

                                    <FormGroup style={{gridColumn: '1 / -1'}}>
                                      {(() => {
                                        const maxCena = parseFloat(formData.max_cena_s_dph) || 0;
                                        const fakturaCastka = parseFloat(faktura.fa_castka) || 0;
                                        const prekroceno = fakturaCastka > maxCena;
                                        return <Label required={prekroceno} style={prekroceno ? {color: '#dc2626', fontWeight: '700'} : {}}>PoznÃ¡mka k vÄ›cnÃ© sprÃ¡vnosti{prekroceno ? ' (POVINNÃ - faktura pÅ™ekraÄuje MAX cenu)' : ''}</Label>;
                                      })()}
                                      <TextArea
                                        value={isEditing ? (currentData.vecna_spravnost_poznamka || '') : (faktura.vecna_spravnost_poznamka || '')}
                                        disabled={shouldLockVecnaSpravnost}
                                        hasError={!!validationErrors[`faktura_${index + 1}_poznamka_vs`]}
                                        onChange={(e) => {
                                          if (!isEditing) {
                                            handleEditFaktura(faktura);
                                          }
                                          setFakturaFormData(prev => ({
                                            ...prev,
                                            vecna_spravnost_poznamka: e.target.value
                                          }));

                                          // OkamÅ¾itÃ¡ aktualizace
                                          const updatedFaktury = formData.faktury.map(f =>
                                            f.id === faktura.id
                                              ? { ...f, vecna_spravnost_poznamka: e.target.value }
                                              : f
                                          );
                                          updateFaktury(updatedFaktury);
                                        }}
                                        placeholder="VolitelnÃ¡ poznÃ¡mka k vÄ›cnÃ© sprÃ¡vnosti..."
                                        rows={2}
                                      />
                                      {validationErrors[`faktura_${index + 1}_poznamka_vs`] && (
                                        <ErrorText>{validationErrors[`faktura_${index + 1}_poznamka_vs`]}</ErrorText>
                                      )}
                                    </FormGroup>
                                  </FormRow>

                                  {/* Checkbox potvrzenÃ­ vÄ›cnÃ© sprÃ¡vnosti */}
                                  {(() => {
                                    const hasError = !!validationErrors[`faktura_${index + 1}_vecna_spravnost`];
                                    return (
                                      <>
                                        <div style={{
                                          marginTop: '1rem',
                                          padding: '0.75rem',
                                          background: hasError ? '#fef2f2' : '#ffffff',
                                          border: hasError ? '2px solid #ef4444' : '1px solid #d1d5db',
                                          borderRadius: '6px'
                                        }}>
                                          <label style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.75rem',
                                            cursor: shouldLockVecnaSpravnost ? 'not-allowed' : 'pointer',
                                            fontSize: '0.9rem',
                                            fontWeight: shouldLockVecnaSpravnost ? '400' : '600',
                                            color: hasError ? '#dc2626' : (shouldLockVecnaSpravnost ? '#9ca3af' : '#374151')
                                          }}>
                                            <input
                                              type="checkbox"
                                              checked={isEditing ? (currentData.vecna_spravnost_potvrzeno === 1) : (faktura.vecna_spravnost_potvrzeno === 1)}
                                              disabled={shouldLockVecnaSpravnost}
                                        onChange={(e) => {
                                          const newValue = e.target.checked ? 1 : 0;
                                          
                                          if (!isEditing) {
                                            handleEditFaktura(faktura);
                                          }

                                          // ðŸ†• PÅ™i zaÅ¡krtnutÃ­ nastavit ID uÅ¾ivatele a timestamp
                                          let updatedFields = { vecna_spravnost_potvrzeno: newValue };
                                          if (newValue === 1 && user_id && !faktura.potvrdil_vecnou_spravnost_id) {
                                            const now = new Date();
                                            const year = now.getFullYear();
                                            const month = String(now.getMonth() + 1).padStart(2, '0');
                                            const day = String(now.getDate()).padStart(2, '0');
                                            const hours = String(now.getHours()).padStart(2, '0');
                                            const minutes = String(now.getMinutes()).padStart(2, '0');
                                            const seconds = String(now.getSeconds()).padStart(2, '0');
                                            const localTimestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                                            
                                            updatedFields.potvrdil_vecnou_spravnost_id = user_id;
                                            updatedFields.dt_potvrzeni_vecne_spravnosti = localTimestamp;
                                            addDebugLog('info', 'VECNA-FAKTURA', 'metadata-set', `Faktura #${faktura.id}: Nastaveno ID=${user_id}, dt=${localTimestamp}`);
                                          }

                                          setFakturaFormData(prev => ({
                                            ...prev,
                                            ...updatedFields
                                          }));

                                          // OkamÅ¾itÃ¡ aktualizace
                                          const updatedFaktury = formData.faktury.map(f =>
                                            f.id === faktura.id
                                              ? { ...f, ...updatedFields }
                                              : f
                                          );
                                          updateFaktury(updatedFaktury);
                                        }}
                                        style={{
                                          width: '18px',
                                          height: '18px',
                                          cursor: shouldLockVecnaSpravnost ? 'not-allowed' : 'pointer',
                                          accentColor: shouldLockVecnaSpravnost ? '#9ca3af' : '#16a34a'
                                        }}
                                      />
                                      <span style={{ flex: 1 }}>
                                        Potvrzuji vÄ›cnou sprÃ¡vnost faktury #{index + 1}
                                      </span>
                                      {((isEditing ? (currentData.vecna_spravnost_potvrzeno === 1) : (faktura.vecna_spravnost_potvrzeno === 1))) && (
                                        <span style={{
                                          fontSize: '0.75rem',
                                          color: '#16a34a',
                                          background: '#dcfce7',
                                          padding: '0.25rem 0.5rem',
                                          borderRadius: '4px',
                                          fontWeight: '600'
                                        }}>
                                          âœ“ ZKONTROLOVÃNO
                                        </span>
                                      )}
                                    </label>
                                    
                                    {/* Info Å™Ã¡dek - kdo a kdy potvrdil (POUZE ve fÃ¡zi ZKONTROLOVANA 8+) */}
                                    {(() => {
                                      const isChecked = (isEditing ? (currentData.vecna_spravnost_potvrzeno === 1) : (faktura.vecna_spravnost_potvrzeno === 1));
                                      const hasRealId = faktura.id && !String(faktura.id).startsWith('temp-');
                                      const hasTimestamp = faktura.dt_potvrzeni_vecne_spravnosti;
                                      const isZkontrolovanaPhase = currentPhase >= 8; // FÃ¡ze ZKONTROLOVANA a vÃ½Å¡e
                                      
                                      if (!isChecked || !hasRealId || !hasTimestamp || !isZkontrolovanaPhase) return null;
                                      
                                      // UrÄit jmÃ©no potvrzujÃ­cÃ­ho
                                      const userName = faktura.potvrdil_vecnou_spravnost_jmeno 
                                        ? `${faktura.potvrdil_vecnou_spravnost_jmeno} ${faktura.potvrdil_vecnou_spravnost_prijmeni || ''}`.trim()
                                        : (faktura.potvrdil_vecnou_spravnost_id ? getUserNameById(faktura.potvrdil_vecnou_spravnost_id) : null);
                                      
                                      return (
                                        <div style={{
                                          marginTop: '0.5rem',
                                          padding: '0.5rem 0.75rem',
                                          background: '#f0fdf4',
                                          border: '1px solid #86efac',
                                          borderRadius: '4px',
                                          fontSize: '0.8rem',
                                          color: '#15803d'
                                        }}>
                                          <strong>Potvrdil:</strong> {userName || 'SystÃ©m'}
                                          {' '}<strong>â€¢</strong>{' '}
                                          <strong>Datum:</strong> {prettyDate(faktura.dt_potvrzeni_vecne_spravnosti)}
                                        </div>
                                      );
                                    })()}
                                  </div>
                                  {hasError && (
                                    <ErrorText style={{ marginTop: '0.5rem' }}>
                                      {validationErrors[`faktura_${index + 1}_vecna_spravnost`]}
                                    </ErrorText>
                                  )}
                                </>
                                    );
                                  })()}
                                </div>
                              )}

                              {/* ðŸ“Ž PÅ˜ÃLOHY FAKTURY - KompaktnÃ­ komponenta s API validacÃ­ */}
                              <InvoiceAttachmentsCompact
                                key={`invoice-attachments-${index}-${formData.id}`}
                                fakturaId={faktura.id}
                                objednavkaId={formData.id}
                                fakturaTypyPrilohOptions={fakturaTypyPrilohOptions}
                                readOnly={shouldLockFaktury}
                                onISDOCParsed={handleISDOCParsed}
                                formData={formData}
                                faktura={faktura}
                                validateInvoiceForAttachments={validateInvoiceForAttachments}
                                attachments={faktura.attachments || []}
                                onAttachmentsChange={(newAttachments) => {
                                  handleInvoiceAttachmentsChange(faktura.id, newAttachments);
                                }}
                                onAttachmentUploaded={(uploadedAttachment) => {
                                  // ðŸ’¾ Po uploadu pÅ™Ã­lohy
                                  handleInvoiceAttachmentUploaded(faktura.id, uploadedAttachment);
                                }}
                                onCreateInvoiceInDB={handleCreateInvoiceInDB}
                              />

                              {/* Faktury se uklÃ¡dajÃ­ automaticky s objednÃ¡vkou - tlaÄÃ­tko "UloÅ¾it fakturu" odstranÄ›no */}

                              {/* Info footer */}
                              {!faktura._isNew && (
                                <div style={{
                                  borderTop: '1px solid #e5e7eb',
                                  paddingTop: '0.5rem',
                                  marginTop: '0.75rem',
                                  fontSize: '0.75rem',
                                  color: '#9ca3af',
                                  display: 'flex',
                                  justifyContent: 'space-between'
                                }}>
                                  <div>
                                    <strong>VytvoÅ™il:</strong> {faktura.vytvoril_jmeno || getUserNameById(faktura.vytvoril_uzivatel_id)}
                                  </div>
                                  <div>
                                    <strong>VytvoÅ™eno:</strong> {prettyDate(faktura.dt_vytvoreni)}
                                  </div>
                                </div>
                              )}

                              </div>
                              {/* Konec content wrapper */}

                            </div>
                          )}))}
                        </div>
                      )}

                      {/* INFORMAÄŒNÃ BOX - Fakturace zpracovÃ¡na - ZOBRAZIT kdyÅ¾ je pÅ™idÃ¡na faktura */}
                      {formData.faktury && formData.faktury.length > 0 && formData.fakturant_id && formData.dt_faktura_pridana && (
                        <div style={{
                          marginTop: '1.5rem',
                          padding: '1rem',
                          backgroundColor: '#dcfce7',
                          border: '1px solid #16a34a',
                          borderRadius: '6px',
                          color: '#166534',
                          fontSize: '0.875rem'
                        }}>
                          <div style={{ fontWeight: '600', marginBottom: '0.25rem' }}>
                            âœ… Fakturace byla zpracovÃ¡na
                          </div>
                          <div>
                            <strong>Datum zpracovÃ¡nÃ­:</strong> {prettyDate(formData.dt_faktura_pridana)} â€¢ <strong>Zpracoval:</strong> {getUserNameById(formData.fakturant_id)}
                          </div>
                        </div>
                      )}
                      </>
                      )}
                    </div>
                  </SectionContent>
                </FormSection>
              ) : null;
              })()}

              {/* ðŸ“ INFO BOX PRO UÅ½IVATELE BEZ PRÃV INVOICE_MANAGE - ÄekÃ¡ se na doplnÄ›nÃ­ faktur */}
              {(() => {
                const isPokladna = (() => {
                  const selectedFinancovani = financovaniOptions.find(opt =>
                    opt.kod === formData.zpusob_financovani ||
                    opt.value === formData.zpusob_financovani
                  );
                  const nazev = selectedFinancovani?.nazev || '';
                  return nazev.toLowerCase().includes('pokladna');
                })();
                const hasFaktury = formData.faktury && formData.faktury.length > 0;
                const showInfoBlock = !isPokladna && currentPhase === 6 && !canManageInvoices && !hasFaktury;
                return showInfoBlock && (
                  <div style={{
                    margin: '2rem 0',
                    padding: '1rem 1.25rem',
                    backgroundColor: '#fef3c7',
                    border: '1px solid #f59e0b',
                    borderRadius: '8px',
                    color: '#92400e'
                  }}>
                    <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      â³ ÄŒekÃ¡ se na doplnÄ›nÃ­ fakturace
                    </div>
                    <div style={{ fontSize: '0.875rem' }}>
                      ObjednÃ¡vka ÄekÃ¡ na pÅ™idÃ¡nÃ­ faktur ekonomickÃ½m oddÄ›lenÃ­m. Po doplnÄ›nÃ­ faktur budete moci pokraÄovat k <strong>vÄ›cnÃ© kontrole</strong>. Tuto akci mÅ¯Å¾e provÃ©st pouze uÅ¾ivatel s oprÃ¡vnÄ›nÃ­m pro sprÃ¡vu faktur.
                    </div>
                  </div>
                );
              })()}

              {/* INFORMAÄŒNÃ BLOK - AKTIVNÃ FAKTURACE: Info o dalÅ¡Ã­m kroku */}
              {(isArchived || currentPhase === 6) && formData.faktury && formData.faktury.length > 0 && (
                <div style={{
                  margin: '2rem 0',
                  padding: '1rem 1.25rem',
                  backgroundColor: '#fefce8',
                  border: '1px solid #eab308',
                  borderRadius: '8px',
                  color: '#854d0e'
                }}>
                  <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    â„¹ï¸ PÅ™idÃ¡nÃ­ faktur k objednÃ¡vce
                  </div>
                  <div style={{ fontSize: '0.875rem' }}>
                    {formData.fakturant_id && formData.dt_faktura_pridana && (
                      <div style={{ marginBottom: '0.5rem' }}>
                        <strong>PÅ™idal fakturu:</strong> {getUserNameById(formData.fakturant_id)}
                        {' â€¢ '}
                        <strong>Datum:</strong> {prettyDate(formData.dt_faktura_pridana)}
                      </div>
                    )}
                    V tÃ©to sekci pÅ™idejte faktury k objednÃ¡vce. Po pÅ™idÃ¡nÃ­ a uloÅ¾enÃ­ mÅ¯Å¾ete pokraÄovat k <strong>vÄ›cnÃ© kontrole</strong>.
                  </div>
                </div>
              )}

              {/* âŒ SEKCE "DODATEÄŒNÃ‰ DOKUMENTY" ODSTRANÄšNA - nahrazena univerzÃ¡lnÃ­ sekcÃ­ "PÅ™Ã­lohy k objednÃ¡vce" */}
              {/* âŒ SEKCE "VÄšCNÃ SPRÃVNOST" ODSTRANÄšNA - refaktorovÃ¡no na per-invoice checkboxy */}

              {/* âœ… TODO: Zde bude novÃ¡ per-invoice vÄ›cnÃ¡ sprÃ¡vnost logika (checkboxy u kaÅ¾dÃ© faktury) */}


              {/* âœ… SEKCE: DOKONÄŒENÃ OBJEDNÃVKY - FÃZE 10 */}
              {/* ZOBRAZIT pouze pokud: */}
              {/* 1. UÅ¾ivatel je ADMIN nebo mÃ¡ prÃ¡vo ORDER_MANAGE NEBO objednÃ¡vka je jiÅ¾ DOKONCENA */}
              {/* 2. Workflow obsahuje ZKONTROLOVANA nebo DOKONCENA (vÄ›cnÃ¡ sprÃ¡vnost potvrzena) */}
              {(canUnlockAnything || hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA')) && 
               (hasWorkflowState(formData.stav_workflow_kod, 'ZKONTROLOVANA') || hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA')) &&
               (() => {
                // ðŸ”’ Logika zamÄenÃ­ sekce dokonÄenÃ­ - STEJNÄš JAKO U VÄšCNÃ‰ SPRÃVNOSTI
                // ZAMÄŒENO pouze pokud:
                // 1. Workflow obsahuje DOKONCENA (ne jen ZKONTROLOVANA!)
                // 2. Checkbox JE ZAÅ KRTNUTÃ (potvrzeni_dokonceni_objednavky = 1)
                // 3. JE ULOÅ½ENO v DB (mÃ¡ formData.id)
                // DÅ®LEÅ½ITÃ‰: dokoncil_id a dt_dokonceni se nastavujÃ­ HNED pÅ™i zaÅ¡krtnutÃ­,
                // takÅ¾e nemÅ¯Å¾eme podle nich zjistit, jestli je uloÅ¾eno v DB!
                const isDokonceniSaved = !!(
                  formData.id &&
                  formData.potvrzeni_dokonceni_objednavky === 1 &&
                  hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA')
                );
                // âœ… PouÅ¾Ã­t dokonceniState z workflowManager (uÅ¾ zahrnuje unlock logic)
                const isDokonceniLockedLocal = !dokonceniState.enabled;

                // Kho mÅ¯Å¾e odemknout? Pouze admin + ORDER_MANAGE
                const canUnlockDokonceni = canUnlockAnything; // Pouze admin/ORDER_MANAGE

                return (
                <FormSection data-section="dokonceni">
                  <SectionHeader
                    sectionTheme="section-dokonceni"
                    isActive={true}
                    style={{
                      background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                      borderColor: '#16a34a'
                    }}
                  >
                    <SectionTitle sectionTheme="section-dokonceni" style={{ color: '#fff', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      <SectionIcon sectionTheme="section-dokonceni" style={{ color: '#fff' }}>
                        <FontAwesomeIcon icon={faCheckCircle} />
                      </SectionIcon>
                      DokonÄenÃ­ objednÃ¡vky
                    </SectionTitle>
                    <SectionControls style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                      <CollapseIcon
                        collapsed={sectionStates.dokonceni}
                        onClick={() => toggleSection('dokonceni')}
                        style={{ color: '#fff', cursor: 'pointer' }}
                      >
                        <FontAwesomeIcon icon={faChevronUp} />
                      </CollapseIcon>
                    </SectionControls>
                  </SectionHeader>

                  <SectionContent collapsed={sectionStates.dokonceni}>
                    <div style={{ padding: '1rem 0' }}>
                      {/* Informace o dokonÄenÃ­ */}
                      <div style={{
                        background: '#f0fdf4',
                        border: '1px solid #22c55e',
                        borderRadius: '8px',
                        padding: '1rem',
                        marginBottom: '1.5rem'
                      }}>
                        <div style={{ fontWeight: '600', color: '#166534', marginBottom: '0.75rem' }}>
                          ðŸŽ‰ FinÃ¡lnÃ­ krok - DokonÄenÃ­ objednÃ¡vky
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#166534', lineHeight: '1.6' }}>
                          ObjednÃ¡vka proÅ¡la vÅ¡emi fÃ¡zemi:
                          <ul style={{ marginTop: '0.5rem', marginLeft: '1.5rem', listStyle: 'none', paddingLeft: 0 }}>
                            <li style={{ display: 'flex', alignItems: 'center', marginBottom: '0.4rem' }}>
                              âœ… SchvÃ¡lenÃ­ ({formData.dt_schvaleni ? prettyDate(formData.dt_schvaleni) : ''} â€¢ {formData.schvalovatel_id ? getUserNameById(formData.schvalovatel_id) : ''})
                            </li>
                            <li style={{ display: 'flex', alignItems: 'center', marginBottom: '0.4rem' }}>
                              âœ… OdeslÃ¡nÃ­ dodavateli ({formData.dt_odeslani ? prettyDate(formData.dt_odeslani) : ''} â€¢ {formData.odesilatel_id ? getUserNameById(formData.odesilatel_id) : ''})
                            </li>
                            <li style={{ display: 'flex', alignItems: 'center', marginBottom: '0.4rem' }}>
                              âœ… PotvrzenÃ­ od dodavatele ({formData.dt_akceptace ? formatDateOnly(formData.dt_akceptace) : ''} â€¢ {formData.dodavatel_potvrdil_id ? getUserNameById(formData.dodavatel_potvrdil_id) : ''})
                            </li>
                            <li style={{ display: 'flex', alignItems: 'center', marginBottom: '0.4rem' }}>
                              âœ… Registr smluv {formData.dt_zverejneni && formData.dt_zverejneni !== '0000-00-00' ? 
                                `(${formatDateOnly(formData.dt_zverejneni)} â€¢ ${formData.zverejnil_id ? getUserNameById(formData.zverejnil_id) : ''})` : 
                                '(nepodlÃ©hÃ¡ zveÅ™ejnÄ›nÃ­ v registru)'}
                            </li>
                            <li style={{ display: 'flex', alignItems: 'center', marginBottom: '0.4rem' }}>
                              âœ… Fakturace ({formData.dt_faktura_pridana ? prettyDate(formData.dt_faktura_pridana) : ''} â€¢ {formData.fakturant_id ? getUserNameById(formData.fakturant_id) : ''})
                            </li>
                            {/* âœ… PER-INVOICE: VÄ›cnÃ¡ sprÃ¡vnost jednotlivÃ½ch faktur */}
                            {formData.faktury && formData.faktury.length > 0 && formData.faktury.map((faktura, index) => {
                              const isPotvrzeno = faktura.vecna_spravnost_potvrzeno === 1;
                              const userName = faktura.potvrdil_vecnou_spravnost_jmeno 
                                ? `${faktura.potvrdil_vecnou_spravnost_jmeno} ${faktura.potvrdil_vecnou_spravnost_prijmeni || ''}`.trim()
                                : (faktura.potvrdil_vecnou_spravnost_id ? getUserNameById(faktura.potvrdil_vecnou_spravnost_id) : '');
                              const datum = faktura.dt_potvrzeni_vecne_spravnosti ? prettyDate(faktura.dt_potvrzeni_vecne_spravnosti) : '';
                              
                              return (
                                <li key={faktura.id || index} style={{ display: 'flex', alignItems: 'center', marginBottom: '0.4rem' }}>
                                  {isPotvrzeno ? 'âœ…' : 'âš ï¸'} VÄ›cnÃ¡ sprÃ¡vnost faktury #{index + 1} {datum ? `(${datum} â€¢ ${userName})` : ''}
                                </li>
                              );
                            })}
                          </ul>
                          <div style={{ marginTop: '0.75rem', fontWeight: '500' }}>
                            NynÃ­ potvrÄte finÃ¡lnÃ­ dokonÄenÃ­ objednÃ¡vky.
                          </div>
                        </div>
                      </div>

                      {/* âš ï¸ KONTROLA PÅ˜EKROÄŒENÃ CENY - zobrazit JEN pokud je fakturace vyÅ¡Å¡Ã­ neÅ¾ MAX cena */}
                      {(() => {
                        const maxCena = parseFloat(formData.max_cena_s_dph) || 0;
                        const fakturyCelkem = formData.faktury ? formData.faktury.reduce((sum, faktura) => {
                          const amount = parseFloat(faktura.fa_castka) || 0;
                          return sum + amount;
                        }, 0) : 0;

                        const rozdil = fakturyCelkem - maxCena;
                        const prekroceno = rozdil > 0;

                        // Zobrazit POUZE pokud je pÅ™ekroÄena MAX cena
                        if (!prekroceno || maxCena === 0 || fakturyCelkem === 0) return null;

                        return (
                          <div style={{
                            background: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                            border: '2px solid #ef4444',
                            borderRadius: '12px',
                            padding: '1rem',
                            marginBottom: '1.5rem',
                            boxShadow: '0 4px 12px rgba(239, 68, 68, 0.15)',
                            display: 'flex',
                            alignItems: 'flex-start',
                            gap: '0.75rem'
                          }}>
                            <div style={{ fontSize: '1.5rem', marginTop: '0.1rem' }}>âš ï¸</div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: '700', fontSize: '1rem', color: '#b91c1c', marginBottom: '0.5rem' }}>
                                POZOR: Fakturace pÅ™ekroÄila MAX cenu s DPH objednÃ¡vky schvÃ¡lenou PO
                              </div>
                              <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'auto auto',
                                gap: '0.5rem 1rem',
                                fontSize: '0.875rem',
                                color: '#7f1d1d',
                                marginBottom: '0.75rem'
                              }}>
                                <span style={{ fontWeight: '600' }}>MAX cena s DPH (schvÃ¡lenÃ¡):</span>
                                <span style={{ fontFamily: 'monospace', fontWeight: '700', textAlign: 'right' }}>{maxCena.toLocaleString('cs-CZ')} KÄ</span>
                                
                                <span style={{ fontWeight: '600' }}>FakturovanÃ¡ ÄÃ¡stka s DPH celkem:</span>
                                <span style={{ fontFamily: 'monospace', fontWeight: '700', textAlign: 'right' }}>{fakturyCelkem.toLocaleString('cs-CZ')} KÄ</span>
                                
                                <span style={{ fontWeight: '600' }}>PÅ™ekroÄenÃ­ o:</span>
                                <span style={{ fontFamily: 'monospace', fontWeight: '700', color: '#dc2626', textAlign: 'right' }}>
                                  +{rozdil.toLocaleString('cs-CZ')} KÄ
                                </span>
                              </div>
                              {formData.vecna_spravnost_poznamka && (
                                <div style={{
                                  borderTop: '1px solid #fca5a5',
                                  paddingTop: '0.75rem',
                                  fontSize: '0.875rem',
                                  color: '#7f1d1d'
                                }}>
                                  <div style={{ lineHeight: '1.5' }}>
                                    <span style={{ fontWeight: '600' }}>VysvÄ›tlenÃ­:</span>
                                    {' '}
                                    <span style={{ fontStyle: 'italic' }}>
                                      "{formData.vecna_spravnost_poznamka}"
                                    </span>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })()}

                      {/* POZNÃMKA K DOKONÄŒENÃ */}
                      <FormRow>
                        <FormGroup style={{ gridColumn: '1 / -1' }}>
                          <Label>POZNÃMKA K DOKONÄŒENÃ (nepovinnÃ©)</Label>
                          <TextArea
                            value={formData.dokonceni_poznamka || ''}
                            onChange={(e) => handleInputChange('dokonceni_poznamka', e.target.value)}
                            placeholder="VolitelnÃ¡ poznÃ¡mka k dokonÄenÃ­ objednÃ¡vky..."
                            rows={3}
                            disabled={isDokonceniLockedLocal}
                            style={{
                              background: isDokonceniLockedLocal ? '#f3f4f6' : undefined,
                              cursor: isDokonceniLockedLocal ? 'not-allowed' : undefined,
                              opacity: isDokonceniLockedLocal ? 0.6 : 1
                            }}
                          />
                        </FormGroup>
                      </FormRow>

                      {/* ANO/NE CHECKBOX - FINÃLNÃ POTVRZENÃ */}
                      <FormRow style={{ marginTop: '1.5rem' }}>
                        <FormGroup style={{ gridColumn: '1 / -1' }}>
                          <div style={{
                            background: isDokonceniLockedLocal ? '#dcfce7' : '#fef3c7',
                            border: `2px solid ${isDokonceniLockedLocal ? '#16a34a' : '#eab308'}`,
                            borderRadius: '8px',
                            padding: '1.25rem',
                            opacity: isDokonceniLockedLocal ? 0.7 : 1
                          }}>
                            <label style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '1rem',
                              cursor: isDokonceniLockedLocal ? 'not-allowed' : 'pointer',
                              fontSize: '1rem',
                              fontWeight: '600',
                              color: formData.dokoncil_id ? '#166534' : '#713f12',
                              opacity: formData.dokoncil_id ? 0.7 : 1
                            }}>
                              <input
                                type="checkbox"
                                checked={
                                  formData.potvrzeni_dokonceni_objednavky === 1 ||
                                  formData.potvrzeni_dokonceni_objednavky === true ||
                                  hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA')
                                }
                                onChange={(e) => {
                                  handleInputChange('potvrzeni_dokonceni_objednavky', e.target.checked ? 1 : 0);
                                }}
                                required
                                disabled={hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA')}
                                style={{
                                  width: '24px',
                                  height: '24px',
                                  cursor: isDokonceniLockedLocal ? 'not-allowed' : 'pointer',
                                  accentColor: '#16a34a'
                                }}
                              />
                              <span>
                                âœ… Potvrzuji finÃ¡lnÃ­ dokonÄenÃ­ objednÃ¡vky
                                <span style={{ color: '#dc2626', marginLeft: '0.25rem' }}>*</span>
                              </span>
                            </label>
                            <div style={{
                              fontSize: '0.875rem',
                              color: isDokonceniLockedLocal ? '#166534' : '#92400e',
                              marginTop: '0.75rem',
                              marginLeft: '2.5rem'
                            }}>
                              {isDokonceniLockedLocal ? (
                                <div>
                                  <div style={{
                                    fontWeight: '600',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem',
                                    marginBottom: '0.5rem'
                                  }}>
                                    <span style={{ fontSize: '1.1rem' }}>ðŸ”’</span>
                                    <strong>ObjednÃ¡vka je dokonÄena a uzamÄena</strong>
                                  </div>
                                  <div style={{ fontSize: '0.8rem', color: '#166534', lineHeight: '1.5' }}>
                                    Workflow je kompletnÄ› uzamÄeno. ZmÄ›ny mÅ¯Å¾e provÃ¡dÄ›t pouze oprÃ¡vnÄ›nÃ½ uÅ¾ivatel.
                                  </div>
                                </div>
                              ) : (
                                'ZaÅ¡krtnutÃ­m potvrdÃ­te dokonÄenÃ­ objednÃ¡vky. CelÃ½ workflow bude uzamÄen.'
                              )}
                            </div>
                          </div>
                        </FormGroup>
                      </FormRow>
                    </div>
                  </SectionContent>
                </FormSection>
                );
              })()}

              {/* ðŸ“ INFO BOX PRO BÄšÅ½NÃ‰ UÅ½IVATELE - ÄekÃ¡ se na vÄ›cnou kontrolu */}
              {(() => {
                // Zobrazit info box pro uÅ¾ivatele BEZ prÃ¡v ke kontrole vÄ›cnÃ© sprÃ¡vnosti
                // âŒ DISABLED: Info block o vÄ›cnÃ© sprÃ¡vnosti - jiÅ¾ nenÃ­ potÅ™eba
                const showInfoBlock = false; // PÅ¯vodnÄ›: currentPhase === 7 && !canUnlockAnything && !formData.potvrdil_vecnou_spravnost_id && !vecnaSpravnostState.visible
                return showInfoBlock && (
                  <div style={{
                    margin: '2rem 0',
                    padding: '1rem 1.25rem',
                    backgroundColor: '#fef3c7',
                    border: '1px solid #f59e0b',
                    borderRadius: '8px',
                    color: '#92400e'
                  }}>
                    <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                      â³ ÄŒekÃ¡ se na vÄ›cnou kontrolu
                    </div>
                    <div style={{ fontSize: '0.875rem' }}>
                      ObjednÃ¡vka ÄekÃ¡ na provedenÃ­ vÄ›cnÃ© kontroly oprÃ¡vnÄ›nÃ½m uÅ¾ivatelem. Po kontrole a potvrzenÃ­ vÄ›cnÃ© sprÃ¡vnosti bude moÅ¾nÃ© pokraÄovat k <strong>dokonÄenÃ­ objednÃ¡vky</strong>.
                    </div>
                  </div>
                );
              })()}

              {/* INFORMAÄŒNÃ BLOK - FÃZE 7: VÄšCNÃ SPRÃVNOST - zobrazÃ­ se pouze kdyÅ¾ workflow obsahuje ZKONTROLOVANA a jeÅ¡tÄ› nenÃ­ potvrzena */}
              {hasWorkflowState(formData.stav_workflow_kod, 'ZKONTROLOVANA') && !formData.potvrdil_vecnou_spravnost_id && (
                <div style={{
                  margin: '2rem 0',
                  padding: '1rem 1.25rem',
                  backgroundColor: '#f0fdfa',
                  border: '1px solid #14b8a6',
                  borderRadius: '8px',
                  color: '#0f766e'
                }}>
                  <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    âœ… FÃZE 7/8: VÄ›cnÃ¡ sprÃ¡vnost - Zkontrolujte a potvrÄte sprÃ¡vnost objednÃ¡vky
                  </div>
                  <div style={{ fontSize: '0.875rem' }}>
                    Zkontrolujte vÄ›cnou sprÃ¡vnost objednÃ¡vky vÄetnÄ› vÅ¡ech faktur a ÃºdajÅ¯. Po kontrole potvrÄte vÄ›cnou sprÃ¡vnost v pÅ™Ã­sluÅ¡nÃ© sekci nÃ­Å¾e.
                    {formData.faktury && formData.faktury.length > 0 && (
                      <div style={{ marginTop: '0.5rem' }}>
                        <strong>Faktury ke kontrole:</strong> {formData.faktury.length}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* INFORMAÄŒNÃ BLOK - FÃZE 8: ÄŒEKÃ NA DOKONÄŒENÃ - pro bÄ›Å¾nÃ© uÅ¾ivatele (bez ORDER_MANAGE) */}
              {!canUnlockAnything && 
               (hasWorkflowState(formData.stav_workflow_kod, 'ZKONTROLOVANA') || hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA')) &&
               formData.potvrdil_vecnou_spravnost_id && 
               !hasWorkflowState(formData.stav_workflow_kod, 'DOKONCENA') && (
                <div style={{
                  margin: '2rem 0',
                  padding: '1.5rem',
                  backgroundColor: '#eff6ff',
                  border: '2px solid #3b82f6',
                  borderRadius: '8px',
                  textAlign: 'center'
                }}>
                  <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>â³</div>
                  <div style={{ fontWeight: '700', color: '#1e40af', marginBottom: '0.75rem', fontSize: '1.1rem' }}>
                    ObjednÃ¡vka ÄekÃ¡ na dokonÄenÃ­
                  </div>
                  <div style={{ fontSize: '0.875rem', color: '#1e40af', lineHeight: '1.6' }}>
                    ObjednÃ¡vka proÅ¡la vÅ¡emi fÃ¡zemi workflow a ÄekÃ¡ na finÃ¡lnÃ­ potvrzenÃ­ dokonÄenÃ­.
                  </div>
                  <div style={{ fontSize: '0.875rem', color: '#1e40af', marginTop: '0.75rem', fontStyle: 'italic' }}>
                    ðŸ’¡ DokonÄenÃ­ objednÃ¡vky provede oprÃ¡vnÄ›nÃ½ uÅ¾ivatel.
                  </div>
                </div>
              )}

              {/* INFORMAÄŒNÃ BLOK - FÃZE 4/8: ÄŒekÃ¡nÃ­ na potvrzenÃ­ dodavatelem */}
              {(isArchived || currentPhase >= 4) && !formData.stav_stornovano && formData.dodavatel_zpusob_potvrzeni?.potvrzeni !== 'ANO' && (
                <div style={{
                  margin: '2rem 0',
                  padding: '1rem 1.25rem',
                  backgroundColor: '#f0fdf4',
                  border: '1px solid #10b981',
                  borderRadius: '8px',
                  color: '#065f46'
                }}>
                  <div style={{ fontWeight: '600', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    ðŸ“‹ ÄŒekÃ¡nÃ­ na potvrzenÃ­ od dodavatele
                  </div>
                  <div style={{ fontSize: '0.875rem' }}>
                    ObjednÃ¡vka byla odeslÃ¡na dodavateli. Po obdrÅ¾enÃ­ potvrzenÃ­ od dodavatele zaÅ¡krtnÄ›te "Dodavatel objednÃ¡vku potvrdil" a vyplÅˆte zpÅ¯sob potvrzenÃ­.
                    {formData.datum_odeslani && (
                      <div style={{ marginTop: '0.5rem' }}>
                        <strong>Datum odeslÃ¡nÃ­:</strong> {(() => {
                          // FormÃ¡tovÃ¡nÃ­ jen data bez Äasu (datum_odeslani je z datepickeru)
                          const dateStr = formData.datum_odeslani.split(' ')[0]; // Odstranit pÅ™Ã­padnÃ½ Äas
                          const [year, month, day] = dateStr.split('-');
                          return `${day}. ${month}. ${year}`;
                        })()}
                        {formData.odesilatel_id && (
                          <>
                            {' â€¢ '}
                            <strong>Odeslal:</strong> {getUserNameById(formData.odesilatel_id)}
                          </>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* SCHOVANÃ‰ SEKCE - PrÅ¯bÄ›h objednÃ¡vky a DodacÃ­ informace natvrdo zakÃ¡zanÃ© */}
              {/*
              <FormSection>
                <SectionHeader
                  sectionTheme={getSectionTheme('prubeh_objednavky')}
                  isActive={isSectionActive('prubeh_objednavky')}
                >
                  <SectionTitle sectionTheme={getSectionTheme('prubeh_objednavky')}>
                    <SectionIcon sectionTheme={getSectionTheme('prubeh_objednavky')}>
                      <FontAwesomeIcon icon={faClipboardCheck} />
                    </SectionIcon>
                    PrÅ¯bÄ›h objednÃ¡vky
                  </SectionTitle>
                  <CollapseIcon
                    collapsed={sectionStates.prubeh_objednavky}
                    sectionTheme={getSectionTheme('prubeh_objednavky')}
                    onClick={() => toggleSection('prubeh_objednavky')}
                    style={{ cursor: 'pointer' }}
                  >
                    <FontAwesomeIcon icon={faChevronUp} />
                  </CollapseIcon>
                </SectionHeader>
                <SectionContent collapsed={sectionStates.prubeh_objednavky}>
                  <FormRow>
                    <FormGroup>
                      <Label>STAV U DODAVATELE</Label>
                      <InputWithIcon hasIcon>
                        <Package />
                        <select
                          name="stav_u_dodavatele"
                          value={formData.stav_u_dodavatele || ''}
                          onChange={(e) => handleInputChange('stav_u_dodavatele', e.target.value)}
                          style={{
                            width: '100%',
                            padding: '0.75rem 3rem 0.75rem 3rem',
                            border: '1px solid #d1d5db',
                            borderRadius: '8px',
                            fontSize: '0.875rem',
                            backgroundColor: 'white'
                          }}
                        >
                          <option value="">Vyberte stav...</option>
                          <option value="potvrzeno">Potvrzeno dodavatelem</option>
                          <option value="ve_vyrobe">Ve vÃ½robÄ›/pÅ™Ã­pravÄ›</option>
                          <option value="pripraveno">PÅ™ipraveno k odeslÃ¡nÃ­</option>
                          <option value="odeslano">OdeslÃ¡no dodavatelem</option>
                          <option value="doruceno">DoruÄeno</option>
                          <option value="stornovÃ¡no">StornovÃ¡no</option>
                        </select>
                      </InputWithIcon>
                    </FormGroup>
                    <FormGroup>
                      <Label>DATUM ZMÄšNY STAVU</Label>
                      <DatePicker
                        fieldName="datum_zmeny_stavu"
                        value={formData.datum_zmeny_stavu || ''}
                        onChange={(value) => handleInputChange('datum_zmeny_stavu', value)}
                        onBlur={(value) => handleFieldBlur('datum_zmeny_stavu', value)}
                        placeholder="Vyberte datum zmÄ›ny stavu"
                      />
                    </FormGroup>
                  </FormRow>
                  <FormRow>
                    <FormGroup style={{gridColumn: '1 / -1'}}>
                      <Label>POZNÃMKA KE STAVU</Label>
                      <TextArea
                        name="poznamka_stav"
                        placeholder="DodateÄnÃ© informace o prÅ¯bÄ›hu objednÃ¡vky..."
                        value={formData.poznamka_stav || ''}
                        onChange={(e) => handleInputChange('poznamka_stav', e.target.value)}
                        onBlur={(e) => handleFieldBlur('poznamka_stav', e.target.value)}
                        rows={3}
                      />
                    </FormGroup>
                  </FormRow>
                </SectionContent>
              </FormSection>

              <FormSection>
                <SectionHeader
                  sectionTheme={getSectionTheme('dodaci_informace')}
                  isActive={isSectionActive('dodaci_informace')}
                >
                  <SectionTitle sectionTheme={getSectionTheme('dodaci_informace')}>
                    <SectionIcon sectionTheme={getSectionTheme('dodaci_informace')}>
                      <Package />
                    </SectionIcon>
                    DodacÃ­ informace
                  </SectionTitle>
                  <CollapseIcon
                    collapsed={sectionStates.dodaci_informace}
                    sectionTheme={getSectionTheme('dodaci_informace')}
                    onClick={() => toggleSection('dodaci_informace')}
                    style={{ cursor: 'pointer' }}
                  >
                    <FontAwesomeIcon icon={faChevronUp} />
                  </CollapseIcon>
                </SectionHeader>
                <SectionContent collapsed={sectionStates.dodaci_informace}>
                  <FormRow>
                    <FormGroup>
                      <Label>ÄŒÃSLO ZÃSILKY</Label>
                      <InputWithIcon hasIcon>
                        <Hash />
                        <Input
                          type="text"
                          name="cislo_zasilky"
                          placeholder="SledovacÃ­ ÄÃ­slo zÃ¡silky"
                          value={formData.cislo_zasilky || ''}
                          onChange={(e) => handleInputChange('cislo_zasilky', e.target.value)}
                          hasIcon
                        />
                      </InputWithIcon>
                    </FormGroup>
                    <FormGroup>
                      <Label>PÅ˜EPRAVCE</Label>
                      <InputWithIcon hasIcon>
                        <Package />
                        <Input
                          type="text"
                          name="prepravce"
                          placeholder="NÃ¡zev pÅ™epravnÃ­ spoleÄnosti"
                          value={formData.prepravce || ''}
                          onChange={(e) => handleInputChange('prepravce', e.target.value)}
                          hasIcon
                        />
                      </InputWithIcon>
                    </FormGroup>
                  </FormRow>
                  <FormRow>
                    <FormGroup>
                      <Label>OÄŒEKÃVANÃ‰ DORUÄŒENÃ</Label>
                      <DatePicker
                        fieldName="ocekavane_doruceni"
                        value={formData.ocekavane_doruceni || ''}
                        onChange={(value) => handleInputChange('ocekavane_doruceni', value)}
                        onBlur={(value) => handleFieldBlur('ocekavane_doruceni', value)}
                        placeholder="Vyberte oÄekÃ¡vanÃ© datum doruÄenÃ­"
                      />
                    </FormGroup>
                    <FormGroup>
                      <Label>SKUTEÄŒNÃ‰ DORUÄŒENÃ</Label>
                      <DatePicker
                        fieldName="skutecne_doruceni"
                        value={formData.skutecne_doruceni || ''}
                        onChange={(value) => handleInputChange('skutecne_doruceni', value)}
                        onBlur={(value) => handleFieldBlur('skutecne_doruceni', value)}
                        placeholder="Vyberte skuteÄnÃ© datum doruÄenÃ­"
                      />
                    </FormGroup>
                  </FormRow>
                </SectionContent>
              </FormSection>
              */}

              {/* SEKCE FAKTURACE DOÄŒASNÄš SKRYTA - BUDE PÅ˜IDÃNA POZDÄšJI */}
              {/* Sekce: Fakturace - zobrazÃ­ se aÅ¾ po potvrzenÃ­ ANO od dodavatele */}
              {false && formData.dodavatel_zpusob_potvrzeni?.potvrzeni === 'ANO' && (
                <FormSection>
                  <SectionHeader
                    sectionTheme={getSectionTheme('fakturace')}
                    isActive={isSectionActive('fakturace')}
                  >
                    <SectionTitle sectionTheme={getSectionTheme('fakturace')}>
                      <SectionIcon sectionTheme={getSectionTheme('fakturace')}>
                        <Calculator />
                      </SectionIcon>
                      Fakturace
                    </SectionTitle>
                    <CollapseIcon
                      collapsed={sectionStates.fakturace}
                      sectionTheme={getSectionTheme('fakturace')}
                      onClick={() => toggleSection('fakturace')}
                      style={{ cursor: 'pointer' }}
                    >
                      <FontAwesomeIcon icon={faChevronUp} />
                    </CollapseIcon>
                  </SectionHeader>
                <SectionContent collapsed={sectionStates.fakturace}>
                  <FormRow>
                    <FormGroup>
                      <Label>ÄŒÃSLO FAKTURY</Label>
                      <InputWithIcon hasIcon>
                        <Hash />
                        <Input
                          type="text"
                          name="cislo_faktury"
                          placeholder="ÄŒÃ­slo pÅ™ijatÃ© faktury"
                          value={formData.cislo_faktury || ''}
                          onChange={(e) => handleInputChange('cislo_faktury', e.target.value)}
                          hasIcon
                        />
                      </InputWithIcon>
                    </FormGroup>
                    <FormGroup>
                      <Label>DATUM FAKTURY</Label>
                      <DatePicker
                        fieldName="datum_faktury"
                        value={formData.datum_faktury || ''}
                        onChange={(value) => handleInputChange('datum_faktury', value)}
                        onBlur={(value) => handleFieldBlur('datum_faktury', value)}
                        placeholder="Vyberte datum faktury"
                      />
                    </FormGroup>
                  </FormRow>
                  <FormRow>
                    <FormGroup>
                      <Label>ÄŒÃSTKA BEZ DPH</Label>
                      <InputWithIcon hasIcon>
                        <Calculator />
                        <Input
                          type="number"
                          step="0.01"
                          name="castka_bez_dph"
                          placeholder="0.00"
                          value={formData.castka_bez_dph || ''}
                          onChange={(e) => handleInputChange('castka_bez_dph', e.target.value)}
                          style={{textAlign: 'right'}}
                          hasIcon
                        />
                      </InputWithIcon>
                    </FormGroup>
                    <FormGroup>
                      <Label>ÄŒÃSTKA S DPH</Label>
                      <InputWithIcon hasIcon>
                        <Calculator />
                        <Input
                          type="number"
                          step="0.01"
                          name="castka_s_dph"
                          placeholder="0.00"
                          value={formData.castka_s_dph || ''}
                          onChange={(e) => handleInputChange('castka_s_dph', e.target.value)}
                          style={{textAlign: 'right'}}
                          hasIcon
                        />
                      </InputWithIcon>
                    </FormGroup>
                  </FormRow>
                  <FormRow>
                    <FormGroup>
                      <Label>DATUM SPLATNOSTI</Label>
                      <DatePicker
                        fieldName="datum_splatnosti"
                        value={formData.datum_splatnosti || ''}
                        onChange={(value) => handleInputChange('datum_splatnosti', value)}
                        onBlur={(value) => handleFieldBlur('datum_splatnosti', value)}
                        placeholder="Vyberte datum splatnosti"
                      />
                    </FormGroup>
                    <FormGroup>
                      <Label>DATUM ZAPLACENÃ</Label>
                      <DatePicker
                        fieldName="datum_zaplaceni"
                        value={formData.datum_zaplaceni || ''}
                        onChange={(value) => handleInputChange('datum_zaplaceni', value)}
                        onBlur={(value) => handleFieldBlur('datum_zaplaceni', value)}
                        placeholder="Vyberte datum zaplacenÃ­"
                      />
                    </FormGroup>
                  </FormRow>
                </SectionContent>
                </FormSection>
              )}
            </>
          )}
        </>
      )}

          {/* âœ… NOVÃ POZICE: Sekce PÅ™Ã­lohy k objednÃ¡vce - zobrazÃ­ se JEN kdyÅ¾ mÃ¡ objednÃ¡vka ID (po prvnÃ­m uloÅ¾enÃ­) */}
          {formData.id && (() => {
            // ðŸ”’ isPrilohyLocked je definovÃ¡no globÃ¡lnÄ› na Å™Ã¡dku ~5203 jako: isWorkflowCompleted && !canUnlockAnything

            return (
            <FormSection data-section="prilohy">
              <SectionHeader
                sectionTheme={getSectionTheme('prilohy')}
                isActive={isSectionActive('prilohy')}
              >
                <SectionTitle sectionTheme={getSectionTheme('prilohy')}>
                  <SectionIcon sectionTheme={getSectionTheme('prilohy')}>
                    <FontAwesomeIcon icon={faClipboard} />
                  </SectionIcon>
                  PÅ™Ã­lohy k objednÃ¡vce
                  {/* ðŸ”’ Badge kdyÅ¾ je objednÃ¡vka dokonÄena/zamÃ­tnuta/zruÅ¡ena */}
                  {isPrilohyLocked && (
                    <LockWarning title="Sekce PÅ™Ã­lohy k objednÃ¡vce je zamÄena - objednÃ¡vka je dokonÄena/zamÃ­tnuta/zruÅ¡ena.">
                      ðŸ”’
                    </LockWarning>
                  )}
                </SectionTitle>
                <CollapseIcon
                  collapsed={sectionStates.prilohy}
                  sectionTheme={getSectionTheme('prilohy')}
                  onClick={() => toggleSection('prilohy')}
                  style={{ cursor: 'pointer' }}
                >
                  <FontAwesomeIcon icon={faChevronUp} />
                </CollapseIcon>
              </SectionHeader>
              <SectionContent collapsed={sectionStates.prilohy}>
                <FormRow>
                  <FormGroup style={{gridColumn: '1 / -1'}}>
                    {/* ðŸ”’ Informace o zamÄenÃ­ */}
                    {isPrilohyLocked && (
                      <div style={{
                        background: '#fef3c7',
                        border: '2px solid #f59e0b',
                        borderRadius: '8px',
                        padding: '1rem',
                        marginBottom: '1rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem'
                      }}>
                        <span style={{ fontSize: '1.5rem' }}>ðŸ”’</span>
                        <div>
                          <div style={{ fontWeight: '600', color: '#92400e', marginBottom: '0.25rem' }}>
                            PÅ™idÃ¡vÃ¡nÃ­ pÅ™Ã­loh je zamÄeno
                          </div>
                          <div style={{ fontSize: '0.875rem', color: '#92400e' }}>
                            ObjednÃ¡vka je dokonÄena - nelze pÅ™idÃ¡vat ani upravovat pÅ™Ã­lohy.
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Drag & Drop Oblast */}
                    <div
                      style={{
                        border: `2px dashed ${isPrilohyLocked ? '#d1d5db' : (dragOver ? '#dc2626' : '#fca5a5')}`,
                        borderRadius: '8px',
                        padding: '2rem',
                        textAlign: 'center',
                        backgroundColor: isPrilohyLocked ? '#f3f4f6' : (dragOver ? 'rgba(254, 202, 202, 0.5)' : 'rgba(254, 226, 226, 0.3)'),
                        marginBottom: '1rem',
                        transition: 'all 0.2s ease',
                        cursor: isPrilohyLocked ? 'not-allowed' : 'pointer',
                        opacity: isPrilohyLocked ? 0.5 : 1,
                        pointerEvents: isPrilohyLocked ? 'none' : 'auto'
                      }}
                      onDrop={(e) => {
                        if (isPrilohyLocked) return;
                        e.preventDefault();
                        e.stopPropagation();
                        setDragOver(false);
                        handleFileDrop(e);
                      }}
                      onDragOver={(e) => {
                        if (isPrilohyLocked) return;
                        e.preventDefault();
                        e.stopPropagation();
                        setDragOver(true);
                      }}
                      onDragEnter={(e) => {
                        if (isPrilohyLocked) return;
                        e.preventDefault();
                        e.stopPropagation();
                        setDragOver(true);
                      }}
                      onDragLeave={(e) => {
                        if (isPrilohyLocked) return;
                        e.preventDefault();
                        e.stopPropagation();
                        // Zkontroluj, zda opravdu opouÅ¡tÃ­me celou oblast
                        if (!e.currentTarget.contains(e.relatedTarget)) {
                          setDragOver(false);
                        }
                      }}
                      onClick={() => !isPrilohyLocked && document.getElementById('fileInput').click()}
                    >
                      {uploadingFiles ? (
                        <div style={{
                          width: '32px',
                          height: '32px',
                          border: '3px solid #f3f4f6',
                          borderTop: '3px solid #3b82f6',
                          borderRadius: '50%',
                          animation: 'spin 1s linear infinite',
                          margin: '0 auto 1rem auto'
                        }}></div>
                      ) : (
                        <div style={{
                          fontSize: '3rem',
                          marginBottom: '1rem',
                          color: dragOver ? '#dc2626' : '#991b1b',
                          transition: 'color 0.2s ease'
                        }}>
                          ðŸ“„
                        </div>
                      )}
                      <div style={{
                        fontSize: '1rem',
                        fontWeight: '500',
                        marginBottom: '0.5rem',
                        color: dragOver ? '#dc2626' : uploadingFiles ? '#f59e0b' : '#991b1b'
                      }}>
                        {uploadingFiles ? 'NahrÃ¡vÃ¡m soubory...' : dragOver ? 'PusÅ¥ soubory zde!' : 'PÅ™etÃ¡hni nebo vyber soubory'}
                      </div>
                      <div style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '1rem' }}>
                        KaÅ¾dÃ¡ pÅ™Ã­loha musÃ­ bÃ½t klasifikovÃ¡na: ObjednÃ¡vka / Faktura / KoÅ¡ilka / JinÃ©.
                      </div>
                      <div style={{ fontSize: '0.75rem', color: '#991b1b', fontWeight: '500' }}>
                        ðŸ“¤ Orders25 API: PÅ™Ã­lohy se automaticky nahrajÃ­ na server po klasifikaci pomocÃ­ Orders25 attachment API.
                      </div>
                      <button
                        type="button"
                        disabled={isPrilohyLocked}
                        style={{
                          marginTop: '1rem',
                          background: isPrilohyLocked ? '#9ca3af' : '#3b82f6',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          padding: '0.5rem 1rem',
                          fontSize: '0.875rem',
                          fontWeight: '500',
                          cursor: isPrilohyLocked ? 'not-allowed' : 'pointer',
                          opacity: isPrilohyLocked ? 0.6 : 1
                        }}
                        onClick={(e) => {
                          if (isPrilohyLocked) return;
                          e.stopPropagation();
                          document.getElementById('fileInput').click();
                        }}
                      >
                        Vybrat
                      </button>
                    </div>

                    {/* SkrytÃ½ file input */}
                    <input
                      id="fileInput"
                      type="file"
                      multiple
                      accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt"
                      onChange={handleFileSelect}
                      disabled={isPrilohyLocked}
                      style={{ display: 'none' }}
                    />

                    {/* Seznam nahranÃ½ch souborÅ¯ - pouze obj- prefix */}
                    {attachments && attachments.filter(a => getFilePrefix(a) === 'obj-').length > 0 && (
                      <div style={{ marginTop: '1rem' }}>
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          marginBottom: '1rem'
                        }}>
                          <Label>
                            PoÄet pÅ™Ã­loh: <strong>{attachments.filter(a => getFilePrefix(a) === 'obj-').length}</strong> |
                            NahrÃ¡no: <span style={{color: '#16a34a'}}><strong>{attachments.filter(f => getFilePrefix(f) === 'obj-' && f.status === 'uploaded').length}</strong></span>
                          </Label>

                          <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            {/* Sync tlaÄÃ­tko */}
                            <button
                              type="button"
                              onClick={() => checkAttachmentsSynchronization25(false)}
                              disabled={isCheckingSyncAttachments}
                              style={{
                                background: '#10b981',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '0.375rem',
                                fontSize: '0.875rem',
                                cursor: isCheckingSyncAttachments ? 'not-allowed' : 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                opacity: isCheckingSyncAttachments ? 0.6 : 1
                              }}
                              title="Kontrola synchronizace pÅ™Ã­loh s databÃ¡zÃ­ a diskem - zkontroluje, jestli jsou pÅ™Ã­lohy v DB i fyzicky na disku"
                            >
                              <FontAwesomeIcon icon={faSync} />
                            </button>

                            {/* Smart tlaÄÃ­tko */}
                            <button
                              type="button"
                              onClick={loadAttachmentsSmartly}
                              style={{
                                background: '#3b82f6',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '0.375rem',
                                fontSize: '0.875rem',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                              }}
                              title="ChytrÃ© naÄtenÃ­ pÅ™Ã­loh - slouÄÃ­ DB pÅ™Ã­lohy s lokÃ¡lnÃ­mi neuloÅ¾enÃ½mi pÅ™Ã­lohami, ideÃ¡lnÃ­ pÅ™i obnovenÃ­ formulÃ¡Å™e"
                            >
                              <FontAwesomeIcon icon={faBrain} />
                            </button>

                            {/* DB tlaÄÃ­tko */}
                            <button
                              type="button"
                              onClick={() => restoreAttachmentsFromDB(false)}
                              style={{
                                background: '#7c3aed',
                                color: 'white',
                                border: 'none',
                                borderRadius: '6px',
                                padding: '0.375rem',
                                fontSize: '0.875rem',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                              }}
                              title="NaÄtenÃ­ z databÃ¡ze - naÄte pouze pÅ™Ã­lohy uloÅ¾enÃ© v databÃ¡zi, pÅ™epÃ­Å¡e lokÃ¡lnÃ­ stav"
                            >
                              <FontAwesomeIcon icon={faDatabase} />
                            </button>

                            {/* Vymazat vÅ¡echny - SKRÃT kdyÅ¾ je zamÄeno */}
                            {!isPrilohyLocked && (
                              <button
                                type="button"
                                onClick={removeAllFiles}
                                style={{
                                  background: '#dc2626',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '6px',
                                  padding: '0.25rem 0.75rem',
                                  fontSize: '0.75rem',
                                  cursor: 'pointer'
                                }}
                              >
                                Vymazat vÅ¡echny
                              </button>
                            )}
                          </div>
                        </div>
                        {attachments.filter(a => getFilePrefix(a) === 'obj-').map((file, index) => (
                          <div key={file.id} style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.75rem',
                            padding: '0.75rem',
                            border: `1px solid ${getFileBorderColor(file)}`,
                            borderRadius: '6px',
                            backgroundColor: getFileBackgroundColor(file),
                            marginBottom: '0.5rem',
                            opacity: file.status === 'uploading' ? 0.6 : 1
                          }}>
                            {/* Ikona PDF/souboru s indikÃ¡torem stavu - fit pro 2 Å™Ã¡dky */}
                            <div style={{
                              width: '32px',
                              height: '44px',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              flexShrink: 0,
                              position: 'relative'
                            }}>
                              <FontAwesomeIcon
                                icon={file.file_exists === false ? faFileCircleXmark : faFileAlt}
                                style={{
                                  color: file.file_exists === false ? '#dc2626' : (file.status === 'uploaded' ? '#10b981' : '#dc2626'),
                                  fontSize: '24px'
                                }}
                              />
                              {file.status === 'uploading' && (
                                <div style={{
                                  position: 'absolute',
                                  top: '-2px',
                                  right: '-2px',
                                  width: '12px',
                                  height: '12px',
                                  backgroundColor: '#f59e0b',
                                  borderRadius: '50%',
                                  animation: 'spin 1s linear infinite'
                                }} />
                              )}
                              {file.status === 'uploaded' && (
                                <div style={{
                                  position: 'absolute',
                                  top: '-2px',
                                  right: '-2px',
                                  width: '12px',
                                  height: '12px',
                                  backgroundColor: '#10b981',
                                  borderRadius: '50%'
                                }} />
                              )}
                            </div>

                            {/* Informace o souboru */}
                            <div style={{ flex: 1, minWidth: 0 }}>
                              <div style={{
                                fontWeight: '500',
                                fontSize: '0.875rem',
                                color: '#374151',
                                marginBottom: '2px'
                              }}>
                                {/* Jeden Å™Ã¡dek - nÃ¡zev, velikost, staÅ¾enÃ­, koÅ¡ */}
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.5rem'
                                }}>
                                  {/* NÃ¡zev souboru s hvÄ›zdiÄkou jako hornÃ­ index */}
                                  <span style={{
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap',
                                    flex: 1,
                                    minWidth: 0,
                                    position: 'relative'
                                  }}>
                                    {file.name}
                                    {/* ÄŒervenÃ¡ hvÄ›zdiÄka jako hornÃ­ index hned za nÃ¡zvem */}
                                    {!file.klasifikace && (
                                      <span style={{
                                        color: '#dc2626',
                                        fontSize: '0.7rem',
                                        fontWeight: 'bold',
                                        position: 'absolute',
                                        top: '-2px',
                                        marginLeft: '2px'
                                      }}>
                                        *
                                      </span>
                                    )}
                                  </span>

                                  {/* Warning pro soubory, kterÃ© neexistujÃ­ na disku */}
                                  {file.file_exists === false && (
                                    <span style={{
                                      color: '#dc2626',
                                      fontSize: '0.7rem',
                                      fontWeight: 'bold',
                                      backgroundColor: '#fee2e2',
                                      padding: '1px 4px',
                                      borderRadius: '3px',
                                      flexShrink: 0
                                    }}>
                                      âš  SOUBOR NENALEZEN
                                    </span>
                                  )}

                                  {/* Warning pro duplicity */}
                                  {file.isDuplicate && (
                                    <span style={{
                                      color: '#f59e0b',
                                      fontSize: '0.7rem',
                                      fontWeight: 'bold',
                                      backgroundColor: '#fef3c7',
                                      padding: '1px 4px',
                                      borderRadius: '3px',
                                      flexShrink: 0
                                    }}>
                                      DUPLIKÃT
                                    </span>
                                  )}

                                  {/* Velikost souboru - pouÅ¾Ã­vej velikost z BE nebo size z lokÃ¡lnÃ­ho */}
                                  <span style={{
                                    color: '#6b7280',
                                    fontWeight: 'normal',
                                    fontSize: '0.75rem',
                                    flexShrink: 0
                                  }}>
                                    ({Math.round((file.velikost || file.size || 0) / 1024)} kB)
                                  </span>

                                  {/* StaÅ¾enÃ­ pro nahranÃ© soubory */}
                                  {file.status === 'uploaded' && file.serverId && (
                                    <button
                                      type="button"
                                      onClick={() => downloadAttachmentFromServer25(file)}
                                      style={{
                                        background: 'none',
                                        border: 'none',
                                        color: '#2563eb',
                                        cursor: 'pointer',
                                        padding: '2px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        fontSize: '12px',
                                        flexShrink: 0
                                      }}
                                      title="StÃ¡hnout soubor"
                                    >
                                      <FileText size={14} />
                                    </button>
                                  )}

                                  {/* KoÅ¡ - SKRÃT kdyÅ¾ je zamÄeno */}
                                  {!isPrilohyLocked && (
                                    <button
                                      type="button"
                                      onClick={() => file.serverId ? deleteAttachmentFromServer25(file.id) : removeFile(file.id)}
                                      disabled={file.status === 'uploading'}
                                      style={{
                                        background: 'none',
                                        border: 'none',
                                        color: file.status === 'uploading' ? '#9ca3af' : '#dc2626',
                                        cursor: file.status === 'uploading' ? 'not-allowed' : 'pointer',
                                        padding: '2px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        opacity: file.status === 'uploading' ? 0.6 : 1,
                                        fontSize: '12px',
                                        flexShrink: 0
                                      }}
                                      title={file.serverId ? "Smazat ze serveru" : "Smazat soubor"}
                                    >
                                      <FontAwesomeIcon icon={faTrash} />
                                    </button>
                                  )}
                                </div>
                              </div>
                              <div style={{
                                fontSize: '0.75rem',
                                color: '#6b7280',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem'
                              }}>
                                <span>{formatDateOnly(new Date(file.uploadDate))} {new Date(file.uploadDate).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}</span>
                                <span>â€¢</span>
                                <span style={{
                                  textTransform: 'uppercase',
                                  backgroundColor: '#fef3c7',
                                  color: '#92400e',
                                  padding: '2px 6px',
                                  borderRadius: '4px',
                                  fontSize: '0.6875rem',
                                  fontWeight: '500'
                                }}>
                                  {file.type.includes('pdf') ? 'PDF' : file.name.split('.').pop()}
                                </span>
                                <span>â€¢</span>
                                <span style={{
                                  backgroundColor: '#e0e7ff',
                                  color: '#3730a3',
                                  padding: '2px 6px',
                                  borderRadius: '4px',
                                  fontSize: '0.6875rem',
                                  fontWeight: '500'
                                }}>
                                  NahrÃ¡no: {file.nahrano_uzivatel?.prijmeni || 'ADMIN'} {file.nahrano_uzivatel?.jmeno || 'Super'}
                                </span>
                              </div>
                            </div>

                            {/* Dropdown pro klasifikaci */}
                            <div style={{ minWidth: '180px', flexShrink: 0 }}>
                              {(() => {
                                // Debug log pro hodnotu selectu
                                // Debug disabled for production
                                return null;
                              })()}
                              <select
                                value={file.klasifikace || ''}
                                onChange={(e) => updateFileKlasifikace(file.id, e.target.value)}
                                disabled={file.status === 'uploading' || file.typ_prilohy === 'IMPORT' || isPrilohyLocked}
                                style={{
                                  width: '100%',
                                  padding: '0.5rem 0.75rem',
                                  border: `1px solid ${!file.klasifikace ? '#fca5a5' : file.typ_prilohy === 'IMPORT' ? '#f59e0b' : '#d1d5db'}`,
                                  borderRadius: '6px',
                                  fontSize: '0.875rem',
                                  backgroundColor: file.status === 'uploading' ? '#f3f4f6' : file.typ_prilohy === 'IMPORT' ? '#fef3c7' : isPrilohyLocked ? '#f3f4f6' : 'white',
                                  color: file.klasifikace ? '#374151' : '#6b7280',
                                  cursor: file.status === 'uploading' || file.typ_prilohy === 'IMPORT' || isPrilohyLocked ? 'not-allowed' : 'pointer',
                                  opacity: file.status === 'uploading' || isPrilohyLocked ? 0.6 : 1,
                                  fontWeight: file.typ_prilohy === 'IMPORT' ? '600' : 'normal'
                                }}
                                title={isPrilohyLocked ? 'Klasifikace je zamÄena - objednÃ¡vka dokonÄena' : (file.typ_prilohy === 'IMPORT' ? 'ImportovanÃ¡ pÅ™Ã­loha - nelze mÄ›nit typ' : '')}
                              >
                                <option value="" style={{ color: '#6b7280' }}>Vyberte...</option>
                                {prilohyTypyOptions.map(typ => (
                                  <option key={typ.kod || typ.id} value={typ.kod || typ.id}>
                                    {typ.nazev || typ.name}
                                  </option>
                                ))}
                              </select>
                            </div>

                          </div>
                        ))}
                      </div>
                    )}

                    {/* VarovnÃ¡ zprÃ¡va o okamÅ¾itÃ½ch zmÄ›nÃ¡ch v pÅ™Ã­lohÃ¡ch */}
                    <div style={{
                      backgroundColor: '#fef3c7',
                      border: '1px solid #f59e0b',
                      borderRadius: '8px',
                      padding: '1rem',
                      marginTop: '1rem',
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '0.75rem'
                    }}>
                      <div style={{
                        fontSize: '1.25rem',
                        flexShrink: 0,
                        lineHeight: 1
                      }}>
                        âš ï¸
                      </div>
                      <div style={{
                        fontSize: '0.875rem',
                        color: '#92400e',
                        lineHeight: '1.5'
                      }}>
                        <strong>DÅ¯leÅ¾itÃ© upozornÄ›nÃ­:</strong> VÅ¡echny zmÄ›ny v pÅ™Ã­lohÃ¡ch (nahrÃ¡nÃ­, klasifikace, mazÃ¡nÃ­)
                        jsou provÃ¡dÄ›ny okamÅ¾itÄ› a automaticky se uklÃ¡dajÃ­ do databÃ¡ze.
                        Tyto akce nelze vzÃ­t zpÄ›t pomocÃ­ tlaÄÃ­tka "ZruÅ¡it".
                      </div>
                    </div>
                  </FormGroup>
                </FormRow>
              </SectionContent>
            </FormSection>
            );
          })()}

          </ScrollableInner>
        </ScrollableContent>
      </FormWrapper>

      {/* Supplier Search Dialog */}
      {showSupplierSearchDialog && ReactDOM.createPortal(
        <SupplierPopupOverlay>
          <SupplierPopupModal onClick={(e) => e.stopPropagation()}>
            <SupplierPopupHeader>
              <SupplierPopupTitle>
                <Users size={24} />
                AdresÃ¡Å™ dodavatelÅ¯
              </SupplierPopupTitle>
              <SupplierPopupCloseButton onClick={handleSupplierSearchClose}>
                Ã—
              </SupplierPopupCloseButton>
            </SupplierPopupHeader>

            <SupplierPopupContent>
              {/* Search Input */}
              <div style={{ marginBottom: '20px' }}>
                <SupplierSearchInput
                  type="text"
                  value={supplierSearchTerm}
                  onChange={handleSupplierSearchChange}
                  placeholder="Vyhledat podle nÃ¡zvu nebo IÄŒO..."
                  autoFocus
                />
              </div>

              {/* Search Results */}
              <div style={{ minHeight: '200px' }}>
                {supplierSearchLoading ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    padding: '40px 20px',
                    textAlign: 'center'
                  }}>
                    <div style={{
                      width: '32px',
                      height: '32px',
                      border: '3px solid #f3f4f6',
                      borderTop: '3px solid #3b82f6',
                      borderRadius: '50%',
                      animation: 'spin 1s linear infinite',
                      marginBottom: '16px'
                    }}></div>
                    <p style={{ color: '#6b7280', margin: 0 }}>VyhledÃ¡vÃ¡m dodavatele...</p>
                  </div>
                ) : supplierSearchResults.length > 0 ? (
                  <SupplierList>
                    {supplierSearchResults.map((supplier, index) => (
                      <SupplierItem
                        key={supplier.id || index}
                        onClick={() => handleSupplierSearchSelect(supplier)}
                      >
                        <div style={{ fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                          {supplier.nazev || supplier.name}
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '4px' }}>
                          {supplier.adresa || supplier.address || supplier.sidlo}
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '4px' }}>
                          {supplier.ico && `IÄŒO: ${supplier.ico}`} {supplier.dic && `â€¢ DIÄŒ: ${supplier.dic}`}
                        </div>
                        {(supplier.kontakt_jmeno || supplier.kontakt_email) && (
                          <div style={{ fontSize: '0.75rem', color: '#9ca3af' }}>
                            Kontakt: {supplier.kontakt_jmeno} {supplier.kontakt_email && `â€¢ ${supplier.kontakt_email}`}
                          </div>
                        )}
                      </SupplierItem>
                    ))}
                  </SupplierList>
                ) : allSupplierContacts.length === 0 ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: '#6b7280'
                  }}>
                    <p>Å½Ã¡dnÃ­ dodavatelÃ© nejsou k dispozici.</p>
                  </div>
                ) : supplierSearchTerm.length >= 2 ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: '#6b7280'
                  }}>
                    <p>Å½Ã¡dnÃ­ dodavatelÃ© nevyhovujÃ­ vyhledÃ¡vÃ¡nÃ­ "{supplierSearchTerm}".</p>
                  </div>
                ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: '#6b7280'
                  }}>
                    <p>ZaÄnÄ›te psÃ¡t pro filtrovÃ¡nÃ­ dodavatelÅ¯...</p>
                  </div>
                )}
              </div>
            </SupplierPopupContent>
          </SupplierPopupModal>
        </SupplierPopupOverlay>,
        document.body
      )}

      {/* ARES Search Popup */}
      {aresPopupOpen && ReactDOM.createPortal(
        <AresPopupOverlay>
          <AresPopupModal onClick={(e) => e.stopPropagation()}>
            <AresPopupHeader>
              <AresPopupTitle>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <ellipse cx="12" cy="5" rx="9" ry="3"/>
                  <path d="M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5"/>
                  <path d="M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3"/>
                </svg>
                ARES - AdministrativnÃ­ registr ekonomickÃ½ch subjektÅ¯
              </AresPopupTitle>
              <AresPopupCloseButton
                onClick={() => {
                  setAresPopupOpen(false);
                  setAresSearch('');
                }}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </AresPopupCloseButton>
            </AresPopupHeader>

            <AresPopupContent>
              <AresSearchInputField
                type="text"
                placeholder="Vyhledat podle nÃ¡zvu firmy nebo IÄŒO..."
                value={aresSearch}
                onChange={handleAresSearchChange}
                autoFocus
              />

              {/* ðŸŽ¯ ROZSAH ULOÅ½ENÃ - PRESNE STEJNÃ‰ jako SupplierAddDialog */}
              <div style={{ marginBottom: '16px' }}>
                <div style={{ fontSize: '14px', fontWeight: '600', color: '#262626', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                  Rozsah uloÅ¾enÃ­
                </div>
                <AresScopeSelector>
                  {/* OsobnÃ­ */}
                  <AresScopeOption
                    type="button"
                    selected={aresSelectedScope === 'personal'}
                    onClick={() => setAresSelectedScope('personal')}
                  >
                    <FontAwesomeIcon icon={faUser} />
                    <span>OsobnÃ­</span>
                  </AresScopeOption>

                  {/* Ãšsek */}
                  <AresScopeOption
                    type="button"
                    selected={aresSelectedScope === 'usek'}
                    onClick={() => hasPermission && hasPermission('CONTACT_EDIT') && setAresSelectedScope('usek')}
                    disabled={!hasPermission || !hasPermission('CONTACT_EDIT')}
                    title={(!hasPermission || !hasPermission('CONTACT_EDIT')) ? "NemÃ¡te oprÃ¡vnÄ›nÃ­ pro ÃºsekovÃ½ kontakt" : ""}
                  >
                    <FontAwesomeIcon icon={faBuilding} />
                    <span>Ãšsek</span>
                  </AresScopeOption>

                  {/* GlobÃ¡lnÃ­ */}
                  <AresScopeOption
                    type="button"
                    selected={aresSelectedScope === 'global'}
                    onClick={() => hasPermission && hasPermission('CONTACT_MANAGE') && setAresSelectedScope('global')}
                    disabled={!hasPermission || !hasPermission('CONTACT_MANAGE')}
                    title={(!hasPermission || !hasPermission('CONTACT_MANAGE')) ? "NemÃ¡te oprÃ¡vnÄ›nÃ­ pro globÃ¡lnÃ­ kontakt" : ""}
                  >
                    <FontAwesomeIcon icon={faGlobe} />
                    <span>GlobÃ¡lnÃ­</span>
                  </AresScopeOption>
                </AresScopeSelector>
              </div>

              {/* ðŸ¢ VÃ½bÄ›r ÃºsekÅ¯ - zobrazÃ­ se pouze pokud je vybranÃ½ scope "usek" */}
              {aresSelectedScope === 'usek' && (
                <div style={{ marginBottom: '16px' }}>
                  <div style={{ fontSize: '14px', fontWeight: '600', color: '#262626', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                    {canManageUsers ? 'VÃ½bÄ›r ÃºsekÅ¯' : `VÃ¡Å¡ Ãºsek: ${userDetail?.usek_zkr || 'N/A'}`}
                  </div>
                  {usekyLoading ? (
                    <div style={{ padding: '1rem', textAlign: 'center', color: '#6b7280' }}>
                      NaÄÃ­tÃ¡m Ãºseky...
                    </div>
                  ) : availableUseky.length === 0 ? (
                    <div style={{ padding: '1rem', background: '#fef2f2', border: '1px solid #fecaca', borderRadius: '8px', color: '#dc2626' }}>
                      âŒ Å½Ã¡dnÃ© Ãºseky nebyly naÄteny
                    </div>
                  ) : (
                    <AresUsekGrid>
                      {(canManageUsers ? availableUseky :
                        availableUseky.filter(usek => usek.usek_zkr === userDetail?.usek_zkr)
                      ).map((usek, index) => (
                        <AresUsekItem
                          key={usek.usek_zkr || index}
                          selected={aresSelectedUseky.includes(usek.usek_zkr)}
                          onClick={() => handleAresUsekToggle(usek.usek_zkr)}
                        >
                          <input
                            type="checkbox"
                            checked={aresSelectedUseky.includes(usek.usek_zkr)}
                            onChange={() => handleAresUsekToggle(usek.usek_zkr)}
                          />
                          {usek.usek_zkr}
                        </AresUsekItem>
                      ))}
                    </AresUsekGrid>
                  )}
                  {aresSelectedUseky.length === 0 && !usekyLoading && availableUseky.length > 0 && (
                    <div style={{ marginTop: '8px', padding: '8px', background: '#e0f2fe', border: '1px solid #0ea5e9', borderRadius: '6px', fontSize: '12px', color: '#0c4a6e' }}>
                      â„¹ï¸ Pokud nevyberete Å¾Ã¡dnÃ½ Ãºsek, kontakt se uloÅ¾Ã­ jako osobnÃ­
                    </div>
                  )}
                </div>
              )}

              <AresList>
                {loadingAres ? (
                  <AresLoadingSpinner>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ animation: 'spin 1s linear infinite' }}>
                      <path d="M21 12a9 9 0 11-6.219-8.56"/>
                    </svg>
                    <span style={{ marginLeft: '12px' }}>VyhledÃ¡vÃ¡m v ARES...</span>
                  </AresLoadingSpinner>
                ) : aresResults.length > 0 ? (
                  aresResults.map((aresItem, index) => {
                    const isCurrentlySaving = savingToLocal === aresItem.ico;

                    return (
                      <AresItem key={index}>
                        <AresItemContent
                          hasButtons={true}
                          onClick={() => handleAresSelect(aresItem)}
                        >
                          <div style={{ fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
                            {aresItem.nazev}
                          </div>
                          <div style={{ fontSize: '0.875rem', color: '#6b7280', marginBottom: '4px' }}>
                            {aresItem.sidlo || aresItem.adresa}
                          </div>
                          <div style={{ fontSize: '0.875rem', color: '#6b7280' }}>
                            IÄŒO: {aresItem.ico} {aresItem.dic && `â€¢ DIÄŒ: ${aresItem.dic}`}
                          </div>

                          {/* ðŸŽ¯ Scope indikÃ¡tory */}
                          {aresScopeInfo[aresItem.ico] && (
                            aresScopeInfo[aresItem.ico].existsInGlobal ||
                            aresScopeInfo[aresItem.ico].existsInUsek ||
                            aresScopeInfo[aresItem.ico].existsInPersonal
                          ) && (
                            <AresScopeBadges>
                              {aresScopeInfo[aresItem.ico].existsInGlobal && (
                                <AresScopeBadge scope="global">
                                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                  </svg>
                                  GlobÃ¡lnÃ­
                                </AresScopeBadge>
                              )}
                              {aresScopeInfo[aresItem.ico].existsInUsek && (
                                <AresScopeBadge scope="usek">
                                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                  </svg>
                                  Ãšsek
                                </AresScopeBadge>
                              )}
                              {aresScopeInfo[aresItem.ico].existsInPersonal && (
                                <AresScopeBadge scope="personal">
                                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                  </svg>
                                  OsobnÃ­
                                </AresScopeBadge>
                              )}
                            </AresScopeBadges>
                          )}
                        </AresItemContent>

                        <AresItemButtons>
                          <AresActionButton
                            className="primary"
                            onClick={() => handleAresSelect(aresItem)}
                          >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <path d="M9 11l3 3L22 4"/>
                              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                            </svg>
                            PouÅ¾Ã­t
                          </AresActionButton>

                          <AresActionButton
                            className="success"
                            onClick={() => {
                              // ðŸŽ¯ PouÅ¾Ã­t vybranÃ½ scope namiesto hardcoded 'personal'
                              const saveLocation = aresSelectedScope === 'usek'
                                ? { scope: 'usek', useky: aresSelectedUseky }
                                : aresSelectedScope;
                              handleSaveToLocal(aresItem, saveLocation);
                              handleAresSelect(aresItem);
                            }}
                            disabled={isCurrentlySaving || (aresSelectedScope === 'usek' && aresSelectedUseky.length === 0)}
                            title={(aresSelectedScope === 'usek' && aresSelectedUseky.length === 0) ? "Vyberte alespoÅˆ jeden Ãºsek" : ""}
                          >
                            {isCurrentlySaving ? (
                              <>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ animation: 'spin 1s linear infinite' }}>
                                  <path d="M21 12a9 9 0 11-6.219-8.56"/>
                                </svg>
                                UklÃ¡dÃ¡m...
                              </>
                            ) : (
                              <>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                  <polyline points="17,21 17,13 7,13 7,21"/>
                                  <polyline points="7,3 7,8 15,8"/>
                                </svg>
                                PouÅ¾Ã­t + UloÅ¾it
                              </>
                            )}
                          </AresActionButton>
                        </AresItemButtons>
                      </AresItem>
                    );
                  })
                ) : aresSearch.length >= 2 ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: '#6b7280'
                  }}>
                    <p>V ARES nebyli nalezeni Å¾Ã¡dnÃ­ dodavatelÃ©.</p>
                  </div>
                ) : (
                  <div style={{
                    textAlign: 'center',
                    padding: '40px 20px',
                    color: '#6b7280'
                  }}>
                    <p>Zadejte alespoÅˆ 2 znaky pro vyhledÃ¡vÃ¡nÃ­ v ARES.</p>
                  </div>
                )}
              </AresList>
            </AresPopupContent>
          </AresPopupModal>
        </AresPopupOverlay>,
        document.body
      )}

      {/* Modal pro uloÅ¾enÃ­ Å¡ablony */}
      {showTemplateSaveModal && ReactDOM.createPortal(
        <TemplateModalOverlay>
          <TemplateModal onClick={(e) => e.stopPropagation()}>
            <TemplateModalCloseButton
              type="button"
              onClick={() => {
                setShowTemplateSaveModal(false);
                setTemplateName('');
                setTemplateType('po');
                setSaveMode('new');
                setSelectedTargetTemplate(null);
              }}
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </TemplateModalCloseButton>

            <TemplateModalHeader>
              <TemplateModalTitle>
                UloÅ¾it Å¡ablonu
              </TemplateModalTitle>
            </TemplateModalHeader>

            <TemplateModalBody>
              {/* ReÅ¾im */}
              <TemplateFormGroup>
                <TemplateLabel>REÅ½IM</TemplateLabel>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {[
                    { value: 'new', label: 'âœ¨ NovÃ¡', disabled: false },
                    { value: 'update', label: 'ðŸ”„ Aktualizovat', disabled: [...savedTemplates, ...serverTemplates].length === 0 },
                    { value: 'merge', label: 'ðŸ”— SlouÄit', disabled: [...savedTemplates, ...serverTemplates].length === 0 }
                  ].map(option => (
                    <label key={option.value} style={{
                      flex: 1,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '4px',
                      padding: '10px 16px',
                      borderRadius: '6px',
                      border: `2px solid ${saveMode === option.value ? '#10b981' : '#e5e7eb'}`,
                      backgroundColor: saveMode === option.value ? '#d1fae5' : 'white',
                      cursor: option.disabled ? 'not-allowed' : 'pointer',
                      opacity: option.disabled ? 0.5 : 1,
                      fontSize: '0.875rem',
                      fontWeight: '600',
                      transition: 'all 0.2s'
                    }}>
                      <input
                        type="radio"
                        name="saveMode"
                        value={option.value}
                        checked={saveMode === option.value}
                        onChange={(e) => setSaveMode(e.target.value)}
                        disabled={option.disabled}
                        style={{ display: 'none' }}
                      />
                      {option.label}
                    </label>
                  ))}
                </div>
              </TemplateFormGroup>

              {/* VÃ½bÄ›r existujÃ­cÃ­ Å¡ablony (pro update/merge) */}
              {(saveMode === 'update' || saveMode === 'merge') && (
                <TemplateFormGroup>
                  <TemplateLabel>VYBERTE Å ABLONU</TemplateLabel>
                  <StableCustomSelect
                    field="templateSelect"
                    value={selectedTargetTemplate?.id || selectedTargetTemplate?.ts || ''}
                    onChange={(selectedValue) => {
                      // âœ… OPRAVA: StableCustomSelect posÃ­lÃ¡ hodnotu pÅ™Ã­mo, ne event!
                      const allTemplates = [...savedTemplates, ...serverTemplates];
                      const selected = allTemplates.find(t => (t.id || t.ts).toString() === String(selectedValue));
                      setSelectedTargetTemplate(selected);
                      if (saveMode === 'update' && selected) {
                        setTemplateName(selected.name || '');
                      }
                    }}
                    options={[...savedTemplates, ...serverTemplates]}
                    placeholder="Vyberte Å¡ablonu..."
                    getOptionLabel={(option) => {
                      const source = option.__fromServer ? 'server' : 'lokÃ¡lnÃ­';
                      return `${option.name} (${source})`;
                    }}
                    getOptionValue={(option) => option.id || option.ts}
                  />
                </TemplateFormGroup>
              )}

              {/* NÃ¡zev Å¡ablony (pro new/merge) */}
              {(saveMode === 'new' || saveMode === 'merge') && (
                <TemplateFormGroup>
                  <TemplateLabel>NÃZEV</TemplateLabel>
                  <TemplateInput
                    type="text"
                    value={templateName}
                    onChange={(e) => setTemplateName(e.target.value)}
                    placeholder={saveMode === 'merge' ? 'NÃ¡zev slouÄenÃ© Å¡ablony' : 'NÃ¡zev Å¡ablony'}
                    autoFocus={saveMode === 'new'}
                  />
                </TemplateFormGroup>
              )}

              {/* Typ Å¡ablony - omezenÃ½ podle fÃ¡ze */}
              <TemplateFormGroup>
                <TemplateLabel>TYP</TemplateLabel>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {[
                    { value: 'po', label: 'PO', disabled: false },
                    { value: 'details', label: 'Detaily', disabled: !isArchived && currentPhase < 2 },
                    { value: 'mixed', label: 'VÅ¡e', disabled: !isArchived && currentPhase < 2 }
                  ].map(option => (
                    <label key={option.value} style={{
                      flex: 1,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      padding: '10px 16px',
                      borderRadius: '6px',
                      border: `2px solid ${templateType === option.value ? '#3b82f6' : '#e5e7eb'}`,
                      backgroundColor: templateType === option.value ? '#dbeafe' : 'white',
                      cursor: option.disabled ? 'not-allowed' : 'pointer',
                      opacity: option.disabled ? 0.4 : 1,
                      fontSize: '0.875rem',
                      fontWeight: '600',
                      transition: 'all 0.2s'
                    }}>
                      <input
                        type="radio"
                        name="templateType"
                        value={option.value}
                        checked={templateType === option.value}
                        onChange={(e) => setTemplateType(e.target.value)}
                        disabled={option.disabled}
                        style={{ display: 'none' }}
                      />
                      {option.label}
                    </label>
                  ))}
                </div>
                {(!isArchived && currentPhase < 2) && (
                  <div style={{
                    marginTop: '8px',
                    padding: '8px 12px',
                    backgroundColor: '#fef3c7',
                    border: '1px solid #fbbf24',
                    borderRadius: '6px',
                    fontSize: '0.75rem',
                    color: '#92400e'
                  }}>
                    âš ï¸ Ve FÃZI 1 lze uklÃ¡dat pouze <strong>PO</strong> (PÅ™edbÄ›Å¾nÃ¡ objednÃ¡vka). Detaily budou dostupnÃ© po schvÃ¡lenÃ­.
                  </div>
                )}
              </TemplateFormGroup>
            </TemplateModalBody>

            <TemplateModalActions>
              <TemplateActionButton
                type="button"
                variant="cancel"
                onClick={() => {
                  setShowTemplateSaveModal(false);
                  setTemplateName('');
                  setTemplateType('po');
                }}
              >
                ZruÅ¡it
              </TemplateActionButton>
              <TemplateActionButton
                type="button"
                variant="primary"
                onClick={async () => {
                  if (!templateName.trim()) return;

                  // SestavenÃ­ dat Å¡ablony podle fÃ¡ze a viditelnosti sekcÃ­
                  const templateData = {};
                  const visibility = getSectionVisibility(mainWorkflowState, currentPhase, isArchived);
                  const fieldMap = getFieldsForSections();

                  // PO ÄÃ¡st (vÅ¾dy dostupnÃ¡)
                  if (templateType === 'po' || templateType === 'mixed') {
                    templateData.poApproval = {
                      predmet: formData.predmet || '',
                      prikazce_id: formData.prikazce_id || '',
                      max_cena_s_dph: formData.max_cena_s_dph || '',
                      strediska_kod: formData.strediska_kod || '',
                      garant_uzivatel_id: formData.garant_uzivatel_id || '',
                      // âœ… FinancovÃ¡nÃ­ - pÅ™esunuto z FÃZE 3 do FÃZE 1, lze uklÃ¡dat do PO Å¡ablony
                      zpusob_financovani: formData.zpusob_financovani || '',
                      lp_kod: formData.lp_kod || [],
                      cislo_smlouvy: formData.cislo_smlouvy || '',
                      smlouva_poznamka: formData.smlouva_poznamka || '',
                      individualni_schvaleni: formData.individualni_schvaleni || '',
                      individualni_poznamka: formData.individualni_poznamka || '',
                      pojistna_udalost_cislo: formData.pojistna_udalost_cislo || '',
                      pojistna_udalost_poznamka: formData.pojistna_udalost_poznamka || ''
                    };
                  }

                  // DetailnÃ­ ÄÃ¡st (pouze od FÃZE 3++ a z viditelnÃ½ch sekcÃ­)
                  if (templateType === 'details' || templateType === 'mixed') {
                    if (currentPhase < 2) {
                      showToast?.('Nelze uloÅ¾it Detaily ve FÃZI 1. PouÅ¾ijte typ "PO".', 'warning');
                      return;
                    }

                    templateData.orderDetails = {};

                    // Naplnit pouze pole z viditelnÃ½ch sekcÃ­
                    Object.entries(fieldMap).forEach(([sectionKey, fields]) => {
                      const isSectionVisible = sectionKey === 'polozky' ? visibility.detaily : visibility[sectionKey];

                      if (isSectionVisible) {
                        fields.forEach(field => {
                          if (field !== 'polozky_objednavky' && formData[field] !== undefined) {
                            templateData.orderDetails[field] = formData[field] || '';
                          }
                        });
                      }
                    });

                    // PoloÅ¾ky objednÃ¡vky (pokud je sekce detaily viditelnÃ¡)
                    if (visibility.detaily && Array.isArray(formData.polozky_objednavky) && formData.polozky_objednavky.length > 0) {
                      templateData.polozky = formData.polozky_objednavky.map(item => ({
                        popis: item.popis || '',
                        cena_bez_dph: item.cena_bez_dph || '',
                        sazba_dph: item.sazba_dph || 21,
                        cena_s_dph: item.cena_s_dph || ''
                      }));
                    }
                  }

                  if (saveMode === 'new') {
                    // NovÃ¡ Å¡ablona
                    await saveTemplateToStorage(templateName.trim(), templateData, templateType);
                  } else if (saveMode === 'update') {
                    // Aktualizace existujÃ­cÃ­ Å¡ablony
                    if (selectedTargetTemplate.__fromServer) {
                      // ServerovÃ¡ Å¡ablona - aktualizace pÅ™es API
                      try {
                        const polozky_po = (templateType === 'po' || templateType === 'mixed') && templateData.poApproval
                          ? JSON.stringify(templateData.poApproval)
                          : '';
                        const polozky_detail = (templateType === 'details' || templateType === 'mixed') && templateData.orderDetails
                          ? JSON.stringify(templateData.orderDetails)
                          : '';

                        const result = await updateTemplate({
                          username: user?.username || username,
                          token,
                          user_id: selectedTargetTemplate.user_id || 0,
                          id: selectedTargetTemplate.id,
                          nazev_sablony: selectedTargetTemplate.name,
                          polozky_po,
                          polozky_detail,
                          typ: templateType,
                          kategorie: "OBJEDNAVKA25"
                        });

                        if (result?.status === 'ok') {
                          await fetchAndMergeTemplates();
                          if (showToast) {
                            showToast(`Å ablona "${selectedTargetTemplate.name}" byla aktualizovÃ¡na`, { type: 'success' });
                          }
                        }
                      } catch (error) {
                        if (showToast) {
                          showToast('Chyba pÅ™i aktualizaci Å¡ablony na serveru', { type: 'error' });
                        }
                      }
                    } else {
                      // LokÃ¡lnÃ­ Å¡ablona - aktualizace v localStorage
                      setSavedTemplates(prev => prev.map(template =>
                        template.ts === selectedTargetTemplate.ts
                          ? { ...template, data: templateData, type: templateType }
                          : template
                      ));
                      if (showToast) {
                        showToast(`Å ablona "${selectedTargetTemplate.name}" byla aktualizovÃ¡na`, { type: 'success' });
                      }
                    }
                  } else if (saveMode === 'merge') {
                    // SlouÄenÃ­ s existujÃ­cÃ­ Å¡ablonou
                    const mergedData = { ...selectedTargetTemplate.data };
                    if (templateData.poApproval) {
                      mergedData.poApproval = { ...mergedData.poApproval, ...templateData.poApproval };
                    }
                    if (templateData.orderDetails) {
                      mergedData.orderDetails = { ...mergedData.orderDetails, ...templateData.orderDetails };
                      // SlouÄit poloÅ¾ky
                      if (templateData.orderDetails.polozky?.length > 0) {
                        mergedData.orderDetails.polozky = [
                          ...(mergedData.orderDetails.polozky || []),
                          ...templateData.orderDetails.polozky
                        ];
                      }
                    }

                    await saveTemplateToStorage(templateName.trim(), mergedData, 'mixed');
                    if (showToast) {
                      showToast(`Å ablona "${templateName}" byla vytvoÅ™ena slouÄenÃ­m`, { type: 'success' });
                    }
                  }

                  setShowTemplateSaveModal(false);
                  setTemplateName('');
                  setTemplateType('po');
                  setSaveMode('new');
                  setSelectedTargetTemplate(null);
                }}
                disabled={
                  (saveMode === 'new' && !templateName.trim()) ||
                  ((saveMode === 'update' || saveMode === 'merge') && !selectedTargetTemplate) ||
                  (saveMode === 'merge' && !templateName.trim())
                }
              >
                {saveMode === 'new' ? 'ðŸ’¾ UloÅ¾it' :
                 saveMode === 'update' ? 'ðŸ”„ Aktualizovat' :
                 'ðŸ”— SlouÄit'}
              </TemplateActionButton>
            </TemplateModalActions>
          </TemplateModal>
        </TemplateModalOverlay>,
        document.body
      )}

      {/* Modal pro potvrzenÃ­ mazÃ¡nÃ­ Å¡ablony */}
      {showDeleteTemplateConfirm && ReactDOM.createPortal(
        <DeleteConfirmOverlay onClick={(e) => { if (e.target === e.currentTarget) cancelDeleteSavedTemplate(); }}>
          <DeleteConfirmModal onClick={(e) => e.stopPropagation()}>
            <DeleteConfirmTitle>
              Potvrdit smazÃ¡nÃ­ Å¡ablony
            </DeleteConfirmTitle>
            <DeleteConfirmMessage>
              Opravdu chcete smazat Å¡ablonu <strong>"{templatePendingDelete?.name}"</strong>?
              <br /><br />
              Tato akce je nevratnÃ¡.
            </DeleteConfirmMessage>
            <DeleteConfirmActions>
              <DeleteConfirmButton onClick={cancelDeleteSavedTemplate}>
                ZruÅ¡it
              </DeleteConfirmButton>
              <DeleteConfirmButton variant="danger" onClick={confirmDeleteSavedTemplate}>
                Smazat
              </DeleteConfirmButton>
            </DeleteConfirmActions>
          </DeleteConfirmModal>
        </DeleteConfirmOverlay>,
        document.body
      )}

      {/* Template Preview Modal */}
      {previewModalData && ReactDOM.createPortal(
        <PreviewModal onClick={() => setPreviewModalData(null)}>
          <PreviewContent onClick={e => e.stopPropagation()}>
            <PreviewHeader>
              <PreviewTitle>
                <Eye size={20} />
                NÃ¡hled Å¡ablony
              </PreviewTitle>
              <PreviewCloseButton onClick={() => setPreviewModalData(null)}>
                <X size={18} />
              </PreviewCloseButton>
            </PreviewHeader>

            {/* Template Info */}
            <PreviewSection>
              <PreviewSectionTitle>
                <FileText size={16} />
                Informace o Å¡ablonÄ›
              </PreviewSectionTitle>
              <PreviewField>
                <PreviewFieldLabel>NÃ¡zev:</PreviewFieldLabel>
                <PreviewFieldValue>{previewModalData.preview.templateInfo.name}</PreviewFieldValue>
              </PreviewField>
              <PreviewField>
                <PreviewFieldLabel>Typ:</PreviewFieldLabel>
                <PreviewFieldValue>
                  <PreviewBadge type={previewModalData.preview.templateInfo.type}>
                    {previewModalData.preview.templateInfo.type === 'po' ? 'SchvÃ¡lenÃ­' :
                     previewModalData.preview.templateInfo.type === 'details' ? 'Detaily' : 'KombinovanÃ©'}
                  </PreviewBadge>
                </PreviewFieldValue>
              </PreviewField>
              <PreviewField>
                <PreviewFieldLabel>VytvoÅ™ena:</PreviewFieldLabel>
                <PreviewFieldValue>{previewModalData.preview.templateInfo.created}</PreviewFieldValue>
              </PreviewField>
              <PreviewField>
                <PreviewFieldLabel>Dostupnost:</PreviewFieldLabel>
                <PreviewFieldValue>
                  {previewModalData.preview.templateInfo.isGlobal ? 'GlobÃ¡lnÃ­ kontakt' : 'OsobnÃ­ kontakt'}
                </PreviewFieldValue>
              </PreviewField>
            </PreviewSection>

            {/* PO Approval Section */}
            {previewModalData.preview.poApproval && (
              <PreviewSection>
                <PreviewSectionTitle>
                  <CheckCircle size={16} />
                  SchvÃ¡lenÃ­ nÃ¡kupu
                </PreviewSectionTitle>
                {previewModalData.preview.poApproval.predmet && (
                  <PreviewField>
                    <PreviewFieldLabel>PÅ™edmÄ›t:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.poApproval.predmet}</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.poApproval.maxCena && (
                  <PreviewField>
                    <PreviewFieldLabel>Max. cena s DPH:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.poApproval.maxCena} KÄ</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.poApproval.popisPozadavku && (
                  <PreviewField>
                    <PreviewFieldLabel>Popis poÅ¾adavku:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.poApproval.popisPozadavku}</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.poApproval.strediska.length > 0 && (
                  <PreviewField>
                    <PreviewFieldLabel>StÅ™ediska:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.poApproval.strediska.length} vybrÃ¡no</PreviewFieldValue>
                  </PreviewField>
                )}
              </PreviewSection>
            )}

            {/* Order Details Section */}
            {previewModalData.preview.orderDetails && (
              <PreviewSection>
                <PreviewSectionTitle>
                  <Package size={16} />
                  Detaily objednÃ¡vky
                </PreviewSectionTitle>
                {previewModalData.preview.orderDetails.dodavatelNazev && (
                  <PreviewField>
                    <PreviewFieldLabel>Dodavatel:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.orderDetails.dodavatelNazev}</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.orderDetails.dodavatelIco && (
                  <PreviewField>
                    <PreviewFieldLabel>IÄŒO:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.orderDetails.dodavatelIco}</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.orderDetails.zpusobFinancovani && (
                  <PreviewField>
                    <PreviewFieldLabel>FinancovÃ¡nÃ­:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.orderDetails.zpusobFinancovani}</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.orderDetails.datumDodani && (
                  <PreviewField>
                    <PreviewFieldLabel>Datum dodÃ¡nÃ­:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.orderDetails.datumDodani}</PreviewFieldValue>
                  </PreviewField>
                )}
                {previewModalData.preview.orderDetails.poznamka && (
                  <PreviewField>
                    <PreviewFieldLabel>PoznÃ¡mka:</PreviewFieldLabel>
                    <PreviewFieldValue>{previewModalData.preview.orderDetails.poznamka}</PreviewFieldValue>
                  </PreviewField>
                )}
              </PreviewSection>
            )}

            {/* Items Section */}
            {previewModalData.preview.items.length > 0 && (
              <PreviewSection>
                <PreviewSectionTitle>
                  <ShoppingCart size={16} />
                  PoloÅ¾ky ({previewModalData.preview.items.length})
                </PreviewSectionTitle>
                <PreviewItemsList>
                  {previewModalData.preview.items.slice(0, 5).map((item, index) => (
                    <PreviewItem key={index}>
                      <PreviewItemTitle>
                        {item.index}. {item.popis || 'Bez popisu'}
                      </PreviewItemTitle>
                      <PreviewItemDetails>
                        <span>{item.pocet}Ã— {item.cenaJednotka} KÄ/{item.jednotka || 'ks'}</span>
                        <strong>{item.cenaTotal.toLocaleString('cs-CZ')} KÄ</strong>
                      </PreviewItemDetails>
                    </PreviewItem>
                  ))}
                  {previewModalData.preview.items.length > 5 && (
                    <PreviewEmptyState>
                      ... a dalÅ¡Ã­ch {previewModalData.preview.items.length - 5} poloÅ¾ek
                    </PreviewEmptyState>
                  )}
                  {previewModalData.preview.items.length > 0 && (
                    <PreviewField style={{ marginTop: '0.75rem', paddingTop: '0.75rem', borderTop: '2px solid #f3f4f6' }}>
                      <PreviewFieldLabel>CelkovÃ¡ cena:</PreviewFieldLabel>
                      <PreviewFieldValue style={{ fontWeight: 'bold', color: '#059669' }}>
                        {previewModalData.preview.items.reduce((sum, item) => sum + item.cenaTotal, 0).toLocaleString('cs-CZ')} KÄ
                      </PreviewFieldValue>
                    </PreviewField>
                  )}
                </PreviewItemsList>
              </PreviewSection>
            )}

            {/* Empty State */}
            {!previewModalData.preview.poApproval && !previewModalData.preview.orderDetails && previewModalData.preview.items.length === 0 && (
              <PreviewEmptyState>
                Tato Å¡ablona neobsahuje Å¾Ã¡dnÃ¡ data
              </PreviewEmptyState>
            )}
          </PreviewContent>
        </PreviewModal>,
        document.body
      )}

      {/* Cancel Confirm Modal - GRADIENT-MODERN ORANGE style */}
      <ConfirmDialog
        isOpen={showCancelConfirmModal}
        onClose={handleCancelCancel}
        onConfirm={handleCancelConfirm}
        title="ZavÅ™Ã­t formulÃ¡Å™"
        icon={faExclamationTriangle}
        variant="warning"
        confirmText="Ano, zavÅ™Ã­t"
        cancelText="Ne, zÅ¯stat"
      >
        {cancelWarningMessage || 'Koncept bude zruÅ¡en a neuloÅ¾enÃ© zmÄ›ny nebudou uloÅ¾eny.'}
      </ConfirmDialog>

    {/* ðŸ—‘ï¸ Confirm Dialog pro smazÃ¡nÃ­ pÅ™Ã­lohy - GRADIENT-MODERN RED */}
    <ConfirmDialog
      isOpen={showDeleteAttachmentDialog}
      onClose={handleCancelDeleteAttachment}
      onConfirm={handleConfirmDeleteAttachment}
      title="Smazat pÅ™Ã­lohu"
      icon={faTrash}
      variant="danger"
      confirmText="Ano, smazat"
      cancelText="ZruÅ¡it"
    >
      <p>Opravdu chcete smazat <strong>"{attachmentToDelete?.attachment?.name || 'tento soubor'}"</strong>?</p>
      {attachmentToDelete?.isFromServer && (
        <p style={{ 
          background: 'linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%)', 
          padding: '0.75rem', 
          borderRadius: '6px', 
          border: '1px solid rgba(239, 68, 68, 0.2)',
          color: '#991b1b',
          fontSize: '0.9rem',
          margin: '0.75rem 0' 
        }}>
          <strong>âš ï¸ Pozor:</strong> Po smazÃ¡nÃ­ jiÅ¾ nebude moÅ¾nÃ© soubor obnovit.
        </p>
      )}
    </ConfirmDialog>

    {/* ðŸ—‘ï¸ Confirm Dialog pro smazÃ¡nÃ­ VÅ ECH pÅ™Ã­loh - GRADIENT-MODERN RED */}
    <ConfirmDialog
      isOpen={showDeleteAllAttachmentsDialog}
      onClose={handleCancelDeleteAllAttachments}
      onConfirm={handleConfirmDeleteAllAttachments}
      title="Smazat vÅ¡echny pÅ™Ã­lohy"
      icon={faTrash}
      variant="danger"
      confirmText="Ano, smazat vÅ¡e"
      cancelText="ZruÅ¡it"
    >
      <p>Opravdu chcete smazat <strong>vÅ¡echny pÅ™Ã­lohy ({attachments.length} souborÅ¯)</strong>?</p>
      <p style={{ 
        background: 'linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%)', 
        padding: '0.75rem', 
        borderRadius: '6px', 
        border: '1px solid rgba(239, 68, 68, 0.2)',
        color: '#991b1b',
        fontSize: '0.9rem',
        margin: '0.75rem 0' 
      }}>
        <strong>âš ï¸ Pozor:</strong> Tato akce odstranÃ­ vÅ¡echny nahranÃ© soubory. Operaci nelze vrÃ¡tit zpÄ›t.
      </p>
    </ConfirmDialog>

    {/* ðŸ—‘ï¸ Confirm Dialog pro smazÃ¡nÃ­ faktury - GRADIENT-MODERN RED */}
    <ConfirmDialog
      isOpen={deleteFacturaDialog.isOpen}
      onClose={() => setDeleteFacturaDialog({ isOpen: false, fakturaId: null, fakturaNazev: '', pocetPriloh: 0 })}
      onConfirm={confirmDeleteFaktura}
      title="Smazat fakturu"
      icon={faTrash}
      variant="danger"
      confirmText="Smazat"
      cancelText="ZruÅ¡it"
    >
      <p>Opravdu chcete smazat fakturu <strong>"{deleteFacturaDialog.fakturaNazev}"</strong>?</p>
      {deleteFacturaDialog.pocetPriloh > 0 && (
        <p style={{ background: '#fee2e2', padding: '0.75rem', borderRadius: '6px', border: '1px solid #ef4444', margin: '0.75rem 0' }}>
          <strong>âš ï¸ POZOR:</strong> Faktura mÃ¡ <strong>{deleteFacturaDialog.pocetPriloh} pÅ™Ã­lohu/pÅ™Ã­loh</strong>, kterÃ© budou takÃ© smazÃ¡ny!
        </p>
      )}
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ FÃZE 1 sekcÃ­ - GRADIENT-MODERN RED */}
    <ConfirmDialog
      isOpen={showUnlockPhase1Confirm}
      onClose={() => setShowUnlockPhase1Confirm(false)}
      onConfirm={() => {
        setShowUnlockPhase1Confirm(false);
        handleResetToPhase1();
      }}
      title="âš ï¸ Odemknout FÃZI 2 (Info o objednateli)"
      icon={faExclamationTriangle}
      variant="danger"
      confirmText="ANO, ODEMKNOUT A SMAZAT"
      cancelText="ZruÅ¡it"
    >
      <p style={{ background: '#fee2e2', padding: '0.75rem', borderRadius: '6px', border: '1px solid #ef4444', margin: '0.75rem 0' }}>
        <strong>âš ï¸ VAROVÃNÃ:</strong> OdemÄenÃ­ FÃZE 2 vymaÅ¾e <strong>vÅ¡echna data vyÅ¡Å¡Ã­ch fÃ¡zÃ­ (FÃZE 3-10)</strong>!
      </p>
      <p>Workflow se resetuje na stav <strong>ODESLÃNA KE SCHVÃLENÃ</strong>.</p>
      <p><strong>Opravdu chcete pokraÄovat?</strong></p>
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ zamÃ­tnutÃ© objednÃ¡vky */}
    <ConfirmDialog
      isOpen={showUnlockPhase2Confirm}
      onClose={() => setShowUnlockPhase2Confirm(false)}
      onConfirm={() => {
        setShowUnlockPhase2Confirm(false);
        handleResetToPhase3Sections();
      }}
      title="Odemknout zamÃ­tnutou objednÃ¡vku"
      icon={faExclamationTriangle}
      variant="danger"
      confirmText="Ano, odemknout"
      cancelText="ZruÅ¡it"
    >
      <p>Opravdu chcete odemknout zamÃ­tnutou objednÃ¡vku?</p>
      <p style={{ marginTop: '0.5rem', color: '#dc2626' }}>
        <strong>âš ï¸ UPOZORNÄšNÃ:</strong> ObjednÃ¡vka bude odemÄena a zpÅ™Ã­stupnÄ›na pro dalÅ¡Ã­ prÅ¯bÄ›h workflow.
      </p>
      <p style={{ marginTop: '0.5rem' }}>
        Budete moci provÃ©st potÅ™ebnÃ© Ãºpravy a objednÃ¡vku znovu odeslat ke schvÃ¡lenÃ­.
      </p>
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ FÃZE 3 sekce */}
    <ConfirmDialog
      isOpen={showUnlockPhase3Confirm}
      onClose={() => setShowUnlockPhase3Confirm(false)}
      onConfirm={() => {
        setShowUnlockPhase3Confirm(false);
        handleResetToPhase3Workflow(); // âœ… Reset workflow + vymazÃ¡nÃ­ dat + uloÅ¾enÃ­ do DB
      }}
      title="âš ï¸ Odemknout FÃZE 3"
      icon={faExclamationTriangle}
      variant="danger"
      confirmText="ANO, ODEMKNOUT A SMAZAT"
      cancelText="ZruÅ¡it"
    >
      <div style={{
        display: 'flex',
        gap: '12px',
        padding: '12px',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        border: '1px solid rgba(239, 68, 68, 0.3)',
        borderRadius: '6px',
        marginBottom: '1rem'
      }}>
        <FontAwesomeIcon icon={faExclamationTriangle} style={{ color: '#ef4444', fontSize: '20px', marginTop: '2px' }} />
        <div>
          <strong>VarovÃ¡nÃ­:</strong> OdemÄenÃ­ FÃZE 3 vymaÅ¾e vÅ¡echna data vyÅ¡Å¡Ã­ch fÃ¡zÃ­ (FÃZE 4-10)!
        </div>
      </div>
      <p>
        Workflow se resetuje na stav <strong>ODESLÃNA</strong>.
      </p>
      <p style={{ marginTop: '0.5rem' }}>
        Opravdu chcete pokraÄovat?
      </p>
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ sekce Registr smluv */}
    <ConfirmDialog
      isOpen={showUnlockRegistrConfirm}
      onClose={() => setShowUnlockRegistrConfirm(false)}
      onConfirm={() => {
        setShowUnlockRegistrConfirm(false);
        workflowManager.unlockSection('registr_vyplneni'); // âœ… Odemknout sekci vyplnÄ›nÃ­ registru (FÃZE 5)

        // âœ… Nastavit workflow na FÃZI 5 - UVEREJNIT
        const currentStates = Array.isArray(formData.stav_workflow_kod)
          ? formData.stav_workflow_kod
          : (formData.stav_workflow_kod ? [formData.stav_workflow_kod] : []);

        // Odebrat UVEREJNENA (pokud existuje) a pÅ™idat UVEREJNIT
        const updatedStates = currentStates.filter(s => s !== 'UVEREJNENA');
        if (!updatedStates.includes('UVEREJNIT')) {
          updatedStates.push('UVEREJNIT');
        }

        // Ujistit se, Å¾e jsou tam zÃ¡kladnÃ­ stavy pro FÃZI 5
        if (!updatedStates.includes('ODESLANA')) updatedStates.push('ODESLANA');
        if (!updatedStates.includes('POTVRZENA')) updatedStates.push('POTVRZENA');

        setFormData(prev => ({
          ...prev,
          stav_workflow_kod: updatedStates
        }));

        addDebugLog('info', 'UNLOCK', 'registr-vyplneni', 'OdemÄena sekce Registr smluv - nastaveno UVEREJNIT (FÃZE 5)');

        // OkamÅ¾itÃ© uloÅ¾enÃ­
        setTimeout(() => {
          triggerAutosave(true);
        }, 100);
      }}
      title="Odemknout sekci Registr smluv"
      icon={faExclamationTriangle}
      variant="danger"
      confirmText="Odemknout"
      cancelText="ZruÅ¡it"
    >
      <p>
        Opravdu chcete odemknout sekci <strong>Registr smluv</strong> pro editaci?
      </p>
      <p style={{ marginTop: '0.5rem' }}>
        Workflow se nastavÃ­ na FÃZI 5 se stavem <strong>UVEREJNIT</strong>.
      </p>
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ sekce PotvrzenÃ­ od dodavatele */}
    <ConfirmDialog
      isOpen={showUnlockPotvrzeniConfirm}
      title="Odemknout sekci PotvrzenÃ­ od dodavatele"
      confirmText="Ano, odemknout"
      cancelText="ZruÅ¡it"
      variant="warning"
      icon={faExclamationTriangle}
      onConfirm={() => {
        setShowUnlockPotvrzeniConfirm(false);
        workflowManager.unlockSection('potvrzeni');
        workflowManager.unlockSection('registr'); // âœ… TakÃ© odemknout sekci Registr smluv

        // âœ… VrÃ¡tit workflow na ODESLANA (FÃZE 4)
        const { updatedFormData } = workflowManager.unlockPhase4();
        setFormData(updatedFormData);

        resetHigherPhaseCheckboxes('potvrzeni'); // Reset vyÅ¡Å¡Ã­ch checkboxÅ¯

        // OkamÅ¾itÃ© uloÅ¾enÃ­
        setTimeout(() => {
          triggerAutosave(true);
        }, 100);
      }}
      onClose={() => setShowUnlockPotvrzeniConfirm(false)}
    >
      <p>Opravdu chcete odemknout sekci <strong>PotvrzenÃ­ od dodavatele</strong> pro editaci?</p>
      <p style={{ marginTop: '0.5rem' }}>
        ZÃ¡roveÅˆ bude odemÄena i sekce <strong>Registr smluv</strong> a workflow se vrÃ¡tÃ­ na stav <strong>ODESLÃNA (FÃZE 4)</strong>.
      </p>
    </ConfirmDialog>

    {/* âŒ Confirm Dialog pro zruÅ¡enÃ­ zveÅ™ejnÄ›nÃ­ */}
    <ConfirmDialog
      isOpen={showCancelPublishConfirm}
      title="ZruÅ¡it zveÅ™ejnÄ›nÃ­ v registru smluv"
      confirmText="Ano, odÅ¡krtnout"
      cancelText="Ne, ponechat zaÅ¡krtnutÃ©"
      variant="danger"
      icon={faExclamationTriangle}
      onConfirm={() => {
        setShowCancelPublishConfirm(false);
        handleInputChange('ma_byt_zverejnena', false);
        handleInputChange('dt_zverejneni', '');
        handleInputChange('registr_iddt', '');
        handleInputChange('zverejnil_id', null);
        addDebugLog('info', 'REGISTR', 'zrusit-zverejneni', 'ZruÅ¡ena povinnost zveÅ™ejnÄ›nÃ­');
      }}
      onClose={() => setShowCancelPublishConfirm(false)}
    >
      <div>
        <p style={{ marginBottom: '1rem' }}>
          CelkovÃ¡ cena objednÃ¡vky je <strong>{celkovaCenaBezDPH.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} KÄ bez DPH</strong>, coÅ¾ je nad limitem 50 000 KÄ.
        </p>
        <p style={{
          fontSize: '0.95rem',
          color: '#dc2626',
          fontWeight: '600',
          marginBottom: '0.75rem',
          padding: '0.75rem',
          backgroundColor: '#fee2e2',
          borderRadius: '6px',
          border: '1px solid #fca5a5'
        }}>
          âš ï¸ Podle zÃ¡kona musÃ­ bÃ½t objednÃ¡vka zveÅ™ejnÄ›na v registru smluv.
        </p>
        <p style={{
          fontSize: '0.9rem',
          color: '#6b7280',
          marginBottom: '0.5rem'
        }}>
          Opravdu chcete odÅ¡krtnout checkbox? Tato akce vymaÅ¾e vyplnÄ›nÃ© Ãºdaje:
        </p>
        <ul style={{
          fontSize: '0.9rem',
          color: '#374151',
          paddingLeft: '1.5rem',
          margin: 0
        }}>
          <li>Datum zveÅ™ejnÄ›nÃ­</li>
          <li>IdentifikÃ¡tor</li>
          <li>ZveÅ™ejnil (uÅ¾ivatel)</li>
        </ul>
      </div>
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ sekce Fakturace */}
    <ConfirmDialog
      isOpen={showUnlockFakturaceConfirm}
      title="Odemknout sekci Fakturace"
      confirmText="Odemknout"
      variant="warning"
      onConfirm={() => {
        setShowUnlockFakturaceConfirm(false);
        workflowManager.unlockSection('fakturace');

        // âœ… Odebrat FAKTURACE + VÅ E CO NÃSLEDUJE â†’ nÃ¡vrat na FÃZI 6
        const currentStates = Array.isArray(formData.stav_workflow_kod)
          ? formData.stav_workflow_kod
          : (formData.stav_workflow_kod ? [formData.stav_workflow_kod] : []);

        // Odebrat FAKTURACE a vÅ¡echny vyÅ¡Å¡Ã­ stavy
        const updatedStates = currentStates.filter(s =>
          !['FAKTURACE', 'VECNA_SPRAVNOST', 'ZKONTROLOVANA', 'DOKONCENA'].includes(s)
        );

        setFormData(prev => ({
          ...prev,
          stav_workflow_kod: updatedStates
        }));

        addDebugLog('info', 'UNLOCK', 'fakturace', 'OdemÄena sekce Fakturace - odebrÃ¡ny stavy FAKTURACE, KONTROLA, ZKONTROLOVANA, DOKONCENA â†’ FÃZE 6/8');

        // ðŸ”„ Reset vyÅ¡Å¡Ã­ch checkboxÅ¯
        resetHigherPhaseCheckboxes('fakturace');

        // OkamÅ¾itÃ© uloÅ¾enÃ­
        setTimeout(() => {
          triggerAutosave(true);
        }, 100);
      }}
      onClose={() => setShowUnlockFakturaceConfirm(false)}
    >
      <p>Opravdu chcete odemknout sekci <strong>Fakturace</strong> pro editaci?</p>
      <p style={{ marginTop: '0.5rem', color: '#dc2626' }}>
        Budou odebrÃ¡ny stavy <strong>FAKTURACE, VECNA_SPRAVNOST, ZKONTROLOVANA, DOKONCENA</strong> a workflow se vrÃ¡tÃ­ na <strong>FÃZI 6/8</strong>.
      </p>
    </ConfirmDialog>

    {/* âŒ DISABLED: Confirm Dialog pro odemÄenÃ­ sekce VÄ›cnÃ¡ sprÃ¡vnost - jiÅ¾ nenÃ­ potÅ™eba */}

    {/* ðŸ”“ Confirm Dialog pro odemÄenÃ­ DokonÄenÃ© objednÃ¡vky (pro ORDER_MANAGE) */}
    <ConfirmDialog
      isOpen={showUnlockDokonceniConfirm}
      title="Odemknout dokonÄenou objednÃ¡vku"
      confirmText="Ano, odemknout"
      cancelText="ZruÅ¡it"
      variant="warning"
      icon={faExclamationTriangle}
      onConfirm={() => {
        setShowUnlockDokonceniConfirm(false);

        addDebugLog('info', 'UNLOCK', 'dokonceni', 'ðŸ”“ DokonÄenÃ¡ objednÃ¡vka odemÄena');


        // âœ… Upravit workflow: odebrat DOKONCENA, zachovat vÅ¡e ostatnÃ­
        const currentWorkflow = formData.stav_workflow_kod || '';
        let workflowArray;
        
        if (Array.isArray(currentWorkflow)) {
          workflowArray = [...currentWorkflow];
        } else {
          workflowArray = String(currentWorkflow).split(',').map(s => s.trim()).filter(s => s);
        }
        
        // Odebrat pouze DOKONCENA
        workflowArray = workflowArray.filter(s => s !== 'DOKONCENA');
        
        // Zajistit ZKONTROLOVANA
        if (!workflowArray.includes('ZKONTROLOVANA')) {
          workflowArray.push('ZKONTROLOVANA');
        }


        // âœ… Nastavit novÃ½ state
        setFormData(prev => ({
          ...prev,
          potvrzeni_dokonceni_objednavky: 0,
          vecna_spravnost_potvrzeno: 1,
          stav_workflow_kod: workflowArray
        }));

        // âœ… VEÅ KERÃ‰ ODEMÄŒENÃ PÅ˜ES WORKFLOW MANAGER
        workflowManager.unlockSection('dokonceni');
        workflowForceRefresh(); // Force pÅ™epoÄet vÅ¡ech sekcÃ­ a stavÅ¯

        addDebugLog('info', 'UNLOCK', 'completed', `âœ… ObjednÃ¡vka odemÄena (workflow manager refresh)`);
      }}
      onClose={() => setShowUnlockDokonceniConfirm(false)}
    >
      <p>Opravdu chcete odemknout dokonÄenou objednÃ¡vku?</p>
      <p style={{ marginTop: '0.5rem', color: '#16a34a' }}>
        <strong>âš ï¸ UPOZORNÄšNÃ:</strong> ObjednÃ¡vka bude zpÅ™Ã­stupnÄ›na k ÃºpravÃ¡m a opravÃ¡m.
      </p>
    </ConfirmDialog>

    {/* ðŸ”“ Confirm Dialog pro odemknutÃ­ stornovanÃ© objednÃ¡vky */}
    <ConfirmDialog
      isOpen={showUnlockStornoConfirm}
      title="Odemknout stornovanou objednÃ¡vku"
      confirmText="Ano, odemknout"
      cancelText="ZruÅ¡it"
      variant="danger"
      icon={faExclamationTriangle}
      onConfirm={async () => {
        setShowUnlockStornoConfirm(false);
        
        addDebugLog('info', 'UNLOCK', 'cancelled', `ðŸ”“ OdemykÃ¡m stornovanou objednÃ¡vku ID: ${formData.id}`);
        
        // Odebrat ZRUSENA stav z workflow
        const updatedWorkflow = (formData.stav_workflow_kod || '')
          .split(',')
          .filter(s => s.trim() !== 'ZRUSENA')
          .join(',');
        
        // Vymazat storno data
        const clearedData = {
          ...formData,
          stav_workflow_kod: updatedWorkflow,
          storno_duvod: null,
          storno_user_id: null,
          dt_storno: null,
          stav_stornovano: 0
        };
        
        // UloÅ¾it do DB pÅ™es useWorkflowManager
        await workflowManager.unlockSection('storno');
        
        // Force update form data
        setFormData(clearedData);
        workflowForceRefresh();
        
        addDebugLog('info', 'UNLOCK', 'cancelled', `âœ… StornovanÃ¡ objednÃ¡vka odemÄena, workflow refresh dokonÄen`);
      }}
      onClose={() => setShowUnlockStornoConfirm(false)}
    >
      <p>Opravdu chcete odemknout stornovanou objednÃ¡vku?</p>
      <p style={{ marginTop: '0.5rem', color: '#16a34a' }}>
        <strong>âš ï¸ UPOZORNÄšNÃ:</strong> ObjednÃ¡vka bude odemÄena a zpÅ™Ã­stupnÄ›na pro dalÅ¡Ã­ prÅ¯bÄ›h workflow.
      </p>
      <p style={{ marginTop: '0.5rem' }}>
        Budete moci provÃ©st potÅ™ebnÃ© Ãºpravy nebo opravy.
      </p>
    </ConfirmDialog>

    {/* ðŸ”“ UniverzÃ¡lnÃ­ Confirm Dialog (pro Phase unlock handlery) */}
    {confirmDialog.isOpen && (
      <ConfirmDialog
        isOpen={confirmDialog.isOpen}
        title={confirmDialog.title}
        message={confirmDialog.message}
        confirmText="Ano, odemknout"
        cancelText="ZruÅ¡it"
        variant="danger"
        icon={faExclamationTriangle}
        onConfirm={() => {
          if (confirmDialog.onConfirm) {
            confirmDialog.onConfirm();
          }
          setConfirmDialog({ isOpen: false, title: '', message: '', onConfirm: null });
        }}
        onClose={() => setConfirmDialog({ isOpen: false, title: '', message: '', onConfirm: null })}
      />
    )}

    {/* ðŸ¢ Dialog pro pÅ™idÃ¡nÃ­ dodavatele do adresÃ¡Å™e */}
    <SupplierAddDialog
      isOpen={showSupplierAddDialog}
      onClose={() => {
        setShowSupplierAddDialog(false);
        setExistingSupplierCheck(null);
      }}
      onSave={handleSaveSupplierToDirectory}
      supplierData={{
        dodavatel_nazev: formData.dodavatel_nazev,
        dodavatel_adresa: formData.dodavatel_adresa,
        dodavatel_ico: formData.dodavatel_ico,
        dodavatel_dic: formData.dodavatel_dic,
        dodavatel_zastoupeny: formData.dodavatel_zastoupeny,
        dodavatel_kontakt_jmeno: formData.dodavatel_kontakt_jmeno,
        dodavatel_kontakt_email: formData.dodavatel_kontakt_email,
        dodavatel_kontakt_telefon: formData.dodavatel_kontakt_telefon
      }}
      existsInPersonal={existingSupplierCheck?.existsInPersonal || null}
      existsInUsek={existingSupplierCheck?.existsInUsek || null}
      existsInGlobal={existingSupplierCheck?.existsInGlobal || null}
      userPermissions={{
        canAddPersonal: hasPermission && (hasPermission('CONTACT_MANAGE') || hasPermission('CONTACT_EDIT')), // CONTACT_MANAGE nebo CONTACT_EDIT
        canAddUsek: hasPermission && (hasPermission('CONTACT_MANAGE') || hasPermission('CONTACT_EDIT')), // CONTACT_MANAGE nebo CONTACT_EDIT pro svÃ© Ãºseky
        canAddGlobal: hasPermission && hasPermission('CONTACT_MANAGE') // Pouze CONTACT_MANAGE
      }}
    />

    {/* ðŸ’¡ ModernÃ­ Sponka helper - kontextovÃ¡ nÃ¡povÄ›da pro formulÃ¡Å™ objednÃ¡vky */}
    {hasPermission('HELPER_VIEW') && (
      <ModernHelper
        pageContext="orderDetail"
      />
    )}

    {/* ðŸ“„ DOCX Generator Modal - Lazy loaded for better performance */}
    {docxModalOpen && (
      <Suspense fallback={<div>NaÄÃ­tÃ¡nÃ­ DOCX generÃ¡toru...</div>}>
        <DocxGeneratorModal
          order={docxModalOrder}
          isOpen={docxModalOpen}
          onClose={handleDocxModalClose}
        />
      </Suspense>
    )}

    {/* ðŸ’¾ Save Overlay - rozmaÅ¾e zbytek strÃ¡nky pÅ™i uklÃ¡dÃ¡nÃ­ (kromÄ› hlaviÄky s progress barem) */}
    {(showSaveProgress || isSaving) && (
      <SaveOverlay $visible={true} />
    )}

    </Container>
  );

  // Pokud je fullscreen, pouÅ¾Ã­t React Portal pro vykreslenÃ­ mimo app strukturu
  if (isFullscreen) {
    return ReactDOM.createPortal(formContent, document.body);
  }

  // NormÃ¡lnÃ­ render
  return formContent;
}

// Obal OrderForm25 v React.memo() pro optimalizaci re-renderÅ¯
// ZabraÅˆuje zbyteÄnÃ½m re-renderÅ¯m kdyÅ¾ se props nemÄ›nÃ­
export default React.memo(OrderForm25);

// ========================================
// NOVÃ‰ STABILNÃ CUSTOM SELECT KOMPONENTY
// ========================================

// NovÃ© styled komponenty pro stabilnÃ­ custom select
const StableSelectWrapper = styled.div`
  position: relative;
  width: 100%;
`;

const StableSelectButton = styled.button`
  width: 100%;
  min-height: 2.5rem;
  padding: 0.75rem 3rem 0.75rem ${props => props.hasIcon ? '3rem' : '1rem'};
  background: white;
  border: 2px solid ${props => props.hasError ? '#dc2626' : props.isOpen ? '#3b82f6' : '#e5e7eb'};
  border-radius: 8px;
  font-size: 0.875rem;
  text-align: left;
  cursor: ${props => props.disabled ? 'not-allowed' : 'pointer'};
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-family: inherit;
  font-weight: ${props => props.disabled ? '400' : (props.hasValue ? '600' : '400')};
  color: ${props => props.disabled ? '#9ca3af' : props.hasValue ? '#1f2937' : '#6b7280'};

  &:hover:not(:disabled) {
    border-color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
  }

  &:focus {
    outline: none;
    border-color: ${props => props.hasError ? '#dc2626' : '#3b82f6'};
    box-shadow: 0 0 0 3px ${props => props.hasError ? 'rgba(220, 38, 38, 0.1)' : 'rgba(59, 130, 246, 0.1)'};
  }

  &:disabled {
    background: #f9fafb;
    cursor: not-allowed;
  }

  /* Chevron ikona */
  &::after {
    content: '';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%) rotate(${props => props.isOpen ? '180deg' : '0deg'});
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 4px solid #6b7280;
    transition: transform 0.2s ease;
  }
`;

const StableSelectDropdown = styled.div`
  position: fixed;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  max-height: 300px;
  overflow-y: auto;
  z-index: 4000;
  min-width: 200px;

  /* Optimalizace pro plynulÃ© scrollovÃ¡nÃ­ */
  scroll-behavior: smooth;
  overscroll-behavior: contain;

  &::-webkit-scrollbar {
    width: 8px;
  }

  &::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }

  &::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
`;

const StableSelectSearchBox = styled.div`
  position: sticky;
  top: 0;
  z-index: 10;
  padding: 0.5rem;
  border-bottom: 1px solid #f3f4f6;
  background: #f8f9fa;
`;

const StableSelectSearchInput = styled.input`
  width: 100%;
  padding: 0.5rem 0.75rem 0.5rem 2.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  font-size: 0.875rem;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }
`;

const StableSelectSearchIcon = styled.div`
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  pointer-events: none;
`;

const StableSelectOption = styled.div`
  padding: ${props => props.level === 0 ? '0.75rem 1rem' : '0.5rem 1rem 0.5rem 2rem'};
  cursor: ${props => props.isHeader ? 'default' : 'pointer'};
  font-size: 0.875rem;
  color: ${props => props.level === 0 ? '#111827' : '#4b5563'};
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: ${props =>
    props.isHeader ? '#f9fafb' :
    props.selected ? '#eff6ff' : 'white'
  };
  border-left: ${props => props.selected ? '3px solid #3b82f6' : '3px solid transparent'};
  border-bottom: ${props => props.level === 0 ? '1px solid #e5e7eb' : 'none'};
  font-weight: ${props => props.selected ? '600' : '400'} !important; /* Bold jen pro vybranou moÅ¾nost */
  /* Focusable pro tab navigaci */
  outline: none;

  &:hover {
    background: ${props =>
      props.isHeader ? '#f3f4f6' :
      props.selected ? '#dbeafe' : '#f8fafc'
    };
    font-weight: ${props => props.selected ? '600' : '400'} !important; /* ZÅ¯stÃ¡vÃ¡ stejnÃ© i pÅ™i hover */
  }

  &:focus {
    background: #dbeafe;
    box-shadow: inset 0 0 0 2px #3b82f6;
  }

  &:last-child {
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
  }

  span {
    padding-left: ${props => (props.level || 0) * 20}px;
    font-weight: ${props => props.selected ? '600' : '400'} !important; /* Bold jen pro vybranou moÅ¾nost */
  }
`;

const StableSelectValue = styled.span`
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`;

// Helper funkce pro normalizaci textu (odstranÄ›nÃ­ diakritiky pro vyhledÃ¡vÃ¡nÃ­)
const normalizeSearchText = (text) => {
  if (!text) return '';
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');
};

// NovÃ½ stabilnÃ­ CustomSelect s jednoduchÃ½m state managementem
const StableCustomSelect = React.memo(({
  value,
  onChange,
  onBlur,
  options = [],
  placeholder = "Vyberte...",
  disabled = false,
  hasError = false,
  required = false,
  field,
  loading = false,
  loadingText = 'NaÄÃ­tÃ¡nÃ­...',
  icon = null,
  multiple = false,
  isClearable = false,
  getOptionLabel,
  getOptionValue,
  hasTriedToSubmit = false
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [internalScroll, setInternalScroll] = useState(0);

  const wrapperRef = useRef(null);
  const buttonRef = useRef(null);
  const dropdownRef = useRef(null);
  const searchInputRef = useRef(null);
  const voiceInputFlagRef = useRef(false); // Flag pro hlasovÃ½ vstup

  // ZpracovÃ¡nÃ­ hodnot
  const normalizedValue = multiple ? (Array.isArray(value) ? value : []) : value;

  // FiltrovanÃ© moÅ¾nosti
  const filteredOptions = useMemo(() => {
    if (!searchTerm || loading) return options;

    // Normalizace hledanÃ©ho textu (bez diakritiky)
    const normalizedSearch = normalizeSearchText(searchTerm);

    return options.filter(option => {
      let label;
      if (getOptionLabel) {
        label = getOptionLabel(option, field);
      } else {
        // Fallback pro rÅ¯znÃ© typy objektÅ¯
        if (field === 'strediska' || field === 'strediska_kod') {
          label = option.label || option.name || option.nazev_stavu || String(option);
        } else if (field === 'lp_kod') {
          label = option.cislo_lp ? `${option.cislo_lp} - ${option.nazev_uctu || ''}` : option.label || String(option);
        } else {
          label = option.label || option.nazev || option.name || String(option);
        }
      }

      // Normalizace labelu (bez diakritiky) pro porovnÃ¡nÃ­
      const normalizedLabel = normalizeSearchText(label);
      return normalizedLabel.includes(normalizedSearch);
    });
  }, [options, searchTerm, loading, getOptionLabel, field]);

  // Display hodnota
  const displayValue = useMemo(() => {
    if (multiple) {
      if (normalizedValue.length === 0) return placeholder;

      const result = normalizedValue.map(val => {
        const option = options.find(opt => {
          const optVal = getOptionValue ? getOptionValue(opt, field) : (opt.id || opt.value || opt.kod_stavu || opt.kod || opt);
          // OPRAVA: PorovnÃ¡nÃ­ i pro string vs number (napÅ™. '26' vs 26)
          return optVal == val;
        });

        if (option) {
          // PouÅ¾ij externÃ­ getOptionLabel funkci nebo fallback
          if (getOptionLabel) {
            return getOptionLabel(option, field);
          }
          // Fallback pro rÅ¯znÃ© typy objektÅ¯
          if (field === 'strediska' || field === 'strediska_kod') {
            return option.label || option.name || option.nazev_stavu || String(option);
          }
          if (field === 'lp_kod') {
            // OPRAVA: PouÅ¾ij label, kterÃ½ uÅ¾ je sprÃ¡vnÄ› naformÃ¡tovanÃ½ pÅ™i naÄÃ­tÃ¡nÃ­ LP kÃ³dÅ¯
            return option.label || (option.cislo_lp ? `${option.cislo_lp} - ${option.nazev_uctu || ''}` : String(option));
          }
          return option.label || option.nazev || option.name || String(option);
        }

        return String(val);
      }).join(', ');

      return result;
    } else {
      if (!normalizedValue) return placeholder;
      const option = options.find(opt => {
        const optVal = getOptionValue ? getOptionValue(opt, field) : (opt.id || opt.value || opt.kod_stavu || opt.kod || opt);
        // OPRAVA: PorovnÃ¡nÃ­ i pro string vs number (napÅ™. '26' vs 26)
        return optVal == normalizedValue; // PouÅ¾Ã­vÃ¡me == mÃ­sto === pro type coercion
      });
      if (option) {
        if (getOptionLabel) {
          return getOptionLabel(option, field);
        }
        return option.label || option.nazev || option.name || String(option);
      }
      // Pokud nenÃ­ nalezen option a jde o prikazce nebo schvalovatel s hodnotou 0 nebo null, zobraz "NeznÃ¡mÃ½"
      if ((field === 'prikazce' || field === 'schvalovatel') && (normalizedValue === 0 || normalizedValue === null || normalizedValue === '0')) {
        return 'NeznÃ¡mÃ½';
      }
      return String(normalizedValue);
    }
  }, [normalizedValue, options, placeholder, multiple, getOptionLabel, getOptionValue, field]);

  // ZavÅ™enÃ­ pÅ™i kliknutÃ­ mimo
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
        setSearchTerm('');
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [isOpen]);

  // Auto-focus search pÅ™i otevÅ™enÃ­
  useEffect(() => {
    if (isOpen && searchInputRef.current && filteredOptions.length > 0) {
      setTimeout(() => searchInputRef.current?.focus(), 100);
    }
  }, [isOpen, filteredOptions.length]);

  // Detekce hlasovÃ©ho vstupu (nastaveno v useGlobalVoiceRecognition.js)
  useEffect(() => {
    if (!wrapperRef.current) return;

    const checkVoiceInputAttribute = () => {
      const hasVoiceInput = wrapperRef.current?.hasAttribute('data-voice-input');
      if (hasVoiceInput && !voiceInputFlagRef.current) {
        voiceInputFlagRef.current = true;
        // NEODSTRAÅ‡UJ atribut hned - nech ho tam pro pÅ™Ã­pad dalÅ¡Ã­ch kontrol
      }
    };

    // Kontroluj okamÅ¾itÄ›
    checkVoiceInputAttribute();

    // A takÃ© pÅ™i zmÄ›nÄ› searchTerm (voice input mÄ›nÃ­ hodnotu)
    if (searchTerm) {
      checkVoiceInputAttribute();
    }
  }, [searchTerm, field]);

  // AutomatickÃ½ vÃ½bÄ›r pÅ™i 1 vÃ½sledku po filtrovÃ¡nÃ­ (pouze pro hlasovÃ© ovlÃ¡dÃ¡nÃ­)
  useEffect(() => {
    if (isOpen && searchTerm && filteredOptions.length === 1 && !multiple && voiceInputFlagRef.current) {
      // Pokud je jen 1 vÃ½sledek po filtrovÃ¡nÃ­ A je to hlasovÃ½ vstup â†’ automaticky vyber po krÃ¡tkÃ©m delay
      const timer = setTimeout(() => {
        const option = filteredOptions[0];
        const optionValue = getOptionValue ? getOptionValue(option, field) : (option.id || option.value || option);

        // Zkontroluj, jestli uÅ¾ nenÃ­ vybranÃ¡
        if (normalizedValue !== optionValue) {
          onChange(optionValue);
          if (onBlur) onBlur(field, optionValue);
          setIsOpen(false);
          setSearchTerm('');
          voiceInputFlagRef.current = false; // Reset flag
          // OdstraÅˆ atribut po auto-vÃ½bÄ›ru
          if (wrapperRef.current) {
            wrapperRef.current.removeAttribute('data-voice-input');
          }
        }
      }, 500); // 500ms delay pro jistotu, Å¾e uÅ¾ivatel uÅ¾ nepÃ­Å¡e

      return () => clearTimeout(timer);
    }
  }, [isOpen, searchTerm, filteredOptions, multiple, getOptionValue, field, normalizedValue, onChange, onBlur]);

  // PozicovÃ¡nÃ­ dropdown
  useEffect(() => {
    if (isOpen && buttonRef.current && dropdownRef.current) {
      const updatePosition = () => {
        if (!buttonRef.current || !dropdownRef.current) return;
        const buttonRect = buttonRef.current.getBoundingClientRect();
        const dropdown = dropdownRef.current;

        const dropdownMaxHeight = 300;
        const footerHeight = 54; // VÃ½Å¡ka fixnÃ­ patiÄky
        const buffer = 20; // Extra buffer pro bezpeÄnost
        const spaceBelow = window.innerHeight - buttonRect.bottom - footerHeight - buffer;
        const spaceAbove = buttonRect.top - buffer;
        // OtevÅ™i nahoru pokud: nenÃ­ dost mÃ­sta dole NEBO je nahoÅ™e vÃ½raznÄ› vÃ­ce mÃ­sta
        const shouldOpenUpward = spaceBelow < 200 || (spaceBelow < dropdownMaxHeight && spaceAbove > spaceBelow + 50);

        dropdown.style.left = buttonRect.left + 'px';
        dropdown.style.width = buttonRect.width + 'px';
        dropdown.style.maxHeight = dropdownMaxHeight + 'px';

        if (shouldOpenUpward) {
          // OtevÅ™Ã­t nahoru
          dropdown.style.bottom = (window.innerHeight - buttonRect.top + 2) + 'px';
          dropdown.style.top = 'auto';
        } else {
          // OtevÅ™Ã­t dolÅ¯ (standardnÃ­ chovÃ¡nÃ­)
          dropdown.style.top = (buttonRect.bottom + 2) + 'px';
          dropdown.style.bottom = 'auto';
        }
      };

      updatePosition();

      const handleScroll = (event) => {
        // Neaktualizovat pÅ™i scrollu uvnitÅ™ dropdown
        if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
          updatePosition();
        }
      };

      // PouÅ¾Ã­vat capture: true pro zachycenÃ­ vÅ¡ech scroll eventÅ¯
      window.addEventListener('scroll', handleScroll, { passive: true, capture: true });
      window.addEventListener('resize', updatePosition, { passive: true });

      return () => {
        window.removeEventListener('scroll', handleScroll, { capture: true });
        window.removeEventListener('resize', updatePosition);
      };
    }
  }, [isOpen]);

  // ZachovÃ¡nÃ­ scroll pozice
  useEffect(() => {
    if (dropdownRef.current && internalScroll > 0) {
      dropdownRef.current.scrollTop = internalScroll;
    }
  }, [filteredOptions, internalScroll]);

  const handleToggle = () => {
    if (disabled) return;

    const newState = !isOpen;
    setIsOpen(newState);

    if (isOpen) {
      setSearchTerm('');
    }
  };

  const handleOptionClick = (option) => {
    // Zachovat scroll pozici
    if (dropdownRef.current) {
      setInternalScroll(dropdownRef.current.scrollTop);
    }

    const optionValue = getOptionValue ? getOptionValue(option, field) : (option.id || option.value || option);

    if (multiple) {
      const currentValues = Array.isArray(normalizedValue) ? normalizedValue : [];
      const newValues = currentValues.includes(optionValue)
        ? currentValues.filter(v => v !== optionValue)
        : [...currentValues, optionValue];

      // Pro multiselect poÅ¡li pole pÅ™Ã­mo
      onChange(newValues);
      if (onBlur) onBlur(field, newValues);
    } else {
      // Pro single select poÅ¡li hodnotu pÅ™Ã­mo
      onChange(optionValue);
      if (onBlur) onBlur(field, optionValue);
      setIsOpen(false);
      setSearchTerm('');
      // Reset voice input flag pÅ™i ruÄnÃ­m vÃ½bÄ›ru
      voiceInputFlagRef.current = false;
      if (wrapperRef.current) {
        wrapperRef.current.removeAttribute('data-voice-input');
      }
    }
  };

  const isSelected = (option) => {
    const optionValue = getOptionValue ? getOptionValue(option, field) : (option.id || option.value || option);
    return multiple
      ? normalizedValue.includes(optionValue)
      : normalizedValue === optionValue;
  };

  // AutomatickÃ¡ detekce chyby pro povinnÃ¡ pole (stejnÄ› jako v CustomSelect.js)
  const hasValue = multiple
    ? (Array.isArray(normalizedValue) && normalizedValue.length > 0)
    : !!normalizedValue;
  const shouldShowError = hasError || (required && !hasValue && !loading && !disabled && hasTriedToSubmit);

  return (
    <StableSelectWrapper ref={wrapperRef} data-stable-select data-field={field}>
      <StableSelectButton
        ref={buttonRef}
        type="button"
        onClick={handleToggle}
        disabled={disabled}
        hasError={shouldShowError}
        isOpen={isOpen}
        hasValue={hasValue}
        hasIcon={!!icon}
        data-field={field}
      >
        {icon && (
          <span style={{
            position: 'absolute',
            left: '12px',
            color: '#9ca3af',
            width: '16px',
            height: '16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            {React.cloneElement(icon, { size: 16 })}
          </span>
        )}
        <StableSelectValue title={displayValue}>
          {displayValue}
        </StableSelectValue>
        {isClearable && !disabled && hasValue && (
          <span
            role="button"
            tabIndex={0}
            onClick={(e) => {
              e.stopPropagation();
              const clearedValue = multiple ? [] : '';
              onChange(clearedValue);
            }}
            onKeyDown={(e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.stopPropagation();
                const clearedValue = multiple ? [] : '';
                onChange(clearedValue);
              }
            }}
            title="Smazat hodnotu"
            style={{
              position: 'absolute',
              right: '32px',
              top: '50%',
              transform: 'translateY(-50%)',
              background: 'none',
              border: 'none',
              padding: '4px',
              cursor: 'pointer',
              color: '#6b7280',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              width: '20px',
              height: '20px',
              borderRadius: '4px',
              transition: 'all 0.2s ease',
              zIndex: 2
            }}
            onMouseEnter={(e) => {
              e.currentTarget.style.background = '#f3f4f6';
              e.currentTarget.style.color = '#374151';
            }}
            onMouseLeave={(e) => {
              e.currentTarget.style.background = 'none';
              e.currentTarget.style.color = '#6b7280';
            }}
          >
            <X size={14} />
          </span>
        )}
      </StableSelectButton>

      {isOpen && !disabled && (
        <StableSelectDropdown ref={dropdownRef}>
          <StableSelectSearchBox>
            <StableSelectSearchIcon>
              <Search size={16} />
            </StableSelectSearchIcon>
            <StableSelectSearchInput
              ref={searchInputRef}
              type="text"
              placeholder="Vyhledat..."
              value={searchTerm}
              onChange={(e) => {
                // PÅ™i ruÄnÃ­m psanÃ­ resetuj voice flag
                if (e.nativeEvent.inputType && e.nativeEvent.inputType.startsWith('insert')) {
                  voiceInputFlagRef.current = false;
                }
                setSearchTerm(e.target.value);
              }}
              onClick={(e) => e.stopPropagation()}
              onKeyDown={(e) => {
                if (e.key === 'ArrowDown') {
                  // Å ipka dolÅ¯ - pÅ™ejdi na prvnÃ­ option
                  e.preventDefault();
                  if (filteredOptions.length > 0) {
                    const firstOption = dropdownRef.current?.querySelector('[role="option"]:not([tabindex="-1"])');
                    if (firstOption) {
                      firstOption.focus();
                    }
                  }
                } else if (e.key === 'ArrowUp') {
                  // Å ipka nahoru - pÅ™ejdi na poslednÃ­ option
                  e.preventDefault();
                  if (filteredOptions.length > 0) {
                    const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]:not([tabindex="-1"])') || []);
                    const lastOption = options[options.length - 1];
                    if (lastOption) {
                      lastOption.focus();
                    }
                  }
                } else if (e.key === 'Tab') {
                  // Pokud je dropdown otevÅ™enÃ½, pÅ™ejdi na prvnÃ­ option mÃ­sto zavÅ™enÃ­
                  if (filteredOptions.length > 0) {
                    e.preventDefault();
                    const firstOption = dropdownRef.current?.querySelector('[role="option"], [class*="SelectOption"]');
                    if (firstOption) {
                      firstOption.focus();
                    }
                  } else {
                    // Pokud nejsou Å¾Ã¡dnÃ© options, zavÅ™i dropdown a pokraÄuj na dalÅ¡Ã­ prvek
                    setIsOpen(false);
                  }
                } else if (e.key === 'Escape') {
                  e.preventDefault();
                  setIsOpen(false);
                  // VraÅ¥ focus na select button
                  if (buttonRef.current) {
                    buttonRef.current.focus();
                  }
                } else if (e.key === 'Enter') {
                  e.preventDefault();
                  e.stopPropagation();
                }
              }}
            />
          </StableSelectSearchBox>

          {loading ? (
            <StableSelectOption>{loadingText}</StableSelectOption>
          ) : filteredOptions.length > 0 ? (
            filteredOptions.map((option, index) => {
              const optionValue = getOptionValue ? getOptionValue(option, field) : (option.id || option.value || option);
              let optionLabel;

              if (getOptionLabel) {
                optionLabel = getOptionLabel(option, field);
              } else {
                // Fallback pro rÅ¯znÃ© typy objektÅ¯
                if (field === 'strediska' || field === 'strediska_kod') {
                  optionLabel = option.label || option.name || option.nazev_stavu || String(option);
                } else if (field === 'lp_kod') {
                  optionLabel = option.cislo_lp ? `${option.cislo_lp} - ${option.nazev_uctu || ''}` : option.label || String(option);
                } else {
                  optionLabel = option.label || option.nazev || option.name || String(option);
                }
              }

              const selected = isSelected(option);
              const level = option.level || 0;
              const isHeader = option.isHeader || (level === 0 && !option.value && !option.id);

              return (
                <StableSelectOption
                  key={optionValue || index}
                  selected={selected}
                  level={level}
                  isHeader={isHeader}
                  tabIndex={isHeader ? -1 : 0}
                  role="option"
                  aria-selected={selected}
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // NeumoÅ¾ni kliknout na header
                    if (!isHeader) {
                      handleOptionClick(option);
                    }
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      if (!isHeader) {
                        handleOptionClick(option);
                      }
                    } else if (e.key === 'ArrowDown') {
                      // Å ipka dolÅ¯ - pÅ™ejdi na dalÅ¡Ã­ option
                      e.preventDefault();
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]:not([tabindex="-1"])') || []);
                      const currentIdx = options.indexOf(e.target);
                      const nextIdx = currentIdx + 1;
                      if (nextIdx < options.length) {
                        options[nextIdx].focus();
                      } else {
                        // Cyklicky na zaÄÃ¡tek
                        options[0]?.focus();
                      }
                    } else if (e.key === 'ArrowUp') {
                      // Å ipka nahoru - pÅ™ejdi na pÅ™edchozÃ­ option
                      e.preventDefault();
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]:not([tabindex="-1"])') || []);
                      const currentIdx = options.indexOf(e.target);
                      const prevIdx = currentIdx - 1;
                      if (prevIdx >= 0) {
                        options[prevIdx].focus();
                      } else {
                        // Cyklicky na konec nebo zpÄ›t do search inputu
                        if (searchInputRef.current) {
                          searchInputRef.current.focus();
                        } else {
                          options[options.length - 1]?.focus();
                        }
                      }
                    } else if (e.key === 'Escape') {
                      e.preventDefault();
                      setIsOpen(false);
                      if (buttonRef.current) {
                        buttonRef.current.focus();
                      }
                    } else if (e.key === 'Tab') {
                      // Nech prohlÃ­Å¾eÄ zvlÃ¡dat tab - pÅ™ejde na dalÅ¡Ã­ option nebo zavÅ™e dropdown
                      const options = Array.from(dropdownRef.current?.querySelectorAll('[role="option"]:not([tabindex="-1"])') || []);
                      const currentIdx = options.indexOf(e.target);

                      if (e.shiftKey) {
                        // Shift+Tab - pokud jsme na prvnÃ­ option, vraÅ¥ se na search input
                        if (currentIdx === 0) {
                          e.preventDefault();
                          if (searchInputRef.current) {
                            searchInputRef.current.focus();
                          }
                        }
                      } else {
                        // Tab - pokud jsme na poslednÃ­ option, zavÅ™i dropdown a pokraÄuj dÃ¡l
                        if (currentIdx === options.length - 1) {
                          e.preventDefault();
                          setIsOpen(false);
                          // Nech hlavnÃ­ tab handler najÃ­t dalÅ¡Ã­ prvek ve formulÃ¡Å™i
                        }
                      }
                    }
                  }}
                >
                  {multiple && !isHeader && (
                    <input
                      type="checkbox"
                      checked={selected}
                      readOnly
                      onChange={() => {}} // PrÃ¡zdnÃ½ handler aby nedÃ¡val warning
                    />
                  )}
                  <span>{optionLabel}</span>
                </StableSelectOption>
              );
            })
          ) : (
            <StableSelectOption>Å½Ã¡dnÃ© vÃ½sledky</StableSelectOption>
          )}
        </StableSelectDropdown>
      )}
    </StableSelectWrapper>
  );
}, (prevProps, nextProps) => {
  // Custom comparison funkce pro React.memo
  // VracÃ­ true pokud jsou props STEJNÃ‰ (skip re-render)
  // VracÃ­ false pokud jsou props RÅ®ZNÃ‰ (provede re-render)

  // Porovnej primitivnÃ­ hodnoty
  if (prevProps.value !== nextProps.value) return false;
  if (prevProps.placeholder !== nextProps.placeholder) return false;
  if (prevProps.disabled !== nextProps.disabled) return false;
  if (prevProps.hasError !== nextProps.hasError) return false;
  if (prevProps.required !== nextProps.required) return false;
  if (prevProps.field !== nextProps.field) return false;
  if (prevProps.loading !== nextProps.loading) return false;
  if (prevProps.loadingText !== nextProps.loadingText) return false;
  if (prevProps.multiple !== nextProps.multiple) return false;
  if (prevProps.hasTriedToSubmit !== nextProps.hasTriedToSubmit) return false;

  // Porovnej arrays (options) - kontrola dÃ©lky a referencÃ­
  if (prevProps.options.length !== nextProps.options.length) return false;
  // Pro performance nekontrolujeme deep equality jednotlivÃ½ch items
  // staÄÃ­ porovnat reference pole (kterÃ© se mÄ›nÃ­ pÅ™i naÄtenÃ­ dat)
  if (prevProps.options !== nextProps.options) return false;

  // Icon mÅ¯Å¾e bÃ½t React element, takÅ¾e pouÅ¾ijeme reference check
  if (prevProps.icon !== nextProps.icon) return false;

  // onChange, onBlur, getOptionLabel, getOptionValue jsou funkce
  // Pokud jsou zmemoizovanÃ© pÅ™es useCallback, reference zÅ¯stane stejnÃ¡
  // Zde je nemÅ¯Å¾eme deep compare, tak pouÅ¾ijeme reference check
  if (prevProps.onChange !== nextProps.onChange) return false;
  if (prevProps.onBlur !== nextProps.onBlur) return false;
  if (prevProps.getOptionLabel !== nextProps.getOptionLabel) return false;
  if (prevProps.getOptionValue !== nextProps.getOptionValue) return false;

  // VÅ¡echny props jsou stejnÃ© - skip re-render
  return true;
});
