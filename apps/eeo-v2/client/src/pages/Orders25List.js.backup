import React, { useEffect, useState, useMemo, useContext, useCallback, useRef, useLayoutEffect } from 'react';
import ReactDOM, { createPortal } from 'react-dom';
import { useNavigate } from 'react-router-dom';
import { AuthContext } from '../context/AuthContext';
import { ProgressContext } from '../context/ProgressContext';
import { DebugContext } from '../context/DebugContext';
import { ToastContext } from '../context/ToastContext';
import { useBackgroundTasks } from '../context/BackgroundTasksContext';
import { downloadAttachment25, createDownloadLink25, lockOrder25, unlockOrder25 } from '../services/api25orders';
import { getOrderV2, listOrdersV2 } from '../services/apiOrderV2'; // ‚úÖ V2 API pro naƒç√≠t√°n√≠ objedn√°vky a seznamu
import { fetchAllUsers, fetchApprovers, fetchCiselniky, fetchLimitovanePrisliby } from '../services/api2auth';
import ordersCacheService from '../services/ordersCacheService';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import {
  faSearch, faFilter, faTimes, faPlus, faEdit, faEye, faTrash, faFileWord,
  faDownload, faSyncAlt, faChevronDown, faChevronUp, faCaretDown,
  faFileInvoice, faDashboard, faTableColumns, faFileExport,
  faBolt, faCalendarAlt, faUser, faBuilding, faMoneyBillWave,
  faCheckCircle, faTimesCircle, faHourglassHalf, faExclamationTriangle,
  faFilePen, faShield, faTruck, faXmark, faClock, faCircleNotch,
  faEraser, faList, faBars, faPalette, faMinus, faInfoCircle,
  faUsers, faPaperclip, faTags, faStickyNote, faPlay, faPause, faStop,
  faRocket, faBan, faBell, faArchive, faDatabase, faBoltLightning, faFileAlt,
  faFaceFrown, faLock, faEnvelope, faPhone, faFileContract,
  faReceipt, faClipboardCheck, faGavel, faChartLine, faListCheck,
  faHashtag, faCoins, faPercent
} from '@fortawesome/free-solid-svg-icons';
import styled from '@emotion/styled';
import { Calendar } from 'lucide-react';
import { CustomSelect, SelectWithIcon } from '../components/CustomSelect';
import { OrderContextMenu } from '../components/OrderContextMenu';
import { DocxGeneratorModal } from '../components/DocxGeneratorModal';
import { TooltipWrapper } from '../styles/GlobalTooltip';
import { css } from '@emotion/react';
import { prettyDate, formatDateOnly, exportCsv } from '../utils/format';
import { normalizeStav, getRowBackgroundFromStatus, getRowBaseColor } from '../utils/orderStatus';
import { isValidConcept, hasDraftChanges, isDraftFromDB, getDraftKey } from '../utils/draftUtils.js';
import order25DraftStorageService from '../services/order25DraftStorageService'; // ORDER25 STANDARD
import draftManager from '../services/DraftManager'; // üéØ CENTRALIZOVAN√ù DRAFT MANAGER
import { broadcastDraftUpdated, broadcastDraftDeleted, broadcastOrderSaved } from '../utils/tabSync';
import { translateErrorMessage, translateErrorMessageShort } from '../utils/errorTranslation';
import {
  useReactTable,
  getCoreRowModel,
  getExpandedRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  flexRender,
} from '@tanstack/react-table';

// =============================================================================
// KEYFRAMES FOR ANIMATIONS
// =============================================================================

const highlightPulse = `
  @keyframes highlightPulse {
    0% { 
      filter: brightness(1.4) saturate(1.3);
      box-shadow: 0 0 30px currentColor, 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px) scale(1.015);
    }
    15% { 
      filter: brightness(1.5) saturate(1.4);
      box-shadow: 0 0 40px currentColor, 0 6px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(-3px) scale(1.02);
    }
    30% { 
      filter: brightness(1.3) saturate(1.2);
      box-shadow: 0 0 25px currentColor, 0 3px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px) scale(1.01);
    }
    60% { 
      filter: brightness(1.15) saturate(1.1);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(0) scale(1.005);
    }
    80% {
      filter: brightness(1.05) saturate(1.05);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.06), 0 1px 4px rgba(0, 0, 0, 0.04);
      transform: translateY(0) scale(1.002);
    }
    100% { 
      filter: brightness(1) saturate(1);
      box-shadow: none;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
  }
`;

// =============================================================================
// STYLED COMPONENTS
// =============================================================================

const Container = styled.div`
  padding: 1rem;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  overflow: visible;
`;

const PageHeader = styled.div`
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-bottom: 2rem;
`;

const PageTitle = styled.h1`
  margin: 0;
  font-size: 2rem;
  font-weight: 700;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 0.75rem;
`;

const ActionBar = styled.div`
  display: flex;
  gap: 0.75rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
  padding-bottom: 1rem;
  border-bottom: 3px solid #e5e7eb;
`;

const ActionButton = styled.button`
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border: 2px solid #3b82f6;
  border-radius: 8px;
  background: ${props => props.$primary ? '#3b82f6' : 'white'};
  color: ${props => props.$primary ? 'white' : '#3b82f6'};
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;

  &:hover {
    background: ${props => props.$primary ? '#2563eb' : '#eff6ff'};
    border-color: ${props => props.$primary ? '#2563eb' : '#2563eb'};
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
  }

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
`;

// Centr√°ln√≠ barevn√° paleta - tmav√© barvy pro 3D dashboard, svƒõtl√© koresponduj√≠c√≠ pro ≈ô√°dky
const STATUS_COLORS = {
  // Tmav√© barvy pro 3D dla≈ædice + koresponduj√≠c√≠ svƒõtl√© odst√≠ny pro tabulku
  NOVA: { 
    dark: '#475569', // tmavƒõ ≈°ed√° - nov√° objedn√°vka
    light: '#e2e8f0' // svƒõtle ≈°ed√° - koresponduje
  },
  ODESLANA_KE_SCHVALENI: { 
    dark: '#dc2626', // ƒåERVEN√Å/RUD√Å - ke schv√°len√≠ (jak po≈æadov√°no)
    light: '#fecaca' // svƒõtle ƒçerven√° - koresponduje s rudou
  },
  SCHVALENA: { 
    dark: '#ea580c', // ORAN≈ΩOV√Å - schv√°len√° (jak po≈æadov√°no)
    light: '#fed7aa' // svƒõtle oran≈æov√° - koresponduje
  },
  ZAMITNUTA: { 
    dark: '#7c2d12', // tmavƒõ hnƒõd√° - zam√≠tnut√°
    light: '#fed7aa' // svƒõtle hnƒõd√° - koresponduje
  },
  ROZPRACOVANA: { 
    dark: '#ca8a04', // ≈ΩLUT√Å - rozpracovan√° (jak po≈æadov√°no)
    light: '#fef08a' // svƒõtle ≈ælut√° - koresponduje
  },
  ODESLANA: { 
    dark: '#1d4ed8', // MODR√Å - odeslan√° dodavateli (jak po≈æadov√°no)
    light: '#dbeafe' // svƒõtle modr√° - koresponduje
  },
  POTVRZENA: { 
    dark: '#0891b2', // CYAN - faktura/potvrzen√° (jak po≈æadov√°no)
    light: '#a5f3fc' // svƒõtle cyan - koresponduje
  },
  UVEREJNENA: { 
    dark: '#7c2d12', // hnƒõd√° - zve≈ôejnƒõn√° v registru smluv
    light: '#fed7aa' // svƒõtle oran≈æov√° - koresponduje
  },
  CEKA_POTVRZENI: { 
    dark: '#7c3aed', // fialov√° - ƒçek√° na potvrzen√≠ (unik√°tn√≠)
    light: '#e9d5ff' // svƒõtle fialov√° - koresponduje
  },
  CEKA_SE: { 
    dark: '#92400e', // tmavƒõ zlatohnƒõd√° - ƒçek√° se (unik√°tn√≠, odli≈°n√° od oran≈æov√©)
    light: '#fef3c7' // svƒõtle zlat√° - koresponduje
  },
  DOKONCENA: { 
    dark: '#16a34a', // ZELEN√Å - dokonƒçen√° (jak po≈æadov√°no)
    light: '#bbf7d0' // svƒõtle zelen√° - koresponduje
  },
  ZRUSENA: { 
    dark: '#be185d', // r≈Ø≈æov√° - zru≈°en√° (unik√°tn√≠)
    light: '#fce7f3' // svƒõtle r≈Ø≈æov√° - koresponduje
  },
  SMAZANA: { 
    dark: '#374151', // tmavƒõ ≈°ed√° - smazan√°
    light: '#d1d5db' // svƒõtle ≈°ed√° - koresponduje
  },
  ARCHIVOVANO: { 
    dark: '#78350f', // tmavƒõ hnƒõd√° - archivovan√°/import
    light: '#fef3c7' // svƒõtle ≈ælut√° - koresponduje
  },
  // Speci√°ln√≠ barvy pro dashboard
  TOTAL: { 
    dark: '#14532d', // tmavƒõ zelen√° pro celkovou hodnotu
    light: '#dcfce7'  // svƒõtle zelen√° - koresponduje
  },
  COUNT: { 
    dark: '#1e3a8a', // tmavƒõ modr√° pro poƒçty
    light: '#dbeafe'  // svƒõtle modr√° - koresponduje
  }
};

// Funkce pro z√≠sk√°n√≠ barvy podle stavu - pou≈æ√≠v√° novou STATUS_COLORS paletu
const getStatusColor = (stav) => {
  if (!stav) return STATUS_COLORS.NOVA;
  
  // Pokud je to ji≈æ syst√©mov√Ω k√≥d, pou≈æij p≈ô√≠mo
  if (typeof stav === 'string' && STATUS_COLORS[stav]) {
    return STATUS_COLORS[stav];
  }
  
  // Jinak normalizuj pomoc√≠ utilit
  const normalized = normalizeStav(stav);
  const statusCode = normalized?.code;
  
  if (!statusCode) return STATUS_COLORS.NOVA;
  
  return STATUS_COLORS[statusCode] || STATUS_COLORS.NOVA;
};

// Funkce pro vytvo≈ôen√≠ svƒõtlej≈°√≠ barvy (90% svƒõtlosti)
const getLighterColor = (color, opacity = 0.9) => {
  // Pokud je barva ve form√°tu hex, p≈ôeveƒè na rgba
  if (color.startsWith('#')) {
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }
  
  // Pokud je u≈æ rgba/rgb, uprav√≠me opacity
  if (color.includes('rgba')) {
    return color.replace(/[\d\.]+\)$/g, `${opacity})`);
  }
  
  if (color.includes('rgb')) {
    return color.replace('rgb', 'rgba').replace(')', `, ${opacity})`);
  }
  
  // Fallback
  return color;
};

// Funkce pro mapov√°n√≠ u≈æivatelsk√©ho stavu na syst√©mov√Ω k√≥d
const mapUserStatusToSystemCode = (userStatus) => {
  const mapping = {
    'Ke schv√°len√≠': 'ODESLANA_KE_SCHVALENI',
    'Nov√°': 'NOVA', 
    'Schv√°len√°': 'SCHVALENA',
    'Zam√≠tnut√°': 'ZAMITNUTA',
    'Rozpracovan√°': 'ROZPRACOVANA',
    'Odeslan√° dodavateli': 'ODESLANA',
    'Potvrzen√° dodavatelem': 'POTVRZENA',
    'Uve≈ôejnƒõn√°': 'UVEREJNENA',
    'ƒåek√° na potvrzen√≠': 'CEKA_POTVRZENI',
    'ƒåek√° se': 'CEKA_SE',
    'Dokonƒçen√°': 'DOKONCENA',
    'Zru≈°en√°': 'ZRUSENA',
    'Smazan√°': 'SMAZANA',
    'Koncept': 'NOVA' // Koncepty se mapuj√≠ jako nov√© objedn√°vky
  };
  return mapping[userStatus] || userStatus;
};

// Funkce pro barvu pozad√≠ ≈ô√°dk≈Ø tabulky - svƒõtl√© odst√≠ny
const getRowBackgroundColor = (order) => {
  try {
    // Speci√°ln√≠ p≈ô√≠pad pro koncepty
    if (order?.isDraft || order?.je_koncept) {
      return STATUS_COLORS.NOVA.light;
    }

    // Z√≠skej syst√©mov√Ω stav pro mapov√°n√≠ na barvy
    let systemStatus;
    
    // Preferuj u≈æivatelsky p≈ô√≠vƒõtiv√Ω stav z stav_objednavky a zmapuj na syst√©mov√Ω
    if (order?.stav_objednavky) {
      systemStatus = mapUserStatusToSystemCode(order.stav_objednavky);
    }
    // Fallback na stav_workflow_kod
    else if (order?.stav_workflow_kod) {
      try {
        const workflowStates = JSON.parse(order.stav_workflow_kod);
        if (Array.isArray(workflowStates)) {
          const lastState = workflowStates[workflowStates.length - 1];
          // Pou≈æij nazev_stavu nebo kod_stavu pokud je k dispozici
          if (typeof lastState === 'object' && (lastState.kod_stavu || lastState.nazev_stavu)) {
            systemStatus = lastState.kod_stavu || 'NEZNAMY';
          } else {
            systemStatus = typeof lastState === 'string' ? lastState : 'NEZNAMY';
          }
        } else {
          systemStatus = order.stav_workflow_kod;
        }
      } catch {
        systemStatus = order.stav_workflow_kod;
      }
    }
    // Dal≈°√≠ fallbacky pro r≈Øzn√© n√°zvy pol√≠
    else {
      systemStatus = order?.stav_id_num ?? order?.stav_id ?? order?.status_id ?? order?.stav ?? 'NOVA';
    }

    const statusColors = getStatusColor(systemStatus);
    
    // Debug v√Ωpis (pro testov√°n√≠) - p≈ô√≠mo prvn√≠ objedn√°vka
    if (order?.cislo_objednavky && order.cislo_objednavky.toString().endsWith('1')) {

    }
    
    return statusColors?.light || STATUS_COLORS.NOVA.light;
  } catch (error) {
    // Error getting row background color
    return STATUS_COLORS.NOVA.light;
  }
};

// Funkce pro barvu dla≈ædic dashboard - tmav√© barvy  
const getDashboardColor = (stav) => {
  try {
    const statusColors = getStatusColor(stav);
    return statusColors.dark;
  } catch {
    return STATUS_COLORS.NOVA.dark;
  }
};

// Funkce pro ikony podle stav≈Ø
const getStatusIcon = (status) => {
  switch (status?.toLowerCase()) {
    case 'nova':
      return faPlay;
    case 'odeslana_ke_schvaleni':
      return faHourglassHalf;
    case 'schvalena':
      return faCheckCircle;
    case 'zamitnuta':
      return faBan;
    case 'rozpracovana':
      return faClock;
    case 'odeslana':
      return faTruck;
    case 'potvrzena':
      return faShield;
    case 'uverejnena':
      return faFileContract;
    case 'dokoncena':
      return faStop;
    case 'ceka_potvrzeni':
      return faPause;
    case 'ceka_se':
      return faHourglassHalf;
    case 'zrusena':
      return faTimesCircle;
    case 'smazana':
      return faTrash;
    case 'archivovano':
      return faArchive;
    default:
      return faCircleNotch;
  }
};

// Dashboard Panel
const DashboardPanel = styled.div`
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 60%, #e2e8f0 100%);
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
`;

const DashboardGrid = styled.div`
  display: grid;
  grid-template-columns: minmax(350px, 400px) repeat(auto-fit, minmax(180px, 220px));
  gap: clamp(0.8rem, 1.5vw, 1.65rem);
  margin-bottom: 1.5rem;
  align-items: start;
  justify-content: start;
  overflow-x: auto;
  
  /* Lep≈°√≠ responzivita pro r≈Øzn√© zoom √∫rovnƒõ */
  @media (max-width: 1400px) {
    grid-template-columns: minmax(320px, 350px) repeat(auto-fit, minmax(160px, 200px));
    gap: clamp(0.7rem, 1.3vw, 1.4rem);
  }
  
  @media (max-width: 1200px) {
    grid-template-columns: minmax(300px, 330px) repeat(auto-fit, minmax(150px, 180px));
    gap: clamp(0.6rem, 1.2vw, 1.3rem);
  }
  
  @media (max-width: 900px) {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: clamp(0.8rem, 2vw, 1.2rem);
  }
  
  @media (max-width: 768px) {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: clamp(0.8rem, 2vw, 1.15rem);
  }
  
  @media (max-width: 600px) {
    grid-template-columns: 1fr;
    gap: clamp(0.6rem, 2vw, 0.9rem);
  }
  
  /* Speci√°ln√≠ pravidla pro vysok√Ω zoom (detekce p≈ôes velk√© font-size) */
  @media (min-width: 1600px) {
    grid-template-columns: minmax(400px, 450px) repeat(auto-fit, minmax(200px, 250px));
    gap: clamp(1.2rem, 1.8vw, 2rem);
  }
`;

const LargeStatCard = styled.div`
  background: linear-gradient(145deg, #ffffff, #f9fafb);
  border-radius: 16px;
  padding: clamp(1.25rem, 1.5vw, 1.75rem);
  border-left: 6px solid ${props => props.$color || '#3b82f6'};
  box-shadow: 
    0 4px 12px rgba(0, 0, 0, 0.08),
    0 2px 4px rgba(0, 0, 0, 0.06);
  
  transition: all 0.3s ease;
  grid-row: span 2;
  grid-column: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: fit-content;
  height: 100%;
  position: relative;
  width: 100%;
  box-sizing: border-box;
  
  /* Hover efekt */
  &:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 8px 20px rgba(0, 0, 0, 0.12),
      0 4px 8px rgba(0, 0, 0, 0.08);
  }
  
  /* Responsive breakpoints */
  @media (max-width: 1200px) {
    grid-row: span 1;
    grid-column: span 2;
    min-height: clamp(140px, 15vh, 180px);
  }
  
  @media (max-width: 900px) {
    grid-column: span 1;
    min-height: clamp(120px, 14vh, 160px);
    padding: clamp(1rem, 1.2vw, 1.5rem);
  }
  
  @media (max-width: 768px) {
    min-height: clamp(110px, 13vh, 150px);
  }
  
  @media (max-width: 600px) {
    min-height: clamp(100px, 12vh, 130px);
    padding: clamp(0.8rem, 1vw, 1.25rem);
  }
`;

const StatCard = styled.div`
  background: ${props => props.$isActive ? 
    `linear-gradient(145deg, ${props.$color || '#3b82f6'}20, ${props.$color || '#3b82f6'}10)` : 
    'linear-gradient(145deg, #ffffff, #f9fafb)'};
  border-radius: 12px;
  padding: clamp(0.8rem, 1vw, 1rem);
  border-left: 4px solid ${props => props.$color || '#3b82f6'};
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.06),
    0 1px 3px rgba(0, 0, 0, 0.04);
  
  transition: all 0.25s ease;
  min-height: clamp(90px, 10vh, 120px);
  min-width: clamp(160px, 18vw, 220px);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  position: relative;
  cursor: ${props => props.$clickable ? 'pointer' : 'default'};
  width: 100%;
  box-sizing: border-box;

  /* Hover efekt */
  &:hover {
    transform: ${props => props.$clickable ? 'translateY(-2px)' : 'translateY(-1px)'};
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.1),
      0 2px 6px rgba(0, 0, 0, 0.06);
    ${props => props.$clickable && `
      background: linear-gradient(145deg, ${props.$color || '#3b82f6'}25, ${props.$color || '#3b82f6'}15);
    `}
  }

  /* Aktivn√≠ stav */
  ${props => props.$isActive && `
    border-left-width: 6px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 0 0 2px ${props.$color || '#3b82f6'}40;
  `}
  
  /* Responsive breakpoints pro r≈Øzn√© velikosti obrazovky a zoom */
  @media (max-width: 1400px) {
    min-height: clamp(85px, 9vh, 110px);
    min-width: clamp(150px, 16vw, 200px);
  }
  
  @media (max-width: 1200px) {
    min-height: clamp(80px, 8vh, 105px);
    min-width: clamp(140px, 15vw, 190px);
  }
  
  @media (max-width: 900px) {
    min-height: clamp(75px, 8vh, 100px);
    min-width: 100%;
  }
  
  @media (max-width: 768px) {
    min-height: clamp(70px, 7vh, 95px);
    padding: clamp(0.7rem, 0.8vw, 0.9rem);
  }
  
  @media (max-width: 600px) {
    min-height: clamp(65px, 7vh, 85px);
    padding: clamp(0.6rem, 0.7vw, 0.8rem);
  }
`;

const StatValue = styled.div`
  font-size: clamp(1.25rem, 2.5vw, 1.875rem);
  font-weight: 700;
  color: #1e293b;
  line-height: 1.2;
  text-align: left;
  
  /* Zaji≈°tƒõn√≠ ƒçitelnosti na r≈Øzn√Ωch zoom √∫rovn√≠ch */
  @media (max-width: 1400px) {
    font-size: clamp(1.2rem, 2.3vw, 1.75rem);
  }
  
  @media (max-width: 1200px) {
    font-size: clamp(1.15rem, 2.2vw, 1.65rem);
  }
  
  @media (max-width: 900px) {
    font-size: clamp(1.1rem, 2.1vw, 1.6rem);
  }
  
  @media (max-width: 768px) {
    font-size: clamp(1rem, 2vw, 1.5rem);
  }
  
  @media (max-width: 600px) {
    font-size: clamp(0.95rem, 1.8vw, 1.3rem);
  }
`;

const StatLabel = styled.div`
  font-size: clamp(0.75rem, 1.2vw, 0.875rem);
  color: #64748b;
  font-weight: 500;
  text-align: left;
  line-height: 1.4;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  
  /* Responzivn√≠ velikosti pro r≈Øzn√© zoom √∫rovnƒõ */
  @media (max-width: 1200px) {
    white-space: normal;
    line-height: 1.3;
  }
  
  @media (max-width: 900px) {
    font-size: clamp(0.7rem, 1.1vw, 0.825rem);
  }
  
  @media (max-width: 768px) {
    font-size: clamp(0.65rem, 1vw, 0.8rem);
  }
  
  @media (max-width: 600px) {
    font-size: clamp(0.6rem, 0.9vw, 0.75rem);
  }
`;

const StatHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
`;

const StatIcon = styled.div`
  color: ${props => props.$color || '#64748b'};
  font-size: 1.25rem;
  opacity: 0.7;
`;

const LargeStatValue = styled.div`
  font-size: clamp(1.25rem, 2.5vw, 1.75rem);
  font-weight: 700;
  color: #1e293b;
  text-align: center;
  line-height: 1.1;
  margin-bottom: 0.5rem;
  
  /* Responzivn√≠ velikosti pro r≈Øzn√© zoom √∫rovnƒõ */
  @media (max-width: 1400px) {
    font-size: clamp(1.15rem, 2.3vw, 1.6rem);
  }
  
  @media (max-width: 1200px) {
    font-size: clamp(1.3rem, 2.6vw, 2rem);
  }
  
  @media (max-width: 900px) {
    font-size: clamp(1.2rem, 2.4vw, 1.9rem);
  }
  
  @media (max-width: 768px) {
    font-size: clamp(1.1rem, 2.2vw, 1.8rem);
  }
  
  @media (max-width: 600px) {
    font-size: clamp(1rem, 2vw, 1.6rem);
  }
`;

const LargeStatLabel = styled.div`
  font-size: 1rem;
  color: #64748b;
  font-weight: 600;
  text-align: center;
  margin-bottom: 1rem;
  
  @media (max-width: 480px) {
    font-size: 0.875rem;
  }
`;

const SummaryRow = styled.div`
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  margin-top: auto;
  
  @media (max-width: 768px) {
    flex-direction: column;
    gap: 0.75rem;
  }
`;

const SummaryItem = styled.div`
  flex: 1;
  padding: 0.75rem;
  border-radius: 8px;
  border-left: 3px solid ${props => props.$color || '#d1d5db'};
  background: ${props => props.$bg || 'rgba(0, 0, 0, 0.02)'};
`;

const SummaryLabel = styled.div`
  font-size: 0.75rem;
  font-weight: 600;
  color: ${props => props.$color || '#6b7280'};
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
`;

const SummaryValue = styled.div`
  font-size: 0.875rem;
  font-weight: 700;
  color: #1f2937;
`;

// Year Filter Panel (prominent position above main header)
const YearFilterPanel = styled.div`
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
  color: white;
  position: relative;
  z-index: 9999;
`;

const YearFilterLeft = styled.div`
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
`;

const YearFilterTitle = styled.h2`
  font-size: calc(1.5rem + 3px);
  font-weight: 700;
  color: white;
  margin: 0;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
`;

// üöÄ CACHE: Status indicator komponenty
const CacheStatusIconWrapper = styled(TooltipWrapper)`
  z-index: 999999;
`;

const CacheStatusIcon = styled.div`
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: ${props => props.fromCache 
    ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 
    : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
  };
  color: white;
  font-size: 0.9rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  cursor: help;
  transition: all 0.2s ease;
  position: relative;
  z-index: 999999;
  
  &:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }
  
  svg {
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
  }
`;

const YearFilterLabel = styled.label`
  font-weight: 600;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const RefreshIconButton = styled.button`
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  width: 42px;
  height: 42px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  transition: all 0.2s ease;
  margin-left: 0.5rem;

  &:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-1px);
  }

  &:active {
    transform: translateY(0);
  }
`;

const MonthFilterLabel = styled.label`
  font-weight: 600;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-left: 1rem;
`;

const YearFilterSelect = styled.select`
  padding: 0.75rem 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.15);
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(8px);

  &:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
  }

  option {
    background: #1e40af;
    color: white;
    padding: 0.5rem;
  }
`;

const MonthFilterSelect = styled.select`
  padding: 0.75rem 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.15);
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(8px);
  width: auto;
  min-width: 240px;

  /* Scrollbar styling */
  overflow-y: auto;
  max-height: 400px;

  &::-webkit-scrollbar {
    width: 12px;
  }

  &::-webkit-scrollbar-track {
    background: rgba(30, 64, 175, 0.3);
    border-radius: 6px;
  }

  &::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(96, 165, 250, 0.9));
    border-radius: 6px;
    border: 2px solid rgba(30, 64, 175, 0.3);
  }

  &::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 1), rgba(96, 165, 250, 1));
  }

  /* Firefox scrollbar */
  scrollbar-width: thin;
  scrollbar-color: rgba(59, 130, 246, 0.8) rgba(30, 64, 175, 0.3);

  &:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
  }

  option {
    background: #1e40af;
    color: white;
    padding: 0.5rem;
    font-size: 0.95rem;
    
    &:hover {
      background: #2563eb;
    }
    
    &[data-separator="true"] {
      padding: 0.5rem 1rem !important;
      margin: 0 !important;
      width: 100% !important;
      height: auto !important;
      line-height: normal !important;
      font-size: 0.95rem !important;
      color: white !important;
      background: #1e40af !important;
      border: none !important;
      border-top: 1px solid white !important;
      cursor: default;
      pointer-events: none;
      display: block;
      box-sizing: border-box;
    }
    
    &[data-action="true"] {
      font-style: normal;
      color: white;
      font-weight: normal;
      padding: 0.5rem;
      margin: 0;
      background: #1e40af;
      
      &:hover {
        background: #2563eb;
      }
    }
  }
`;

// Custom Month Dropdown Components
const MonthDropdownContainer = styled.div`
  position: relative;
  width: auto;
  min-width: 240px;
`;

const YearDropdownContainer = styled.div`
  position: relative;
  width: auto;
  min-width: 160px;
`;

const MonthDropdownButton = styled.button`
  padding: 0.75rem 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.15);
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  backdrop-filter: blur(8px);
  width: 100%;
  text-align: left;
  display: flex;
  justify-content: space-between;
  align-items: center;
  
  &:focus {
    outline: none;
    border-color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
  }
  
  &:hover {
    background: rgba(255, 255, 255, 0.25);
  }
`;

const MonthDropdownMenu = styled.div`
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: 0.5rem;
  background: #1e40af;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
  backdrop-filter: blur(8px);
  
  /* Scrollbar styling */
  &::-webkit-scrollbar {
    width: 12px;
  }

  &::-webkit-scrollbar-track {
    background: rgba(30, 64, 175, 0.3);
    border-radius: 6px;
  }

  &::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(96, 165, 250, 0.9));
    border-radius: 6px;
    border: 2px solid rgba(30, 64, 175, 0.3);
  }

  &::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 1), rgba(96, 165, 250, 1));
  }

  /* Firefox scrollbar */
  scrollbar-width: thin;
  scrollbar-color: rgba(59, 130, 246, 0.8) rgba(30, 64, 175, 0.3);
`;

const MonthDropdownItem = styled.div`
  padding: 0.75rem 1rem;
  color: white;
  cursor: ${props => props.disabled ? 'default' : 'pointer'};
  font-size: 0.95rem;
  transition: background 0.15s ease;
  pointer-events: ${props => props.disabled ? 'none' : 'auto'};
  
  ${props => props.separator && `
    border-top: 1px solid rgba(255, 255, 255, 0.3);
    padding: 0.5rem 1rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
  `}
  
  ${props => props.action && `
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
  `}
  
  ${props => !props.disabled && !props.separator && `
    &:hover {
      background: #2563eb;
    }
  `}
`;

// Filters Panel
const FiltersPanel = styled.div`
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 60%, #e2e8f0 100%);
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
`;

const FiltersHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
`;

const FiltersGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: clamp(1rem, 1.5vw, 1.5rem);
  margin-top: 1.5rem;
  margin-bottom: 1rem;
  
  /* Prvn√≠ ≈ô√°dek: 5 select≈Ø (Stav, Objednatel, Garant, P≈ô√≠kazce, Schvalovatel) */
  /* Druh√Ω ≈ô√°dek: Datum (2 sloupce), Cena (2 sloupce), Rychl√© filtry (1 sloupec) */
  & > *:nth-of-type(6) {
    grid-column: 1 / 3;
  }
  
  & > *:nth-of-type(7) {
    grid-column: 3 / 5;
  }
  
  & > *:nth-of-type(8) {
    grid-column: 5 / 6;
  }
  
  /* Responzivn√≠ breakpointy */
  @media (max-width: 1400px) {
    grid-template-columns: repeat(3, 1fr);
    
    /* Na st≈ôedn√≠ch obrazovk√°ch - datum a cena na vlastn√≠ ≈ô√°dky */
    & > *:nth-of-type(6) {
      grid-column: 1 / -1;
    }
    
    & > *:nth-of-type(7) {
      grid-column: 1 / -1;
    }
    
    & > *:nth-of-type(8) {
      grid-column: 1 / -1;
    }
  }
  
  @media (max-width: 1200px) {
    grid-template-columns: repeat(2, 1fr);
    
    /* Na st≈ôedn√≠ch obrazovk√°ch - datum a cena na vlastn√≠ ≈ô√°dky */
    & > *:nth-of-type(6) {
      grid-column: 1 / -1;
    }
    
    & > *:nth-of-type(7) {
      grid-column: 1 / -1;
    }
    
    & > *:nth-of-type(8) {
      grid-column: 1 / -1;
    }
  }
  
  @media (max-width: 768px) {
    grid-template-columns: 1fr;
    gap: clamp(0.8rem, 1.2vw, 1.25rem);
    
    /* Na mobilech - v≈°echno na jeden sloupec */
    & > * {
      grid-column: 1 !important;
    }
  }
  
  @media (max-width: 480px) {
    gap: clamp(0.6rem, 1vw, 1rem);
  }
`;

// Wrapper pro tlaƒç√≠tko vymazat filtry v gridu
const ClearFiltersWrapper = styled.div`
  display: flex;
  align-items: flex-end;
  justify-content: flex-end;
`;

const FilterGroup = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
`;

const FilterLabel = styled.div`
  font-size: 0.875rem;
  font-weight: 600;
  color: #374151;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 0.5rem;
  width: 100%;
  margin-bottom: 0.5rem;
`;

const FilterLabelLeft = styled.div`
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const FilterClearButton = styled.button`
  background: none;
  border: none;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
  color: #9ca3af;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  transition: all 0.2s ease;
  border-radius: 4px;
  opacity: ${props => props.visible ? 1 : 0};
  pointer-events: ${props => props.visible ? 'auto' : 'none'};
  margin-left: auto;

  &:hover {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }

  svg {
    width: 12px;
    height: 12px;
  }
`;

// Wrapper pro input s ikonou - konzistentn√≠ se zbytkem aplikace
const FilterInputWithIcon = styled.div`
  position: relative;
  width: 100%;
  
  > svg:first-of-type {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 1;
    pointer-events: none;
    width: 16px !important;
    height: 16px !important;
  }
`;

const ClearButton = styled.button`
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  padding: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
  z-index: 1;
  width: 20px;
  height: 20px;
  
  &:hover {
    color: #6b7280;
  }
  
  > svg {
    width: 14px !important;
    height: 14px !important;
  }
`;

const FilterInput = styled.input`
  width: 100%;
  box-sizing: border-box;
  padding: ${props => props.hasIcon ? '0.75rem 2.5rem 0.75rem 2.5rem' : '0.75rem'};
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 0.875rem;
  transition: all 0.2s ease;
  background: white;
  
  /* Pro number inputy - zarovn√°n√≠ doprava a odstranƒõn√≠ ≈°ipek */
  ${props => props.type === 'number' && `
    text-align: right;
    padding-right: 2.5rem; /* m√≠sto pro Kƒç symbol */
    
    /* Odstranƒõn√≠ spinner ≈°ipek - WebKit */
    &::-webkit-outer-spin-button,
    &::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Odstranƒõn√≠ spinner ≈°ipek - Firefox */
    &[type=number] {
      -moz-appearance: textfield;
    }
  `}

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  &::placeholder {
    color: #9ca3af;
  }
`;

// Wrapper pro select s ikonou
const FilterSelectWithIcon = styled.div`
  position: relative;
  width: 100%;
  
  > svg {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 1;
    pointer-events: none;
    width: 16px !important;
    height: 16px !important;
  }
`;

const FilterSelect = styled.select`
  width: 100%;
  box-sizing: border-box;
  padding: ${props => props.hasIcon ? '0.75rem 1.75rem 0.75rem 2.5rem' : '0.75rem 1.75rem 0.75rem 0.75rem'};
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 0.875rem;
  background: white;
  cursor: pointer;
  color: #1f2937;
  font-weight: 500;
  transition: all 0.2s ease;
  appearance: none;
  -moz-appearance: none;
  -webkit-appearance: none;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  &:hover {
    border-color: #3b82f6;
  }

  /* Custom dropdown arrow - stejn√° jako v OrderForm25 */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  background-size: 16px 16px;
  
  /* Styling pro placeholder option */
  option[value=""] {
    color: #9ca3af;
    font-weight: 400;
  }
  
  option {
    color: #1f2937;
    font-weight: 500;
    padding: 0.5rem;
  }
`;

// Layout pre cena od-do (dva inputy vedƒæa seba)
const PriceRangeGroup = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
`;

const PriceRangeInputs = styled.div`
  display: flex;
  gap: 0.5rem;
  align-items: center;
`;

const PriceInputWrapper = styled.div`
  flex: 1;
  position: relative;
  
  > svg {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 1;
    pointer-events: none;
    width: 16px !important;
    height: 16px !important;
  }
  
  /* Kƒç symbol vpravo */
  &::after {
    content: 'Kƒç';
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    pointer-events: none;
    z-index: 2;
  }
`;

const PriceSeparator = styled.span`
  color: #6b7280;
  font-weight: 500;
  font-size: 0.875rem;
  padding: 0 0.25rem;
`;

// Layout pre datum od-do (dva inputy vedƒæa seba)
const DateRangeGroup = styled.div`
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
`;

const DateRangeInputs = styled.div`
  display: flex;
  gap: 0.5rem;
  align-items: center;
`;

const DateInputWrapper = styled.div`
  flex: 1;
  position: relative;
  
  > svg {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 1;
    pointer-events: none;
    width: 16px !important;
    height: 16px !important;
  }
`;

const DateSeparator = styled.span`
  color: #6b7280;
  font-weight: 500;
  font-size: 0.875rem;
  padding: 0 0.25rem;
`;

const ColumnFilterWrapper = styled.div`
  position: relative;
  width: 100%;
  
  > svg:first-of-type {
    position: absolute;
    left: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    z-index: 1;
    pointer-events: none;
    width: 12px !important;
    height: 12px !important;
  }
`;

const ColumnClearButton = styled.button`
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  padding: 0.15rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
  z-index: 1;
  width: 16px;
  height: 16px;
  
  &:hover {
    color: #6b7280;
  }
  
  > svg {
    width: 10px !important;
    height: 10px !important;
  }
`;

const ColumnFilterInput = styled.input`
  width: 100%;
  padding: 0.5rem 2rem 0.5rem 2rem;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 0.75rem;
  background: #f9fafb;
  transition: all 0.2s ease;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    background: white;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  &::placeholder {
    color: #9ca3af;
    font-size: 0.75rem;
  }
`;

const FilterActionButton = styled.button`
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
  color: #6b7280;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  margin: 0 2px;
  font-size: 14px;
  position: relative;
  overflow: hidden;

  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
  }

  &:hover {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    color: #1e40af;
    border-color: #3b82f6;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    
    &::before {
      left: 100%;
    }
  }

  &:active {
    transform: translateY(-1px) scale(1.02);
  }

  &.active {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    color: white;
    border-color: #1d4ed8;
    box-shadow: 
      0 4px 16px rgba(59, 130, 246, 0.4),
      0 0 20px rgba(59, 130, 246, 0.3);
    transform: scale(1.1);
    
    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(255, 255, 255, 0.1) 0%,
        transparent 20%,
        transparent 80%,
        rgba(255, 255, 255, 0.1) 100%);
      animation: shimmer 2s infinite;
    }
    
    &:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 50%, #1e40af 100%);
      box-shadow: 
        0 6px 20px rgba(59, 130, 246, 0.5),
        0 0 25px rgba(59, 130, 246, 0.4);
      transform: scale(1.12) translateY(-2px);
    }
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
`;

// Empty State Styles
const EmptyState = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  text-align: center;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  margin: 2rem 0;
  border: 2px dashed #cbd5e1;
`;

const EmptyStateIcon = styled.div`
  font-size: 4rem;
  color: #94a3b8;
  margin-bottom: 1.5rem;
  opacity: 0.7;
`;

const EmptyStateTitle = styled.h3`
  font-size: 1.5rem;
  font-weight: 600;
  color: #475569;
  margin: 0 0 0.5rem 0;
`;

const EmptyStateText = styled.p`
  font-size: 1rem;
  color: #64748b;
  margin: 0;
  max-width: 500px;
`;

// Table Styles
const TableContainer = styled.div`
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
`;

const Table = styled.table`
  width: 100%;
  border-collapse: collapse;
`;

const TableHead = styled.thead`
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
`;

const TableRow = styled.tr`
  /* Z√°kladn√≠ pozad√≠ ≈ô√°dku podle priority:
     1. KONCEPTY V EDITACI - nejvy≈°≈°√≠ priorita - oran≈æov√© zv√Ωraznƒõn√≠
     2. ZV√ùRAZ≈áOV√ÅN√ç PODLE STAVU - pokud je zapnuto
     3. STRIPING - jednoduch√© st≈ô√≠d√°n√≠ b√≠l√©/≈°ed√© (pokud highlighting vypnuto)
  */
  background: ${props => {
    // 1. KONCEPTY V EDITACI - NEJVY≈†≈†√ç PRIORITA - v≈ædy viditeln√©
    if (props.$isDraft || props.$hasLocalChanges) {
      return 'linear-gradient(135deg, #ea580c 0%, #f97316 30%, #ea580c 70%, #dc2626 100%)';
    }
    
    // 2. ZV√ùRAZ≈áOV√ÅN√ç PODLE STAVU - pokud je zapnuto
    if (props.$showHighlighting && props.$order) {
      const bgColor = getRowBackgroundColor(props.$order);
      if (bgColor && bgColor !== 'transparent') {
        return `linear-gradient(135deg, ${bgColor} 0%, ${bgColor}dd 50%, ${bgColor} 100%)`;
      }
    }
    
    // 3. STRIPING - jednoduch√© st≈ô√≠d√°n√≠ (fallback)
    if (props.$showStriping) {
      return props.$isEven ? '#f8fafc' : 'white';
    }
    
    // 4. DEFAULT - ƒçistƒõ b√≠l√© pozad√≠
    return 'white';
  }};

  /* Speci√°ln√≠ efekty pro KONCEPTY V EDITACI - jen svƒõtlej≈°√≠ pozad√≠ */
  ${props => (props.$isDraft || props.$hasLocalChanges) ? `
    border-left: 4px solid #ea580c;
    position: relative;
    z-index: 5;
    
    /* B√≠l√© p√≠smo pro koncepty - d≈Øle≈æit√© pro ƒçitelnost */
    color: white !important;
    font-weight: 700;
    
    /* V≈°echny vno≈ôen√© elementy */
    & * {
      color: white !important;
      font-weight: 600 !important;
    }
    
    & div, & span, & sup, & sub, & small, & strong {
      color: white !important;
    }
    
    /* Ikony a SVG */
    & .fa, & svg, & [class*="fa-"] {
      color: white !important;
    }
    
    /* Tlaƒç√≠tka v konceptech */
    & button {
      color: white !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
      
      &:hover {
        background: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
      }
    }
    
    /* Vstupn√≠ pole v konceptech */
    & input {
      background: rgba(255, 255, 255, 0.1) !important;
      color: white !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
      
      &::placeholder {
        color: rgba(255, 255, 255, 0.7) !important;
      }
    }

    /* Hover efekt pro koncepty - jen svƒõtlej≈°√≠ pozad√≠ */
    &:hover {
      background: linear-gradient(135deg, #fed7aa 0%, #fdba74 30%, #fb923c 70%, #f97316 100%) !important;
      
      & * {
        color: #7c2d12 !important;
      }
    }
  ` : ''}

  /* EFEKTY PODLE STAVU - pouze pokud nen√≠ koncept */
  ${props => {
    if (!(props.$isDraft || props.$hasLocalChanges) && props.$showHighlighting && props.$order) {
      // Z√≠skej syst√©mov√Ω stav pomoc√≠ stejn√© logiky jako getRowBackgroundColor
      let systemStatus;
      
      if (props.$order?.stav_objednavky) {
        // Mapov√°n√≠ u≈æivatelsky p≈ô√≠vƒõtiv√Ωch stav≈Ø na syst√©mov√© k√≥dy
        const mapping = {
          'Ke schv√°len√≠': 'ODESLANA_KE_SCHVALENI',
          'Nov√°': 'NOVA', 
          'Schv√°len√°': 'SCHVALENA',
          'Zam√≠tnut√°': 'ZAMITNUTA',
          'Rozpracovan√°': 'ROZPRACOVANA',
          'Odeslan√° dodavateli': 'ODESLANA',
          'Potvrzen√° dodavatelem': 'POTVRZENA',
          'Uve≈ôejnƒõn√°': 'UVEREJNENA',
          'ƒåek√° na potvrzen√≠': 'CEKA_POTVRZENI',
          'ƒåek√° se': 'CEKA_SE',
          'Dokonƒçen√°': 'DOKONCENA',
          'Zru≈°en√°': 'ZRUSENA',
          'Smazan√°': 'SMAZANA',
          'Koncept': 'NOVA'
        };
        systemStatus = mapping[props.$order.stav_objednavky] || props.$order.stav_objednavky;
      } else if (props.$order?.stav_workflow_kod) {
        try {
          const workflowStates = JSON.parse(props.$order.stav_workflow_kod);
          systemStatus = Array.isArray(workflowStates) ? workflowStates[workflowStates.length - 1] : props.$order.stav_workflow_kod;
        } catch {
          systemStatus = props.$order.stav_workflow_kod;
        }
      } else {
        systemStatus = props.$order?.stav_id_num ?? props.$order?.stav_id ?? props.$order?.status_id ?? props.$order?.stav ?? 'NOVA';
      }

      const statusColors = getStatusColor(systemStatus);
      const bgColor = statusColors?.light || '#f8fafc';
      const darkColor = statusColors?.dark || '#64748b';
      
      return `
        /* Jemn√Ω 3D efekt podle stavu */
        box-shadow: 
          0 2px 8px ${bgColor}66,
          inset 0 1px 0 rgba(255, 255, 255, 0.5);
        
        /* Lep≈°√≠ ƒçitelnost textu */
        color: #1f2937;
        font-weight: 500;

        /* Hover efekt pro ≈ô√°dky s highlighting - jen svƒõtlej≈°√≠ pozad√≠ */
        &:hover {
          filter: brightness(1.1);
          color: #1f2937 !important;
        }
      `;
    }
    return '';
  }}

  /* BLINK EFEKT p≈ôi ulo≈æen√≠ - m√° nejvy≈°≈°√≠ prioritu */
  ${props => props.$isHighlighted ? highlightPulse + `
    animation: highlightPulse 3s ease-out;
    animation-iteration-count: 1;
    z-index: 100 !important;
    position: relative;
  ` : ''}

  /* Jemn√Ω hover efekt pro v≈°echny ≈ô√°dky (kromƒõ koncept≈Ø kter√© maj√≠ vlastn√≠) */
  ${props => !(props.$isDraft || props.$hasLocalChanges) ? `
    &:hover {
      ${props.$showHighlighting ? 
        // Pokud je highlighting zapnuto, jen jemn√© zesvƒõtlen√≠
        `filter: brightness(1.08);` :
        // Pokud highlighting vypnuto, svƒõtle modr√Ω hover
        `background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;`
      }
    }
  ` : ''}

  /* Plynul√© p≈ôechody */
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* V√Ωchoz√≠ cursor - ≈æ√°dn√° interakce s ≈ô√°dkem */
  cursor: default;
`;

const TableHeader = styled.th`
  padding: 1rem 0.75rem;
  text-align: center;
  font-weight: 600;
  color: white;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  cursor: pointer;
  user-select: none;
  position: sticky;
  top: 0;
  z-index: 10;

  &:hover {
    background: rgba(255, 255, 255, 0.1);
  }
`;

const TableCell = styled.td`
  padding: 0.75rem;
  border-bottom: 1px solid #f1f5f9;
  vertical-align: middle;
`;

const ExpandButton = styled.button`
  background: none;
  border: none;
  cursor: pointer;
  color: #3b82f6;
  font-size: 1.25rem;
  padding: 0.25rem;
  border-radius: 4px;
  transition: background-color 0.2s ease;

  &:hover {
    background: #eff6ff;
  }
`;

// Expanded Row Content
const ExpandedContent = styled.div`
  padding: 1.5rem;
  background: ${props => {
    if (props.$order && props.$showRowHighlighting) {
      // Z√≠skej syst√©mov√Ω stav pro mapov√°n√≠ na barvy
      let systemStatus;
      
      // Preferuj u≈æivatelsky p≈ô√≠vƒõtiv√Ω stav z stav_objednavky a zmapuj na syst√©mov√Ω
      if (props.$order?.stav_objednavky) {
        systemStatus = mapUserStatusToSystemCode(props.$order.stav_objednavky);
      }
      // Fallback na stav_workflow_kod
      else if (props.$order?.stav_workflow_kod) {
        try {
          const workflowStates = JSON.parse(props.$order.stav_workflow_kod);
          systemStatus = Array.isArray(workflowStates) ? workflowStates[workflowStates.length - 1] : props.$order.stav_workflow_kod;
        } catch {
          systemStatus = props.$order.stav_workflow_kod;
        }
      } else {
        systemStatus = props.$order?.stav_id_num ?? props.$order?.stav_id ?? props.$order?.status_id ?? props.$order?.stav ?? 'NOVA';
      }

      const statusColors = getStatusColor(systemStatus);
      const bgColor = statusColors?.light || '#f8fafc';
      const lighterBgColor = getLighterColor(bgColor, 0.05); // Jen 5% opacity pro jemnƒõj≈°√≠ efekt
      
      return lighterBgColor;
    }
    return '#f9fafb'; // Lehce ≈°ed√© pozad√≠ pro lep≈°√≠ kontrast
  }};
  border-top: 2px solid ${props => {
    if (props.$order && props.$showRowHighlighting) {
      // Z√≠skej syst√©mov√Ω stav pro mapov√°n√≠ na barvy
      let systemStatus;
      
      if (props.$order?.stav_objednavky) {
        systemStatus = mapUserStatusToSystemCode(props.$order.stav_objednavky);
      } else if (props.$order?.stav_workflow_kod) {
        try {
          const workflowStates = JSON.parse(props.$order.stav_workflow_kod);
          systemStatus = Array.isArray(workflowStates) ? workflowStates[workflowStates.length - 1] : props.$order.stav_workflow_kod;
        } catch {
          systemStatus = props.$order.stav_workflow_kod;
        }
      } else {
        systemStatus = props.$order?.stav_id_num ?? props.$order?.stav_id ?? props.$order?.status_id ?? props.$order?.stav ?? 'NOVA';
      }

      const statusColors = getStatusColor(systemStatus);
      const darkColor = statusColors?.dark || '#64748b';
      
      return darkColor;
    }
    return '#e5e7eb';
  }};
  border-bottom: 2px solid #000000;
`;

const ExpandedGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  
  /* Prvn√≠ ≈ô√°dek: 5 karet (Z√°kladn√≠, Finanƒçn√≠, Odpovƒõdn√©, Workflow, Dodavatel) */
  /* Ka≈æd√° karta zabere 1 sloupec */
  
  /* Druh√Ω ≈ô√°dek: 3 karty (Polo≈æky, Faktury, P≈ô√≠lohy) */
  /* Ka≈æd√° karta m≈Ø≈æe zabrat v√≠ce sloupc≈Ø pro vyrovn√°n√≠ */
  
  @media (max-width: 1800px) {
    grid-template-columns: repeat(4, 1fr);
  }
  
  @media (max-width: 1400px) {
    grid-template-columns: repeat(3, 1fr);
  }
  
  @media (max-width: 1200px) {
    grid-template-columns: repeat(2, 1fr);
  }
  
  @media (max-width: 768px) {
    grid-template-columns: 1fr;
  }
`;

// Nov√Ω layout pro druh√Ω ≈ô√°dek: Polo≈æky a Faktury vlevo, P≈ô√≠lohy vpravo p≈ôes v√Ω≈°ku
const SecondRowLayout = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr; /* 50/50 layout */
  gap: 1rem;
  grid-column: 1 / -1; /* Zabere celou ≈°√≠≈ôku gridu */
  
  @media (max-width: 1200px) {
    grid-template-columns: 1fr;
  }
`;

const LeftColumn = styled.div`
  display: flex;
  flex-direction: column;
  gap: 1rem;
`;

const RightColumn = styled.div`
  display: flex;
  flex-direction: column;
  height: 100%; /* Zarovn√°n√≠ na v√Ω≈°ku lev√©ho sloupce */
  
  /* InfoCard v prav√©m sloupci m√° zabrat celou v√Ω≈°ku */
  > div {
    flex: 1;
    display: flex;
    flex-direction: column;
    
    /* Obsah p≈ô√≠lohy rozt√°hnout */
    > div:last-child {
      flex: 1;
      overflow-y: auto;
    }
  }
`;


const InfoCard = styled.div`
  background: white;
  border-radius: 8px;
  padding: 1.25rem;
  border-left: 4px solid ${props => {
    if (props.$order && props.$showRowHighlighting) {
      // Z√≠skej syst√©mov√Ω stav pro mapov√°n√≠ na barvy
      let systemStatus;
      
      if (props.$order?.stav_objednavky) {
        systemStatus = mapUserStatusToSystemCode(props.$order.stav_objednavky);
      } else if (props.$order?.stav_workflow_kod) {
        try {
          const workflowStates = JSON.parse(props.$order.stav_workflow_kod);
          systemStatus = Array.isArray(workflowStates) ? workflowStates[workflowStates.length - 1] : props.$order.stav_workflow_kod;
        } catch {
          systemStatus = props.$order.stav_workflow_kod;
        }
      } else {
        systemStatus = props.$order?.stav_id_num ?? props.$order?.stav_id ?? props.$order?.status_id ?? props.$order?.stav ?? 'NOVA';
      }

      const statusColors = getStatusColor(systemStatus);
      const darkColor = statusColors?.dark || '#3b82f6';
      
      return darkColor;
    }
    return '#3b82f6';
  }};
  box-shadow: 
    0 4px 6px -1px rgba(0, 0, 0, 0.1),
    0 2px 4px -1px rgba(0, 0, 0, 0.06),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
  
  /* 3D efekt pro karty */
  position: relative;
  transform: translateZ(0);
  transition: all 0.2s ease-in-out;
  
  &:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05),
      inset 0 1px 0 rgba(255, 255, 255, 0.8);
  }
  
  /* Subtle gradient overlay pro 3D efekt */
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.02) 100%);
    border-radius: 8px;
    pointer-events: none;
  }
`;

const InfoCardTitle = styled.h4`
  margin: 0 0 0.75rem 0;
  font-size: 1rem;
  font-weight: 600;
  color: #0a0a0a;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  
  svg {
    color: #6b7280;
    opacity: 0.8;
  }
`;

// üÜï Komponenty pro faktury a dodateƒçn√© dokumenty
const ListItemCard = styled.div`
  padding: 10px 12px;
  background: #f8fafc;
  border-radius: 6px;
  border: 1px solid #e2e8f0;
  transition: all 0.2s ease;
  
  &:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    transform: translateX(2px);
  }
`;

const ListItemHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 6px;
  gap: 12px;
`;

const ListItemTitle = styled.div`
  font-weight: 600;
  font-size: 0.95em;
  color: #0f172a;
  flex: 1;
`;

const ListItemBadge = styled.span`
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 600;
  text-transform: uppercase;
  white-space: nowrap;
  background: ${props => props.$success ? '#dcfce7' : props.$warning ? '#fef3c7' : '#dbeafe'};
  color: ${props => props.$success ? '#166534' : props.$warning ? '#854d0e' : '#1e40af'};
  border: 1px solid ${props => props.$success ? '#86efac' : props.$warning ? '#fde047' : '#93c5fd'};
  
  svg {
    color: #6b7280;
    opacity: 0.8;
  }
`;

const ListItemMeta = styled.div`
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 0.85em;
  color: #64748b;
`;

const ListItemMetaItem = styled.span`
  display: flex;
  align-items: center;
  gap: 4px;
`;

const AttachmentsList = styled.div`
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px dashed #e2e8f0;
  display: flex;
  flex-direction: column;
  gap: 4px;
`;

const AttachmentItem = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 8px;
  background: white;
  border-radius: 4px;
  font-size: 0.85em;
  
  &:hover {
    background: #f8fafc;
  }
`;

const AttachmentName = styled.span`
  flex: 1;
  color: #475569;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`;

const AttachmentSize = styled.span`
  color: #94a3b8;
  font-size: 0.9em;
  margin-left: 8px;
`;

// üÜï Komponenty pro f√°ze dokonƒçen√≠
const PhaseProgressBar = styled.div`
  width: 100%;
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  overflow: hidden;
  margin: 8px 0;
`;

const PhaseProgressFill = styled.div`
  height: 100%;
  background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
  border-radius: 4px;
  transition: width 0.3s ease;
  width: ${props => props.$progress || 0}%;
`;

const PhaseLabel = styled.div`
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.9em;
  margin-bottom: 4px;
  
  .phase-name {
    font-weight: 500;
    color: #1e293b;
  }
  
  .phase-percent {
    font-weight: 600;
    color: #3b82f6;
  }
`;

const InfoRow = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1.5rem;
  padding: 0.45rem 0;
  border-bottom: 1px dashed #e5e7eb;

  &:last-child {
    border-bottom: none;
  }
`;

const InfoLabel = styled.span`
  font-weight: 600;
  color: #0a0a0a;
  flex-shrink: 0;
  white-space: nowrap;
  max-width: 45%;
`;

const InfoValue = styled.span`
  color: #0a0a0a;
  text-align: right;
  word-wrap: break-word;
  overflow-wrap: break-word;
  flex: 1;
  min-width: 0;
  line-height: 1.5;
`;

// Pagination
const PaginationContainer = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: #f8fafc;
  border-top: 1px solid #e5e7eb;
`;

const PaginationInfo = styled.div`
  font-size: 0.875rem;
  color: #64748b;
`;

const PaginationControls = styled.div`
  display: flex;
  gap: 0.5rem;
  align-items: center;
`;

const PageButton = styled.button`
  padding: 0.5rem 1rem;
  border: 1px solid #e5e7eb;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 500;
  transition: all 0.2s ease;

  &:hover:not(:disabled) {
    background: #f3f4f6;
    border-color: #3b82f6;
  }

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  &.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
  }
`;

const PageSizeSelect = styled.select`
  padding: 0.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: white;
  font-size: 0.875rem;
  cursor: pointer;
`;

// Status Badge
const StatusBadge = styled.span`
  display: inline-flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  border: 2px solid;
  background: ${props => {
    // Speci√°ln√≠ styling pro editovan√©/konceptov√© ≈ô√°dky - transparentn√≠ pozad√≠ (jen obrys)
    if (props.$isInEditRow) {
      return 'transparent';
    }
    const statusColors = getStatusColor(props.$status);
    return statusColors?.light || STATUS_COLORS.NOVA.light;
  }};
  color: ${props => {
    // Speci√°ln√≠ styling pro editovan√©/konceptov√© ≈ô√°dky - tmav√© barvy pro dobr√Ω kontrast
    if (props.$isInEditRow) {
      const statusColors = getStatusColor(props.$status);
      return statusColors?.dark || STATUS_COLORS.NOVA.dark;
    }
    const statusColors = getStatusColor(props.$status);
    return statusColors?.dark || STATUS_COLORS.NOVA.dark;
  }};
  border-color: ${props => {
    // Speci√°ln√≠ styling pro editovan√©/konceptov√© ≈ô√°dky - sytƒõ ƒçerven√Ω r√°meƒçek m√≠sto modr√©ho
    if (props.$isInEditRow) {
      return '#dc2626'; // sytƒõ ƒçerven√° barva pro edit ≈ô√°dky m√≠sto ru≈°iv√© modr√©
    }
    const statusColors = getStatusColor(props.$status);
    return statusColors?.dark || STATUS_COLORS.NOVA.dark;
  }};
  box-shadow: ${props => {
    // P≈ôidej st√≠n pro lep≈°√≠ viditelnost na oran≈æov√©m pozad√≠
    if (props.$isInEditRow) {
      return '0 1px 3px rgba(0, 0, 0, 0.2)';
    }
    return 'none';
  }};
`;

// Action Menu
const ActionMenu = styled.div`
  display: flex;
  gap: 0.12rem;
  justify-content: center;
  align-items: center;
`;

const ActionMenuButton = styled.button`
  padding: 0.375rem;
  border: none;
  background: transparent;
  cursor: pointer;
  border-radius: 4px;
  color: #64748b;
  font-size: 0.8rem;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 28px;
  min-height: 28px;

  &:hover {
    background: #f1f5f9;
    color: #1e293b;
  }

  &.edit:hover {
    color: #3b82f6;
    background: #eff6ff;
  }

  &.export-document:hover {
    color: #059669;
    background: #ecfdf5;
  }

  &.delete:hover {
    color: #dc2626;
    background: #fef2f2;
  }

  &:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
`;

// Debug Panel Styles
const DebugPanel = styled.div`
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border: 2px solid #0ea5e9;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  color: white;
  font-family: 'Courier New', monospace;
  box-shadow: 0 8px 32px rgba(14, 165, 233, 0.3);
`;

const DebugHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid rgba(14, 165, 233, 0.3);
`;

const DebugTitle = styled.h3`
  margin: 0;
  color: #0ea5e9;
  font-size: 1.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
`;

const DebugContent = styled.div`
  max-height: 400px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  padding: 1rem;
  border: 1px solid rgba(14, 165, 233, 0.2);
`;

const DebugSection = styled.div`
  margin-bottom: 1rem;
  &:last-child { margin-bottom: 0; }
`;

const DebugLabel = styled.div`
  color: #0ea5e9;
  font-weight: 600;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
`;

const DebugValue = styled.pre`
  margin: 0;
  color: #e2e8f0;
  font-size: 0.75rem;
  line-height: 1.4;
  white-space: pre-wrap;
  word-break: break-all;
  background: rgba(0, 0, 0, 0.2);
  padding: 0.75rem;
  border-radius: 6px;
  border-left: 3px solid #0ea5e9;
`;

// Loading Overlay with blur and fade effects
const LoadingOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(248, 250, 252, 0.95);
  backdrop-filter: blur(${props => props.$visible ? '8px' : '0px'});
  -webkit-backdrop-filter: blur(${props => props.$visible ? '8px' : '0px'});
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: ${props => props.$visible ? 1 : 0};
  transition: opacity 0.5s ease-in-out, backdrop-filter 0.6s ease-in-out;
  pointer-events: ${props => props.$visible ? 'auto' : 'none'};
  
  @media (max-width: 768px) {
    padding: 1rem;
  }
`;

const LoadingSpinner = styled.div`
  width: 64px;
  height: 64px;
  border: 4px solid #e2e8f0;
  border-top: 4px solid #f59e0b;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1.5rem;
  transform: scale(${props => props.$visible ? 1 : 0.8});
  transition: transform 0.5s ease-in-out;
  
  @keyframes spin {
    0% { transform: rotate(0deg) scale(1); }
    100% { transform: rotate(360deg) scale(1); }
  }
`;

const LoadingMessage = styled.div`
  font-size: 1.125rem;
  font-weight: 600;
  color: #374151;
  text-align: center;
  margin-bottom: 0.5rem;
  transform: translateY(${props => props.$visible ? '0' : '10px'});
  opacity: ${props => props.$visible ? 1 : 0};
  transition: transform 0.5s ease-in-out 0.1s, opacity 0.5s ease-in-out 0.1s;
`;

const LoadingSubtext = styled.div`
  font-size: 0.875rem;
  color: #6b7280;
  text-align: center;
  transform: translateY(${props => props.$visible ? '0' : '10px'});
  opacity: ${props => props.$visible ? 1 : 0};
  transition: transform 0.5s ease-in-out 0.15s, opacity 0.5s ease-in-out 0.15s;
`;

const PageContent = styled.div`
  filter: blur(${props => props.$blurred ? '3px' : '0px'});
  transition: filter 0.6s ease-in-out;
  pointer-events: ${props => props.$blurred ? 'none' : 'auto'};
`;

// Modal Dialog Components
const ModalOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease-out;
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
`;

const ModalDialog = styled.div`
  background: white;
  border-radius: 12px;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  border: 1px solid #e5e7eb;
`;

const ModalHeader = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
`;

const ModalIcon = styled.div`
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: ${props => props.danger ? '#fee2e2' : props.warning ? '#fef3c7' : '#dbeafe'};
  display: flex;
  align-items: center;
  justify-content: center;
  color: ${props => props.danger ? '#dc2626' : props.warning ? '#d97706' : '#3b82f6'};
  font-size: 1.5rem;
`;

const ModalTitle = styled.h3`
  font-size: 1.25rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
`;

const ModalContent = styled.div`
  margin-bottom: 2rem;
  line-height: 1.6;
  color: #475569;
`;

const ModalActions = styled.div`
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
`;

// üîí Styled komponenty pro zamƒçenou objedn√°vku dialog
const UserInfo = styled.div`
  padding: 1rem;
  background: #f8fafc;
  border-left: 4px solid #3b82f6;
  border-radius: 4px;
  margin: 1rem 0;
  font-size: 1.1rem;
`;

const InfoText = styled.p`
  margin: 0.75rem 0;
  color: #64748b;
  line-height: 1.6;
`;

const WarningText = styled.p`
  margin: 0.75rem 0;
  color: #dc2626;
  font-weight: 600;
  line-height: 1.6;
`;

const ContactInfo = styled.div`
  margin: 1rem 0;
  padding: 1rem;
  background: #f0f9ff;
  border: 1px solid #bfdbfe;
  border-radius: 8px;
`;

const ContactItem = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.5rem 0;
  color: #1e40af;
  
  &:not(:last-child) {
    border-bottom: 1px solid #e0e7ff;
  }

  svg {
    color: #3b82f6;
    width: 18px;
    height: 18px;
  }

  a {
    color: #1e40af;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;

    &:hover {
      color: #1e3a8a;
      text-decoration: underline;
    }
  }
`;

const ContactLabel = styled.span`
  font-weight: 600;
  min-width: 80px;
  color: #64748b;
`;

const LockTimeInfo = styled.div`
  margin: 0.75rem 0;
  padding: 0.75rem;
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  border-radius: 4px;
  font-size: 0.875rem;
  color: #92400e;
  display: flex;
  align-items: center;
  gap: 0.5rem;

  svg {
    color: #f59e0b;
    width: 16px;
    height: 16px;
  }
`;

const ModalButton = styled.button`
  padding: 0.75rem 1.5rem;
  border: 2px solid;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  
  ${props => props.danger ? `
    background: #dc2626;
    color: white;
    border-color: #dc2626;
    
    &:hover {
      background: #b91c1c;
      border-color: #b91c1c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
    }
  ` : props.$variant === 'primary' ? `
    background: #dc2626;
    color: white;
    border-color: #dc2626;
    
    &:hover {
      background: #b91c1c;
      border-color: #b91c1c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
    }
  ` : props.secondary ? `
    background: white;
    color: #6b7280;
    border-color: #d1d5db;
    
    &:hover {
      background: #f9fafb;
      border-color: #9ca3af;
      color: #374151;
    }
  ` : `
    background: white;
    color: #6b7280;
    border-color: #d1d5db;
    
    &:hover {
      background: #f9fafb;
      border-color: #9ca3af;
      color: #374151;
    }
  `}
`;

// =============================================================================
// FORCE UNLOCK WARNING DIALOG - Styled Components
// =============================================================================

const ForceUnlockWarningOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.2s ease;

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
`;

const ForceUnlockWarningDialog = styled.div`
  background: white;
  border-radius: 16px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  overflow: hidden;
  animation: slideUp 0.3s ease;

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;

const ForceUnlockWarningHeader = styled.div`
  background: linear-gradient(135deg, #fca5a5, #ef4444, #dc2626);
  padding: 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  border-bottom: 3px solid #b91c1c;
`;

const ForceUnlockWarningIcon = styled.div`
  font-size: 2.5rem;
  animation: pulse 2s ease-in-out infinite;
  filter: drop-shadow(0 2px 8px rgba(185, 28, 28, 0.5));

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }
`;

const ForceUnlockWarningTitle = styled.h3`
  margin: 0;
  color: white;
  font-size: 1.25rem;
  font-weight: 800;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  flex: 1;
`;

const ForceUnlockWarningContent = styled.div`
  padding: 1.5rem;
`;

const ForceUnlockWarningMessage = styled.div`
  margin-bottom: 1.25rem;
  line-height: 1.6;
  color: #374151;

  strong {
    color: #dc2626;
    font-weight: 700;
  }

  p {
    margin: 0 0 0.75rem 0;

    &:last-child {
      margin-bottom: 0;
    }
  }
`;

const ForceUnlockWarningDetails = styled.div`
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  border: 2px solid #fecaca;
  border-radius: 12px;
  padding: 1rem;
  margin-top: 1rem;
`;

const ForceUnlockWarningDetailRow = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  font-size: 0.9375rem;

  &:last-child {
    margin-bottom: 0;
  }

  svg {
    color: #dc2626;
    flex-shrink: 0;
  }
`;

const ForceUnlockWarningDetailLabel = styled.span`
  font-weight: 700;
  color: #7f1d1d;
  min-width: 120px;
`;

const ForceUnlockWarningDetailValue = styled.span`
  color: #991b1b;
  flex: 1;
`;

const ForceUnlockWarningActions = styled.div`
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 2px solid #f3f4f6;
`;

const ForceUnlockWarningButton = styled.button`
  padding: 0.75rem 1.5rem;
  border: 2px solid;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.9375rem;
  cursor: pointer;
  transition: all 0.2s ease;

  ${props => props.$primary ? `
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);

    &:hover {
      background: linear-gradient(135deg, #b91c1c, #991b1b);
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
      transform: translateY(-2px);
    }

    &:active {
      transform: translateY(0);
    }
  ` : `
    background: white;
    color: #6b7280;
    border-color: #d1d5db;

    &:hover {
      background: #f9fafb;
      border-color: #9ca3af;
      color: #374151;
    }
  `}
`;

// =============================================================================
// MULTISELECT KOMPONENTA (mimo hlavn√≠ komponentu aby se nevytv√°≈ôela p≈ôi ka≈æd√©m renderu)
// =============================================================================

const MultiSelectLocal = ({ field, value, onChange, options, placeholder, icon }) => {
  const [isOpen, setIsOpen] = React.useState(false);
  const [searchTerm, setSearchTerm] = React.useState(''); // üîç P≈ôid√°no vyhled√°v√°n√≠
  const dropdownRef = React.useRef(null);
  const searchInputRef = React.useRef(null);
  
  // Zav≈ôi dropdown p≈ôi kliku mimo
  React.useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
        setSearchTerm(''); // Vyma≈æ vyhled√°v√°n√≠ p≈ôi zav≈ôen√≠
      }
    };
    
    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [isOpen]);

  // üîç Focus na vyhled√°vac√≠ pole p≈ôi otev≈ôen√≠
  React.useEffect(() => {
    if (isOpen && searchInputRef.current) {
      setTimeout(() => {
        searchInputRef.current?.focus();
      }, 100);
    }
  }, [isOpen]);
  
  // Memoizuj aktu√°ln√≠ hodnoty pro rychlej≈°√≠ porovn√°v√°n√≠
  const valueSet = React.useMemo(() => {
    const arr = Array.isArray(value) ? value : [];
    // P≈ôeveƒè v≈°echny hodnoty na stringy pro konzistentn√≠ porovn√°v√°n√≠
    return new Set(arr.map(v => String(v)));
  }, [value]);

  // üîç Filtrovan√© options podle vyhled√°v√°n√≠
  const filteredOptions = React.useMemo(() => {
    if (!searchTerm.trim()) return options;
    
    const search = searchTerm.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    return options.filter(opt => {
      const label = (opt.displayName || opt.nazev_stavu || opt.nazev || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      return label.includes(search);
    });
  }, [options, searchTerm]);
  
  const getDisplayValue = React.useCallback(() => {
    if (!value || value.length === 0) return placeholder || 'Vyberte...';
    if (value.length === 1) {
      const opt = options?.find(o => String(o.id) === String(value[0]));
      // Pro n√°zvy pou≈æij po≈ôad√≠: displayName > nazev_stavu > nazev
      return opt ? (opt.displayName || opt.nazev_stavu || opt.nazev || value[0]) : value[0];
    }
    return `Vybr√°no: ${value.length}`;
  }, [value, options, placeholder]);

  const handleToggle = React.useCallback((optValue) => {
    const currentValue = Array.isArray(value) ? value : [];
    const newValue = currentValue.includes(optValue)
      ? currentValue.filter(v => v !== optValue)
      : [...currentValue, optValue];
    
    // MultiSelectLocal value change
    
    // Vytvo≈ô fake event s options pro kompatibilitu s existuj√≠c√≠mi handlery
    const fakeEvent = {
      target: {
        options: newValue.map(v => ({ value: v, selected: true }))
      }
    };
    onChange(fakeEvent);
  }, [value, onChange, field]);

  const handleMainClick = React.useCallback((e) => {
    e.stopPropagation();
    setIsOpen(prev => !prev);
  }, []);

  const handleItemClick = React.useCallback((e, optValue) => {
    e.stopPropagation();
    handleToggle(optValue);
  }, [handleToggle]);

  // Pokud nejsou options, zobraz placeholder
  if (!options || options.length === 0) {
    return (
      <div style={{ 
        padding: '0.75rem 2.5rem',
        border: '2px solid #e5e7eb',
        borderRadius: '8px',
        color: '#9ca3af',
        fontSize: '0.875rem'
      }}>
        Naƒç√≠t√°n√≠...
      </div>
    );
  }

  return (
    <div ref={dropdownRef} style={{ position: 'relative', width: '100%' }}>
      <div
        onClick={handleMainClick}
        style={{
          width: '100%',
          padding: '0.75rem 2.5rem 0.75rem 2.5rem',
          border: '2px solid #e5e7eb',
          borderRadius: '8px',
          fontSize: '0.875rem',
          background: '#ffffff',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          position: 'relative',
          color: (!value || value.length === 0) ? '#9ca3af' : '#1f2937',
          fontWeight: (value && value.length > 0) ? '600' : '400'
        }}
      >
        <span>{getDisplayValue()}</span>
        <svg
          style={{ 
            position: 'absolute', 
            right: '0.5rem',
            width: '16px',
            height: '16px',
            transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)',
            transition: 'transform 0.2s ease',
            pointerEvents: 'none'
          }}
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#374151"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>
      
      {isOpen && (
        <div style={{
          position: 'absolute',
          top: '100%',
          left: 0,
          right: 0,
          marginTop: '4px',
          background: '#ffffff',
          border: '2px solid #3b82f6',
          borderRadius: '8px',
          zIndex: 9999,
          boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
          display: 'flex',
          flexDirection: 'column',
          maxHeight: '400px'
        }}>
          {/* üîç Vyhled√°vac√≠ pole */}
          <div style={{
            padding: '0.75rem',
            borderBottom: '2px solid #e5e7eb',
            position: 'sticky',
            top: 0,
            background: '#ffffff',
            zIndex: 1
          }}>
            <div style={{ position: 'relative', width: '100%' }}>
              <FontAwesomeIcon 
                icon={faSearch} 
                style={{
                  position: 'absolute',
                  left: '0.75rem',
                  top: '50%',
                  transform: 'translateY(-50%)',
                  color: '#9ca3af',
                  width: '12px',
                  height: '12px',
                  pointerEvents: 'none',
                  zIndex: 1
                }}
              />
              <input
                ref={searchInputRef}
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Hledat..."
                style={{
                  width: '100%',
                  padding: '0.5rem 0.75rem 0.5rem 2rem',
                  border: '1px solid #d1d5db',
                  borderRadius: '6px',
                  fontSize: '0.875rem',
                  outline: 'none',
                  transition: 'border-color 0.2s'
                }}
                onFocus={(e) => e.target.style.borderColor = '#3b82f6'}
                onBlur={(e) => e.target.style.borderColor = '#d1d5db'}
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </div>
          
          {/* Seznam options */}
          <div style={{
            overflowY: 'auto',
            maxHeight: '300px'
          }}>
            {filteredOptions.length === 0 ? (
              <div style={{
                padding: '1rem',
                textAlign: 'center',
                color: '#9ca3af',
                fontSize: '0.875rem'
              }}>
                ≈Ω√°dn√© v√Ωsledky
              </div>
            ) : (
              filteredOptions.map((opt, idx) => {
                const optValue = String(opt.id || '');
                const optLabel = opt.displayName || opt.nazev_stavu || opt.nazev || 'Bez n√°zvu';
                const isSelected = valueSet.has(optValue);
                
                if (!optValue) {
                  return null; // P≈ôeskoƒç polo≈æky bez ID
                }
                
                return (
                  <div
                    key={optValue}
                    onClick={(e) => handleItemClick(e, optValue)}
                    style={{
                      padding: '0.75rem 1rem',
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      background: isSelected ? '#eff6ff' : '#ffffff',
                      borderBottom: '1px solid #f3f4f6',
                      fontSize: '0.875rem',
                      transition: 'background 0.15s'
                    }}
                    onMouseEnter={(e) => {
                      if (!isSelected) e.currentTarget.style.background = '#f9fafb';
                    }}
                    onMouseLeave={(e) => {
                      if (!isSelected) e.currentTarget.style.background = '#ffffff';
                    }}
                  >
                    <input
                      type="checkbox"
                      checked={isSelected}
                      readOnly
                      style={{ 
                        cursor: 'pointer',
                        width: '16px',
                        height: '16px',
                        accentColor: '#3b82f6',
                        pointerEvents: 'none'
                      }}
                    />
                    <span style={{ 
                      fontWeight: isSelected ? '600' : '400',
                      color: isSelected ? '#1f2937' : '#4b5563'
                    }}>
                      {optLabel}
                    </span>
                  </div>
                );
              })
            )}
          </div>
        </div>
      )}
      
      {/* Ikona vlevo dole */}
      {icon && (
        <div style={{
          position: 'absolute',
          left: '0.75rem',
          bottom: '0.75rem',
          color: '#9ca3af',
          pointerEvents: 'none',
          fontSize: '14px'
        }}>
          {icon}
        </div>
      )}
    </div>
  );
};

// =============================================================================
// DATEPICKER KOMPONENTA
// =============================================================================

const DatePicker = ({ value, onChange, placeholder = 'Vyberte datum' }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [openUpwards, setOpenUpwards] = useState(false);
  const wrapperRef = useRef(null);

  const selectedDate = value ? new Date(value) : null;

  useEffect(() => {
    if (value) {
      const date = new Date(value);
      if (!isNaN(date.getTime())) {
        setCurrentMonth(date);
      }
    }
  }, [value]);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => document.removeEventListener('mousedown', handleClickOutside);
    }
  }, [isOpen]);

  useEffect(() => {
    if (isOpen && wrapperRef.current) {
      const checkPosition = () => {
        if (!wrapperRef.current) return;
        const buttonRect = wrapperRef.current.getBoundingClientRect();
        const calendarHeight = 380;
        const footerHeight = 54;
        const buffer = 20;
        const spaceBelow = window.innerHeight - buttonRect.bottom - footerHeight - buffer;
        const spaceAbove = buttonRect.top - buffer;
        const shouldOpenUpward = spaceBelow < 300 || (spaceBelow < calendarHeight && spaceAbove > spaceBelow + 50);
        setOpenUpwards(shouldOpenUpward);
      };
      checkPosition();
    }
  }, [isOpen]);

  const formatDisplayDate = (date) => {
    if (!date) return '';
    try {
      const d = new Date(date);
      if (isNaN(d.getTime())) return '';
      return d.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch {
      return '';
    }
  };

  const formatInputDate = (date) => {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  const getCalendarDays = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
    const days = [];
    for (let i = startDay - 1; i >= 0; i--) {
      const date = new Date(year, month, -i);
      days.push({ date, isOtherMonth: true });
    }
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const date = new Date(year, month, i);
      days.push({ date, isOtherMonth: false });
    }
    const remainingDays = 42 - days.length;
    for (let i = 1; i <= remainingDays; i++) {
      const date = new Date(year, month + 1, i);
      days.push({ date, isOtherMonth: true });
    }
    return days;
  };

  const handleDateSelect = (date) => {
    onChange(formatInputDate(date));
    setIsOpen(false);
  };

  const handleToday = (e) => {
    e?.preventDefault();
    e?.stopPropagation();
    handleDateSelect(new Date());
  };

  const handleClear = (e) => {
    e?.preventDefault();
    e?.stopPropagation();
    onChange('');
    setIsOpen(false);
  };

  const prevMonth = (e) => {
    e?.preventDefault();
    e?.stopPropagation();
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
  };

  const nextMonth = (e) => {
    e?.preventDefault();
    e?.stopPropagation();
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));
  };

  const today = new Date();
  const calendarDays = getCalendarDays();
  const displayText = value ? formatDisplayDate(value) : placeholder;

  return (
    <DatePickerWrapper ref={wrapperRef}>
      <InputWithIcon hasIcon>
        <Calendar size={18} style={{ position: 'absolute', left: '0.75rem', top: '50%', transform: 'translateY(-50%)', color: '#9ca3af', pointerEvents: 'none' }} />
        <DateInputButton
          type="button"
          onClick={() => setIsOpen(!isOpen)}
          hasValue={!!value}
        >
          {displayText}
        </DateInputButton>
        {value && (
          <DateClearButton type="button" onClick={handleClear} title="Smazat datum">‚úï</DateClearButton>
        )}
        <DateTodayButton type="button" onClick={handleToday} title="Nastavit dne≈°n√≠ datum">üìÖ</DateTodayButton>
      </InputWithIcon>
      {isOpen && (
        <DateCalendarPopup openUpwards={openUpwards}>
          <CalendarHeader>
            <CalendarNav onClick={prevMonth}>‚óÄ</CalendarNav>
            <CalendarTitle>
              <span>{currentMonth.toLocaleDateString('cs-CZ', { month: 'long' })}</span>
              <span>{currentMonth.getFullYear()}</span>
            </CalendarTitle>
            <CalendarNav onClick={nextMonth}>‚ñ∂</CalendarNav>
          </CalendarHeader>
          <CalendarGrid>
            {['Po', '√öt', 'St', 'ƒåt', 'P√°', 'So', 'Ne'].map((day) => (
              <CalendarDay key={day}>{day}</CalendarDay>
            ))}
            {calendarDays.map((day, index) => {
              const isToday = day.date.toDateString() === today.toDateString();
              const isSelected = selectedDate && day.date.toDateString() === selectedDate.toDateString();
              return (
                <CalendarDate
                  key={index}
                  onClick={() => handleDateSelect(day.date)}
                  isToday={isToday}
                  isSelected={isSelected}
                  isOtherMonth={day.isOtherMonth}
                >
                  {day.date.getDate()}
                </CalendarDate>
              );
            })}
          </CalendarGrid>
          <CalendarFooter>
            <CalendarButton className="today" onClick={handleToday}>Dnes</CalendarButton>
            <CalendarButton className="clear" onClick={handleClear}>Smazat</CalendarButton>
          </CalendarFooter>
        </DateCalendarPopup>
      )}
    </DatePickerWrapper>
  );
};

const DatePickerWrapper = styled.div`
  position: relative;
  width: 100%;
`;

const InputWithIcon = styled.div`
  position: relative;
  width: 100%;
`;

const DateInputButton = styled.button`
  width: 100%;
  display: block;
  padding: 0.75rem;
  padding-left: 2.75rem;
  padding-right: ${props => props.hasValue ? '4.5rem' : '3rem'};
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  background: white;
  color: ${props => props.hasValue ? '#1f2937' : '#9ca3af'};
  font-size: 0.875rem;
  font-weight: ${props => props.hasValue ? '600' : '400'};
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 42px;
  &:hover {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
`;

const DateClearButton = styled.button`
  position: absolute;
  right: 36px;
  top: 50%;
  transform: translateY(-50%);
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s ease;
  z-index: 1;
  &:hover {
    background: #dc2626;
    transform: translateY(-50%) scale(1.1);
  }
`;

const DateTodayButton = styled.button`
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: #10b981;
  color: white;
  border: none;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: bold;
  transition: all 0.2s ease;
  z-index: 1;
  &:hover {
    background: #059669;
    transform: translateY(-50%) scale(1.1);
  }
`;

const DateCalendarPopup = styled.div`
  position: absolute;
  ${props => props.openUpwards ? `bottom: calc(100% + 4px); top: auto;` : `top: calc(100% + 4px); bottom: auto;`}
  left: 0;
  right: 0;
  z-index: 10001;
  background: white;
  border: 2px solid #3b82f6;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  padding: 0.5rem;
`;

const CalendarHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  padding-bottom: 0.35rem;
  border-bottom: 1px solid #e5e7eb;
`;

const CalendarNav = styled.button`
  background: #f3f4f6;
  border: none;
  border-radius: 4px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #374151;
  font-weight: 600;
  font-size: 0.875rem;
  transition: all 0.2s ease;
  &:hover {
    background: #3b82f6;
    color: white;
    transform: scale(1.1);
  }
`;

const CalendarTitle = styled.div`
  font-weight: 600;
  font-size: 0.85rem;
  color: #111827;
  display: flex;
  gap: 0.35rem;
`;

const CalendarGrid = styled.div`
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 1px;
`;

const CalendarDay = styled.div`
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  font-weight: 600;
  color: #6b7280;
  padding: 0.15rem;
`;

const CalendarDate = styled.button`
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  border: none;
  border-radius: 4px;
  background: ${props => props.isToday ? '#dbeafe' : props.isSelected ? '#3b82f6' : 'transparent'};
  color: ${props => props.isSelected ? 'white' : props.isOtherMonth ? '#9ca3af' : '#374151'};
  font-weight: ${props => props.isToday || props.isSelected ? '600' : '400'};
  cursor: pointer;
  transition: all 0.2s ease;
  &:hover {
    background: ${props => props.isSelected ? '#2563eb' : '#f3f4f6'};
    transform: scale(1.1);
    color: ${props => props.isSelected ? 'white' : '#111827'};
  }
`;

const CalendarFooter = styled.div`
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 2px solid #e5e7eb;
`;

const CalendarButton = styled.button`
  flex: 1;
  padding: 0.5rem;
  border: none;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  &.today {
    background: #dbeafe;
    color: #1e40af;
    &:hover {
      background: #bfdbfe;
    }
  }
  &.clear {
    background: #fee2e2;
    color: #991b1b;
    &:hover {
      background: #fecaca;
    }
  }
`;

// =============================================================================
// MAIN COMPONENT
// =============================================================================

const Orders25List = () => {
  const navigate = useNavigate();
  const { user, token, username, hasPermission, user_id, userDetail } = useContext(AuthContext);
  const { setProgress } = useContext(ProgressContext) || {};
  const { setDebugInfo } = useContext(DebugContext) || {};
  const { showToast } = useContext(ToastContext) || {};

  // ÔøΩ CRITICAL FIX: API V2 vrac√≠ ID jako NUMBER, AuthContext m√° user_id jako STRING
  // Konverze na number pro v≈°echna porovn√°n√≠
  const currentUserId = useMemo(() => parseInt(user_id, 10), [user_id]);

  // Helper funkce pro user-specific localStorage kl√≠ƒçe
  const getUserKey = (baseKey) => `${baseKey}_user_${currentUserId || 'anon'}`;
  
  // Helper funkce pro ukl√°d√°n√≠/naƒç√≠t√°n√≠ s user izolac√≠
  const getUserStorage = (baseKey, defaultValue = null) => {
    try {
      const saved = localStorage.getItem(getUserKey(baseKey));
      return saved !== null ? JSON.parse(saved) : defaultValue;
    } catch {
      return defaultValue;
    }
  };
  
  const setUserStorage = (baseKey, value) => {
    try {
      localStorage.setItem(getUserKey(baseKey), JSON.stringify(value));
    } catch (e) {
      // Failed to save to localStorage
    }
  };
  const bgTasksContext = useBackgroundTasks();
  
  // üöÄ CACHE FIX: Stabilizuj permissions pro dependencies (useMemo m√≠sto p≈ô√≠m√©ho vol√°n√≠ hasPermission)
  // Toto zabr√°n√≠ zbyteƒçn√©mu rerendering p≈ôi ka≈æd√©m F5
  const permissions = useMemo(() => {
    if (!hasPermission) return { canViewAll: false, hasOnlyOwn: false };
    
    const canViewAll = hasPermission('ORDER_MANAGE') || 
                       hasPermission('ORDER_READ_ALL') ||
                       hasPermission('ORDER_VIEW_ALL') ||
                       hasPermission('ORDER_EDIT_ALL') ||
                       hasPermission('ORDER_DELETE_ALL');
    
    const hasOnlyOwn = !canViewAll && (
      hasPermission('ORDER_READ_OWN') ||
      hasPermission('ORDER_VIEW_OWN') ||
      hasPermission('ORDER_EDIT_OWN') ||
      hasPermission('ORDER_DELETE_OWN')
    );
    
    return { canViewAll, hasOnlyOwn };
  }, [hasPermission]);
  
  // üîß OPTIMALIZACE: Ref pro aktu√°ln√≠ hodnotu permissions
  // Pou≈æit√≠ v loadData useCallback pro odstranƒõn√≠ circular dependency
  const permissionsRef = useRef(permissions);
  
  // Aktualizuj ref p≈ôi ka≈æd√© zmƒõnƒõ permissions
  useEffect(() => {
    permissionsRef.current = permissions;
  }, [permissions]);
  
  // State
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [users, setUsers] = useState({});
  
  // üé¨ STATE pro inicializaci - splash screen zmiz√≠ a≈æ po dokonƒçen√≠ V≈†EHO
  const [initializationComplete, setInitializationComplete] = useState(false);
  const [splashVisible, setSplashVisible] = useState(true); // Pro fade efekt
  
  // üöÄ CACHE: State pro tracking cache info
  const [lastLoadSource, setLastLoadSource] = useState(null); // 'cache' | 'database' | null
  const [lastLoadTime, setLastLoadTime] = useState(null);
  const [lastLoadDuration, setLastLoadDuration] = useState(null); // Jak dlouho trvalo naƒçten√≠ (ms)
  
  // Dropdown lists - p≈ôipraven√© seznamy pro rychl√© zobrazen√≠
  const [objednatelList, setObjednatelList] = useState([]);
  const [garantList, setGarantList] = useState([]);
  const [schvalovatelList, setSchvalovatelList] = useState([]);
  
  // Data z DB pro filtry
  const [allUsers, setAllUsers] = useState([]); // v≈°ichni u≈æivatel√© z DB pro filtry
  const [approversList, setApproversList] = useState([]); // schvalovatel√© z DB
  const [orderStatesList, setOrderStatesList] = useState([]); // stavy objedn√°vek z ƒç√≠seln√≠ku
  const [lpKodyList, setLpKodyList] = useState([]); // LP k√≥dy pro p≈ôevod ID na n√°zvy
  const [showEditConfirmModal, setShowEditConfirmModal] = useState(false);
  const [orderToEdit, setOrderToEdit] = useState(null);
  const [currentDraftData, setCurrentDraftData] = useState(null); // Data draftu pro zobrazen√≠ v modalu
  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false);
  const [orderToDelete, setOrderToDelete] = useState(null);
  const [showArchivedWarningModal, setShowArchivedWarningModal] = useState(false);
  const [showArchivedWithDraftWarningModal, setShowArchivedWithDraftWarningModal] = useState(false); // Kombinovan√Ω modal
  
  // üîí Nov√Ω state pro dialog zamƒçen√© objedn√°vky
  const [showLockedOrderDialog, setShowLockedOrderDialog] = useState(false);
  const [lockedOrderInfo, setLockedOrderInfo] = useState(null); // Info o zamƒçen√≠: { lockedByUserName, canForceUnlock, orderId }
  
  // ‚ö†Ô∏è State pro Force Unlock Warning Dialog
  const [showForceUnlockWarning, setShowForceUnlockWarning] = useState(false);
  const [forceUnlockWarningData, setForceUnlockWarningData] = useState(null); // { orderNumber, lockedBy, lockedByEmail, lockedByPhone, lockedAt }
  
  const [showDashboard, setShowDashboard] = useState(() => {
    // Naƒçti stav z localStorage s user izolac√≠, v√Ωchoz√≠ je true (zobrazeno)
    return getUserStorage('orders25List_showDashboard', true);
  });
  
  // üß™ DEBUG: State pro Order V2 API test panel
  const [showApiTestPanel, setShowApiTestPanel] = useState(false);
  const [apiTestData, setApiTestData] = useState(null);
  const [showFiltersPanel, setShowFiltersPanel] = useState(() => {
    // Naƒçti stav z localStorage pro zobrazen√≠ cel√©ho panelu filtr≈Ø s user izolac√≠, v√Ωchoz√≠ je true (zobrazeno)
    return getUserStorage('orders25List_showFiltersPanel', true);
  });
  const [showFilters, setShowFilters] = useState(() => {
    // Naƒçti stav z localStorage s user izolac√≠, v√Ωchoz√≠ je false (skryto)
    return getUserStorage('orders25List_showFilters', false);
  });
  const [showDebug, setShowDebug] = useState(() => {
    // Naƒçti stav z localStorage s user izolac√≠, v√Ωchoz√≠ je false (skryto)
    return getUserStorage('orders25List_showDebug', false);
  });
  const [dashboardCompact, setDashboardCompact] = useState(() => {
    // Naƒçti stav z localStorage s user izolac√≠, v√Ωchoz√≠ je true (kompaktn√≠)
    return getUserStorage('orders25List_dashboardCompact', true);
  });
  const [activeStatusFilter, setActiveStatusFilter] = useState(() => {
    return getUserStorage('orders25List_activeStatusFilter', null);
  }); // Pro dashboard klikac√≠ filtry
  const [rawData, setRawData] = useState(null);
  const [initializing, setInitializing] = useState(true);
  
  // Filters - load from localStorage s user izolac√≠
  const [globalFilter, setGlobalFilter] = useState(() => {
    return getUserStorage('orders25List_globalFilter', '');
  });
  const [statusFilter, setStatusFilter] = useState(() => {
    const saved = getUserStorage('orders25List_statusFilter', []);
    // Pokud je ulo≈æen√© jako string (backward compatibility), p≈ôeveƒè na pole
    return Array.isArray(saved) ? saved : (saved ? [saved] : []);
  });
  const [userFilter, setUserFilter] = useState(() => {
    return getUserStorage('orders25List_userFilter', '');
  });
  
  // Simple dropdown selections (just for showing selected values) - CHANGED TO ARRAYS for multiselect
  const [selectedObjednatel, setSelectedObjednatel] = useState(() => {
    const saved = getUserStorage('orders25List_selectedObjednatel', []);
    // Backward compatibility: p≈ôeveƒè string na pole
    return Array.isArray(saved) ? saved : (saved ? [saved] : []);
  });
  const [selectedGarant, setSelectedGarant] = useState(() => {
    const saved = getUserStorage('orders25List_selectedGarant', []);
    // Backward compatibility: p≈ôeveƒè string na pole
    return Array.isArray(saved) ? saved : (saved ? [saved] : []);
  });
  const [selectedSchvalovatel, setSelectedSchvalovatel] = useState(() => {
    const saved = getUserStorage('orders25List_selectedSchvalovatel', []);
    // Backward compatibility: p≈ôeveƒè string na pole
    return Array.isArray(saved) ? saved : (saved ? [saved] : []);
  });
  const [selectedPrikazce, setSelectedPrikazce] = useState(() => {
    const saved = getUserStorage('orders25List_selectedPrikazce', []);
    // Backward compatibility: p≈ôeveƒè string na pole
    return Array.isArray(saved) ? saved : (saved ? [saved] : []);
  });
  const [dateFromFilter, setDateFromFilter] = useState('');
  const [dateToFilter, setDateToFilter] = useState('');
  const [amountFromFilter, setAmountFromFilter] = useState(() => {
    return getUserStorage('orders25List_amountFrom', '');
  });
  const [amountToFilter, setAmountToFilter] = useState(() => {
    return getUserStorage('orders25List_amountTo', '');
  });
  
  // Filtry pro zve≈ôejnƒõn√≠
  const [filterMaBytZverejneno, setFilterMaBytZverejneno] = useState(() => {
    return getUserStorage('orders25List_filterMaBytZverejneno', false);
  });
  const [filterByloZverejneno, setFilterByloZverejneno] = useState(() => {
    return getUserStorage('orders25List_filterByloZverejneno', false);
  });
  
  // Highlight newly created order
  const [highlightOrderId, setHighlightOrderId] = useState(null);
  
  // Column-specific filters
  const [columnFilters, setColumnFilters] = useState({
    dt_objednavky: '',
    cislo_objednavky: '',
    predmet: '',
    objednatel: '',
    stav_objednavky: '',
    max_cena_s_dph: '',
    garant: '',
    prikazce: '',
    schvalovatel: ''
  });
  
  // Row highlighting by status (zv√Ωraz≈àov√°n√≠ podle stavu)
  const [showRowHighlighting, setShowRowHighlighting] = useState(() => {
    return getUserStorage('orders25List_showRowHighlighting', true);
  });
  
  // Row striping (alternating colors) - deprecated, nahrazeno highlighting
  const [showRowStriping, setShowRowStriping] = useState(() => {
    return getUserStorage('orders25List_showRowStriping', false); // V√Ωchoz√≠ false - pou≈æ√≠v√°me highlighting
  });
  
  // Year filter - load from localStorage s user izolac√≠ or use current year
  const [selectedYear, setSelectedYear] = useState(() => {
    const saved = getUserStorage('orders25List_selectedYear', null);
    return saved !== null ? saved : new Date().getFullYear();
  });

  // Month filter - load from localStorage s user izolac√≠ or use "all" (v≈°echny mƒõs√≠ce)
  const [selectedMonth, setSelectedMonth] = useState(() => {
    return getUserStorage('orders25List_selectedMonth', 'all'); // all, last-month, last-quarter, last-half, nebo "1-3" (konkr√©tn√≠ mƒõs√≠ce)
  });

  // Show expanded month options
  const [showExpandedMonths, setShowExpandedMonths] = useState(() => {
    const saved = getUserStorage('orders25List_selectedMonth', 'all');
    // Pokud je ulo≈æen√° hodnota mimo z√°kladn√≠ 4, zobraz roz≈°√≠≈ôen√© mo≈ænosti
    return saved && !['all', 'last-month', 'last-quarter', 'last-half'].includes(saved);
  });

  // Show archived orders checkbox - defaultnƒõ false (neza≈°krtnuto = nezobrazovat archivovan√©)
  const [showArchived, setShowArchived] = useState(() => {
    return getUserStorage('orders25List_showArchived', false);
  });

  // "JEN MOJE" filter - pouze pro SUPERADMIN a ADMINISTRATOR
  const [showOnlyMyOrders, setShowOnlyMyOrders] = useState(() => {
    return getUserStorage('orders25List_showOnlyMyOrders', false);
  });

  // Ref pro mƒõs√≠ƒçn√≠ select
  const monthSelectRef = useRef(null);
  
  // Ref pro roƒçn√≠ select
  const yearSelectRef = useRef(null);
  
  // Stav pro otev≈ôen√≠ mƒõs√≠ƒçn√≠ho dropdownu
  const [isMonthDropdownOpen, setIsMonthDropdownOpen] = useState(false);
  
  // Stav pro otev≈ôen√≠ roƒçn√≠ho dropdownu
  const [isYearDropdownOpen, setIsYearDropdownOpen] = useState(false);

  // Custom Select states
  const [selectStates, setSelectStates] = useState({});
  const [searchStates, setSearchStates] = useState({});
  const [touchedSelectFields, setTouchedSelectFields] = useState(new Set());
  const [hasTriedToSubmit, setHasTriedToSubmit] = useState(false);

  // Kontextov√© menu
  const [contextMenu, setContextMenu] = useState(null); // { x, y, order }
  
  // DOCX Generator Modal
  const [docxModalOpen, setDocxModalOpen] = useState(false);
  const [docxModalOrder, setDocxModalOrder] = useState(null);

  // Memoizovan√© options pro MultiSelect - aby se nevytv√°≈ôely nov√© pole p≈ôi ka≈æd√©m renderu
  const sortedAllUsers = useMemo(() => {
    const processed = [...allUsers].map(user => {
      // Najdi prvn√≠ dostupn√© ID
      const userId = user.id || user.uzivatel_id || user.user_id;
      if (!userId) {
        // User without ID - data issue
      }
      return {
        ...user,
        id: userId // V≈ædy nastav id
      };
    }).sort((a, b) => {
      const nameA = a.displayName || '';
      const nameB = b.displayName || '';
      return nameA.localeCompare(nameB);
    });
    
    return processed;
  }, [allUsers]);

  const sortedApprovers = useMemo(() => {
    return [...approversList].map(approver => {
      // Najdi prvn√≠ dostupn√© ID
      const approverId = approver.id || approver.user_id || approver.uzivatel_id;
      if (!approverId) {
        // Approver without ID - data issue
      }
      return {
        ...approver,
        id: approverId, // V≈ædy nastav id
        // Normalizuj displayName
        displayName: approver.displayName || approver.jmeno_prijmeni || `${approver.jmeno || ''} ${approver.prijmeni || ''}`.trim() || `User ${approverId}`
      };
    }).sort((a, b) => {
      const nameA = a.displayName || '';
      const nameB = b.displayName || '';
      return nameA.localeCompare(nameB);
    });
  }, [approversList]);

  const statusOptions = useMemo(() => {
    return [...orderStatesList].map(status => {
      const statusId = status.kod_stavu || status.id;
      if (!statusId) {
        // Status without ID - data issue
      }
      return {
        ...status,
        id: statusId // V≈ædy nastav id (z kod_stavu)
      };
    });
  }, [orderStatesList]);

  // Listen for calendar date filter changes from Layout.js
  useEffect(() => {
    const handleDateFilterChange = (event) => {
      const { dateFrom, dateTo, userId } = event.detail || {};
      const currentUserId = user_id || 'anon';
      
      // Only react if the event is for current user
      if (userId !== currentUserId) return;
      
      if (dateFrom) {
        setDateFromFilter(dateFrom || '');
      }
      if (dateTo !== undefined) { // Allow empty string to clear
        setDateToFilter(dateTo || '');
      }
    };
    
    window.addEventListener('orders25_date_filter_changed', handleDateFilterChange);
    
    return () => {
      window.removeEventListener('orders25_date_filter_changed', handleDateFilterChange);
    };
  }, [user_id]);

  // Load date filters from localStorage when user_id becomes available
  useEffect(() => {
    if (!user_id) return;
    
    const sid = user_id || 'anon';
    const dateFromKey = `orders25_dateFrom_${sid}`;
    const dateToKey = `orders25_dateTo_${sid}`;
    
    try {
      const savedFrom = localStorage.getItem(dateFromKey);
      const savedTo = localStorage.getItem(dateToKey);
      if (savedFrom && !dateFromFilter) setDateFromFilter(savedFrom || '');
      if (savedTo && !dateToFilter) setDateToFilter(savedTo || '');
    } catch (_) {}
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user_id]); // Naƒçti jen jednou kdy≈æ se user_id zmƒõn√≠

  // Table pagination - load from localStorage
  const [pageSize, setPageSize] = useState(() => {
    const saved = localStorage.getItem('orders25List_pageSize');
    return saved ? parseInt(saved, 10) : 25;
  });
  
  const [currentPageIndex, setCurrentPageIndex] = useState(() => {
    const saved = localStorage.getItem('orders25List_pageIndex');
    return saved ? parseInt(saved, 10) : 0;
  });
  
  // Table sorting - load from user-specific localStorage
  const [sorting, setSorting] = useState(() => {
    return getUserStorage('orders25List_sorting', []);
  });

  // üìç EXPANDED ROWS: State pro rozbalen√© ≈ô√°dky (ukl√°d√°me row index, ne ID)
  const [expanded, setExpanded] = useState({});

  // üîß OPTIMALIZACE: Batch update v≈°ech filtr≈Ø do localStorage najednou
  // Nahrazuje 14 samostatn√Ωch useEffects ‚Üí 1 useEffect
  // V√Ωhody: rychlej≈°√≠ p≈ôi zmƒõnƒõ user_id, m√©nƒõ re-render≈Ø, lep≈°√≠ ƒçitelnost
  useEffect(() => {
    if (!user_id) return; // ƒåekej na user_id
    
    // Jednoduch√© filtry - p≈ô√≠m√© ulo≈æen√≠
    const simpleFilters = {
      'orders25List_globalFilter': globalFilter,
      'orders25List_statusFilter': statusFilter,
      'orders25List_userFilter': userFilter,
      'orders25List_selectedObjednatel': selectedObjednatel,
      'orders25List_selectedGarant': selectedGarant,
      'orders25List_selectedSchvalovatel': selectedSchvalovatel,
      'orders25List_selectedPrikazce': selectedPrikazce,
      'orders25List_amountFrom': amountFromFilter,
      'orders25List_amountTo': amountToFilter,
      'orders25List_filterMaBytZverejneno': filterMaBytZverejneno,
      'orders25List_filterByloZverejneno': filterByloZverejneno,
      'orders25List_activeStatusFilter': activeStatusFilter,
      'orders25List_sorting': sorting // ‚Üê P≈ôid√°no sorting
    };
    
    // Batch save v≈°ech jednoduch√Ωch filtr≈Ø
    Object.entries(simpleFilters).forEach(([key, value]) => {
      setUserStorage(key, value);
    });
    
    // Speci√°ln√≠ handling pro datum filtry (odstranƒõn√≠ pokud pr√°zdn√©)
    if (dateFromFilter) {
      setUserStorage('orders25_dateFrom', dateFromFilter);
    } else {
      const key = getUserKey('orders25_dateFrom');
      localStorage.removeItem(key);
    }
    
    if (dateToFilter) {
      setUserStorage('orders25_dateTo', dateToFilter);
    } else {
      const key = getUserKey('orders25_dateTo');
      localStorage.removeItem(key);
    }
  }, [
    globalFilter, 
    statusFilter, 
    userFilter, 
    selectedObjednatel, 
    selectedGarant, 
    selectedSchvalovatel, 
    selectedPrikazce, 
    dateFromFilter, 
    dateToFilter, 
    amountFromFilter, 
    amountToFilter, 
    filterMaBytZverejneno, 
    filterByloZverejneno, 
    activeStatusFilter,
    sorting, // ‚Üê P≈ôid√°no sorting do dependencies
    user_id
  ]);

  // üìç SCROLL STATE: Ref pro tracking zda u≈æ byla pozice obnovena
  const scrollStateRestored = React.useRef(false);
  const isFirstRender = React.useRef(true); // ‚Üê Track first render
  
  // üìç SCROLL STATE: Pamatuj si p≈ôedchoz√≠ filtry pro detekci RE√ÅLN√â zmƒõny
  const prevFiltersRef = React.useRef(null);
  
  // üìç SCROLL STATE: Ref pro ulo≈æen√© ID rozbalen√Ωch objedn√°vek (obnov pozdƒõji kdy≈æ je filteredData ready)
  const pendingExpandedOrderIds = React.useRef(null);
  
  // üìç SCROLL STATE: Ref na filteredData (pro pou≈æit√≠ v save useEffect)
  const filteredDataRef = React.useRef([]);
  
  // üìç SCROLL STATE: Refs pro aktu√°ln√≠ hodnoty (pro scroll listener)
  const currentPageIndexRef = React.useRef(currentPageIndex);
  const pageSizeRef = React.useRef(pageSize);
  const expandedRef = React.useRef(expanded);
  
  // Aktualizuj refs p≈ôi ka≈æd√© zmƒõnƒõ
  React.useEffect(() => {
    currentPageIndexRef.current = currentPageIndex;
    pageSizeRef.current = pageSize;
    expandedRef.current = expanded;
  }, [currentPageIndex, pageSize, expanded]);
  
  // üé¨ INITIALIZATION: Ref pro sledov√°n√≠ krok≈Ø inicializace
  const initStepsCompleted = React.useRef({
    dataLoaded: false,
    paginationRestored: false,
    expandedRestored: false,
    scrollRestored: false
  });

  // üìç SCROLL STATE: Obnovit pozici p≈ôi prvn√≠m naƒçten√≠ dat
  useEffect(() => {
    // Pokud u≈æ byla pozice obnovena, skip
    if (scrollStateRestored.current) {
      return;
    }
    
    // Pokud nejsou pot≈ôebn√° data, skip
    if (!user_id) {
      return;
    }
    
    // Pokud je≈°tƒõ nejsou naƒçten√° data (loading), poƒçkej
    if (loading) {
      return;
    }
    
    // Pokud jsou data pr√°zdn√°, oznaƒç v≈°echny kroky jako hotov√©
    if (orders.length === 0) {
      initStepsCompleted.current.paginationRestored = true;
      initStepsCompleted.current.expandedRestored = true;
      initStepsCompleted.current.scrollRestored = true;
      scrollStateRestored.current = true;
      return;
    }
    
    const savedState = ordersCacheService.getScrollState(user_id, {
      ...(selectedYear !== 'all' && { rok: selectedYear }),
      mesic: selectedMonth
    }, orders.length);
    
    if (savedState && savedState.page && savedState.rowsPerPage) {
      // Obnov str√°nku (convert from 1-based to 0-based)
      const targetPage = savedState.page - 1;
      const maxPage = Math.ceil(orders.length / savedState.rowsPerPage) - 1;
      
      if (targetPage >= 0 && targetPage <= maxPage) {
        setCurrentPageIndex(targetPage);
      }
      
      // Obnov page size pokud se zmƒõnil
      if (savedState.rowsPerPage !== pageSize) {
        setPageSize(savedState.rowsPerPage);
        localStorage.setItem('orders25List_pageSize', savedState.rowsPerPage);
      }
      
      initStepsCompleted.current.paginationRestored = true;
      
      // üìç OBNOV ROZBALEN√â OBJEDN√ÅVKY - ulo≈æ ID do ref (obnov pozdƒõji)
      if (savedState.expandedOrderIds && savedState.expandedOrderIds.length > 0) {
        pendingExpandedOrderIds.current = savedState.expandedOrderIds;
      } else {
        // ≈Ω√°dn√© rozbalen√© objedn√°vky
        initStepsCompleted.current.expandedRestored = true;
      }
      
      // Scroll restoration disabled
      initStepsCompleted.current.scrollRestored = true;
    } else {
      // ≈Ω√°dn√Ω ulo≈æen√Ω stav
      initStepsCompleted.current.paginationRestored = true;
      initStepsCompleted.current.expandedRestored = true;
      initStepsCompleted.current.scrollRestored = true;
    }
    
    scrollStateRestored.current = true;
  }, [orders.length, loading, user_id, selectedYear, selectedMonth, pageSize]);

  // üìç SCROLL STATE: Helper funkce pro manu√°ln√≠ ulo≈æen√≠ pozice
  const saveCurrentScrollState = useCallback(() => {
    if (!user_id || !scrollStateRestored.current || orders.length === 0) {
      return;
    }
    
    // Scroll saving disabled - keeping only expanded rows memory
    const currentPage = currentPageIndexRef.current;
    const currentPageSize = pageSizeRef.current;
    const currentExpanded = expandedRef.current;
    
    const expandedOrderIds = Object.keys(currentExpanded)
      .filter(index => currentExpanded[index])
      .map(index => {
        const order = filteredDataRef.current[parseInt(index)];
        return order?.id;
      })
      .filter(Boolean);
    
    ordersCacheService.saveScrollState(user_id, {
      ...(selectedYear !== 'all' && { rok: selectedYear }),
      mesic: selectedMonth
    }, {
      page: currentPage + 1,
      rowsPerPage: currentPageSize,
      scrollY: 0, // Scroll disabled
      totalRows: orders.length,
      expandedOrderIds
    });
  }, [user_id, selectedYear, selectedMonth, orders.length]);

  // üìç AUTO-SAVE: Automaticky ukl√°dej p≈ôi zmƒõnƒõ str√°nky, pageSize nebo expanded rows
  useEffect(() => {
    // Skip pokud je≈°tƒõ nebyla obnovena pozice (neukl√°dej p≈ôi prvn√≠m naƒçten√≠)
    if (!scrollStateRestored.current) {
      return;
    }
    
    // Ulo≈æ aktu√°ln√≠ stav
    saveCurrentScrollState();
  }, [currentPageIndex, pageSize, expanded, saveCurrentScrollState]);

  // üìç SCROLL STATE: Invaliduj POUZE p≈ôi SKUTEƒåN√â zmƒõnƒõ filtr≈Ø
  useEffect(() => {
    // Skip prvn√≠ render (p≈ôi mount se filtry inicializuj√≠)
    if (isFirstRender.current) {
      isFirstRender.current = false;
      
      // Ulo≈æ aktu√°ln√≠ hodnoty filtr≈Ø jako baseline
      prevFiltersRef.current = {
        year: selectedYear,
        month: selectedMonth,
        status: statusFilter,
        user: userFilter,
        global: globalFilter,
        objednatel: selectedObjednatel,
        garant: selectedGarant,
        schvalovatel: selectedSchvalovatel,
        dateFrom: dateFromFilter,
        dateTo: dateToFilter,
        amountFrom: amountFromFilter,
        amountTo: amountToFilter,
        activeStatus: activeStatusFilter
      };
      
      return;
    }
    
    if (!user_id || !prevFiltersRef.current) return;
    
    // Porovnej P≈òEDCHOZ√ç hodnoty s aktu√°ln√≠mi
    const currentFilters = {
      year: selectedYear,
      month: selectedMonth,
      status: statusFilter,
      user: userFilter,
      global: globalFilter,
      objednatel: selectedObjednatel,
      garant: selectedGarant,
      schvalovatel: selectedSchvalovatel,
      dateFrom: dateFromFilter,
      dateTo: dateToFilter,
      amountFrom: amountFromFilter,
      amountTo: amountToFilter,
      activeStatus: activeStatusFilter
    };
    
    // Detekuj skuteƒçnou zmƒõnu
    const hasChanged = JSON.stringify(prevFiltersRef.current) !== JSON.stringify(currentFilters);
    
    if (!hasChanged) {
      return; // Filtry se nezmƒõnily = jen remount komponenty
    }
    
    // Ulo≈æ nov√© hodnoty
    prevFiltersRef.current = currentFilters;
    
    // P≈ôi SKUTEƒåN√â zmƒõnƒõ filtru resetuj scroll state
    ordersCacheService.clearScrollState(user_id, {
      ...(selectedYear !== 'all' && { rok: selectedYear }),
      mesic: selectedMonth
    });
    
    // Reset tracking
    scrollStateRestored.current = false;
    
    // Reset rozbalen√Ωch objedn√°vek
    setExpanded({});
    
    // Reset na prvn√≠ str√°nku
    setCurrentPageIndex(0);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [selectedYear, selectedMonth, statusFilter, userFilter, globalFilter, 
      selectedObjednatel, selectedGarant, selectedSchvalovatel,
      dateFromFilter, dateToFilter, amountFromFilter, amountToFilter, activeStatusFilter]);

  // Debug v√Ωpis pro testov√°n√≠ highlighting
  React.useEffect(() => {
    if (orders.length > 0) {

      // Success log odstranƒõn
      
      // Debug v√Ωpis odstranƒõn pro produkci
      
    }
  }, [showRowHighlighting, showRowStriping, orders]);

  // Custom Select helper functions
  const toggleSelect = useCallback((field) => {
    setSelectStates(prev => {
      // Zav≈ôi v≈°echny ostatn√≠ selecty
      const newState = Object.keys(prev).reduce((acc, key) => {
        acc[key] = false;
        return acc;
      }, {});
      // Toggleni jen po≈æadovan√Ω select
      newState[field] = !prev[field];
      return newState;
    });
  }, []);

  const filterOptions = useCallback((options, searchTerm, field) => {
    if (!searchTerm) return options;
    
    const lowerSearchTerm = searchTerm.toLowerCase();
    return options.filter(option => {
      const label = getOptionLabel(option, field);
      return label.toLowerCase().includes(lowerSearchTerm);
    });
  }, []);

  const getOptionLabel = useCallback((option, field) => {
    if (!option) return '';
    
    switch (field) {
      case 'statusFilter':
        return option.nazev_stavu || option.nazev || option.popis || option.kod_stavu || option.kod || String(option);
      case 'selectedObjednatel':
      case 'selectedGarant':
        return option.displayName || `${option.jmeno || ''} ${option.prijmeni || ''}`.trim() || 'Bez jm√©na';
      case 'selectedSchvalovatel':
        return option.displayName || option.jmeno_prijmeni || `${option.jmeno || ''} ${option.prijmeni || ''}`.trim() || 'Bez jm√©na';
      case 'pageSize':
        return option.label || String(option.value || option);
      // OrderForm25 field typy
      case 'zpusob_financovani':
        return option.nazev || option.label || (typeof option === 'string' ? option : 'Nezn√°m√Ω');
      case 'lp_kod':
        return `${option.kod || option.id || option} - ${option.nazev || option.label || 'Bez n√°zvu'}`;
      case 'druh_objednavky_kod':
        return option.nazev || option.label || (typeof option === 'string' ? option : 'Nezn√°m√Ω');
      default:
        return String(option);
    }
  }, []);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (!event.target.closest('[data-custom-select]')) {
        setSelectStates({});
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  // P≈ôiprav dropdown seznamy pro filtry
  const prepareDropdownLists = useCallback((ordersData) => {
    // Preparing dropdown lists
    
    // Objednatel√©
    const uniqueObjednatele = new Set();
    const uniqueGaranti = new Set();
    const uniqueSchvalovatel√© = new Set();
    
    ordersData.forEach(order => {
      // Objednatel: objednatel_id -> uzivatel_id
      const objednatelId = order.objednatel_id || order.uzivatel_id;
      if (objednatelId && users[objednatelId]) {
        uniqueObjednatele.add(objednatelId);
      }
      
      // Garant
      if (order.garant_uzivatel_id && users[order.garant_uzivatel_id]) {
        uniqueGaranti.add(order.garant_uzivatel_id);
      }
      
      // Schvalovatel
      if (order.schvalovatel_id && users[order.schvalovatel_id]) {
        uniqueSchvalovatel√©.add(order.schvalovatel_id);
      }
    });
    
    // P≈ôeveƒè na se≈ôazen√© seznamy
    const sortByName = (a, b) => {
      const nameA = (typeof users[a] === 'object' ? users[a].displayName : users[a]) || '';
      const nameB = (typeof users[b] === 'object' ? users[b].displayName : users[b]) || '';
      return nameA.localeCompare(nameB);
    };
    
    const objednatelArray = Array.from(uniqueObjednatele).sort(sortByName);
    const garantArray = Array.from(uniqueGaranti).sort(sortByName);
    const schvalovatelArray = Array.from(uniqueSchvalovatel√©).sort(sortByName);
    
    // Dropdown lists prepared
    
    setObjednatelList(objednatelArray);
    setGarantList(garantArray);
    setSchvalovatelList(schvalovatelArray);
  }, [users]);

  // Aktualizuj dropdown seznamy kdy≈æ se zmƒõn√≠ users nebo orders
  useEffect(() => {
    if (orders.length > 0 && Object.keys(users).length > 0) {
      prepareDropdownLists(orders);
    }
  }, [orders, users, prepareDropdownLists]);

  // Load data
  const loadData = useCallback(async (forceRefresh = false) => {
    if (!token || !user?.username) return;
    
    // üöÄ CACHE: Start mƒõ≈ôen√≠ doby naƒç√≠t√°n√≠
    const loadStartTime = performance.now();
    
    try {
      setLoading(true);
      setError(null);
      setProgress?.(5);

      // Load orders podle opr√°vnƒõn√≠ - pou≈æij orders25/by-user pro filtrov√°n√≠ na BE
      setProgress?.(20);
      
      let ordersData;
      
      // Z√≠skej mƒõs√≠ƒçn√≠ filtr
      const mesicFilter = getMonthFilterForAPI();
      
      // ÔøΩ OPTIMALIZACE: Pou≈æij ref pro aktu√°ln√≠ permissions m√≠sto p≈ô√≠m√© dependency
      // Toto odstran√≠ circular dependency: loadData mƒõn√≠ -> useEffect vol√° loadData -> permissions se mƒõn√≠ -> loadData se mƒõn√≠...
      const currentPermissions = permissionsRef.current;
      const canViewAllOrders = currentPermissions.canViewAll;
      const hasOnlyOwnPermissions = currentPermissions.hasOnlyOwn;
      
      // ÔøΩ P≈ôevod roku a mƒõs√≠ce na datum_od/datum_do pro Order V2 API
      const getDateRange = () => {
        // Pokud je vybr√°n konkr√©tn√≠ rok
        if (selectedYear !== 'all') {
          const year = parseInt(selectedYear);
          
          // Pokud je vybr√°n mƒõs√≠c
          if (mesicFilter) {
            // Parsuj mƒõs√≠c (m≈Ø≈æe b√Ωt "1", "1-3", "10-12")
            const monthMatch = mesicFilter.match(/^(\d+)(?:-(\d+))?$/);
            if (monthMatch) {
              const startMonth = parseInt(monthMatch[1]);
              const endMonth = monthMatch[2] ? parseInt(monthMatch[2]) : startMonth;
              
              // Datum od: prvn√≠ den prvn√≠ho mƒõs√≠ce
              const datum_od = `${year}-${String(startMonth).padStart(2, '0')}-01`;
              
              // Datum do: posledn√≠ den posledn√≠ho mƒõs√≠ce
              const lastDay = new Date(year, endMonth, 0).getDate();
              const datum_do = `${year}-${String(endMonth).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
              
              return { datum_od, datum_do };
            }
          } else {
            // Cel√Ω rok
            const datum_od = `${year}-01-01`;
            const datum_do = `${year}-12-31`;
            
            return { datum_od, datum_do };
          }
        }
        
        // Pokud je "V≈°echny roky" - neomezujeme datum
        return {};
      };
      
      const dateRange = getDateRange();
      
      // ÔøΩüöÄ MIGRACE: Fetch funkce pro V2 API
      const fetchFunction = async () => {
        // üî• DEBUG: Zobraz permissions p≈ôed vol√°n√≠m API
        console.group('üîç [LOAD DATA] API Request Debug');
        console.log('üë§ Current User ID:', currentUserId);
        console.log('üîê Permissions:', {
          canViewAll: canViewAllOrders,
          hasOnlyOwn: hasOnlyOwnPermissions,
          permissions: permissionsRef.current
        });
        console.log('üìÖ Date Range:', dateRange);
        console.log('üì¶ Show Archived:', showArchived);
        
        // ÔøΩ DEBUG: Doƒçasnƒõ bez filtr≈Ø pro otestov√°n√≠ admin pr√°v
        const filters = {
          // üöÄ BACKEND FILTRUJE AUTOMATICKY podle rol√≠ u≈æivatele!
          // Backend aplikuje 12-role WHERE klauzuli pro omezen√© u≈æivatele
          ...dateRange,
          ...(showArchived && { archivovano: 1 })
        };
        
        console.log('üì§ Filters sent to API:', filters);
        console.log('üåê Token:', token ? 'Present' : 'MISSING');
        console.log('üë§ Username:', username || 'MISSING');
        console.log('üéØ API Endpoint: POST /order-v2/list-enriched');
        console.groupEnd();
        
        // üß™ DEBUG: Ulo≈æ API request data pro test panel
        setApiTestData(prev => ({
          ...prev,
          requestFilters: filters,
          requestTimestamp: new Date().toISOString()
        }));
        
        // üöÄ V2 API: V≈ΩDY pou≈æ√≠vej enriched endpoint pro kompletn√≠ data
        const apiResult = await listOrdersV2(filters, token, username, false, true);
        
        // üî• DEBUG: Zobraz co backend vr√°til
        console.group('üì• [LOAD DATA] API Response Debug');
        console.log('üéØ API Endpoint: POST /order-v2/list-enriched');
        console.log('üì¶ RAW Response:', apiResult);
        console.log('‚úÖ Orders returned:', apiResult?.length || 0);
        console.log('üîê Should see ALL orders (admin):', canViewAllOrders);
        console.log('üìä First 3 orders:', apiResult?.slice(0, 3).map(o => ({
          id: o.id,
          cislo: o.cislo_objednavky,
          uzivatel_id: o.uzivatel_id,
          objednatel_id: o.objednatel_id,
          garant_id: o.garant_uzivatel_id
        })));
        console.groupEnd();
        
        // üß™ DEBUG: Ulo≈æ API response data
        setApiTestData(prev => ({
          ...prev,
          apiResponse: apiResult,
          apiResponseCount: apiResult?.length || 0,
          archivedInResponse: apiResult?.filter(o => o.stav_objednavky === 'ARCHIVOVANO').length || 0,
          responseTimestamp: new Date().toISOString()
        }));
        
        return apiResult;
      };
      
      // üöÄ CACHE: Pou≈æij getOrders pro inteligentn√≠ cache (memory + localStorage + TTL)
      // forceRefresh se pou≈æ√≠v√° JEN p≈ôi manu√°ln√≠m kliknut√≠ na tlaƒç√≠tko "Obnovit"
      
      const cacheResult = forceRefresh 
        ? await ordersCacheService.forceRefresh(
            user_id,
            fetchFunction,
            {
              ...dateRange,
              viewAll: canViewAllOrders,
              showArchived: showArchived
            }
          )
        : await ordersCacheService.getOrders(
            user_id,
            fetchFunction,
            {
              ...dateRange,
              viewAll: canViewAllOrders,
              showArchived: showArchived
            }
          );
      
      // üöÄ CACHE: Rozbal data a info o zdroji
      ordersData = cacheResult.data;
      
      // üöÄ Zmƒõ≈ô dobu naƒç√≠t√°n√≠
      const loadEndTime = performance.now();
      const loadDuration = Math.round(loadEndTime - loadStartTime);
      
      // üöÄ Nastav zdroj podle skuteƒçn√©ho zdroje z cache
      setLastLoadSource(cacheResult.source); // 'memory', 'database', nebo 'database_forced'
      setLastLoadTime(new Date());
      setLastLoadDuration(loadDuration);
      
      setProgress?.(60);
      
      // Load users for names
      try {
        const usersData = await fetchAllUsers({ token, username });
        const usersMap = {};
        usersData.forEach((u, index) => {
          // Ulo≈æ√≠me kompletn√≠ informace o u≈æivateli vƒçetnƒõ titul≈Ø
          const userId = u.id || u.user_id || u.uzivatel_id;

          // Spr√°vn√© po≈ôad√≠: Titul p≈ôed + Jm√©no + P≈ô√≠jmen√≠ + Titul za
          const titul_pred_str = u.titul_pred ? u.titul_pred + ' ' : '';
          const jmeno_str = u.jmeno || '';
          const prijmeni_str = u.prijmeni || '';
          const titul_za_str = u.titul_za ? ', ' + u.titul_za : '';
          const displayName = `${titul_pred_str}${jmeno_str} ${prijmeni_str}${titul_za_str}`.replace(/\s+/g, ' ').trim() || u.username || u.uzivatelske_jmeno || `User ${userId}`;
          
          if (userId) {
            usersMap[userId] = {
              id: userId,
              jmeno: u.jmeno || '',
              prijmeni: u.prijmeni || '', 
              titul_pred: u.titul_pred || '',
              titul_za: u.titul_za || '',
              username: u.username || u.uzivatelske_jmeno || '',
              displayName: displayName
            };

          }
        });
        
        setUsers(usersMap);
        
        // NYN√ç m≈Ø≈æeme zpracovat koncepty s dostupn√Ωmi users daty
        const localDrafts = [];
        try {
          // üîß FIX: Pou≈æij order25DraftStorageService m√≠sto p≈ô√≠m√©ho localStorage
          // D≈ô√≠ve: const draftDataRaw = localStorage.getItem(key); const draftData = JSON.parse(draftDataRaw || '{}');
          const draftData = await order25DraftStorageService.loadDraft(user_id);
          
          // Draft loading debug removed for performance
          
          if (draftData) {
            const isConceptValid = isValidConcept(draftData);
            const hasDbChanges = hasDraftChanges(draftData);
            
            if (isConceptValid && !hasDbChanges) {
              const formData = draftData.formData || draftData;
              const draftKey = getDraftKey(user_id); // Z√≠skej kl√≠ƒç pro ID
              
              // Extrahuj ID z hodnot (CustomSelect m≈Ø≈æe ulo≈æit objekt m√≠sto ID)
              let garantUserId = formData.garant_uzivatel_id;
              if (typeof garantUserId === 'object' && garantUserId !== null) {
                garantUserId = garantUserId.id || garantUserId.user_id || garantUserId.uzivatel_id;
              }
              
              let objednatelId = formData.objednatel_id || user_id;
              if (typeof objednatelId === 'object' && objednatelId !== null) {
                objednatelId = objednatelId.id || objednatelId.user_id || objednatelId.uzivatel_id;
              }

              const conceptOrder = {
                id: `draft_${draftKey}`,
                cislo_objednavky: formData.ev_cislo || '‚òÖ KONCEPT ‚òÖ',
                predmet: formData.predmet || 'Nov√° objedn√°vka (koncept)',
                popis_pozadavku: formData.popis_pozadavku || '',
                stav_objednavky: 'Koncept',
                stav_workflow_kod: '["NOVA"]',
                max_cena_s_dph: formData.max_cena_s_dph || 0,
                poznamky: formData.poznamky || '',
                dodavatel_nazev: formData.dodavatel_nazev || '',
                dodavatel_kontakt_jmeno: formData.dodavatel_kontakt_jmeno || '',
                dodavatel_kontakt_telefon: formData.dodavatel_kontakt_telefon || '',
                dodavatel_kontakt_email: formData.dodavatel_kontakt_email || '',
                garant_uzivatel_id: garantUserId || '',
                objednatel_id: objednatelId || '',
                prikazce_id: formData.prikazce_id || '',
                uzivatel_id: objednatelId || user_id,
                strediska_kod: formData.strediska_kod || [],
                dt_vytvoreni: draftData.timestamp || new Date().toISOString(),
                temp_datum_objednavky: draftData.firstAutoSaveDate ? draftData.firstAutoSaveDate.split('T')[0] : (formData.temp_datum_objednavky || new Date().toISOString().split('T')[0]),
                vytvoril_uzivatel: username,
                isDraft: true,
                je_koncept: true,
                _originalKey: draftKey,
                _originalData: draftData,
                _formData: formData
              };
              
              localDrafts.push(conceptOrder);
            }
          }
        } catch (err) {
          // üîß FIX: Lep≈°√≠ error handling pro draft loading
          // console.warn('‚ö†Ô∏è [Orders25List] Chyba p≈ôi naƒç√≠t√°n√≠ konceptu:', err);
        }
        
        // P≈ôidej koncepty na zaƒç√°tek seznamu
        if (localDrafts.length > 0) {
          ordersData = [...localDrafts, ...(ordersData || [])];
        }
        
        // Ulo≈æ√≠me tak√© v≈°echny u≈æivatele pro filtry (ne jen ty z objedn√°vek)
        const allUsersForFilters = usersData.map(u => {
          // Zkus naj√≠t ID z r≈Øzn√Ωch mo≈æn√Ωch pol√≠
          const userId = u.id || u.user_id || u.uzivatel_id;
          
          const titul_pred_str = u.titul_pred ? u.titul_pred + ' ' : '';
          const jmeno_str = u.jmeno || '';
          const prijmeni_str = u.prijmeni || '';
          const titul_za_str = u.titul_za ? ', ' + u.titul_za : '';
          const displayName = `${titul_pred_str}${jmeno_str} ${prijmeni_str}${titul_za_str}`.replace(/\s+/g, ' ').trim() || u.username || u.uzivatelske_jmeno || `User ${userId}`;
          
          return {
            id: userId,
            jmeno: u.jmeno || '',
            prijmeni: u.prijmeni || '', 
            titul_pred: u.titul_pred || '',
            titul_za: u.titul_za || '',
            username: u.username || u.uzivatelske_jmeno || '',
            email: u.email || '',
            displayName: displayName
          };
        });
        setAllUsers(allUsersForFilters);
        
        setProgress?.(70);
      } catch (err) {
        // Error loading users
      }
      
      // Load schvalovatel√© z DB
      try {
        const approversData = await fetchApprovers({ token, username: user.username });
        
        // P≈ôidej displayName pro schvalovatelje pokud chyb√≠
        const approversWithDisplayName = (approversData || []).map(approver => {
          if (approver.displayName) return approver; // u≈æ m√° displayName
          
          const titul_pred_str = approver.titul_pred ? approver.titul_pred + ' ' : '';
          const jmeno_str = approver.jmeno || '';
          const prijmeni_str = approver.prijmeni || '';
          const titul_za_str = approver.titul_za ? ', ' + approver.titul_za : '';
          const displayName = `${titul_pred_str}${jmeno_str} ${prijmeni_str}${titul_za_str}`.replace(/\s+/g, ' ').trim() || 
                             approver.jmeno_prijmeni || 
                             approver.username || 
                             approver.uzivatelske_jmeno || 
                             `User ${approver.user_id || approver.uzivatel_id}`;
          
          return { ...approver, displayName };
        });
        
        setApproversList(approversWithDisplayName);
        setProgress?.(75);
      } catch (err) {
        // Error loading approvers
      }
      
      // Load ƒç√≠seln√≠ky pro stavy objedn√°vek
      try {
        const statesData = await fetchCiselniky({ token, username: user.username, typ: 'OBJEDNAVKA' });
        // Se≈ôaƒè stavy abecednƒõ podle n√°zvu
        const sortedStates = (statesData || []).sort((a, b) => {
          const nameA = (a.nazev_stavu || a.nazev || '').toLowerCase();
          const nameB = (b.nazev_stavu || b.nazev || '').toLowerCase();
          return nameA.localeCompare(nameB, 'cs');
        });
        setOrderStatesList(sortedStates);
        setProgress?.(80);
      } catch (err) {
        // Error loading state codes
      }
      
      // Load LP k√≥dy pro p≈ôevod ID na n√°zvy
      try {
        const lpData = await fetchLimitovanePrisliby({ token, username: user.username });
        setLpKodyList(lpData || []);
      } catch (err) {
        // Error loading LP codes
      }
      
      // Koncepty ji≈æ byly zpracov√°ny v√Ω≈°e po naƒçten√≠ users
      let finalOrders = ordersData || [];
      
      // Oznaƒçit existuj√≠c√≠ DB ≈ô√°dky, kter√© maj√≠ rozpracovan√© zmƒõny v order25DraftStorageService
      const hasUserDraft = order25DraftStorageService.hasDraft(user_id);

      if (hasUserDraft) {
        try {
          const draftData = await order25DraftStorageService.loadDraft(user_id);
          
          // Pou≈æij spr√°vnou funkci pro kontrolu validn√≠ch draft zmƒõn
          const hasValidDraftChanges = hasDraftChanges(draftData);
          // Oznaƒçuj ≈ô√°dek POUZE pokud skuteƒçnƒõ m√° validn√≠ zmƒõny
          if (hasValidDraftChanges) {
            // Pokud m√° draft DB ID, pokus se oznaƒçit odpov√≠daj√≠c√≠ ≈ô√°dek
            const orderIdToMark = draftData.formData?.id || draftData.savedOrderId;
            if (orderIdToMark) {
              let foundAndMarked = false;
              finalOrders = finalOrders.map(order => {
                // Porovn√°vej jak ƒç√≠sla tak stringy (DB m≈Ø≈æe vracet r≈Øzn√© typy)
                const orderIdStr = String(order.id);
                const markIdStr = String(orderIdToMark);
                
                if (orderIdStr === markIdStr && !order.isDraft) {
                  foundAndMarked = true;
                  return { ...order, hasLocalDraftChanges: true };
                }
                return order;
              });
            }
          }
        } catch (err) {
          // Chyba p≈ôi kontrole DB ≈ô√°dk≈Ø pro oznaƒçen√≠
        }
      }
      
      setOrders(finalOrders);
      
      // Populate rawData for debug panel
      setRawData({
        timestamp: new Date().toISOString(),
        ordersCount: finalOrders.length,
        allFields: finalOrders.length > 0 ? Object.keys(finalOrders[0]) : [],
        firstOrder: finalOrders[0] || null,
        rawData: finalOrders
      });
      
      // Generate calendar_order_counts immediately after loading from DB
      // This must run BEFORE any filtering, on raw DB data
      try {
        const counts = {};
        
        finalOrders.forEach(order => {
          // Skip draft/concept orders
          if (order.isDraft || order.isLocalConcept) return;
          
          // Get order date - try multiple field names
          let dateStr = order.dt_objednavky || order.datum_objednavky || order.created_at || order.dt_vytvoreni;
          
          if (!dateStr) return;
          
          // Parse date - support both ISO format (YYYY-MM-DD HH:MM:SS) and Czech format (DD.MM.YYYY)
          let year, month, day;
          
          // Try ISO format first (from DB): YYYY-MM-DD HH:MM:SS or YYYY-MM-DD
          const isoMatch = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (isoMatch) {
            year = isoMatch[1];
            month = isoMatch[2];
            day = isoMatch[3];
          } else {
            // Try Czech format: DD.MM.YYYY
            const czMatch = dateStr.match(/(\d{2})\.(\d{2})\.(\d{4})/);
            if (czMatch) {
              day = czMatch[1];
              month = czMatch[2];
              year = czMatch[3];
            } else {
              return; // Neither format matched
            }
          }
          
          // Create key in format YYYY-MM-DD
          const key = `${year}-${month}-${day}`;
          
          // Initialize day data if not exists
          if (!counts[key]) {
            counts[key] = { total: 0, pending: 0 };
          }
          
          counts[key].total += 1;
          
          // üö® OPRAVA: Check for NESCHV√ÅLEN√â objedn√°vky (stav_schvaleni === 'neschvaleno')
          // nebo objedn√°vky "Ke schv√°len√≠" (stav_objednavky)
          const stavSchvaleni = order.stav_schvaleni || '';
          const stavObjednavky = order.stav_objednavky || '';
          
          if (stavSchvaleni === 'neschvaleno' || 
              stavObjednavky.toLowerCase().includes('ke schv√°len√≠') || 
              stavObjednavky.toLowerCase().includes('ke schvaleni')) {
            counts[key].pending += 1;
          }
        });
        
        // üîß OPRAVA: Ukl√°dat p≈ô√≠mo do localStorage bez user_id suffixu
        // CalendarPanel ƒçte z 'calendar_order_counts', ne z getUserKey()
        localStorage.setItem('calendar_order_counts', JSON.stringify(counts));
        localStorage.setItem('calendar_order_counts_updated', Date.now());
        window.dispatchEvent(new CustomEvent('calendar_order_counts_updated'));
      } catch (err) {
        // Ti≈°e ignorovat chyby p≈ôi generov√°n√≠ kalend√°≈ôe
      }
      
      setProgress?.(100);

      // Ode≈°li broadcast ud√°lost pro aktualizaci menubar po naƒçten√≠ dat - ORDER25 SERVICE
      const hasDraft = order25DraftStorageService.hasDraft(user_id);
      if (hasDraft) {
        try {
          const draftData = await order25DraftStorageService.loadDraft(user_id);
          broadcastDraftUpdated(user_id, draftData);
        } catch (e) {
          // Ignoruj chyby p≈ôi parsov√°n√≠ draftu
          broadcastDraftDeleted(user_id);
        }
      } else {
        broadcastDraftDeleted(user_id);
      }
      
      // üé¨ INITIALIZATION: Oznaƒç dokonƒçen√≠ naƒç√≠t√°n√≠ dat
      initStepsCompleted.current.dataLoaded = true;

    } catch (err) {
      // P≈ôekl√°d√°me anglick√© error messages do ƒçe≈°tiny
      const errorMessage = translateErrorMessage(err.message || 'Chyba p≈ôi naƒç√≠t√°n√≠ objedn√°vek');
      setError(errorMessage);
      
      // üé¨ INITIALIZATION: V p≈ô√≠padƒõ chyby oznaƒç v≈°echny kroky jako hotov√©
      initStepsCompleted.current.dataLoaded = true;
      initStepsCompleted.current.paginationRestored = true;
      initStepsCompleted.current.expandedRestored = true;
      initStepsCompleted.current.scrollRestored = true;
    } finally {
      setLoading(false);
      setInitializing(false);
      setTimeout(() => setProgress?.(0), 500);
    }
  }, [token, user?.username, user_id, selectedYear, selectedMonth, showArchived]); 
  // ÔøΩ OPTIMALIZACE: Odstranƒõno 'permissions' z dependencies - pou≈æit permissionsRef.current m√≠sto toho
  // Toto odstran√≠ circular dependency a zabr√°n√≠ zbyteƒçn√Ωm reload p≈ôi zmƒõnƒõ permissions objektu
  // permissions zmƒõny jsou zachyceny p≈ôes ref kter√Ω je v≈ædy aktu√°ln√≠

  // Load data on mount
  useEffect(() => {
    loadData();
  }, [loadData]);

  // Registrace callback pro background refresh objedn√°vek
  // ‚úÖ Background refresh FUNGUJE pro v≈°echny u≈æivatele
  // Backend API nyn√≠ filtruje podle permissions (uzivatel_id pro ORDER_READ_OWN)
  useEffect(() => {
    if (!bgTasksContext) return;
    
    const refreshCallback = (ordersData) => {
      // üîß DEBUG: Z√°kladn√≠ info o background refreshi
      console.group('üîÑ [Background Refresh] Spu≈°tƒõn');
      console.log('üìÖ Timestamp:', new Date().toISOString());
      console.log('üë§ User ID:', user_id);
      console.log('üë§ Current User ID (number):', currentUserId);
      console.log('üîê Permissions:', permissions);
      console.log('üìä Aktu√°ln√≠ poƒçet objedn√°vek:', orders.length);
      
      // üîß OPTIMALIZACE: Validace dat p≈ôed nastaven√≠m
      // Ochrana proti p≈ôeps√°n√≠ existuj√≠c√≠ch dat nevalidn√≠mi daty
      
      // Kontrola 1: Data mus√≠ b√Ωt pole
      if (!ordersData || !Array.isArray(ordersData)) {
        console.error('‚ùå [Validace 1] Nevalidn√≠ data (nen√≠ pole)');
        console.log('   Typ dat:', typeof ordersData);
        console.log('   Data:', ordersData);
        console.groupEnd();
        return; // ‚Üê OCHRANA: Nemƒõnit orders pokud data nejsou validn√≠
      }
      console.log('‚úÖ [Validace 1] Data jsou pole');
      
      // Kontrola 2: Pokud m√°me aktu√°lnƒõ data a p≈ôi≈°lo pr√°zdn√© pole, varov√°n√≠
      if (orders.length > 0 && ordersData.length === 0) {
        console.warn('‚ö†Ô∏è [Validace 2] Pr√°zdn√© pole p≈ôi existuj√≠c√≠ch datech!');
        console.warn('   Aktu√°ln√≠ poƒçet:', orders.length);
        console.warn('   Nov√Ω poƒçet:', 0);
        console.warn('   Mo≈æn√© p≈ô√≠ƒçiny:');
        console.warn('   - Token expiroval ‚Üí API vr√°tilo pr√°zdn√© pole');
        console.warn('   - Backend chyba ‚Üí vr√°tilo [] m√≠sto error');
        console.warn('   - Permissions zmƒõnily ‚Üí u≈æivatel nem√° p≈ô√≠stup');
        console.groupEnd();
        // ‚Üê OCHRANA: Zachovat aktu√°ln√≠ data m√≠sto p≈ôeps√°n√≠ pr√°zdn√Ωm polem
        return;
      }
      console.log('‚úÖ [Validace 2] Poƒçet dat je OK');
      
      // Kontrola 3: Minim√°ln√≠ validace struktury dat (prvn√≠ objedn√°vka m√° ID)
      if (ordersData.length > 0 && !ordersData[0]?.id) {
        console.error('‚ùå [Validace 3] Data nemaj√≠ validn√≠ strukturu (chyb√≠ ID)');
        console.log('   Prvn√≠ objedn√°vka:', ordersData[0]);
        console.log('   Dostupn√© kl√≠ƒçe:', Object.keys(ordersData[0] || {}));
        console.groupEnd();
        return;
      }
      console.log('‚úÖ [Validace 3] Struktura dat je validn√≠');
      
      // üîß DEBUG: Info o p≈ôijat√Ωch datech
      console.log('üì¶ P≈ôijato objedn√°vek z API:', ordersData.length);
      if (ordersData.length > 0) {
        console.log('   Prvn√≠ objedn√°vka ID:', ordersData[0].id);
        console.log('   Prvn√≠ objedn√°vka ƒç√≠slo:', ordersData[0].cislo_objednavky);
        console.log('   Prvn√≠ objedn√°vka stav:', ordersData[0].stav_objednavky);
        console.log('   Prvn√≠ objedn√°vka objednatel_id:', ordersData[0].objednatel_id);
        console.log('   Prvn√≠ objedn√°vka uzivatel_id:', ordersData[0].uzivatel_id);
      }
      
      // ‚úÖ Data pro≈°la validac√≠, m≈Ø≈æeme aktualizovat
      let filteredOrders = ordersData;
      
      // ‚úÖ ARCHIV: Aplikuj showArchived filtr (frontend filtr)
      const beforeArchiveFilter = filteredOrders.length;
      if (!showArchived) {
        // Odfiltruj archivovan√© objedn√°vky
        filteredOrders = filteredOrders.filter(order => 
          order.stav_objednavky !== 'ARCHIVOVANO'
        );
        console.log(`üóÇÔ∏è [Archive Filter] ${beforeArchiveFilter} ‚Üí ${filteredOrders.length} (odfiltrov√°no ${beforeArchiveFilter - filteredOrders.length} archivovan√Ωch)`);
      } else {
        console.log('üóÇÔ∏è [Archive Filter] Vypnuto - zobrazuj√≠ se i archivovan√©');
      }
      
      // üîß DEBUG: Fin√°ln√≠ info
      console.log('‚úÖ [√öSPƒöCH] Background refresh dokonƒçen');
      console.log('üìä Fin√°ln√≠ poƒçet objedn√°vek:', filteredOrders.length);
      console.log('üîÑ Zmƒõna:', orders.length, '‚Üí', filteredOrders.length);
      
      // üîß DEBUG: Uk√°zka prvn√≠ch 3 objedn√°vek (pro kontrolu permissions)
      if (filteredOrders.length > 0) {
        console.log('üìã Uk√°zka prvn√≠ch 3 objedn√°vek:');
        filteredOrders.slice(0, 3).forEach((order, idx) => {
          console.log(`   ${idx + 1}. ID=${order.id}, ƒå√≠slo=${order.cislo_objednavky}, Objednatel_ID=${order.objednatel_id}, Uzivatel_ID=${order.uzivatel_id}`);
        });
      }
      
      console.groupEnd();
      
      setOrders(filteredOrders);
      
      // Update rawData for debug panel
      setRawData({
        timestamp: new Date().toISOString(),
        ordersCount: filteredOrders.length,
        allFields: filteredOrders.length > 0 ? Object.keys(filteredOrders[0]) : [],
        firstOrder: filteredOrders[0] || null,
        rawData: filteredOrders
      });
      
      // Zobraz toast o aktualizaci
      showToast?.(`Seznam objedn√°vek aktualizov√°n (${filteredOrders.length} obj)`, {
        type: 'info',
        duration: 3000
      });
    };
    
    bgTasksContext.registerOrdersRefreshCallback?.(refreshCallback);
    
    return () => {
      bgTasksContext.registerOrdersRefreshCallback?.(null);
    };
  }, [bgTasksContext, showToast, showArchived, orders.length, user_id, currentUserId, permissions]); // ‚Üê P≈ôid√°ny dependencies pro debug logging

  // üîî Registrace callbacku pro nov√© notifikace (force unlock warning)
  useEffect(() => {
    if (!bgTasksContext?.registerNewNotificationsCallback) {
      return;
    }

    const handleNewNotifications = (notifications, unreadCount) => {
      if (!notifications || notifications.length === 0) {
        return;
      }

      // Hledej ORDER_UNLOCK_FORCED notifikace
      const forceUnlockNotifications = notifications.filter(n => 
        n.type === 'order_unlock_forced' && 
        n.is_read === false
      );

      if (forceUnlockNotifications.length > 0) {
        // Zobraz warning dialog pro prvn√≠ force unlock notifikaci
        const notification = forceUnlockNotifications[0];
        
        // Parsuj data z notifikace
        const notifData = notification.data || {};
        
        setForceUnlockWarningData({
          orderNumber: notifData.cislo_objednavky || 'N/A',
          lockedBy: notifData.forced_by_name || notifData.forced_by_username || 'N/A',
          lockedByEmail: notifData.forced_by_email || null,
          lockedByPhone: notifData.forced_by_telefon || null,
          lockedAt: notifData.forced_at || new Date().toISOString(),
          notificationId: notification.id
        });
        
        setShowForceUnlockWarning(true);
        
        // console.log('‚ö†Ô∏è [FORCE UNLOCK] Zobrazuji warning dialog pro objedn√°vku:', notifData.cislo_objednavky);
      }
    };

    bgTasksContext.registerNewNotificationsCallback(handleNewNotifications);

    return () => {
      bgTasksContext.registerNewNotificationsCallback?.(null);
    };
  }, [bgTasksContext]);

  // Check for highlighted order ID from DraftManager (after redirect from form)
  useEffect(() => {
    if (!user_id) return;
    
    // üéØ Naƒç√≠st highlightOrderId p≈ôes DraftManager
    const uiState = draftManager.getUIState();
    const highlightId = uiState?.highlightOrderId;
    
    if (highlightId) {
      setHighlightOrderId(highlightId);
      
      // üî• HNED SMAZAT z DraftManager po nastaven√≠
      draftManager.saveUIState({ highlightOrderId: null });
      
      // üìú AUTOMATICK√ù SCROLL na zv√Ωraznƒõnou objedn√°vku
      // Poƒçkat a≈æ se DOM aktualizuje (po naƒçten√≠ dat)
      const scrollToHighlightedRow = () => {
        const highlightedRow = document.querySelector(`[data-order-id="${highlightId}"]`);
        if (highlightedRow) {
          // Z√≠skej pozici ≈ô√°dku a v√Ω≈°ku okna
          const rect = highlightedRow.getBoundingClientRect();
          const viewportHeight = window.innerHeight;
          const rowHeight = rect.height;
          
          // Zjisti, jestli je to jeden z prvn√≠ch ≈ô√°dk≈Ø (m√°lo prostoru naho≈ôe)
          const rowTop = highlightedRow.offsetTop;
          const isNearTop = rowTop < viewportHeight / 2;
          
          // üìç Pro ≈ô√°dky naho≈ôe (vƒçetnƒõ PRVN√çHO) pou≈æij 'start', jinak 'center'
          const blockPosition = isNearTop ? 'start' : 'center';
          
          try {
            highlightedRow.scrollIntoView({ 
              behavior: 'smooth', 
              block: blockPosition,  // 'start' pro prvn√≠ ≈ô√°dky, 'center' pro ostatn√≠
              inline: 'nearest' 
            });
          } catch (e) {
            // Fallback pro star≈°√≠ prohl√≠≈æeƒçe
            highlightedRow.scrollIntoView(isNearTop); // true = align top, false = align bottom
          }
          return true; // √öspƒõch
        }
        return false; // Nepoda≈ôilo se naj√≠t
      };
      
      // Prvn√≠ pokus po 300ms
      setTimeout(() => {
        if (!scrollToHighlightedRow()) {
          
          // Druh√Ω pokus po 800ms (celkem 1100ms)
          setTimeout(() => {
            if (!scrollToHighlightedRow()) {
            }
          }, 800);
        }
      }, 300);
      
      // Clear highlight after 5 seconds with fade effect
      setTimeout(() => {
        setHighlightOrderId(null);
      }, 5000);
    }
  }, [orders, user_id]); // Run when orders change (after load)

  // Mapov√°n√≠ u≈æivatelsky p≈ô√≠vƒõtiv√Ωch stav≈Ø na syst√©mov√© k√≥dy pro statistiky

  // Helper function to get order status pro ZOBRAZEN√ç (preferuje stav_objednavky, fallback na stav_workflow_kod)
  const getOrderDisplayStatus = (order) => {
    // Preferuj u≈æivatelsky p≈ô√≠vƒõtiv√Ω stav z stav_objednavky
    if (order.stav_objednavky) {
      return order.stav_objednavky;
    }
    
    // Fallback na posledn√≠ stav z stav_workflow_kod - pou≈æij kod_stavu nebo nazev_stavu
    if (order.stav_workflow_kod) {
      try {
        const workflowStates = JSON.parse(order.stav_workflow_kod);
        if (Array.isArray(workflowStates)) {
          const lastState = workflowStates[workflowStates.length - 1];
          // Pou≈æij kod_stavu pokud je k dispozici
          if (typeof lastState === 'object' && (lastState.kod_stavu || lastState.nazev_stavu)) {
            return lastState.kod_stavu || 'NEZNAMY_STAV';
          }
          return typeof lastState === 'string' ? lastState : 'NEZNAMY_STAV';
        } else {
          return order.stav_workflow_kod;
        }
      } catch {
        return order.stav_workflow_kod;
      }
    }
    
    return 'DRAFT';
  };

  // Helper function to get order status pro STATISTIKY (v≈ædy syst√©mov√Ω k√≥d)
  const getOrderSystemStatus = (order) => {
    // Speci√°ln√≠ p≈ô√≠pad pro koncepty - poƒç√≠taj√≠ se jako NOVA pro statistiky
    if (order.isDraft || order.je_koncept) {
      return 'NOVA';
    }
    
    // Pokud m√°me u≈æivatelsky p≈ô√≠vƒõtiv√Ω stav, zmapuj na syst√©mov√Ω k√≥d
    if (order.stav_objednavky) {
      return mapUserStatusToSystemCode(order.stav_objednavky);
    }
    
    // Fallback na posledn√≠ stav z stav_workflow_kod
    if (order.stav_workflow_kod) {
      try {
        const workflowStates = JSON.parse(order.stav_workflow_kod);
        return Array.isArray(workflowStates) ? workflowStates[workflowStates.length - 1] : order.stav_workflow_kod;
      } catch {
        return order.stav_workflow_kod;
      }
    }
    
    return 'DRAFT';
  };

  // üí∞ Helper funkce pro z√≠sk√°n√≠ celkov√© ceny s DPH Z POLO≈ΩEK OBJEDN√ÅVKY
  // Poƒç√≠t√° POUZE ze souƒçtu polo≈æek (cena_s_dph), NIKDY z max_cena_s_dph
  const getOrderTotalPriceWithDPH = useCallback((order) => {
    // 1. Zkus vr√°cen√© pole z BE (polozky_celkova_cena_s_dph je ji≈æ souƒçet)
    if (order.polozky_celkova_cena_s_dph != null && order.polozky_celkova_cena_s_dph !== '') {
      const value = parseFloat(order.polozky_celkova_cena_s_dph);
      if (!isNaN(value)) return value;
    }
    
    // 2. Spoƒç√≠tej z polo≈æek (Order V2 API vrac√≠ polozky p≈ô√≠mo v order objektu)
    if (order.polozky && Array.isArray(order.polozky) && order.polozky.length > 0) {
      const total = order.polozky.reduce((sum, item) => {
        const cena = parseFloat(item.cena_s_dph || 0);
        return sum + (isNaN(cena) ? 0 : cena);
      }, 0);
      return total;
    }
    
    // 3. Pokud nejsou polo≈æky, vra≈• 0 (NE max_cena_s_dph!)
    // max_cena_s_dph je limit, ne skuteƒçn√° cena
    return 0;
  }, [orders]);

  // Stats calculation
  const stats = useMemo(() => {
    // OPRAVA: Poƒç√≠tej stats z orders, ale aplikuj showArchived filtr
    // Aby dla≈ædice odpov√≠daly tomu, co se zobrazuje v tabulce
    const dataToCount = showArchived 
      ? orders 
      : orders.filter(order => {
          const status = getOrderSystemStatus(order);
          return status !== 'ARCHIVOVANO';
        });
    
    const total = dataToCount.length;
    const byStatus = dataToCount.reduce((acc, order) => {
      const systemStatus = getOrderSystemStatus(order);
      const displayStatus = getOrderDisplayStatus(order);
      acc[systemStatus] = (acc[systemStatus] || 0) + 1;
      
      // Debug: loguj stav pro prvn√≠ p√°r objedn√°vek
      if (acc._debug < 5) {

        acc._debug = (acc._debug || 0) + 1;
      }
      
      return acc;
    }, {});
    
    const totalAmount = dataToCount.reduce((sum, order) => {
      const amount = getOrderTotalPriceWithDPH(order);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    // Poƒç√≠t√°n√≠ cen dokonƒçen√Ωch a nedokonƒçen√Ωch
    const completedAmount = dataToCount.reduce((sum, order) => {
      const status = getOrderSystemStatus(order);
      const isCompleted = ['DOKONCENA', 'VYRIZENA', 'COMPLETED'].includes(status);
      if (isCompleted) {
        const amount = getOrderTotalPriceWithDPH(order);
        return sum + (isNaN(amount) ? 0 : amount);
      }
      return sum;
    }, 0);

    const incompleteAmount = dataToCount.reduce((sum, order) => {
      const status = getOrderSystemStatus(order);
      const isCancelledOrRejected = ['STORNOVA', 'ZAMITNUTA', 'ZRUSENA', 'CANCELLED', 'SMAZANA'].includes(status);
      const isCompleted = ['DOKONCENA', 'VYRIZENA', 'COMPLETED'].includes(status);
      if (!isCancelledOrRejected && !isCompleted) {
        const amount = getOrderTotalPriceWithDPH(order);
        return sum + (isNaN(amount) ? 0 : amount);
      }
      return sum;
    }, 0);

    // Debug: uk√°≈æ cel√Ω byStatus objekt

    return {
      total,
      nova: byStatus.NOVA || 0,
      odeslana_ke_schvaleni: byStatus.ODESLANA_KE_SCHVALENI || 0,
      schvalena: byStatus.SCHVALENA || 0,
      zamitnuta: byStatus.ZAMITNUTA || 0,
      ceka_se: byStatus.CEKA_SE || 0,
      rozpracovana: byStatus.ROZPRACOVANA || 0,
      odeslana: byStatus.ODESLANA || 0,
      potvrzena: byStatus.POTVRZENA || 0,
      uverejnena: byStatus.UVEREJNENA || 0,
      dokoncena: byStatus.DOKONCENA || 0,
      vyrizena: byStatus.VYRIZENA || 0,
      zrusena: byStatus.ZRUSENA || 0,
      stornova: byStatus.STORNOVA || 0,
      smazana: byStatus.SMAZANA || 0,
      archivovano: byStatus.ARCHIVOVANO || 0,
      k_uverejneni_do_registru: byStatus.K_UVEREJNENI_DO_REGISTRU || 0,
      ceka_potvrzeni: byStatus.CEKA_POTVRZENI || 0,
      draft: byStatus.DRAFT || 0,
      approved: byStatus.APPROVED || 0,
      completed: byStatus.COMPLETED || 0,
      cancelled: byStatus.CANCELLED || 0,
      totalAmount,
      completedAmount,
      incompleteAmount
    };
  }, [orders, showArchived, getOrderTotalPriceWithDPH]); // p≈ôid√°na getOrderTotalPriceWithDPH dependency

  // Pomocn√° funkce pro z√≠sk√°n√≠ data objedn√°vky (skuteƒçn√© nebo doƒçasn√© pro koncepty)
  // Z√≠sk√°n√≠ full datetime pro objedn√°vku
  const getOrderDateTime = useCallback((order) => {
    // Pokud je to koncept (isDraft)
    if (order.isDraft) {
      // Pokud m√° ulo≈æen√© datum prvn√≠ho autosave v _originalData, pou≈æij ho
      if (order._originalData?.firstAutoSaveDate && typeof order._originalData.firstAutoSaveDate === 'string') {
        return order._originalData.firstAutoSaveDate; // Cel√Ω ISO string
      }
      // Jinak pou≈æij dt_vytvoreni
      if (order.dt_vytvoreni && typeof order.dt_vytvoreni === 'string') {
        return order.dt_vytvoreni; // Cel√Ω ISO string
      }
    }
    // Jinak pou≈æij standardn√≠ dt_objednavky
    return (order.dt_objednavky && typeof order.dt_objednavky === 'string') ? order.dt_objednavky : null;
  }, []);

  // Z√≠sk√°n√≠ jen data pro objedn√°vku (pro filtrov√°n√≠ apod.)
  const getOrderDate = useCallback((order) => {
    const dateTime = getOrderDateTime(order);
    return (dateTime && typeof dateTime === 'string') ? dateTime.split('T')[0] : null;
  }, [getOrderDateTime]);

  // Column definitions
  const columns = useMemo(() => [
    {
      id: 'expander',
      header: '',
      cell: ({ row }) => (
        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
          <ExpandButton
            onClick={(e) => {
              row.getToggleExpandedHandler()(e);
              
              // Pokud se ≈ô√°dek rozbaluje, naƒçti detaily osob (pokud je≈°tƒõ nejsou v enriched datech)
              if (!row.getIsExpanded()) {
                const order = row.original;
                
                // Order V2 API enriched vrac√≠: uzivatel{}, prikazce_uzivatel{}, garant_uzivatel{}, schvalovatel{}
                // Naƒçti detaily jen pokud chyb√≠
                if (order.prikazce_id && !order.prikazce?.email && !order.prikazce_uzivatel?.email) {
                  loadPersonDetail(order.id, 'prikazce', order.prikazce_id);
                }
                if (order.uzivatel_id && !order.objednatel?.email && !order.uzivatel?.email) {
                  loadPersonDetail(order.id, 'objednatel', order.uzivatel_id);
                }
                if (order.garant_uzivatel_id && !order.garant?.email && !order.garant_uzivatel?.email) {
                  loadPersonDetail(order.id, 'garant', order.garant_uzivatel_id);
                }
                if (order.schvalovatel_id && !order.schvalovatel?.email) {
                  loadPersonDetail(order.id, 'schvalovatel', order.schvalovatel_id);
                }
              }
            }}
            title={row.getIsExpanded() ? 'Sbalit' : 'Rozbalit'}
          >
            <FontAwesomeIcon icon={row.getIsExpanded() ? faMinus : faPlus} />
          </ExpandButton>
        </div>
      ),
      size: 50,
      meta: {
        align: 'center'
      }
    },
    {
      accessorKey: 'dt_objednavky',
      header: 'Datum objedn√°vky',
      cell: ({ row }) => {
        const orderDateTime = getOrderDateTime(row.original);
        if (!orderDateTime) return <div style={{ textAlign: 'center' }}>---</div>;
        
        const date = new Date(orderDateTime);
        const dateStr = formatDateOnly(date);
        const timeStr = date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
        
        return (
          <div style={{ textAlign: 'center', lineHeight: '1.2' }}>
            <div>{dateStr}</div>
            <div style={{ fontSize: '0.75rem', color: '#6b7280' }}>{timeStr}</div>
          </div>
        );
      },
      size: 120
    },
    {
      accessorKey: 'cislo_objednavky',
      header: 'Ev. ƒç√≠slo',
      cell: ({ row }) => (
        <div style={{ 
          fontWeight: 600, 
          color: '#1e293b', 
          fontFamily: 'monospace',
          textAlign: 'center',
          whiteSpace: 'nowrap',
          overflow: 'visible',
          position: 'relative'
        }}>
          {row.original.stav_objednavky === 'ARCHIVOVANO' && (
            <span style={{ 
              color: '#dc2626', 
              fontWeight: 'bold',
              marginRight: '4px',
              fontSize: '1.1em'
            }}>
              ‚ö†
            </span>
          )}
          {row.original.cislo_objednavky || '---'}
          {row.original.id && !row.original.isDraft && !row.original.je_koncept && (
            <sup style={{ 
              fontSize: '0.6rem', 
              color: '#9ca3af', 
              fontWeight: 'normal',
              marginLeft: '2px'
            }}>
              #{row.original.id}
            </sup>
          )}
        </div>
      ),
      size: 100
    },
    {
      accessorKey: 'predmet',
      header: 'P≈ôedmƒõt',
      cell: ({ row }) => (
        <div style={{ maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis' }}>
          {row.original.predmet || '---'}
        </div>
      )
    },
    {
      accessorKey: 'objednatel',
      header: 'Objednatel', 
      cell: ({ row }) => {
        const order = row.original;
        let name = '---';
        
        // 1. Priorita: Order V2 API enriched data s tituly (objednatel_uzivatel)
        if (order.objednatel_uzivatel) {
          name = getUserDisplayName(null, order.objednatel_uzivatel);
        }
        // 2. Pak zkus objekt objednatel p≈ô√≠mo z BE dat
        else if (order.objednatel) {
          const obj = order.objednatel;
          // Vytvo≈ô kompletn√≠ jm√©no z objektu objednatel s tituly
          if (obj.jmeno && obj.prijmeni) {
            const titul_pred_str = obj.titul_pred ? obj.titul_pred + ' ' : '';
            const titul_za_str = obj.titul_za ? ', ' + obj.titul_za : '';
            name = `${titul_pred_str}${obj.jmeno} ${obj.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (obj.username) {
            name = obj.username;
          } else if (obj.cele_jmeno) {
            name = obj.cele_jmeno;
          }
        }
        // 3. Zkus uzivatel (vytvo≈ôil objedn√°vku)
        else if (order.uzivatel) {
          name = getUserDisplayName(null, order.uzivatel);
        }
        // 4. Fallback na lok√°ln√≠ users mapping podle objednatel_id
        else if (order.objednatel_id) {
          name = getUserDisplayName(order.objednatel_id);
        }
        // 5. Fallback na uzivatel_id (autor objedn√°vky)
        else if (order.uzivatel_id) {
          name = getUserDisplayName(order.uzivatel_id);
        }
        
        return <div title={name}>{name}</div>;
      }
    },
    {
      accessorKey: 'garant',
      header: 'Garant',
      cell: ({ row }) => {
        const order = row.original;
        let name = '---';
        
        // 1. Priorita: Order V2 API enriched data s tituly (garant_uzivatel)
        if (order.garant_uzivatel) {
          // Pokud m√° cele_jmeno, pou≈æij to jako prioritu
          if (order.garant_uzivatel.cele_jmeno) {
            name = order.garant_uzivatel.cele_jmeno;
          } else {
            name = getUserDisplayName(null, order.garant_uzivatel);
          }
        }
        // 2. Pak zkus objekt garant p≈ô√≠mo z BE dat
        else if (order.garant) {
          const gar = order.garant;
          // Vytvo≈ô kompletn√≠ jm√©no z objektu garant s tituly
          if (gar.cele_jmeno) {
            name = gar.cele_jmeno;
          } else if (gar.jmeno && gar.prijmeni) {
            const titul_pred_str = gar.titul_pred ? gar.titul_pred + ' ' : '';
            const titul_za_str = gar.titul_za ? ', ' + gar.titul_za : '';
            name = `${titul_pred_str}${gar.jmeno} ${gar.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (gar.username) {
            name = gar.username;
          }
        }
        // 3. Fallback na lok√°ln√≠ users mapping podle ID
        else if (order.garant_uzivatel_id) {
          name = getUserDisplayName(order.garant_uzivatel_id);
        }
        
        return <div title={name}>{name}</div>;
      },
      size: 150
    },
    {
      accessorKey: 'prikazce',
      header: 'P≈ô√≠kazce',
      cell: ({ row }) => {
        const order = row.original;
        let name = '---';
        
        // 1. Priorita: Order V2 API enriched data s tituly (prikazce_uzivatel)
        if (order.prikazce_uzivatel) {
          name = getUserDisplayName(null, order.prikazce_uzivatel);
        }
        // 2. Pak zkus objekt prikazce p≈ô√≠mo z BE dat
        else if (order.prikazce) {
          const pri = order.prikazce;
          // Vytvo≈ô kompletn√≠ jm√©no z objektu prikazce s tituly
          if (pri.jmeno && pri.prijmeni) {
            const titul_pred_str = pri.titul_pred ? pri.titul_pred + ' ' : '';
            const titul_za_str = pri.titul_za ? ', ' + pri.titul_za : '';
            name = `${titul_pred_str}${pri.jmeno} ${pri.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (pri.username) {
            name = pri.username;
          } else if (pri.cele_jmeno) {
            name = pri.cele_jmeno;
          }
        }
        // 3. Fallback na lok√°ln√≠ users mapping - pou≈æij prikazce_id
        else if (order.prikazce_id) {
          name = getUserDisplayName(order.prikazce_id);
        }
        
        return <div title={name}>{name}</div>;
      },
      size: 150
    },
    {
      accessorKey: 'schvalovatel',
      header: 'Schvalovatel',
      cell: ({ row }) => {
        const order = row.original;
        let name = '---';
        
        // 1. Priorita: Order V2 API enriched data s tituly (schvalovatel_uzivatel)
        if (order.schvalovatel_uzivatel) {
          name = getUserDisplayName(null, order.schvalovatel_uzivatel);
        }
        // 2. Pak zkus objekt schvalovatel p≈ô√≠mo z BE dat
        else if (order.schvalovatel) {
          const sch = order.schvalovatel;
          // Vytvo≈ô kompletn√≠ jm√©no z objektu schvalovatel s tituly
          if (sch.jmeno && sch.prijmeni) {
            const titul_pred_str = sch.titul_pred ? sch.titul_pred + ' ' : '';
            const titul_za_str = sch.titul_za ? ', ' + sch.titul_za : '';
            name = `${titul_pred_str}${sch.jmeno} ${sch.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (sch.username) {
            name = sch.username;
          } else if (sch.cele_jmeno) {
            name = sch.cele_jmeno;
          }
        }
        // 3. Fallback na lok√°ln√≠ users mapping
        else if (order.schvalovatel_id) {
          name = getUserDisplayName(order.schvalovatel_id);
        }
        
        return <div title={name}>{name}</div>;
      },
      size: 150
    },
    {
      accessorKey: 'stav_objednavky',
      header: 'Stav',
      cell: ({ row }) => {
        const order = row.original;
        const statusCode = getOrderSystemStatus(order);
        const displayStatus = getOrderDisplayStatus(order);
        
        // Pou≈æijeme displayStatus (u≈æivatelsky p≈ô√≠vƒõtiv√Ω) pro zobrazen√≠
        let statusText = displayStatus;
        
        // Speci√°ln√≠ zobrazen√≠ pro koncepty
        if (order.isDraft || order.je_koncept) {
          statusText = 'Nova / koncept';
        }
        else if (order.stav_workflow) {
          // Order V2 API enriched m≈Ø≈æe vracet stav_workflow objekt nebo string
          if (typeof order.stav_workflow === 'object') {
            // Pou≈æij nazev_stavu pokud je k dispozici
            if (order.stav_workflow.nazev_stavu) {
              statusText = order.stav_workflow.nazev_stavu;
            } else if (order.stav_workflow.nazev) {
              statusText = order.stav_workflow.nazev;
            } else {
              statusText = 'Nezn√°m√Ω stav';
            }
          } else {
            // Pro string nebo jin√© primitivn√≠ hodnoty
            statusText = order.stav_workflow?.nazev_stavu || order.stav_workflow?.nazev || String(order.stav_workflow) || 'Nezn√°m√Ω stav';
          }
        }
        
        return (
          <StatusBadge 
            $status={statusCode}
            $isInEditRow={row.original.isDraft || row.original.hasLocalDraftChanges || false}
          >
            <FontAwesomeIcon 
              icon={
                statusCode === 'NOVA' ? faFilePen :
                statusCode === 'ODESLANA_KE_SCHVALENI' ? faClock :
                statusCode === 'SCHVALENA' ? faShield :
                statusCode === 'POTVRZENA' ? faCheckCircle :
                statusCode === 'UVEREJNENA' ? faFileContract :
                statusCode === 'DOKONCENA' ? faTruck :
                statusCode === 'ZRUSENA' ? faXmark :
                faCircleNotch
              }
              style={{ 
                alignSelf: 'flex-start',
                marginTop: '2px',
                fontSize: '12px'
              }}
            />
            <span style={{ lineHeight: '1.2' }}>{statusText}</span>
          </StatusBadge>
        );
      }
    },
    {
      accessorKey: 'stav_registru',
      header: 'Stav registru',
      cell: ({ row }) => {
        const order = row.original;
        const registr = order.registr_smluv;
        
        let stavText = '';
        let stavIcon = null;
        let statusCode = 'EMPTY'; // Pro pr√°zdn√Ω stav
        
        // Logika podle BE struktury:
        // 1. Pokud existuje dt_zverejneni A registr_iddt -> "Zve≈ôejnƒõno"
        // 2. Pokud existuje zverejnit: "ANO" -> "M√° b√Ωt zve≈ôejnƒõno"
        // 3. Jinak -> pr√°zdn√©
        
        if (registr) {
          if (registr.dt_zverejneni && registr.registr_iddt) {
            stavText = 'Zve≈ôejnƒõno';
            stavIcon = faCheckCircle;
            statusCode = 'UVEREJNENA'; // Pou≈æij status code pro zelen√© t√©ma
          } else if (registr.zverejnit === 'ANO') {
            stavText = 'M√° b√Ωt zve≈ôejnƒõno';
            stavIcon = faClock;
            statusCode = 'ODESLANA_KE_SCHVALENI'; // Pou≈æij status code pro oran≈æov√© t√©ma
          }
        }
        
        // Pokud nem√°me ≈æ√°dn√Ω stav, vra≈• ---
        if (!stavText) {
          return (
            <div style={{ 
              textAlign: 'center',
              color: '#94a3b8',
              fontSize: '0.9em'
            }}>
              ---
            </div>
          );
        }
        
        return (
          <div style={{ 
            display: 'flex', 
            justifyContent: 'center', 
            alignItems: 'center',
            width: '100%'
          }}>
            <StatusBadge 
              $status={statusCode}
              $isInEditRow={false}
              title={registr?.registr_iddt || ''}
            >
              <FontAwesomeIcon 
                icon={stavIcon}
                style={{ 
                  alignSelf: 'flex-start',
                  marginTop: '2px',
                  fontSize: '12px'
                }}
              />
              <span style={{ lineHeight: '1.2' }}>{stavText}</span>
            </StatusBadge>
          </div>
        );
      },
      size: 150
    },
    {
      accessorKey: 'cena_s_dph',
      header: 'Cena s DPH',
      cell: ({ row }) => {
        // üí∞ Pou≈æij helper funkci pro p≈ôesn√Ω v√Ωpoƒçet ceny s DPH
        const price = getOrderTotalPriceWithDPH(row.original);
        return (
          <div style={{ textAlign: 'right', fontWeight: 600, fontFamily: 'monospace', whiteSpace: 'nowrap' }}>
            {!isNaN(price) && price > 0 ? <>{price.toLocaleString('cs-CZ')}&nbsp;Kƒç</> : '---'}
          </div>
        );
      }
    },
    {
      accessorKey: 'max_cena_s_dph',
      header: 'Max. cena s DPH',
      cell: ({ row }) => {
        const price = parseFloat(row.original.max_cena_s_dph || 0);
        return (
          <div style={{ textAlign: 'right', fontWeight: 600, fontFamily: 'monospace', whiteSpace: 'nowrap' }}>
            {!isNaN(price) && price > 0 ? <>{price.toLocaleString('cs-CZ')}&nbsp;Kƒç</> : '---'}
          </div>
        );
      }
    },
    {
      id: 'actions',
      size: 140, // 4 ikony √ó 2rem (32px) + 3 mezery √ó 0.12rem (~2px) + padding = ~140px
      maxSize: 140,
      header: () => (
        <div style={{ 
          textAlign: 'center',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          width: '100%'
        }}>
          <FontAwesomeIcon 
            icon={faBolt} 
            style={{ 
              color: '#eab308',
              fontSize: '16px'
            }} 
          />
        </div>
      ),
      cell: ({ row }) => (
        <ActionMenu>
          <ActionMenuButton
            className="edit"
            onClick={() => handleEdit(row.original)}
            title={(row.original.isDraft || row.original.hasLocalDraftChanges) ? "Pokraƒçovat v editaci" : "Editovat"}
            disabled={!canEdit(row.original)}
          >
            <FontAwesomeIcon icon={faEdit} />
          </ActionMenuButton>
          <ActionMenuButton
            onClick={() => handleView(row.original)}
            title="N√°hled"
          >
            <FontAwesomeIcon icon={faEye} />
          </ActionMenuButton>
          <ActionMenuButton
            className="export-document"
            onClick={() => handleExportDocument(row.original)}
            title="Generovat DOCX"
            disabled={!canExportDocument(row.original)}
          >
            <FontAwesomeIcon icon={faFileWord} />
          </ActionMenuButton>
          <ActionMenuButton
            className="delete"
            onClick={() => handleDelete(row.original)}
            title="Smazat"
            disabled={!canDelete(row.original)}
          >
            <FontAwesomeIcon icon={faTrash} />
          </ActionMenuButton>
        </ActionMenu>
      ),
      size: 120,
      minSize: 120,
      maxSize: 140
    }
  ], [users, getOrderDate]);

  // Helper function to get user display name with titles
  const getUserDisplayName = useCallback((userId, enrichedUser = null) => {
    if (enrichedUser) {
      const { titul_pred, jmeno, prijmeni, titul_za } = enrichedUser;
      // Spr√°vn√© po≈ôad√≠: Titul p≈ôed + Jm√©no + P≈ô√≠jmen√≠ + Titul za
      const titul_pred_str = titul_pred ? titul_pred + ' ' : '';
      const jmeno_str = jmeno || '';
      const prijmeni_str = prijmeni || '';
      const titul_za_str = titul_za ? ', ' + titul_za : '';
      
      return `${titul_pred_str}${jmeno_str} ${prijmeni_str}${titul_za_str}`.replace(/\s+/g, ' ').trim();
    }
    
    if (userId && users[userId]) {
      // Pokud m√°me objekt s displayName, pou≈æij ho
      if (typeof users[userId] === 'object' && users[userId].displayName) {
        return users[userId].displayName;
      }
      // Pokud je to star√Ω form√°t (pouze string), pou≈æij ho
      if (typeof users[userId] === 'string') {
        return users[userId];
      }
    }
    
    return 'Nezn√°m√Ω';
  }, [users]);

  // Utility function pro odstranƒõn√≠ diakritiky
  const removeDiacritics = useCallback((text) => {
    if (!text) return '';
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, ''); // Odstran√≠ diakritick√© znaky
  }, []);

  // Get unique users for dropdowns from current orders data

  // Filter function
  const filteredData = useMemo(() => {
    // üîß DEBUG: Log p≈ôi ka≈æd√©m p≈ôefiltrov√°n√≠
    console.group('üîç [Filter Data] P≈ôefiltrov√°n√≠ dat');
    console.log('üìä Vstupn√≠ poƒçet objedn√°vek:', orders.length);
    console.log('üîê Permissions:', permissions);
    console.log('üë§ Current User ID:', currentUserId);
    console.log('üìÖ Timestamp:', new Date().toISOString());
    
    const filtered = orders.filter(order => {
      // "JEN MOJE" filtr - nez√°visl√Ω na ostatn√≠ch filtrech, pouze pro SUPERADMIN a ADMINISTRATOR
      if (showOnlyMyOrders && userDetail?.roles) {
        const isSuperAdminOrAdmin = userDetail.roles.some(
          role => role.kod_role === 'SUPERADMIN' || role.kod_role === 'ADMINISTRATOR'
        );
        
        if (isSuperAdminOrAdmin) {
          // Filtruj objedn√°vky kde je u≈æivatel jako Objednatel, Garant, Schvalovatel nebo P≈ô√≠kazce
          // üî• FIX: Pou≈æij currentUserId (number) m√≠sto user_id (string)
          const isObjednatel = order.objednatel_id === currentUserId || order.uzivatel_id === currentUserId;
          const isGarant = order.garant_uzivatel_id === currentUserId;
          const isSchvalovatel = order.schvalovatel_id === currentUserId;
          const isPrikazce = order.prikazce_id === currentUserId;
          
          if (!isObjednatel && !isGarant && !isSchvalovatel && !isPrikazce) {
            return false;
          }
        }
      }
      
      // üîß FIX: Pou≈æij stabiln√≠ permissions object m√≠sto hasPermission funkce
      // Toto zabr√°n√≠ zbyteƒçn√©mu p≈ôefiltrov√°n√≠ p≈ôi background refresh
      // ÔøΩ PERMISSIONS FILTR ODSTRANƒöN - Backend V2 API u≈æ filtruje podle rol√≠!
      // Backend automaticky aplikuje 12-role WHERE klauzuli p≈ôi SQL dotazu.
      // U≈æivatel s omezen√Ωmi pr√°vy dost√°v√° jen objedn√°vky kde m√° nƒõjakou roli.
      // Viz: BACKEND-ORDER-V2-USER-ROLES-FILTER.md
      
      // Column-specific filters
      if (columnFilters.dt_objednavky) {
        const orderDateValue = getOrderDate(order);
        if (!orderDateValue) return false;
        const dateStr = formatDateOnly(new Date(orderDateValue));
        if (!dateStr.toLowerCase().includes(columnFilters.dt_objednavky.toLowerCase())) {
          return false;
        }
      }

      if (columnFilters.cislo_objednavky) {
        const cislo = removeDiacritics(order.cislo_objednavky || '');
        if (!cislo.includes(removeDiacritics(columnFilters.cislo_objednavky))) {
          return false;
        }
      }

      if (columnFilters.predmet) {
        const predmet = removeDiacritics(order.predmet || '');
        if (!predmet.includes(removeDiacritics(columnFilters.predmet))) {
          return false;
        }
      }

      if (columnFilters.objednatel) {
        const enriched = order._enriched || {};
        let objednatelId = null;
        
        // Z√≠skej ID objednatele
        if (enriched?.uzivatel?.id) {
          objednatelId = String(enriched.uzivatel.id);
        } else if (order.uzivatel_id) {
          objednatelId = String(order.uzivatel_id);
        } else if (order.objednatel_id) {
          objednatelId = String(order.objednatel_id);
        }
        
        if (!objednatelId) return false;
        
        // Multiselect: columnFilters.objednatel obsahuje ID oddƒõlen√° '|'
        const selectedIds = columnFilters.objednatel.split('|').map(id => id.trim());
        if (!selectedIds.includes(objednatelId)) {
          return false;
        }
      }

      if (columnFilters.stav_objednavky) {
        const displayStatus = removeDiacritics(getOrderDisplayStatus(order));
        if (!displayStatus.includes(removeDiacritics(columnFilters.stav_objednavky))) {
          return false;
        }
      }

      if (columnFilters.max_cena_s_dph) {
        const amount = parseFloat(order.max_cena_s_dph || 0);
        const amountStr = amount > 0 ? amount.toLocaleString('cs-CZ') : '';
        if (!amountStr.includes(columnFilters.max_cena_s_dph)) {
          return false;
        }
      }

      // Garant filter
      if (columnFilters.garant) {
        const filterValue = columnFilters.garant.trim();
        
        // Pokud filtr obsahuje |, jedn√° se o multiselect s ID
        if (filterValue.includes('|')) {
          const enriched = order._enriched;
          let garantId = null;
          
          // Z√≠skej ID garanta
          if (enriched?.garant_uzivatel?.id) {
            garantId = String(enriched.garant_uzivatel.id);
          } else if (order.garant?.id) {
            garantId = String(order.garant.id);
          } else if (order.garant_uzivatel_id) {
            garantId = String(order.garant_uzivatel_id);
          }
          
          if (!garantId) return false;
          
          // Multiselect: columnFilters.garant obsahuje ID oddƒõlen√° '|'
          const selectedIds = filterValue.split('|').map(id => id.trim());
          if (!selectedIds.includes(garantId)) {
            return false;
          }
        } else {
          // Jinak hled√°me v textov√©m jm√©nƒõ (vyhled√°vac√≠ pole)
          const enriched = order._enriched;
          let garantName = '';
          
          // Z√≠skej jm√©no garanta
          if (order.garant?.jmeno && order.garant?.prijmeni) {
            const gar = order.garant;
            const titul_pred_str = gar.titul_pred ? gar.titul_pred + ' ' : '';
            const titul_za_str = gar.titul_za ? ', ' + gar.titul_za : '';
            garantName = `${titul_pred_str}${gar.jmeno} ${gar.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (enriched?.garant_uzivatel) {
            garantName = getUserDisplayName(null, enriched.garant_uzivatel);
          } else if (order.garant_uzivatel_id) {
            garantName = getUserDisplayName(order.garant_uzivatel_id);
          }
          
          // Textov√© vyhled√°v√°n√≠ bez diakritiky
          if (!removeDiacritics(garantName.toLowerCase()).includes(removeDiacritics(filterValue.toLowerCase()))) {
            return false;
          }
        }
      }

      // P≈ô√≠kazce filter
      if (columnFilters.prikazce) {
        const filterValue = columnFilters.prikazce.trim();
        
        // Pokud filtr obsahuje |, jedn√° se o multiselect s ID
        if (filterValue.includes('|')) {
          const enriched = order._enriched;
          let prikazceId = null;
          
          // Z√≠skej ID p≈ô√≠kazce
          if (enriched?.prikazce_uzivatel?.id) {
            prikazceId = String(enriched.prikazce_uzivatel.id);
          } else if (order.prikazce?.id) {
            prikazceId = String(order.prikazce.id);
          } else if (order.prikazce_id) {
            prikazceId = String(order.prikazce_id);
          }
          
          if (!prikazceId) return false;
          
          // Multiselect: columnFilters.prikazce obsahuje ID oddƒõlen√° '|'
          const selectedIds = filterValue.split('|').map(id => id.trim());
          if (!selectedIds.includes(prikazceId)) {
            return false;
          }
        } else {
          // Jinak hled√°me v textov√©m jm√©nƒõ (vyhled√°vac√≠ pole)
          const enriched = order._enriched;
          let prikazceName = '';
          
          // Z√≠skej jm√©no p≈ô√≠kazce
          if (order.prikazce?.jmeno && order.prikazce?.prijmeni) {
            const pri = order.prikazce;
            const titul_pred_str = pri.titul_pred ? pri.titul_pred + ' ' : '';
            const titul_za_str = pri.titul_za ? ', ' + pri.titul_za : '';
            prikazceName = `${titul_pred_str}${pri.jmeno} ${pri.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (enriched?.prikazce_uzivatel) {
            prikazceName = getUserDisplayName(null, enriched.prikazce_uzivatel);
          } else if (order.prikazce_id) {
            prikazceName = getUserDisplayName(order.prikazce_id);
          }
          
          // Textov√© vyhled√°v√°n√≠ bez diakritiky
          if (!removeDiacritics(prikazceName.toLowerCase()).includes(removeDiacritics(filterValue.toLowerCase()))) {
            return false;
          }
        }
      }

      // Schvalovatel filter  
      if (columnFilters.schvalovatel) {
        const filterValue = columnFilters.schvalovatel.trim();
        
        // Pokud filtr obsahuje |, jedn√° se o multiselect s ID
        if (filterValue.includes('|')) {
          const enriched = order._enriched;
          let schvalovatelId = null;
          
          // Z√≠skej ID schvalovatele
          if (enriched?.schvalovatel_uzivatel?.id) {
            schvalovatelId = String(enriched.schvalovatel_uzivatel.id);
          } else if (order.schvalovatel?.id) {
            schvalovatelId = String(order.schvalovatel.id);
          } else if (order.schvalovatel_id) {
            schvalovatelId = String(order.schvalovatel_id);
          }
          
          if (!schvalovatelId) return false;
          
          // Multiselect: columnFilters.schvalovatel obsahuje ID oddƒõlen√° '|'
          const selectedIds = filterValue.split('|').map(id => id.trim());
          if (!selectedIds.includes(schvalovatelId)) {
            return false;
          }
        } else {
          // Jinak hled√°me v textov√©m jm√©nƒõ (vyhled√°vac√≠ pole)
          const enriched = order._enriched;
          let schvalovatelName = '';
          
          // Z√≠skej jm√©no schvalovatele
          if (order.schvalovatel?.jmeno && order.schvalovatel?.prijmeni) {
            const sch = order.schvalovatel;
            const titul_pred_str = sch.titul_pred ? sch.titul_pred + ' ' : '';
            const titul_za_str = sch.titul_za ? ', ' + sch.titul_za : '';
            schvalovatelName = `${titul_pred_str}${sch.jmeno} ${sch.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
          } else if (enriched?.schvalovatel) {
            schvalovatelName = getUserDisplayName(null, enriched.schvalovatel);
          } else if (order.schvalovatel_id) {
            schvalovatelName = getUserDisplayName(order.schvalovatel_id);
          }
          
          // Textov√© vyhled√°v√°n√≠ bez diakritiky
          if (!removeDiacritics(schvalovatelName.toLowerCase()).includes(removeDiacritics(filterValue.toLowerCase()))) {
            return false;
          }
        }
      }

      // Global search
      if (globalFilter) {
        const searchText = removeDiacritics(globalFilter);
        const enriched = order._enriched || {};
        
        // Helper function pro z√≠sk√°n√≠ jm√©na z objektu nebo enriched dat
        const getGarantName = () => {
          if (enriched.garant_uzivatel) return getUserDisplayName(null, enriched.garant_uzivatel);
          if (order.garant) {
            if (order.garant.jmeno && order.garant.prijmeni) {
              const titul_pred_str = order.garant.titul_pred ? order.garant.titul_pred + ' ' : '';
              const titul_za_str = order.garant.titul_za ? ', ' + order.garant.titul_za : '';
              return `${titul_pred_str}${order.garant.jmeno} ${order.garant.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
            } else {
              return order.garant.username || '';
            }
          }
          if (order.garant_uzivatel_id) return getUserDisplayName(order.garant_uzivatel_id);
          return '';
        };
        
        const getSchvalovatelName = () => {
          if (enriched.schvalovatel_uzivatel) return getUserDisplayName(null, enriched.schvalovatel_uzivatel);
          if (order.schvalovatel) {
            if (order.schvalovatel.jmeno && order.schvalovatel.prijmeni) {
              const titul_pred_str = order.schvalovatel.titul_pred ? order.schvalovatel.titul_pred + ' ' : '';
              const titul_za_str = order.schvalovatel.titul_za ? ', ' + order.schvalovatel.titul_za : '';
              return `${titul_pred_str}${order.schvalovatel.jmeno} ${order.schvalovatel.prijmeni}${titul_za_str}`.replace(/\s+/g, ' ').trim();
            } else {
              return order.schvalovatel.username || '';
            }
          }
          if (order.schvalovatel_id) return getUserDisplayName(order.schvalovatel_id);
          return '';
        };

        const searchableText = removeDiacritics([
          order.cislo_objednavky,
          order.predmet,
          order.dodavatel_nazev,
          order.poznamka,
          enriched.uzivatel ? getUserDisplayName(null, enriched.uzivatel) : '',
          getGarantName(),
          getSchvalovatelName(),
          enriched.stav_workflow 
            ? enriched.stav_workflow.nazev_stavu || enriched.stav_workflow.nazev
            : getOrderDisplayStatus(order),
          (() => {
            // Zkus parsovat enriched.druh_objednavky.nazev (m≈Ø≈æe b√Ωt stringified JSON)
            if (enriched.druh_objednavky?.nazev) {
              try {
                if (typeof enriched.druh_objednavky.nazev === 'string' && enriched.druh_objednavky.nazev.startsWith('{')) {
                  const parsed = JSON.parse(enriched.druh_objednavky.nazev);
                  return parsed.nazev_stavu || parsed.nazev || enriched.druh_objednavky.nazev;
                }
                return enriched.druh_objednavky.nazev;
              } catch (e) {
                return enriched.druh_objednavky.nazev;
              }
            }
            if (enriched.druh_objednavky?.nazev_stavu) return enriched.druh_objednavky.nazev_stavu;
            if (order.druh_objednavky_kod) {
              try {
                if (typeof order.druh_objednavky_kod === 'string' && order.druh_objednavky_kod.startsWith('{')) {
                  const parsed = JSON.parse(order.druh_objednavky_kod);
                  return parsed.nazev_stavu || parsed.nazev || '';
                }
                if (typeof order.druh_objednavky_kod === 'object' && order.druh_objednavky_kod.nazev_stavu) {
                  return order.druh_objednavky_kod.nazev_stavu;
                }
                return order.druh_objednavky_kod;
              } catch (e) {
                return '';
              }
            }
            return '';
          })(),
          enriched.strediska ? enriched.strediska.map(s => `${s.kod} ${s.nazev}`).join(' ') : order.strediska_kod,
          getUserDisplayName(order.uzivatel_id),
          getUserDisplayName(order.objednatel_id)
        ].filter(Boolean).join(' '));
        
        if (!searchableText.includes(searchText)) {
          return false;
        }
      }

      // Status filter - pouze pokud je statusFilter nepr√°zdn√Ω (pole)
      if (statusFilter && Array.isArray(statusFilter) && statusFilter.length > 0) {
        // üîß OPRAVA: Porovn√°vej p≈ô√≠mo hodnotu z order.stav_objednavky (u≈æivatelsk√Ω stav z DB)
        // BEZ ROZLI≈†EN√ç VELIKOSTI P√çSMEN A BEZ DIAKRITIKY
        const orderStatus = order.stav_objednavky;
        
        // Helper funkce pro normalizaci textu (bez diakritiky, lowercase)
        const normalizeText = (text) => {
          if (!text) return '';
          return text
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, ''); // Odstra≈à diakritiku
        };
        
        // Pokud objedn√°vka nem√° stav (koncept), pou≈æij fallback
        if (!orderStatus) {
          // Koncepty se poƒç√≠taj√≠ jako NOVA
          const shouldInclude = statusFilter.some(filterVal => {
            const normalized = normalizeText(filterVal);
            return normalized === 'nova' || normalized === 'draft' || normalized === 'nova objednavka';
          });
          if (!shouldInclude) return false;
        } else {
          // Normalizuj stav objedn√°vky a v≈°echny hodnoty z filtru
          const normalizedOrderStatus = normalizeText(orderStatus);
          
          // Porovnej s filtrem
          const shouldInclude = statusFilter.some(filterVal => {
            const normalizedFilter = normalizeText(filterVal);
            return normalizedOrderStatus === normalizedFilter;
          });
          
          if (!shouldInclude) return false;
        }
      }

      // Archived filter - pokud nen√≠ za≈°krtnuto "S archivov√°no", odfiltruj archivovan√© objedn√°vky
      if (!showArchived) {
        const status = getOrderSystemStatus(order);
        if (status === 'ARCHIVOVANO') {
          return false; // Nezobrazuj archivovan√© objedn√°vky kdy≈æ checkbox nen√≠ za≈°krtnut√Ω
        }
      }

      // User filter - check uzivatel_id (creator) or objednatel_id (if exists)
      if (userFilter) {
        const userId = parseInt(userFilter);
        const matchesCreator = order.uzivatel_id === userId;
        const matchesOrderer = order.objednatel_id === userId;
        
        if (!matchesCreator && !matchesOrderer) {
          return false;
        }
      }

      // Date filters - kontrola dt_objednavky (datum vytvo≈ôen√≠) i datum_obj_do (konec obdob√≠)
      // Objedn√°vka projde filtrem pokud BUƒéTO dt_objednavky NEBO datum_obj_do spad√° do rozmez√≠
      if (dateFromFilter || dateToFilter) {
        const dtObjednavky = getOrderDate(order); // dt_objednavky
        const datumObjDo = order.datum_obj_do ? order.datum_obj_do.split('T')[0] : null; // datum_obj_do (konec obdob√≠)
        
        // Pokud m√° objedn√°vka alespo≈à jedno z tƒõchto dat, kontroluj filtry
        const hasAnyDate = dtObjednavky || datumObjDo;
        
        if (hasAnyDate) {
          let passesFilter = false;
          
          // Kontrola dt_objednavky
          if (dtObjednavky) {
            const orderDate = new Date(dtObjednavky);
            const fromDate = dateFromFilter ? new Date(dateFromFilter) : null;
            const toDate = dateToFilter ? new Date(dateToFilter) : null;
            
            if (toDate) toDate.setHours(23, 59, 59, 999);
            
            const afterFrom = !fromDate || orderDate >= fromDate;
            const beforeTo = !toDate || orderDate <= toDate;
            
            if (afterFrom && beforeTo) {
              passesFilter = true;
            }
          }
          
          // Kontrola datum_obj_do (pokud dt_objednavky nepro≈°lo)
          if (!passesFilter && datumObjDo) {
            const objDoDate = new Date(datumObjDo);
            const fromDate = dateFromFilter ? new Date(dateFromFilter) : null;
            const toDate = dateToFilter ? new Date(dateToFilter) : null;
            
            if (toDate) toDate.setHours(23, 59, 59, 999);
            
            const afterFrom = !fromDate || objDoDate >= fromDate;
            const beforeTo = !toDate || objDoDate <= toDate;
            
            if (afterFrom && beforeTo) {
              passesFilter = true;
            }
          }
          
          // Pokud ani jedno datum neprojde filtrem, odfiltruj objedn√°vku
          if (!passesFilter) return false;
        }
      }

      // Amount filters
      const amount = parseFloat(order.max_cena_s_dph || 0);
      if (amountFromFilter && amount < parseFloat(amountFromFilter)) return false;
      if (amountToFilter && amount > parseFloat(amountToFilter)) return false;

      // Filtr "M√° b√Ωt zve≈ôejnƒõno" - objedn√°vky kter√© maj√≠ zverejnit: 'ANO' (ale je≈°tƒõ nejsou zve≈ôejnƒõn√©)
      if (filterMaBytZverejneno) {
        const registr = order.registr_smluv;
        // M√° b√Ωt zve≈ôejnƒõno = zverejnit: 'ANO' ALE je≈°tƒõ NEM√Å dt_zverejneni a registr_iddt
        const maZverejnit = registr?.zverejnit === 'ANO';
        const jeZverejneno = registr?.dt_zverejneni && registr?.registr_iddt;
        
        if (!maZverejnit || jeZverejneno) {
          return false;
        }
      }

      // Filtr "Bylo ji≈æ zve≈ôejnƒõno" - objedn√°vky kter√© maj√≠ vyplnƒõn√© OBOJ√ç: dt_zverejneni I registr_iddt
      if (filterByloZverejneno) {
        const registr = order.registr_smluv;
        const jeZverejneno = registr?.dt_zverejneni && registr?.registr_iddt;
        
        // Bylo zve≈ôejnƒõno = m√° vyplnƒõn√© OBOJ√ç dt_zverejneni I registr_iddt
        if (!jeZverejneno) {
          return false;
        }
      }

      return true;
    });
    
    // üîß DEBUG: V√Ωsledky filtrov√°n√≠
    console.log('‚úÖ V√Ωstupn√≠ poƒçet objedn√°vek:', filtered.length);
    console.log('üîÑ Zmƒõna:', orders.length, '‚Üí', filtered.length, `(${orders.length - filtered.length} odfiltrov√°no)`);
    
    if (filtered.length === 0 && orders.length > 0) {
      console.warn('‚ö†Ô∏è V≈†ECHNY OBJEDN√ÅVKY BYLY ODFILTROV√ÅNY!');
      console.warn('   Mo≈æn√© p≈ô√≠ƒçiny:');
      console.warn('   1. Permissions filtr - u≈æivatel nem√° p≈ô√≠stup k ≈æ√°dn√© objedn√°vce');
      console.warn('   2. Aktivn√≠ filtry - zkontroluj statusFilter, dateFromFilter, atd.');
      console.warn('   3. showOnlyMyOrders - filtr "Jen moje"');
      console.warn('   Zkontroluj permissions a filtry v√Ω≈°e ‚Üë');
    }
    
    // Debug uk√°zka permissions filtru
    if (!permissions.canViewAll && permissions.hasOnlyOwn) {
      console.log('üîê Permissions filtr aktivn√≠ (ORDER_*_OWN)');
      console.log('   U≈æivatel vid√≠ pouze objedn√°vky kde je:');
      console.log('   - objednatel_id ==', currentUserId);
      console.log('   - uzivatel_id ==', currentUserId);
      console.log('   - garant_uzivatel_id ==', currentUserId);
      console.log('   - schvalovatel_id ==', currentUserId);
      
      if (orders.length > 0 && filtered.length > 0) {
        console.log('   Uk√°zka prvn√≠ vyfiltrovan√© objedn√°vky:');
        const first = filtered[0];
        console.log('   - ID:', first.id);
        console.log('   - ƒå√≠slo:', first.cislo_objednavky);
        console.log('   - objednatel_id:', first.objednatel_id);
        console.log('   - uzivatel_id:', first.uzivatel_id);
        console.log('   - garant_uzivatel_id:', first.garant_uzivatel_id);
        console.log('   - schvalovatel_id:', first.schvalovatel_id);
      }
    } else if (permissions.canViewAll) {
      console.log('üîì Permissions filtr NEAKTIVN√ç (m√° ORDER_*_ALL)');
    }
    
    console.groupEnd();
    
    return filtered;
  }, [orders, columnFilters, globalFilter, statusFilter, userFilter, dateFromFilter, dateToFilter, amountFromFilter, amountToFilter, filterMaBytZverejneno, filterByloZverejneno, users, getOrderDate, getUserDisplayName, removeDiacritics, permissions, user_id, showArchived, showOnlyMyOrders, userDetail, currentUserId]);
  // üîß FIX: Nahrazeno hasPermission ‚Üí permissions pro stabiln√≠ filtrov√°n√≠ podle opr√°vnƒõn√≠
  // P≈ôid√°n currentUserId pro spr√°vn√© porovn√°n√≠ ID u≈æivatele
  
  // üß™ DEBUG: Ulo≈æ filtered data pro test panel
  useEffect(() => {
    setApiTestData(prev => ({
      ...prev,
      filteredData: filteredData,
      filteredCount: filteredData.length,
      archivedInFiltered: filteredData.filter(o => getOrderSystemStatus(o) === 'ARCHIVOVANO').length,
      nonArchivedInFiltered: filteredData.filter(o => getOrderSystemStatus(o) !== 'ARCHIVOVANO').length,
      filterState: {
        showArchived,
        selectedYear,
        selectedMonth,
        canViewAllOrders: permissions?.canViewAll,
        currentUserId
      }
    }));
  }, [filteredData, showArchived, selectedYear, selectedMonth, permissions, currentUserId]);

  // üìç SCROLL STATE: Obnov rozbalen√© objedn√°vky A≈Ω kdy≈æ je filteredData ready
  useEffect(() => {
    // Aktualizuj ref pro pou≈æit√≠ v save useEffect
    filteredDataRef.current = filteredData;
    
    if (!pendingExpandedOrderIds.current || filteredData.length === 0) {
      return;
    }
    
    // Poƒçkej na render tabulky, pak rozbali objedn√°vky podle ID
    setTimeout(() => {
      // Double-check ≈æe ref st√°le existuje (mohl b√Ωt vynulov√°n mezit√≠m)
      if (!pendingExpandedOrderIds.current || !Array.isArray(pendingExpandedOrderIds.current)) {
        return;
      }
      
      const newExpanded = {};
      
      // Najdi indexy objedn√°vek podle ID
      pendingExpandedOrderIds.current.forEach(orderId => {
        const index = filteredData.findIndex(order => order.id === orderId);
        if (index >= 0) {
          newExpanded[index] = true;
        }
      });
      
      if (Object.keys(newExpanded).length > 0) {
        setExpanded(newExpanded);
        
        // üé¨ INITIALIZATION: Oznaƒç dokonƒçen√≠ rozbalen√≠
        initStepsCompleted.current.expandedRestored = true;
        
        // Oznaƒç scroll jako "p≈ôipraven√Ω"
        initStepsCompleted.current.scrollRestored = true;
      } else {
        // ≈Ω√°dn√© objedn√°vky se nepoda≈ôilo rozbalit
        initStepsCompleted.current.expandedRestored = true;
        initStepsCompleted.current.scrollRestored = true;
      }
      
      // Vyƒçisti ref
      pendingExpandedOrderIds.current = null;
    }, 100); // Kr√°tk√© ƒçek√°n√≠ aby se stihla vykreslit tabulka
  }, [filteredData]); // Spust√≠ se kdy≈æ je filteredData p≈ôipraven√©
  
  // üé¨ INITIALIZATION: Kontroluj dokonƒçen√≠ v≈°ech krok≈Ø a skryj splash screen
  // üîß REVERT: Vr√°cen p≈Øvodn√≠ polling p≈ô√≠stup (funguje spolehlivƒõ)
  // Event-driven p≈ô√≠stup by vy≈æadoval p≈ôepis v≈°ech m√≠st kde se nastavuje initStepsCompleted.current
  useEffect(() => {
    const steps = initStepsCompleted.current;
    
    // Kontroluj ka≈æd√Ωch 100ms jestli jsou v≈°echny kroky hotov√©
    const checkInterval = setInterval(() => {
      if (steps.dataLoaded && steps.paginationRestored && 
          steps.expandedRestored && steps.scrollRestored) {
        
        // Zaƒçni fade-out
        setSplashVisible(false);
        
        // Po dokonƒçen√≠ fade animace (200ms) oznaƒç inicializaci jako hotovou
        setTimeout(() => {
          setInitializationComplete(true);
        }, 200);
        
        clearInterval(checkInterval);
      }
    }, 100);
    
    // Cleanup
    return () => clearInterval(checkInterval);
  }, []); // Spust√≠ se jen jednou p≈ôi mount

  // Debug log - upozornƒõn√≠ na aktivn√≠ filtry bez v√Ωsledk≈Ø
  useEffect(() => {
    const hasActiveFilters = 
      globalFilter || 
      (Array.isArray(statusFilter) && statusFilter.length > 0) ||
      userFilter || 
      dateFromFilter || 
      dateToFilter || 
      amountFromFilter || 
      amountToFilter ||
      Object.values(columnFilters).some(val => val);
    
    if (hasActiveFilters && orders.length > 0 && filteredData.length === 0) {
      // Filter warning detection - filters are hiding all orders
    }
  }, [filteredData.length, orders.length, globalFilter, statusFilter, userFilter, dateFromFilter, dateToFilter, amountFromFilter, amountToFilter, columnFilters]);

  // Funkce pro rozbalen√≠/sbalen√≠ v≈°ech ≈ô√°dk≈Ø
  const expandAllRows = () => {
    table.toggleAllRowsExpanded(true);
  };

  const collapseAllRows = () => {
    table.toggleAllRowsExpanded(false);
  };

  const toggleAllRows = () => {
    const anyExpanded = table.getIsSomeRowsExpanded();
    table.toggleAllRowsExpanded(!anyExpanded);
  };

  // Table instance
  const table = useReactTable({
    data: filteredData,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getExpandedRowModel: getExpandedRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    enableExpanding: true,
    getRowCanExpand: () => true,
    manualPagination: false,
    state: {
      sorting,
      expanded, // ‚Üê P≈ôid√°no pro kontrolu rozbalen√Ωch ≈ô√°dk≈Ø
      pagination: {
        pageSize: pageSize,
        pageIndex: currentPageIndex,
      },
    },
    onSortingChange: setSorting,
    onExpandedChange: setExpanded, // ‚Üê Handler pro zmƒõny
  });

  // üîß OPTIMALIZACE: Odstranƒõn redundantn√≠ useEffect pro table.setPageSize/Index
  // React Table automaticky reaguje na zmƒõny v state.pagination prop
  // Manu√°ln√≠ nastavov√°n√≠ zp≈Øsobovalo potenci√°ln√≠ race conditions
  
  // üîß OPTIMALIZACE: sorting useEffect byl p≈ôesunut do batch localStorage updatu v√Ω≈°e

  // Reset to first page if current page is out of bounds
  useEffect(() => {
    if (table && table.getPageCount() > 0) {
      const maxPageIndex = table.getPageCount() - 1;
      if (currentPageIndex > maxPageIndex) {
        setCurrentPageIndex(0);
        setUserStorage('orders25List_pageIndex', 0);
        table.setPageIndex(0);
      }
    }
  }, [table, currentPageIndex, filteredData]);

  // Pagination navigation helpers
  const goToFirstPage = useCallback(() => {
    saveCurrentScrollState(); // Ulo≈æ p≈ôed zmƒõnou
    table.setPageIndex(0);
    setCurrentPageIndex(0);
    setUserStorage('orders25List_pageIndex', 0);
  }, [table, saveCurrentScrollState]);

  const goToPreviousPage = useCallback(() => {
    saveCurrentScrollState(); // Ulo≈æ p≈ôed zmƒõnou
    const newIndex = Math.max(0, table.getState().pagination.pageIndex - 1);
    table.previousPage();
    setCurrentPageIndex(newIndex);
    setUserStorage('orders25List_pageIndex', newIndex);
  }, [table, saveCurrentScrollState]);

  const goToNextPage = useCallback(() => {
    saveCurrentScrollState(); // Ulo≈æ p≈ôed zmƒõnou
    const newIndex = Math.min(table.getPageCount() - 1, table.getState().pagination.pageIndex + 1);
    table.nextPage();
    setCurrentPageIndex(newIndex);
    setUserStorage('orders25List_pageIndex', newIndex);
  }, [table, saveCurrentScrollState]);

  const goToLastPage = useCallback(() => {
    saveCurrentScrollState(); // Ulo≈æ p≈ôed zmƒõnou
    const lastIndex = table.getPageCount() - 1;
    table.setPageIndex(lastIndex);
    setCurrentPageIndex(lastIndex);
    setUserStorage('orders25List_pageIndex', lastIndex);
  }, [table, saveCurrentScrollState]);

  // Permission checks
  const canEdit = (order) => {
    if (!hasPermission) return false;
    
    // Koncepty m≈Ø≈æe editovat ka≈æd√Ω kdo m√° z√°kladn√≠ pr√°va (je to jeho vlastn√≠ koncept)
    if (order.isDraft || order.je_koncept) {
      return hasPermission('ORDER_EDIT_ALL') || hasPermission('ORDER_EDIT_OWN');
    }
    
    // U≈æivatel√© s ORDER_*_ALL opr√°vnƒõn√≠mi mohou editovat v≈°echny objedn√°vky
    if (hasPermission('ORDER_EDIT_ALL') || hasPermission('ORDER_MANAGE')) {
      // hasPermission('ORDER_OLD') - ORDER_OLD je pouze pro star√Ω syst√©m (Orders.js)
      return true;
    }
    
    // U≈æivatel√© s ORDER_*_OWN opr√°vnƒõn√≠mi (vƒçetnƒõ ORDER_2025) mohou editovat pouze sv√© objedn√°vky
    // üî• FIX: Pou≈æij currentUserId (number) m√≠sto user_id (string)
    if (hasPermission('ORDER_EDIT_OWN') || hasPermission('ORDER_2025')) {
      return order.objednatel_id === currentUserId || 
             order.uzivatel_id === currentUserId ||
             order.garant_uzivatel_id === currentUserId || 
             order.schvalovatel_id === currentUserId;
    }
    
    return false;
  };

  const canDelete = (order) => {
    if (!hasPermission) return false;
    
    // Zak√°zat smaz√°n√≠ pro objedn√°vky v editaci/konceptu
    if (order.isDraft || order.je_koncept || order.hasLocalDraftChanges) return false;
    
    // Importovan√© objedn√°vky (ARCHIVOVANO) mohou mazat pouze ORDER_MANAGE a ORDER_DELETE_ALL
    if (order.stav_objednavky === 'ARCHIVOVANO') {
      return hasPermission('ORDER_MANAGE') || hasPermission('ORDER_DELETE_ALL');
    }
    
    // U≈æivatel√© s ORDER_*_ALL opr√°vnƒõn√≠mi mohou mazat v≈°echny objedn√°vky
    if (hasPermission('ORDER_DELETE_ALL') || hasPermission('ORDER_MANAGE')) {
      // hasPermission('ORDER_OLD') - ORDER_OLD je pouze pro star√Ω syst√©m (Orders.js)
      return true;
    }
    
    // U≈æivatel√© s ORDER_*_OWN opr√°vnƒõn√≠mi (vƒçetnƒõ ORDER_2025) mohou mazat pouze sv√© objedn√°vky
    // üî• FIX: Pou≈æij currentUserId (number) m√≠sto user_id (string)
    if (hasPermission('ORDER_DELETE_OWN') || hasPermission('ORDER_2025')) {
      return order.objednatel_id === currentUserId || 
             order.uzivatel_id === currentUserId ||
             order.garant_uzivatel_id === currentUserId || 
             order.schvalovatel_id === currentUserId;
    }
    
    return false;
  };

  const canExportDocument = (order) => {
    // Povol√≠me generov√°n√≠ DOCX pouze pro pokroƒçil√© stavy (NE pro SCHVALENA)
    if (!order) return false;
    
    // Z√≠skej aktu√°ln√≠ stav objedn√°vky (posledn√≠ ze workflow)
    let aktualniStav = null;
    let nazevStavu = '';
    
    try {
      // Priorita 1: stav_workflow_kod (pole stav≈Ø - vz√≠t posledn√≠)
      if (order.stav_workflow_kod) {
        const workflowStates = JSON.parse(order.stav_workflow_kod);
        if (Array.isArray(workflowStates) && workflowStates.length > 0) {
          const lastState = workflowStates[workflowStates.length - 1];
          if (typeof lastState === 'object' && (lastState.kod_stavu || lastState.nazev_stavu)) {
            aktualniStav = lastState.kod_stavu || lastState.nazev_stavu;
            nazevStavu = lastState.nazev_stavu || lastState.kod_stavu || '';
          } else if (typeof lastState === 'string') {
            aktualniStav = lastState;
            nazevStavu = lastState;
          }
        }
      }
      
      // Priorita 2: fallback na jin√© pole stavu
      if (!aktualniStav) {
        aktualniStav = order.stav_id_num || order.stav_id || order.stav || order.nazev_stavu;
        nazevStavu = order.nazev_stavu || order.status_name || aktualniStav;
      }
    } catch (error) {
      // console.warn('Chyba p≈ôi parsing stavu objedn√°vky pro DOCX:', error);
      aktualniStav = order.stav_id_num || order.stav_id || order.nazev_stavu;
      nazevStavu = order.nazev_stavu || '';
    }
    
    if (!aktualniStav) return false;
    
    // Normalizuj stav pro kontrolu
    const stav = normalizeStav(aktualniStav);
    const stavCode = stav?.code;
    
    // Povol√≠me POUZE pro pokroƒçil√© stavy (ODSTRANIT SCHVALENA!)
    const allowedStates = ['POTVRZENA', 'DOKONCENA', 'ODESLANA', 'CEKA_SE'];
    
    // Tak√© povol√≠me pro stavy obsahuj√≠c√≠ "rozpracovan", "dodavatel" apod.
    const stavText = nazevStavu.toLowerCase();
    const isRozpracovana = stavText.includes('rozpracovan');
    const isDodavatel = stavText.includes('dodavatel');
    
    const canGenerate = allowedStates.includes(stavCode) || isRozpracovana || isDodavatel;
    
    return canGenerate;
  };

  // Handlers
  const handleExportDocument = async (order) => {
    try {
      // Otev≈ôi modal pro v√Ωbƒõr DOCX ≈°ablony
      setDocxModalOrder(order);
      setDocxModalOpen(true);
    } catch (error) {
      showToast?.('Chyba p≈ôi otev√≠r√°n√≠ DOCX gener√°toru', { type: 'error' });
    }
  };
  const handleEdit = async (order) => {
    
    // Pokud je objedn√°vka ji≈æ v konceptu, rovnou p≈ôesmƒõruj
    if (order.isDraft || order.hasLocalDraftChanges) {
      navigate(`/order-form-25?edit=${order.id || order.objednavka_id}&archivovano=1`);
      return;
    }

    // üîí KONTROLA ZAMƒåEN√ç - PRVN√ç VƒöC P≈òED NAƒå√çT√ÅN√çM DAT!
    // Naƒçti aktu√°ln√≠ data z DB pro kontrolu lock_info (BE vrac√≠ lock_info v orders25/by-id)
    const orderIdToCheck = order.id || order.objednavka_id;
    
    try {
      // ‚úÖ V2 API
      const dbOrder = await getOrderV2(
        orderIdToCheck,
        token,
        username,
        true // enriched = true
      );

      if (!dbOrder) {
        showToast('Nepoda≈ôilo se naƒç√≠st objedn√°vku z datab√°ze', { type: 'error' });
        return;
      }

      // üîí NOV√Å LOGIKA podle BE dokumentace (24.10.2025):
      // BE vrac√≠ locked: true POUZE kdy≈æ je zamƒçen√° JIN√ùM u≈æivatelem
      // locked: false znamen√° "m≈Ø≈æu editovat" (voln√° NEBO moje zamƒçen√°)
      
      // console.log('üîç Lock info check:', {
      //   orderId: orderIdToCheck,
      //   locked: dbOrder.lock_info?.locked,
      //   lock_status: dbOrder.lock_info?.lock_status,
      //   is_owned_by_me: dbOrder.lock_info?.is_owned_by_me,
      //   locked_by: dbOrder.lock_info?.locked_by_user_fullname
      // });

      // ‚úÖ JEDNODUCH√Å kontrola podle nov√© BE s√©mantiky
      if (dbOrder.lock_info?.locked === true) {
        // ‚ùå Zamƒçen√° JIN√ùM u≈æivatelem - ZOBRAZ dialog a BLOKUJ editaci
        const lockInfo = dbOrder.lock_info;
        const lockedByUserName = lockInfo.locked_by_user_fullname || `u≈æivatel #${lockInfo.locked_by_user_id}`;
        
        // Zjisti, zda m√° u≈æivatel pr√°vo na force unlock (SUPERADMIN nebo ADMINISTRATOR)
        const canForceUnlock = userDetail?.roles?.some(role => 
          role.kod_role === 'SUPERADMIN' || role.kod_role === 'ADMINISTRATOR'
        );
        
        // console.log(`üîí Objedn√°vka ${orderIdToCheck} je zamƒçen√° u≈æivatelem ${lockedByUserName}`);
        
        // Ulo≈æ info o zamƒçen√≠ vƒçetnƒõ kontaktn√≠ch √∫daj≈Ø (24.10.2025 - roz≈°√≠≈ôen√Ω lock_info)
        setLockedOrderInfo({
          lockedByUserName,
          lockedByUserEmail: lockInfo.locked_by_user_email || null,
          lockedByUserTelefon: lockInfo.locked_by_user_telefon || null,
          lockedAt: lockInfo.locked_at || null,
          lockAgeMinutes: lockInfo.lock_age_minutes || null,
          canForceUnlock,
          orderId: orderIdToCheck,
          userRoleName: userDetail?.roles?.find(r => r.kod_role === 'SUPERADMIN' || r.kod_role === 'ADMINISTRATOR')?.nazev_role || 'administr√°tor'
        });
        setOrderToEdit(order); // Ulo≈æ pro pozdƒõj≈°√≠ pou≈æit√≠
        setShowLockedOrderDialog(true);
        return; // ZASTAVIT - ƒçek√°me na rozhodnut√≠ u≈æivatele
      } else {
        // ‚úÖ locked === false znamen√° m≈Ø≈æu editovat (voln√° NEBO moje zamƒçen√°)
        if (dbOrder.lock_info?.is_owned_by_me === true) {
          // console.log(`‚úÖ Objedn√°vka ${orderIdToCheck} je ji≈æ zamƒçen√° aktu√°ln√≠m u≈æivatelem - pokraƒçuji v editaci`);
        } else if (dbOrder.lock_info?.lock_status === 'unlocked' || dbOrder.lock_info?.lock_status === 'expired') {
          // console.log(`‚úÖ Objedn√°vka ${orderIdToCheck} je voln√° - pokraƒçuji v editaci`);
        }
      }
    } catch (error) {
      showToast('Chyba p≈ôi kontrole dostupnosti objedn√°vky', { type: 'error' });
      return;
    }

    // Zkontroluj, jestli existuje validn√≠ koncept (pro rozhodnut√≠ o confirm dialogu) - ORDER25 SERVICE
    const hasDraft = order25DraftStorageService.hasDraft(user_id);
    
    let shouldShowConfirmDialog = false;
    let draftDataToStore = null;
    
    if (hasDraft) {
      try {
        const draftData = await order25DraftStorageService.loadDraft(user_id);
        // OPRAVA: Kontrola pro NOV√â koncepty (isValidConcept) NEBO editovan√© DB objedn√°vky (hasDraftChanges)
        const hasNewConcept = isValidConcept(draftData);
        const hasDbChanges = hasDraftChanges(draftData);
        shouldShowConfirmDialog = hasNewConcept || hasDbChanges;
        
        if (shouldShowConfirmDialog) {
          draftDataToStore = draftData; // Ulo≈æ pro zobrazen√≠ v modalu
        }

      } catch (error) {
        shouldShowConfirmDialog = false;
      }
    }

    // KONTROLA: Pokud je objedn√°vka ARCHIVOVANO a z√°rove≈à existuje koncept
    if (order.stav_objednavky === 'ARCHIVOVANO' && shouldShowConfirmDialog) {
      setCurrentDraftData(draftDataToStore);
      setOrderToEdit(order);
      setShowArchivedWithDraftWarningModal(true); // Zobraz KOMBINOVAN√ù modal
      return;
    }

    // KONTROLA: Pokud je objedn√°vka ARCHIVOVANO (bez konceptu)
    if (order.stav_objednavky === 'ARCHIVOVANO') {
      setOrderToEdit(order);
      setShowArchivedWarningModal(true);
      return;
    }

    // Rozhodni, zda zobrazit confirm dialog nebo editovat rovnou
    if (shouldShowConfirmDialog) {
      setCurrentDraftData(draftDataToStore); // Ulo≈æ draft data
      setOrderToEdit(order); // Nastav pro modal
      setShowEditConfirmModal(true);
    } else {
      handleEditConfirm(order); // P≈ôedej order p≈ô√≠mo
    }
  };

  // Handler pro KOMBINOVAN√ù modal (archivov√°no + draft)
  const handleArchivedWithDraftConfirm = () => {
    // 1. Zav≈ôi kombinovan√Ω modal
    setShowArchivedWithDraftWarningModal(false);
    
    // 2. Sma≈æ existuj√≠c√≠ draft z localStorage - ORDER25 SERVICE
    order25DraftStorageService.deleteDraft(user_id);
    
    // 3. Edituj archivovanou objedn√°vku (s parametrem archivovano=1)
    if (orderToEdit) {
      handleEditConfirm(orderToEdit);
    }
  };

  const handleArchivedWarningConfirm = async () => {
    // Zav≈ôi archivovan√Ω warning modal
    setShowArchivedWarningModal(false);
    
    // Pokraƒçuj v norm√°ln√≠m edit flow - zkontroluj, jestli existuje koncept - ORDER25 SERVICE
    const hasDraft = order25DraftStorageService.hasDraft(user_id);
    
    let shouldShowConfirmDialog = false;
    if (hasDraft) {
      try {
        const draftData = await order25DraftStorageService.loadDraft(user_id);
        const hasNewConcept = isValidConcept(draftData);
        const hasDbChanges = hasDraftChanges(draftData);
        shouldShowConfirmDialog = hasNewConcept || hasDbChanges;
      } catch (error) {
        shouldShowConfirmDialog = false;
      }
    }

    // Rozhodni, zda zobrazit confirm dialog nebo editovat rovnou
    if (shouldShowConfirmDialog) {
      setShowEditConfirmModal(true);
    } else {
      handleEditConfirm(orderToEdit);
    }
  };

  const handleEditConfirm = async (orderParam = null) => {
    
    // Pokud orderParam je SyntheticEvent (z onClick), ignoruj ho a pou≈æij orderToEdit ze state
    let orderToUse = orderToEdit;
    if (orderParam && orderParam.id && !orderParam.type) { // orderParam je skuteƒçn√° objedn√°vka, ne event
      orderToUse = orderParam;
    }

    if (!orderToUse) {
      return;
    }

    try {
      const orderIdToLoad = orderToUse.id || orderToUse.objednavka_id;

      if (!orderIdToLoad) {
        showToast('Chyba: Nelze urƒçit ID objedn√°vky', { type: 'error' });
        return;
      }

      // Naƒçti aktu√°ln√≠ data z DB - ‚úÖ V2 API
      const dbOrder = await getOrderV2(
        orderIdToLoad,
        token,
        username,
        true // enriched = true
      );

      if (!dbOrder) {
        showToast('Nepoda≈ôilo se naƒç√≠st objedn√°vku z datab√°ze', { type: 'error' });
        return;
      }

      // üîí Zamkni objedn√°vku pro editaci (kontrola zamƒçen√≠ u≈æ byla provedena v handleEdit)
      try {
        const lockResult = await lockOrder25({ token, username, orderId: orderIdToLoad });
        if (lockResult.success) {
          // console.log(`‚úÖ Objedn√°vka ${orderIdToLoad} byla zamknuta pro editaci`);
        }
      } catch (lockError) {
        // console.error('‚ö†Ô∏è Varov√°n√≠ p≈ôi zamyk√°n√≠ objedn√°vky:', lockError);
        // Pokraƒçuj i kdy≈æ sel≈æe zamyk√°n√≠ (kontrola u≈æ byla provedena v handleEdit)
      }

      // Naƒçti detaily objednatele z DB p≈ôes jeho ID
      let objednatelDetails = null;
      
      if (dbOrder.objednatel_id) {
        try {
          const { getUserDetailApi2 } = await import('../services/api2auth');
          objednatelDetails = await getUserDetailApi2(username, token, dbOrder.objednatel_id);
        } catch (error) {
          // D≈ÆLE≈ΩIT√â: Pokud nelze naƒç√≠st detaily, zkus√≠me naj√≠t u≈æivatele v existuj√≠c√≠m seznamu
          objednatelDetails = null;
        }
      } else {
      }
        
      let cleanedKeys = [];
      
      // Vyƒçisti v≈°echny star√© koncepty
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key && (
          key.startsWith('orderForm25_') || 
          key.startsWith('order25_draft_') ||  // ORDER25 STANDARD
          key.startsWith('order25-draft-') ||  // LEGACY cleanup
          key.startsWith('orderForm25-') ||
          key.includes('draft') && key.includes('order')
        )) {
          localStorage.removeItem(key);
          cleanedKeys.push(key);
        }
      }

      // Vytvo≈ô koncept s ƒçerstv√Ωmi daty z DB  
      const orderId = dbOrder.id;
      
      // Vytvo≈ô spr√°vn√© √∫daje objednatele z naƒçten√Ωch detail≈Ø z DB
      let objednatelData = {
        objednatel_id: dbOrder.objednatel_id || user_id,
        jmeno: 'Neuvedeno',
        email: '',
        telefon: ''
      };

      if (objednatelDetails) {
        // Pou≈æij detaily naƒçten√© z DB podle objednatel_id
        const jmeno = `${objednatelDetails.titul_pred ? objednatelDetails.titul_pred + ' ' : ''}${objednatelDetails.jmeno || ''} ${objednatelDetails.prijmeni || ''}${objednatelDetails.titul_za ? ', ' + objednatelDetails.titul_za : ''}`.replace(/\s+/g, ' ').trim();
        objednatelData = {
          objednatel_id: dbOrder.objednatel_id,
          jmeno: jmeno || 'Neuvedeno',
          email: objednatelDetails.email || '',
          telefon: objednatelDetails.telefon || ''
        };
      } else if (dbOrder.objednatel_id) {
      }

      // Anal√Ωza workflow stavu a nastaven√≠ checkbox≈Ø
      const hasWorkflowState = (workflowCode, state) => {
        if (!workflowCode) return false;
        try {
          if (typeof workflowCode === 'string' && workflowCode.startsWith('[')) {
            const states = JSON.parse(workflowCode);
            return Array.isArray(states) && states.includes(state);
          }
          return String(workflowCode).includes(state);
        } catch {
          return String(workflowCode).includes(state);
        }
      };

      // Anal√Ωza workflow stavu pro spr√°vn√© nastaven√≠ UI
      const isSchvalena = hasWorkflowState(dbOrder.stav_workflow_kod, 'SCHVALENA');
      const isOdeslana = hasWorkflowState(dbOrder.stav_workflow_kod, 'ODESLANA'); 
      const isZrusena = hasWorkflowState(dbOrder.stav_workflow_kod, 'ZRUSENA');
      const isZamitnuta = hasWorkflowState(dbOrder.stav_workflow_kod, 'ZAMITNUTA');
      const isCekaSe = hasWorkflowState(dbOrder.stav_workflow_kod, 'CEKA_SE');

      // Odvozen√≠ UI stav≈Ø ze workflow
      let stavSchvaleni = dbOrder.stav_schvaleni || ''; // Zachovat p≈Øvodn√≠ nebo pr√°zdn√Ω
      if (isSchvalena) {
        stavSchvaleni = 'schvaleno';
      } else if (isZamitnuta) {
        stavSchvaleni = 'neschvaleno';
      } else if (isCekaSe) {
        stavSchvaleni = 'ceka_se';
      }

      // DEBUG: Kontrola ev_cislo p≈ôed vytvo≈ôen√≠m draftu
      const finalEvCislo = dbOrder.cislo_objednavky || dbOrder.ev_cislo || 'CHYBA: Chyb√≠ ƒç√≠slo v DB!';

      const freshDraft = {
        formData: {
          ...dbOrder, // ƒåerstv√° data z DB
          uzivatel_id: user_id, // Souƒçasn√Ω u≈æivatel co edituje
          // KRITICK√â: Spr√°vn√© mapov√°n√≠ ƒç√≠sla objedn√°vky pro frontend
          ev_cislo: dbOrder.cislo_objednavky || dbOrder.ev_cislo || 'CHYBA: Chyb√≠ ƒç√≠slo v DB!',
          // Spr√°vn√© nastaven√≠ UI prvk≈Ø podle workflow stavu
          stav_schvaleni: stavSchvaleni, // Odvozeno ze workflow
          stav_odeslano: isOdeslana,     // Checkbox "Odesl√°no"
          stav_stornovano: isZrusena,    // Checkbox "Stornov√°no"
          // EXPLICITNƒö p≈ôepsat √∫daje objednatele z API (aby nep≈ôepsaly star≈°√≠ data z dbOrder)
          ...(objednatelData && {
            objednatel_id: objednatelData.objednatel_id,
            jmeno: objednatelData.jmeno,
            email: objednatelData.email,
            telefon: objednatelData.telefon
          })
        },
        timestamp: Date.now(),
        version: '1.4',
        isConceptSaved: true,
        isChanged: false, // Synchronn√≠ s DB
        isOrderSavedToDB: true,
        savedOrderId: orderId,
        attachments: []
      };
      
      // Ulo≈æ koncept s DB daty
      setUserStorage('order25-draft', freshDraft);

      // Ode≈°li broadcast ud√°lost pro aktualizaci menubar
      broadcastDraftUpdated(user_id, freshDraft);
      
      // üîÑ EXPLICITN√ç REFRESH MENUBAR: Ozn√°m MenuBaru o naƒçten√≠ objedn√°vky pro editaci
      window.dispatchEvent(new CustomEvent('orderDraftChange', { 
        detail: { 
          hasDraft: true,
          isEditMode: true, // EDITACE objedn√°vky (ne koncept)
          orderId: orderId,
          orderNumber: finalEvCislo,
          isLoading: false
        } 
      }));

      // Pou≈æij React Router s edit parametrem pro naƒçten√≠ objedn√°vky do editace
      navigate(`/order-form-25?edit=${orderId}&archivovano=1`);
        
    } catch (error) {
      showToast('Chyba p≈ôi naƒç√≠t√°n√≠ objedn√°vky z datab√°ze', { type: 'error' });
    }
    
    setShowEditConfirmModal(false);
    setOrderToEdit(null);
  };

  const handleEditCancel = () => {
    // Jen zav≈ôi modal bez maz√°n√≠ koncept≈Ø
    // U≈æivatel z≈Østane na seznamu objedn√°vek a zachovaj√≠ se jeho rozepsan√© zmƒõny
    setShowEditConfirmModal(false);
    setOrderToEdit(null);
    setCurrentDraftData(null);
  };

  const handleView = (order) => {
    // TODO: Implement preview

  };

  // Handler pro vytvo≈ôen√≠ nov√© objedn√°vky z action menu
  const handleCreateNewOrder = async () => {
    // Zkontroluj, jestli existuje aktivn√≠ koncept nebo editace
    const hasDraft = order25DraftStorageService.hasDraft(user_id);
    
    let shouldShowConfirmDialog = false;
    let draftDataToStore = null;
    
    if (hasDraft) {
      try {
        const draftData = await order25DraftStorageService.loadDraft(user_id);
        const hasNewConcept = isValidConcept(draftData);
        const hasDbChanges = hasDraftChanges(draftData);
        shouldShowConfirmDialog = hasNewConcept || hasDbChanges;
        
        if (shouldShowConfirmDialog) {
          draftDataToStore = draftData; // Ulo≈æ pro zobrazen√≠ v modalu
        }
      } catch (error) {
        shouldShowConfirmDialog = false;
      }
    }

    // Pokud existuje aktivn√≠ koncept/editace, zobraz confirm dialog
    if (shouldShowConfirmDialog) {
      setCurrentDraftData(draftDataToStore); // Ulo≈æ draft data pro modal
      setOrderToEdit(null); // ≈Ω√°dn√° konkr√©tn√≠ objedn√°vka - vytv√°≈ô√≠me novou
      setShowEditConfirmModal(true);
    } else {
      // Rovnou p≈ôesmƒõruj na pr√°zdn√Ω formul√°≈ô
      navigate('/order-form-25');
    }
  };

  // Handler pro potvrzen√≠ vytvo≈ôen√≠ nov√© objedn√°vky (po confirm dialogu)
  const handleCreateNewOrderConfirm = () => {
    // Sma≈æ existuj√≠c√≠ draft
    order25DraftStorageService.deleteDraft(user_id);
    
    // Zav≈ôi modal a vyƒçisti state
    setShowEditConfirmModal(false);
    setOrderToEdit(null);
    setCurrentDraftData(null);
    
    // P≈ôesmƒõruj na pr√°zdn√Ω formul√°≈ô
    navigate('/order-form-25');
  };

  // =============================================================================
  // üîí HANDLER PRO ZAMƒåENOU OBJEDN√ÅVKU
  // =============================================================================
  
  const handleLockedOrderForceUnlock = async () => {
    if (!lockedOrderInfo) return;
    
    try {
      // 1. N√°silnƒõ odemkni
      const unlockResult = await unlockOrder25({ 
        token, 
        username, 
        orderId: lockedOrderInfo.orderId, 
        force: true 
      });
      
      if (unlockResult.success && unlockResult.unlock_type === 'forced') {
        showToast(
          `Objedn√°vka byla n√°silnƒõ odemƒçena u≈æivateli ${lockedOrderInfo.lockedByUserName} a p≈ôevzata`,
          { type: 'success' }
        );
        
        // 2. Zamkni pro aktu√°ln√≠ho u≈æivatele
        const lockResult = await lockOrder25({ token, username, orderId: lockedOrderInfo.orderId });
        if (lockResult.success) {
          showToast(
            `Objedn√°vka byla zamknuta pro editaci`,
            { type: 'success' }
          );
          // console.log(`‚úÖ Objedn√°vka ${lockedOrderInfo.orderId} byla n√°silnƒõ odemƒçena a p≈ôevzata`);
        }
        
        // Zav≈ôi dialog
        setShowLockedOrderDialog(false);
        setLockedOrderInfo(null);
        
        // Pokraƒçuj v editaci - znovu zavolej handleEditConfirm
        if (orderToEdit) {
          handleEditConfirm(orderToEdit);
        }
      }
    } catch (forceError) {
      showToast(
        `Nepoda≈ôilo se n√°silnƒõ odemknout objedn√°vku: ${forceError.message}`,
        { type: 'error' }
      );
      setShowLockedOrderDialog(false);
      setLockedOrderInfo(null);
      setOrderToEdit(null);
    }
  };
  
  const handleLockedOrderCancel = () => {
    // Zav≈ôi dialog a vyƒçisti state
    setShowLockedOrderDialog(false);
    setLockedOrderInfo(null);
    setShowEditConfirmModal(false);
    setOrderToEdit(null);
  };

  // =============================================================================
  // FORCE UNLOCK WARNING DIALOG HANDLERS
  // =============================================================================

  const handleForceUnlockWarningClose = () => {
    setShowForceUnlockWarning(false);
    setForceUnlockWarningData(null);
  };

  const handleForceUnlockWarningAcknowledge = async () => {
    // Oznaƒç notifikaci jako p≈ôeƒçtenou (pokud m√°me ID)
    if (forceUnlockWarningData?.notificationId) {
      try {
        // TODO: Vol√°n√≠ API pro oznaƒçen√≠ notifikace jako p≈ôeƒçten√©
        // await markNotificationAsRead(forceUnlockWarningData.notificationId);
        // console.log('üìñ [FORCE UNLOCK] Notifikace oznaƒçena jako p≈ôeƒçten√°:', forceUnlockWarningData.notificationId);
      } catch (error) {
      }
    }

    // Refresh dat (objedn√°vka byla p≈ôevzata jin√Ωm u≈æivatelem)
    await loadData(true);
    
    // Zav≈ôi dialog
    handleForceUnlockWarningClose();
    
    showToast?.('Seznam objedn√°vek byl aktualizov√°n', { type: 'info' });
  };

  // =============================================================================
  // KONTEXTOV√â MENU HANDLERS
  // =============================================================================
  
  const handleContextMenu = (e, order, cellData = null) => {
    e.preventDefault(); // Zabra≈à v√Ωchoz√≠mu kontextov√©mu menu
    
    // Zjisti na jakou bu≈àku se kliklo
    let selectedData = null;
    const target = e.target;
    
    if (cellData) {
      selectedData = cellData;
    } else if (target && target.closest('td')) {
      // Najdi text obsahu bu≈àky
      const cellElement = target.closest('td');
      selectedData = {
        value: cellElement.textContent?.trim() || '',
        element: cellElement
      };
    }
    
    setContextMenu({
      x: e.clientX,
      y: e.clientY,
      order: order,
      selectedData: selectedData
    });
  };
  
  const handleCloseContextMenu = () => {
    setContextMenu(null);
  };
  
  const handleAddToTodo = (order) => {
    // TODO: Implementace - p≈ôid√° objedn√°vku do TODO panelu
    showToast(`üéØ Funkce "P≈ôidat do TODO" bude brzy implementov√°na pro objedn√°vku ${order.cislo_objednavky}`, { type: 'info' });
  };
  
  const handleAddAlarm = (order) => {
    // TODO: Implementace - otev≈ôe dialog pro nastaven√≠ alarmu
    showToast(`‚è∞ Funkce "P≈ôidat alarm" bude brzy implementov√°na pro objedn√°vku ${order.cislo_objednavky}`, { type: 'info' });
  };
  
  const handleContextMenuEdit = (order) => {
    // Pou≈æije existuj√≠c√≠ handleEdit
    handleEdit(order);
  };
  
  const handleContextMenuDelete = (order) => {
    // Pou≈æije existuj√≠c√≠ handleDelete
    handleDelete(order);
  };
  
  const handleGenerateDocx = (order) => {
    // Zavol√° stejnou funkci jako action button
    handleExportDocument(order);
  };
  
  const handleDocxModalClose = () => {
    setDocxModalOpen(false);
    setDocxModalOrder(null);
  };

  const handleDelete = (order) => {
    setOrderToDelete(order);
    setShowDeleteConfirmModal(true);
  };

  const handleDeleteConfirm = async (deleteType) => {
    if (!orderToDelete) return;

    try {
      // ‚ùå NEPOU≈Ω√çVAT setLoading(true) - chceme smazat bez splash screenu
      const { softDeleteOrder25, hardDeleteOrder25 } = await import('../services/api25orders');
      
      // ‚úÖ Okam≈æitƒõ odebrat ze seznamu (optimistick√° aktualizace)
      setOrders(prevOrders => prevOrders.filter(order => order.id !== orderToDelete.id));
      
      if (deleteType === 'hard') {
        // √öpln√© smaz√°n√≠ vƒçetnƒõ polo≈æek a p≈ô√≠loh (na pozad√≠)
        hardDeleteOrder25({ 
          token, 
          username: user?.username, 
          orderId: orderToDelete.id 
        }).then(() => {
          showToast && showToast('Objedn√°vka byla √∫plnƒõ smaz√°na vƒçetnƒõ v≈°ech p≈ô√≠loh.', { type: 'success' });
        }).catch(error => {
          // Rollback - vr√°tit objedn√°vku zpƒõt
          setOrders(prevOrders => [...prevOrders, orderToDelete].sort((a, b) => b.id - a.id));
          const errorMsg = translateErrorMessageShort(error.message);
          showToast && showToast(`Chyba p≈ôi maz√°n√≠: ${errorMsg}`, { type: 'error' });
        });
      } else {
        // Pouze oznaƒçit jako neaktivn√≠ (na pozad√≠)
        softDeleteOrder25({ 
          token, 
          username: user?.username, 
          orderId: orderToDelete.id 
        }).then(() => {
          showToast && showToast('Objedn√°vka byla oznaƒçena jako neaktivn√≠.', { type: 'success' });
        }).catch(error => {
          // Rollback - vr√°tit objedn√°vku zpƒõt
          setOrders(prevOrders => [...prevOrders, orderToDelete].sort((a, b) => b.id - a.id));
          const errorMsg = translateErrorMessageShort(error.message);
          showToast && showToast(`Chyba p≈ôi maz√°n√≠: ${errorMsg}`, { type: 'error' });
        });
      }
      
      // ‚ùå NEREFRESHOVAT loadData() - u≈æ jsme odebrali lok√°lnƒõ

      // Ode≈°li broadcast ud√°lost pro aktualizaci menubar (objedn√°vka byla smaz√°na)
      broadcastDraftDeleted(user_id);
      
    } catch (error) {
      const errorMsg = translateErrorMessageShort(error.message);
      showToast && showToast(`Chyba p≈ôi maz√°n√≠ objedn√°vky: ${errorMsg}`, { type: 'error' });
    } finally {
      // ‚ùå NEPOU≈Ω√çVAT setLoading(false)
      setShowDeleteConfirmModal(false);
      setOrderToDelete(null);
    }
  };

  const handleDeleteCancel = () => {
    setShowDeleteConfirmModal(false);
    setOrderToDelete(null);
  };

  const performDelete = async (order, orderName) => {
    try {
      setLoading(true);
      const { softDeleteOrder25 } = await import('../services/api25orders');
      
      await softDeleteOrder25({ 
        token, 
        username: user?.username, 
        orderId: order.id 
      });
      
      // Refresh data after successful deletion
      await loadData();
      
      // Show success notification
      if (typeof window !== 'undefined') {
        const event = new CustomEvent('showNotification', { 
          detail: { 
            message: `Objedn√°vka "${orderName}" byla oznaƒçena jako neaktivn√≠.`,
            type: 'success'
          }
        });
        window.dispatchEvent(event);
      }
      
    } catch (error) {
      // Error deleting order
      
      // Show error notification
      if (typeof window !== 'undefined') {
        const event = new CustomEvent('showNotification', { 
          detail: { 
            message: `Chyba p≈ôi maz√°n√≠ objedn√°vky: ${error.message}`,
            type: 'error'
          }
        });
        window.dispatchEvent(event);
      }
    } finally {
      setLoading(false);
    }
  };

  const handleNewOrder = () => {
    navigate('/order-form-25');
  };

  const handleRefresh = async () => {
    // üöÄ FORCE REFRESH: Vyma≈æ cache a naƒçti z DB
    if (!token || !user?.username) return;
    
    // console.log('üîÑ [REFRESH] Manu√°ln√≠ refresh - vymaz√°n√≠ cache a reload z DB');
    
    try {
      // 1. Vyma≈æ celou cache pro aktu√°ln√≠ho u≈æivatele (v≈°echny filtry)
      ordersCacheService.invalidate(user_id);
      // console.log('‚úÖ [REFRESH] Cache vymaz√°na pro user_id:', user_id);
      
      // 2. Vyma≈æ i scroll state
      ordersCacheService.clearScrollState(user_id);
      // console.log('‚úÖ [REFRESH] Scroll state vymaz√°n');
      
      // 3. Force reload z datab√°ze
      setLoading(true);
      await loadData(true); // forceRefresh=true
      // console.log('‚úÖ [REFRESH] Data naƒçtena z DB');
      
      // 4. Trigger manu√°ln√≠ refresh notifikac√≠
      if (bgTasksContext?.triggerNotificationsRefresh) {
        bgTasksContext.triggerNotificationsRefresh();
      }
      
      // 5. Zobraz toast potvrzen√≠
      showToast && showToast('Seznam objedn√°vek byl obnoven z datab√°ze', { type: 'success' });
      
    } catch (error) {
      showToast && showToast('Chyba p≈ôi obnoven√≠ dat: ' + error.message, { type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  const handleYearChange = (newYear) => {
    setSelectedYear(newYear);
    setUserStorage('orders25List_selectedYear', newYear);
    setIsYearDropdownOpen(false);
  };

  // Toggle year dropdown
  const toggleYearDropdown = () => {
    setIsYearDropdownOpen(prev => !prev);
  };

  // Close year dropdown when clicking outside
  useEffect(() => {
    if (!isYearDropdownOpen) return;
    
    const handleClickOutside = (event) => {
      if (yearSelectRef.current && !yearSelectRef.current.contains(event.target)) {
        setIsYearDropdownOpen(false);
      }
    };
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isYearDropdownOpen]);

  const handleMonthChange = (newMonth) => {
    // Pokud u≈æivatel vybere "show-more", jen zobraz dal≈°√≠ mo≈ænosti a nechej dropdown otev≈ôen√Ω
    if (newMonth === 'show-more') {
      setShowExpandedMonths(true);
      // Nech√°me dropdown otev≈ôen√Ω - nemƒõn√≠me isMonthDropdownOpen
      return;
    }
    
    // Pokud u≈æivatel vybere "show-less", sbal zpƒõt na z√°kladn√≠ mo≈ænosti
    if (newMonth === 'show-less') {
      setShowExpandedMonths(false);
      // Nech√°me dropdown otev≈ôen√Ω - nemƒõn√≠me isMonthDropdownOpen
      return;
    }
    
    // Pro skuteƒçn√Ω v√Ωbƒõr mƒõs√≠ce - zav≈ôeme dropdown
    setSelectedMonth(newMonth);
    setUserStorage('orders25List_selectedMonth', newMonth);
    setIsMonthDropdownOpen(false);
  };

  // Handle show archived checkbox change
  const handleShowArchivedChange = (e) => {
    // Pokud je to ud√°lost z checkboxu, pou≈æij checked
    // Pokud je to kliknut√≠ na div, toggleni hodnotu
    const newValue = e?.target?.type === 'checkbox' ? e.target.checked : !showArchived;
    
    setShowArchived(newValue);
    setUserStorage('orders25List_showArchived', newValue);
  };

  // Toggle month dropdown
  const toggleMonthDropdown = () => {
    setIsMonthDropdownOpen(prev => !prev);
  };

  // Close dropdown when clicking outside
  useEffect(() => {
    if (!isMonthDropdownOpen) return;
    
    const handleClickOutside = (event) => {
      if (monthSelectRef.current && !monthSelectRef.current.contains(event.target)) {
        setIsMonthDropdownOpen(false);
      }
    };
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isMonthDropdownOpen]);

  // Helper funkce pro z√≠sk√°n√≠ mƒõs√≠ƒçn√≠ho filtru pro API
  const getMonthFilterForAPI = () => {
    const currentMonth = new Date().getMonth() + 1; // 1-12
    
    switch (selectedMonth) {
      case 'all':
        return undefined; // ≈Ω√°dn√Ω filtr mƒõs√≠ce
      
      case 'last-month':
        // Posledn√≠ mƒõs√≠c od souƒçasnosti
        return currentMonth.toString();
      
      case 'last-quarter':
        // Posledn√≠ 3 mƒõs√≠ce (kvart√°l)
        const quarterStart = Math.max(1, currentMonth - 2);
        return `${quarterStart}-${currentMonth}`;
      
      case 'last-half':
        // Posledn√≠ch 6 mƒõs√≠c≈Ø
        const halfStart = Math.max(1, currentMonth - 5);
        return `${halfStart}-${currentMonth}`;
      
      default:
        // Jinak vr√°t√≠me p≈ô√≠mo hodnotu (nap≈ô. "1-3", "10-12")
        return selectedMonth;
    }
  };

  // Helper funkce pro z√≠sk√°n√≠ n√°zvu mƒõs√≠ce
  const getMonthLabel = (value) => {
    const labels = {
      'all': 'V≈°echny mƒõs√≠ce',
      'last-month': 'Posledn√≠ mƒõs√≠c',
      'last-quarter': 'Posledn√≠ kvart√°l',
      'last-half': 'Posledn√≠ p≈Ølrok',
      '1': 'Leden',
      '2': '√önor',
      '3': 'B≈ôezen',
      '4': 'Duben',
      '5': 'Kvƒõten',
      '6': 'ƒåerven',
      '7': 'ƒåervenec',
      '8': 'Srpen',
      '9': 'Z√°≈ô√≠',
      '10': '≈ò√≠jen',
      '11': 'Listopad',
      '12': 'Prosinec',
      '1-3': 'Q1 (Leden-B≈ôezen)',
      '4-6': 'Q2 (Duben-ƒåerven)',
      '7-9': 'Q3 (ƒåervenec-Z√°≈ô√≠)',
      '10-12': 'Q4 (≈ò√≠jen-Prosinec)'
    };
    return labels[value] || value;
  };

  // Helper funkce pro z√≠sk√°n√≠ seznamu rok≈Ø
  const getYearsList = () => {
    const currentYear = new Date().getFullYear();
    const startYear = 2016;
    const years = []; // Zaƒçni bez "V≈°echny roky"
    
    // Generuj roky od 2016 do souƒçasnosti (vzestupnƒõ)
    for (let year = startYear; year <= currentYear; year++) {
      years.push(year);
    }
    
    // Pokud je souƒçasn√Ω rok men≈°√≠ ne≈æ 2016, p≈ôidej ho
    if (currentYear < startYear) {
      years.push(currentYear);
    }
    
    // Vra≈• roky v sestupn√©m po≈ôad√≠ (nejnovƒõj≈°√≠ naho≈ôe), "V≈°echny" a≈æ na konci
    const numericYears = years.sort((a, b) => b - a);
    return [...numericYears, 'all']; // "V≈°echny roky" na konci
  };

  const handleExport = () => {
    const exportData = filteredData.map(order => {
      const enriched = order._enriched || {};
      
      // Z√≠sk√°me zp≈Øsob financov√°n√≠ z JSON struktury  
      const financovaniKodyMap = {
        'SMLOUVA': 'Smlouva',
        'INDIVIDUALNI_SCHVALENI': 'Individu√°ln√≠ schv√°len√≠', 
        'POKLADNA': 'Pokladna',
        'LP': 'Limitovan√Ω p≈ô√≠slib',
        'POJISTNA_UDALOST': 'Pojistn√° ud√°lost'
      };
      
      let zpusobFinancovani = '';
      let finData = null;
      
      if (order.financovani_parsed && typeof order.financovani_parsed === 'object') {
        finData = order.financovani_parsed;
      } else if (order.financovani && typeof order.financovani === 'string') {
        try {
          finData = JSON.parse(order.financovani);
        } catch {
          zpusobFinancovani = order.financovani;
        }
      } else if (order.zpusob_financovani) {
        if (typeof order.zpusob_financovani === 'string') {
          try {
            finData = JSON.parse(order.zpusob_financovani);
          } catch {
            zpusobFinancovani = order.zpusob_financovani;
          }
        } else if (typeof order.zpusob_financovani === 'object') {
          finData = order.zpusob_financovani;
        }
      }
      
      // Pokud m√°me parsovan√° data, extrahujeme nazev_stavu nebo mapujeme kod_stavu
      if (finData && typeof finData === 'object') {
        zpusobFinancovani = finData.nazev_stavu || 
                           (finData.kod_stavu ? financovaniKodyMap[finData.kod_stavu] : null) ||
                           finData.nazev || finData.label || '';
      }

      return {
        'ID': order.id || '',
        'ƒå√≠slo objedn√°vky': order.cislo_objednavky || '',
        'P≈ôedmƒõt': order.predmet || '',
        'Objednatel': enriched.uzivatel 
          ? `${enriched.uzivatel.jmeno} ${enriched.uzivatel.prijmeni}`
          : getUserDisplayName(order.uzivatel_id),
        'Stav': enriched.stav_workflow 
          ? enriched.stav_workflow.nazev_stavu || enriched.stav_workflow.nazev
          : getOrderDisplayStatus(order),
        'Datum objedn√°vky': getOrderDate(order) ? formatDateOnly(getOrderDate(order)) : '',
        'Vytvo≈ôeno': order.dt_vytvoreni ? formatDateOnly(order.dt_vytvoreni) : '',
        'Zp≈Øsob financov√°n√≠': zpusobFinancovani,
        'Max. cena s DPH': parseFloat(order.max_cena_s_dph) || 0,
        'Poƒçet polo≈æek': order.polozky?.length || 0,
        'Celkov√° cena polo≈æek': parseFloat(order.total_price) || 0,
        'Dodavatel': order.dodavatel_nazev || '',
        'St≈ôedisko': enriched.strediska && enriched.strediska.length > 0 
          ? enriched.strediska.map(s => `${s.kod} - ${s.nazev}`).join('; ')
          : order.strediska_kod || ''
      };
    });
    
    exportCsv(exportData, 'objednavky_2025');
  };

  // Pomocn√© funkce pro form√°tov√°n√≠ ƒç√°stek s oddƒõlovaƒçi tis√≠c≈Ø
  const formatNumberWithSpaces = (value) => {
    if (!value) return '';
    // Odstra≈à v≈°echny mezery a neƒç√≠seln√© znaky kromƒõ ƒç√°rky a teƒçky
    const numericValue = value.toString().replace(/[^\d]/g, '');
    if (!numericValue) return '';
    
    // P≈ôidej mezery jako oddƒõlovaƒçe tis√≠c≈Ø
    return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  };

  const parseFormattedNumber = (value) => {
    if (!value) return '';
    // Odstra≈à mezery a vra≈• ƒçistƒõ ƒç√≠selnou hodnotu
    return value.toString().replace(/\s/g, '');
  };

  const handleAmountFromChange = (e) => {
    const rawValue = e.target.value;
    const numericValue = parseFormattedNumber(rawValue);
    setAmountFromFilter(numericValue);
  };

  const handleAmountToChange = (e) => {
    const rawValue = e.target.value;
    const numericValue = parseFormattedNumber(rawValue);
    setAmountToFilter(numericValue);
  };

  const clearFilters = () => {
    // Vyma≈æ v≈°echny filtry ve stavu (pole = pr√°zdn√© pole)
    setGlobalFilter('');
    setStatusFilter([]);
    setUserFilter('');
    setSelectedObjednatel([]);
    setSelectedGarant([]);
    setSelectedSchvalovatel([]);
    setDateFromFilter('');
    setDateToFilter('');
    setAmountFromFilter('');
    setAmountToFilter('');
    setActiveStatusFilter(null); // Zru≈° tak√© aktivn√≠ filter z dla≈ædic
    setColumnFilters({
      dt_objednavky: '',
      cislo_objednavky: '',
      predmet: '',
      objednatel: '',
      stav_objednavky: '',
      max_cena_s_dph: '',
      garant: '',
      schvalovatel: ''
    });

    // Vyma≈æ v≈°echny filtry z localStorage
    const sid = user_id || 'anon';
    localStorage.removeItem('orders25List_globalFilter');
    localStorage.removeItem('orders25List_statusFilter');
    localStorage.removeItem('orders25List_userFilter');
    localStorage.removeItem('orders25List_selectedObjednatel');
    localStorage.removeItem('orders25List_selectedGarant');
    localStorage.removeItem('orders25List_selectedSchvalovatel');
    localStorage.removeItem(`orders25_dateFrom_${sid}`);
    localStorage.removeItem(`orders25_dateTo_${sid}`);
    localStorage.removeItem('orders25List_amountFrom');
    localStorage.removeItem('orders25List_amountTo');
    localStorage.removeItem('orders25List_activeStatusFilter');
  };

  // Handlery pro jednoduch√© filtrov√°n√≠ p≈ôes globalFilter
  const handleStatusFilterChange = (e) => {
    const options = e.target.options;
    const selected = [];
    for (let i = 0; i < options.length; i++) {
      if (options[i].selected && options[i].value) {
        selected.push(options[i].value);
      }
    }
    setStatusFilter(selected);
  };

  const handleObjednatelChange = (e) => {
    const options = e.target.options;
    const selected = [];
    for (let i = 0; i < options.length; i++) {
      if (options[i].selected && options[i].value) {
        selected.push(options[i].value);
      }
    }

    setSelectedObjednatel(selected);
    
    // Pro column filter ulo≈æ vybran√° ID oddƒõlen√° |
    if (selected.length === 0) {
      setColumnFilters(prev => ({ ...prev, objednatel: '' }));
    } else {
      // Ulo≈æ ID oddƒõlen√° |
      const filterValue = selected.join('|');

      setColumnFilters(prev => ({ ...prev, objednatel: filterValue }));
    }
  };

  const handleGarantChange = (e) => {
    const options = e.target.options;
    const selected = [];
    for (let i = 0; i < options.length; i++) {
      if (options[i].selected && options[i].value) {
        selected.push(options[i].value);
      }
    }

    setSelectedGarant(selected);
    
    // Pro column filter ulo≈æ vybran√° ID oddƒõlen√° |
    if (selected.length === 0) {
      setColumnFilters(prev => ({ ...prev, garant: '' }));
    } else {
      // Ulo≈æ ID oddƒõlen√° |
      const filterValue = selected.join('|');

      setColumnFilters(prev => ({ ...prev, garant: filterValue }));
    }
  };

  const handleSchvalovatelChange = (e) => {
    const options = e.target.options;
    const selected = [];
    for (let i = 0; i < options.length; i++) {
      if (options[i].selected && options[i].value) {
        selected.push(options[i].value);
      }
    }

    setSelectedSchvalovatel(selected);
    
    // Pro column filter ulo≈æ vybran√° ID oddƒõlen√° |
    if (selected.length === 0) {
      setColumnFilters(prev => ({ ...prev, schvalovatel: '' }));
    } else {
      // Ulo≈æ ID oddƒõlen√° | (ID jsou ji≈æ normalizovan√° na 'id' v sortedApprovers)
      const filterValue = selected.join('|');

      setColumnFilters(prev => ({ ...prev, schvalovatel: filterValue }));
    }
  };

  const handlePrikazceChange = (e) => {
    const options = e.target.options;
    const selected = [];
    for (let i = 0; i < options.length; i++) {
      if (options[i].selected && options[i].value) {
        selected.push(options[i].value);
      }
    }

    setSelectedPrikazce(selected);
    
    // Pro column filter ulo≈æ vybran√° ID oddƒõlen√° |
    if (selected.length === 0) {
      setColumnFilters(prev => ({ ...prev, prikazce: '' }));
    } else {
      // Ulo≈æ ID oddƒõlen√° |
      const filterValue = selected.join('|');

      setColumnFilters(prev => ({ ...prev, prikazce: filterValue }));
    }
  };

  const clearColumnFilters = () => {
    // Vyma≈æ vyhled√°vac√≠ pole v hlaviƒçce tabulky
    setColumnFilters({
      dt_objednavky: '',
      cislo_objednavky: '',
      predmet: '',
      objednatel: '',
      stav_objednavky: '',
      max_cena_s_dph: '',
      garant: '',
      prikazce: '',
      schvalovatel: ''
    });
    
    // Reset select≈Ø v roz≈°√≠≈ôen√©m filtru - pr√°zdn√° pole m√≠sto pr√°zdn√Ωch string≈Ø
    setSelectedObjednatel([]);
    setSelectedGarant([]);
    setSelectedPrikazce([]);
    setSelectedSchvalovatel([]);
    setStatusFilter([]);
    
    // Vyma≈æ tak√© z localStorage
    localStorage.removeItem('orders25List_selectedObjednatel');
    localStorage.removeItem('orders25List_selectedGarant');
    localStorage.removeItem('orders25List_selectedPrikazce');
    localStorage.removeItem('orders25List_selectedSchvalovatel');
    localStorage.removeItem('orders25List_statusFilter');
  };

  // Funkce pro vymaz√°n√≠ jednotliv√Ωch filtr≈Ø
  const clearStatusFilter = () => {
    setStatusFilter([]);
    localStorage.removeItem('orders25List_statusFilter');
  };

  const clearObjednatelFilter = () => {
    setSelectedObjednatel([]);
    setColumnFilters(prev => ({ ...prev, objednatel: '' }));
    localStorage.removeItem('orders25List_selectedObjednatel');
  };

  const clearGarantFilter = () => {
    setSelectedGarant([]);
    setColumnFilters(prev => ({ ...prev, garant: '' }));
    localStorage.removeItem('orders25List_selectedGarant');
  };

  const clearSchvalovatelFilter = () => {
    setSelectedSchvalovatel([]);
    setColumnFilters(prev => ({ ...prev, schvalovatel: '' }));
    localStorage.removeItem('orders25List_selectedSchvalovatel');
  };

  const clearPrikazceFilter = () => {
    setSelectedPrikazce([]);
    setColumnFilters(prev => ({ ...prev, prikazce: '' }));
    localStorage.removeItem('orders25List_selectedPrikazce');
  };

  const clearDateFilter = () => {
    setDateFromFilter('');
    setDateToFilter('');
    const sid = user_id || 'anon';
    localStorage.removeItem(`orders25_dateFrom_${sid}`);
    localStorage.removeItem(`orders25_dateTo_${sid}`);
  };

  const clearPriceFilter = () => {
    setAmountFromFilter('');
    setAmountToFilter('');
  };

  const toggleRowStriping = () => {
    const newStriping = !showRowStriping;
    setShowRowStriping(newStriping);
    setUserStorage('orders25List_showRowStriping', newStriping);
  };

  const toggleRowHighlighting = () => {
    const newHighlighting = !showRowHighlighting;
    setShowRowHighlighting(newHighlighting);
    setUserStorage('orders25List_showRowHighlighting', newHighlighting);
  };

  // Handler pro klik na dashboard karty - filtrov√°n√≠ podle stavu
  const handleStatusFilterClick = (status) => {
    if (activeStatusFilter === status) {
      // Opakovan√Ω klik - zru≈° filtr
      setActiveStatusFilter(null);
      setStatusFilter([]); // Zru≈° tak√© glob√°ln√≠ status filtr (jako pr√°zdn√© pole)
    } else {
      // Nov√Ω filtr - mapuj n√°zev z dashboardu na syst√©mov√Ω k√≥d
      const systemStatusMapping = {
        'odeslana_ke_schvaleni': 'ODESLANA_KE_SCHVALENI',
        'schvalena': 'SCHVALENA', 
        'rozpracovana': 'ROZPRACOVANA',
        'odeslana': 'ODESLANA',
        'potvrzena': 'POTVRZENA',
        'uverejnena': 'UVEREJNENA',
        'dokoncena': 'DOKONCENA',
        'nova': 'NOVA',
        'zamitnuta': 'ZAMITNUTA',
        'zrusena': 'ZRUSENA',
        'ceka_potvrzeni': 'CEKA_POTVRZENI',
        'ceka_se': 'CEKA_SE',
        'smazana': 'SMAZANA',
        'archivovano': 'ARCHIVOVANO'
      };
      
      setActiveStatusFilter(status);
      const systemStatus = systemStatusMapping[status] || status.toUpperCase();
      setStatusFilter([systemStatus]); // Nastav jako pole s jedn√≠m prvkem
    }
  };

  const handleToggleDebug = () => {
    const newShowDebug = !showDebug;
    setShowDebug(newShowDebug);
    setUserStorage('orders25List_showDebug', newShowDebug);
  };

  const handleToggleDashboard = () => {
    const newShowDashboard = !showDashboard;
    setShowDashboard(newShowDashboard);
    setUserStorage('orders25List_showDashboard', newShowDashboard);
  };

  const handleToggleFilters = () => {
    const newShowFilters = !showFilters;
    setShowFilters(newShowFilters);
    setUserStorage('orders25List_showFilters', newShowFilters);
  };

  const handleHideFilters = () => {
    setShowFiltersPanel(false);
    setUserStorage('orders25List_showFiltersPanel', false);
  };

  const handleShowFilters = () => {
    setShowFiltersPanel(true);
    setUserStorage('orders25List_showFiltersPanel', true);
  };

  const handleToggleDashboardView = () => {
    const newDashboardCompact = !dashboardCompact;
    setDashboardCompact(newDashboardCompact);
    setUserStorage('orders25List_dashboardCompact', newDashboardCompact);
  };

  const handleToggleOnlyMyOrders = () => {
    const newShowOnlyMyOrders = !showOnlyMyOrders;
    setShowOnlyMyOrders(newShowOnlyMyOrders);
    setUserStorage('orders25List_showOnlyMyOrders', newShowOnlyMyOrders);
  };

  // Sta≈æen√≠ p≈ô√≠lohy
  const handleDownloadAttachment = async (attachment) => {
    // Funkce pro detekci, zda m√° soubor p≈ô√≠ponu vhodnou pro n√°hled v prohl√≠≈æeƒçi
    const canPreviewInBrowser = (filename) => {
      if (!filename) return false;
      const ext = filename.split('.').pop()?.toLowerCase();
      const previewableExtensions = [
        'pdf', 'jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp',
        'txt', 'html', 'htm', 'xml', 'json', 'csv',
        'mp4', 'webm', 'ogg', 'mp3', 'wav'
      ];
      return previewableExtensions.includes(ext);
    };

    const fileName = attachment.originalni_nazev_souboru || attachment.nazev || `priloha_${attachment.id}`;
    const shouldPreview = canPreviewInBrowser(fileName);

    // Pro archivovan√© objedn√°vky (importovan√© ze star√© DB) - st√°hnout p≈ô√≠mo ze star√© URL
    if (attachment.typ_prilohy === 'IMPORT' && attachment.originalni_nazev_souboru) {
      const oldAttachmentsUrl = process.env.REACT_APP_OLD_ATTACHMENTS_URL || 'https://eeo.zachranka.cz/prilohy/';
      const oldUrl = `${oldAttachmentsUrl}${attachment.originalni_nazev_souboru}`;
      
      // Otev≈ô√≠t v nov√©m oknƒõ/tabu pro n√°hled nebo sta≈æen√≠
      window.open(oldUrl, '_blank');
      showToast?.(`P≈ô√≠loha "${attachment.originalni_nazev_souboru}" se ${shouldPreview ? 'otev√≠r√°' : 'stahuje'} ze star√©ho syst√©mu`, { type: 'info' });
      return;
    }
    
    // Standardn√≠ sta≈æen√≠ pro bƒõ≈æn√© p≈ô√≠lohy
    if (!attachment.id || !token || !username) {
      showToast?.('Nelze st√°hnout p≈ô√≠lohu - chyb√≠ pot≈ôebn√© √∫daje', { type: 'error' });
      return;
    }

    try {
      showToast?.(`${shouldPreview ? 'Otev√≠r√°m' : 'Stahuji'} p≈ô√≠lohu...`, { type: 'info' });

      const blob = await downloadAttachment25({
        token,
        username,
        attachment_id: attachment.id
      });

      if (shouldPreview) {
        // Otev≈ô√≠t v nov√©m oknƒõ pro n√°hled
        const blobUrl = window.URL.createObjectURL(blob);
        window.open(blobUrl, '_blank');
        showToast?.(`‚úÖ P≈ô√≠loha "${fileName}" byla otev≈ôena v nov√©m oknƒõ`, { type: 'success' });
      } else {
        // St√°hnout jako soubor
        createDownloadLink25(blob, fileName);
        showToast?.(`‚úÖ P≈ô√≠loha "${fileName}" byla sta≈æena`, { type: 'success' });
      }

    } catch (error) {
      // Error downloading attachment
      const errorMsg = translateErrorMessageShort(error.response?.data?.message || error.message || 'Nezn√°m√° chyba');
      showToast?.(`‚ùå Chyba p≈ôi stahov√°n√≠: ${errorMsg}`, { type: 'error' });
    }
  };

  // State pro detaily osob
  const [personDetailsCache, setPersonDetailsCache] = useState({});
  
  // Funkce pro naƒçten√≠ detailu osoby - zavol√° se p≈ôi rozbalen√≠ ≈ô√°dku
  const loadPersonDetail = async (orderId, personKey, personId) => {
    const cacheKey = `${orderId}_${personKey}`;
    
    // Pokud u≈æ m√°me v cache, nemus√≠me naƒç√≠tat znovu
    if (personDetailsCache[cacheKey]) {
      return;
    }
    
    try {
      const { getUserDetailApi2 } = await import('../services/api2auth');
      const userDetail = await getUserDetailApi2(username, token, personId);
      
      if (userDetail) {
        const details = {
          jmeno: userDetail.jmeno,
          prijmeni: userDetail.prijmeni,
          titul_pred: userDetail.titul_pred,
          titul_za: userDetail.titul_za,
          email: userDetail.email
        };
        
        // Ulo≈æ do cache
        setPersonDetailsCache(prev => ({
          ...prev,
          [cacheKey]: details
        }));
      }
    } catch (error) {
      // Error loading person detail
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìã RENDER EXPANDED ROW - V2 API OPTIMIZED
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const renderExpandedContent = (order) => {
    // ‚úÖ Order V2 API vrac√≠ enriched data p≈ô√≠mo v order objektu:
    // - polozky[] (s cena_bez_dph, cena_s_dph, dph_castka, dph_procento)
    // - polozky_count, polozky_celkova_cena_s_dph, polozky_celkova_cena_bez_dph
    // - faktury[] (s fa_castka_bez_dph, fa_castka_s_dph, fa_dph_castka, prilohy[])
    // - faktury_count, faktury_celkova_castka_s_dph
    // - prilohy[] (objedn√°vky), prilohy_count
    // - dodavatel_detail{}, user_detail{}, organizace_detail{}
    // - strediska[], strediska_kod[]
    // - financovani{typ, lp_kody[], ...}
    
    // P≈ôiprav√≠me data
    const polozky = order.polozky || [];
    const hasPolozky = Array.isArray(polozky) && polozky.length > 0;
    
    const faktury = order.faktury || [];
    const hasFaktury = Array.isArray(faktury) && faktury.length > 0;
    
    const prilohy = order.prilohy || [];
    const hasPrilohy = Array.isArray(prilohy) && prilohy.length > 0;
    
    const dodatecneDokumenty = order.dodatecne_dokumenty || [];
    const hasDodatecneDokumenty = Array.isArray(dodatecneDokumenty) && dodatecneDokumenty.length > 0;
    
    const strediska = order.strediska_kod || order.strediska || [];
    const hasStrediska = Array.isArray(strediska) && strediska.length > 0;

    return (
      <ExpandedContent $order={order} $showRowHighlighting={showRowHighlighting}>
        <ExpandedGrid>
          
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 1Ô∏è‚É£ Z√ÅKLADN√ç √öDAJE OBJEDN√ÅVKY */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
            <InfoCardTitle>
              <FontAwesomeIcon icon={faInfoCircle} />
              Z√°kladn√≠ √∫daje objedn√°vky
            </InfoCardTitle>
            
            {/* ƒå√≠slo objedn√°vky - cel√° ≈°√≠≈ôka, nezalomiteln√©, s ID jako horn√≠ index */}
            <div style={{ 
              width: '100%', 
              marginBottom: '0.75rem',
              padding: '0.5rem',
              background: 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)',
              borderRadius: '6px',
              border: '1px solid #e2e8f0'
            }}>
              <div style={{ 
                fontSize: '0.75em', 
                color: '#64748b', 
                marginBottom: '0.25rem',
                fontWeight: 500,
                textTransform: 'uppercase',
                letterSpacing: '0.05em'
              }}>
                ƒå√≠slo objedn√°vky
              </div>
              <div style={{ 
                fontFamily: 'monospace', 
                fontWeight: 700, 
                fontSize: '1.15em',
                color: '#0f172a',
                whiteSpace: 'nowrap',
                overflow: 'hidden',
                textOverflow: 'ellipsis'
              }}>
                {order.cislo_objednavky || '---'}
                <sup style={{ 
                  fontSize: '0.6em', 
                  color: '#94a3b8',
                  fontWeight: 400,
                  marginLeft: '0.3em'
                }}>
                  #{order.id || '?'}
                </sup>
              </div>
            </div>
            
            <InfoRow>
              <InfoLabel>P≈ôedmƒõt:</InfoLabel>
              <InfoValue style={{ fontWeight: 500 }}>
                {order.predmet || '---'}
              </InfoValue>
            </InfoRow>
            
            <InfoRow>
              <InfoLabel>Stav:</InfoLabel>
              <InfoValue>
                <span style={{ 
                  fontWeight: 600,
                  color: (() => {
                    const statusCode = order.stav_objednavky 
                      ? mapUserStatusToSystemCode(order.stav_objednavky)
                      : 'NOVA';
                    const statusColors = getStatusColor(statusCode);
                    return statusColors?.dark || STATUS_COLORS.NOVA.dark;
                  })()
                }}>
                  {order.stav_objednavky || getOrderDisplayStatus(order) || '---'}
                </span>
              </InfoValue>
            </InfoRow>
            
            <InfoRow>
              <InfoLabel>Datum vytvo≈ôen√≠:</InfoLabel>
              <InfoValue>
                {order.dt_vytvoreni ? prettyDate(order.dt_vytvoreni) : '---'}
              </InfoValue>
            </InfoRow>
            
            <InfoRow>
              <InfoLabel>Datum objedn√°vky:</InfoLabel>
              <InfoValue style={{ fontWeight: 500 }}>
                {order.dt_objednavky ? prettyDate(order.dt_objednavky) : '---'}
              </InfoValue>
            </InfoRow>
            
            {order.dt_schvaleni && (
              <InfoRow>
                <InfoLabel>Datum schv√°len√≠:</InfoLabel>
                <InfoValue style={{ color: '#059669', fontWeight: 500 }}>
                  {prettyDate(order.dt_schvaleni)}
                </InfoValue>
              </InfoRow>
            )}
            
            {order.dt_predpokladany_termin_dodani && (
              <InfoRow>
                <InfoLabel>Term√≠n dod√°n√≠:</InfoLabel>
                <InfoValue style={{ fontWeight: 500 }}>
                  {formatDateOnly(order.dt_predpokladany_termin_dodani)}
                </InfoValue>
              </InfoRow>
            )}
            
            {order.dt_potvrzeni_vecne_spravnosti && (
              <InfoRow>
                <InfoLabel>Potvrzen√≠ vƒõc. spr√°vnosti:</InfoLabel>
                <InfoValue style={{ color: '#0891b2', fontWeight: 500 }}>
                  {prettyDate(order.dt_potvrzeni_vecne_spravnosti)}
                </InfoValue>
              </InfoRow>
            )}
            
            {order.dt_dokonceni && (
              <InfoRow>
                <InfoLabel>Datum dokonƒçen√≠:</InfoLabel>
                <InfoValue style={{ color: '#16a34a', fontWeight: 600 }}>
                  {prettyDate(order.dt_dokonceni)}
                </InfoValue>
              </InfoRow>
            )}
            
            <InfoRow>
              <InfoLabel>Posledn√≠ zmƒõna:</InfoLabel>
              <InfoValue style={{ fontSize: '0.9em', color: '#6b7280' }}>
                {order.dt_posledni_zmeny ? prettyDate(order.dt_posledni_zmeny) : '---'}
              </InfoValue>
            </InfoRow>
          </InfoCard>

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 2Ô∏è‚É£ FINANƒåN√ç √öDAJE - KOMPLETN√ç S V2 API */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
            <InfoCardTitle>
              <FontAwesomeIcon icon={faMoneyBillWave} />
              Finanƒçn√≠ √∫daje
            </InfoCardTitle>
            
            {/* üéØ FINANƒåN√ç ZDROJ - NA ZAƒå√ÅTKU */}
            {/* St≈ôediska */}
            {hasStrediska && (
              <InfoRow>
                <InfoLabel>St≈ôediska:</InfoLabel>
                <InfoValue style={{ fontSize: '0.9em', fontWeight: 500 }}>
                  {Array.isArray(strediska) ? (
                    strediska.map((s, idx) => {
                      if (typeof s === 'string') return s;
                      return s.kod || s.nazev || `St≈ôedisko ${idx + 1}`;
                    }).join(', ')
                  ) : (
                    String(strediska || '---')
                  )}
                </InfoValue>
              </InfoRow>
            )}
            
            {/* Zp≈Øsob financov√°n√≠ */}
            {order.financovani && (
              <>
                <InfoRow>
                  <InfoLabel>Zp≈Øsob financov√°n√≠:</InfoLabel>
                  <InfoValue style={{ fontWeight: 600, color: '#7c3aed' }}>
                    {order.financovani.typ_nazev || order.financovani.typ || '---'}
                  </InfoValue>
                </InfoRow>
                
                {/* LP k√≥dy s detaily */}
                {order.financovani?.lp_nazvy && Array.isArray(order.financovani.lp_nazvy) && order.financovani.lp_nazvy.length > 0 && (
                  <div style={{ marginTop: '0.5rem', marginBottom: '0.5rem' }}>
                    <InfoLabel style={{ marginBottom: '0.5rem', display: 'block' }}>LP √∫ƒçty:</InfoLabel>
                    {order.financovani.lp_nazvy.map((lp, index) => (
                      <div key={index} style={{ 
                        fontSize: '0.9em',
                        marginBottom: '0.25rem',
                        paddingLeft: '0.5rem',
                        borderLeft: '3px solid #7c3aed',
                        backgroundColor: '#faf5ff',
                        padding: '0.4rem 0.5rem',
                        borderRadius: '0 4px 4px 0'
                      }}>
                        <span style={{ fontWeight: 600, color: '#7c3aed' }}>
                          {lp.cislo_lp || lp.kod || '---'}
                        </span>
                        {lp.nazev && (
                          <span style={{ color: '#64748b', marginLeft: '0.5rem' }}>
                            ‚Äì {lp.nazev}
                          </span>
                        )}
                      </div>
                    ))}
                  </div>
                )}
                
                {/* Fallback na star√© LP k√≥dy (pokud nejsou lp_nazvy) */}
                {(!order.financovani?.lp_nazvy || order.financovani.lp_nazvy.length === 0) && 
                 order.financovani?.lp_kody && Array.isArray(order.financovani.lp_kody) && order.financovani.lp_kody.length > 0 && (
                  <InfoRow>
                    <InfoLabel>LP k√≥dy:</InfoLabel>
                    <InfoValue style={{ fontSize: '0.9em' }}>
                      {order.financovani.lp_kody.join(', ')}
                    </InfoValue>
                  </InfoRow>
                )}
                
                {/* Dal≈°√≠ dynamick√° data financov√°n√≠ */}
                {order.financovani && typeof order.financovani === 'object' && (() => {
                  const fin = order.financovani;
                  const skipKeys = ['typ', 'typ_nazev', 'nazev', 'lp_kody', 'lp_nazvy', 'kod_stavu', 'nazev_stavu', 'label'];
                  const extraKeys = Object.keys(fin).filter(key => !skipKeys.includes(key) && fin[key] != null);
                  
                  return extraKeys.map(key => {
                    const value = fin[key];
                    const displayValue = Array.isArray(value) ? value.join(', ') : String(value);
                    const labelMap = {
                      'cislo': 'ƒå√≠slo',
                      'poznamka': 'Pozn√°mka',
                      'cislo_smlouvy': 'ƒå√≠slo smlouvy',
                      'smlouva_cislo': 'ƒå√≠slo smlouvy',
                      'poznamka_smlouvy': 'Pozn√°mka smlouvy',
                      'cislo_pojistne_udalosti': 'ƒå√≠slo pojistn√© ud√°losti',
                      'poznamka_pojistne_udalosti': 'Pozn√°mka',
                      'individualni_schvaleni': 'ƒå√≠slo schv√°len√≠',
                      'individualni_poznamka': 'Pozn√°mka',
                      'individualni_schvaleni_poznamka': 'Pozn√°mka',
                      'pokladna_cislo': 'ƒå√≠slo',
                      'pokladna_poznamka': 'Pozn√°mka',
                      'castka': 'ƒå√°stka',
                      'datum': 'Datum',
                      'schvalovaci_osoba': 'Schvaluj√≠c√≠ osoba'
                    };
                    const label = labelMap[key] || key.replace(/_/g, ' ').replace(/^\w/, c => c.toUpperCase());
                    
                    return (
                      <InfoRow key={key}>
                        <InfoLabel>{label}:</InfoLabel>
                        <InfoValue style={{ fontSize: '0.9em' }}>
                          {displayValue}
                        </InfoValue>
                      </InfoRow>
                    );
                  });
                })()}
              </>
            )}
            
            {/* Oddƒõlovac√≠ ƒç√°ra */}
            {(hasStrediska || order.financovani) && (
              <div style={{ 
                borderBottom: '2px solid #e2e8f0', 
                margin: '0.75rem 0',
                boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
              }} />
            )}
            
            {/* Max cena s DPH */}
            <InfoRow>
              <InfoLabel>Max. cena s DPH:</InfoLabel>
              <InfoValue style={{ fontWeight: 700, color: '#059669', fontSize: '1.1em', whiteSpace: 'nowrap' }}>
                {order.max_cena_s_dph ? <>{parseFloat(order.max_cena_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç</> : '---'}
              </InfoValue>
            </InfoRow>
            
            {/* üÜï CELKOV√Å CENA OBJEDN√ÅVKY (bez DPH) */}
            {order.celkova_cena_bez_dph && parseFloat(order.celkova_cena_bez_dph) > 0 && (
              <InfoRow>
                <InfoLabel>Celkov√° cena bez DPH:</InfoLabel>
                <InfoValue style={{ fontWeight: 600, whiteSpace: 'nowrap' }}>
                  {parseFloat(order.celkova_cena_bez_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                </InfoValue>
              </InfoRow>
            )}
            
            {/* üÜï CELKOV√Å CENA OBJEDN√ÅVKY (s DPH) */}
            {order.celkova_cena_s_dph && parseFloat(order.celkova_cena_s_dph) > 0 && (
              <InfoRow>
                <InfoLabel>Celkov√° cena s DPH:</InfoLabel>
                <InfoValue style={{ fontWeight: 700, color: '#0ea5e9', fontSize: '1.05em', whiteSpace: 'nowrap' }}>
                  {parseFloat(order.celkova_cena_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                </InfoValue>
              </InfoRow>
            )}
            
            {/* üÜï CELKOV√Å DPH ƒå√ÅSTKA */}
            {order.celkova_dph && parseFloat(order.celkova_dph) > 0 && (
              <InfoRow>
                <InfoLabel>Celkov√° DPH:</InfoLabel>
                <InfoValue style={{ fontWeight: 600, color: '#f59e0b', whiteSpace: 'nowrap' }}>
                  {parseFloat(order.celkova_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                </InfoValue>
              </InfoRow>
            )}
            
            {/* Mƒõna */}
            {order.mena && order.mena !== 'CZK' && (
              <InfoRow>
                <InfoLabel>Mƒõna:</InfoLabel>
                <InfoValue style={{ fontWeight: 600 }}>
                  {order.mena}
                </InfoValue>
              </InfoRow>
            )}
            
            {/* POLO≈ΩKY - CENY */}
            {hasPolozky && (
              <>
                {/* Poƒçet polo≈æek */}
                <InfoRow>
                  <InfoLabel>Poƒçet polo≈æek:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500 }}>
                    {order.polozky_count || polozky.length} ks
                  </InfoValue>
                </InfoRow>
                
                {/* Polo≈æky - cena s DPH */}
                {order.polozky_celkova_cena_s_dph && parseFloat(order.polozky_celkova_cena_s_dph) > 0 && (
                  <InfoRow>
                    <InfoLabel>Polo≈æky (s DPH):</InfoLabel>
                    <InfoValue style={{ fontWeight: 600, color: '#3b82f6', whiteSpace: 'nowrap' }}>
                      {parseFloat(order.polozky_celkova_cena_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                    </InfoValue>
                  </InfoRow>
                )}
              </>
            )}
            
            {/* FAKTURY - CENY */}
            {hasFaktury && (
              <>
                {/* Poƒçet faktur */}
                <InfoRow>
                  <InfoLabel>Poƒçet faktur:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500 }}>
                    {order.faktury_count || faktury.length} ks
                  </InfoValue>
                </InfoRow>
                
                {/* Faktury - celkov√° ƒç√°stka s DPH */}
                {order.faktury_celkova_castka_s_dph && parseFloat(order.faktury_celkova_castka_s_dph) > 0 && (
                  <InfoRow>
                    <InfoLabel>Faktury (s DPH):</InfoLabel>
                    <InfoValue style={{ fontWeight: 600, color: '#7c3aed', whiteSpace: 'nowrap' }}>
                      {parseFloat(order.faktury_celkova_castka_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                    </InfoValue>
                  </InfoRow>
                )}
              </>
            )}
            
            {/* Druh objedn√°vky */}
            <InfoRow>
              <InfoLabel>Druh objedn√°vky:</InfoLabel>
              <InfoValue style={{ fontWeight: 500, fontSize: '0.9em' }}>
                {(() => {
                  if (order.druh_objednavky?.nazev) {
                    return order.druh_objednavky.nazev;
                  }
                  return '---';
                })()}
              </InfoValue>
            </InfoRow>
          </InfoCard>

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 3Ô∏è‚É£ ODPOVƒöDN√â OSOBY */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
            <InfoCardTitle>
              <FontAwesomeIcon icon={faUsers} />
              Odpovƒõdn√© osoby
            </InfoCardTitle>
            
            {/* Objednatel */}
            <InfoRow>
              <InfoLabel>Objednatel:</InfoLabel>
              <InfoValue>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '2px', alignItems: 'flex-end' }}>
                  <span style={{ fontWeight: 500 }}>
                    {order.objednatel?.cele_jmeno || order.uzivatel?.cele_jmeno || getUserDisplayName(order.uzivatel_id) || '---'}
                  </span>
                </div>
              </InfoValue>
            </InfoRow>
            {(order.objednatel?.email || order.uzivatel?.email) && (
              <div style={{ 
                textAlign: 'right', 
                fontSize: '0.85em', 
                color: '#6b7280',
                marginTop: '-0.3rem',
                marginBottom: '0.5rem',
                paddingRight: '0',
                wordBreak: 'break-all'
              }}>
                {order.objednatel?.email || order.uzivatel?.email}
              </div>
            )}
            
            {/* Garant */}
            {order.garant_uzivatel && (
              <>
                <InfoRow>
                  <InfoLabel>Garant:</InfoLabel>
                  <InfoValue>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px', alignItems: 'flex-end' }}>
                      <span style={{ fontWeight: 500 }}>
                        {order.garant_uzivatel.cele_jmeno || getUserDisplayName(order.garant_uzivatel.id) || '---'}
                      </span>
                    </div>
                  </InfoValue>
                </InfoRow>
                {order.garant_uzivatel.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.garant_uzivatel.email}
                  </div>
                )}
              </>
            )}
            
            {/* P≈ô√≠kazce */}
            {order.prikazce && (
              <>
                <InfoRow>
                  <InfoLabel>P≈ô√≠kazce:</InfoLabel>
                  <InfoValue>
                    <span style={{ fontWeight: 500 }}>
                      {order.prikazce.cele_jmeno || getUserDisplayName(order.prikazce.id) || '---'}
                    </span>
                  </InfoValue>
                </InfoRow>
                {order.prikazce.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.prikazce.email}
                  </div>
                )}
              </>
            )}
            
            {/* Schvalovatel */}
            {order.schvalovatel && (
              <>
                <InfoRow>
                  <InfoLabel>Schvalovatel:</InfoLabel>
                  <InfoValue>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px', alignItems: 'flex-end' }}>
                      <span style={{ fontWeight: 500 }}>
                        {order.schvalovatel.cele_jmeno || getUserDisplayName(order.schvalovatel.id) || '---'}
                      </span>
                    </div>
                  </InfoValue>
                </InfoRow>
                {order.schvalovatel.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.schvalovatel.email}
                  </div>
                )}
              </>
            )}
            
            {/* Odes√≠latel */}
            {order.odesilatel && (
              <>
                <InfoRow>
                  <InfoLabel>Odes√≠latel:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500, color: '#0891b2' }}>
                    {order.odesilatel.cele_jmeno || '---'}
                  </InfoValue>
                </InfoRow>
                {order.odesilatel.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.odesilatel.email}
                  </div>
                )}
              </>
            )}
            
            {/* Dodavatel potvrdil */}
            {order.dodavatel_potvrdil && (
              <>
                <InfoRow>
                  <InfoLabel>Dodavatel potvrdil:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500, color: '#0891b2' }}>
                    {order.dodavatel_potvrdil.cele_jmeno || '---'}
                  </InfoValue>
                </InfoRow>
                {order.dodavatel_potvrdil.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.dodavatel_potvrdil.email}
                  </div>
                )}
              </>
            )}
            
            {/* Zve≈ôejnil */}
            {order.zverejnil && (
              <>
                <InfoRow>
                  <InfoLabel>Zve≈ôejnil:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500, color: '#0891b2' }}>
                    {order.zverejnil.cele_jmeno || '---'}
                  </InfoValue>
                </InfoRow>
                {order.zverejnil.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.zverejnil.email}
                  </div>
                )}
              </>
            )}
            
            {/* Fakturant */}
            {order.fakturant && (
              <>
                <InfoRow>
                  <InfoLabel>Fakturant:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500, color: '#7c3aed' }}>
                    {order.fakturant.cele_jmeno || '---'}
                  </InfoValue>
                </InfoRow>
                {order.fakturant.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.fakturant.email}
                  </div>
                )}
              </>
            )}
            
            {/* Potvrdil vƒõcnou spr√°vnost */}
            {order.potvrdil_vecnou_spravnost && (
              <>
                <InfoRow>
                  <InfoLabel>Potvrdil vƒõcnou spr√°vnost:</InfoLabel>
                  <InfoValue style={{ fontWeight: 500, color: '#0891b2' }}>
                    {order.potvrdil_vecnou_spravnost.cele_jmeno || '---'}
                  </InfoValue>
                </InfoRow>
                {order.potvrdil_vecnou_spravnost.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.potvrdil_vecnou_spravnost.email}
                  </div>
                )}
              </>
            )}
            
            {/* Dokonƒçil objedn√°vku */}
            {order.dokoncil && (
              <>
                <InfoRow>
                  <InfoLabel>Dokonƒçil objedn√°vku:</InfoLabel>
                  <InfoValue style={{ fontWeight: 600, color: '#16a34a' }}>
                    {order.dokoncil.cele_jmeno || '---'}
                  </InfoValue>
                </InfoRow>
                {order.dokoncil.email && (
                  <div style={{ 
                    textAlign: 'right', 
                    fontSize: '0.85em', 
                    color: '#6b7280',
                    marginTop: '-0.3rem',
                    marginBottom: '0.5rem',
                    wordBreak: 'break-all'
                  }}>
                    {order.dokoncil.email}
                  </div>
                )}
              </>
            )}
          </InfoCard>

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 4Ô∏è‚É£ WORKFLOW KROKY */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
            <InfoCardTitle>
              <FontAwesomeIcon icon={faListCheck} />
              Workflow kroky
            </InfoCardTitle>
            
            {/* Vytvo≈ôil */}
            {order.uzivatel && (
              <div style={{ 
                marginBottom: '0.75rem',
                paddingBottom: '0.75rem',
                borderBottom: '1px dashed #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#3b82f6', marginBottom: '2px' }}>
                      1. Vytvo≈ôil
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.uzivatel.cele_jmeno}
                    </div>
                  </div>
                  {order.uzivatel.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.uzivatel.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Schv√°lil */}
            {order.schvalovatel && (
              <div style={{ 
                marginBottom: '0.75rem',
                paddingBottom: '0.75rem',
                borderBottom: '1px dashed #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#059669', marginBottom: '2px' }}>
                      2. Schv√°lil
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.schvalovatel.cele_jmeno}
                    </div>
                  </div>
                  {order.schvalovatel.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.schvalovatel.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Odeslal */}
            {order.odesilatel && (
              <div style={{ 
                marginBottom: '0.75rem',
                paddingBottom: '0.75rem',
                borderBottom: '1px dashed #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#0891b2', marginBottom: '2px' }}>
                      3. Odeslal dodavateli
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.odesilatel.cele_jmeno}
                    </div>
                  </div>
                  {order.odesilatel.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.odesilatel.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Dodavatel potvrdil */}
            {order.dodavatel_potvrdil && (
              <div style={{ 
                marginBottom: '0.75rem',
                paddingBottom: '0.75rem',
                borderBottom: '1px dashed #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#7c3aed', marginBottom: '2px' }}>
                      4. Dodavatel potvrdil
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.dodavatel_potvrdil.cele_jmeno}
                    </div>
                  </div>
                  {order.dodavatel_potvrdil.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.dodavatel_potvrdil.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Zve≈ôejnil */}
            {order.zverejnil && (
              <div style={{ 
                marginBottom: '0.75rem',
                paddingBottom: '0.75rem',
                borderBottom: '1px dashed #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#f59e0b', marginBottom: '2px' }}>
                      5. Zve≈ôejnil
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.zverejnil.cele_jmeno}
                    </div>
                  </div>
                  {order.zverejnil.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.zverejnil.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Potvrdil vƒõcnou spr√°vnost */}
            {order.potvrdil_vecnou_spravnost && (
              <div style={{ 
                marginBottom: '0.75rem',
                paddingBottom: '0.75rem',
                borderBottom: '1px dashed #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#0891b2', marginBottom: '2px' }}>
                      6. Potvrdil vƒõcnou spr√°vnost
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.potvrdil_vecnou_spravnost.cele_jmeno}
                    </div>
                  </div>
                  {order.potvrdil_vecnou_spravnost.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.potvrdil_vecnou_spravnost.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Dokonƒçil */}
            {order.dokoncil && (
              <div style={{ 
                marginBottom: '0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.85em', color: '#16a34a', marginBottom: '2px' }}>
                      7. Dokonƒçil objedn√°vku
                    </div>
                    <div style={{ fontSize: '0.9em', fontWeight: 500 }}>
                      {order.dokoncil.cele_jmeno}
                    </div>
                  </div>
                  {order.dokoncil.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#64748b',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.dokoncil.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Posledn√≠ aktualizace */}
            {order.uzivatel_akt && (
              <div style={{ 
                marginTop: '0.75rem',
                paddingTop: '0.75rem',
                borderTop: '2px solid #e2e8f0'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  gap: '8px'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, fontSize: '0.75em', color: '#94a3b8', marginBottom: '2px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                      Posledn√≠ zmƒõna
                    </div>
                    <div style={{ fontSize: '0.85em', color: '#64748b' }}>
                      {order.uzivatel_akt.cele_jmeno}
                    </div>
                  </div>
                  {order.uzivatel_akt.datum && (
                    <div style={{ 
                      fontSize: '0.75em', 
                      color: '#94a3b8',
                      textAlign: 'right',
                      whiteSpace: 'nowrap'
                    }}>
                      {prettyDate(order.uzivatel_akt.datum)}
                    </div>
                  )}
                </div>
              </div>
            )}
          </InfoCard>

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 5Ô∏è‚É£ DODAVATEL */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
            <InfoCardTitle>
              <FontAwesomeIcon icon={faBuilding} />
              Dodavatel
            </InfoCardTitle>
            
            <InfoRow>
              <InfoLabel>N√°zev:</InfoLabel>
              <InfoValue style={{ fontWeight: 600 }}>
                {order.dodavatel_nazev || '---'}
              </InfoValue>
            </InfoRow>
            
            <InfoRow>
              <InfoLabel>IƒåO:</InfoLabel>
              <InfoValue style={{ fontFamily: 'monospace', fontSize: '0.95em' }}>
                {order.dodavatel_ico || '---'}
              </InfoValue>
            </InfoRow>
            
            {order.dodavatel_adresa && (
              <InfoRow>
                <InfoLabel>Adresa:</InfoLabel>
                <InfoValue>{order.dodavatel_adresa}</InfoValue>
              </InfoRow>
            )}
            
            {order.dodavatel_kontakt_jmeno && (
              <InfoRow>
                <InfoLabel>Kontaktn√≠ osoba:</InfoLabel>
                <InfoValue>{order.dodavatel_kontakt_jmeno}</InfoValue>
              </InfoRow>
            )}
            
            {order.dodavatel_kontakt_email && (
              <InfoRow>
                <InfoLabel>E-mail:</InfoLabel>
                <InfoValue style={{ wordBreak: 'break-all' }}>
                  {order.dodavatel_kontakt_email}
                </InfoValue>
              </InfoRow>
            )}
            
            {order.dodavatel_kontakt_telefon && (
              <InfoRow>
                <InfoLabel>Telefon:</InfoLabel>
                <InfoValue>{order.dodavatel_kontakt_telefon}</InfoValue>
              </InfoRow>
            )}
          </InfoCard>

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* DRUH√ù ≈ò√ÅDEK: Polo≈æky + Faktury vlevo | P≈ô√≠lohy vpravo p≈ôes v√Ω≈°ku */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          <SecondRowLayout>
            <LeftColumn>
              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              {/* 6Ô∏è‚É£ POLO≈ΩKY OBJEDN√ÅVKY - KOMPLETN√ç S DPH */}
              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              {hasPolozky && (
                <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
                  <InfoCardTitle>
                    <FontAwesomeIcon icon={faList} />
                    Polo≈æky objedn√°vky ({order.polozky_count || polozky.length})
                  </InfoCardTitle>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginTop: '8px' }}>
                {polozky.slice(0, 10).map((polozka, index) => (
                  <ListItemCard key={index}>
                    <ListItemHeader>
                      <ListItemTitle>
                        {polozka.popis || polozka.nazev || `Polo≈æka ${index + 1}`}
                        {polozka.id && (
                          <sup style={{ 
                            fontSize: '0.6em', 
                            color: '#94a3b8', 
                            fontWeight: 400,
                            marginLeft: '4px'
                          }}>
                            #{polozka.id}
                          </sup>
                        )}
                      </ListItemTitle>
                      
                      {/* Cena s DPH - hlavn√≠ hodnota */}
                      {polozka.cena_s_dph && (
                        <div style={{ 
                          fontWeight: 700, 
                          fontSize: '1em',
                          color: '#059669',
                          whiteSpace: 'nowrap'
                        }}>
                          {parseFloat(polozka.cena_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                        </div>
                      )}
                    </ListItemHeader>
                    
                    {/* Tagy pod n√°zvem - √∫sek, budova, m√≠stnost, pozn√°mka um√≠stƒõn√≠ */}
                    {(polozka.mistnost_kod || polozka.budova_kod || polozka.usek_kod || polozka.poznamka_umisteni) && (
                      <div style={{ 
                        display: 'flex', 
                        flexWrap: 'wrap', 
                        gap: '6px', 
                        marginTop: '6px',
                        marginBottom: '8px'
                      }}>
                        {polozka.usek_kod && (
                          <span style={{
                            display: 'inline-block',
                            padding: '3px 8px',
                            fontSize: '0.75em',
                            fontWeight: 500,
                            backgroundColor: '#f3e8ff',
                            color: '#6b21a8',
                            borderRadius: '4px',
                            border: '1px solid #d8b4fe'
                          }}>
                            √ösek: {polozka.usek_kod}
                          </span>
                        )}
                        
                        {polozka.budova_kod && (
                          <span style={{
                            display: 'inline-block',
                            padding: '3px 8px',
                            fontSize: '0.75em',
                            fontWeight: 500,
                            backgroundColor: '#dbeafe',
                            color: '#1e40af',
                            borderRadius: '4px',
                            border: '1px solid #93c5fd'
                          }}>
                            Budova: {polozka.budova_kod}
                          </span>
                        )}
                        
                        {polozka.mistnost_kod && (
                          <span style={{
                            display: 'inline-block',
                            padding: '3px 8px',
                            fontSize: '0.75em',
                            fontWeight: 500,
                            backgroundColor: '#dbeafe',
                            color: '#1e40af',
                            borderRadius: '4px',
                            border: '1px solid #93c5fd'
                          }}>
                            M√≠stnost: {polozka.mistnost_kod}
                          </span>
                        )}
                        
                        {polozka.poznamka_umisteni && (
                          <span style={{
                            display: 'inline-block',
                            padding: '3px 8px',
                            fontSize: '0.75em',
                            fontStyle: 'italic',
                            backgroundColor: '#fef3c7',
                            color: '#92400e',
                            borderRadius: '4px',
                            border: '1px solid #fde68a'
                          }}>
                            {polozka.poznamka_umisteni}
                          </span>
                        )}
                      </div>
                    )}
                    
                    <ListItemMeta>
                      {/* Poƒçet */}
                      {polozka.pocet && (
                        <ListItemMetaItem>
                          <span style={{ fontWeight: 500 }}>Poƒçet:</span>
                          <span>{polozka.pocet} {polozka.jednotka || 'ks'}</span>
                        </ListItemMetaItem>
                      )}
                      
                      {/* Jednotkov√° cena bez DPH */}
                      {polozka.jednotkova_cena_bez_dph && (
                        <ListItemMetaItem>
                          <span style={{ fontWeight: 500 }}>Jedn. bez DPH:</span>
                          <span>{parseFloat(polozka.jednotkova_cena_bez_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç</span>
                        </ListItemMetaItem>
                      )}
                      
                      {/* Jednotkov√° cena s DPH */}
                      {polozka.jednotkova_cena_s_dph && (
                        <ListItemMetaItem>
                          <span style={{ fontWeight: 500 }}>Jedn. s DPH:</span>
                          <span>{parseFloat(polozka.jednotkova_cena_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç</span>
                        </ListItemMetaItem>
                      )}
                      
                      {/* Cena bez DPH celkem */}
                      {polozka.cena_bez_dph && (
                        <ListItemMetaItem>
                          <span style={{ fontWeight: 500 }}>Bez DPH:</span>
                          <span style={{ color: '#64748b' }}>
                            {parseFloat(polozka.cena_bez_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                          </span>
                        </ListItemMetaItem>
                      )}
                      
                      {/* DPH procento */}
                      {polozka.dph_procento && (
                        <ListItemMetaItem>
                          <span style={{ fontWeight: 500 }}>DPH:</span>
                          <span>{polozka.dph_procento}%</span>
                        </ListItemMetaItem>
                      )}
                      
                      {/* DPH ƒç√°stka */}
                      {polozka.dph_castka && (
                        <ListItemMetaItem>
                          <span style={{ fontWeight: 500 }}>DPH ƒç√°stka:</span>
                          <span>
                            {parseFloat(polozka.dph_castka).toLocaleString('cs-CZ')}&nbsp;Kƒç
                          </span>
                        </ListItemMetaItem>
                      )}
                    </ListItemMeta>
                  </ListItemCard>
                ))}
                
                {polozky.length > 10 && (
                  <div style={{ 
                    fontSize: '0.85em', 
                    color: '#6b7280', 
                    fontStyle: 'italic',
                    textAlign: 'center',
                    padding: '8px'
                  }}>
                    ... a dal≈°√≠ch {polozky.length - 10} polo≈æek
                  </div>
                )}
                
                {/* Spoleƒçn√° pozn√°mka k polo≈æk√°m */}
                {order.poznamka && (
                  <div style={{ 
                    marginTop: '12px',
                    padding: '10px 12px',
                    backgroundColor: '#fffbeb',
                    border: '1px solid #fde68a',
                    borderRadius: '6px',
                    fontSize: '0.9em',
                    color: '#92400e',
                    fontStyle: 'italic'
                  }}>
                    <strong style={{ fontStyle: 'normal', fontWeight: 600 }}>Pozn√°mka k polo≈æk√°m:</strong>
                    <div style={{ marginTop: '4px' }}>
                      {order.poznamka}
                    </div>
                  </div>
                )}
              </div>
            </InfoCard>
          )}

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 7Ô∏è‚É£ FAKTURY - KOMPLETN√ç S DPH A P≈ò√çLOHAMI */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {hasFaktury && (
            <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
              <InfoCardTitle>
                <FontAwesomeIcon icon={faReceipt} />
                Faktury ({order.faktury_count || faktury.length})
              </InfoCardTitle>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginTop: '8px' }}>
                {faktury.map((faktura, index) => {
                  const fakturaPrilohy = faktura.prilohy || [];
                  const hasFakturaPrilohy = Array.isArray(fakturaPrilohy) && fakturaPrilohy.length > 0;
                  
                  return (
                    <ListItemCard key={index}>
                      <ListItemHeader>
                        <ListItemTitle>
                          {faktura.fa_cislo_vema || faktura.cislo_faktury || `Faktura ${index + 1}`}
                        </ListItemTitle>
                        
                        {/* Stav faktury */}
                        {faktura.stav && (
                          <ListItemBadge 
                            $success={faktura.stav === 'ZAPLACENA'}
                            $warning={faktura.stav === 'NEZAPLACENA'}
                          >
                            {faktura.stav === 'ZAPLACENA' && <FontAwesomeIcon icon={faCheckCircle} />}
                            {faktura.stav === 'NEZAPLACENA' && <FontAwesomeIcon icon={faHourglassHalf} />}
                            {faktura.stav}
                          </ListItemBadge>
                        )}
                      </ListItemHeader>
                      
                      <ListItemMeta>
                        {/* ƒå√≠slo faktury VEMA */}
                        {faktura.fa_cislo_vema && (
                          <ListItemMetaItem>
                            <span style={{ fontWeight: 500 }}>ƒå√≠slo faktury: {faktura.fa_cislo_vema}</span>
                          </ListItemMetaItem>
                        )}
                        
                        {/* Datum vystaven√≠ */}
                        {(faktura.fa_datum_vystaveni || faktura.dt_vystaveni) && (
                          <ListItemMetaItem>
                            <span>Vystavena: {formatDateOnly(faktura.fa_datum_vystaveni || faktura.dt_vystaveni)}</span>
                          </ListItemMetaItem>
                        )}
                        
                        {/* Datum doruƒçen√≠ */}
                        {faktura.fa_datum_doruceni && (
                          <ListItemMetaItem>
                            <span>Doruƒçena: {formatDateOnly(faktura.fa_datum_doruceni)}</span>
                          </ListItemMetaItem>
                        )}
                        
                        {/* Datum splatnosti */}
                        {(faktura.fa_datum_splatnosti || faktura.dt_splatnosti) && (
                          <ListItemMetaItem>
                            <span>Splatnost: {formatDateOnly(faktura.fa_datum_splatnosti || faktura.dt_splatnosti)}</span>
                          </ListItemMetaItem>
                        )}
                        
                        {/* ƒå√°stka bez DPH */}
                        {faktura.castka_bez_dph && parseFloat(faktura.castka_bez_dph) > 0 && (
                          <ListItemMetaItem>
                            <span style={{ fontWeight: 500 }}>Bez DPH:</span>
                            <span style={{ color: '#64748b' }}>
                              {parseFloat(faktura.castka_bez_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                            </span>
                          </ListItemMetaItem>
                        )}
                        
                        {/* DPH ƒç√°stka */}
                        {faktura.dph_castka && parseFloat(faktura.dph_castka) > 0 && (
                          <ListItemMetaItem>
                            <span style={{ fontWeight: 500 }}>DPH:</span>
                            <span style={{ color: '#f59e0b' }}>
                              {parseFloat(faktura.dph_castka).toLocaleString('cs-CZ')}&nbsp;Kƒç
                            </span>
                          </ListItemMetaItem>
                        )}
                        
                        {/* ƒå√°stka s DPH - HLAVN√ç HODNOTA */}
                        {faktura.castka_s_dph && parseFloat(faktura.castka_s_dph) > 0 && (
                          <ListItemMetaItem>
                            <span style={{ fontWeight: 700, color: '#059669', fontSize: '1.05em' }}>
                              {parseFloat(faktura.castka_s_dph).toLocaleString('cs-CZ')}&nbsp;Kƒç
                            </span>
                          </ListItemMetaItem>
                        )}
                      </ListItemMeta>
                      
                      {/* St≈ôediska faktury */}
                      {faktura.fa_strediska_kod && Array.isArray(faktura.fa_strediska_kod) && faktura.fa_strediska_kod.length > 0 && (
                        <div style={{ 
                          marginTop: '6px', 
                          fontSize: '0.85em', 
                          color: '#475569',
                          paddingTop: '6px',
                          borderTop: '1px dashed #e2e8f0'
                        }}>
                          <span style={{ fontWeight: 500 }}>St≈ôediska:</span> {faktura.fa_strediska_kod.join(', ')}
                        </div>
                      )}
                      
                      {/* Pozn√°mka k faktu≈ôe */}
                      {faktura.fa_poznamka && (
                        <div style={{ 
                          marginTop: '8px',
                          padding: '8px 10px',
                          backgroundColor: '#fef9e7',
                          border: '1px solid #fde68a',
                          borderRadius: '4px',
                          fontSize: '0.85em',
                          color: '#92400e',
                          whiteSpace: 'pre-wrap',
                          lineHeight: '1.4'
                        }}>
                          <div style={{ fontWeight: 600, marginBottom: '4px' }}>
                            Pozn√°mka:
                          </div>
                          {faktura.fa_poznamka}
                        </div>
                      )}
                      
                      {/* P≈ô√≠lohy faktury */}
                      {hasFakturaPrilohy && (
                        <AttachmentsList>
                          {fakturaPrilohy.map((priloha, pIndex) => (
                            <AttachmentItem key={pIndex}>
                              <FontAwesomeIcon icon={faPaperclip} style={{ color: '#94a3b8', marginRight: '6px' }} />
                              <AttachmentName>
                                {priloha.nazev_souboru || priloha.nazev || 'Dokument'}
                              </AttachmentName>
                              {priloha.velikost && (
                                <AttachmentSize>
                                  ({Math.round(priloha.velikost / 1024)} KB)
                                </AttachmentSize>
                              )}
                              <FontAwesomeIcon 
                                icon={faDownload} 
                                style={{ 
                                  color: '#3b82f6', 
                                  cursor: 'pointer',
                                  marginLeft: '8px'
                                }}
                                title="St√°hnout p≈ô√≠lohu"
                                onClick={() => handleDownloadAttachment(priloha)}
                              />
                            </AttachmentItem>
                          ))}
                        </AttachmentsList>
                      )}
                    </ListItemCard>
                  );
                })}
              </div>
            </InfoCard>
          )}
            </LeftColumn>

            <RightColumn>
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {/* 8Ô∏è‚É£ V≈†ECHNY P≈ò√çLOHY - KATEGORIZOVAN√â */}
          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
          {(hasPrilohy || hasDodatecneDokumenty || hasFaktury) && (
            <InfoCard $order={order} $showRowHighlighting={showRowHighlighting}>
              <InfoCardTitle>
                <FontAwesomeIcon icon={faPaperclip} />
                P≈ô√≠lohy ({
                  (order.prilohy_count || prilohy.length) + 
                  (dodatecneDokumenty.length) + 
                  (faktury.reduce((sum, f) => sum + ((f.prilohy && f.prilohy.length) || 0), 0))
                })
              </InfoCardTitle>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', marginTop: '8px' }}>
                
                {/* üìé P≈ò√çLOHY OBJEDN√ÅVKY */}
                {hasPrilohy && (
                  <div>
                    <div style={{ 
                      fontWeight: 600, 
                      fontSize: '0.95em', 
                      color: '#1e40af',
                      marginBottom: '8px',
                      paddingBottom: '4px',
                      borderBottom: '2px solid #dbeafe'
                    }}>
                      P≈ô√≠lohy objedn√°vky ({order.prilohy_count || prilohy.length})
                    </div>
                    
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                      {prilohy.slice(0, 10).map((priloha, index) => (
                        <AttachmentItem key={index}>
                          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '2px' }}>
                            <AttachmentName style={{ fontWeight: 500 }}>
                              {priloha.nazev_souboru || priloha.nazev || `P≈ô√≠loha ${index + 1}`}
                            </AttachmentName>
                            <div style={{ fontSize: '0.8em', color: '#94a3b8' }}>
                              {priloha.dt_nahrano && formatDateOnly(priloha.dt_nahrano)}
                              {priloha.popis && ` ‚Ä¢ ${priloha.popis}`}
                            </div>
                          </div>
                          {priloha.velikost && (
                            <AttachmentSize>
                              ({Math.round(priloha.velikost / 1024)} KB)
                            </AttachmentSize>
                          )}
                          <FontAwesomeIcon 
                            icon={faDownload} 
                            style={{ 
                              color: '#3b82f6', 
                              cursor: 'pointer',
                              marginLeft: '8px'
                            }}
                            title="St√°hnout p≈ô√≠lohu"
                            onClick={() => handleDownloadAttachment(priloha)}
                          />
                        </AttachmentItem>
                      ))}
                      
                      {prilohy.length > 10 && (
                        <div style={{ 
                          fontSize: '0.85em', 
                          color: '#6b7280', 
                          fontStyle: 'italic',
                          textAlign: 'center',
                          padding: '8px'
                        }}>
                          ... a dal≈°√≠ch {prilohy.length - 10} p≈ô√≠loh
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* üìÑ DODATEƒåN√â DOKUMENTY */}
                {hasDodatecneDokumenty && (
                  <div>
                    <div style={{ 
                      fontWeight: 600, 
                      fontSize: '0.95em', 
                      color: '#7c3aed',
                      marginBottom: '8px',
                      paddingBottom: '4px',
                      borderBottom: '2px solid #ede9fe'
                    }}>
                      Dodateƒçn√© dokumenty ({dodatecneDokumenty.length})
                    </div>
                    
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                      {dodatecneDokumenty.map((dokument, index) => (
                        <AttachmentItem key={index}>
                          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '2px' }}>
                            <AttachmentName style={{ fontWeight: 500 }}>
                              {dokument.nazev_souboru || dokument.nazev || `Dokument ${index + 1}`}
                            </AttachmentName>
                            <div style={{ fontSize: '0.8em', color: '#94a3b8' }}>
                              {dokument.dt_nahrano && formatDateOnly(dokument.dt_nahrano)}
                              {dokument.popis && ` ‚Ä¢ ${dokument.popis}`}
                            </div>
                          </div>
                          {dokument.velikost && (
                            <AttachmentSize>
                              ({Math.round(dokument.velikost / 1024)} KB)
                            </AttachmentSize>
                          )}
                          <FontAwesomeIcon 
                            icon={faDownload} 
                            style={{ 
                              color: '#7c3aed', 
                              cursor: 'pointer',
                              marginLeft: '8px'
                            }}
                            title="St√°hnout dokument"
                            onClick={() => handleDownloadAttachment(dokument)}
                          />
                        </AttachmentItem>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* üßæ P≈ò√çLOHY FAKTUR */}
                {hasFaktury && faktury.some(f => f.prilohy && f.prilohy.length > 0) && (
                  <div>
                    <div style={{ 
                      fontWeight: 600, 
                      fontSize: '0.95em', 
                      color: '#059669',
                      marginBottom: '8px',
                      paddingBottom: '4px',
                      borderBottom: '2px solid #d1fae5'
                    }}>
                      P≈ô√≠lohy faktur ({faktury.reduce((sum, f) => sum + ((f.prilohy && f.prilohy.length) || 0), 0)})
                    </div>
                    
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                      {faktury.map((faktura, fIndex) => {
                        const fakturaPrilohy = faktura.prilohy || [];
                        if (!fakturaPrilohy.length) return null;
                        
                        return (
                          <div key={fIndex} style={{ 
                            paddingLeft: '12px',
                            borderLeft: '3px solid #d1fae5'
                          }}>
                            <div style={{ 
                              fontSize: '0.85em', 
                              fontWeight: 600, 
                              color: '#047857',
                              marginBottom: '6px'
                            }}>
                              {faktura.cislo_faktury || `Faktura ${fIndex + 1}`}
                            </div>
                            
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                              {fakturaPrilohy.map((priloha, pIndex) => (
                                <AttachmentItem key={pIndex}>
                                  <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                    <AttachmentName style={{ fontWeight: 500 }}>
                                      {priloha.nazev_souboru || priloha.nazev || 'Dokument'}
                                    </AttachmentName>
                                    <div style={{ fontSize: '0.8em', color: '#94a3b8' }}>
                                      {priloha.dt_nahrano && formatDateOnly(priloha.dt_nahrano)}
                                    </div>
                                  </div>
                                  {priloha.velikost && (
                                    <AttachmentSize>
                                      ({Math.round(priloha.velikost / 1024)} KB)
                                    </AttachmentSize>
                                  )}
                                  <FontAwesomeIcon 
                                    icon={faDownload} 
                                    style={{ 
                                      color: '#059669', 
                                      cursor: 'pointer',
                                      marginLeft: '8px'
                                    }}
                                    title="St√°hnout p≈ô√≠lohu"
                                    onClick={() => handleDownloadAttachment(priloha)}
                                  />
                                </AttachmentItem>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                
              </div>
            </InfoCard>
          )}
            </RightColumn>
          </SecondRowLayout>

          {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
        </ExpandedGrid>
      </ExpandedContent>
    );
  };

  // üé¨ Zobraz splash screen bƒõhem JAK√âHOKOLIV naƒç√≠t√°n√≠ (inicializace i refresh)
  if (loading || !initializationComplete) {
    return (
      <LoadingOverlay $visible={true}>
        <LoadingSpinner $visible={true} />
        <LoadingMessage $visible={true}>
          {!initializationComplete ? 'Inicializace p≈ôehledu objedn√°vek' : 'Naƒç√≠t√°n√≠ dat z datab√°ze...'}
        </LoadingMessage>
        <LoadingSubtext $visible={true}>
          {!initializationComplete && !initStepsCompleted.current.dataLoaded && 'Naƒç√≠t√°n√≠ dat z datab√°ze...'}
          {!initializationComplete && initStepsCompleted.current.dataLoaded && !initStepsCompleted.current.paginationRestored && 'Obnoven√≠ str√°nkov√°n√≠...'}
          {!initializationComplete && initStepsCompleted.current.paginationRestored && !initStepsCompleted.current.expandedRestored && 'Rozbalov√°n√≠ objedn√°vek...'}
          {!initializationComplete && initStepsCompleted.current.expandedRestored && !initStepsCompleted.current.scrollRestored && 'Obnoven√≠ pozice...'}
          {initializationComplete && loading && 'Pros√≠m ƒçekejte...'}
        </LoadingSubtext>
      </LoadingOverlay>
    );
  }

  if (error) {
    return (
      <Container>
        <div style={{ textAlign: 'center', padding: '3rem' }}>
          <FontAwesomeIcon icon={faExclamationTriangle} size="2x" style={{ color: '#dc2626' }} />
          <div style={{ marginTop: '1rem', fontSize: '1.25rem', color: '#dc2626' }}>
            Chyba p≈ôi naƒç√≠t√°n√≠
          </div>
          <div style={{ marginTop: '0.5rem', color: '#64748b' }}>{error}</div>
          <div style={{ marginTop: '1rem', display: 'flex', gap: '1rem', justifyContent: 'center' }}>
            <ActionButton 
              onClick={handleRefresh} 
              $primary
            >
              <FontAwesomeIcon icon={faSyncAlt} />
              Zkusit znovu
            </ActionButton>
            <ActionButton 
              onClick={() => {}}
            >
              <FontAwesomeIcon icon={faBolt} />
              Debug info
            </ActionButton>
          </div>
        </div>
      </Container>
    );
  }

  // CustomSelect wrapper - pou≈æ√≠v√° glob√°ln√≠ komponentu
  const CustomSelectLocal = (props) => (
    <CustomSelect
      {...props}
      selectStates={selectStates}
      setSelectStates={setSelectStates}
      searchStates={searchStates}
      setSearchStates={setSearchStates}
      touchedSelectFields={touchedSelectFields}
      setTouchedSelectFields={setTouchedSelectFields}
      hasTriedToSubmit={hasTriedToSubmit}
      toggleSelect={toggleSelect}
      filterOptions={filterOptions}
      getOptionLabel={getOptionLabel}
    />
  );

  return (
    <Container>
      <PageContent $blurred={false}>
      {/* Year Filter - prominent position above header */}
      <YearFilterPanel>
        <YearFilterLeft>
          <YearFilterLabel>
            <FontAwesomeIcon icon={faCalendarAlt} />
            Rok:
          </YearFilterLabel>
          <YearDropdownContainer ref={yearSelectRef}>
            <MonthDropdownButton onClick={toggleYearDropdown}>
              <span>{selectedYear === 'all' ? 'V≈°echny roky' : selectedYear}</span>
              <FontAwesomeIcon icon={isYearDropdownOpen ? faChevronUp : faChevronDown} />
            </MonthDropdownButton>
            {isYearDropdownOpen && (
              <MonthDropdownMenu>
                {getYearsList().map(year => (
                  <MonthDropdownItem key={year} onClick={() => handleYearChange(year)}>
                    {year === 'all' ? 'V≈°echny roky' : year}
                  </MonthDropdownItem>
                ))}
              </MonthDropdownMenu>
            )}
          </YearDropdownContainer>

          <MonthFilterLabel>
            <FontAwesomeIcon icon={faCalendarAlt} />
            Obdob√≠:
          </MonthFilterLabel>
          <MonthDropdownContainer ref={monthSelectRef}>
            <MonthDropdownButton onClick={toggleMonthDropdown}>
              <span>{getMonthLabel(selectedMonth)}</span>
              <FontAwesomeIcon icon={isMonthDropdownOpen ? faChevronUp : faChevronDown} />
            </MonthDropdownButton>
            {isMonthDropdownOpen && (
              <MonthDropdownMenu>
                <MonthDropdownItem onClick={() => handleMonthChange('all')}>
                  V≈°echny mƒõs√≠ce
                </MonthDropdownItem>
                <MonthDropdownItem onClick={() => handleMonthChange('last-month')}>
                  Posledn√≠ mƒõs√≠c
                </MonthDropdownItem>
                <MonthDropdownItem onClick={() => handleMonthChange('last-quarter')}>
                  Posledn√≠ kvart√°l
                </MonthDropdownItem>
                <MonthDropdownItem onClick={() => handleMonthChange('last-half')}>
                  Posledn√≠ p≈Ølrok
                </MonthDropdownItem>
                
                {!showExpandedMonths ? (
                  <>
                    <MonthDropdownItem separator disabled>
                      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    </MonthDropdownItem>
                    <MonthDropdownItem action onClick={() => handleMonthChange('show-more')}>
                      ‚ûï Zobrazit dal≈°√≠...
                    </MonthDropdownItem>
                  </>
                ) : (
                  <>
                    <MonthDropdownItem separator disabled>
                      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    </MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('1')}>Leden</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('2')}>√önor</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('3')}>B≈ôezen</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('4')}>Duben</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('5')}>Kvƒõten</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('6')}>ƒåerven</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('7')}>ƒåervenec</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('8')}>Srpen</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('9')}>Z√°≈ô√≠</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('10')}>≈ò√≠jen</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('11')}>Listopad</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('12')}>Prosinec</MonthDropdownItem>
                    <MonthDropdownItem separator disabled>
                      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    </MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('1-3')}>Q1 (Leden-B≈ôezen)</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('4-6')}>Q2 (Duben-ƒåerven)</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('7-9')}>Q3 (ƒåervenec-Z√°≈ô√≠)</MonthDropdownItem>
                    <MonthDropdownItem onClick={() => handleMonthChange('10-12')}>Q4 (≈ò√≠jen-Prosinec)</MonthDropdownItem>
                    <MonthDropdownItem separator disabled>
                      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                    </MonthDropdownItem>
                    <MonthDropdownItem action onClick={() => handleMonthChange('show-less')}>
                      ‚ûñ Zobrazit m√©nƒõ
                    </MonthDropdownItem>
                  </>
                )}
              </MonthDropdownMenu>
            )}
          </MonthDropdownContainer>

          {/* Checkbox pro zobrazen√≠ archivovan√Ωch objedn√°vek */}
          <div style={{
            position: 'relative',
            minWidth: '180px',
            marginLeft: '1rem'
          }}>
            <MonthDropdownButton
              as="label"
              htmlFor="showArchived"
              style={{
                padding: '0.75rem 1rem',
                cursor: 'pointer',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                gap: '0.75rem'
              }}
            >
              <input
                type="checkbox"
                id="showArchived"
                checked={showArchived}
                onChange={handleShowArchivedChange}
                style={{
                  width: '20px',
                  height: '20px',
                  cursor: 'pointer',
                  accentColor: 'rgba(255, 255, 255, 0.9)',
                  margin: 0,
                  flexShrink: 0
                }}
              />
              <span style={{ 
                flex: 1, 
                fontWeight: 600,
                fontSize: '1rem',
                textAlign: 'center'
              }}>
                ARCHIV
              </span>
              <FontAwesomeIcon 
                icon={faArchive} 
                style={{ 
                  fontSize: '1.1rem',
                  flexShrink: 0
                }} 
              />
            </MonthDropdownButton>
          </div>

          {/* Tlaƒç√≠tko Obnovit */}
          <RefreshIconButton 
            onClick={handleRefresh}
            title="Obnovit seznam objedn√°vek (force reload z datab√°ze)"
          >
            <FontAwesomeIcon icon={faSyncAlt} />
          </RefreshIconButton>
        </YearFilterLeft>
        <YearFilterTitle>
          {lastLoadSource && (
            <CacheStatusIconWrapper>
              <CacheStatusIcon fromCache={lastLoadSource === 'memory' || lastLoadSource === 'cache'}>
                <FontAwesomeIcon icon={lastLoadSource === 'memory' || lastLoadSource === 'cache' ? faBoltLightning : faDatabase} />
              </CacheStatusIcon>
              <div className="tooltip" data-icon="none">
                {(lastLoadSource === 'memory' || lastLoadSource === 'cache')
                  ? '‚ö° Naƒçteno z cache (pamƒõti) - rychl√© zobrazen√≠ bez dotazu na datab√°zi'
                  : 'üíæ Naƒçteno z datab√°ze - aktu√°ln√≠ data p≈ô√≠mo ze serveru'
                }
                {lastLoadTime && (
                  <div style={{ fontSize: '0.75rem', marginTop: '0.25rem', opacity: 0.8 }}>
                    üìÖ {new Date(lastLoadTime).toLocaleTimeString('cs-CZ')}
                    {lastLoadDuration !== null && (
                      <span style={{ marginLeft: '0.5rem' }}>
                        ‚è±Ô∏è {lastLoadDuration}ms
                      </span>
                    )}
                  </div>
                )}
              </div>
            </CacheStatusIconWrapper>
          )}
          P≈ôehled objedn√°vek
          <FontAwesomeIcon icon={faFileInvoice} style={{ marginLeft: '0.5rem' }} />
        </YearFilterTitle>
      </YearFilterPanel>

      {/* Page Header */}
      <PageHeader>
        <ActionBar>
          <TooltipWrapper>
            <ActionButton 
              onClick={handleCreateNewOrder}
              style={{ 
                background: '#166534',
                color: 'white',
                fontWeight: 600
              }}
            >
              <FontAwesomeIcon icon={faPlus} />
              Nov√° objedn√°vka
            </ActionButton>
            <div className="tooltip top" data-icon="success">
              Vytvo≈ôit novou objedn√°vku
            </div>
          </TooltipWrapper>
          
          <TooltipWrapper>
            <ActionButton onClick={handleRefresh}>
              <FontAwesomeIcon icon={faSyncAlt} />
              Obnovit
            </ActionButton>
            <div className="tooltip top" data-icon="info">
              Obnovit seznam objedn√°vek z datab√°ze
            </div>
          </TooltipWrapper>
          
          {!showDashboard && (
            <TooltipWrapper>
              <ActionButton onClick={handleToggleDashboard}>
                <FontAwesomeIcon icon={faDashboard} />
                Dashboard
              </ActionButton>
              <div className="tooltip top" data-icon="info">
                Zobrazit p≈ôehledov√Ω dashboard s grafy
              </div>
            </TooltipWrapper>
          )}
          
          {!showFiltersPanel && (
            <TooltipWrapper>
              <ActionButton onClick={handleShowFilters}>
                <FontAwesomeIcon icon={faFilter} />
                Filtr
              </ActionButton>
              <div className="tooltip top" data-icon="info">
                Zobrazit pokroƒçil√© filtry
              </div>
            </TooltipWrapper>
          )}
          
          <TooltipWrapper>
            <ActionButton onClick={handleExport}>
              <FontAwesomeIcon icon={faFileExport} />
              Export
            </ActionButton>
            <div className="tooltip top" data-icon="success">
              Export aktu√°ln√≠ho seznamu do CSV souboru
            </div>
          </TooltipWrapper>

        </ActionBar>
      </PageHeader>

      {/* Debug Panel */}
      {showDebug && rawData && (
        <DebugPanel>
          <DebugHeader>
            <DebugTitle>
              <FontAwesomeIcon icon={faBolt} />
              üîç DEBUG - Surov√° data z datab√°ze
            </DebugTitle>
            <div style={{ display: 'flex', gap: '10px' }}>
              <ActionButton 
                onClick={() => window.open('/test-notifications', '_blank')}
                style={{ background: '#1e40af', borderColor: '#60a5fa' }}
              >
                <FontAwesomeIcon icon={faBell} />
                Test Notifikac√≠
              </ActionButton>
              <ActionButton onClick={handleToggleDebug}>
                <FontAwesomeIcon icon={faTimes} />
                Skr√Ωt debug
              </ActionButton>
            </div>
          </DebugHeader>
          <DebugContent>
            <DebugSection>
              <DebugLabel>üìä Z√°kladn√≠ info:</DebugLabel>
              <DebugValue>{`Naƒçteno: ${rawData.timestamp}
Poƒçet z√°znam≈Ø: ${rawData.ordersCount}
Dostupn√° pole: ${rawData.allFields.join(', ')}`}</DebugValue>
            </DebugSection>
            
            {rawData.firstOrder && (
              <DebugSection>
                <DebugLabel>üìù Prvn√≠ z√°znam (struktura):</DebugLabel>
                <DebugValue>{JSON.stringify(rawData.firstOrder, null, 2)}</DebugValue>
              </DebugSection>
            )}
            
            <DebugSection>
              <DebugLabel>üóÇÔ∏è V≈°echna data (JSON):</DebugLabel>
              <DebugValue>{JSON.stringify(rawData.rawData, null, 2)}</DebugValue>
            </DebugSection>
          </DebugContent>
        </DebugPanel>
      )}

      {/* üß™ Order V2 API Test Panel */}
      {showApiTestPanel && (
        <DebugPanel>
          <DebugHeader>
            <DebugTitle>
              <FontAwesomeIcon icon={faBolt} />
              üß™ ORDER V2 API TEST PANEL
            </DebugTitle>
            <ActionButton onClick={() => setShowApiTestPanel(false)}>
              <FontAwesomeIcon icon={faTimes} />
              Zav≈ô√≠t
            </ActionButton>
          </DebugHeader>
          <DebugContent>
            {!apiTestData ? (
              <DebugSection>
                <DebugLabel>‚è≥ ƒåek√°m na data...</DebugLabel>
                <DebugValue>Zmƒõ≈à filtr (rok, mƒõs√≠c, archiv checkbox) nebo klikni na Obnovit pro naƒçten√≠ dat.</DebugValue>
              </DebugSection>
            ) : (
              <>
                {/* Filter State */}
                <DebugSection>
                  <DebugLabel>üéõÔ∏è Stav filtr≈Ø:</DebugLabel>
                  <DebugValue>{JSON.stringify({
                    showArchived: apiTestData.filterState?.showArchived,
                    selectedYear: apiTestData.filterState?.selectedYear,
                    selectedMonth: apiTestData.filterState?.selectedMonth,
                    canViewAllOrders: apiTestData.filterState?.canViewAllOrders,
                    currentUserId: apiTestData.filterState?.currentUserId
                  }, null, 2)}</DebugValue>
                </DebugSection>
            
            {/* API Request */}
            <DebugSection>
              <DebugLabel>üì° API Request (co se pos√≠l√°):</DebugLabel>
              <DebugValue>{JSON.stringify({
                endpoint: '/order-v2/list-enriched',
                filters: apiTestData.requestFilters,
                timestamp: apiTestData.requestTimestamp
              }, null, 2)}</DebugValue>
            </DebugSection>
            
            {/* API Response Summary */}
            <DebugSection>
              <DebugLabel>üì• API Response (co p≈ôi≈°lo z BE):</DebugLabel>
              <DebugValue>{`Celkem objedn√°vek: ${apiTestData.apiResponseCount || 0}
Archivovan√©: ${apiTestData.archivedInResponse || 0}
Nearchivovan√©: ${(apiTestData.apiResponseCount || 0) - (apiTestData.archivedInResponse || 0)}
Timestamp: ${apiTestData.responseTimestamp || 'N/A'}`}</DebugValue>
            </DebugSection>
            
            {/* Frontend Filter Result */}
            <DebugSection>
              <DebugLabel>üîç Po frontend filtraci (co se zobrazuje):</DebugLabel>
              <DebugValue>{`Zobrazeno objedn√°vek: ${apiTestData.filteredCount || 0}
Archivovan√©: ${apiTestData.archivedInFiltered || 0}
Nearchivovan√©: ${apiTestData.nonArchivedInFiltered || 0}`}</DebugValue>
            </DebugSection>
            
            {/* First 3 Orders Sample */}
            {apiTestData.apiResponse && apiTestData.apiResponse.length > 0 && (
              <DebugSection>
                <DebugLabel>üìù Uk√°zka prvn√≠ch 3 objedn√°vek z API:</DebugLabel>
                <DebugValue>{JSON.stringify(
                  apiTestData.apiResponse.slice(0, 3).map(o => ({
                    id: o.id,
                    cislo_objednavky: o.cislo_objednavky,
                    stav_objednavky: o.stav_objednavky,
                    uzivatel_id: o.uzivatel_id,
                    garant_uzivatel_id: o.garant_uzivatel_id,
                    dt_objednavky: o.dt_objednavky,
                    datum_obj_od: o.datum_obj_od,
                    datum_obj_do: o.datum_obj_do
                  })),
                  null,
                  2
                )}</DebugValue>
              </DebugSection>
            )}
            
            {/* Full API Response */}
            <DebugSection>
              <DebugLabel>üóÇÔ∏è Kompletn√≠ API Response (JSON):</DebugLabel>
              <DebugValue style={{ maxHeight: '400px', overflow: 'auto' }}>
                {JSON.stringify(apiTestData.apiResponse, null, 2)}
              </DebugValue>
            </DebugSection>
              </>
            )}
          </DebugContent>
        </DebugPanel>
      )}

      {/* Dashboard */}
      {showDashboard && (
        <DashboardPanel>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
            <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <FontAwesomeIcon icon={faDashboard} style={{ color: '#3b82f6' }} />
              Dashboard objedn√°vek {dashboardCompact ? '(kompaktn√≠)' : '(pln√Ω)'}
            </h3>
            <div style={{ display: 'flex', gap: '0.5rem' }}>
              <ActionButton onClick={handleToggleDashboardView}>
                <FontAwesomeIcon icon={dashboardCompact ? faTableColumns : faFileInvoice} />
                {dashboardCompact ? 'Pln√Ω' : 'Kompaktn√≠'}
              </ActionButton>
              <ActionButton onClick={handleToggleDashboard}>
                <FontAwesomeIcon icon={faTimes} />
                Skr√Ωt
              </ActionButton>
            </div>
          </div>
          <DashboardGrid>
            {dashboardCompact ? (
              // Kompaktn√≠ verze
              <>
                <StatCard $color={STATUS_COLORS.TOTAL.dark}>
                  <div style={{ width: '100%' }}>
                    <StatValue style={{ textAlign: 'left' }}>{Math.round(stats.totalAmount).toLocaleString('cs-CZ')}&nbsp;Kƒç</StatValue>
                    <StatLabel style={{ textAlign: 'left' }}>Celkov√° cena s DPH za obdob√≠ ({stats.total})</StatLabel>
                    {(() => {
                      const hasActiveFilters = 
                        globalFilter || 
                        (Array.isArray(statusFilter) && statusFilter.length > 0) ||
                        userFilter || 
                        dateFromFilter || 
                        dateToFilter || 
                        amountFromFilter || 
                        amountToFilter ||
                        Object.values(columnFilters).some(val => val);
                      
                      if (hasActiveFilters && filteredData.length < orders.length) {
                        const filteredAmount = filteredData.reduce((sum, order) => {
                          const amount = parseFloat(order.polozky_celkova_cena_s_dph || 0);
                          return sum + (isNaN(amount) ? 0 : amount);
                        }, 0);
                        
                        return (
                          <div style={{
                            marginTop: '0.5rem',
                            paddingTop: '0.5rem',
                            borderTop: '1px solid rgba(100, 116, 139, 0.2)'
                          }}>
                            <div style={{
                              fontSize: '1rem',
                              fontWeight: '700',
                              color: '#f59e0b',
                              textAlign: 'left',
                              marginBottom: '0.125rem'
                            }}>
                              {Math.round(filteredAmount).toLocaleString('cs-CZ')}&nbsp;Kƒç
                            </div>
                            <div style={{
                              fontSize: '0.65rem',
                              fontWeight: '600',
                              color: '#f59e0b',
                              textAlign: 'left',
                              paddingBottom: '0.5rem',
                              borderBottom: '1px solid rgba(100, 116, 139, 0.2)'
                            }}>
                              Celkov√° cena s DPH za vybran√© ({filteredData.length})
                            </div>
                          </div>
                        );
                      }
                      return null;
                    })()}
                  </div>
                </StatCard>

                <StatCard $color="#2196f3">
                  <StatHeader>
                    <StatValue>{filteredData.length}</StatValue>
                    <StatIcon $color="#2196f3">
                      <FontAwesomeIcon icon={faFileAlt} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Poƒçet objedn√°vek</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ODESLANA_KE_SCHVALENI.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'odeslana_ke_schvaleni'}
                  onClick={() => handleStatusFilterClick('odeslana_ke_schvaleni')}
                >
                  <StatHeader>
                    <StatValue>{stats.odeslana_ke_schvaleni}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ODESLANA_KE_SCHVALENI.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('odeslana_ke_schvaleni')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Ke schv√°len√≠</StatLabel>
                </StatCard>
                <StatCard 
                  $color={STATUS_COLORS.SCHVALENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'schvalena'}
                  onClick={() => handleStatusFilterClick('schvalena')}
                >
                  <StatHeader>
                    <StatValue>{stats.schvalena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.SCHVALENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('schvalena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Schv√°len√°</StatLabel>
                </StatCard>
                <StatCard 
                  $color={STATUS_COLORS.ROZPRACOVANA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'rozpracovana'}
                  onClick={() => handleStatusFilterClick('rozpracovana')}
                >
                  <StatHeader>
                    <StatValue>{stats.rozpracovana}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ROZPRACOVANA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('rozpracovana')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Rozpracovan√°</StatLabel>
                </StatCard>
                <StatCard 
                  $color={STATUS_COLORS.ODESLANA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'odeslana'}
                  onClick={() => handleStatusFilterClick('odeslana')}
                >
                  <StatHeader>
                    <StatValue>{stats.odeslana}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ODESLANA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('odeslana')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Odeslan√° dodavateli</StatLabel>
                </StatCard>
                <StatCard 
                  $color={STATUS_COLORS.POTVRZENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'potvrzena'}
                  onClick={() => handleStatusFilterClick('potvrzena')}
                >
                  <StatHeader>
                    <StatValue>{stats.potvrzena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.POTVRZENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('potvrzena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Potvrzen√° dodavatelem</StatLabel>
                </StatCard>
                <StatCard 
                  $color={STATUS_COLORS.UVEREJNENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'uverejnena'}
                  onClick={() => handleStatusFilterClick('uverejnena')}
                >
                  <StatHeader>
                    <StatValue>{stats.uverejnena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.UVEREJNENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('uverejnena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Uve≈ôejnƒõn√°</StatLabel>
                </StatCard>
                <StatCard 
                  $color={STATUS_COLORS.DOKONCENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'dokoncena'}
                  onClick={() => handleStatusFilterClick('dokoncena')}
                >
                  <StatHeader>
                    <StatValue>{stats.dokoncena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.DOKONCENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('dokoncena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Dokonƒçen√°</StatLabel>
                </StatCard>

                {/* Moje objedn√°vky dla≈ædice - pouze pro SUPERADMIN a ADMINISTRATOR (kompaktn√≠ re≈æim) */}
                {userDetail?.roles?.some(role => role.kod_role === 'SUPERADMIN' || role.kod_role === 'ADMINISTRATOR') && (() => {
                  // Spoƒç√≠tej kolik objedn√°vek pat≈ô√≠ dan√©mu u≈æivateli ZE FILTROVAN√ùCH DAT
                  // Order V2 API enriched pou≈æ√≠v√° tyto n√°zvy pol√≠:
                  // - uzivatel_id: ID objednatele (vytvo≈ôil objedn√°vku)
                  // - garant_uzivatel_id: ID garanta (NE garant_id!)
                  // - prikazce_id: ID p≈ô√≠kazce
                  // - schvalovatel_id: ID schvalovatele
                  
                  // üî• CRITICAL FIX: Konverze user_id na number pro porovn√°n√≠ (API V2 vrac√≠ ƒç√≠sla)
                  const currentUserIdNum = parseInt(user_id, 10);
                  
                  const myOrdersCount = filteredData.filter(order => {
                    const isObjednatel = order.uzivatel_id === currentUserIdNum;
                    const isGarant = order.garant_uzivatel_id === currentUserIdNum;
                    const isSchvalovatel = order.schvalovatel_id === currentUserIdNum;
                    const isPrikazce = order.prikazce_id === currentUserIdNum;
                    
                    return isObjednatel || isGarant || isSchvalovatel || isPrikazce;
                  }).length;

                  return (
                    <StatCard 
                      $color="#7c3aed"
                      $clickable={true}
                      $isActive={showOnlyMyOrders}
                      onClick={handleToggleOnlyMyOrders}
                    >
                      <StatHeader>
                        <StatValue>{myOrdersCount}</StatValue>
                        <StatIcon $color="#7c3aed">
                          <FontAwesomeIcon icon={faUser} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>Moje objedn√°vky</StatLabel>
                    </StatCard>
                  );
                })()}

                {/* üí∞ Faktury dla≈ædice (kompaktn√≠) */}
                {(() => {
                  let fakturyCount = 0;
                  filteredData.forEach(order => {
                    if (order._enriched?.faktury?.length) fakturyCount += order._enriched.faktury.length;
                    else if (order._enriched?.faktury_count) fakturyCount += order._enriched.faktury_count;
                  });
                  return fakturyCount > 0 ? (
                    <StatCard $color="#f59e0b">
                      <StatHeader>
                        <StatValue>{fakturyCount}</StatValue>
                        <StatIcon $color="#f59e0b"><FontAwesomeIcon icon={faFileInvoice} /></StatIcon>
                      </StatHeader>
                      <StatLabel>Faktury</StatLabel>
                    </StatCard>
                  ) : null;
                })()}

                {/* üìé P≈ô√≠lohy (kompaktn√≠) */}
                {(() => {
                  let prilohyCount = 0;
                  filteredData.forEach(order => {
                    if (order._enriched?.prilohy?.length) prilohyCount += order._enriched.prilohy.length;
                    else if (order._enriched?.prilohy_count) prilohyCount += order._enriched.prilohy_count;
                  });
                  return prilohyCount > 0 ? (
                    <StatCard $color="#8b5cf6">
                      <StatHeader>
                        <StatValue>{prilohyCount}</StatValue>
                        <StatIcon $color="#8b5cf6"><FontAwesomeIcon icon={faPaperclip} /></StatIcon>
                      </StatHeader>
                      <StatLabel>P≈ô√≠lohy</StatLabel>
                    </StatCard>
                  ) : null;
                })()}
              </>
            ) : (
              // Pln√° verze s ƒçist√Ωm designem
              <>
                <LargeStatCard $color={STATUS_COLORS.TOTAL.dark}>
                  <div>
                    <LargeStatValue>
                      {Math.round(stats.totalAmount).toLocaleString('cs-CZ')}&nbsp;Kƒç
                    </LargeStatValue>
                    <LargeStatLabel>
                      Celkov√° cena s DPH za obdob√≠ ({stats.total})
                    </LargeStatLabel>
                    {(() => {
                      const hasActiveFilters = 
                        globalFilter || 
                        (Array.isArray(statusFilter) && statusFilter.length > 0) ||
                        userFilter || 
                        dateFromFilter || 
                        dateToFilter || 
                        amountFromFilter || 
                        amountToFilter ||
                        Object.values(columnFilters).some(val => val);
                      
                      if (hasActiveFilters && filteredData.length < orders.length) {
                        const filteredAmount = filteredData.reduce((sum, order) => {
                          const amount = getOrderTotalPriceWithDPH(order);
                          return sum + (isNaN(amount) ? 0 : amount);
                        }, 0);
                        
                        return (
                          <div style={{
                            marginTop: '0.75rem',
                            paddingTop: '0.75rem',
                            borderTop: '1px solid rgba(100, 116, 139, 0.2)'
                          }}>
                            <div style={{
                              fontSize: '1.25rem',
                              fontWeight: '700',
                              color: '#f59e0b',
                              textAlign: 'center',
                              marginBottom: '0.25rem'
                            }}>
                              {Math.round(filteredAmount).toLocaleString('cs-CZ')}&nbsp;Kƒç
                            </div>
                            <div style={{
                              fontSize: '0.75rem',
                              fontWeight: '600',
                              color: '#f59e0b',
                              textAlign: 'center',
                              paddingBottom: '0.75rem',
                              borderBottom: '1px solid rgba(100, 116, 139, 0.2)'
                            }}>
                              Celkov√° cena s DPH za vybran√© ({filteredData.length})
                            </div>
                          </div>
                        );
                      }
                      return null;
                    })()}
                  </div>
                  
                  <SummaryRow>
                    <SummaryItem 
                      $color="#d97706" 
                      $bg="rgba(217, 119, 6, 0.08)"
                    >
                      <SummaryLabel $color="#92400e">Rozpracovan√©</SummaryLabel>
                      <SummaryValue>
                        {Math.round(filteredData.reduce((sum, order) => {
                          const status = getOrderSystemStatus(order);
                          const isCancelledOrRejected = ['STORNOVA', 'ZAMITNUTA', 'ZRUSENA', 'CANCELLED', 'SMAZANA'].includes(status);
                          const isCompleted = ['DOKONCENA', 'VYRIZENA', 'COMPLETED'].includes(status);
                          if (!isCancelledOrRejected && !isCompleted) {
                            const amount = getOrderTotalPriceWithDPH(order);
                            return sum + (isNaN(amount) ? 0 : amount);
                          }
                          return sum;
                        }, 0)).toLocaleString('cs-CZ')}&nbsp;Kƒç
                      </SummaryValue>
                    </SummaryItem>
                    
                    <SummaryItem 
                      $color="#059669" 
                      $bg="rgba(5, 150, 105, 0.08)"
                    >
                      <SummaryLabel $color="#065f46">Dokonƒçen√©</SummaryLabel>
                      <SummaryValue>
                        {Math.round(filteredData.reduce((sum, order) => {
                          const status = getOrderSystemStatus(order);
                          const isCompleted = ['DOKONCENA', 'VYRIZENA', 'COMPLETED'].includes(status);
                          if (isCompleted) {
                            const amount = getOrderTotalPriceWithDPH(order);
                            return sum + (isNaN(amount) ? 0 : amount);
                          }
                          return sum;
                        }, 0)).toLocaleString('cs-CZ')}&nbsp;Kƒç
                      </SummaryValue>
                    </SummaryItem>
                  </SummaryRow>
                </LargeStatCard>

                <StatCard $color="#2196f3">
                  <StatHeader>
                    <StatValue>{filteredData.length}</StatValue>
                    <StatIcon $color="#2196f3">
                      <FontAwesomeIcon icon={faFileAlt} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Poƒçet objedn√°vek</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.NOVA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'nova'}
                  onClick={() => handleStatusFilterClick('nova')}
                >
                  <StatHeader>
                    <StatValue>{stats.nova}</StatValue>
                    <StatIcon $color={STATUS_COLORS.NOVA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('nova')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Nov√° / Koncept</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ODESLANA_KE_SCHVALENI.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'odeslana_ke_schvaleni'}
                  onClick={() => handleStatusFilterClick('odeslana_ke_schvaleni')}
                >
                  <StatHeader>
                    <StatValue>{stats.odeslana_ke_schvaleni}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ODESLANA_KE_SCHVALENI.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('odeslana_ke_schvaleni')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Ke schv√°len√≠</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.SCHVALENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'schvalena'}
                  onClick={() => handleStatusFilterClick('schvalena')}
                >
                  <StatHeader>
                    <StatValue>{stats.schvalena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.SCHVALENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('schvalena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Schv√°len√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ZAMITNUTA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'zamitnuta'}
                  onClick={() => handleStatusFilterClick('zamitnuta')}
                >
                  <StatHeader>
                    <StatValue>{stats.zamitnuta}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ZAMITNUTA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('zamitnuta')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Zam√≠tnut√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ROZPRACOVANA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'rozpracovana'}
                  onClick={() => handleStatusFilterClick('rozpracovana')}
                >
                  <StatHeader>
                    <StatValue>{stats.rozpracovana}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ROZPRACOVANA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('rozpracovana')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Rozpracovan√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ODESLANA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'odeslana'}
                  onClick={() => handleStatusFilterClick('odeslana')}
                >
                  <StatHeader>
                    <StatValue>{stats.odeslana}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ODESLANA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('odeslana')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Odeslan√° dodavateli</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.POTVRZENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'potvrzena'}
                  onClick={() => handleStatusFilterClick('potvrzena')}
                >
                  <StatHeader>
                    <StatValue>{stats.potvrzena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.POTVRZENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('potvrzena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Potvrzen√° dodavatelem</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.UVEREJNENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'uverejnena'}
                  onClick={() => handleStatusFilterClick('uverejnena')}
                >
                  <StatHeader>
                    <StatValue>{stats.uverejnena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.UVEREJNENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('uverejnena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Uve≈ôejnƒõn√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.CEKA_POTVRZENI.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'ceka_potvrzeni'}
                  onClick={() => handleStatusFilterClick('ceka_potvrzeni')}
                >
                  <StatHeader>
                    <StatValue>{stats.ceka_potvrzeni}</StatValue>
                    <StatIcon $color={STATUS_COLORS.CEKA_POTVRZENI.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('ceka_potvrzeni')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>ƒåek√° na potvrzen√≠</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.CEKA_SE.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'ceka_se'}
                  onClick={() => handleStatusFilterClick('ceka_se')}
                >
                  <StatHeader>
                    <StatValue>{stats.ceka_se}</StatValue>
                    <StatIcon $color={STATUS_COLORS.CEKA_SE.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('ceka_se')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>ƒåek√° se</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.DOKONCENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'dokoncena'}
                  onClick={() => handleStatusFilterClick('dokoncena')}
                >
                  <StatHeader>
                    <StatValue>{stats.dokoncena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.DOKONCENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('dokoncena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Dokonƒçen√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ZRUSENA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'zrusena'}
                  onClick={() => handleStatusFilterClick('zrusena')}
                >
                  <StatHeader>
                    <StatValue>{stats.zrusena}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ZRUSENA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('zrusena')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Zru≈°en√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.SMAZANA.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'smazana'}
                  onClick={() => handleStatusFilterClick('smazana')}
                >
                  <StatHeader>
                    <StatValue>{stats.smazana}</StatValue>
                    <StatIcon $color={STATUS_COLORS.SMAZANA.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('smazana')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Smazan√°</StatLabel>
                </StatCard>

                <StatCard 
                  $color={STATUS_COLORS.ARCHIVOVANO.dark}
                  $clickable={true}
                  $isActive={activeStatusFilter === 'archivovano'}
                  onClick={() => handleStatusFilterClick('archivovano')}
                >
                  <StatHeader>
                    <StatValue>{stats.archivovano}</StatValue>
                    <StatIcon $color={STATUS_COLORS.ARCHIVOVANO.dark}>
                      <FontAwesomeIcon icon={getStatusIcon('archivovano')} />
                    </StatIcon>
                  </StatHeader>
                  <StatLabel>Archivov√°no / Import</StatLabel>
                </StatCard>

                {/* Moje objedn√°vky dla≈ædice - pouze pro SUPERADMIN a ADMINISTRATOR */}
                {userDetail?.roles?.some(role => role.kod_role === 'SUPERADMIN' || role.kod_role === 'ADMINISTRATOR') && (() => {
                  // Spoƒç√≠tej kolik objedn√°vek pat≈ô√≠ dan√©mu u≈æivateli ZE FILTROVAN√ùCH DAT
                  // Order V2 API enriched pou≈æ√≠v√° tyto n√°zvy pol√≠:
                  // - uzivatel_id: ID objednatele (vytvo≈ôil objedn√°vku)
                  // - garant_uzivatel_id: ID garanta (NE garant_id!)
                  // - prikazce_id: ID p≈ô√≠kazce
                  // - schvalovatel_id: ID schvalovatele
                  
                  // üî• CRITICAL FIX: Konverze user_id na number pro porovn√°n√≠ (API V2 vrac√≠ ƒç√≠sla)
                  const currentUserIdNum = parseInt(user_id, 10);
                  
                  const myOrdersCount = filteredData.filter(order => {
                    const isObjednatel = order.uzivatel_id === currentUserIdNum;
                    const isGarant = order.garant_uzivatel_id === currentUserIdNum;
                    const isSchvalovatel = order.schvalovatel_id === currentUserIdNum;
                    const isPrikazce = order.prikazce_id === currentUserIdNum;
                    
                    return isObjednatel || isGarant || isSchvalovatel || isPrikazce;
                  }).length;

                  return (
                    <StatCard 
                      $color="#7c3aed"
                      $clickable={true}
                      $isActive={showOnlyMyOrders}
                      onClick={handleToggleOnlyMyOrders}
                    >
                      <StatHeader>
                        <StatValue>{myOrdersCount}</StatValue>
                        <StatIcon $color="#7c3aed">
                          <FontAwesomeIcon icon={faUser} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>Moje objedn√°vky</StatLabel>
                    </StatCard>
                  );
                })()}

                {/* üí∞ Faktury dla≈ædice */}
                {(() => {
                  let fakturyCount = 0;
                  let fakturyCelkem = 0;
                  
                  filteredData.forEach(order => {
                    if (order._enriched?.faktury && Array.isArray(order._enriched.faktury)) {
                      fakturyCount += order._enriched.faktury.length;
                      order._enriched.faktury.forEach(faktura => {
                        const castka = parseFloat(faktura.fa_castka || 0);
                        if (!isNaN(castka)) fakturyCelkem += castka;
                      });
                    }
                    // Fallback na faktury_count pokud existuje
                    if (!order._enriched?.faktury && order._enriched?.faktury_count) {
                      fakturyCount += order._enriched.faktury_count;
                    }
                    if (!order._enriched?.faktury && order._enriched?.faktury_celkova_castka) {
                      fakturyCelkem += parseFloat(order._enriched.faktury_celkova_castka || 0);
                    }
                  });

                  return (
                    <StatCard $color="#f59e0b" title={`Celkov√° ƒç√°stka: ${Math.round(fakturyCelkem).toLocaleString('cs-CZ')} Kƒç`}>
                      <StatHeader>
                        <StatValue>{fakturyCount}</StatValue>
                        <StatIcon $color="#f59e0b">
                          <FontAwesomeIcon icon={faFileInvoice} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>Faktury</StatLabel>
                      {fakturyCelkem > 0 && (
                        <div style={{ fontSize: '0.75rem', color: '#92400e', marginTop: '0.25rem', fontWeight: 600 }}>
                          {Math.round(fakturyCelkem).toLocaleString('cs-CZ')}&nbsp;Kƒç
                        </div>
                      )}
                    </StatCard>
                  );
                })()}

                {/* üìé P≈ô√≠lohy objedn√°vek dla≈ædice */}
                {(() => {
                  let prilohyCount = 0;
                  let prilohyVelikost = 0;
                  
                  filteredData.forEach(order => {
                    if (order._enriched?.prilohy && Array.isArray(order._enriched.prilohy)) {
                      prilohyCount += order._enriched.prilohy.length;
                      order._enriched.prilohy.forEach(priloha => {
                        const velikost = parseFloat(priloha.velikost_souboru_b || 0);
                        if (!isNaN(velikost)) prilohyVelikost += velikost;
                      });
                    }
                    // Fallback na prilohy_count pokud existuje
                    if (!order._enriched?.prilohy && order._enriched?.prilohy_count) {
                      prilohyCount += order._enriched.prilohy_count;
                    }
                  });
                  
                  // P≈ôevod na MB
                  const velikostMB = (prilohyVelikost / (1024 * 1024)).toFixed(1);

                  return (
                    <StatCard $color="#8b5cf6" title={`Celkov√° velikost: ${velikostMB} MB`}>
                      <StatHeader>
                        <StatValue>{prilohyCount}</StatValue>
                        <StatIcon $color="#8b5cf6">
                          <FontAwesomeIcon icon={faPaperclip} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>P≈ô√≠lohy obj.</StatLabel>
                      {prilohyVelikost > 0 && (
                        <div style={{ fontSize: '0.75rem', color: '#5b21b6', marginTop: '0.25rem', fontWeight: 600 }}>
                          {velikostMB}&nbsp;MB
                        </div>
                      )}
                    </StatCard>
                  );
                })()}

                {/* üìÑ Dodateƒçn√© dokumenty dla≈ædice */}
                {(() => {
                  let dokumentyCount = 0;
                  
                  filteredData.forEach(order => {
                    if (order._enriched?.dodatecne_dokumenty && Array.isArray(order._enriched.dodatecne_dokumenty)) {
                      dokumentyCount += order._enriched.dodatecne_dokumenty.length;
                    }
                    // Fallback
                    if (!order._enriched?.dodatecne_dokumenty && order._enriched?.dodatecne_dokumenty_count) {
                      dokumentyCount += order._enriched.dodatecne_dokumenty_count;
                    }
                  });

                  return dokumentyCount > 0 ? (
                    <StatCard $color="#06b6d4">
                      <StatHeader>
                        <StatValue>{dokumentyCount}</StatValue>
                        <StatIcon $color="#06b6d4">
                          <FontAwesomeIcon icon={faFileAlt} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>Dodat. dokumenty</StatLabel>
                    </StatCard>
                  ) : null;
                })()}

                {/* ‚úÖ Vƒõcn√° kontrola dla≈ædice */}
                {(() => {
                  let vecnaKontrolaCount = 0;
                  let vecnaKontrolaOk = 0;
                  
                  filteredData.forEach(order => {
                    if (order._enriched?.vecna_kontrola) {
                      vecnaKontrolaCount++;
                      if (order._enriched.vecna_kontrola.stav === 'OK' || 
                          order._enriched.vecna_kontrola.stav === 'SCHVALENO' ||
                          order._enriched.vecna_kontrola.provedena === true) {
                        vecnaKontrolaOk++;
                      }
                    }
                    // Fallback na boolean pole
                    if (order.vecna_kontrola === true || order.vecna_spravnost === true) {
                      vecnaKontrolaCount++;
                      vecnaKontrolaOk++;
                    }
                  });

                  return vecnaKontrolaCount > 0 ? (
                    <StatCard $color="#10b981" title={`Schv√°leno: ${vecnaKontrolaOk} z ${vecnaKontrolaCount}`}>
                      <StatHeader>
                        <StatValue>{vecnaKontrolaOk}/{vecnaKontrolaCount}</StatValue>
                        <StatIcon $color="#10b981">
                          <FontAwesomeIcon icon={faCheckCircle} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>Vƒõcn√° kontrola</StatLabel>
                    </StatCard>
                  ) : null;
                })()}

                {/* üìã Registr smluv dla≈ædice */}
                {(() => {
                  let registrSmlouvCount = 0;
                  let registrSmlouvAktivni = 0;
                  
                  filteredData.forEach(order => {
                    if (order._enriched?.registr_smluv) {
                      registrSmlouvCount++;
                      if (order._enriched.registr_smluv.stav === 'AKTIVNI' || 
                          order._enriched.registr_smluv.aktivni === true) {
                        registrSmlouvAktivni++;
                      }
                    }
                    // Fallback na ƒç√≠slo smlouvy
                    if (order.cislo_smlouvy || order._enriched?.cislo_smlouvy) {
                      registrSmlouvCount++;
                      registrSmlouvAktivni++; // P≈ôedpokl√°d√°me aktivn√≠ pokud m√° ƒç√≠slo
                    }
                  });

                  return registrSmlouvCount > 0 ? (
                    <StatCard $color="#0ea5e9" title={`Aktivn√≠ch: ${registrSmlouvAktivni} z ${registrSmlouvCount}`}>
                      <StatHeader>
                        <StatValue>{registrSmlouvCount}</StatValue>
                        <StatIcon $color="#0ea5e9">
                          <FontAwesomeIcon icon={faFileContract} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>Registr smluv</StatLabel>
                    </StatCard>
                  ) : null;
                })()}

                {/* üéØ F√°ze dokonƒçen√≠ dla≈ædice */}
                {(() => {
                  let fazeDokonceniCount = 0;
                  let fazeDokonceniHotovo = 0;
                  
                  filteredData.forEach(order => {
                    if (order._enriched?.faze_dokonceni || order.dokonceno) {
                      fazeDokonceniCount++;
                      if (order.dokonceno === 1 || order._enriched?.faze_dokonceni?.stav === 'DOKONCENO') {
                        fazeDokonceniHotovo++;
                      }
                    }
                  });

                  return fazeDokonceniCount > 0 ? (
                    <StatCard $color="#ec4899" title={`Dokonƒçeno: ${fazeDokonceniHotovo} z ${fazeDokonceniCount}`}>
                      <StatHeader>
                        <StatValue>{fazeDokonceniHotovo}/{fazeDokonceniCount}</StatValue>
                        <StatIcon $color="#ec4899">
                          <FontAwesomeIcon icon={faRocket} />
                        </StatIcon>
                      </StatHeader>
                      <StatLabel>F√°ze dokonƒçen√≠</StatLabel>
                    </StatCard>
                  ) : null;
                })()}
              </>
            )}
          </DashboardGrid>
        </DashboardPanel>
      )}

      {/* Filters */}
      {showFiltersPanel && (
      <FiltersPanel>
        <FiltersHeader>
          <h3 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <FontAwesomeIcon icon={faFilter} style={{ color: '#3b82f6' }} />
            Filtry a vyhled√°v√°n√≠
          </h3>
          <div style={{ display: 'flex', gap: '0.5rem' }}>
            <ActionButton onClick={clearFilters} style={{ backgroundColor: '#dc2626', borderColor: '#dc2626', color: 'white' }}>
              <FontAwesomeIcon icon={faEraser} />
              Vymazat filtry
            </ActionButton>
            <ActionButton onClick={handleToggleFilters}>
              <FontAwesomeIcon icon={showFilters ? faChevronUp : faChevronDown} />
              {showFilters ? 'Skr√Ωt filtry' : 'Roz≈°√≠≈ôen√Ω filtr'}
            </ActionButton>
            <ActionButton onClick={handleHideFilters}>
              <FontAwesomeIcon icon={faTimes} />
              Skr√Ωt
            </ActionButton>
          </div>
        </FiltersHeader>

        <FilterGroup>
          <FilterLabel>
            <FontAwesomeIcon icon={faSearch} />
            Fulltext vyhled√°v√°n√≠
          </FilterLabel>
          <FilterInputWithIcon>
            <FontAwesomeIcon icon={faSearch} />
            <FilterInput
              type="text"
              placeholder="Hledat v evidenƒçn√≠m ƒç√≠sle, p≈ôedmƒõtu, objednateli..."
              value={globalFilter}
              onChange={(e) => setGlobalFilter(e.target.value)}
              hasIcon
            />
            {globalFilter && (
              <ClearButton onClick={() => setGlobalFilter('')} title="Vymazat">
                <FontAwesomeIcon icon={faTimes} />
              </ClearButton>
            )}
          </FilterInputWithIcon>
        </FilterGroup>

        {showFilters && (
          <FiltersGrid>
            {/* Prvn√≠ ≈ô√°dek: Stav objedn√°vky, Objednatel, Garant, Schvalovatel */}
            <FilterGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faList} />
                  Stav objedn√°vky
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={statusFilter.length > 0}
                  onClick={clearStatusFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <SelectWithIcon>
                <MultiSelectLocal
                  field="statusFilter"
                  value={statusFilter}
                  onChange={handleStatusFilterChange}
                  options={statusOptions}
                  placeholder="Vyberte stavy..."
                  icon={<FontAwesomeIcon icon={faList} />}
                />
              </SelectWithIcon>
            </FilterGroup>

            <FilterGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faUser} />
                  Objednatel
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={selectedObjednatel.length > 0}
                  onClick={clearObjednatelFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <SelectWithIcon>
                <MultiSelectLocal
                  field="selectedObjednatel"
                  value={selectedObjednatel}
                  onChange={handleObjednatelChange}
                  options={sortedAllUsers}
                  placeholder="Vyberte objednatele..."
                  icon={<FontAwesomeIcon icon={faUser} />}
                />
              </SelectWithIcon>
            </FilterGroup>

            <FilterGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faUser} />
                  Garant
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={selectedGarant.length > 0}
                  onClick={clearGarantFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <SelectWithIcon>
                <MultiSelectLocal
                  field="selectedGarant"
                  value={selectedGarant}
                  onChange={handleGarantChange}
                  options={sortedAllUsers}
                  placeholder="Vyberte garanty..."
                  icon={<FontAwesomeIcon icon={faUser} />}
                />
              </SelectWithIcon>
            </FilterGroup>

            <FilterGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faUser} />
                  P≈ô√≠kazce
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={selectedPrikazce.length > 0}
                  onClick={clearPrikazceFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <SelectWithIcon>
                <MultiSelectLocal
                  field="selectedPrikazce"
                  value={selectedPrikazce}
                  onChange={handlePrikazceChange}
                  options={sortedAllUsers}
                  placeholder="Vyberte p≈ô√≠kazce..."
                  icon={<FontAwesomeIcon icon={faUser} />}
                />
              </SelectWithIcon>
            </FilterGroup>

            <FilterGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faShield} />
                  Schvalovatel
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={selectedSchvalovatel.length > 0}
                  onClick={clearSchvalovatelFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <SelectWithIcon>
                <MultiSelectLocal
                  field="selectedSchvalovatel"
                  value={selectedSchvalovatel}
                  onChange={handleSchvalovatelChange}
                  options={sortedApprovers}
                  placeholder="Vyberte schvalovately..."
                  icon={<FontAwesomeIcon icon={faShield} />}
                />
              </SelectWithIcon>
            </FilterGroup>

            {/* Druh√Ω ≈ô√°dek: Datum od-do, Cena od-do */}
            <DateRangeGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faCalendarAlt} />
                  Datum od - do
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={dateFromFilter || dateToFilter}
                  onClick={clearDateFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <DateRangeInputs>
                <DateInputWrapper>
                  <DatePicker
                    value={dateFromFilter || ''}
                    onChange={(value) => setDateFromFilter(value || '')}
                    placeholder="Datum od"
                  />
                </DateInputWrapper>
                <DateSeparator>‚Äî</DateSeparator>
                <DateInputWrapper>
                  <DatePicker
                    value={dateToFilter || ''}
                    onChange={(value) => setDateToFilter(value || '')}
                    placeholder="Datum do"
                  />
                </DateInputWrapper>
              </DateRangeInputs>
            </DateRangeGroup>

            <PriceRangeGroup>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faMoneyBillWave} />
                  Cena od - do (Kƒç)
                </FilterLabelLeft>
                <FilterClearButton
                  type="button"
                  visible={amountFromFilter || amountToFilter}
                  onClick={clearPriceFilter}
                  title="Vymazat filtr"
                >
                  <FontAwesomeIcon icon={faTimes} />
                </FilterClearButton>
              </FilterLabel>
              <PriceRangeInputs>
                <PriceInputWrapper>
                  <FontAwesomeIcon icon={faMoneyBillWave} />
                  <FilterInput
                    type="text"
                    placeholder="0"
                    value={formatNumberWithSpaces(amountFromFilter)}
                    onChange={handleAmountFromChange}
                    hasIcon
                    style={{ textAlign: 'right', paddingRight: '2.5rem' }}
                  />
                </PriceInputWrapper>
                <PriceSeparator>‚Äî</PriceSeparator>
                <PriceInputWrapper>
                  <FontAwesomeIcon icon={faMoneyBillWave} />
                  <FilterInput
                    type="text"
                    placeholder="‚àû"
                    value={formatNumberWithSpaces(amountToFilter)}
                    onChange={handleAmountToChange}
                    hasIcon
                    style={{ textAlign: 'right', paddingRight: '2.5rem' }}
                  />
                </PriceInputWrapper>
              </PriceRangeInputs>
            </PriceRangeGroup>

            {/* Rychl√© filtry pro Stav registru */}
            <FilterGroup style={{ gridColumn: 'span 1' }}>
              <FilterLabel>
                <FilterLabelLeft>
                  <FontAwesomeIcon icon={faFileContract} />
                  Stav registru
                </FilterLabelLeft>
              </FilterLabel>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                <label style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '0.5rem',
                  cursor: 'pointer',
                  fontSize: '0.875rem',
                  fontWeight: filterMaBytZverejneno ? '600' : '400',
                  color: filterMaBytZverejneno ? '#f59e0b' : '#4b5563'
                }}>
                  <input
                    type="checkbox"
                    checked={filterMaBytZverejneno}
                    onChange={(e) => {
                      setFilterMaBytZverejneno(e.target.checked);
                      // Pokud zap√≠n√°≈° "M√° b√Ωt zve≈ôejnƒõno", vypni "Bylo ji≈æ zve≈ôejnƒõno"
                      if (e.target.checked && filterByloZverejneno) {
                        setFilterByloZverejneno(false);
                      }
                    }}
                    style={{ 
                      cursor: 'pointer',
                      width: '16px',
                      height: '16px',
                      accentColor: '#f59e0b'
                    }}
                  />
                  <span>M√° b√Ωt zve≈ôejnƒõno</span>
                </label>
                <label style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '0.5rem',
                  cursor: 'pointer',
                  fontSize: '0.875rem',
                  fontWeight: filterByloZverejneno ? '600' : '400',
                  color: filterByloZverejneno ? '#10b981' : '#4b5563'
                }}>
                  <input
                    type="checkbox"
                    checked={filterByloZverejneno}
                    onChange={(e) => {
                      setFilterByloZverejneno(e.target.checked);
                      // Pokud zap√≠n√°≈° "Bylo ji≈æ zve≈ôejnƒõno", vypni "M√° b√Ωt zve≈ôejnƒõno"
                      if (e.target.checked && filterMaBytZverejneno) {
                        setFilterMaBytZverejneno(false);
                      }
                    }}
                    style={{ 
                      cursor: 'pointer',
                      width: '16px',
                      height: '16px',
                      accentColor: '#10b981'
                    }}
                  />
                  <span>Bylo ji≈æ zve≈ôejnƒõno</span>
                </label>
              </div>
            </FilterGroup>

          </FiltersGrid>
        )}
      </FiltersPanel>
      )}

      {/* Table */}
      <TableContainer>
        <Table>
          <TableHead>
            {/* Header row with column names */}
            {table.getHeaderGroups().map(headerGroup => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map(header => (
                  <TableHeader
                    key={header.id}
                    onClick={header.column.getCanSort() ? header.column.getToggleSortingHandler() : undefined}
                    style={{ 
                      cursor: header.column.getCanSort() ? 'pointer' : 'default',
                      width: header.getSize()
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' }}>
                      {flexRender(header.column.columnDef.header, header.getContext())}
                      {header.column.getCanSort() && header.column.getIsSorted() && (
                        <FontAwesomeIcon
                          icon={
                            header.column.getIsSorted() === 'asc' ? faChevronUp :
                            faChevronDown
                          }
                        />
                      )}
                    </div>
                  </TableHeader>
                ))}
              </tr>
            ))}
            
            {/* Filter row with search inputs */}
            <tr>
              {table.getHeaderGroups()[0]?.headers.map(header => (
                <TableHeader key={`filter-${header.id}`} style={{ 
                  padding: '0.5rem',
                  backgroundColor: '#f8f9fa',
                  borderTop: '1px solid #e5e7eb'
                }}>
                  {header.id === 'expander' ? (
                    <div style={{ 
                      display: 'flex', 
                      justifyContent: 'center', 
                      alignItems: 'center',
                      height: '32px'
                    }}>
                      <FilterActionButton
                        onClick={toggleAllRows}
                        title={table.getIsSomeRowsExpanded() ? "Sbalit v≈°echny ≈ô√°dky" : "Rozbalit v≈°echny ≈ô√°dky"}
                      >
                        <FontAwesomeIcon icon={table.getIsSomeRowsExpanded() ? faMinus : faPlus} />
                      </FilterActionButton>
                    </div>
                  ) : header.id === 'actions' ? (
                    <div style={{ 
                      display: 'flex', 
                      justifyContent: 'center', 
                      alignItems: 'center',
                      gap: '3px',
                      height: '32px'
                    }}>
                      <FilterActionButton
                        onClick={clearColumnFilters}
                        title="Vymazat filtry sloupc≈Ø"
                      >
                        <FontAwesomeIcon icon={faEraser} />
                      </FilterActionButton>
                      <FilterActionButton
                        onClick={toggleRowHighlighting}
                        title={showRowHighlighting ? 
                          "Vypnout zv√Ωraz≈àov√°n√≠ ≈ô√°dk≈Ø podle stavu objedn√°vky\n(koncepty z≈Østanou v≈ædy zv√Ωraznƒõn√©)" : 
                          "Zapnout zv√Ωraz≈àov√°n√≠ ≈ô√°dk≈Ø podle stavu objedn√°vky\n(ka≈æd√Ω stav m√° svou barvu)"}
                        className={showRowHighlighting ? 'active' : ''}
                      >
                        <FontAwesomeIcon icon={faPalette} />
                      </FilterActionButton>
                    </div>
                  ) : (
                    <ColumnFilterWrapper>
                      <FontAwesomeIcon icon={faSearch} />
                      <ColumnFilterInput
                        type="text"
                        placeholder={`Hledat ${header.column.columnDef.header}...`}
                        value={columnFilters[header.column.columnDef.accessorKey] || ''}
                        onChange={(e) => {
                          const newFilters = { ...columnFilters };
                          newFilters[header.column.columnDef.accessorKey] = e.target.value;
                          setColumnFilters(newFilters);
                        }}
                      />
                      {columnFilters[header.column.columnDef.accessorKey] && (
                        <ColumnClearButton 
                          onClick={() => {
                            const newFilters = { ...columnFilters };
                            delete newFilters[header.column.columnDef.accessorKey];
                            setColumnFilters(newFilters);
                          }}
                          title="Vymazat"
                        >
                          <FontAwesomeIcon icon={faTimes} />
                        </ColumnClearButton>
                      )}
                    </ColumnFilterWrapper>
                  )}
                </TableHeader>
              ))}
            </tr>
          </TableHead>
          <tbody>
            {orders.length === 0 ? (
              // Pr√°zdn√Ω stav - u≈æivatel nem√° ≈æ√°dn√© objedn√°vky (p≈ôed filtrov√°n√≠m)
              <tr>
                <td colSpan={columns.length} style={{ padding: 0 }}>
                  <EmptyState>
                    <EmptyStateIcon>
                      <FontAwesomeIcon icon={faFaceFrown} />
                    </EmptyStateIcon>
                    <EmptyStateTitle>Zat√≠m nem√°te ≈æ√°dnou objedn√°vku</EmptyStateTitle>
                    <EmptyStateText>
                      Vytvo≈ôte svou prvn√≠ objedn√°vku kliknut√≠m na tlaƒç√≠tko "Nov√° objedn√°vka" v√Ω≈°e.
                    </EmptyStateText>
                  </EmptyState>
                </td>
              </tr>
            ) : table.getRowModel().rows.length === 0 ? (
              // Filtrov√°no - ≈æ√°dn√© v√Ωsledky
              <tr>
                <td colSpan={columns.length} style={{ padding: '2rem', textAlign: 'center', color: '#64748b' }}>
                  <FontAwesomeIcon icon={faFilter} style={{ fontSize: '2rem', marginBottom: '1rem', opacity: 0.5 }} />
                  <div>≈Ω√°dn√© objedn√°vky nevyhovuj√≠ nastaven√Ωm filtr≈Øm</div>
                </td>
              </tr>
            ) : (
              table.getRowModel().rows.map((row, index) => (
              <React.Fragment key={row.id}>
                <TableRow 
                  $order={row.original}
                  $isDraft={row.original.isDraft || false}
                  $hasLocalChanges={row.original.hasLocalDraftChanges || false}
                  $isEven={showRowStriping && index % 2 === 0}
                  $showStriping={showRowStriping}
                  $showHighlighting={showRowHighlighting}
                  $isHighlighted={highlightOrderId && (row.original.id === highlightOrderId || row.original.cislo_objednavky === highlightOrderId)}
                  onContextMenu={(e) => handleContextMenu(e, row.original)}
                  style={{ cursor: 'context-menu' }}
                  data-order-id={row.original.cislo_objednavky || row.original.id}
                >
                  {row.getVisibleCells().map(cell => (
                    <TableCell key={cell.id}>
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </TableCell>
                  ))}
                </TableRow>
                {row.getIsExpanded() && (
                  <TableRow 
                    $order={row.original}
                    $showStriping={showRowStriping}
                    $showHighlighting={showRowHighlighting}
                    $isEven={showRowStriping && index % 2 === 0}
                  >
                    <TableCell colSpan={columns.length} style={{ padding: 0, borderBottom: '1px solid #000' }}>
                      {renderExpandedContent(row.original)}
                    </TableCell>
                  </TableRow>
                )}
              </React.Fragment>
            )))}
          </tbody>
        </Table>

        {/* Pagination */}
        <PaginationContainer>
          <PaginationInfo>
            Zobrazeno {table.getRowModel().rows.length} z {filteredData.length} objedn√°vek
            {filteredData.length !== orders.length && (
              <span> (filtrov√°no z {orders.length})</span>
            )}
          </PaginationInfo>
          
          <PaginationControls>
            <span style={{ fontSize: '0.875rem', color: '#64748b', marginRight: '1rem' }}>
              Zobrazit:
            </span>
            <PageSizeSelect
              value={pageSize}
              onChange={(e) => {
                const newSize = parseInt(e.target.value);
                setPageSize(newSize);
                setUserStorage('orders25List_pageSize', newSize);
                table.setPageSize(newSize);
                // Resetuj na prvn√≠ str√°nku p≈ôi zmƒõnƒõ velikosti str√°nky
                setCurrentPageIndex(0);
                setUserStorage('orders25List_pageIndex', 0);
                table.setPageIndex(0);
              }}
            >
              <option value={10}>10</option>
              <option value={25}>25</option>
              <option value={50}>50</option>
              <option value={100}>100</option>
              <option value={250}>250</option>
            </PageSizeSelect>
            
            <PageButton
              onClick={goToFirstPage}
              disabled={!table.getCanPreviousPage()}
            >
              ¬´¬´
            </PageButton>
            <PageButton
              onClick={goToPreviousPage}
              disabled={!table.getCanPreviousPage()}
            >
              ‚Äπ
            </PageButton>
            
            <span style={{ fontSize: '0.875rem', color: '#64748b', margin: '0 1rem' }}>
              Str√°nka {table.getState().pagination.pageIndex + 1} z {table.getPageCount()}
            </span>
            
            <PageButton
              onClick={goToNextPage}
              disabled={!table.getCanNextPage()}
            >
              ‚Ä∫
            </PageButton>
            <PageButton
              onClick={goToLastPage}
              disabled={!table.getCanNextPage()}
            >
              ¬ª¬ª
            </PageButton>
          </PaginationControls>
        </PaginationContainer>
      </TableContainer>

      {/* Mod√°ln√≠ dialog pro potvrzen√≠ editace */}
      {showEditConfirmModal && ReactDOM.createPortal(
        <ModalOverlay onClick={handleEditCancel}>
          <ModalDialog onClick={e => e.stopPropagation()}>
            <ModalHeader>
              <ModalIcon>
                <FontAwesomeIcon icon={faExclamationTriangle} />
              </ModalIcon>
              <ModalTitle>{orderToEdit ? 'Potvrzen√≠ editace objedn√°vky' : 'Potvrzen√≠ vytvo≈ôen√≠ nov√© objedn√°vky'}</ModalTitle>
            </ModalHeader>
            
            <ModalContent>
              {orderToEdit ? (
                <p>
                  Chyst√°te se editovat objedn√°vku <strong>"{orderToEdit?.cislo_objednavky || orderToEdit?.predmet || orderToEdit?.ev_cislo || (orderToEdit?.id ? `ID ${orderToEdit.id}` : 'nezn√°m√° objedn√°vka')}"</strong>.
                </p>
              ) : (
                <p>
                  Chyst√°te se vytvo≈ôit <strong>novou objedn√°vku</strong>.
                </p>
              )}
              
              {/* DEBUG INFO - zobraz draft kter√Ω bude smaz√°n */}
              {process.env.NODE_ENV === 'development' && (() => {
                if (!currentDraftData) return (
                  <details style={{ fontSize: '0.8em', color: '#666', margin: '0.5rem 0' }}>
                    <summary>Debug info - ≈æ√°dn√Ω draft v state</summary>
                    <pre>currentDraftData: null{'\n'}orderToEdit: {JSON.stringify(orderToEdit, null, 2)}</pre>
                  </details>
                );
                
                try {
                  const formData = currentDraftData.formData || currentDraftData;
                  const isNewConcept = isValidConcept(currentDraftData);
                  const hasDbChanges = hasDraftChanges(currentDraftData);
                  
                  return (
                    <details style={{ fontSize: '0.8em', color: '#666', margin: '0.5rem 0' }}>
                      <summary>Debug info - draft kter√Ω bude smaz√°n ‚úì</summary>
                      <pre>
{`üìù Draft Title: ${formData.ev_cislo || formData.cislo_objednavky || formData.predmet || 'N/A'}
üÜî Draft ID: ${formData.id || '≈æ√°dn√© ID (nov√Ω koncept)'}
üìã P≈ôedmƒõt: ${formData.predmet || 'N/A'}
üÜï Is New Concept: ${isNewConcept ? 'ANO - √∫plnƒõ nov√° objedn√°vka' : 'NE'}
‚úèÔ∏è Has DB Changes: ${hasDbChanges ? 'ANO - editace existuj√≠c√≠ DB obj.' : 'NE'}
üéØ Saved Order ID: ${currentDraftData.savedOrderId || '≈æ√°dn√©'}

‚û°Ô∏è P≈ôep√≠n√°me na:
${orderToEdit ? `   Objedn√°vku: ${orderToEdit.cislo_objednavky || orderToEdit.predmet || 'ID ' + orderToEdit.id}` : '   NOVOU objedn√°vku (pr√°zdn√Ω formul√°≈ô)'}`}
                      </pre>
                    </details>
                  );
                } catch (error) {
                  return (
                    <details style={{ fontSize: '0.8em', color: '#666', margin: '0.5rem 0' }}>
                      <summary>Debug info - chyba zpracov√°n√≠ draftu</summary>
                      <pre>Error: {error.message}{'\n'}orderToEdit: {JSON.stringify(orderToEdit, null, 2)}</pre>
                    </details>
                  );
                }
              })()}
              
              {/* Zobraz varov√°n√≠ o rozepracovan√© objedn√°vce, pokud existuje - ORDER25 SERVICE */}
              {(() => {
                if (!currentDraftData) return null;
                
                try {
                  const formData = currentDraftData.formData || currentDraftData;
                  const draftTitle = formData.ev_cislo || formData.cislo_objednavky || formData.predmet || '‚òÖ KONCEPT ‚òÖ';
                  const isNewConcept = isValidConcept(currentDraftData);
                  
                  return (
                    <p style={{ background: '#fef3c7', padding: '0.75rem', borderRadius: '6px', border: '1px solid #f59e0b', margin: '0.5rem 0' }}>
                      <strong>Pozor:</strong> M√°te rozepracovanou {isNewConcept ? 'novou objedn√°vku' : 'editaci objedn√°vky'}{' '}
                      <strong>{draftTitle}</strong>
                      . {orderToEdit ? 'P≈ôepnut√≠m na jinou objedn√°vku' : 'Vytvo≈ôen√≠m nov√© objedn√°vky'} p≈ôijdete o neulo≈æen√© zmƒõny!
                    </p>
                  );
                } catch (error) {
                  // Chyba p≈ôi zpracov√°n√≠ draft pro confirm dialog
                  return null;
                }
              })()}
              
              {orderToEdit ? (
                <>
                  <p>
                    <strong>Varov√°n√≠:</strong> T√≠mto budou zru≈°eny v≈°echny p≈ô√≠padn√© neulo≈æen√© zmƒõny v jin√Ωch objedn√°vk√°ch a m≈Ø≈æe doj√≠t ke ztr√°tƒõ dat.
                  </p>
                  <p>
                    Chcete pokraƒçovat v editaci?
                  </p>
                </>
              ) : (
                <>
                  <p>
                    <strong>Varov√°n√≠:</strong> T√≠mto budou zru≈°eny v≈°echny neulo≈æen√© zmƒõny v souƒçasn√© objedn√°vce a m≈Ø≈æe doj√≠t ke ztr√°tƒõ dat.
                  </p>
                  <p>
                    Chcete vytvo≈ôit novou objedn√°vku a zahodit neulo≈æen√© zmƒõny?
                  </p>
                </>
              )}
            </ModalContent>
            
            <ModalActions>
              <ModalButton onClick={handleEditCancel}>
                Ne, zru≈°it
              </ModalButton>
              <ModalButton $variant="primary" onClick={(e) => { 
                e.preventDefault(); 
                if (orderToEdit) {
                  handleEditConfirm();
                } else {
                  handleCreateNewOrderConfirm();
                }
              }}>
                Ano, pokraƒçovat
              </ModalButton>
            </ModalActions>
          </ModalDialog>
        </ModalOverlay>,
        document.body
      )}

      {/* Mod√°ln√≠ dialog pro varov√°n√≠ o archivovan√© objedn√°vce */}
      {showArchivedWarningModal && ReactDOM.createPortal(
        <ModalOverlay onClick={() => { setShowArchivedWarningModal(false); setOrderToEdit(null); }}>
          <ModalDialog onClick={e => e.stopPropagation()}>
            <ModalHeader>
              <ModalIcon style={{ background: '#fed7aa', color: '#ea580c' }}>
                <FontAwesomeIcon icon={faExclamationTriangle} />
              </ModalIcon>
              <ModalTitle>Varov√°n√≠ - Importovan√° objedn√°vka</ModalTitle>
            </ModalHeader>
            
            <ModalContent>
              <p>
                Chyst√°te se editovat archivovanou objedn√°vku <strong>"{orderToEdit?.cislo_objednavky || orderToEdit?.ev_cislo || 'nezn√°m√° objedn√°vka'}"</strong>.
              </p>
              
              <p style={{ background: '#fef3c7', padding: '0.75rem', borderRadius: '6px', border: '1px solid #f59e0b', margin: '0.75rem 0' }}>
                <strong>‚ö†Ô∏è UPOZORNƒöN√ç:</strong> Tato objedn√°vka byla importov√°na z p≈Øvodn√≠ho syst√©mu EEO a m√° stav <strong>ARCHIVOV√ÅNO</strong>.
              </p>
              
              <p>
                Editace t√©to objedn√°vky m≈Ø≈æe ovlivnit p≈ô√≠padn√Ω opakovan√Ω import dat, pokud bude prov√°dƒõna aktualizace objedn√°vek ze star√©ho syst√©mu.
              </p>
              
              <p>
                <strong>D≈Øsledky editace:</strong>
              </p>
              <ul style={{ marginLeft: '1.5rem', marginTop: '0.5rem' }}>
                <li>Zmƒõny v objedn√°vce mohou b√Ωt p≈ôeps√°ny p≈ôi opakovan√©m importu</li>
                <li>Data nemus√≠ odpov√≠dat p≈Øvodn√≠mu syst√©mu EEO</li>
                <li>M≈Ø≈æe doj√≠t ke ztr√°tƒõ va≈°ich √∫prav</li>
              </ul>
              
              <p style={{ marginTop: '1rem' }}>
                Opravdu chcete pokraƒçovat v editaci?
              </p>
            </ModalContent>
            
            <ModalActions>
              <ModalButton onClick={() => { setShowArchivedWarningModal(false); setOrderToEdit(null); }}>
                Ne, zru≈°it
              </ModalButton>
              <ModalButton $variant="primary" onClick={(e) => { e.preventDefault(); handleArchivedWarningConfirm(); }}>
                Ano, rozum√≠m rizik≈Øm a chci pokraƒçovat
              </ModalButton>
            </ModalActions>
          </ModalDialog>
        </ModalOverlay>,
        document.body
      )}

      {/* KOMBINOVAN√ù modal: Archivovan√° objedn√°vka + existuj√≠c√≠ koncept */}
      {showArchivedWithDraftWarningModal && ReactDOM.createPortal(
        <ModalOverlay onClick={() => { setShowArchivedWithDraftWarningModal(false); setOrderToEdit(null); }}>
          <ModalDialog onClick={e => e.stopPropagation()}>
            <ModalHeader>
              <ModalIcon style={{ background: '#fed7aa', color: '#ea580c' }}>
                <FontAwesomeIcon icon={faExclamationTriangle} />
              </ModalIcon>
              <ModalTitle>D≈Øle≈æit√© varov√°n√≠</ModalTitle>
            </ModalHeader>
            
            <ModalContent>
              <p>
                Chyst√°te se editovat archivovanou objedn√°vku <strong>"{orderToEdit?.cislo_objednavky || orderToEdit?.ev_cislo || 'nezn√°m√° objedn√°vka'}"</strong>.
              </p>
              
              {/* VAROV√ÅN√ç 1: Archivovan√° objedn√°vka */}
              <div style={{ background: '#fef3c7', padding: '0.75rem', borderRadius: '6px', border: '1px solid #f59e0b', margin: '0.75rem 0' }}>
                <strong>‚ö†Ô∏è VAROV√ÅN√ç - ARCHIVOV√ÅNO:</strong><br />
                Tato objedn√°vka byla importov√°na z p≈Øvodn√≠ho syst√©mu EEO a m√° stav <strong>ARCHIVOV√ÅNO</strong>. 
                Editace m≈Ø≈æe b√Ωt p≈ôeps√°na p≈ôi opakovan√©m importu dat.
              </div>
              
              {/* VAROV√ÅN√ç 2: Ztr√°ta rozpracovan√© objedn√°vky */}
              <div style={{ background: '#fee2e2', padding: '0.75rem', borderRadius: '6px', border: '1px solid #ef4444', margin: '0.75rem 0' }}>
                <strong>üóëÔ∏è ZTR√ÅTA KONCEPTU:</strong><br />
                M√°te rozpracovanou objedn√°vku, kter√° bude p≈ôi pokraƒçov√°n√≠ <strong>ZTRACENA</strong> a nelze ji obnovit!
              </div>
              
              <p style={{ marginTop: '1rem' }}>
                <strong>Co se stane po pokraƒçov√°n√≠:</strong>
              </p>
              <ul style={{ marginLeft: '1.5rem', marginTop: '0.5rem' }}>
                <li>V√°≈° rozpracovan√Ω koncept bude <strong>trvale smaz√°n</strong></li>
                <li>Otev≈ôete archivovanou objedn√°vku k editaci</li>
                <li>Zmƒõny mohou b√Ωt p≈ôeps√°ny p≈ôi budouc√≠m importu</li>
              </ul>
              
              <p style={{ marginTop: '1rem', fontWeight: 'bold', color: '#dc2626' }}>
                Opravdu chcete pokraƒçovat a ztratit rozpracovanou objedn√°vku?
              </p>
            </ModalContent>
            
            <ModalActions>
              <ModalButton onClick={() => { setShowArchivedWithDraftWarningModal(false); setOrderToEdit(null); }}>
                Ne, zru≈°it
              </ModalButton>
              <ModalButton $variant="primary" onClick={(e) => { 
                e.preventDefault(); 
                handleArchivedWithDraftConfirm(); 
              }}>
                Ano, rozum√≠m a chci pokraƒçovat
              </ModalButton>
            </ModalActions>
          </ModalDialog>
        </ModalOverlay>,
        document.body
      )}

      {/* Mod√°ln√≠ dialog pro potvrzen√≠ smaz√°n√≠ */}
      {showDeleteConfirmModal && ReactDOM.createPortal(
        <ModalOverlay onClick={handleDeleteCancel}>
          <ModalDialog onClick={e => e.stopPropagation()}>
            <ModalHeader>
              <ModalIcon style={{ background: '#fecaca', color: '#dc2626' }}>
                <FontAwesomeIcon icon={faTrash} />
              </ModalIcon>
              <ModalTitle>Smaz√°n√≠ objedn√°vky</ModalTitle>
            </ModalHeader>
            
            <ModalContent>
              <p>
                Chyst√°te se smazat objedn√°vku <strong>"{orderToDelete?.cislo_objednavky || orderToDelete?.predmet || `ID ${orderToDelete?.id}`}"</strong>.
              </p>
              
              {(hasPermission('ORDER_MANAGE') || hasPermission('ORDER_2025')) ? (
                <div>
                  <p><strong>M√°te administr√°torsk√° pr√°va. Vyberte zp≈Øsob smaz√°n√≠:</strong></p>
                  <div style={{ background: '#f3f4f6', padding: '1rem', borderRadius: '6px', margin: '1rem 0' }}>
                    <p><strong>Oznaƒçit jako neaktivn√≠:</strong> Objedn√°vka z≈Østane v datab√°zi, ale nebude se zobrazovat v seznamech.</p>
                    <p><strong>Smazat √∫plnƒõ:</strong> Objedn√°vka bude natrvalo smaz√°na vƒçetnƒõ v≈°ech polo≈æek a p≈ô√≠loh. Tuto akci nelze vr√°tit zpƒõt!</p>
                  </div>
                </div>
              ) : (
                <p>Objedn√°vka bude oznaƒçena jako neaktivn√≠. Z≈Østane v datab√°zi, ale nebude se zobrazovat v seznamech.</p>
              )}
            </ModalContent>
            
            <ModalActions>
              <ModalButton onClick={handleDeleteCancel}>
                Zru≈°it
              </ModalButton>
              
              {(hasPermission('ORDER_MANAGE') || hasPermission('ORDER_2025')) ? (
                <>
                  <ModalButton onClick={() => handleDeleteConfirm('soft')}>
                    Oznaƒçit neaktivn√≠
                  </ModalButton>
                  <ModalButton $variant="primary" onClick={() => handleDeleteConfirm('hard')}>
                    Smazat √∫plnƒõ
                  </ModalButton>
                </>
              ) : (
                <ModalButton $variant="primary" onClick={() => handleDeleteConfirm('soft')}>
                  Oznaƒçit neaktivn√≠
                </ModalButton>
              )}
            </ModalActions>
          </ModalDialog>
        </ModalOverlay>,
        document.body
      )}
      
      {/* üîí Modal pro zamƒçenou objedn√°vku */}
      {showLockedOrderDialog && lockedOrderInfo && ReactDOM.createPortal(
        <ModalOverlay onClick={handleLockedOrderCancel}>
          <ModalDialog onClick={(e) => e.stopPropagation()}>
            <ModalHeader>
              <ModalIcon danger={lockedOrderInfo.canForceUnlock} warning={!lockedOrderInfo.canForceUnlock}>
                <FontAwesomeIcon icon={faLock} />
              </ModalIcon>
              <ModalTitle>
                {lockedOrderInfo.canForceUnlock ? 'Objedn√°vka je zamƒçen√°' : 'Objedn√°vka nen√≠ dostupn√°'}
              </ModalTitle>
            </ModalHeader>
            <ModalContent>
              {lockedOrderInfo.canForceUnlock ? (
                <>
                  <WarningText>
                    ‚ö†Ô∏è Objedn√°vka je aktu√°lnƒõ editov√°na u≈æivatelem:
                  </WarningText>
                  <UserInfo>
                    <strong>{lockedOrderInfo.lockedByUserName}</strong>
                  </UserInfo>

                  {/* Kontaktn√≠ √∫daje */}
                  {(lockedOrderInfo.lockedByUserEmail || lockedOrderInfo.lockedByUserTelefon) && (
                    <ContactInfo>
                      {lockedOrderInfo.lockedByUserEmail && (
                        <ContactItem>
                          <FontAwesomeIcon icon={faEnvelope} />
                          <ContactLabel>Email:</ContactLabel>
                          <a href={`mailto:${lockedOrderInfo.lockedByUserEmail}`}>
                            {lockedOrderInfo.lockedByUserEmail}
                          </a>
                        </ContactItem>
                      )}
                      {lockedOrderInfo.lockedByUserTelefon && (
                        <ContactItem>
                          <FontAwesomeIcon icon={faPhone} />
                          <ContactLabel>Telefon:</ContactLabel>
                          <a href={`tel:${lockedOrderInfo.lockedByUserTelefon}`}>
                            {lockedOrderInfo.lockedByUserTelefon}
                          </a>
                        </ContactItem>
                      )}
                    </ContactInfo>
                  )}

                  {/* ƒåas zamƒçen√≠ */}
                  {lockedOrderInfo.lockAgeMinutes !== null && (
                    <LockTimeInfo>
                      <FontAwesomeIcon icon={faClock} />
                      Zamƒçeno p≈ôed {lockedOrderInfo.lockAgeMinutes} {lockedOrderInfo.lockAgeMinutes === 1 ? 'minutou' : lockedOrderInfo.lockAgeMinutes < 5 ? 'minutami' : 'minutami'}
                    </LockTimeInfo>
                  )}

                  <InfoText>
                    Jako <strong>{lockedOrderInfo.userRoleName}</strong> m≈Ø≈æete objedn√°vku n√°silnƒõ odemknout a p≈ôevz√≠t.
                  </InfoText>
                  <WarningText>
                    ‚ö†Ô∏è P≈Øvodn√≠ u≈æivatel bude informov√°n o p≈ôevzet√≠ objedn√°vky a ztrat√≠ neulo≈æen√© zmƒõny.
                  </WarningText>
                </>
              ) : (
                <>
                  <InfoText>
                    Objedn√°vka je aktu√°lnƒõ editov√°na u≈æivatelem:
                  </InfoText>
                  <UserInfo>
                    <strong>{lockedOrderInfo.lockedByUserName}</strong>
                  </UserInfo>

                  {/* Kontaktn√≠ √∫daje */}
                  {(lockedOrderInfo.lockedByUserEmail || lockedOrderInfo.lockedByUserTelefon) && (
                    <ContactInfo>
                      {lockedOrderInfo.lockedByUserEmail && (
                        <ContactItem>
                          <FontAwesomeIcon icon={faEnvelope} />
                          <ContactLabel>Email:</ContactLabel>
                          <a href={`mailto:${lockedOrderInfo.lockedByUserEmail}`}>
                            {lockedOrderInfo.lockedByUserEmail}
                          </a>
                        </ContactItem>
                      )}
                      {lockedOrderInfo.lockedByUserTelefon && (
                        <ContactItem>
                          <FontAwesomeIcon icon={faPhone} />
                          <ContactLabel>Telefon:</ContactLabel>
                          <a href={`tel:${lockedOrderInfo.lockedByUserTelefon}`}>
                            {lockedOrderInfo.lockedByUserTelefon}
                          </a>
                        </ContactItem>
                      )}
                    </ContactInfo>
                  )}

                  {/* ƒåas zamƒçen√≠ */}
                  {lockedOrderInfo.lockAgeMinutes !== null && (
                    <LockTimeInfo>
                      <FontAwesomeIcon icon={faClock} />
                      Zamƒçeno p≈ôed {lockedOrderInfo.lockAgeMinutes} {lockedOrderInfo.lockAgeMinutes === 1 ? 'minutou' : lockedOrderInfo.lockAgeMinutes < 5 ? 'minutami' : 'minutami'}
                    </LockTimeInfo>
                  )}

                  <InfoText>
                    Nelze ji naƒç√≠st pro editaci. Poƒçkejte, a≈æ bude u≈æivatel s editac√≠ hotov√Ω, nebo ho kontaktujte.
                  </InfoText>
                </>
              )}
            </ModalContent>
            <ModalActions>
              {lockedOrderInfo.canForceUnlock ? (
                <>
                  <ModalButton secondary onClick={handleLockedOrderCancel}>
                    <FontAwesomeIcon icon={faTimes} style={{ marginRight: '0.5rem' }} />
                    Zru≈°it
                  </ModalButton>
                  <ModalButton danger onClick={handleLockedOrderForceUnlock}>
                    <FontAwesomeIcon icon={faLock} style={{ marginRight: '0.5rem' }} />
                    Odemknout a p≈ôevz√≠t
                  </ModalButton>
                </>
              ) : (
                <ModalButton onClick={handleLockedOrderCancel}>
                  <FontAwesomeIcon icon={faTimes} style={{ marginRight: '0.5rem' }} />
                  Zav≈ô√≠t
                </ModalButton>
              )}
            </ModalActions>
          </ModalDialog>
        </ModalOverlay>,
        document.body
      )}
      
      {/* ‚ö†Ô∏è FORCE UNLOCK WARNING DIALOG */}
      {showForceUnlockWarning && forceUnlockWarningData && createPortal(
        <ForceUnlockWarningOverlay onClick={(e) => e.target === e.currentTarget && handleForceUnlockWarningClose()}>
          <ForceUnlockWarningDialog onClick={(e) => e.stopPropagation()}>
            <ForceUnlockWarningHeader>
              <ForceUnlockWarningIcon>‚ö†Ô∏è</ForceUnlockWarningIcon>
              <ForceUnlockWarningTitle>N√ÅSILN√â P≈òEVZET√ç OBJEDN√ÅVKY</ForceUnlockWarningTitle>
            </ForceUnlockWarningHeader>
            
            <ForceUnlockWarningContent>
              <ForceUnlockWarningMessage>
                <p>
                  <strong>Va≈°e objedn√°vka byla n√°silnƒõ p≈ôevzata jin√Ωm u≈æivatelem!</strong>
                </p>
                <p>
                  Objedn√°vka <strong>{forceUnlockWarningData.orderNumber}</strong> byla n√°silnƒõ odemƒçena 
                  a p≈ôevzata. Va≈°e neulo≈æen√© zmƒõny mohly b√Ωt ztraceny.
                </p>
              </ForceUnlockWarningMessage>

              <ForceUnlockWarningDetails>
                <ForceUnlockWarningDetailRow>
                  <FontAwesomeIcon icon={faFileAlt} />
                  <ForceUnlockWarningDetailLabel>Objedn√°vka:</ForceUnlockWarningDetailLabel>
                  <ForceUnlockWarningDetailValue>{forceUnlockWarningData.orderNumber}</ForceUnlockWarningDetailValue>
                </ForceUnlockWarningDetailRow>

                <ForceUnlockWarningDetailRow>
                  <FontAwesomeIcon icon={faUser} />
                  <ForceUnlockWarningDetailLabel>P≈ôevzal:</ForceUnlockWarningDetailLabel>
                  <ForceUnlockWarningDetailValue>{forceUnlockWarningData.lockedBy}</ForceUnlockWarningDetailValue>
                </ForceUnlockWarningDetailRow>

                {forceUnlockWarningData.lockedByEmail && (
                  <ForceUnlockWarningDetailRow>
                    <FontAwesomeIcon icon={faEnvelope} />
                    <ForceUnlockWarningDetailLabel>Email:</ForceUnlockWarningDetailLabel>
                    <ForceUnlockWarningDetailValue>
                      <a 
                        href={`mailto:${forceUnlockWarningData.lockedByEmail}`}
                        style={{ color: '#991b1b', textDecoration: 'underline' }}
                      >
                        {forceUnlockWarningData.lockedByEmail}
                      </a>
                    </ForceUnlockWarningDetailValue>
                  </ForceUnlockWarningDetailRow>
                )}

                {forceUnlockWarningData.lockedByPhone && (
                  <ForceUnlockWarningDetailRow>
                    <FontAwesomeIcon icon={faPhone} />
                    <ForceUnlockWarningDetailLabel>Telefon:</ForceUnlockWarningDetailLabel>
                    <ForceUnlockWarningDetailValue>
                      <a 
                        href={`tel:${forceUnlockWarningData.lockedByPhone}`}
                        style={{ color: '#991b1b', textDecoration: 'underline' }}
                      >
                        {forceUnlockWarningData.lockedByPhone}
                      </a>
                    </ForceUnlockWarningDetailValue>
                  </ForceUnlockWarningDetailRow>
                )}

                <ForceUnlockWarningDetailRow>
                  <FontAwesomeIcon icon={faClock} />
                  <ForceUnlockWarningDetailLabel>ƒåas:</ForceUnlockWarningDetailLabel>
                  <ForceUnlockWarningDetailValue>
                    {new Date(forceUnlockWarningData.lockedAt).toLocaleString('cs-CZ')}
                  </ForceUnlockWarningDetailValue>
                </ForceUnlockWarningDetailRow>
              </ForceUnlockWarningDetails>

              <ForceUnlockWarningActions>
                <ForceUnlockWarningButton onClick={handleForceUnlockWarningClose}>
                  Zav≈ô√≠t
                </ForceUnlockWarningButton>
                <ForceUnlockWarningButton $primary onClick={handleForceUnlockWarningAcknowledge}>
                  <FontAwesomeIcon icon={faCheckCircle} style={{ marginRight: '0.5rem' }} />
                  Rozum√≠m, aktualizovat seznam
                </ForceUnlockWarningButton>
              </ForceUnlockWarningActions>
            </ForceUnlockWarningContent>
          </ForceUnlockWarningDialog>
        </ForceUnlockWarningOverlay>,
        document.body
      )}
      
      {/* Kontextov√© menu */}
      {contextMenu && (
        <OrderContextMenu
          x={contextMenu.x}
          y={contextMenu.y}
          order={contextMenu.order}
          selectedData={contextMenu.selectedData}
          onClose={handleCloseContextMenu}
          onAddToTodo={handleAddToTodo}
          onAddAlarm={handleAddAlarm}
          onEdit={handleContextMenuEdit}
          onDelete={handleContextMenuDelete}
          onGenerateDocx={handleGenerateDocx}
          canDelete={
            hasPermission('ORDER_MANAGE') || 
            hasPermission('ORDER_DELETE_ALL') || 
            hasPermission('ORDER_2025') ||
            (hasPermission('ORDER_DELETE_OWN') && contextMenu.order.uzivatel_id === currentUserId)
          }
        />
      )}
      
      {/* DOCX Generator Modal */}
      <DocxGeneratorModal 
        order={docxModalOrder}
        isOpen={docxModalOpen}
        onClose={handleDocxModalClose}
      />
      </PageContent>
    </Container>
  );
};

export default Orders25List;