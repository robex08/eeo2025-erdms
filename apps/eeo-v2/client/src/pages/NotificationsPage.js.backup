import React, { useState, useEffect } from 'react';
import styled from '@emotion/styled';
import { keyframes } from '@emotion/react';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { 
  faBell,
  faCheck,
  faCheckDouble,
  faTimes,
  faTrash,
  faFilter,
  faSearch,
  faExclamationCircle,
  faClock,
  faInfoCircle,
  faEdit,
  faEye,
  faEyeSlash,
  faUndo,
  faChevronDown,
  faSyncAlt
} from '@fortawesome/free-solid-svg-icons';
import { useBackgroundTasks } from '../context/BackgroundTasksContext';
import { 
  getNotificationsList,
  markNotificationAsRead,
  markAllNotificationsAsRead,
  dismissNotification,
  restoreNotification,
  deleteNotification,
  deleteAllNotifications,
  NOTIFICATION_CONFIG
} from '../services/notificationsApi';
import { useNavigate } from 'react-router-dom';
import ConfirmDialog from '../components/ConfirmDialog';

// =============================================================================
// ANIMATIONS
// =============================================================================

const fadeIn = keyframes`
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
`;

const slideIn = keyframes`
  from { 
    opacity: 0; 
    transform: translateX(-10px); 
  }
  to { 
    opacity: 1; 
    transform: translateX(0); 
  }
`;

// =============================================================================
// STYLED COMPONENTS
// =============================================================================

const PageContainer = styled.div`
  min-height: 100vh;
  padding: 2rem;
  position: relative;
  z-index: 1;
  
  @media (min-width: 1400px) {
    padding: 2rem 3rem;
  }
  
  @media (min-width: 1800px) {
    padding: 2rem 4rem;
  }
  
  @media (max-width: 768px) {
    padding: 1rem;
  }
`;

const ContentWrapper = styled.div`
  width: 100%;
  max-width: none;
  margin: 0 auto;
`;

const TitlePanel = styled.div`
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
`;

const TitleLeft = styled.div`
  display: flex;
  align-items: center;
  gap: 0.75rem;
`;

const RefreshButton = styled.button`
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  width: 42px;
  height: 42px;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  transition: all 0.2s ease;

  &:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-1px);
  }

  &:active {
    transform: translateY(0);
  }
`;

const PageDivider = styled.div`
  border-bottom: 3px solid #e5e7eb;
  margin-bottom: 2rem;
`;

const PageTitle = styled.h1`
  margin: 0;
  font-size: calc(1.5rem + 3px);
  font-weight: 700;
  color: white;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
`;

const PageHeader = styled.div`
  margin-bottom: 32px;
`;

const PageSubtitle = styled.p`
  font-size: 15px;
  color: #6b7280;
  margin: 0;
`;

const ToolbarContainer = styled.div`
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  align-items: center;
`;

const SearchBox = styled.div`
  flex: 1;
  min-width: 250px;
  position: relative;
`;

const SearchInput = styled.input`
  width: 100%;
  padding: 10px 40px 10px 40px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.15s ease;

  &:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
`;

const SearchIcon = styled.div`
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  pointer-events: none;
`;

const ClearSearchButton = styled.button`
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  padding: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
  z-index: 1;
  width: 20px;
  height: 20px;
  
  &:hover {
    color: #6b7280;
  }
  
  > svg {
    width: 14px !important;
    height: 14px !important;
  }
`;

const FilterGroup = styled.div`
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
`;

const FilterButton = styled.button`
  padding: 10px 16px;
  border: 1px solid ${props => props.$active ? '#3b82f6' : '#d1d5db'};
  background: ${props => props.$active ? 'linear-gradient(135deg, #3b82f6, #2563eb)' : 'white'};
  color: ${props => props.$active ? 'white' : '#374151'};
  border-radius: 8px;
  font-size: 14px;
  font-weight: ${props => props.$active ? 600 : 500};
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 6px;

  &:hover {
    background: ${props => props.$active ? 'linear-gradient(135deg, #2563eb, #1d4ed8)' : '#f9fafb'};
    border-color: ${props => props.$active ? '#2563eb' : '#9ca3af'};
  }

  &:active {
    transform: scale(0.98);
  }
`;

const ActionButton = styled.button`
  padding: 10px 16px;
  border: none;
  background: ${props => {
    if (props.$variant === 'danger') return 'linear-gradient(135deg, #ef4444, #dc2626)';
    if (props.$variant === 'success') return 'linear-gradient(135deg, #10b981, #059669)';
    if (props.$variant === 'warning') return 'linear-gradient(135deg, #f59e0b, #d97706)';
    return 'linear-gradient(135deg, #6b7280, #4b5563)';
  }};
  color: white;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  gap: 6px;

  &:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  &:active {
    transform: translateY(0);
  }

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
`;

const StatsBar = styled.div`
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
  flex-wrap: wrap;
`;

const StatCard = styled.div`
  background: ${props => props.$isActive ? 
    `linear-gradient(145deg, ${props.$color || '#3b82f6'}20, ${props.$color || '#3b82f6'}10)` : 
    'linear-gradient(145deg, #ffffff, #f9fafb)'};
  border-radius: 12px;
  padding: 20px;
  border-left: ${props => props.$isActive ? '6px' : '4px'} solid ${props => props.$color || '#3b82f6'};
  box-shadow: ${props => props.$isActive ? 
    `0 4px 16px rgba(0, 0, 0, 0.12), 0 0 0 2px ${props.$color || '#3b82f6'}40` :
    '0 1px 3px rgba(0, 0, 0, 0.05)'};
  flex: 1;
  min-width: 200px;
  cursor: ${props => props.$clickable ? 'pointer' : 'default'};
  transition: all 0.25s ease;

  &:hover {
    transform: ${props => props.$clickable ? 'translateY(-2px)' : 'translateY(-1px)'};
    box-shadow: ${props => props.$clickable ?
      '0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.06)' :
      '0 2px 4px rgba(0, 0, 0, 0.08)'};
    ${props => props.$clickable && `
      background: linear-gradient(145deg, ${props.$color || '#3b82f6'}25, ${props.$color || '#3b82f6'}15);
    `}
  }
`;

const StatValue = styled.div`
  font-size: clamp(1.25rem, 2.5vw, 1.875rem);
  font-weight: 700;
  color: #1e293b;
  line-height: 1.2;
  text-align: left;
  
  @media (max-width: 1400px) {
    font-size: clamp(1.2rem, 2.3vw, 1.75rem);
  }
  
  @media (max-width: 900px) {
    font-size: clamp(1.1rem, 2.1vw, 1.6rem);
  }
  
  @media (max-width: 768px) {
    font-size: clamp(1rem, 2vw, 1.5rem);
  }
`;

const StatLabel = styled.div`
  font-size: clamp(0.75rem, 1.2vw, 0.875rem);
  color: #64748b;
  font-weight: 500;
  text-align: left;
  line-height: 1.4;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  
  @media (max-width: 1200px) {
    white-space: normal;
    line-height: 1.3;
  }
  
  @media (max-width: 900px) {
    font-size: clamp(0.7rem, 1.1vw, 0.825rem);
  }
  
  @media (max-width: 768px) {
    font-size: clamp(0.65rem, 1vw, 0.8rem);
  }
`;

const NotificationsList = styled.div`
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  overflow: hidden;
`;

const NotificationItem = styled.div`
  padding: 20px;
  border-bottom: 1px solid #f3f4f6;
  display: flex;
  gap: 16px;
  align-items: start;
  transition: all 0.15s ease;
  cursor: pointer;
  animation: ${slideIn} 0.3s ease-out;
  animation-delay: ${props => props.$index * 0.03}s;
  animation-fill-mode: backwards;
  
  /* Unread styling */
  background: ${props => props.$isUnread ? 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)' : 'transparent'};
  border-left: ${props => props.$isUnread ? '4px solid #3b82f6' : '4px solid transparent'};
  
  /* Priority coloring */
  ${props => props.$priority === 'high' && `
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border-left-color: #ef4444;
  `}
  
  ${props => props.$priority === 'urgent' && `
    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
    border-left-color: #dc2626;
  `}

  &:hover {
    background: ${props => props.$isUnread ? '#dbeafe' : '#f9fafb'};
    ${props => props.$priority === 'high' && 'background: #fee2e2;'}
    ${props => props.$priority === 'urgent' && 'background: #fecaca;'}
  }

  &:last-child {
    border-bottom: none;
  }
`;

const NotificationIcon = styled.div`
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
  background: ${props => {
    if (props.$priority === 'urgent') return 'linear-gradient(135deg, #dc2626, #991b1b)';
    if (props.$priority === 'high') return 'linear-gradient(135deg, #f59e0b, #d97706)';
    return 'linear-gradient(135deg, #3b82f6, #2563eb)';
  }};
  color: white;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
`;

const NotificationContent = styled.div`
  flex: 1;
  min-width: 0;
`;

const NotificationHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 8px;
`;

const NotificationTitle = styled.div`
  font-weight: ${props => props.$isUnread ? 700 : 600};
  color: ${props => props.$isUnread ? '#111827' : '#374151'};
  font-size: 16px;
  line-height: 1.4;
`;

const NotificationMessage = styled.div`
  font-size: 14px;
  color: #6b7280;
  line-height: 1.6;
  margin-bottom: 12px;
`;

const NotificationMeta = styled.div`
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 13px;
  color: #9ca3af;
  flex-wrap: wrap;
`;

const MetaItem = styled.span`
  display: flex;
  align-items: center;
  gap: 6px;
`;

const TypeBadge = styled.span`
  background: ${props => {
    if (props.$type === 'order') return '#dbeafe';
    if (props.$type === 'TODO_ALARM') return '#fef3c7';
    if (props.$type === 'system') return '#e5e7eb';
    return '#f3f4f6';
  }};
  color: ${props => {
    if (props.$type === 'order') return '#1e40af';
    if (props.$type === 'TODO_ALARM') return '#92400e';
    if (props.$type === 'system') return '#374151';
    return '#6b7280';
  }};
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
`;

const NotificationActions = styled.div`
  display: flex;
  gap: 8px;
  flex-shrink: 0;
`;

const IconButton = styled.button`
  background: transparent;
  border: 1px solid #e5e7eb;
  color: #6b7280;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s ease;
  font-size: 14px;

  &:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    color: #111827;
  }

  &:active {
    transform: scale(0.95);
  }
`;

const EmptyState = styled.div`
  padding: 80px 20px;
  text-align: center;
  color: #9ca3af;
`;

const EmptyIcon = styled.div`
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
`;

const EmptyText = styled.div`
  font-size: 18px;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 8px;
`;

const EmptySubtext = styled.div`
  font-size: 14px;
  color: #9ca3af;
`;

const LoadingState = styled.div`
  padding: 60px 20px;
  text-align: center;
  color: #9ca3af;
  font-size: 15px;
`;

// =============================================================================
// COMPONENT
// =============================================================================

export const NotificationsPage = () => {
  const bgTasks = useBackgroundTasks();
  const navigate = useNavigate();
  
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterType, setFilterType] = useState('all'); // all, unread, read
  const [filterPriority, setFilterPriority] = useState('all'); // all, urgent, high, normal
  const [activeStatFilter, setActiveStatFilter] = useState(null); // Pro klikac√≠ dla≈ædice
  const [error, setError] = useState(null);
  const [confirmDialog, setConfirmDialog] = useState({ isOpen: false });

  // Naƒçten√≠ notifikac√≠ z datab√°ze
  useEffect(() => {
    loadNotifications();
  }, []);

  // Auto-refresh p≈ôi nov√Ωch notifikac√≠ch z backgroundu
  useEffect(() => {
    if (bgTasks?.registerNewNotificationsCallback) {
      // Registruj callback pro nov√© notifikace
      const handleNewNotifications = (newNotifications, unreadCount) => {
        // Auto-refresh str√°nky kdy≈æ p≈ôijdou nov√© notifikace nebo se zmƒõn√≠ stav
        loadNotifications();
      };
      
      bgTasks.registerNewNotificationsCallback(handleNewNotifications);
      
      // Cleanup - odregistruj callback p≈ôi unmount
      return () => {
        bgTasks.registerNewNotificationsCallback(null);
      };
    }
  }, [bgTasks]);

  // P≈ôeklad kategori√≠ do ƒçe≈°tiny
  const getCategoryLabel = (category) => {
    const labels = {
      'orders': 'Objedn√°vky',
      'todo': 'TODO √∫koly',
      'system': 'Syst√©m',
      'mentions': 'Zm√≠nky',
      'reminders': 'P≈ôipom√≠nky'
    };
    return labels[category] || category;
  };

      const loadNotifications = async (showSpinner = false) => {
    if (showSpinner) {
      setIsRefreshing(true);
    } else {
      setLoading(true);
    }
    setError(null);
    try {
      // Naƒçten√≠ notifikac√≠ z backendu - 100 posledn√≠ch notifikac√≠
      // ‚úÖ include_dismissed: true - pro str√°nku chceme i skryt√© notifikace
      const result = await getNotificationsList({
        limit: 100,
        offset: 0,
        unread_only: false,
        include_dismissed: true
      });
      
      // Backend vrac√≠ data v result.data
      const notificationsData = result.data || [];
      
      // Oboha≈• notifikace o config (ikony, barvy)
      const enrichedNotifications = notificationsData.map(notification => {
        const config = NOTIFICATION_CONFIG[notification.type] || {};
        return {
          ...notification,
          icon: config.icon || 'üîî',
          color: config.color || '#3b82f6',
          category: config.category || 'system',
          priority: notification.priority || config.priority || 'normal'
        };
      });
      
      setNotifications(enrichedNotifications);
      
    } catch (error) {
      console.error('‚ùå [NotificationsPage] Chyba p≈ôi naƒç√≠t√°n√≠ notifikac√≠:', error);
      setError('Nepoda≈ôilo se naƒç√≠st notifikace. Zkontroluj konzoli pro detaily.');
      
      // V p≈ô√≠padƒõ chyby zobraz pr√°zdn√Ω seznam
      setNotifications([]);
    } finally {
      setLoading(false);
      setIsRefreshing(false);
    }
  };

  const handleRefresh = () => {
    loadNotifications(true);
  };

  // Handler pro kliknut√≠ na statistickou dla≈ædici (filtr)
  const handleStatCardClick = (filterValue) => {
    if (filterValue === 'total') {
      // Celkem - zru≈° V≈†ECHNY filtry
      setActiveStatFilter(null);
      setFilterType('all');
      setFilterPriority('all');
      setSearchQuery(''); // Zru≈° i vyhled√°v√°n√≠
      return;
    }
    
    if (activeStatFilter === filterValue) {
      // Zru≈°it filtr
      setActiveStatFilter(null);
      setFilterType('all');
      setFilterPriority('all');
    } else {
      // Nastavit filtr
      setActiveStatFilter(filterValue);
      
      if (filterValue === 'unread') {
        setFilterType('unread');
        setFilterPriority('all');
      } else if (filterValue === 'urgent') {
        setFilterType('all');
        setFilterPriority('urgent');
      } else if (filterValue === 'high') {
        setFilterType('all');
        setFilterPriority('high');
      }
    }
  };

  // Filtered notifications
  const filteredNotifications = notifications.filter(notification => {
    // Search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const matchesSearch = 
        notification.title?.toLowerCase().includes(query) ||
        notification.message?.toLowerCase().includes(query);
      if (!matchesSearch) return false;
    }

    // Type filter (read/unread)
    if (filterType === 'unread' && (notification.is_read === 1 || notification.is_read === true)) return false;
    if (filterType === 'read' && (notification.is_read === 0 || notification.is_read === false)) return false;

    // Priority filter
    if (filterPriority !== 'all' && notification.priority !== filterPriority) return false;

    return true;
  });

  // Statistics
  const stats = {
    total: notifications.length,
    unread: notifications.filter(n => !n.is_read || n.is_read === 0).length,
    urgent: notifications.filter(n => n.priority === 'urgent').length,
    high: notifications.filter(n => n.priority === 'high').length,
  };

  const handleNotificationClick = async (notification) => {
    
    // Oznaƒçit jako p≈ôeƒçtenou pokud nen√≠
    const isUnread = !notification.is_read || notification.is_read === 0;
    if (isUnread) {
      await handleMarkAsRead(notification.id);
    }
    
    // Navigace podle typu notifikace
    try {
      const data = notification.data_json ? JSON.parse(notification.data_json) : {};
      
      // Notifikace objedn√°vek - navigace na detail
      if (notification.type && notification.type.includes('order') && data.order_id) {
        navigate(`/order-form-25?id=${data.order_id}&mode=view`);
      }
      // TODO alarmy - navigace na objedn√°vku pokud je v datech
      else if (notification.type && notification.type.includes('alarm_todo') && data.order_id) {
        navigate(`/order-form-25?id=${data.order_id}&mode=edit`);
      }
      
    } catch (error) {
      console.error('[NotificationsPage] Error parsing notification data:', error);
    }
  };

  const handleMarkAsRead = async (notificationId, e) => {
    e?.stopPropagation();
    
    try {
      // Zavolej backend API
      await markNotificationAsRead(notificationId);
      
      // Aktualizuj lok√°ln√≠ stav
      setNotifications(prev => 
        prev.map(n => n.id === notificationId ? { ...n, is_read: 1 } : n)
      );
      
      // Aktualizuj badge v menu
      if (bgTasks?.handleUnreadCountChange) {
        const currentCount = bgTasks.unreadNotificationsCount || 0;
        if (currentCount > 0) {
          bgTasks.handleUnreadCountChange(currentCount - 1);
        }
      }
      
      
    } catch (error) {
      console.error('[NotificationsPage] Failed to mark as read:', error);
      alert('Nepoda≈ôilo se oznaƒçit notifikaci jako p≈ôeƒçtenou.');
    }
  };

  const handleMarkAllRead = async () => {
    try {
      // Zavolej backend API
      await markAllNotificationsAsRead();
      
      // Aktualizuj v≈°echny jako p≈ôeƒçten√©
      setNotifications(prev => 
        prev.map(n => ({ ...n, is_read: 1 }))
      );
      
      // Aktualizuj badge na 0
      if (bgTasks?.handleUnreadCountChange) {
        bgTasks.handleUnreadCountChange(0);
      }
      
      
    } catch (error) {
      console.error('[NotificationsPage] Failed to mark all as read:', error);
      alert('Nepoda≈ôilo se oznaƒçit v≈°echny notifikace jako p≈ôeƒçten√©.');
    }
  };

  const handleDismiss = async (notificationId, e) => {
    e?.stopPropagation();
    
    try {
      console.log('[NotificationsPage] Dismiss notification:', notificationId);
      
      // Zavolej backend API
      await dismissNotification(notificationId);
      
      console.log('[NotificationsPage] Dismiss successful, updating local state to is_dismissed=1');
      
      // ‚úÖ Na str√°nce spr√°vy: NEODSTRA≈áUJ notifikaci, pouze ji oznaƒç jako skrytou
      // U≈æivatel ji uvid√≠ se statusem "Skryt√° v dropdownu"
      setNotifications(prev => {
        const updated = prev.map(n => n.id === notificationId ? { ...n, is_dismissed: 1 } : n);
        console.log('[NotificationsPage] Updated notifications after dismiss:', updated.find(n => n.id === notificationId));
        return updated;
      });
      
      // Aktualizuj badge pokud byla notifikace nep≈ôeƒçten√°
      const notification = notifications.find(n => n.id === notificationId);
      if (notification && (!notification.is_read || notification.is_read === 0)) {
        if (bgTasks?.handleUnreadCountChange) {
          const currentCount = bgTasks.unreadNotificationsCount || 0;
          if (currentCount > 0) {
            bgTasks.handleUnreadCountChange(currentCount - 1);
          }
        }
      }
      
      
    } catch (error) {
      console.error('[NotificationsPage] Failed to dismiss notification:', error);
      alert('Nepoda≈ôilo se smazat notifikaci.');
    }
  };

  // ‚úÖ RESTORE - Obnovit skrytou notifikaci (znovu zobrazit v dropdownu)
  const handleRestore = async (notificationId, e) => {
    e?.stopPropagation();
    
    try {
      // Zavolej backend API
      await restoreNotification(notificationId);
      
      // Aktualizuj lok√°ln√≠ stav - oznaƒç jako ne-skrytou
      setNotifications(prev => 
        prev.map(n => n.id === notificationId ? { ...n, is_dismissed: 0 } : n)
      );
      
      
    } catch (error) {
      console.error('[NotificationsPage] Failed to restore notification:', error);
      alert('Nepoda≈ôilo se obnovit notifikaci.');
    }
  };

  const handleDismissAll = async () => {
    try {
      // Smazat v≈°echny notifikace paralelnƒõ
      const dismissPromises = notifications.map(n => dismissNotification(n.id));
      await Promise.all(dismissPromises);
      
      // ‚úÖ Na str√°nce spr√°vy: NEODSTRA≈áUJ notifikace, pouze je oznaƒç jako skryt√©
      setNotifications(prev => 
        prev.map(n => ({ ...n, is_dismissed: 1 }))
      );
      
      // Aktualizuj badge na 0
      if (bgTasks?.handleUnreadCountChange) {
        bgTasks.handleUnreadCountChange(0);
      }
      
      
    } catch (error) {
      console.error('[NotificationsPage] Failed to dismiss all:', error);
      alert('Nepoda≈ôilo se smazat v≈°echny notifikace. Nƒõkter√© mohly b√Ωt smaz√°ny.');
      // Znovu naƒçti pro sync se skuteƒçn√Ωm stavem
      loadNotifications();
    }
  };

  
  // ‚úÖ DELETE - Smazat jednotlivou notifikaci z DB
  const handleDelete = (notificationId) => {
    setConfirmDialog({
      isOpen: true,
      title: 'Smazat notifikaci',
      message: 'Opravdu chcete trvale smazat tuto notifikaci z datab√°ze?\n\nTato akce je NEVRATN√Å!',
      confirmText: 'Smazat trvale',
      confirmVariant: 'danger',
      onConfirm: async () => {
        setConfirmDialog({ isOpen: false });
        try {
          await deleteNotification(notificationId);
          
          // Odstra≈à z lok√°ln√≠ho stavu
          setNotifications(prev => prev.filter(n => n.id !== notificationId));
          
          // Aktualizuj badge pokud byla nep≈ôeƒçten√°
          const notification = notifications.find(n => n.id === notificationId);
          if (notification && (!notification.is_read || notification.is_read === 0)) {
            if (bgTasks?.handleUnreadCountChange) {
              const currentCount = bgTasks.unreadNotificationsCount || 0;
              if (currentCount > 0) {
                bgTasks.handleUnreadCountChange(currentCount - 1);
              }
            }
          }
        } catch (error) {
          console.error('[NotificationsPage] Failed to delete notification:', error);
          setConfirmDialog({
            isOpen: true,
            title: 'Chyba',
            message: 'Nepoda≈ôilo se smazat notifikaci.\n\nZkuste to pros√≠m znovu.',
            confirmText: 'OK',
            confirmVariant: 'primary',
            onConfirm: () => setConfirmDialog({ isOpen: false }),
            onCancel: () => setConfirmDialog({ isOpen: false })
          });
        }
      },
      onCancel: () => setConfirmDialog({ isOpen: false })
    });
  };


  // ‚úÖ DELETE ALL - Smazat v≈°echny nebo filtrovan√© notifikace z DB
  const handleDeleteAll = () => {
    // Pokud je aktivn√≠ filtr, sma≈æ pouze zobrazen√© notifikace
    const hasActiveFilter = searchQuery || filterType !== 'all' || filterPriority !== 'all';
    const notificationsToDelete = hasActiveFilter ? filteredNotifications : notifications;
    const count = notificationsToDelete.length;
    const actionText = hasActiveFilter ? 'zobrazen√©' : 'V≈†ECHNY';
    
    setConfirmDialog({
      isOpen: true,
      title: hasActiveFilter ? 'Smazat zobrazen√© notifikace' : 'Smazat v≈°echny notifikace',
      message: `Opravdu chcete trvale smazat ${actionText} notifikace (${count} ks) z datab√°ze?\n\nTato akce je NEVRATN√Å a nelze ji vr√°tit zpƒõt!`,
      confirmText: hasActiveFilter ? 'Smazat zobrazen√© trvale' : 'Smazat v≈°e trvale',
      confirmVariant: 'danger',
      onConfirm: async () => {
        setConfirmDialog({ isOpen: false });
        try {
          let result;
          
          if (hasActiveFilter) {
            // Sma≈æ pouze filtrovan√© notifikace (jedna po druh√©)
            const deletePromises = notificationsToDelete.map(n => deleteNotification(n.id));
            await Promise.all(deletePromises);
            result = { deleted_count: notificationsToDelete.length };
            
            // Odstra≈à smazan√© notifikace z lok√°ln√≠ho stavu
            const deletedIds = new Set(notificationsToDelete.map(n => n.id));
            setNotifications(prev => prev.filter(n => !deletedIds.has(n.id)));
            
            // Aktualizuj badge - odeƒçti smazan√© nep≈ôeƒçten√©
            const deletedUnreadCount = notificationsToDelete.filter(n => !n.is_read || n.is_read === 0).length;
            if (deletedUnreadCount > 0 && bgTasks?.handleUnreadCountChange) {
              const currentCount = bgTasks.unreadNotificationsCount || 0;
              bgTasks.handleUnreadCountChange(Math.max(0, currentCount - deletedUnreadCount));
            }
          } else {
            // Sma≈æ v≈°echny notifikace
            result = await deleteAllNotifications();
            
            // Vyƒçisti lok√°ln√≠ stav
            setNotifications([]);
            
            // Aktualizuj badge na 0
            if (bgTasks?.handleUnreadCountChange) {
              bgTasks.handleUnreadCountChange(0);
            }
          }
          
          // ‚úÖ √öspƒõch - jen logovat do konzole, bez dialogu
          console.log(`[NotificationsPage] Successfully deleted ${result.deleted_count} notifications`);
          
        } catch (error) {
          console.error('[NotificationsPage] Failed to delete notifications:', error);
          setConfirmDialog({
            isOpen: true,
            title: 'Chyba',
            message: 'Nepoda≈ôilo se smazat notifikace.\n\nZkuste to pros√≠m znovu.',
            confirmText: 'OK',
            confirmVariant: 'primary',
            onConfirm: () => setConfirmDialog({ isOpen: false }),
            onCancel: () => setConfirmDialog({ isOpen: false })
          });
        }
      },
      onCancel: () => setConfirmDialog({ isOpen: false })
    });
  };

  const getTimeAgo = (dateString) => {
    if (!dateString) return '';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Pr√°vƒõ teƒè';
    if (diffMins < 60) return `P≈ôed ${diffMins} min`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `P≈ôed ${diffHours} h`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `P≈ôed ${diffDays} d`;
    
    return date.toLocaleDateString('cs-CZ', { 
      day: 'numeric', 
      month: 'long',
      year: 'numeric'
    });
  };

  const getPriorityIcon = (priority) => {
    switch (priority) {
      case 'urgent':
        return faExclamationCircle;
      case 'high':
        return faClock;
      default:
        return faInfoCircle;
    }
  };

  return (
    <PageContainer>
      <ContentWrapper>
        <TitlePanel>
          <TitleLeft>
            <RefreshButton 
              onClick={handleRefresh} 
              title="Obnovit data z datab√°ze"
            >
              <FontAwesomeIcon icon={faSyncAlt} />
            </RefreshButton>
          </TitleLeft>
          <PageTitle>
            Spr√°va a p≈ôehled notifikac√≠
            <FontAwesomeIcon icon={faBell} />
          </PageTitle>
        </TitlePanel>

        <PageDivider />

        <StatsBar>
          <StatCard 
            $color="#3b82f6"
            $clickable={true}
            $isActive={activeStatFilter === 'total' || (!activeStatFilter && !searchQuery && filterType === 'all' && filterPriority === 'all')}
            onClick={() => handleStatCardClick('total')}
            title="Kliknut√≠m zru≈°√≠te v≈°echny filtry"
          >
            <StatValue>{stats.total}</StatValue>
            <StatLabel>Celkem notifikac√≠</StatLabel>
          </StatCard>
          <StatCard 
            $color="#ef4444"
            $clickable={true}
            $isActive={activeStatFilter === 'unread'}
            onClick={() => handleStatCardClick('unread')}
          >
            <StatValue>{stats.unread}</StatValue>
            <StatLabel>Nep≈ôeƒçten√©</StatLabel>
          </StatCard>
          <StatCard 
            $color="#dc2626"
            $clickable={true}
            $isActive={activeStatFilter === 'urgent'}
            onClick={() => handleStatCardClick('urgent')}
          >
            <StatValue>{stats.urgent}</StatValue>
            <StatLabel>Urgentn√≠</StatLabel>
          </StatCard>
          <StatCard 
            $color="#f59e0b"
            $clickable={true}
            $isActive={activeStatFilter === 'high'}
            onClick={() => handleStatCardClick('high')}
          >
            <StatValue>{stats.high}</StatValue>
            <StatLabel>Vysok√° priorita</StatLabel>
          </StatCard>
        </StatsBar>

        <ToolbarContainer>
          <SearchBox>
            <SearchIcon>
              <FontAwesomeIcon icon={faSearch} />
            </SearchIcon>
            <SearchInput
              type="text"
              placeholder="Hledat v notifikac√≠ch..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
            {searchQuery && (
              <ClearSearchButton onClick={() => setSearchQuery('')} title="Vymazat">
                <FontAwesomeIcon icon={faTimes} />
              </ClearSearchButton>
            )}
          </SearchBox>

          <FilterGroup>
            <FilterButton
              $active={filterType === 'all'}
              onClick={() => setFilterType('all')}
            >
              V≈°echny
            </FilterButton>
            <FilterButton
              $active={filterType === 'unread'}
              onClick={() => setFilterType('unread')}
            >
              Nep≈ôeƒçten√©
            </FilterButton>
            <FilterButton
              $active={filterType === 'read'}
              onClick={() => setFilterType('read')}
            >
              P≈ôeƒçten√©
            </FilterButton>
          </FilterGroup>

          <FilterGroup>
            <FilterButton
              $active={filterPriority === 'all'}
              onClick={() => setFilterPriority('all')}
            >
              <FontAwesomeIcon icon={faFilter} />
              V≈°echny priority
            </FilterButton>
            <FilterButton
              $active={filterPriority === 'urgent'}
              onClick={() => setFilterPriority('urgent')}
            >
              Urgentn√≠
            </FilterButton>
            <FilterButton
              $active={filterPriority === 'high'}
              onClick={() => setFilterPriority('high')}
            >
              Vysok√°
            </FilterButton>
            <FilterButton
              $active={filterPriority === 'normal'}
              onClick={() => setFilterPriority('normal')}
            >
              Norm√°ln√≠
            </FilterButton>
          </FilterGroup>

          <div style={{ marginLeft: 'auto', display: 'flex', gap: '8px' }}>
            {stats.unread > 0 && (
              <ActionButton
                $variant="success"
                onClick={handleMarkAllRead}
              >
                <FontAwesomeIcon icon={faCheckDouble} />
                Oznaƒçit v≈°e jako p≈ôeƒçten√©
              </ActionButton>
            )}
            {notifications.length > 0 && (
              <ActionButton
                $variant="warning"
                onClick={handleDismissAll}
              >
                <FontAwesomeIcon icon={faEyeSlash} />
                Skr√Ωt v≈°e z menu
              </ActionButton>
            )}
            {notifications.length > 0 && (() => {
              const hasActiveFilter = searchQuery || filterType !== 'all' || filterPriority !== 'all';
              const count = hasActiveFilter ? filteredNotifications.length : notifications.length;
              const buttonText = hasActiveFilter ? `Smazat zobrazen√© (${count})` : 'Smazat v≈°e trvale';
              
              return (
                <ActionButton
                  $variant="danger"
                  onClick={handleDeleteAll}
                  title={hasActiveFilter ? `Sma≈æe ${count} zobrazen√Ωch notifikac√≠` : `Sma≈æe v≈°echny notifikace (${count} ks)`}
                >
                  <FontAwesomeIcon icon={faTrash} />
                  {buttonText}
                </ActionButton>
              );
            })()}
          </div>
        </ToolbarContainer>

        <NotificationsList>
          {error ? (
            <EmptyState>
              <EmptyIcon>‚ùå</EmptyIcon>
              <EmptyText>Chyba p≈ôi naƒç√≠t√°n√≠</EmptyText>
              <EmptySubtext>{error}</EmptySubtext>
              <ActionButton
                style={{ marginTop: '16px' }}
                onClick={loadNotifications}
              >
                Zkusit znovu
              </ActionButton>
            </EmptyState>
          ) : loading ? (
            <LoadingState>
              <div style={{ fontSize: '32px', marginBottom: '16px' }}>‚è≥</div>
              Naƒç√≠t√°n√≠ notifikac√≠...
            </LoadingState>
          ) : filteredNotifications.length === 0 ? (
            <EmptyState>
              <EmptyIcon>üîî</EmptyIcon>
              <EmptyText>
                {searchQuery || filterType !== 'all' || filterPriority !== 'all'
                  ? '≈Ω√°dn√© notifikace neodpov√≠daj√≠ filtr≈Øm'
                  : '≈Ω√°dn√© notifikace'
                }
              </EmptyText>
              <EmptySubtext>
                {searchQuery || filterType !== 'all' || filterPriority !== 'all'
                  ? 'Zkuste zmƒõnit filtry nebo vyhled√°v√°n√≠'
                  : 'Budete informov√°ni o nov√Ωch ud√°lostech'
                }
              </EmptySubtext>
            </EmptyState>
          ) : (
            filteredNotifications.map((notification, index) => {
              const isUnread = !notification.is_read || notification.is_read === 0 || notification.is_read === false;
              const isDismissed = notification.is_dismissed === 1 || notification.is_dismissed === true;
              const priority = notification.priority || 'normal';
              
              // ‚úÖ Parse data_json if exists
              let notificationData = {};
              try {
                if (notification.data_json) {
                  notificationData = typeof notification.data_json === 'string' 
                    ? JSON.parse(notification.data_json) 
                    : notification.data_json;
                } else if (notification.data) {
                  notificationData = notification.data;
                }
              } catch (error) {
                console.error('[NotificationsPage] Failed to parse data_json:', error);
                notificationData = notification.data || {};
              }
              
              // ‚úÖ Attach parsed data to notification object for rendering
              notification.data = notificationData;
              
              return (
                <NotificationItem
                  key={notification.id}
                  $index={index}
                  $isUnread={isUnread}
                  $priority={priority}
                  onClick={() => handleNotificationClick(notification)}
                >
                  <NotificationIcon $priority={priority}>
                    {notification.icon ? notification.icon : <FontAwesomeIcon icon={getPriorityIcon(priority)} />}
                  </NotificationIcon>
                  <NotificationContent>
                    <NotificationHeader>
                      <NotificationTitle $isUnread={isUnread}>
                        {notification.title}
                      </NotificationTitle>
                    </NotificationHeader>
                    {notification.message && (
                      <NotificationMessage>
                        {notification.message}
                      </NotificationMessage>
                    )}
                    
                    {/* ÔøΩ TODO pozn√°mka */}
                    {notification.data?.note && (
                      <div style={{
                        fontSize: '0.85rem',
                        color: '#475569',
                        fontStyle: 'italic',
                        marginTop: '0.5rem',
                        padding: '0.625rem 0.75rem',
                        background: '#f8fafc',
                        borderLeft: '3px solid #cbd5e1',
                        borderRadius: '4px'
                      }}>
                        <strong style={{ fontStyle: 'normal', color: '#64748b' }}>üìù Pozn√°mka:</strong>{' '}
                        {notification.data.note}
                      </div>
                    )}
                    
                    {/* Detaily objedn√°vky - KOMPAKTN√ç */}
                    {notification.type?.includes('order') && notification.data && (
                      <div style={{
                        marginTop: '0.5rem',
                        padding: '0.5rem',
                        background: 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)',
                        borderRadius: '6px',
                        border: '1px solid #e2e8f0',
                        color: '#334155',
                        fontSize: '0.75rem'
                      }}>
                        {/* P≈ôedmƒõt a cena - jedno≈ô√°dkovƒõ */}
                        <div style={{ 
                          display: 'flex',
                          flexWrap: 'wrap',
                          gap: '0.5rem',
                          marginBottom: notification.data.action_performed_by ? '0.4rem' : '0',
                          fontSize: '0.75rem'
                        }}>
                          {notification.data.order_subject && (
                            <div style={{ 
                              flex: '1 1 auto',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.3rem',
                              minWidth: '60%'
                            }}>
                              <span style={{ fontSize: '0.85rem' }}>üìã</span>
                              <span style={{ 
                                fontWeight: '600',
                                color: '#1e293b',
                                overflow: 'hidden',
                                textOverflow: 'ellipsis',
                                whiteSpace: 'nowrap'
                              }}>
                                {notification.data.order_subject}
                              </span>
                            </div>
                          )}
                          {notification.data.max_price && (
                            <div style={{ 
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.3rem',
                              padding: '0.15rem 0.5rem',
                              background: '#fef3c7',
                              borderRadius: '4px',
                              whiteSpace: 'nowrap'
                            }}>
                              <span style={{ fontSize: '0.8rem' }}>ÔøΩ</span>
                              <strong style={{ fontSize: '0.75rem', color: '#92400e' }}>
                                {notification.data.max_price} Kƒç
                              </strong>
                            </div>
                          )}
                        </div>
                        
                        {/* Osoba a datum - jedno≈ô√°dkovƒõ */}
                        {notification.data.action_performed_by && (
                          <div style={{ 
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            fontSize: '0.7rem',
                            color: '#64748b'
                          }}>
                            <span>üë§ <strong style={{ color: '#475569' }}>{notification.data.action_performed_by}</strong></span>
                            {notification.data.action_date && (
                              <>
                                <span style={{ color: '#cbd5e1' }}>‚Ä¢</span>
                                <span>üìÖ {notification.data.action_date}</span>
                              </>
                            )}
                          </div>
                        )}
                      </div>
                    )}
                    
                    <NotificationMeta>
                      <MetaItem>
                        <FontAwesomeIcon icon={faClock} style={{ fontSize: '12px' }} />
                        {getTimeAgo(notification.dt_created || notification.created_at)}
                      </MetaItem>
                      {notification.category && (
                        <TypeBadge $type={notification.category}>
                          {getCategoryLabel(notification.category)}
                        </TypeBadge>
                      )}
                      {notification.from_user_name && (
                        <MetaItem>
                          Od: {notification.from_user_name}
                        </MetaItem>
                      )}
                      {/* ‚úÖ Badge pro skryt√© notifikace */}
                      {isDismissed && (
                        <TypeBadge style={{ background: '#fee2e2', color: '#991b1b', fontWeight: 700 }}>
                          üö´ Skryt√° v dropdownu
                        </TypeBadge>
                      )}
                    </NotificationMeta>
                  </NotificationContent>
                  <NotificationActions>
                    {isUnread && (
                      <IconButton
                        onClick={(e) => handleMarkAsRead(notification.id, e)}
                        title="Oznaƒçit jako p≈ôeƒçten√©"
                      >
                        <FontAwesomeIcon icon={faCheck} />
                      </IconButton>
                    )}
                    {/* ‚úÖ Pokud je dismissed, nab√≠dnout OBNOVEN√ç m√≠sto skryt√≠ */}
                    {isDismissed ? (
                      <IconButton
                        onClick={(e) => handleRestore(notification.id, e)}
                        title="Obnovit v dropdownu"
                        style={{ color: '#16a34a', borderColor: '#16a34a' }}
                      >
                        <FontAwesomeIcon icon={faUndo} />
                      </IconButton>
                    ) : (
                      <IconButton
                        onClick={(e) => handleDismiss(notification.id, e)}
                        title="Skr√Ωt z menu (z≈Østane v datab√°zi)"
                      >
                        <FontAwesomeIcon icon={faEyeSlash} />
                      </IconButton>
                    )}
                    {/* ‚úÖ Tlaƒç√≠tko pro trval√© smaz√°n√≠ z datab√°ze */}
                    <IconButton
                      onClick={(e) => {
                        e.stopPropagation();
                        handleDelete(notification.id);
                      }}
                      title="Smazat trvale z datab√°ze"
                      style={{ color: '#dc2626', borderColor: '#dc2626' }}
                    >
                      <FontAwesomeIcon icon={faTrash} />
                    </IconButton>
                  </NotificationActions>
                </NotificationItem>
              );
            })
          )}
        </NotificationsList>
      </ContentWrapper>

      {/* ‚úÖ Confirm Dialog */}
      <ConfirmDialog
        isOpen={confirmDialog.isOpen}
        title={confirmDialog.title}
        message={confirmDialog.message}
        confirmText={confirmDialog.confirmText}
        confirmVariant={confirmDialog.confirmVariant}
        onConfirm={confirmDialog.onConfirm}
        onCancel={confirmDialog.onCancel}
      />
    </PageContainer>
  );
};

export default NotificationsPage;
