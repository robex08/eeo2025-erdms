<?php
/**
 * Order V2 Endpoints - Standardized API Implementation
 * 
 * NovÃ© API endpointy s prefixem /order-v2/ podle standardizaÄnÃ­ho dokumentu.
 * ZachovÃ¡vÃ¡ zpÄ›tnou kompatibilitu - nemodifikuje stÃ¡vajÃ­cÃ­ /orders25/ endpointy.
 * 
 * Endpoints:
 * - GET /api/order-v2/{id} - NaÄtenÃ­ objednÃ¡vky podle ID
 * - GET /api/order-v2/list - Listing objednÃ¡vek s filtering
 * - POST /api/order-v2 - VytvoÅ™enÃ­ novÃ© objednÃ¡vky  
 * - PUT /api/order-v2/{id} - Update objednÃ¡vky
 * - DELETE /api/order-v2/{id} - SmazÃ¡nÃ­ objednÃ¡vky
 * 
 * @author Senior Developer
 * @date 29. Å™Ã­jna 2025
 */

require_once __DIR__ . '/orderQueries.php';
require_once __DIR__ . '/OrderV2Handler.php';

/**
 * GET /api/order-v2/{id}
 * NaÄtenÃ­ objednÃ¡vky podle ID s standardizovanÃ½m vÃ½stupem
 */
function handle_order_v2_get($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu - V2 authentication pattern
    $username = isset($input['username']) ? $input['username'] : '';
    $token = isset($input['token']) ? $input['token'] : '';
    $order_id = isset($input['id']) ? (int)$input['id'] : 0;
    
    // Connect to database for token verification
    $db = new mysqli($config['host'], $config['username'], $config['password'], $config['database']);
    if ($db->connect_error) {
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Database connection failed'));
        return;
    }
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        $db->close();
        return;
    }
    
    if ($order_id <= 0) {
        http_response_code(400);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ© ID objednÃ¡vky'));
        return;
    }
    
    try {
        $handler = new OrderV2Handler($config);
        $current_user_id = $auth_result['id'];
        
        // VolitelnÃ½ parametr archivovano
        $includeArchived = isset($input['archivovano']) && $input['archivovano'] == 1;
        
        $order = $handler->getOrderById($order_id, $current_user_id, $includeArchived);
        
        if (!$order) {
            http_response_code(404);
            echo json_encode(array('status' => 'error', 'message' => 'ObjednÃ¡vka nebyla nalezena'));
            return;
        }
        
        // VolitelnÃ½ enrichment (pokud parametr enriched=1)
        if (isset($input['enriched']) && $input['enriched'] == 1) {
            $db = get_db($config);
            enrichOrderWithItems($db, $order);
            enrichOrderWithInvoices($db, $order);
            enrichOrderWithCodebooks($db, $order);
        }
        
        require_once __DIR__ . '/TimezoneHelper.php';
        echo json_encode(array(
            'status' => 'ok',
            'data' => $order,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 GET Error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i naÄÃ­tÃ¡nÃ­ objednÃ¡vky: ' . $e->getMessage()));
    }
}

/**
 * GET /api/order-v2/list
 * Listing objednÃ¡vek s filtering a pagination
 */
function handle_order_v2_list($input, $config, $queries) {
    // ğŸ”¥ FINAL: Full implementation with detailed error logging
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    try {
        error_log("Order V2 LIST: Starting with user " . $auth_result['id']);
        
        $current_user_id = $auth_result['id'];
        $handler = new OrderV2Handler($config);
        
        // Pagination parametry
        $limit = isset($input['limit']) ? (int)$input['limit'] : 20;
        $offset = isset($input['offset']) ? (int)$input['offset'] : 0;
        
        error_log("Order V2 LIST: Pagination - limit: $limit, offset: $offset");
        
        // Filtering parametry
        $params = array();
        
        // ZÃ¡kladnÃ­ WHERE podmÃ­nka
        $whereConditions = array();
        
        // Filter: aktivni objednÃ¡vky (default)
        if (!isset($input['archivovano']) || $input['archivovano'] != 1) {
            $whereConditions[] = "o.aktivni = 1";
        }
        
        error_log("Order V2 LIST: Basic filters applied, whereConditions: " . json_encode($whereConditions));
        
        // SestavenÃ­ WHERE klauzule
        $whereClause = '';
        if (!empty($whereConditions)) {
            $whereClause = 'WHERE ' . implode(' AND ', $whereConditions);
        }
        
        // PÅ™ipojenÃ­ k databÃ¡zi pro business logiku
        $db = get_db($config);
        
        // HlavnÃ­ dotaz pro data
        $sql = "SELECT o.*
                FROM " . get_orders_table_name() . " o
                {$whereClause}
                ORDER BY o.dt_vytvoreni DESC
                LIMIT :limit OFFSET :offset";
        
        error_log("Order V2 LIST: SQL query: " . $sql);
        
        $stmt = $db->prepare($sql);
        
        // Bind pagination parametry
        $stmt->bindValue(':limit', $limit, PDO::PARAM_INT);
        $stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
        
        // Bind filter parametry
        foreach ($params as $key => $value) {
            $stmt->bindValue(':' . $key, $value);
        }
        
        error_log("Order V2 LIST: Executing query...");
        $stmt->execute();
        $orders = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        error_log("Order V2 LIST: Found " . count($orders) . " orders");
        
        // Count dotaz
        $countSql = "SELECT COUNT(*) as total FROM " . get_orders_table_name() . " o {$whereClause}";
        $countStmt = $db->prepare($countSql);
        
        foreach ($params as $key => $value) {
            $countStmt->bindValue(':' . $key, $value);
        }
        
        $countStmt->execute();
        $totalCount = $countStmt->fetch(PDO::FETCH_ASSOC)['total'];
        
        error_log("Order V2 LIST: Total count: " . $totalCount);
        
        // Standardizace vÃ½stupu pomocÃ­ OrderV2Handler
        $standardizedOrders = array();
        foreach ($orders as $order) {
            $standardizedOrders[] = $handler->transformFromDB($order);
        }
        
        error_log("Order V2 LIST: Standardized " . count($standardizedOrders) . " orders");
        
        require_once __DIR__ . '/TimezoneHelper.php';
        echo json_encode(array(
            'status' => 'ok',
            'data' => $standardizedOrders,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'pagination' => array(
                    'total' => (int)$totalCount,
                    'limit' => $limit,
                    'offset' => $offset,
                    'has_more' => ($offset + $limit) < $totalCount
                ),
                'filters_applied' => count($params),
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 LIST Error: " . $e->getMessage() . " in " . $e->getFile() . " on line " . $e->getLine());
        error_log("Order V2 LIST Stack trace: " . $e->getTraceAsString());
        http_response_code(500);
        echo json_encode(array(
            'status' => 'error', 
            'message' => 'Chyba pÅ™i naÄÃ­tÃ¡nÃ­ seznamu objednÃ¡vek: ' . $e->getMessage(),
            'debug_info' => array(
                'file' => $e->getFile(),
                'line' => $e->getLine(),
                'trace' => $e->getTraceAsString()
            )
        ));
    }
    
    /* COMMENTED OUT FOR DEBUG
    // OvÄ›Å™enÃ­ tokenu
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    try {
        $current_user_id = $auth_result['id'];
        $handler = new OrderV2Handler($config);
        
        // Pagination parametry
        $limit = isset($input['limit']) ? (int)$input['limit'] : 20;
        $offset = isset($input['offset']) ? (int)$input['offset'] : 0;
        
        // Filtering parametry
        $filters = array();
    END DEBUG COMMENT */
    
    /* COMMENTED OUT - entire function body for debug
        $params = array();
        
        // ZÃ¡kladnÃ­ WHERE podmÃ­nka
        $whereConditions = array();
        
        // Filter: aktivni objednÃ¡vky (default)
        if (!isset($input['archivovano']) || $input['archivovano'] != 1) {
            $whereConditions[] = "o.aktivni = 1";
        }
        
        // Filter: podle uÅ¾ivatele
        if (isset($input['uzivatel_id']) && is_numeric($input['uzivatel_id'])) {
            $whereConditions[] = "(o.objednatel_id = :uzivatel_id OR o.garant_uzivatel_id = :uzivatel_id)";
            $params['uzivatel_id'] = (int)$input['uzivatel_id'];
        }
        
        // Filter: podle stavu workflow
        if (isset($input['stav']) && !empty($input['stav'])) {
            $whereConditions[] = "JSON_CONTAINS(o.stav_workflow_kod, :stav_json)";
            $params['stav_json'] = json_encode($input['stav']);
        }
        
        // Filter: podle druhu objednÃ¡vky
        if (isset($input['druh']) && !empty($input['druh'])) {
            $whereConditions[] = "o.druh_objednavky_kod = :druh";
            $params['druh'] = $input['druh'];
        }
        
        // Filter: podle stÅ™ediska
        if (isset($input['stredisko']) && !empty($input['stredisko'])) {
            $whereConditions[] = "JSON_CONTAINS(o.strediska_kod, :stredisko_json)";
            $params['stredisko_json'] = json_encode($input['stredisko']);
        }
        
        // Filter: podle data od-do
        if (isset($input['datum_od']) && !empty($input['datum_od'])) {
            $whereConditions[] = "DATE(o.dt_objednavky) >= :datum_od";
            $params['datum_od'] = $input['datum_od'];
        }
        
        if (isset($input['datum_do']) && !empty($input['datum_do'])) {
            $whereConditions[] = "DATE(o.dt_objednavky) <= :datum_do";
            $params['datum_do'] = $input['datum_do'];
        }
        
        // SestavenÃ­ WHERE klauzule
        $whereClause = '';
        if (!empty($whereConditions)) {
            $whereClause = 'WHERE ' . implode(' AND ', $whereConditions);
        }
        
        // PÅ™ipojenÃ­ k databÃ¡zi pro business logiku
        $db = get_db($config);
        
        // HlavnÃ­ dotaz pro data
        $sql = "SELECT o.*
                FROM " . get_orders_table_name() . " o
                {$whereClause}
                ORDER BY o.dt_vytvoreni DESC
                LIMIT :limit OFFSET :offset";
        
        $stmt = $db->prepare($sql);
        
        // Bind parametry
        foreach ($params as $key => $value) {
            $stmt->bindValue(':' . $key, $value);
        }
        $stmt->bindValue(':limit', $limit, PDO::PARAM_INT);
        $stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
        
        $stmt->execute();
        $rawOrders = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // Dotaz pro celkovÃ½ poÄet (bez LIMIT)
        $countSql = "SELECT COUNT(*) as total
                     FROM " . get_orders_table_name() . " o
                     {$whereClause}";
        
        $countStmt = $db->prepare($countSql);
        foreach ($params as $key => $value) {
            $countStmt->bindValue(':' . $key, $value);
        }
        $countStmt->execute();
        $totalCount = $countStmt->fetch(PDO::FETCH_ASSOC)['total'];
        
        // Transformace dat do standardizovanÃ©ho formÃ¡tu
        $orders = array();
        foreach ($rawOrders as $rawOrder) {
            $standardOrder = $handler->transformFromDB($rawOrder);
            
            // VolitelnÃ½ enrichment pro listing (pokud parametr enriched=1)
            if (isset($input['enriched']) && $input['enriched'] == 1) {
                enrichOrderWithItems($db, $standardOrder);
                enrichOrderWithInvoices($db, $standardOrder);
                enrichOrderWithCodebooks($db, $standardOrder);
            }
            
            $orders[] = $standardOrder;
        }
        
        echo json_encode(array(
            'status' => 'ok',
            'data' => $orders,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'pagination' => array(
                    'total' => (int)$totalCount,
                    'limit' => $limit,
                    'offset' => $offset,
                    'has_more' => ($offset + $limit) < $totalCount
                ),
                'filters_applied' => count($params),
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    END COMMENTED OUT FUNCTION BODY */
        
    /* COMMENTED OUT FOR DEBUG - catch block
    } catch (Exception $e) {
        error_log("Order V2 LIST Error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i naÄÃ­tÃ¡nÃ­ seznamu objednÃ¡vek: ' . $e->getMessage()));
    }
    END DEBUG COMMENT */
}

/**
 * POST /api/order-v2
 * VytvoÅ™enÃ­ novÃ© objednÃ¡vky se standardizovanÃ½mi daty
 */
function handle_order_v2_create($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    try {
        $handler = new OrderV2Handler($config);
        
        // AUTOMATICKÃ‰ GENEROVÃNÃ ÄŒÃSLA OBJEDNÃVKY pokud nenÃ­ zadÃ¡no
        if (empty($input['cislo_objednavky'])) {
            $numberData = $handler->generateNextOrderNumber($username);
            if (!$numberData) {
                http_response_code(400);
                echo json_encode(array(
                    'status' => 'error',
                    'message' => 'NepodaÅ™ilo se vygenerovat ÄÃ­slo objednÃ¡vky - uÅ¾ivatel nemÃ¡ pÅ™iÅ™azenou organizaci/Ãºsek'
                ));
                return;
            }
            // PÅ™idej vygenerovanÃ© ÄÃ­slo do inputu
            $input['cislo_objednavky'] = $numberData['next_order_string'];
        }
        
        // Validace vstupnÃ­ch dat
        $validation = $handler->validateOrderData($input);
        if (!$validation['valid']) {
            http_response_code(400);
            echo json_encode(array(
                'status' => 'error', 
                'message' => 'Chyba validace dat',
                'errors' => $validation['errors']
            ));
            return;
        }
        
        // Transformace dat pro DB
        $dbData = $handler->transformToDB($input);
        
        // AutomatickÃ© nastavenÃ­ - opraveno timezone handling
        require_once __DIR__ . '/TimezoneHelper.php';
        TimezoneHelper::setMysqlTimezone($db);
        $dbData['dt_vytvoreni'] = TimezoneHelper::getCzechDateTime();
        $dbData['aktivni'] = 1;
        
        // SestavenÃ­ INSERT dotazu
        $fields = array();
        $placeholders = array();
        $values = array();
        
        foreach ($dbData as $key => $value) {
            if ($key !== 'id') { // ID je auto-increment
                $fields[] = "`{$key}`";
                $placeholders[] = ":{$key}";
                $values[$key] = $value;
            }
        }
        
        $sql = "INSERT INTO " . get_orders_table_name() . " (" . implode(', ', $fields) . ") 
                VALUES (" . implode(', ', $placeholders) . ")";
        
        $db = get_db($config);
        $stmt = $db->prepare($sql);
        
        foreach ($values as $key => $value) {
            $stmt->bindValue(":{$key}", $value);
        }
        
        $stmt->execute();
        $newOrderId = $db->lastInsertId();
        
        // NaÄtenÃ­ vytvoÅ™enÃ© objednÃ¡vky ve standardizovanÃ©m formÃ¡tu
        $newOrder = $handler->getOrderById($newOrderId, $auth_result['id']);
        
        echo json_encode(array(
            'status' => 'ok',
            'message' => 'ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› vytvoÅ™ena',
            'data' => $newOrder,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'created_id' => (int)$newOrderId,
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 CREATE Error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i vytvÃ¡Å™enÃ­ objednÃ¡vky: ' . $e->getMessage()));
    }
}

/**
 * PUT /api/order-v2/{id}
 * Update objednÃ¡vky se standardizovanÃ½mi daty
 */
function handle_order_v2_update($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    $order_id = isset($input['id']) ? (int)$input['id'] : 0;
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    
    if ($order_id <= 0) {
        http_response_code(400);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ© ID objednÃ¡vky'));
        return;
    }
    
    try {
        $handler = new OrderV2Handler($config);
        $current_user_id = $auth_result['id'];
        
        // OvÄ›Å™ Å¾e objednÃ¡vka existuje
        $existingOrder = $handler->getOrderById($order_id, $current_user_id);
        if (!$existingOrder) {
            http_response_code(404);
            echo json_encode(array('status' => 'error', 'message' => 'ObjednÃ¡vka nebyla nalezena'));
            return;
        }
        
        // Kontrola lock stavu
        if ($existingOrder['lock_info']['locked'] === true) {
            http_response_code(423); // Locked
            echo json_encode(array(
                'status' => 'error', 
                'message' => 'ObjednÃ¡vka je zamÄenÃ¡ jinÃ½m uÅ¾ivatelem',
                'lock_info' => $existingOrder['lock_info']
            ));
            return;
        }
        
        // Validace vstupnÃ­ch dat (pro UPDATE - partial update povoleno)
        $validation = $handler->validateOrderDataForUpdate($input);
        if (!$validation['valid']) {
            http_response_code(400);
            echo json_encode(array(
                'status' => 'error', 
                'message' => 'Chyba validace dat pro UPDATE',
                'errors' => $validation['errors']
            ));
            return;
        }
        
        // Transformace dat pro DB
        $dbData = $handler->transformToDB($input);
        
        $db = get_db($config);
        $db->beginTransaction();
        
        // AutomatickÃ© nastavenÃ­ - timezone handling PO inicializaci DB
        require_once __DIR__ . '/TimezoneHelper.php';
        TimezoneHelper::setMysqlTimezone($db);
        $dbData['dt_aktualizace'] = TimezoneHelper::getCzechDateTime();
        // $dbData['uzivatel_akt_id'] = $current_user_id; // Commented out - sloupec moÅ¾nÃ¡ neexistuje v produkci
        
        try {
            // ========== UPDATE HLAVNÃ OBJEDNÃVKY ==========
            $setParts = array();
            $values = array();
            
            foreach ($dbData as $key => $value) {
                if ($key !== 'id') { // ID nemÄ›nÃ­me
                    $setParts[] = "`{$key}` = :{$key}";
                    $values[$key] = $value;
                }
            }
            
            $sql = "UPDATE " . get_orders_table_name() . " SET " . implode(', ', $setParts) . " WHERE id = :id";
            $values['id'] = $order_id;
            
            $stmt = $db->prepare($sql);
            foreach ($values as $key => $value) {
                $stmt->bindValue(":{$key}", $value);
            }
            $stmt->execute();
            
            // ========== UPDATE POLOÅ½EK OBJEDNÃVKY ==========
            // ZpracovÃ¡nÃ­ poloÅ¾ek podle vzoru z Order25 (saveOrderItems pattern)
            $items_processed = 0;
            $items_updated = false;
            
            // Kontrola, zda jsou v input datech poloÅ¾ky k aktualizaci
            if (array_key_exists('polozky', $input) || array_key_exists('polozky_objednavky', $input)) {
                // Validace a parsovÃ¡nÃ­ poloÅ¾ek
                $order_items = validateAndParseOrderItems($input);
                if ($order_items !== false) {
                    // saveOrderItems pattern: smaÅ¾ stÃ¡vajÃ­cÃ­ + vloÅ¾ novÃ©
                    if (saveOrderV2Items($db, $order_id, $order_items)) {
                        $items_processed = count($order_items);
                        $items_updated = true;
                    } else {
                        throw new Exception('Chyba pÅ™i aktualizaci poloÅ¾ek objednÃ¡vky');
                    }
                } else {
                    throw new Exception('NevalidnÃ­ formÃ¡t poloÅ¾ek objednÃ¡vky');
                }
            }
            
            // ========== ZPRACOVÃNÃ FAKTUR V2 ==========
            // Frontend mÅ¯Å¾e poslat pole faktur podle vzoru Order25:
            // - Pokud mÃ¡ faktura id=null nebo chybÃ­ â†’ CREATE novÃ© faktury
            // - Pokud mÃ¡ faktura id (number) â†’ UPDATE existujÃ­cÃ­ faktury
            // - PÅ™Ã­lohy se spravujÃ­ separÃ¡tnÄ› v invoice attachments API
            
            $invoices_processed = 0;
            $invoices_updated = false;
            
            if (isset($input['faktury']) && is_array($input['faktury'])) {
                $faktury_table = get_invoices_table_name(); // 25a_objednavky_faktury
                
                foreach ($input['faktury'] as $faktura) {
                    $faktura_id = isset($faktura['id']) ? (int)$faktura['id'] : null;
                    
                    if ($faktura_id === null || $faktura_id === 0) {
                        // ========== CREATE novÃ¡ faktura ==========
                        $fa_castka = isset($faktura['fa_castka']) ? $faktura['fa_castka'] : null;
                        $fa_cislo_vema = isset($faktura['fa_cislo_vema']) ? trim($faktura['fa_cislo_vema']) : '';
                        
                        if (!$fa_castka || empty($fa_cislo_vema)) {
                            continue; // PÅ™eskoÄ neplatnou fakturu
                        }
                        
                        // Zpracuj fa_strediska_kod - array â†’ JSON, string â†’ pÅ™Ã­mo (PHP 5.6)
                        $fa_strediska_value = null;
                        if (isset($faktura['fa_strediska_kod'])) {
                            if (is_array($faktura['fa_strediska_kod'])) {
                                $fa_strediska_value = json_encode($faktura['fa_strediska_kod']);
                            } else {
                                $fa_strediska_value = $faktura['fa_strediska_kod'];
                            }
                        }
                        
                        // Zpracuj rozsirujici_data - array â†’ JSON, string â†’ pÅ™Ã­mo (PHP 5.6)
                        $rozsirujici_value = null;
                        if (isset($faktura['rozsirujici_data'])) {
                            if (is_array($faktura['rozsirujici_data'])) {
                                $rozsirujici_value = json_encode($faktura['rozsirujici_data']);
                            } else {
                                $rozsirujici_value = $faktura['rozsirujici_data'];
                            }
                        }
                        
                        // MySQL 5.5.43 kompatibilnÃ­ INSERT
                        $sql_insert = "INSERT INTO `{$faktury_table}` (
                            objednavka_id,
                            fa_dorucena,
                            fa_castka,
                            fa_cislo_vema,
                            fa_datum_vystaveni,
                            fa_datum_splatnosti,
                            fa_datum_doruceni,
                            fa_strediska_kod,
                            fa_poznamka,
                            rozsirujici_data,
                            vytvoril_uzivatel_id,
                            dt_vytvoreni,
                            aktivni
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), 1)";
                        
                        $stmt_insert = $db->prepare($sql_insert);
                        $stmt_insert->execute(array(
                            $order_id,
                            isset($faktura['fa_dorucena']) ? (int)$faktura['fa_dorucena'] : 0,
                            $fa_castka,
                            $fa_cislo_vema,
                            isset($faktura['fa_datum_vystaveni']) ? $faktura['fa_datum_vystaveni'] : null,
                            isset($faktura['fa_datum_splatnosti']) ? $faktura['fa_datum_splatnosti'] : null,
                            isset($faktura['fa_datum_doruceni']) ? $faktura['fa_datum_doruceni'] : null,
                            $fa_strediska_value,
                            isset($faktura['fa_poznamka']) ? $faktura['fa_poznamka'] : null,
                            $rozsirujici_value,
                            $current_user_id
                        ));
                        
                        $invoices_processed++;
                        $invoices_updated = true;
                        
                    } else {
                        // ========== UPDATE existujÃ­cÃ­ faktura ==========
                        $update_fields = array();
                        $update_values = array();
                        
                        // Pouze zadanÃ© hodnoty budou aktualizovÃ¡ny (PHP 5.6 array syntax)
                        if (isset($faktura['fa_castka'])) {
                            $update_fields[] = 'fa_castka = ?';
                            $update_values[] = $faktura['fa_castka'];
                        }
                        if (isset($faktura['fa_cislo_vema'])) {
                            $update_fields[] = 'fa_cislo_vema = ?';
                            $update_values[] = trim($faktura['fa_cislo_vema']);
                        }
                        if (isset($faktura['fa_dorucena'])) {
                            $update_fields[] = 'fa_dorucena = ?';
                            $update_values[] = (int)$faktura['fa_dorucena'];
                        }
                        if (isset($faktura['fa_datum_vystaveni'])) {
                            $update_fields[] = 'fa_datum_vystaveni = ?';
                            $update_values[] = $faktura['fa_datum_vystaveni'];
                        }
                        if (isset($faktura['fa_datum_splatnosti'])) {
                            $update_fields[] = 'fa_datum_splatnosti = ?';
                            $update_values[] = $faktura['fa_datum_splatnosti'];
                        }
                        if (isset($faktura['fa_datum_doruceni'])) {
                            $update_fields[] = 'fa_datum_doruceni = ?';
                            $update_values[] = $faktura['fa_datum_doruceni'];
                        }
                        
                        // ZpracovÃ¡nÃ­ JSON polÃ­ pro UPDATE
                        if (isset($faktura['fa_strediska_kod'])) {
                            $update_fields[] = 'fa_strediska_kod = ?';
                            if (is_array($faktura['fa_strediska_kod'])) {
                                $update_values[] = json_encode($faktura['fa_strediska_kod']);
                            } else {
                                $update_values[] = $faktura['fa_strediska_kod'];
                            }
                        }
                        
                        if (isset($faktura['rozsirujici_data'])) {
                            $update_fields[] = 'rozsirujici_data = ?';
                            if (is_array($faktura['rozsirujici_data'])) {
                                $update_values[] = json_encode($faktura['rozsirujici_data']);
                            } else {
                                $update_values[] = $faktura['rozsirujici_data'];
                            }
                        }
                        
                        if (isset($faktura['fa_poznamka'])) {
                            $update_fields[] = 'fa_poznamka = ?';
                            $update_values[] = $faktura['fa_poznamka'];
                        }
                        
                        // Pokud jsou nÄ›jakÃ¡ pole k aktualizaci
                        if (!empty($update_fields)) {
                            // AutomatickÃ© pole
                            $update_fields[] = 'dt_aktualizace = NOW()';
                            // $update_fields[] = 'uzivatel_akt_id = ?'; // Commented out - sloupec moÅ¾nÃ¡ neexistuje v produkci
                            // $update_values[] = $current_user_id;
                            
                            // ID faktury na konec
                            $update_values[] = $faktura_id;
                            
                            // MySQL 5.5.43 kompatibilnÃ­ UPDATE
                            $sql_update = "UPDATE `{$faktury_table}` SET " . implode(', ', $update_fields) . " WHERE id = ?";
                            $stmt_update = $db->prepare($sql_update);
                            $stmt_update->execute($update_values);
                            
                            $invoices_processed++;
                            $invoices_updated = true;
                        }
                    }
                }
            }
            
            $db->commit();
            
            // NaÄtenÃ­ aktualizovanÃ© objednÃ¡vky ve standardizovanÃ©m formÃ¡tu
            $updatedOrder = $handler->getOrderById($order_id, $current_user_id);
            
        } catch (Exception $e) {
            $db->rollback();
            throw $e; // Re-throw pro vnÄ›jÅ¡Ã­ catch
        }
        
        // SestavenÃ­ zprÃ¡vy o ÃºspÄ›Å¡nÃ© aktualizaci
        $message_parts = array('ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› aktualizovÃ¡na');
        if ($items_updated) {
            $message_parts[] = "{$items_processed} poloÅ¾ek";
        }
        if ($invoices_updated) {
            $message_parts[] = "{$invoices_processed} faktur";
        }
        
        echo json_encode(array(
            'status' => 'ok',
            'message' => implode(' vÄetnÄ› ', $message_parts),
            'data' => $updatedOrder,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'updated_id' => $order_id,
                'items_processed' => $items_processed,
                'items_updated' => $items_updated,
                'invoices_processed' => $invoices_processed,
                'invoices_updated' => $invoices_updated,
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 UPDATE Error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i aktualizaci objednÃ¡vky: ' . $e->getMessage()));
    }
}

/**
 * DELETE /api/order-v2/{id}
 * SmazÃ¡nÃ­ objednÃ¡vky (soft delete - aktivni = 0)
 */
function handle_order_v2_delete($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    $order_id = isset($input['id']) ? (int)$input['id'] : 0;
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    
    if ($order_id <= 0) {
        http_response_code(400);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ© ID objednÃ¡vky'));
        return;
    }
    
    try {
        $handler = new OrderV2Handler($config);
        $current_user_id = $auth_result['id'];
        
        // OvÄ›Å™ Å¾e objednÃ¡vka existuje
        $existingOrder = $handler->getOrderById($order_id, $current_user_id);
        if (!$existingOrder) {
            http_response_code(404);
            echo json_encode(array('status' => 'error', 'message' => 'ObjednÃ¡vka nebyla nalezena'));
            return;
        }
        
        // Kontrola lock stavu
        if ($existingOrder['lock_info']['locked'] === true) {
            http_response_code(423); // Locked
            echo json_encode(array(
                'status' => 'error', 
                'message' => 'ObjednÃ¡vka je zamÄenÃ¡ jinÃ½m uÅ¾ivatelem',
                'lock_info' => $existingOrder['lock_info']
            ));
            return;
        }
        
        // Soft delete - nastavÃ­me aktivni = 0
        $sql = "UPDATE " . get_orders_table_name() . " 
                SET aktivni = 0, dt_aktualizace = :dt_aktualizace 
                WHERE id = :id";
        
        $db = get_db($config);
        require_once __DIR__ . '/TimezoneHelper.php';
        TimezoneHelper::setMysqlTimezone($db);
        $stmt = $db->prepare($sql);
        $stmt->bindValue(':dt_aktualizace', TimezoneHelper::getCzechDateTime());
        $stmt->bindValue(':id', $order_id, PDO::PARAM_INT);
        $stmt->execute();
        
        echo json_encode(array(
            'status' => 'ok',
            'message' => 'ObjednÃ¡vka byla ÃºspÄ›Å¡nÄ› smazÃ¡na',
            'meta' => array(
                'version' => 'v2',
                'deleted_id' => $order_id,
                'soft_delete' => true,
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 DELETE Error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i mazÃ¡nÃ­ objednÃ¡vky: ' . $e->getMessage()));
    }
} 

/**
 * GET/POST /api/order-v2/{id}/enriched
 * NaÄtenÃ­ objednÃ¡vky podle ID s VÅ½DY enriched daty (poloÅ¾ky, faktury, ÄÃ­selnÃ­ky)
 */
function handle_order_v2_get_enriched($input, $config, $queries) {
    // Force enriched = 1
    $input['enriched'] = 1;
    
    // Zavolej standardnÃ­ GET handler s vynucenÃ½m enrichment
    handle_order_v2_get($input, $config, $queries);
}

/**
 * GET/POST /api/order-v2/list-enriched  
 * Listing objednÃ¡vek s VÅ½DY enriched daty (poloÅ¾ky, faktury, ÄÃ­selnÃ­ky)
 */
function handle_order_v2_list_enriched($input, $config, $queries) {
    // Force enriched = 1
    $input['enriched'] = 1;
    
    // Zavolej standardnÃ­ LIST handler s vynucenÃ½m enrichment
    handle_order_v2_list($input, $config, $queries);
}

/**
 * POST /api/order-v2/next-number
 * GenerovÃ¡nÃ­ dalÅ¡Ã­ho dostupnÃ©ho evidenÄnÃ­ho ÄÃ­sla objednÃ¡vky
 */
function handle_order_v2_next_number($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu
    
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    
    $auth_result = verify_token_v2($username, $token);

    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
   
    try {
        error_log("Order V2 NEXT NUMBER: Starting for user " . $username);
        
        $handler = new OrderV2Handler($config);
        
        // GenerovÃ¡nÃ­ dalÅ¡Ã­ho ÄÃ­sla
        $numberData = $handler->generateNextOrderNumber($username);
        
        error_log("Order V2 NEXT NUMBER: Generated data: " . json_encode($numberData));
    
        if (!$numberData) {
            http_response_code(404);
            echo json_encode(array(
                'status' => 'error',
                'message' => 'UÅ¾ivatel nenalezen nebo nemÃ¡ pÅ™iÅ™azenou organizaci/Ãºsek'
            ));
            return;
        }
        
        // PÅ™idÃ¡nÃ­ note pro FE kompatibilitu s Order25
        $numberData['note'] = 'order_number_string = nÃ¡sledujÃ­cÃ­ volnÃ© ÄÃ­slo pro novou objednÃ¡vku';
        
        require_once __DIR__ . '/TimezoneHelper.php';
        echo json_encode(array(
            'status' => 'ok',
            'data' => $numberData,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 NEXT-NUMBER Error: " . $e->getMessage() . " in " . $e->getFile() . " on line " . $e->getLine());
        error_log("Order V2 NEXT-NUMBER Stack trace: " . $e->getTraceAsString());
        http_response_code(500);
        echo json_encode(array(
            'status' => 'error', 
            'message' => 'Chyba pÅ™i zÃ­skÃ¡vÃ¡nÃ­ dalÅ¡Ã­ho ÄÃ­sla objednÃ¡vky: ' . $e->getMessage(),
            'debug_info' => array(
                'file' => $e->getFile(),
                'line' => $e->getLine()
            )
        ));
    }
}

/**
 * POST /api/order-v2/check-number
 * Kontrola dostupnosti evidenÄnÃ­ho ÄÃ­sla objednÃ¡vky
 */
function handle_order_v2_check_number($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    
    // ZÃ­skÃ¡nÃ­ orderNumber - podporujeme rÅ¯znÃ© formÃ¡ty pro kompatibilitu
    $orderNumber = null;
    if (isset($input['orderNumber'])) {
        $orderNumber = trim($input['orderNumber']);
    } elseif (isset($input['payload']['orderNumber'])) {
        $orderNumber = trim($input['payload']['orderNumber']);
    }
    
    // Suggest flag - zda navrhnout alternativnÃ­ ÄÃ­slo
    $suggest = false;
    if (isset($input['suggest'])) {
        $suggest = (bool)$input['suggest'];
    } elseif (isset($input['payload']['suggest'])) {
        $suggest = (bool)$input['payload']['suggest'];
    }
    
    if (!$orderNumber) {
        http_response_code(400);
        echo json_encode(array('status' => 'error', 'message' => 'ChybÃ­ orderNumber'));
        return;
    }
    
    try {
        $handler = new OrderV2Handler($config);
        
        // Kontrola ÄÃ­sla
        $checkResult = $handler->checkOrderNumber($orderNumber, $username, $suggest);
        
        if (!$checkResult) {
            http_response_code(500);
            echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i kontrole ÄÃ­sla objednÃ¡vky'));
            return;
        }
        
        echo json_encode(array(
            'status' => 'ok',
            'data' => $checkResult,
            'meta' => array(
                'version' => 'v2',
                'standardized' => true,
                'timestamp' => TimezoneHelper::getApiTimestamp()
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 CHECK-NUMBER Error: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(array('status' => 'error', 'message' => 'Chyba pÅ™i kontrole ÄÃ­sla objednÃ¡vky: ' . $e->getMessage()));
    }
}

/**
 * GET /api/order-v2/{id}/dt-aktualizace
 * NaÄtenÃ­ pouze dt_aktualizace objednÃ¡vky podle ID
 * PHP 5.6 + MySQL 5.5.43 compatible
 */
function handle_order_v2_get_dt_aktualizace($input, $config, $queries) {
    // OvÄ›Å™enÃ­ tokenu z POST dat
    $token = isset($input['token']) ? $input['token'] : '';
    $username = isset($input['username']) ? $input['username'] : '';
    $order_id = isset($input['id']) ? (int)$input['id'] : 0;
    
    $auth_result = verify_token_v2($username, $token);
    if (!$auth_result) {
        http_response_code(401);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ½ nebo chybÄ›jÃ­cÃ­ token'));
        return;
    }
    
    
    if ($order_id <= 0) {
        http_response_code(400);
        echo json_encode(array('status' => 'error', 'message' => 'NeplatnÃ© ID objednÃ¡vky'));
        return;
    }
    
    try {
        error_log("Order V2 GET DT_AKTUALIZACE: Starting for order ID " . $order_id);
        
        $db = get_db($config);
        
        // SQL query pro naÄtenÃ­ pouze dt_aktualizace podle ID
        $sql = "SELECT dt_aktualizace FROM " . get_orders_table_name() . " WHERE id = :id AND aktivni = 1";
        
        error_log("Order V2 GET DT_AKTUALIZACE: SQL: " . $sql);
        
        $stmt = $db->prepare($sql);
        $stmt->bindValue(':id', $order_id, PDO::PARAM_INT);
        $stmt->execute();
        
        $result = $stmt->fetch(PDO::FETCH_ASSOC);
        
        error_log("Order V2 GET DT_AKTUALIZACE: Result: " . json_encode($result));
        
        if (!$result) {
            http_response_code(404);
            echo json_encode(array('status' => 'error', 'message' => 'ObjednÃ¡vka nebyla nalezena nebo nenÃ­ aktivnÃ­'));
            return;
        }
        
        // StandardizovanÃ¡ response s dt_aktualizace
        require_once __DIR__ . '/TimezoneHelper.php';
        echo json_encode(array(
            'status' => 'ok',
            'data' => array(
                'id' => $order_id,
                'dt_aktualizace' => $result['dt_aktualizace']
            ),
            'meta' => array(
                'version' => 'v2',
                'endpoint' => 'dt-aktualizace',
                'timestamp' => TimezoneHelper::getApiTimestamp(),
                'compatibility' => 'PHP 5.6 + MySQL 5.5.43'
            )
        ));
        
    } catch (Exception $e) {
        error_log("Order V2 GET DT-AKTUALIZACE Error: " . $e->getMessage() . " in " . $e->getFile() . " on line " . $e->getLine());
        error_log("Order V2 GET DT-AKTUALIZACE Stack trace: " . $e->getTraceAsString());
        http_response_code(500);
        echo json_encode(array(
            'status' => 'error', 
            'message' => 'Chyba pÅ™i naÄÃ­tÃ¡nÃ­ dt_aktualizace: ' . $e->getMessage(),
            'debug_info' => array(
                'file' => $e->getFile(),
                'line' => $e->getLine()
            )
        ));
    }
}

// ========== ORDER V2 ITEMS MANAGEMENT FUNCTIONS ==========

/**
 * VloÅ¾Ã­ poloÅ¾ky objednÃ¡vky pro Order V2 (25a_objednavky_polozky)
 * Batch insert pro lepÅ¡Ã­ vÃ½kon - PHP 5.6 kompatibilnÃ­
 * @param PDO $db - DatabÃ¡zovÃ© spojenÃ­
 * @param int $order_id - ID objednÃ¡vky
 * @param array $items - Pole poloÅ¾ek k vloÅ¾enÃ­
 * @return bool - True pÅ™i ÃºspÄ›chu
 */
function insertOrderV2Items($db, $order_id, $items) {
    if (empty($items)) {
        return true; // Å½Ã¡dnÃ© poloÅ¾ky k vloÅ¾enÃ­
    }
    
    try {
        // Batch insert pro lepÅ¡Ã­ vÃ½kon
        $itemsCount = count($items);
        $sql = insertOrderItemsBatchQuery($itemsCount);
        $stmt = $db->prepare($sql);
        
        $params = array(':objednavka_id' => $order_id);
        
        foreach ($items as $index => $item) {
            $params[":popis_{$index}"] = $item['popis'];
            $params[":cena_bez_dph_{$index}"] = $item['cena_bez_dph'];
            $params[":sazba_dph_{$index}"] = $item['sazba_dph'];
            $params[":cena_s_dph_{$index}"] = $item['cena_s_dph'];
            // LokalizaÄnÃ­ data - 3 kÃ³dy + poznamka
            $params[":usek_kod_{$index}"] = isset($item['usek_kod']) ? $item['usek_kod'] : null;
            $params[":budova_kod_{$index}"] = isset($item['budova_kod']) ? $item['budova_kod'] : null;
            $params[":mistnost_kod_{$index}"] = isset($item['mistnost_kod']) ? $item['mistnost_kod'] : null;
            $params[":poznamka_{$index}"] = isset($item['poznamka']) ? $item['poznamka'] : null;
        }
        
        $stmt->execute($params);
        return true;
        
    } catch (Exception $e) {
        error_log("Order V2 insertOrderV2Items Error: " . $e->getMessage());
        return false;
    }
}

/**
 * UloÅ¾Ã­ poloÅ¾ky objednÃ¡vky Order V2 (smaÅ¾e starÃ©, vloÅ¾Ã­ novÃ©)
 * Implementuje "saveOrderItems" pattern pro 25a_objednavky_polozky
 * @param PDO $db - DatabÃ¡zovÃ© spojenÃ­
 * @param int $order_id - ID objednÃ¡vky
 * @param array $items - Pole poloÅ¾ek k uloÅ¾enÃ­
 * @return bool - True pÅ™i ÃºspÄ›chu
 */
function saveOrderV2Items($db, $order_id, $items) {
    try {
        // Nejprve smaÅ¾eme vÅ¡echny stÃ¡vajÃ­cÃ­ poloÅ¾ky
        $deleteStmt = $db->prepare(deleteOrderItemsByOrderIdQuery());
        $deleteStmt->bindParam(':objednavka_id', $order_id, PDO::PARAM_INT);
        $deleteStmt->execute();
        
        // Pak vloÅ¾Ã­me novÃ© poloÅ¾ky
        return insertOrderV2Items($db, $order_id, $items);
        
    } catch (Exception $e) {
        error_log("Order V2 saveOrderV2Items Error: " . $e->getMessage());
        return false;
    }
}

/**
 * Aktualizuje poloÅ¾ky objednÃ¡vky Order V2 (smaÅ¾e starÃ©, vloÅ¾Ã­ novÃ©)
 * Alias pro saveOrderV2Items() - zachovÃ¡vÃ¡ konzistenci s Order25 API
 * @param PDO $db - DatabÃ¡zovÃ© spojenÃ­
 * @param int $order_id - ID objednÃ¡vky
 * @param array $items - Pole novÃ½ch poloÅ¾ek
 * @return bool - True pÅ™i ÃºspÄ›chu
 */
function updateOrderV2Items($db, $order_id, $items) {
    return saveOrderV2Items($db, $order_id, $items);
}