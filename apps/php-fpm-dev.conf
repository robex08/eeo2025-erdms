; ==========================================
; PHP-FPM DEVELOPMENT CONFIGURATION
; ==========================================
; Optimalizováno pro vývojové prostředí s omezeným SSH tunelem
; Použití: sudo ln -s /var/www/erdms-dev/apps/php-fpm-dev.conf /etc/php/8.x/fpm/pool.d/dev.conf
; Reload: sudo systemctl reload php8.x-fpm

[dev-pool]
; Unix user/group of processes
user = www-data
group = www-data

; Listen na lokálním socketu (rychlejší než TCP)
listen = /run/php/php-fpm-dev.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; ==========================================
; PROCESS MANAGER - DEVELOPMENT OPTIMIZED
; ==========================================
; Pro dev prostředí: MÉNĚ procesů = méně I/O競爭

pm = dynamic

; SNÍŽENÉ HODNOTY PRO DEV:
pm.max_children = 5          ; Max 5 procesů (produkce: 20-50)
pm.start_servers = 2         ; Start s 2 procesy (produkce: 5-10)
pm.min_spare_servers = 1     ; Min 1 spare (produkce: 5)
pm.max_spare_servers = 3     ; Max 3 spare (produkce: 10)

; Restart workera po X requestech (prevence memory leaks)
pm.max_requests = 100        ; Dev: častější restart OK (produkce: 500-1000)

; Process manager status
pm.status_path = /fpm-status

; ==========================================
; PERFORMANCE & TIMEOUTS
; ==========================================
; Request timeout (pro dev: vyšší kvůli debuggingu)
request_terminate_timeout = 60s

; Slow log - zalogovat requesty delší než 10s
slowlog = /var/log/php-fpm/dev-slow.log
request_slowlog_timeout = 10s

; ==========================================
; RESOURCE LIMITS
; ==========================================
; Omezit memory per worker (dev: nižší je OK)
php_admin_value[memory_limit] = 256M

; Max execution time
php_admin_value[max_execution_time] = 60

; Upload limits (dev: menší je OK)
php_admin_value[upload_max_filesize] = 20M
php_admin_value[post_max_size] = 25M

; ==========================================
; ERROR HANDLING (DEV)
; ==========================================
php_admin_flag[display_errors] = on
php_admin_value[error_reporting] = E_ALL
php_admin_value[log_errors] = on
php_admin_value[error_log] = /var/log/php-fpm/dev-error.log

; ==========================================
; OPCACHE - RELAXED FOR DEV
; ==========================================
; Validate často = vidět změny okamžitě (prod: 60s)
php_admin_value[opcache.revalidate_freq] = 2

; Enable opcache ale s validací
php_admin_flag[opcache.enable] = 1
php_admin_flag[opcache.validate_timestamps] = 1

; Menší opcache memory pro dev
php_admin_value[opcache.memory_consumption] = 64

; ==========================================
; SESSION & CACHE
; ==========================================
php_admin_value[session.save_path] = /tmp/php-sessions-dev

; ==========================================
; MONITORING
; ==========================================
; Access log (optional - můžete vypnout pro snížení I/O)
; access.log = /var/log/php-fpm/dev-access.log

; Security (chroot není nutný pro dev)
; chroot = 

; Nice priority (nižší priorita = méně ovlivní systém)
; process.priority = 10

; ==========================================
; DEPLOYMENT NOTES
; ==========================================
; 1. Vytvořte log adresář:
;    sudo mkdir -p /var/log/php-fpm
;    sudo chown www-data:www-data /var/log/php-fpm
;
; 2. Vytvořte session adresář:
;    sudo mkdir -p /tmp/php-sessions-dev
;    sudo chown www-data:www-data /tmp/php-sessions-dev
;
; 3. Symlink tento soubor:
;    sudo ln -sf /var/www/erdms-dev/apps/php-fpm-dev.conf /etc/php/8.x/fpm/pool.d/dev.conf
;
; 4. Otestujte konfiguraci:
;    sudo php-fpm8.x -t
;
; 5. Reload:
;    sudo systemctl reload php8.x-fpm
;
; 6. Monitoring:
;    watch -n 1 'sudo systemctl status php8.x-fpm'
;    tail -f /var/log/php-fpm/dev-slow.log
