# ==========================================
# SSH CONFIG OPTIMIZATIONS
# ==========================================
# Soubor: ~/.ssh/config (na KLIENTOVI, ne serveru)
# Použití: Přidejte tento blok do ~/.ssh/config na vašem lokálním PC

# Host alias pro váš dev server
Host erdms-dev
    HostName your-server.com  # <-- Změňte na skutečnou adresu
    User your-username         # <-- Změňte na své uživatelské jméno
    Port 22
    
    # ==========================================
    # KOMPRESE - Snížení datového toku
    # ==========================================
    # Level 6 = dobrý kompromis mezi CPU a bandwidth
    Compression yes
    CompressionLevel 6
    
    # ==========================================
    # CONNECTION MULTIPLEXING
    # ==========================================
    # Sdílené TCP spojení = méně overhead pro VS Code channels
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 10m
    
    # ==========================================
    # KEEPALIVE - Prevence timeout
    # ==========================================
    # Každých 30s pošli keepalive packet (max 10 pokusů)
    ServerAliveInterval 30
    ServerAliveCountMax 10
    TCPKeepAlive yes
    
    # ==========================================
    # QoS & PRIORITIZATION
    # ==========================================
    # AF21 (18) = Assured Forwarding class 2, low drop
    # Preferuje interaktivní provoz před bulk transfers
    IPQoS af21 cs1
    # První hodnota (af21) = interactive traffic (SSH, typing)
    # Druhá hodnota (cs1) = bulk data (file transfers)
    
    # ==========================================
    # CIPHERS & MAC - Rychlé algoritmy
    # ==========================================
    # ChaCha20 = rychlý cipher s nízkou latencí (dobré pro CPU)
    # AES-GCM = hardwarová akcelerace na většině CPU
    Ciphers chacha20-poly1305@openssh.com,aes128-gcm@openssh.com,aes256-gcm@openssh.com
    
    # UMAC/ETIM jsou rychlejší než SHA-256
    MACs umac-128-etm@openssh.com,hmac-sha2-256-etm@openssh.com
    
    # ==========================================
    # PERFORMANCE TUNING
    # ==========================================
    # Disable Nagle's algorithm = nižší latence pro malé packety
    # (dobré pro typing, Copilot)
    # Poznámka: Toto není přímo SSH direktiva, ale můžete použít:
    # - Na serveru: /etc/ssh/sshd_config -> TCPKeepAlive yes
    
    # Forward agent (optional)
    # ForwardAgent yes
    
    # ==========================================
    # VS CODE REMOTE SPECIFIC
    # ==========================================
    # Larger receive buffer = plynulejší transfer
    # (vyžaduje moderní OpenSSH)
    # SetEnv DISPLAY=:0  # Pokud potřebujete X11
    
    # Reuse connections (important!)
    # VS Code otevře více SSH channels - s multiplexingem je to levnější
    StreamLocalBindUnlink yes

# ==========================================
# GLOBAL DEFAULTS (pro všechna spojení)
# ==========================================
Host *
    # Connection sharing socket directory
    # Vytvořte adresář: mkdir -p ~/.ssh/sockets
    # ControlPath je definován výše
    
    # Fast cipher preferece (fallback)
    Ciphers chacha20-poly1305@openssh.com,aes128-gcm@openssh.com,aes256-gcm@openssh.com,aes128-ctr,aes256-ctr
    
    # Hash known hosts (security + rychlejší lookup)
    HashKnownHosts yes
    
    # Disable GSSAPI (pokud nepoužíváte Kerberos - šetří DNS lookups)
    GSSAPIAuthentication no
    
    # Fast host key algorithms
    HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256

# ==========================================
# SETUP INSTRUCTIONS
# ==========================================
# 1. Vytvořte socket directory:
#    mkdir -p ~/.ssh/sockets
#
# 2. Nastavte permissions:
#    chmod 700 ~/.ssh
#    chmod 700 ~/.ssh/sockets
#
# 3. Editujte ~/.ssh/config:
#    nano ~/.ssh/config
#    (přidejte výše uvedený blok)
#
# 4. Nastavte permissions:
#    chmod 600 ~/.ssh/config
#
# 5. Testujte spojení:
#    ssh -v erdms-dev
#    (hledejte "Compression" a "multiplexing" v logu)
#
# 6.Ověřte QoS (na serveru):
#    sudo tcpdump -i any -n 'port 22' -v
#    (hledejte DSCP hodnoty)

# ==========================================
# SERVER-SIDE OPTIMIZATIONS
# ==========================================
# Soubor: /etc/ssh/sshd_config (na SERVERU)
# Přidejte/upravte:
#
# # Compression
# Compression yes
#
# # Keepalive
# ClientAliveInterval 30
# ClientAliveCountMax 10
# TCPKeepAlive yes
#
# # Performance
# UseDNS no  # Zakázat DNS lookup (rychlejší auth)
# MaxStartups 10:30:60  # Throttle concurrent connections
#
# # Cipher preferences (stejné jako klient)
# Ciphers chacha20-poly1305@openssh.com,aes128-gcm@openssh.com,aes256-gcm@openssh.com
#
# Po úpravě:
# sudo sshd -t  # Test config
# sudo systemctl reload sshd

# ==========================================
# SYSTEM-LEVEL QoS (LINUX SERVER)
# ==========================================
# Pro prioritizaci SSH provozu na serveru:
#
# sudo tc qdisc add dev eth0 root handle 1: prio
# sudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip sport 22 0xffff flowid 1:1
# sudo tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip dport 22 0xffff flowid 1:1
#
# Poznámka: Nahraďte 'eth0' vaším síťovým interface

# ==========================================
# MONITORING & DEBUGGING
# ==========================================
# Otestujte latenci a throughput:
#
# 1. Ping:
#    ping -c 10 your-server.com
#
# 2. SSH verbose:
#    ssh -vvv erdms-dev
#
# 3. Check compression ratio:
#    # Na serveru:
#    sudo tcpdump -i any -n 'port 22' -w ssh.pcap
#    # Analyzujte v Wireshark
#
# 4. Monitor bandwidth:
#    # Na serveru:
#    iftop -i eth0 -f 'port 22'
#
# 5. Check SSH multiplexing:
#    ls -la ~/.ssh/sockets/
#    # Měl byste vidět socket file když je VS Code připojeno
