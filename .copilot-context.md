# ERDMS - Project Context Memory

## ğŸ“‹ ZÃ¡kladnÃ­ informace o projektu

### NÃ¡zev projektu
**ERDMS** - ElektronickÃ½ RozcestnÃ­k pro Dokument Management System

### Organizace
**ZZS** - ZdravotnickÃ¡ zÃ¡chrannÃ¡ sluÅ¾ba

### ProdukÄnÃ­ domÃ©na
- **URL:** https://erdms.zachranka.cz
- **SSL:** âœ… AktivnÃ­

---

## ğŸ“‚ Struktura projektu

### Development workspace: `/var/www/eeo2025/`
```
eeo2025/
â”œâ”€â”€ client/                     # React frontend (Vite + MSAL)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ HomePage.jsx/css
â”‚   â”‚   â”‚   â””â”€â”€ LoginPage.jsx/css
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ authConfig.js   # MSAL konfigurace pro React
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â””â”€â”€ main.jsx
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.js
â”‚   â””â”€â”€ .env                    # CLIENT_ID, TENANT_ID, API_SCOPE
â”‚
â”œâ”€â”€ server/                     # Express API (Node.js + MSAL)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ msalConfig.js   # MSAL konfigurace pro server
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â””â”€â”€ authMiddleware.js
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â”‚   â””â”€â”€ protected.js
â”‚   â”‚   â””â”€â”€ index.js            # HlavnÃ­ server soubor
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ .env                    # CLIENT_ID, TENANT_ID, CLIENT_SECRET
â”‚
â””â”€â”€ docs/                       # Dokumentace
    â”œâ”€â”€ deployment/
    â”‚   â””â”€â”€ DEPLOYED.md
    â”œâ”€â”€ development/
    â”‚   â”œâ”€â”€ START.md
    â”‚   â””â”€â”€ CHECKLIST.md
    â”œâ”€â”€ production/
    â”‚   â”œâ”€â”€ PRODUCTION.md
    â”‚   â””â”€â”€ SYSTEMD_SERVICE.md
    â””â”€â”€ setup/
        â””â”€â”€ MICROSOFT_ENTRA_SETUP.md
```

### Production build: `/var/www/erdms/`
```
erdms/
â”œâ”€â”€ index.html                  # Client build (SPA entry point)
â”œâ”€â”€ assets/                     # JS, CSS bundly z Vite
â”œâ”€â”€ logo-ZZS.png
â”œâ”€â”€ vite.svg
â”œâ”€â”€ MICROSOFT_ENTRA_SETUP.md
â””â”€â”€ api/
    â””â”€â”€ v1.0/                   # API deployment
        â”œâ”€â”€ src/
        â”‚   â”œâ”€â”€ config/
        â”‚   â”œâ”€â”€ middleware/
        â”‚   â”œâ”€â”€ routes/
        â”‚   â””â”€â”€ index.js
        â”œâ”€â”€ node_modules/
        â”œâ”€â”€ package.json
        â”œâ”€â”€ .env
        â”œâ”€â”€ server.log
        â””â”€â”€ server.pid
```

---

## ğŸ” Autentizace - Microsoft Entra ID

### Technologie
- **Frontend:** `@azure/msal-react` (v3.0.22)
- **Backend:** `@azure/msal-node` (v3.8.3)

### Flow
1. User â†’ PÅ™ihlÃ¡Å¡enÃ­ pÅ™es Microsoft (SSO)
2. Frontend zÃ­skÃ¡ Access Token
3. Frontend â†’ API s `Bearer Token` v hlaviÄce
4. Backend validuje token pomocÃ­ JWKS
5. Backend vracÃ­ data

### Konfigurace (.env)

**Client (.env):**
```env
VITE_AZURE_CLIENT_ID=...
VITE_AZURE_TENANT_ID=...
VITE_AZURE_AUTHORITY=https://login.microsoftonline.com/{TENANT_ID}
VITE_REDIRECT_URI=https://erdms.zachranka.cz
VITE_AZURE_API_SCOPE=api://{CLIENT_ID}/access_as_user
```

**Server (.env):**
```env
AZURE_CLIENT_ID=...
AZURE_TENANT_ID=...
AZURE_CLIENT_SECRET=...
AZURE_AUTHORITY=https://login.microsoftonline.com/{TENANT_ID}
AZURE_API_SCOPE=api://{CLIENT_ID}/access_as_user
PORT=5000
NODE_ENV=production
```

### Scopes
- **Login:** `User.Read`, `profile`, `email`, `openid`
- **API:** `api://{CLIENT_ID}/access_as_user`

---

## ğŸ› ï¸ Technologie

### Frontend
- **React:** 19.2.0
- **Vite:** 7.2.4 (build tool)
- **React Router:** 7.9.6
- **Axios:** 1.13.2 (HTTP klient)
- **MSAL React:** 3.0.22

### Backend
- **Node.js:** 20.x
- **Express:** 5.2.1
- **MSAL Node:** 3.8.3
- **JWT:** jsonwebtoken 9.0.2, jwks-rsa 3.2.0
- **Security:** helmet 8.1.0, cors 2.8.5
- **Logger:** morgan 1.10.1

### Server
- **Web server:** Apache 2.4
- **OS:** Linux
- **Process manager:** nohup + PID file (moÅ¾nÃ¡ upgrade na systemd)

---

## ğŸš€ SpuÅ¡tÄ›nÃ­

### Development
```bash
# Terminal 1 - Server
cd /var/www/eeo2025/server
npm run dev                    # nodemon na portu 5000

# Terminal 2 - Client
cd /var/www/eeo2025/client
npm run dev                    # Vite dev server na portu 3000
```

### Production - API Server
```bash
# Status
ps aux | grep "node src/index.js"

# Start
cd /var/www/erdms/api/v1.0
source ~/.nvm/nvm.sh
nohup node src/index.js > /var/log/erdms-api.log 2>&1 &
echo $! > /var/run/erdms-api.pid

# Stop
kill $(cat /var/run/erdms-api.pid)

# Restart
kill $(cat /var/run/erdms-api.pid) && sleep 1
cd /var/www/erdms/api/v1.0 && nohup node src/index.js > /var/log/erdms-api.log 2>&1 &
echo $! > /var/run/erdms-api.pid

# Logy
tail -f /var/log/erdms-api.log
```

### Production - Apache
```bash
# Status
systemctl status apache2

# Restart
systemctl restart apache2

# Logy
tail -f /var/log/apache2/erdms-443-ssl-access.log
tail -f /var/log/apache2/erdms-443-ssl-error.log
```

---

## ğŸ“¦ Build & Deploy workflow

### 1. ZmÄ›ny v kÃ³du
```bash
# Edituj soubory v /var/www/eeo2025/client/ nebo /server/
```

### 2. Test v development
```bash
cd /var/www/eeo2025/client && npm run dev
cd /var/www/eeo2025/server && npm run dev
```

### 3. Build frontend
```bash
cd /var/www/eeo2025/client
npm run build                   # VytvoÅ™Ã­ dist/
```

### 4. Deploy frontend
```bash
cp -r /var/www/eeo2025/client/dist/* /var/www/erdms/
```

### 5. Deploy backend
```bash
# ZkopÃ­ruj zmÄ›nÄ›nÃ© soubory
cp /var/www/eeo2025/server/src/* /var/www/erdms/api/v1.0/src/

# Restart API
kill $(cat /var/run/erdms-api.pid)
cd /var/www/erdms/api/v1.0 && nohup node src/index.js > /var/log/erdms-api.log 2>&1 &
echo $! > /var/run/erdms-api.pid
```

### 6. OvÄ›Å™enÃ­
```bash
# Health check
curl http://localhost:5000/api/health

# Test v prohlÃ­Å¾eÄi
firefox https://erdms.zachranka.cz
```

---

## ğŸŒ Apache VirtualHost konfigurace

**Soubor:** `/etc/apache2/sites-available/erdms.zachranka.cz.conf`

### KlÃ­ÄovÃ© direktivy
- **DocumentRoot:** `/var/www/erdms/`
- **ServerName:** `erdms.zachranka.cz`
- **SSL:** âœ… AktivnÃ­ (certifikÃ¡t Let's Encrypt)
- **API Proxy:** `/api â†’ http://localhost:5000/api`
- **SPA Routing:** `FallbackResource /index.html`

### Proxy nastavenÃ­
```apache
ProxyPass /api http://localhost:5000/api
ProxyPassReverse /api http://localhost:5000/api
```

---

## ğŸ” DÅ¯leÅ¾itÃ© endpointy

### API
- **Health:** `GET http://localhost:5000/api/health`
- **Auth Token:** `POST http://localhost:5000/api/auth/token`
- **Protected Data:** `GET http://localhost:5000/api/protected/data`

### Frontend
- **Homepage:** `https://erdms.zachranka.cz/`
- **Login:** `https://erdms.zachranka.cz/` (HomePage zobrazÃ­ login)

---

## âš ï¸ AktuÃ¡lnÃ­ stav

### âœ… Co funguje
- Apache VirtualHost konfigurace
- SSL certifikÃ¡t
- Frontend build deployed
- Backend API bÄ›Å¾Ã­ (port 5000)
- API proxy routing
- SPA routing (FallbackResource)
- Health endpoint

### âŒ Co nefunguje / ÄekÃ¡ se
- **Microsoft Entra ID pÅ™ihlÃ¡Å¡enÃ­** - pouÅ¾Ã­vajÃ­ se dummy hodnoty
  - CLIENT_ID: `00000000-0000-0000-0000-000000000000`
  - TENANT_ID: `00000000-0000-0000-0000-000000000000`
- ÄŒekÃ¡ se na skuteÄnÃ© hodnoty od IT kolegy

### ğŸ”œ TODO
- [ ] ZÃ­skat skuteÄnÃ© EntraID credentials
- [ ] Aktualizovat .env soubory (client + server)
- [ ] Rebuild & redeploy s novÃ½mi hodnotami
- [ ] Otestovat pÅ™ihlÃ¡Å¡enÃ­
- [ ] Nastavit systemd service pro API (mÃ­sto nohup)

---

## ğŸ“ PoznÃ¡mky

### Git repository
- **Owner:** robex08
- **Repo:** eeo2025-erdms
- **Branch:** main (default)

### Node.js verze
- PouÅ¾Ã­vÃ¡ se pÅ™es NVM (`~/.nvm/nvm.sh`)
- Verze: 20.x

### PHP verze
- **CLI:** PHP 8.4.11 (NTS)
- **FPM:** PHP 8.4 FastCGI Process Manager
- **Status:** âœ… AktivnÃ­ (bÄ›Å¾Ã­ od 24. Å™Ã­jna 2025)
- **Zend Engine:** v4.4.11
- **OPcache:** âœ… AktivnÃ­
- **Config:** `/etc/php/8.4/`
- **PoznÃ¡mka:** Apache nepouÅ¾Ã­vÃ¡ PHP modul (mod_php), ale FastCGI (php-fpm)

### MySQL/Database
- **Server IP:** 10.3.172.11
- **Port:** 3306 (standardnÃ­ MySQL port)
- **Status:** âœ… FUNKÄŒNÃ - Firewall opraven, pÅ™ipojenÃ­ funguje!
- **Verze serveru:** MariaDB 11.8.3-0+deb13u1 (Debian)
- **Typ serveru:** MariaDB (TCP connection)
- **Verze protokolu:** 10
- **PÅ™ipojenÃ­:** âš ï¸ SSL musÃ­ bÃ½t vypnuto (`--skip-ssl`) - chyba "wrong version number"
- **phpMyAdmin:** 5.2.2deb1 (localhost:3306)
- **MySQL klient:** âœ… NainstalovanÃ½ na web serveru (mariadb-client 11.8.3)
- **Firewall:** âœ… Opraveno - web server 10.3.174.11 mÃ¡ pÅ™Ã­stup
- **DatabÃ¡zovÃ© extensions PHP:** mysqli, mysqlnd 8.4.11, pdo_mysql

#### DatabÃ¡ze ERDMS:
- **NÃ¡zev:** `erdms`
- **Charset:** `utf8mb4` âœ…
- **Collation:** `utf8mb4_czech_ci` âœ… (ÄeskÃ© Å™azenÃ­, case-insensitive)
- **UÅ¾ivatel:** `erdms_user@10.3.174.11`
- **Heslo:** UloÅ¾eno v `/var/www/eeo2025/server/.env`
- **OprÃ¡vnÄ›nÃ­:** ALL PRIVILEGES na databÃ¡zi `erdms`
- **Stav:** PrÃ¡zdnÃ¡ databÃ¡ze (Å¾Ã¡dnÃ© tabulky zatÃ­m)

### ÄŒasovÃ© razÃ­tko
- **PoslednÃ­ update:** 2. prosince 2025
- **NasazenÃ­ dokonÄeno:** 1. prosince 2025

---

## ğŸ†˜ Quick troubleshooting

### API nereaguje
```bash
# Zjisti, jestli bÄ›Å¾Ã­
ps aux | grep "node src/index.js"

# Zkontroluj logy
tail -f /var/log/erdms-api.log

# Restart
kill $(cat /var/run/erdms-api.pid)
cd /var/www/erdms/api/v1.0 && nohup node src/index.js > /var/log/erdms-api.log 2>&1 &
echo $! > /var/run/erdms-api.pid
```

### Frontend vracÃ­ 404
```bash
# Zkontroluj, Å¾e build existuje
ls -la /var/www/erdms/index.html

# Zkontroluj Apache
systemctl status apache2
tail -f /var/log/apache2/erdms-443-ssl-error.log
```

### Login nefunguje
```bash
# Zkontroluj .env hodnoty
cat /var/www/eeo2025/client/.env
cat /var/www/eeo2025/server/.env

# Po zmÄ›nÄ› .env vÅ¾dy rebuild
cd /var/www/eeo2025/client && npm run build
cp -r dist/* /var/www/erdms/
```

---

**Tento soubor slouÅ¾Ã­ jako "pamÄ›Å¥" pro GitHub Copilot - obsahuje vÅ¡echny dÅ¯leÅ¾itÃ© informace o projektu.**
